unit MainNew;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, AdvShapeButton, ExtCtrls, StdCtrls, datelbl, acPNG, jpeg,
  AdvGlowButton, AdvOfficeStatusBar, AdvEdit, Menus, ScktComp, IdComponent,
  IdRawBase, IdRawClient, IdIcmpClient, IdBaseComponent, IdAntiFreezeBase,
  IdAntiFreeze, OoMisc, AdPort, DB, ADODB, Grids, BaseGrid, AdvGrid, ComCtrls,
  Buttons, DBAdvGrid, sCustomComboEdit, sTooledit, Mask, sMaskEdit, sButton,
  sLabel, sPanel, IniFiles, advlued, AdvToolBtn, AdvSmoothButton, IdContext,
  IdServerIOHandler, IdServerIOHandlerSocket, IdServerIOHandlerStack,
  IdCustomTCPServer, IdTCPServer, IdGlobal, IdIOHandler, IdIOHandlerSocket,
  IdIOHandlerStack, IdTCPConnection, IdTCPClient, DateUtils, Winsock, AdvObj,
  sSkinManager, Vcl.OleCtrls, sBitBtn, SMTPAYAXLib_TLB, System.Generics.Collections, CodeSiteLogging;

type
  byDynamicArr = array of byte;

  FeeItem = record
    FeeNo: Integer;
    FeeName: string;
    WeekdaysMax: Integer;
    SaturdayMax: Integer;
    SundayMax: Integer;
    TotMax: Integer;
    GroupNo: Integer;
    sTime: string;
    eTime: string;
    FreeTime: string;
    Fee: Integer;
    FeeTime: Integer
  end;

  R_SCWait = Record
    sSCFile1: AnsiString;
    sSCCarNo1: AnsiString;
    sSCFile2: AnsiString;
    sSCCarNo2: AnsiString;
    sSCIOTime: AnsiString;
    nSCLprNo: Byte;
    nSCInOut: Byte;
    nSCRecog1: Byte;
    nSCRecog2: Byte;
    sSCDspIP: AnsiString;
    csSCLPR: TClientSocket;
    bBarOpen: Boolean;
  end;

  R_NCWait = Record
    sNCFile1: AnsiString;
    sNCCarNo1: AnsiString;
    sNCFile2: AnsiString;
    sNCCarNo2: AnsiString;
    sNCIOTime: AnsiString;
    nNCLprNo: Byte;
    nNCInOut: Byte;
    nNCRecog1: Byte;
    nNCRecog2: Byte;
    nNCCharo: Byte;
    sNCDspIP: AnsiString;
    csNCLPR: TClientSocket;
    bBarOpen: Boolean;
    nFeeNo: Byte;          // Added by LJH 2020-01-15 11:25:09 정기차량 요금부과때문에 입차대기시 요금제번호도 같이 저장함.
  end;                     // 일반차량은 전부다 0으로 통일부과(요금기에서 버튼을눌러야함)

  TfrmMainNew = class(TForm)
    imgMain: TImage;
    btnClose: TAdvShapeButton;
    btnMinimize: TAdvShapeButton;
    btnSetup: TAdvShapeButton;
    Image1: TImage;
    Image2: TImage;
    AdvShapeButton1: TAdvShapeButton;
    AdvShapeButton3: TAdvShapeButton;
    AdvShapeButton5: TAdvShapeButton;
    AdvShapeButton7: TAdvShapeButton;
    DateLabel1: TDateLabel;
    DateLabel2: TDateLabel;
    Image3: TImage;
    Image4: TImage;
    Image5: TImage;
    Image6: TImage;
    btnCancel: TAdvShapeButton;
    btnReceipt: TAdvShapeButton;
    btnProc: TAdvShapeButton;
    Image7: TImage;
    Image8: TImage;
    Image9: TImage;
    Image10: TImage;
    btn1: TAdvShapeButton;
    edtMName: TAdvEdit;
    btn2: TAdvShapeButton;
    btn3: TAdvShapeButton;
    btn4: TAdvShapeButton;
    btn5: TAdvShapeButton;
    btn6: TAdvShapeButton;
    btn7: TAdvShapeButton;
    btn8: TAdvShapeButton;
    btn9: TAdvShapeButton;
    btn10: TAdvShapeButton;
    btn11: TAdvShapeButton;
    btn12: TAdvShapeButton;
    btn13: TAdvShapeButton;
    btn14: TAdvShapeButton;
    btn15: TAdvShapeButton;
    btn16: TAdvShapeButton;
    btnCarSearch: TAdvShapeButton;
    btnClosing: TAdvShapeButton;
    Label1: TLabel;
    Label2: TLabel;
    Label3: TLabel;
    lbInTime: TLabel;
    lbOutTime: TLabel;
    lbParkingTime: TLabel;
    lbCarNo: TLabel;
    imgOut: TImage;
    imgIn: TImage;
    lbOutCarNo: TLabel;
    lbInCarNo: TLabel;
    lbYogum1: TLabel;
    lbYogum2: TLabel;
    lbYogum3: TLabel;
    lbYogum4: TLabel;
    lbYogum5: TLabel;
    lbYogum6: TLabel;
    lbDCName: TLabel;
    pnSetup: TPopupMenu;
    mnuSetup: TMenuItem;
    mnuUnitInfo: TMenuItem;
    mnuInDsp: TMenuItem;
    mnuOutDsp: TMenuItem;
    Button1: TButton;
    Button2: TButton;
    Button3: TButton;
    ic1: TImage;
    ic2: TImage;
    ic3: TImage;
    qryMainTemp: TADOQuery;
    qry1: TADOQuery;
    ComPrn: TApdComPort;
    IdAntiFreeze1: TIdAntiFreeze;
    ICMP: TIdIcmpClient;
    csInLpr1: TClientSocket;
    csInLpr2: TClientSocket;
    csInLpr3: TClientSocket;
    csOutLpr1: TClientSocket;
    csOutLpr2: TClientSocket;
    csOutLpr3: TClientSocket;
    csInDsp1: TClientSocket;
    csInDsp2: TClientSocket;
    csInDsp3: TClientSocket;
    csOutDsp1: TClientSocket;
    csOutDsp2: TClientSocket;
    csOutDsp3: TClientSocket;
    tInDsp: TTimer;
    tOutDsp: TTimer;
    edtDCYogum: TAdvEdit;
    edtTotYogum: TAdvEdit;
    edtProcYogum: TAdvEdit;
    btnManualIn: TAdvShapeButton;
    btnManualOut: TAdvShapeButton;
    sgIn: TAdvStringGrid;
    sgOut: TAdvStringGrid;
    pnLost: TPanel;
    Panel14: TPanel;
    Panel15: TPanel;
    Label20: TLabel;
    Panel35: TPanel;
    Label42: TLabel;
    imgLost: TImage;
    dgLost: TDBAdvGrid;
    Panel1: TPanel;
    Label41: TLabel;
    btnLostProc: TBitBtn;
    edtLostCarNo: TEdit;
    btnSeek: TBitBtn;
    lbMCnt: TLabel;
    lbMTot: TLabel;
    PopupMenu1: TPopupMenu;
    mnuDetail: TMenuItem;
    mnuDC1: TMenuItem;
    mnuDC2: TMenuItem;
    mnuDC3: TMenuItem;
    mnuDC4: TMenuItem;
    mnuDC5: TMenuItem;
    mnuDC6: TMenuItem;
    mnuDC7: TMenuItem;
    mnuDC8: TMenuItem;
    mnuDC9: TMenuItem;
    mnuDC10: TMenuItem;
    mnuDC11: TMenuItem;
    mnuDC12: TMenuItem;
    mnuDC13: TMenuItem;
    mnuDC14: TMenuItem;
    mnuDC15: TMenuItem;
    mnuDC16: TMenuItem;
    mnuReceipt: TMenuItem;
    edtDC: TEdit;
    edtBarcode: TAdvEdit;
    btnLostCancel: TsButton;
    csInLpr4: TClientSocket;
    csInLpr5: TClientSocket;
    tAlive: TTimer;
    csInDsp4: TClientSocket;
    csInDsp5: TClientSocket;
    pnBar: TPanel;
    btnBar1: TAdvToolButton;
    btnBar2: TAdvToolButton;
    btnBar3: TAdvToolButton;
    btnBar4: TAdvToolButton;
    btnBar5: TAdvToolButton;
    btnBar6: TAdvToolButton;
    btnBar7: TAdvToolButton;
    btnBar8: TAdvToolButton;
    btnBarClose: TAdvToolButton;
    Panel13: TPanel;
    btnBar9: TAdvToolButton;
    btnBar10: TAdvToolButton;
    idTS: TIdTCPServer;
    IdStack1: TIdServerIOHandlerStack;
    idTC: TIdTCPClient;
    idStack2: TIdIOHandlerStack;
    qryCtrl: TADOQuery;
    imgLogo: TImage;
    tSCWait: TTimer;
    tNCInWait: TTimer;
    tNCOutWait: TTimer;
    lbMCreditCnt: TLabel;
    Label8: TLabel;
    Label9: TLabel;
    lbMCreditTot: TLabel;
    edtCharo: TEdit;
    btnBar: TAdvShapeButton;
    btnSCSearch: TAdvShapeButton;
    mnuSCSearch: TMenuItem;
    mnuBarProc: TMenuItem;
    mnuClosing: TMenuItem;
    mnuCarSearch: TMenuItem;
    mnuManualIn: TMenuItem;
    mnuManualOut: TMenuItem;
    lbOutCarType: TLabel;
    mnuSearch: TMenuItem;
    btnWebDC1: TAdvShapeButton;
    btnWebDC2: TAdvShapeButton;
    btnWebDC3: TAdvShapeButton;
    btnWebDC4: TAdvShapeButton;
    btnWebDC5: TAdvShapeButton;
    btnWebDC6: TAdvShapeButton;
    btnWebDC7: TAdvShapeButton;
    btnWebDC8: TAdvShapeButton;
    btnWebDC9: TAdvShapeButton;
    btnWebDC10: TAdvShapeButton;
    btnWebDC11: TAdvShapeButton;
    btnWebDC12: TAdvShapeButton;
    btnWebDC13: TAdvShapeButton;
    btnWebDC14: TAdvShapeButton;
    btnWebDC15: TAdvShapeButton;
    btnWebDC16: TAdvShapeButton;
    btnWebDC17: TAdvShapeButton;
    btnWebDC18: TAdvShapeButton;
    btnWebDC19: TAdvShapeButton;
    btnWebDC20: TAdvShapeButton;
    btnOp: TPanel;
    pnManualOut: TsPanel;
    sLabel32: TsLabel;
    btnManualOutOk: TsButton;
    btnManualOutCancel: TsButton;
    edtOutTime: TsMaskEdit;
    edtOutDate: TsDateEdit;
    pnManual: TsPanel;
    sLabel31: TsLabel;
    Label6: TLabel;
    edtManualCarNo: TEdit;
    btnManualOK: TsButton;
    btnManualCancel: TsButton;
    pnModify: TsPanel;
    sLabel28: TsLabel;
    Label4: TLabel;
    edtMCarNo: TEdit;
    btnMOK: TsButton;
    btnMCancel: TsButton;
    Panel2: TPanel;
    imgModify: TImage;
    pnlReceipt: TsPanel;
    sLabelReceipt: TsLabel;
    lbReceipt: TListBox;
    pnManualProc: TPanel;
    Label10: TLabel;
    Label12: TLabel;
    Panel4: TPanel;
    Panel3: TPanel;
    imgManual: TImage;
    pnNManualProc: TPanel;
    Panel6: TPanel;
    Label11: TLabel;
    imgNManual: TImage;
    dgNManualProc: TDBAdvGrid;
    edtManualProcCarNo: TEdit;
    edtManualProcDate: TDateTimePicker;
    pnSManualProc: TPanel;
    DBAdvGrid2: TDBAdvGrid;
    btnManualSeek: TBitBtn;
    btnManualProc: TBitBtn;
    btnManualSCOut: TBitBtn;
    edtManualOutTime: TsMaskEdit;
    btnManualOutProc: TBitBtn;
    btnManualProcCancel: TsButton;
    pnSCSearch: TPanel;
    Label7: TLabel;
    DBAdvGrid1: TDBAdvGrid;
    btnSCOut: TsButton;
    btnSCCancel: TsButton;
    btnSC: TBitBtn;
    edtSCCarNo: TEdit;
    csAps: TClientSocket;
    mnuClosingPrt: TMenuItem;
    mnuReceiptPrt: TMenuItem;
    btnBar11: TAdvToolButton;
    btnBar12: TAdvToolButton;
    btnBar13: TAdvToolButton;
    btnBar14: TAdvToolButton;
    btnBar15: TAdvToolButton;
    btnBar16: TAdvToolButton;
    btnBar17: TAdvToolButton;
    btnBar18: TAdvToolButton;
    edtManualOutCarNo1: TEdit;
    Label5: TLabel;
    edtManualOutCarNo: TEdit;
    Label13: TLabel;
    btnMode: TButton;
    N1: TMenuItem;
    mnuCreditReceipt: TMenuItem;
    mnuCashReceipt: TMenuItem;
    comScanner: TApdComPort;
    comMSReader: TApdComPort;
    edtMGReader: TEdit;
    btnMGReader: TsBitBtn;
    Label14: TLabel;
    Label15: TLabel;
    edtDCRemain: TEdit;
    Label16: TLabel;
    Button5: TButton;
    Button6: TButton;
    N2: TMenuItem;
    N3: TMenuItem;
    tDbCheck: TTimer;
    edtOcsCar: TEdit;
    Label17: TLabel;
    edtOcsCode: TEdit;
    Label18: TLabel;
    procedure btnCloseClick(Sender: TObject);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure mnuSetupClick(Sender: TObject);
    procedure mnuUnitInfoClick(Sender: TObject);
    procedure mnuInDspClick(Sender: TObject);
    procedure mnuOutDspClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure Button2Click(Sender: TObject);
    procedure Button3Click(Sender: TObject);
    procedure tInDspTimer(Sender: TObject);
    procedure tOutDspTimer(Sender: TObject);
    procedure edtProcYogumChange(Sender: TObject);
    procedure csInLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnReceiptClick(Sender: TObject);
    procedure btnProcClick(Sender: TObject);
    procedure btn1Click(Sender: TObject);
    procedure btn2Click(Sender: TObject);
    procedure btn3Click(Sender: TObject);
    procedure btn4Click(Sender: TObject);
    procedure btn5Click(Sender: TObject);
    procedure btn6Click(Sender: TObject);
    procedure btn7Click(Sender: TObject);
    procedure btn8Click(Sender: TObject);
    procedure btn9Click(Sender: TObject);
    procedure btn10Click(Sender: TObject);
    procedure btn11Click(Sender: TObject);
    procedure btn12Click(Sender: TObject);
    procedure btn13Click(Sender: TObject);
    procedure btn14Click(Sender: TObject);
    procedure btn15Click(Sender: TObject);
    procedure btn16Click(Sender: TObject);
    procedure btnCancelClick(Sender: TObject);
    procedure FormKeyPress(Sender: TObject; var Key: Char);
    procedure btnManualInClick(Sender: TObject);
    procedure btnManualOutClick(Sender: TObject);
    procedure btnManualOutOkClick(Sender: TObject);
    procedure btnManualOutCancelClick(Sender: TObject);
    procedure btnCarSearchClick(Sender: TObject);
    procedure dgLostClick(Sender: TObject);
    procedure btnSeekClick(Sender: TObject);
    procedure btnLostProcClick(Sender: TObject);
    procedure btnClosingClick(Sender: TObject);
    procedure btnBarClick(Sender: TObject);
    procedure edtBarcodeKeyPress(Sender: TObject; var Key: Char);
    procedure btnLostCancelClick(Sender: TObject);
    procedure edtOutTimeKeyPress(Sender: TObject; var Key: Char);
    procedure csInLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr5Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnBarCloseClick(Sender: TObject);
    procedure btnMinimizeClick(Sender: TObject);
    procedure idTSExecute(AContext: TIdContext);
    procedure btnBar1Click(Sender: TObject);
    procedure sgInDblClickCell(Sender: TObject; ARow, ACol: Integer);
    procedure btnMOKClick(Sender: TObject);
    procedure btnMCancelClick(Sender: TObject);
    procedure btnBar2Click(Sender: TObject);
    procedure btnBar3Click(Sender: TObject);
    procedure btnBar4Click(Sender: TObject);
    procedure btnBar5Click(Sender: TObject);
    procedure btnBar6Click(Sender: TObject);
    procedure btnBar7Click(Sender: TObject);
    procedure btnBar8Click(Sender: TObject);
    procedure btnBar9Click(Sender: TObject);
    procedure btnBar10Click(Sender: TObject);
    procedure mnuDetailClick(Sender: TObject);
    procedure lbReceiptDblClick(Sender: TObject);
    procedure btnManualOKClick(Sender: TObject);
    procedure btnManualCancelClick(Sender: TObject);
    procedure edtManualCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure tSCWaitTimer(Sender: TObject);
    procedure tNCInWaitTimer(Sender: TObject);
    procedure tNCOutWaitTimer(Sender: TObject);
    procedure btnSCCancelClick(Sender: TObject);
    procedure btnSCClick(Sender: TObject);
    procedure btnSCOutClick(Sender: TObject);
    procedure DBAdvGrid1Click(Sender: TObject);
    procedure btnSCSearchClick(Sender: TObject);
    procedure mnuSCSearchClick(Sender: TObject);
    procedure mnuBarProcClick(Sender: TObject);
    procedure mnuClosingClick(Sender: TObject);
    procedure mnuCarSearchClick(Sender: TObject);
    procedure mnuManualInClick(Sender: TObject);
    procedure mnuManualOutClick(Sender: TObject);
    procedure edtLostCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure btnManualSeekClick(Sender: TObject);
    procedure dgNManualProcClick(Sender: TObject);
    procedure btnManualProcClick(Sender: TObject);
    procedure btnManualSCOutClick(Sender: TObject);
    procedure edtSCCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure edtManualProcCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure btnManualOutProcClick(Sender: TObject);
    procedure edtManualOutTimeKeyPress(Sender: TObject; var Key: Char);
    procedure DBAdvGrid2Click(Sender: TObject);
    procedure FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
    procedure btnManualProcCancelClick(Sender: TObject);
    procedure mnuSearchClick(Sender: TObject);
    procedure csInDsp1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp4Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp5Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csOutDsp1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure csOutDsp2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure csOutDsp3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure csOutLpr1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure csOutLpr2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure csOutLpr3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure csInLpr1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr4Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr5Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr4Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr5Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp4Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp5Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnOpClick(Sender: TObject);
    procedure csApsConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csApsDisconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csApsError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csApsRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure mnuClosingPrtClick(Sender: TObject);
    procedure mnuReceiptPrtClick(Sender: TObject);
    procedure btnBar11Click(Sender: TObject);
    procedure btnBar12Click(Sender: TObject);
    procedure btnBar13Click(Sender: TObject);
    procedure btnBar14Click(Sender: TObject);
    procedure btnBar15Click(Sender: TObject);
    procedure btnBar16Click(Sender: TObject);
    procedure btnBar17Click(Sender: TObject);
    procedure btnBar18Click(Sender: TObject);
    procedure btnModeClick(Sender: TObject);
    procedure N1Click(Sender: TObject);
    procedure comScannerTriggerAvail(CP: TObject; Count: Word);
    procedure comMSReaderTriggerAvail(CP: TObject; Count: Word);
    procedure btnMGReaderClick(Sender: TObject);
    procedure Button5Click(Sender: TObject);
    procedure Button6Click(Sender: TObject);
    procedure N2Click(Sender: TObject);
    procedure N3Click(Sender: TObject);
    procedure tDbCheckTimer(Sender: TObject);
    procedure tAliveTimer(Sender: TObject);
    procedure FormMouseDown(Sender: TObject; Button: TMouseButton;
      Shift: TShiftState; X, Y: Integer);
  private
    { Private declarations }
    procedure ClearFormData(flag:Integer=0);
    procedure T_ProcClear;
    procedure ClearGTime;
    procedure ClearDCProc;
    procedure InOpen(csLPR: TClientSocket);
    Procedure OutOpen(csLPR: TClientSocket);
    procedure FormAlign;
    procedure dcBtnClick(dcBtn: TAdvShapeButton; dcMnu: TMenuItem);
    procedure btnClick(btn: TAdvShapeButton; mnu: TMenuItem);
    function IntToBool(nNo: Integer): Boolean;
    procedure ICMPReply(ASender: TComponent; const ReplyStatus: TReplyStatus);
    function is_ping(IP: AnsiString): Boolean;
    procedure UnitCtrl(nCmd, nFCNo, nUnitNo, nMNo: Word; sData: AnsiString);
    function JulsaProc(nOrgAmt: Integer): Integer;
    procedure BarcodeProc(sSerial, sExpDate, sDCType, sDCAmt: AnsiString);
    procedure MinwonProc(csLPR: TClientSocket);
    procedure FreeTimeProc(csLPR: TClientSocket);
    function unknownRevData(inData: string): Boolean;

  public
    { Public declarations }
    function RecvLprProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
      sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
      sDspIP: AnsiString; csLPR: TClientSocket; bOpen: Boolean): String;
    procedure MichulProc(sCarNo, sProcDate, sProcTime: AnsiString);
    procedure NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
      sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
      sDspIP: AnsiString; csLPR: TClientSocket);
    procedure NormalProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
      sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
      sDspIP: AnsiString; csLPR: TClientSocket; bOpen: Boolean);
    function chkHoliday(sDate: AnsiString): Boolean;
    procedure DCEnable(bCheck: Boolean);
    procedure MoneyProc(csLPR: TClientSocket);
    // nIO: 1-입구, 2-출구    nType: 1-정기차량, 2-일반차량, 3-요금표시, 4-주차요금0원
    procedure DspProc(nIO, nType: Byte; sData, sDspIP: AnsiString);
    procedure ManualOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
      sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte);
    procedure GridClear;
    procedure GridData(sResult: String);
    procedure NGridData(sResult: String);
    procedure PartGridData(sResult: String);
    procedure WebDCDetail(nCnt: Integer);
    procedure WebDCProc(sWebDC: String);
    procedure FixedDCProc(sCarno: String);
    procedure FixedDCDetail(nDCNo: Integer);
    procedure DCProcess(sNowTKno: String);
//    procedure BarCodeDCDetail(nCnt: Integer);
    procedure BarCodeDCDetail(nDiscountCode: Integer);
    procedure CancelDataProc;
    procedure WaitClear;
    procedure InitProc;
    function GracetimeCheck(sInTime, sNow: AnsiString): Boolean;
    function DCFixedCheck(sUseWeekDay,sCarNo: AnsiString; nDayCount,nMonthCount: Integer): Boolean;
    procedure FcModeChange(nMode: Byte);
    procedure FreeOpenOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
      sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte);
    procedure MGDCDetail(sIssueDate, sDCType , sDCCode , sParkNo , sNumber : AnsiString);
    procedure BarCodeDCProc(sNowTKno,codeStr: String);
    function DJSM_FeeCalc(nParkNo : Integer; nOrignFeeNo : Integer; sStartDateTime, sEndDateTime : AnsiString): Integer;
    function DJSM_FeeCalcEx(nParkNo : Integer; nOrignFeeNo : Integer; sStartDateTime, sEndDateTime : AnsiString; iYugum: Integer = 0): Integer;
    procedure OCSDCProc(sNowTKno: String);
    procedure OCSDCProcEx(sNowTKno,barC: String); //바코드 할인을위해 확장해서 만듬
    procedure OCSDCDetail(nDiscountCode: Integer);
    procedure OCSDCDetailEx(nDiscountCode,sameDcCnt: Integer);
    function OCSAdminDCDetail(nDCValue: Integer): Integer;
    procedure OCSDCProc_CAR(sNowTKno: String);//OCS 인지 일반차량 구분
    //21.04.01 OCS 처리속도 개선부분
    procedure OCSDCProc_CAR_Ex(sNowTKno: String);//OCS 인지 일반차량 구분
    procedure OCSDCProc_Ex(sNowTKno: String);  //OCS 할인 처리
    procedure OCSDCProc_Ex_Bar(sNowTKno, barC: String);  //OCS 바코드할인 처리
    function  OCSAdminDCDetail_Ex(nDCValue: Integer): Integer;
    function  OCSAdminDCDetail_DCTime(nTimeDC: Integer): Integer;

    procedure BarCodeTest;//바코드 테스트 임시 함수
    procedure CenterControl(AControl: TControl); //바코드 수동입력

    procedure InCarList; //입차 내역 조회
    procedure OutCarList; //출차 내역 조회
    procedure TrimAppMemorySize; //메모리 최적화 (속도 땜시)
  end;

var
  frmMainNew: TfrmMainNew;
  bLostProc: Boolean = False;
  sChkDateTime, sNextDateTime, sInDate, sInTime, sOutDate, sOutTime, sChkDate,
    sChkTime, sNextTime: AnsiString;
  nYogum, nTotYogum, nTotYogum2, nItemMax, nTotMax, nDayCnt, nItemMax0, nTotMax0: Cardinal;
  nFeeNo: Word = 0;
  nDCList: Byte = 0;
  nowLpr, ManualLpr: TClientSocket;
  ping_success: Boolean = False;

  // 정기차량 처리대기용 변수들
  bSCProcWait: Boolean = False;
  nSCWaitFlag: Byte = 0; // 처리할 데이터 위치
  nSCWaitPoint: Byte = 0; // 대기 데이터 위치
  RSCWait: Array [1 .. 20] of R_SCWait;

  // 일반차량 처리대기용 변수들
  bNCInProcWait: Boolean = False;
  bNCOutProcWait: Boolean = False;
  nNCInWaitFlag: Byte = 0; // 처리할 데이터 위치
  nNCInWaitPoint: Byte = 0; // 대기 데이터 위치
  nNCOutWaitFlag: Byte = 0; // 처리할 데이터 위치
  nNCOutWaitPoint: Byte = 0; // 대기 데이터 위치
  RNCInWait: Array [1 .. 20] of R_NCWait;
  RNCOutWait: Array [1 .. 20] of R_NCWait;

  // 정기차량 수동출차 차량번호
  sManualSCCarNo: String;

  lprLiveThd: TThread;

  test_OcsNo: string = '';

  bufBarc: string = '';

  nowUseTime: Integer = 0; //보호자차감 현재 사용시간(분)
  overUseTime: Integer = 0; //보호자차감 초과사용시간(분)

function DBConnect(pDBIP: Pointer): Boolean; StdCall; external 'Tariff.dll';
function FeeCalc(nParkNo: Integer; nFeeNo: Integer; pInDateTime: Pointer;
  pOutDateTime: Pointer): Integer; StdCall; external 'Tariff.dll';
function ReturnFee(nParkNo: Integer; nFeeNo: Integer; pInDateTime: Pointer;
  pOutDateTime: Pointer): Integer; StdCall; external 'Tariff.dll';

function IcmpCreateFile : THandle; stdcall; external 'icmp.dll';
function IcmpCloseHandle (icmpHandle : THandle) : boolean; stdcall; external 'icmp.dll';
function IcmpSendEcho (IcmpHandle    : THandle;  DestinationAddress: LongInt;
                       RequestData   : Pointer;  RequestSize       : Smallint;
                       RequestOptions: pointer;  ReplyBuffer       : Pointer;
                       ReplySize     : DWORD;    Timeout           : DWORD): DWORD;
                       stdcall; external 'icmp.dll';

implementation

uses
  Global, Tables, Login, Setup, UnitInfo, Closing, InDspSet, DspSet, PaySelect,ClosingPrint, ReceiptPrt, Msg,
  Credit_SMT, Cancel_SMT, Cash_SMT,
  cashOption, CashSelect;//, Credit_SMT, Credit_SMTCancel, Cash_SMTCancel, Cash_SMT,  Smartro;
  // Credit_Kicc, Cash_Kicc, Cancel_Kicc;
{$R *.dfm}

procedure TfrmMainNew.OCSDCProcEx(sNowTKno,barC: String);
var
  sPATIENTNO  : array of aString;   //환자번호 변수
  sDCCODE, sDCCODE_PAST : array of aString;   //병원에 등록된 OCS할인정보 변수
  sRECEIPTDATE, sRECEIPTDATE_PAST : array of aString;   //병원에 등록된 수납일자 변수
  sPID, sPID_PAST : array of aString;   //병원에 등록된 PID변수
  bIsPast : Boolean;                  //어제할인인지.
  bIsAdmission : Boolean;             //입원할인 처리여부
  I, J : Integer;                     //for 반복문용 변수할당

  tempString  : aString;              //임시저장용 string 변수
  nTempDCNo   : Integer;              //임시저장용 할인코드
  sAdmStartDate : aString;            //입원할인시작일
  sAdmEndDate   : aString;
  nAdmDateCount : Integer;            //입원일 수
  nAdmDateTime : Integer;            //남은 시간(1일 이상 주차 시)

  nAlreadyDCValue : Integer;    //입원일 재입차시 사용한 할인값
  nRemainDCValue  : Integer;    //입원일 재입차시 잔여 할인값
  nTotRemainTime: Integer; //입원일기간 총 보호자차감 잔여분

  bIsPatient : Boolean;

  nTimeDC : Integer;
  sEndDateTime : aString;
  //보호자 할인 처리 변수
  nprocdate, nprocTime, nprocdate_nprocTime, nFirstpdateTime :astring;

  //디비 속도 향상 (OCS)
  SQL_Field, SQL_Field2, SQL_Field3, SQL_Field4, SQL_Field5: TField;
  //디비 속도 향상
  SQL_Field6, SQL_Field7, SQL_Field8, SQL_Field9, SQL_Field10: TField;
  sDISCFLAG, sDISCCD, sRCPTDD, nPID, sHANDICAPRYN : aString;
  asPATIENTNO, asDCCODE, asDCCODE_PAST : Integer;
begin
  //대전성모병원 OCS할인처리 시작
  tempString := barC;
  ExceptLogging('***************************************************************');
  ExceptLogging('[바코드할인] 대전성모병원 OCS 정보 처리 시작');
  sAdmStartDate := '';
  sAdmEndDate   := '';
  nAdmDateCount := 0;
  bIsPatient := False;

  nAlreadyDCValue := 0;
  nRemainDCValue  := 0;

  bHandicap := False; //장애인 여부 변수 초기화
  bNational := False; //국가유공자 여부 변수 초기화
  sPATIENTNO := nil;  //환자 번호 초기화

  nsAdmDateCount := 0;  //할인 횟수 카운팅

  //디비 속도 향상
  SQL_Field := TField.Create(self);
  SQL_Field2 := TField.Create(self);
  SQL_Field3 := TField.Create(self);
  SQL_Field4 := TField.Create(self);
  SQL_Field5 := TField.Create(self);

  SQL_Field6 := TField.Create(self);
  SQL_Field7 := TField.Create(self);
  SQL_Field8 := TField.Create(self);
  SQL_Field9 := TField.Create(self);
  SQL_Field10 := TField.Create(self);

  try

    {$REGION '채번된 환자번호로 OCS할인'}
    ExceptLogging('채번된 환자번호로 OCS할인정보 획득 시작');
    try
      bIsAdmission := False;
      with dmTables.qryOCS do begin
        dmTables.qryOCS.DisableControls;
        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 연동 당일 바코드 할인 코드 시작(쿼리 시간) : ' + OCSTIME);

        Close;
        SQL.Clear;
        SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
        SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS Where PID = ''' + QuotedStr(tempString) + ''' ');
        SQL.Add('ORDER BY DISCCD ASC, RCPTDD ASC, RCPTTM ASC '')');
        ExceptLogging('OCS 당일 할인정보 획득 쿼리 : ' + SQL.Text);
        Open;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 연동 당일 바코드 할인 코드 중간(쿼리 시간) : ' + OCSTIME);

        if RecordCount > 0 then begin
          SetLength(sDCCODE, RecordCount);
          SetLength(sRECEIPTDATE, RecordCount);
          SetLength(sPID, RecordCount);
          //bIsPatientUse := 1;
          I := 1;

          SQL_Field2 := FieldByName('DISCFLAG');
          SQL_Field3 := FieldByName('DISCCD');
          SQL_Field4 := FieldByName('RCPTDD');
          SQL_Field := FieldByName('PID');
          SQL_Field5 := FieldByName('HANDICAPRYN');
          //21.03.17 수정
          while not Eof do begin
           //디비 속도 향상
            sDISCFLAG := SQL_Field2.AsString;
            sDISCCD   := SQL_Field3.AsString;
            sRCPTDD   := SQL_Field4.AsString;
            //nPID      := SQL_Field4.AsString;
            nPID      := SQL_Field.AsString;
            sHANDICAPRYN   := SQL_Field5.AsString;

            if sDISCFLAG = '02' then begin //시간
              if (sDISCCD = '01') or
                 (sDISCCD = '02') or
                 (sDISCCD = '03') or
                 (sDISCCD = '04') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE[I-1]      := sDISCCD; //tempString;

                sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID[I-1] := nPID;
                Inc(I);
              end else begin
                ExceptLogging('병원에서 제공한 할인코드가 상이함.. 할인 불가능');
                ExceptLogging('DISCCD : ['+sDISCCD+'] ');
                ExceptLogging('DISCFLAG : ['+sDISCFLAG+'] ');
              end;
            end else if sDISCFLAG = '01' then begin //당일
              if (sDISCCD = '05') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE[I-1]      := sDISCCD;
                sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID[I-1] := nPID;
                Inc(I);
              end;
            end;
            Next;
          end;

//          while not Eof do begin
//            if FieldByName('DISCFLAG').AsString = '02' then begin //시간
//              if (FieldByName('DISCCD').AsString = '01') or
//                 (FieldByName('DISCCD').AsString = '02') or
//                 (FieldByName('DISCCD').AsString = '03') or
//                 (FieldByName('DISCCD').AsString = '04') then begin
//                ExceptLogging(FieldByName('DISCFLAG').AsString+' '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE[I-1]      := FieldByName('DISCCD').AsString; //tempString;
//                {sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end else begin
//                ExceptLogging('병원에서 제공한 할인코드가 상이함.. 할인 불가능');
//                ExceptLogging('DISCCD : ['+FieldByName('DISCCD').AsString+'] ');
//                ExceptLogging('DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
//              end;
//            end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
//              if (FieldByName('DISCCD').AsString = '05') then begin
//                ExceptLogging(FieldByName('DISCFLAG').AsString+' '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE[I-1]      := FieldByName('DISCCD').AsString;
//                {sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end;
//            end;
//
//            {if (not bHandicap) and (FieldByName('HANDICAPRYN').AsString = 'Y') then begin
//              ExceptLogging('PMOVPKDS ['+sNowLprCarNo1+'] 차량 장애인 등록여부 확인됨: '+FieldByName('HANDICAPRYN').AsString);
//              bHandicap := True;
//            end;}
//
//            Next;
//          end;
        end else begin
          bIsPatientUse := 0;
          ExceptLogging('OCS 당일 할인정보 테이블내 현재 차량 정보 없음! ');
          ExceptLogging('.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
        end;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 바코드 할인 코드 시작(쿼리 시간) : ' + OCSTIME);
        Close;
        SQL.Clear;
        SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
        SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS_PAST Where PID = ''' + QuotedStr(tempString)+''' ');
        SQL.Add(' '')');
        ExceptLogging('OCS 전날 할인정보 획득 쿼리 : ' + SQL.Text);
        Open;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 바코드 할인 코드 중간(쿼리 시간) : ' + OCSTIME);

        if RecordCount > 0 then begin
          SetLength(sDCCODE_PAST, RecordCount);
          SetLength(sRECEIPTDATE_PAST, RecordCount);
          SetLength(sPID_PAST, RecordCount);
          //bIsPatientUse := 1;
          I := 1;
          //21.03.17 수정
          SQL_Field2 := FieldByName('DISCFLAG');
          SQL_Field3 := FieldByName('DISCCD');
          SQL_Field4 := FieldByName('RCPTDD');
          SQL_Field := FieldByName('PID');
          SQL_Field5 := FieldByName('HANDICAPRYN');

          while not Eof do begin
           //디비 속도 향상
            sDISCFLAG := SQL_Field2.AsString;
            sDISCCD   := SQL_Field3.AsString;
            sRCPTDD   := SQL_Field4.AsString;
            //nPID      := SQL_Field4.AsString;
            nPID      := SQL_Field.AsString;
            sHANDICAPRYN   := SQL_Field5.AsString;

            if sDISCFLAG = '02' then begin //시간
              if //(sDISCCD = '01') or
                 //(sDISCCD = '02') or
                 (sDISCCD = '03') or
                 (sDISCCD = '04') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE_PAST[I-1]      := sDISCCD; //tempString;

                sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID_PAST[I-1] := nPID;
                Inc(I);
              end else begin
                ExceptLogging('병원에서 제공한 할인코드가 상이함.. 할인 불가능');
                ExceptLogging('DISCCD : ['+sDISCCD+'] ');
                ExceptLogging('DISCFLAG : ['+sDISCFLAG+'] ');
              end;
            end else if sDISCFLAG = '01' then begin //당일
              if (sDISCCD = '05') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE_PAST[I-1]      := sDISCCD;
                sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID_PAST[I-1] := nPID;
                Inc(I);
              end;
            end;
            Next;
          end;
//          while not Eof do begin
//            if FieldByName('DISCFLAG').AsString = '02' then begin //시간
//              //if (FieldByName('DISCCD').AsString = '01') or
//              //   (FieldByName('DISCCD').AsString = '02') or
//              if  (FieldByName('DISCCD').AsString = '03') or
//                 (FieldByName('DISCCD').AsString = '04') then begin
//                ExceptLogging(FieldByName('DISCFLAG').AsString+' '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE_PAST[I-1]      := FieldByName('DISCCD').AsString; //tempString;
//                {sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID_PAST[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end else begin
//                ExceptLogging('병원에서 제공한 할인코드가 상이함.. 할인 불가능');
//                ExceptLogging('DISCCD : ['+FieldByName('DISCCD').AsString+'] ');
//                ExceptLogging('DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
//              end;
//            end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
//              if (FieldByName('DISCCD').AsString = '05') then begin
//                ExceptLogging(FieldByName('DISCFLAG').AsString+' '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE_PAST[I-1]      := FieldByName('DISCCD').AsString;
//                {sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID_PAST[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end;
//            end;
//            Next;
//          end;
        end else begin
          bIsPatientUse := 0;
          ExceptLogging('OCS 전날 할인정보 테이블내 현재 차량 정보 없음! ');
          ExceptLogging('.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
        end;
        dmTables.qryOCS.EnableControls;
      end;

      OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
      ExceptLogging('OCS 전날 할인정보 바코드 할인 끝(쿼리 시간) : ' + OCSTIME);
      bIsPast := False;

      asDCCODE := Length(sDCCODE);
      {if Length(sDCCODE) = 0 then begin
        //당일 할인이 한개도 없을경우, 전날할인을 본다
        sDCCODE      := sDCCODE_PAST;
        sRECEIPTDATE := sRECEIPTDATE_PAST;
        sPID         := sPID_PAST;
        bIsPast      := True;
      end;}

      if asDCCODE = 0 then begin
        //당일 할인이 한개도 없을경우, 전날할인을 본다
        sDCCODE      := sDCCODE_PAST;
        sRECEIPTDATE := sRECEIPTDATE_PAST;
        sPID         := sPID_PAST;
        bIsPast      := True;
      end;
      asDCCODE := Length(sDCCODE);
      asDCCODE_PAST := Length(sDCCODE_PAST);

     // if Length(sDCCODE) > 0 then begin
      if asDCCODE > 0 then begin
        //for I := 0 to Length(sDCCODE) - 1 do begin
        for I := 0 to asDCCODE - 1 do begin
          nTempDCNo := 0;
          with dmTables.qryOCSProc do begin
            dmTables.qryOCSProc.DisableControls;
            if (bIsAdmission = True) and ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin
            end else begin
              if ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin
                //입원할인 처리 진입한경우 변수할당하여 입원할인 중복처리 불가하도록..
                bIsPatientUse := 1;
                bIsAdmission := True;
                //OCS에서 입원시작일 정보 가져오기
                if (sDCCODE[I] = '03') then begin //할인코드 03인경우 수납일 = 입원일임.
                  sAdmStartDate := sRECEIPTDATE[I];
                end else if (sDCCODE[I] = '04') then begin
                  //if Length(sDCCODE_PAST) > 0 then begin
                  if asDCCODE_PAST > 0 then begin
                    //for J := 0 to Length(sDCCODE_PAST) - 1 do begin
                    for J := 0 to asDCCODE_PAST - 1 do begin
                      if (sDCCODE_PAST[J] = '03') and (sPID_PAST[J] = sPID[I]) then begin
                        sAdmStartDate := sRECEIPTDATE_PAST[J]; //입원일 변수 할당
                      end;
                    end;

                    if sAdmStartDate = '' then begin
                      sAdmStartDate := sRECEIPTDATE[I];
                    end;
                  end else begin
                    sAdmStartDate := sRECEIPTDATE[I];
                  end;
                end;
//                 and (sDCCODE_PAST[I] = '03') then begin //당일 할인코드 04, 전날 할인코드 03인경우 전날 데이터 수납일 = 입원일임.
//                  sAdmStartDate := sRECEIPTDATE_PAST[I];
//                end else if (sDCCODE[I] = '04') and not (sDCCODE_PAST[I] = '03') then begin //당일 할인코드 04, 전날 할인코드 03이 아닌경우 당일 데이터가 수납일이됨.
//                  sAdmStartDate := sRECEIPTDATE[I];
//                end;

                //OCS에서 퇴원일 정보 가져오기
                if bIsPast then begin
                  sAdmEndDate := MG_AddDate(Copy(aString(lbOutTime.Caption), 1, 10), -1);
                end else begin
                  sAdmEndDate := Copy(aString(lbOutTime.Caption), 1, 10);
                end;

                //가져와진 입원일자랑 입차일자 비교 시작
                if sAdmStartDate > Copy(aString(lbInTime.Caption), 1, 10) then begin
                  sAdmStartDate := sAdmStartDate;
                end else begin
                  sAdmStartDate := Copy(aString(lbInTime.Caption), 1, 10);
                end;

                //퇴원일자 조정 : 전날할인 들고왔을 경우에 시작일이 퇴원일보다 더클경우 문제발생
                if sAdmEndDate < sAdmStartDate then
                  sAdmEndDate := sAdmStartDate;

                //보호자(6H), 입원(6H) 할인은 입차후 24시간 할인(1일) 적용 시키도록 적용
                if (sDCCODE[I] = '03') or (sDCCODE[I] = '04') then
                begin
                  //nAdmDateCount := 1;
                   nsAdmDateCount := 0;
                   nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                       IncHour(StrToDateTime(aString(lbInTime.Caption)), 24));
                   ExceptLogging('보호자 할인 할인 횟수 : '+inttostr(nAdmDateCount));

                  //보호자 할인 (6h)할인은 입차 후 24시간으로 계산 후 할인 적용  11.05
                  //우선 할인 적용 있는지 확인 여부
                  nprocdate := '';
                  nprocTime := '';
                  ExceptLogging('OCS 날짜 '+sAdmStartDate);
                  //입원 당시 날짜로 입차 최초의 할인 시간 및 날짜 조회 입차 후 24시간 계산  11.05
                  Close;
                  SQL.Clear;
                  SQL.Add('SELECT Top 1 * from IONDATA');
                  SQL.Add('where ProcDate = :V1 AND InCarNo1 = :V2 ');
                  SQL.Add('order by procdate asc, proctime asc   ');
                  Parameters.ParamByName('v1').Value := sAdmStartDate;
                  Parameters.ParamByName('v2').Value := sNowLprCarNo1;
                  ExceptLogging(sql.Text);
                  Open;

                  if RecordCount > 0 then begin
                    //21.03.15 디비 속도 향상
                    SQL_Field6 := FieldByName('procdate');   //날짜
                    SQL_Field7 := FieldByName('procTime');   //시간
                    nprocdate  := SQL_Field6.AsString;
                    nprocTime  := SQL_Field7.AsString;

//                    nprocdate := FieldByName('procdate').AsString;   //날짜
//                    nprocTime := FieldByName('procTime').AsString;   //시간
                    nFirstpdateTime := nprocdate+' '+nprocTime;
                    //최초 입차 후 24시간 계산
                    ExceptLogging('최초 입차 : '+ nFirstpdateTime);
                    nprocdate_nprocTime := DateTimetostr(IncHour(StrToDateTime(nprocdate+' '+nprocTime), 24));
                    ExceptLogging('최초 입차 후 24시간 후: '+ nprocdate_nprocTime);

                    //마지막 입차 후 24시간 후의 날짜 보다 현재 입차가 날짜가 크면 보호자 할인 시간 0분적용
                    if IncHour(StrToDateTime(aString(nFirstpdateTime)), 24) < StrToDateTime(aString(lbInTime.Caption)) then
                    begin
                          nAdmDateCount := 0;
                    end
                    else
                    begin
                        {nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                            IncHour(StrToDateTime(aString(nFirstpdateTime)), 24));
                        ExceptLogging('OCS 할인 할인 횟수(최초 입차 날짜 기준) : '+inttostr(nAdmDateCount));}

                         //nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                        nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                    StrToDateTime(aString(lbOutTime.Caption)));

                        if nAdmDateCount = 0 then
                        begin
                           //nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                            nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                        StrToDateTime(aString(lbOutTime.Caption))) + 1;
                        end
                        else
                        begin
                           //nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                           nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                       StrToDateTime(aString(lbOutTime.Caption)));
                        end;

                        nFirstpdateTime := nFirstpdateTime;
                        nprocdate_nprocTime := DateTimeToStr(IncHour(StrToDateTime(aString(nFirstpdateTime)), 24 * nAdmDateCount));
                        ExceptLogging('보호자입차2 : '+nFirstpdateTime);
                        ExceptLogging('보호자입차(24시간 후)2 : '+nprocdate_nprocTime);

                    end;

                    //보호자 할인 입차 후 24시간이내에      11.05
                    //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                    Close;
                    SQL.Clear;
                    SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                    SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                    SQL.Add('FROM DCDetail ');
                    SQL.Add('WHERE 1=1 ');
                    if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                    end else begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                    end;
                    //SQL.Add('AND ProcDate + ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND ProcDate +'' ''+ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                    SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                    Parameters.ParamByName('v1').Value := nFirstpdateTime;//nprocdate +' '+nprocTime;   //최초 입차
                    Parameters.ParamByName('v2').Value := nprocdate_nprocTime;        //입차 후 24시간
                    ExceptLogging(sql.Text);
                    Open;
                  end
                  else
                  begin
                     //보호자 할인 입차 후 24시간이내에      11.05
                    //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.

                    nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                                StrToDateTime(aString(lbOutTime.Caption)));
                    ExceptLogging('OCS 할인 할인 횟수 3: '+inttostr(nAdmDateCount));
                    if nAdmDateCount = 0 then
                    begin
                       nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                                   StrToDateTime(aString(lbOutTime.Caption))) + 1;
                       ExceptLogging('OCS 할인 할인 횟수4 : '+inttostr(nAdmDateCount));
                    end;

                    Close;
                    SQL.Clear;
                    SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                    SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                    SQL.Add('FROM DCDetail ');
                    SQL.Add('WHERE 1=1 ');
                    if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                    end else begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                    end;
                    //SQL.Add('AND ProcDate + ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND ProcDate +'' ''+ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                    SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                    Parameters.ParamByName('v1').Value := aString(lbInTime.Caption);   //최초 입차
                    Parameters.ParamByName('v2').Value := IncHour(StrToDateTime(aString(lbInTime.Caption)), 24);     //입차 후 24시간
                    ExceptLogging(sql.Text);
                    Open;
                  end;
                end
                else
                begin
                  nAdmDateCount := DaysBetween(StrToDateTime(sAdmEndDate + ' 00:00:00'),
                                               StrToDateTime(sAdmStartDate + ' 00:00:00')) + 1;

                  //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                  Close;
                  SQL.Clear;
                  SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                  SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                  SQL.Add('FROM DCDetail ');
                  SQL.Add('WHERE 1=1 ');
                  if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                    SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                  end else begin
                    SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                  end;
                  SQL.Add('AND ProcDate BETWEEN :v1 and :v2');
                  SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                  SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                  Parameters.ParamByName('v1').Value := sAdmStartDate;
                  Parameters.ParamByName('v2').Value := sAdmEndDate;
                  ExceptLogging(sql.Text);
                  Open;
                end;

                {nAdmDateCount := DaysBetween(StrToDateTime(sAdmEndDate + ' 00:00:00'),
                                             StrToDateTime(sAdmStartDate + ' 00:00:00')) + 1;

                //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                Close;
                SQL.Clear;
                SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                SQL.Add('FROM DCDetail ');
                SQL.Add('WHERE 1=1 ');
                if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                  SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                end else begin
                  SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                end;
                SQL.Add('AND ProcDate BETWEEN :v1 and :v2');
                SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                Parameters.ParamByName('v1').Value := sAdmStartDate;
                Parameters.ParamByName('v2').Value := sAdmEndDate;
                Open; }

                //12.29 OCS 할인 시간 주차시간 1일 이상시 남은 시간 6시간 이내의 차량 할인 적용
                nAdmDateTime  := 0;
                nsAdmDateTime := 0;
                if nDayEx >= 1 then
                begin
                  if nHourEx <= 6 then   //6시간까지 할인 적용
                  begin
                     nAdmDateTime := nHourEx * 60 + nMinEx;
                     ExceptLogging(IntToStr(nDayEx)+' 일 '+'남은 주차시간(분) '+ IntToStr(nAdmDateTime));
                     nsAdmDateTime := nAdmDateTime;
                  end
                  else //6시간 초과시
                  begin
                     //nAdmDateTime := nHourEx * 60 + nMinEx;      //총 주차시간
                     //nAdmDateTime := nAdmDateTime - ((nHourEx - 6) * 60); //총 주차 시간 - 6시간 이후 의 남은 시간
                     nAdmDateTime := 360;
                     ExceptLogging(IntToStr(nDayEx)+' 일 '+'남은 주차시간(분)_6시간 초과  '+ IntToStr(nAdmDateTime));
                  end;
                  nsAdmDateCount := nDayEx;
                  ExceptLogging('구간 요금 일수 : '+ inttostr(nsAdmDateCount));
                end;

                //nTotRemainTime := 360 * nAdmDateCount;
                //nsAdmDateCount := nAdmDateCount + nsAdmDateCount;
                ExceptLogging('구간 요금 일수2 : '+ inttostr(nsAdmDateCount));
                nTotRemainTime := 360 * nAdmDateCount + nAdmDateTime;
                if RecordCount > 0 then begin
                  //21.03.15 디비 속도 향상
                  SQL_Field8 := FieldByName('dcsum');
                  nAlreadyDCValue := SQL_Field8.AsInteger;
                  //nAlreadyDCValue := FieldByName('dcsum').AsInteger; //사용한 보호자시간
                  nRemainDCValue := nTotRemainTime - nAlreadyDCValue; //기존사용한 시간 차감
                end else begin
                  //결과가 없는 경우
                  nAlreadyDCValue := 0;
                  nRemainDCValue := nTotRemainTime; //매일 보호자에게 부여되는 무료출차시간 360분*일수
                end;
                ExceptLogging('[이전 사용시간/남은시간(분)] '+IntToStr(nAlreadyDCValue) + '/'+IntToStr(nRemainDCValue));
                Close;
                SQL.Clear;
                //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );

                if sDCInTime2 <> '' then   //OCS 중복 할인(01,02코드시) 시
                begin
                   if lbOutTime.Caption < sDCInTime  then    //출차 시간보다 입차 시간이 큰 경우
                   begin
                      sDCInTime := lbOutTime.Caption;
                   end;

                   SQL.Add('select datediff(mi,'+QuotedStr(sDCInTime)+' , '+QuotedStr(lbOutTime.Caption)+')' );

                end
                else  //OCS 중복 할인 안할시
                begin
                   //자동입차
                   SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                   //수동 입차
                   //SQL.Add('select datediff(mi,'+QuotedStr(lbInTime.Caption)+' , '+QuotedStr(lbOutTime.Caption)+')' );
                end;

                {if sDCInTime2 <> '' then   //OCS 중복 할인(01,02코드시) 시
                begin
                   SQL.Add('select datediff(mi,'+QuotedStr(sDCInTime)+' , '+QuotedStr(lbOutTime.Caption)+')' );
                end
                else  //OCS 중복 할인 안할시
                begin
                   if nmanualUse = 1 then //수동 출차 시 부분
                   begin
                      SQL.Add('select datediff(mi,'+QuotedStr(lbInTime.Caption)+' , '+QuotedStr(lbOutTime.Caption)+')' );
                   end
                   else   //일반 OCS 연동 시
                   begin
                      SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                   end;
                   //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                end;}

                //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                Open;
                if RecordCount > 0 then begin
                  nowUseTime := Fields[0].AsInteger;
                  ExceptLogging('[현재주차시간(분)] '+IntToStr(nowUseTime));
                  if nowUseTime > (nTotRemainTime - nAlreadyDCValue) then begin
                    overuseTime := abs(nTotRemainTime-nAlreadyDCValue-nowUseTime);
                    nAlreadyDCValue := nTotRemainTime;
                  end else if nowUseTime = (nTotRemainTime - nAlreadyDCValue) then begin
                    nAlreadyDCValue := nTotRemainTime;
                    overUseTime := 0;
                  end else begin
                    nAlreadyDCValue := nAlreadyDCValue + nowUseTime;
                    nRemainDCValue := nTotRemainTime - nAlreadyDCValue;
                    overUseTime := 0;
                  end;
                  ExceptLogging('[사용시간/초과사용시간(분)] '+IntToStr(nAlreadyDCValue)+'/'+IntToStr(overuseTime));
                end;
                //10.19 초과 사용 시간(분) 경우  (남은 주차 시간 계산)
                if nAlreadyDCValue > 0 then begin
                  //입원일 당일이 입원재입차인경우, 해당시간만큼 차감하여 계산.
                  //21.01.09 보호자 차감시간이 없거나
                  //if nRemainDCValue > 0 then begin
                  if (nRemainDCValue > 0) then begin
                    nISCCD := sDCCODE[I]; //보호자 할인 적용
                    nRemainDCValue := OCSAdminDCDetail(nRemainDCValue);     //차감할인 적용
                  end
                  else   //보호자 차감시간이 없는 경우 할인 적용 안함
                  begin
                     ExceptLogging('보호자 남은시간(분) ' + IntToStr(nRemainDCValue) +' 없으므로 OCS할인 적용 안됨' );
                     Exit;
                  end;
                end
                else
                begin
                  //입원 후 24시간 후 입차 시 할인 적용이 안되도록 설정(최초 요금 부과)
                  edtProcYogum.Text := inttostr(nTotYogum2);
                  nProcYogum := nTotYogum2;
                  lbDCName.Caption := '';
                  edtDC.Text:='';
                end;
                edtDCRemain.Text := IntToStr(nRemainDCValue);
                ExceptLogging('[실제남은시간] '+ edtDCRemain.Text);

                {noverYunm := 0;
                if overuseTime > 0 then
                begin
                   sEndDateTime := MG_AddTime(lbOutTime.Caption, 0, overuseTime, 0, 0);
                   ExceptLogging('요금계산일:'+ lbOutTime.Caption + ' ~ '+ sEndDateTime);

                   nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),
                                                                PAnsiChar(Copy(sEndDateTime, 1, 16)));
                   noverYunm := nTimeDC;
                   ExceptLogging('[초과 사용 시간에 대한 주차요금]: '+ IntToStr(noverYunm));
                end;}
               {else
                begin
                  if nAlreadyDCValue > 0 then begin
                    //입원일 당일이 입원재입차인경우, 해당시간만큼 차감하여 계산.
                    if nRemainDCValue > 0 then begin
                      nRemainDCValue := OCSAdminDCDetail(nRemainDCValue);     //차감할인 적용
                    end;
                  end;
                  edtDCRemain.Text := IntToStr(nRemainDCValue);
                  ExceptLogging('[실제남은시간] '+ edtDCRemain.Text);
                end;}


               { if nAlreadyDCValue > 0 then begin
                  //입원일 당일이 입원재입차인경우, 해당시간만큼 차감하여 계산.
                  if nRemainDCValue > 0 then begin
                    nRemainDCValue := OCSAdminDCDetail(nRemainDCValue);     //차감할인 적용
                  end;
                end;
                edtDCRemain.Text := IntToStr(nRemainDCValue);
                ExceptLogging('[실제남은시간] '+ edtDCRemain.Text); }
                if (sDCCODE[I] = '04') and (nAdmDateCount > 0) then begin
                  //출차일이 퇴원일일경우 퇴원할인으로 변경처리
//                  nAdmDateCount := nAdmDateCount - 1;

//                  Close;
//                  SQL.Clear;
//                  SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
//                  Parameters.ParamByName('DCCODE').Value := '04';
//                  Open;
//
//                  if RecordCount > 0 then begin
//                    nTempDCNo := FieldByName('DCNo').AsInteger;
//                  end else begin
//                    logStr := logStr + #13#10 + ('OCS할인코드 [04]넥스파 할인코드 매칭안됨 확인요망.');
//                  end;
//
//                  if nTempDCNo > 0 then begin
//                    OCSDCDetail(nTempDCNo);
//                  end;
                end;

//                Close;
//                SQL.Clear;
//                SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
//                Parameters.ParamByName('DCCODE').Value := '03';
//                Open;
//
//                if RecordCount > 0 then begin
//                  nTempDCNo := FieldByName('DCNo').AsInteger;
//                end else begin
//                  logStr := logStr + #13#10 + ('OCS할인코드 [03]넥스파 할인코드 매칭안됨 확인요망.');
//                end;
//
//                if nAdmDateCount > 1 then begin //2일이상 있다가 나가면
//                  if nRemainDCValue > 0 then begin //현재일로 보호자차감시간이 있으면 할인
//                    OCSDCDetailEx(nTempDCNo,nAdmDateCount); //6시간 차감같은경우 한번에 할 수 있도록
//                  end else begin
//                    OCSDCDetailEx(nTempDCNo,nAdmDateCount-1); //6시간 차감같은경우 한번에 할 수 있도록
//                  end;
//                end else if nAdmDateCount = 1 then begin //당일있다가 나가면
//                  if nRemainDCValue > 0 then begin //현재일로 보호자차감시간이 있으면 할인
//                    OCSDCDetailEx(nTempDCNo,nAdmDateCount); //6시간 차감같은경우 한번에 할 수 있도록
//                  end;
//                end;


//                if nAdmDateCount > 0 then begin
//                  for J := 1 to nAdmDateCount do begin
//                    if nTempDCNo > 0 then begin
//                      OCSDCDetail(nTempDCNo);
//                    end;
//                  end;
//                end;
              end else begin
                //일반할인
                //재입차시 반복부여 가능
                ExceptLogging('OCS Code: '+sDCCODE[I]);
                ExceptLogging('OCS 입원일자: '+sRECEIPTDATE[I]);
                //nsAdmStartDate := sRECEIPTDATE[I];

                Close;
                SQL.Clear;
                SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
                Parameters.ParamByName('DCCODE').Value := sDCCODE[I];
                Open;

                if RecordCount > 0 then begin
                  //nTempDCNo := FieldByName('DCNo').AsInteger;
                  //21.03.15 디비 속도 향상
                  SQL_Field9 := FieldByName('DCNo');
                  nTempDCNo := SQL_Field9.AsInteger;
                  nOcsCode  := sDCCODE[I];
                end else begin

                end;

                if nTempDCNo > 0 then begin
                  OCSDCDetail(nTempDCNo);
                end;
              end;
            end;
            dmTables.qryOCSProc.EnableControls;
          end;
        end;

        //2020-04-28 대전성모 수정사항 : OCS연동할인 후 추가할인키 입력인 안되도록 설정
        DCEnable(False);
      end else begin
      end;
    except
      on E: Exception do begin
        ExceptLogging('채번된 환자번호로 OCS할인정보 획득 중 오류 발생 : ' + E.Message);
        Exit;
      end;
    end;
    ExceptLogging('채번된 환자번호로 OCS할인정보 획득 종료');
    {$ENDREGION}

    {$REGION '장애인 및 국가유공자 처리'}
    //11.22 장애인 국가 유공자 처리 유인 쪽 에서는 수동으로 할인키로 적용 시키도록 함
    //그 이유: 장애인이 아닌 차량이 할인 적용 된다고 해서 이부분 처리 안함
    //추후에 필요하면 적용 되도록 하는데 지금은 안정화가 필요한 상태
    {ExceptLogging('채번된 환자번호로 장애인 / 국가유공자 처리 시작');
    if bNational then begin
      ExceptLogging('국가유공자 확인됨.. 국가유공자 처리시작');
      with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Text := 'Select * From DCInfo Where OcsCode = :National ';
        Parameters.ParamByName('National').Value := 'NA';
        Open;

        nTempDCNo := 0;
        if RecordCount > 0 then begin
          nTempDCNo := FieldByName('DCNo').AsInteger;
          if nTempDCNo > 0 then begin
            OCSDCDetail(nTempDCNo);
          end else begin
            ExceptLogging('국가유공자 할인코드값 오류.. 확인필요');
          end;
        end else begin
          ExceptLogging('국가유공자 할인코드 매칭불가. 할인권 설정 확인필요');
        end;
      end;
      ExceptLogging('국가유공자 확인됨.. 국가유공자 처리종료');
    end;

    if bHandicap and not bNational then begin //국가유공자 처리하면 장애인은 처리안함 - 중복불가요청 대전성모병원
      ExceptLogging('장애인여부 확인됨.. 장애인할인 처리시작');
      with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Text := 'Select * From DCInfo Where OcsCode = :National ';
        Parameters.ParamByName('National').Value := 'HD';
        Open;

        nTempDCNo := 0;
        if RecordCount > 0 then begin
          nTempDCNo := FieldByName('DCNo').AsInteger;
          if nTempDCNo > 0 then begin
            OCSDCDetail(nTempDCNo);
          end else begin
            ExceptLogging('장애인 할인코드값 오류.. 확인필요');
          end;
        end else begin
          ExceptLogging('장애인 할인코드 매칭불가. 할인권 설정 확인필요');
          Exit;
        end;
      end;
      ExceptLogging('장애인여부 확인됨.. 장애인할인 처리시작');
    end;
    ExceptLogging('채번된 환자번호로 장애인 / 국가유공자 처리 종료'); }
    {$ENDREGION}
  finally
    sPATIENTNO := nil;
    sDCCODE := nil;
    dmTables.qryOCS.Active := False;
    ExceptLogging('OCS 할인처리 종료');
  end;

end;


procedure TfrmMainNew.OCSDCProc_CAR(sNowTKno: String);
var
  sPATIENTNO  : array of aString;   //환자번호 변수
  sDCCODE, sDCCODE_PAST : array of aString;   //병원에 등록된 OCS할인정보 변수
  sRECEIPTDATE, sRECEIPTDATE_PAST : array of aString;   //병원에 등록된 수납일자 변수
  sPID, sPID_PAST : array of aString;   //병원에 등록된 PID변수
  bIsPast : Boolean;                  //어제할인인지.
  bIsAdmission : Boolean;             //입원할인 처리여부
  I, J : Integer;                     //for 반복문용 변수할당
  tempString  : aString;              //임시저장용 string 변수
  logStr: string;

  bIsPatient : Boolean;
  asPATIENTNO, asDCCODE :Integer;
begin
   try
     edtDC.Text :='';//할인명 초기화
     edtDCRemain.Text :='';
     edtOcsCar.Text  :='';
     tempString := '';
     {with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Add('SELECT * FROM OPENQUERY('+sLinkedDBName+', ');
        SQL.Add(  ' ''SELECT PID, ');
        SQL.Add(       'COUNT(case when HANDICAPRYN = ''' + QuotedStr('Y') + ''' then 1 end) as HANDCNT, ');
        SQL.Add(       'COUNT(case when NATIONTOYN = ''' + QuotedStr('Y') + ''' then 1 end) as NATCNT ');
        SQL.Add(      'From '+sOCSDBName+'.PMCMPKBS ');
        if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
          SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) +
                      ''' or CarNo = ''' + QuotedStr(sNowLprCarNo2) + ''' ');    //incarno2
        end else begin
          SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) + ''' ');
        end;
        SQL.Add(      'Group by PID'' )');
        Open;
        if RecordCount > 0 then begin
           bIsPatientUse := 1;
           ExceptLogging('OCS할인 차량');
        end else begin
           bIsPatientUse := 0;
           ExceptLogging('OCS할인 차량아님');
        end;
     end;}

     //12.21 OCS차량 할인코드 01, 02이면 10분당 300원으로 계산을 하여 최조 요금 부과
      SQL_Field := TField.Create(self);
      SQL_Field2 := TField.Create(self);
      SQL_Field3 := TField.Create(self);
      SQL_Field4 := TField.Create(self);
      SQL_Field5 := TField.Create(self);
      try
        with dmTables.qryOCS do begin
          dmTables.qryOCS.DisableControls;
          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 할인 차량 연동 시작(쿼리 시간) : ' + OCSTIME);
          Close;
          SQL.Clear;
          SQL.Add('SELECT * FROM OPENQUERY('+sLinkedDBName+', ');
          SQL.Add(  ' ''SELECT PID, ');
          SQL.Add(       'COUNT(case when HANDICAPRYN = ''' + QuotedStr('Y') + ''' then 1 end) as HANDCNT, ');
          SQL.Add(       'COUNT(case when NATIONTOYN = ''' + QuotedStr('Y') + ''' then 1 end) as NATCNT ');
          SQL.Add(      'From '+sOCSDBName+'.PMCMPKBS ');
          if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
            SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) +
                        ''' or CarNo = ''' + QuotedStr(sNowLprCarNo2) + ''' ');    //incarno2
          end else begin
            SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) + ''' ');
          end;
          SQL.Add(      'Group by PID'' )');
          logStr := logStr + #13#10 + ('환자번호로 장애인/국가유공자 할인검색 : ' + SQL.Text);
          Open;

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 할인 차량 연동 중간(쿼리 시간) : ' + OCSTIME);

          if RecordCount > 0 then begin
            I := 1;
            SetLength(sPATIENTNO, RecordCount);
            bIsPatientUse := 1;
            //디비 속도 향상
            SQL_Field := FieldByName('PID');
            while not Eof do begin
               //디비 속도 향상
              tempString := SQL_Field.AsString;
              //tempString := FieldByName('PID').AsString;
              ExceptLogging('OCS 할인 전 최초요금 환자번호 : ' + tempString);
              {if (not bHandicap) and (FieldByName('HANDCNT').AsInteger > 0) then begin
                logStr := logStr + #13#10 + ('['+IntToStr(I)+'] : ' + tempString + ', ['+sNowLprCarNo1+'] 차량 장애인 등록여부 확인됨.');
                bHandicap := True;
              end;
              if (not bNational) and (FieldByName('NATCNT').AsInteger > 0) then begin
                logStr := logStr + #13#10 + ('['+IntToStr(I)+'] : ' + tempString + ', ['+sNowLprCarNo1+'] 차량 국가유공자 등록여부 확인됨.');
                bNational := True;
              end;}
              sPATIENTNO[I-1] := tempString;
              Inc(I);
              Next;

              bIsPatient := True;
              bIsPatientUse := 1;
            end;
          end else begin
            //대전성모 OCS PAM.PMCMPKBS테이블에 환자정보가 없을 수 있음.(신규환자의 경우)
            //병원
            logStr := logStr + #13#10 + ('환자번호 장애인/국가유공자 해당안됨');
            SetLength(sPATIENTNO, 5);
            edtOcsCar.Text := '차량아님';
            edtOcsCode.Text := '';
            sDCInTime2 := '';
          end;
          asPATIENTNO := Length(sPATIENTNO);
          //for I := 0 to Length(sPATIENTNO)-1 do begin //0부터했으면 카운트-1을해야지..

          {for I := 0 to asPATIENTNO-1 do begin
            if not(sPATIENTNO[I] = '') then begin
              bIsPatient := True;
              bIsPatientUse := 1;
            end;
          end;}

          //실제 테스트시 주석 열어줌
          //OCS 연동 시 차량 번호 없으면 무조건 빠져 나가기
          if not bIsPatient then begin
             bIsPatientUse := 0;
             logStr := logStr + #13#10 + ('환자 주차료 할인 테이블내 현재 차량 정보 없음!: '+'OCS할인처리 중단.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
             Exit;   //임시주석테스트
          end;

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 할인 차량 연동 끝(쿼리 시간) : ' + OCSTIME);
          dmTables.qryOCS.EnableControls;
        end;
      except
        on E: Exception do begin
          logStr := logStr + #13#10 + ('환자번호 채번중 오류 발생 : ' + E.Message);
          Exit;
        end;
      end;
      {$ENDREGION}

      {$REGION '채번된 환자번호로 OCS코드 알아내기'}
      try
        bIsAdmission := False;
        with dmTables.qryOCS do begin
          tempString := '';
          I := 1;
          //asPATIENTNO := Length(sPATIENTNO);
          //for I := 1 to Length(sPATIENTNO) do begin
          for I := 1 to asPATIENTNO do begin
            if tempString = '' then begin
              tempString := 'IN (';
            end;
            tempString := tempString + '''' + QuotedStr(sPATIENTNO[I-1]) + '''';

            //if not (I = Length(sPATIENTNO)) then begin
            if not (I = asPATIENTNO) then begin
              tempString := tempString + ', ';
            end else begin
              tempString := tempString + ')';
            end;
          end;

          //nPID_str := 'IN (''''713902'''')';
//          nPID_str := 'IN (''''1413904'''')';
//          tempString := nPID_str;//임시 테스트

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 시작(쿼리 시간) : ' + OCSTIME);
          Close;
          SQL.Clear;
          SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
          SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS Where PID ' + tempString + ' ');
          SQL.Add('ORDER BY DISCCD ASC, RCPTDD ASC, RCPTTM ASC '')');
          logStr := logStr + #13#10 + ('OCS 당일 할인정보 획득 쿼리 : ' + SQL.Text);
          Open;

          SQL_Field2 := FieldByName('DISCFLAG');
          SQL_Field3 := FieldByName('DISCCD');
          SQL_Field4 := FieldByName('RCPTDD');
          SQL_Field := FieldByName('PID');
          SQL_Field5 := FieldByName('HANDICAPRYN');

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 중간 (쿼리 시간) : ' + OCSTIME);

          if RecordCount > 0 then begin
            SetLength(sDCCODE, RecordCount);
            SetLength(sRECEIPTDATE, RecordCount);
            SetLength(sPID, RecordCount);
            I := 1;

            edtOcsCar.Text := '차량';
            while not Eof do begin
              //21.03.15 디비속도향상
              //디비 속도 향상
              sDISCFLAG := SQL_Field2.AsString;
              sDISCCD   := SQL_Field3.AsString;
              sRCPTDD   := SQL_Field4.AsString;
              nPID      := SQL_Field.AsString;
              sHANDICAPRYN   := SQL_Field5.AsString;

              if sDISCFLAG = '02' then begin //시간
                if (sDISCCD = '01') or
                   (sDISCCD = '02') or
                   (sDISCCD = '03') or
                   (sDISCCD = '04') then begin
                   logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   sDCCODE[I-1]      := sDISCCD; //tempString;
                   sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                        Copy(sRCPTDD, 5, 2) + '-' +
                                        Copy(sRCPTDD, 7, 2);
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+sDISCCD+'], '+'DISCFLAG : ['+sDISCFLAG+'] ');
                end;
              end
              else if sDISCFLAG = '01' then begin //당일
                if (sDISCCD = '05') then begin
                   logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                   sDCCODE[I-1]      := sDISCCD;
                   sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                        Copy(sRCPTDD, 5, 2) + '-' +
                                        Copy(sRCPTDD, 7, 2);
                   sPID[I-1] := nPID;
                   Inc(I);
                end;
              end;

              {if FieldByName('DISCFLAG').AsString = '02' then begin //시간
                if (FieldByName('DISCCD').AsString = '01') or
                   (FieldByName('DISCCD').AsString = '02') or
                   (FieldByName('DISCCD').AsString = '03') or
                   (FieldByName('DISCCD').AsString = '04') then begin
                  logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                  sDCCODE[I-1]      := FieldByName('DISCCD').AsString; //tempString;
                  sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 7, 2);
                  sPID[I-1] := FieldByName('PID').AsString;
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
                end;
              end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
                if (FieldByName('DISCCD').AsString = '05') then begin
                  logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                  sDCCODE[I-1]      := FieldByName('DISCCD').AsString;
                  sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 7, 2);
                  sPID[I-1] := FieldByName('PID').AsString;
                  Inc(I);
                end;
              end;

              if (not bHandicap) and (FieldByName('HANDICAPRYN').AsString = 'Y') then begin
                logStr := logStr + #13#10 + ('['+sNowLprCarNo1+'] 차량 장애인 등록여부 확인됨.');
                bHandicap := True;
              end;}
              Next;
            end;

          end else begin
            logStr := logStr + #13#10 + ('OCS 당일 할인정보 테이블내 현재 차량 정보 없음!: 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
            bIsPatientUse := 0;
            edtOcsCar.Text := '차량아님';
            edtOcsCode.Text :='';
          end;
          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 끝 (쿼리 시간) : ' + OCSTIME);

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 전날 할인정보 쿼리 시작 (쿼리 시간) : ' + OCSTIME);
          Close;
          SQL.Clear;
          SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
          SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS_PAST Where PID ' + tempString + ' ');
          SQL.Add(' '')');
          logStr := logStr + #13#10 + ('OCS 전날 할인정보 획득 쿼리 : ' + SQL.Text);
          Open;

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 전날 할인정보 쿼리 중간 (쿼리 시간) : ' + OCSTIME);
          if RecordCount > 0 then begin
            SetLength(sDCCODE_PAST, RecordCount);
            SetLength(sRECEIPTDATE_PAST, RecordCount);
            SetLength(sPID_PAST, RecordCount);
            I := 1;

            SQL_Field2 := FieldByName('DISCFLAG');
            SQL_Field3 := FieldByName('DISCCD');
            SQL_Field4 := FieldByName('RCPTDD');
            SQL_Field := FieldByName('PID');
            SQL_Field5 := FieldByName('HANDICAPRYN');

            edtOcsCar.Text := '차량';
            while not Eof do begin
              //21.03.15 디비속도향상
              //디비 속도 향상
              sDISCFLAG := SQL_Field2.AsString;
              sDISCCD   := SQL_Field3.AsString;
              sRCPTDD   := SQL_Field4.AsString;
              nPID      := SQL_Field.AsString;
              sHANDICAPRYN   := SQL_Field5.AsString;

              if sDISCFLAG = '02' then begin //시간
                if (sDISCCD = '01') or
                   (sDISCCD = '02') or
                   (sDISCCD = '03') or
                   (sDISCCD = '04') then begin
                   logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   ExceptLogging('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   sDCCODE_PAST[I-1]      := sDISCCD; //tempString;
                   sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                             Copy(sRCPTDD, 5, 2) + '-' +
                                             Copy(sRCPTDD, 7, 2);
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+sDISCCD+'], '+'DISCFLAG : ['+sDISCFLAG+'] ');
                end;
              end
              else if sDISCFLAG = '01' then begin //당일
                if (sDISCCD = '05') then begin
                   logStr := logStr + #13#10 + ('전날: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                   ExceptLogging('전날: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   sDCCODE_PAST[I-1]      := sDISCCD;
                   sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                             Copy(sRCPTDD, 5, 2) + '-' +
                                             Copy(sRCPTDD, 7, 2);
                   sPID_PAST[I-1] := nPID;
                   Inc(I);
                end;
              end;

              {if FieldByName('DISCFLAG').AsString = '02' then begin //시간
                if (FieldByName('DISCCD').AsString = '01') or
                   (FieldByName('DISCCD').AsString = '02') or
                   (FieldByName('DISCCD').AsString = '03') or
                   (FieldByName('DISCCD').AsString = '04') then begin
                  logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                  sDCCODE[I-1]      := FieldByName('DISCCD').AsString; //tempString;
                  sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 7, 2);
                  sPID[I-1] := FieldByName('PID').AsString;
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
                end;
              end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
                if (FieldByName('DISCCD').AsString = '05') then begin
                  logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                  sDCCODE[I-1]      := FieldByName('DISCCD').AsString;
                  sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                       Copy(FieldByName('RCPTDD').AsString, 7, 2);
                  sPID[I-1] := FieldByName('PID').AsString;
                  Inc(I);
                end;
              end;

              if (not bHandicap) and (FieldByName('HANDICAPRYN').AsString = 'Y') then begin
                logStr := logStr + #13#10 + ('['+sNowLprCarNo1+'] 차량 장애인 등록여부 확인됨.');
                bHandicap := True;
              end;}
              Next;
            end;

            {while not Eof do begin
              if FieldByName('DISCFLAG').AsString = '02' then begin //시간
                 //전날 외래(01)나 기타외래(02)만 있을 경우 OCS할인 적용 안함
                if (FieldByName('DISCCD').AsString = '03') or
                   (FieldByName('DISCCD').AsString = '04') then begin
                  logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                  sDCCODE_PAST[I-1]      := FieldByName('DISCCD').AsString; //tempString;
                  sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                            Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                            Copy(FieldByName('RCPTDD').AsString, 7, 2);
                  sPID_PAST[I-1] := FieldByName('PID').AsString;
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능: '+'DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
                end;
              end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
                if (FieldByName('DISCCD').AsString = '05') then begin
                  logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                  sDCCODE_PAST[I-1]      := FieldByName('DISCCD').AsString;
                  sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                            Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                            Copy(FieldByName('RCPTDD').AsString, 7, 2);
                  sPID_PAST[I-1] := FieldByName('PID').AsString;
                  Inc(I);
                end;
              end;
              Next;
            end;}
          end else begin
            logStr := logStr + #13#10 + ('OCS 전날 할인정보 테이블내 현재 차량 정보 없음!: '+'차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
            bIsPatientUse := 0;
            edtOcsCar.Text := '차량아님';
            edtOcsCode.Text :='';
          end;
        end;
        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 쿼리 끝 (쿼리 시간) : ' + OCSTIME);
      except
        on E: Exception do begin
          Exit;
        end;
      end;

      {bIsPast := False;
      if Length(sDCCODE) = 0 then begin
        //당일 할인이 한개도 없을경우, 전날할인을 본다
        sDCCODE      := sDCCODE_PAST;
        sRECEIPTDATE := sRECEIPTDATE_PAST;
        sPID         := sPID_PAST;
        bIsPast      := True;
      end;

      asDCCODE := Length(sDCCODE);}
      //if Length(sDCCODE) > 0 then begin
      {if asDCCODE > 0 then begin
        bOcsCodeUse := 1;
        //for I := 0 to Length(sDCCODE) - 1 do begin
        for I := 0 to asDCCODE - 1 do begin
//           with dmTables.qryOCSProc do begin
               //외래(4H), 기타외래(6H) 는 무조건 10분당 300원 요금 부과
              if ((sDCCODE[I] = '01') or (sDCCODE[I] = '02')) then begin
                bIsPatientUse := 0;
                ExceptLogging('OCS 할인코드 '+sDCCODE[I] + ' 10분당 300원 주차요금 발생');
              end
              else if ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin  //입원(6H), 보호자(6H) 는 구간최대요금 부과
                 bIsPatientUse := 1;
                 ExceptLogging('OCS 할인코드 '+sDCCODE[I] + ' 구간최대요금 발생');
              end;
              edtOcsCode.Text := edtOcsCode.Text +', '+sDCCODE[I];

//           end;
        end;
      end;}
      OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
      ExceptLogging('OCS 차량여부 끝 (쿼리 시간) : ' + OCSTIME);
      ExceptLogging(logStr);
      {$ENDREGION}

   except
      on E: Exception do begin
        Exit;
      end;
   end;
end;

procedure TfrmMainNew.OCSDCProc_CAR_Ex(sNowTKno: String);
var
  I, J, asPATIENTNO: Integer;                //for 반복문용 변수할당 , //동적배열 길이
  tempString, logStr: string;                         //임시저장용 string 변수
  SQL_Field, SQL_Field2, SQL_Field3, SQL_Field4, SQL_Field5: TField;
begin
  try
    edtDC.Text :='';//할인명 초기화
    edtDCRemain.Text :='';
    edtOcsCar.Text  :='';
    //재입차시 반복부여 가능
    nDCValue := 0; //총 주어진 할인 주차 시간
    asDCCODE := 0; //초기화
    //OCS 중복할인 처리 변수
    sDCInTime2 := '';
    sDCOutTime2:= '';
    //수동처리
    nmanualUse := 0;
    bufBarc := '';//바코드 값 초기화
    asPATIENTNO := 0;
    bIsPatient := False;

    //OCS 환자번호 처리 변수
    nDCTKNO := '';

    //초기화를 맨앞에해야지! 환자번호 채번할때 데이터있으면 초기화는 아니지않나.. 이러니 계속 장애인,국가유공자할인 뜬거였지..
    bHandicap := False; //장애인 여부 변수 초기화
    bNational := False; //국가유공자 여부 변수 초기화
    sPATIENTNO := nil;  //환자 번호 초기화
    sDCCODE:= nil;      //병원에 등록된 OCS할인정보 변수 초기화
    sDCCODE_PAST := nil; //병원에 등록된 OCS할인정보 변수 초기화
    sRECEIPTDATE := nil;   //병원에 등록된 수납일자 변수
    sRECEIPTDATE_PAST := nil; //병원에 등록된 수납일자 변수

    SQL_Field := TField.Create(self);
    SQL_Field2 := TField.Create(self);
    SQL_Field3 := TField.Create(self);
    SQL_Field4 := TField.Create(self);
    SQL_Field5 := TField.Create(self);

    //nDCInTime := '';
    nISCCD := '';
    nOcsCode  :='';
    edtDC.Text:='';
    edtDCRemain.Text :='';
    edtOcsCar.Text :='';

    {$REGION '환자번호 채번'}
    dmTables.qryOCS.DisableControls;
    OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
    ExceptLogging('OCS 할인 차량 연동 시작(쿼리 시간) : ' + OCSTIME);
    dmTables.qryOCS.Close;
    dmTables.qryOCS.SQL.Clear;
    dmTables.qryOCS.SQL.Add('SELECT * FROM OPENQUERY('+sLinkedDBName+', ');
    dmTables.qryOCS.SQL.Add(  ' ''SELECT PID, ');
    dmTables.qryOCS.SQL.Add(       'COUNT(case when HANDICAPRYN = ''' + QuotedStr('Y') + ''' then 1 end) as HANDCNT, ');
    dmTables.qryOCS.SQL.Add(       'COUNT(case when NATIONTOYN = ''' + QuotedStr('Y') + ''' then 1 end) as NATCNT ');
    dmTables.qryOCS.SQL.Add(      'From '+sOCSDBName+'.PMCMPKBS ');
    if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
      dmTables.qryOCS.SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) +
                  ''' or CarNo = ''' + QuotedStr(sNowLprCarNo2) + ''' ');    //incarno2
    end else begin
      dmTables.qryOCS.SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) + ''' ');
    end;
    dmTables.qryOCS.SQL.Add(      'Group by PID'' )');
    logStr := logStr + #13#10 + ('환자번호로 장애인/국가유공자 할인검색 : ' + dmTables.qryOCS.SQL.Text);
    dmTables.qryOCS.Open;

    OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
    ExceptLogging('OCS 할인 차량 연동 중간(쿼리 시간) : ' + OCSTIME);

    if dmTables.qryOCS.RecordCount > 0 then begin
      I := 1;
      SetLength(sPATIENTNO, dmTables.qryOCS.RecordCount);
      bIsPatientUse := 1;
      //디비 속도 향상
      SQL_Field := dmTables.qryOCS.FieldByName('PID');
      while not dmTables.qryOCS.Eof do begin
         //디비 속도 향상
        tempString := SQL_Field.AsString;
        ExceptLogging('OCS 할인 전 최초요금 환자번호 : ' + tempString);
        sPATIENTNO[I-1] := tempString;
        Inc(I);
        dmTables.qryOCS.Next;
        bIsPatient := True;
      end;
    end else begin
      //대전성모 OCS PAM.PMCMPKBS테이블에 환자정보가 없을 수 있음.(신규환자의 경우)
      //병원
      logStr := logStr + #13#10 + ('환자번호 장애인/국가유공자 해당안됨');
      SetLength(sPATIENTNO, 5);
      edtOcsCar.Text := '차량아님';
      edtOcsCode.Text := '';
      bIsPatient := False;
    end;
    asPATIENTNO := Length(sPATIENTNO);
    //실제 테스트시 주석 열어줌
    //OCS 연동 시 차량 번호 없으면 무조건 빠져 나가기
    if not bIsPatient then begin
       bIsPatientUse := 0;
       logStr := logStr + #13#10 + ('환자 주차료 할인 테이블내 현재 차량 정보 없음!: '+'OCS할인처리 중단.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
       dmTables.qryOCS.Active := False;
       ExceptLogging(logStr);
       Exit;   //임시주석테스트
    end;
    OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
    ExceptLogging('OCS 할인 차량 연동 끝(쿼리 시간) : ' + OCSTIME);

    dmTables.qryOCS.EnableControls;
    {$ENDREGION}

    {$REGION '채번된 환자번호로 OCS코드 알아내기'}
      try
          bIsAdmission := False;
          tempString := '';
          I := 1;
          for I := 1 to asPATIENTNO do begin
            if tempString = '' then begin
              tempString := 'IN (';
            end;
            tempString := tempString + '''' + QuotedStr(sPATIENTNO[I-1]) + '''';

            if not (I = asPATIENTNO) then begin
              tempString := tempString + ', ';
            end else begin
              tempString := tempString + ')';
            end;
          end;
          //nPID_str := 'IN (''''713902'''')';
          //nPID_str := 'IN (''''1413904'''')';
          //tempString := nPID_str;//임시 테스트

          dmTables.qryOCS.disableControls;
          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 시작(쿼리 시간) : ' + OCSTIME);
          dmTables.qryOCS.Close;
          dmTables.qryOCS.SQL.Clear;
          dmTables.qryOCS.SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
          dmTables.qryOCS.SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS Where PID ' + tempString + ' ');
          dmTables.qryOCS.SQL.Add('ORDER BY DISCCD ASC, RCPTDD ASC, RCPTTM ASC '')');
          logStr := logStr + #13#10 + ('OCS 당일 할인정보 획득 쿼리 : ' + dmTables.qryOCS.SQL.Text);
          dmTables.qryOCS.Open;

          SQL_Field2 := dmTables.qryOCS.FieldByName('DISCFLAG');
          SQL_Field3 := dmTables.qryOCS.FieldByName('DISCCD');
          SQL_Field4 := dmTables.qryOCS.FieldByName('RCPTDD');
          SQL_Field  := dmTables.qryOCS.FieldByName('PID');
          SQL_Field5 := dmTables.qryOCS.FieldByName('HANDICAPRYN');

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 중간 (쿼리 시간) : ' + OCSTIME);

          if dmTables.qryOCS.RecordCount > 0 then begin
            SetLength(sDCCODE, dmTables.qryOCS.RecordCount);
            SetLength(sRECEIPTDATE, dmTables.qryOCS.RecordCount);
            SetLength(sPID, dmTables.qryOCS.RecordCount);
            I := 1;
            bOcsCodeUse   := 1;
            while not dmTables.qryOCS.Eof do begin
              //21.03.15 디비속도향상
              //디비 속도 향상
              sDISCFLAG := SQL_Field2.AsString;
              sDISCCD   := SQL_Field3.AsString;
              sRCPTDD   := SQL_Field4.AsString;
              nPID      := SQL_Field.AsString;
              sHANDICAPRYN   := SQL_Field5.AsString;
              if (sDISCCD ='03') or (sDISCCD ='04') then
              begin
                  edtOcsCar.Text := '차량';
              end;
              if sDISCFLAG = '02' then begin //시간
                if (sDISCCD = '01') or
                   (sDISCCD = '02') or
                   (sDISCCD = '03') or
                   (sDISCCD = '04') or
                   (sDISCCD = '06')then begin    //DISCCD (06-외래(제증명)) 1시간 할인
                   logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   sDCCODE[I-1]      := sDISCCD;
                   sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                        Copy(sRCPTDD, 5, 2) + '-' +
                                        Copy(sRCPTDD, 7, 2);
                   bOcsCodeUse   := 1;
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+sDISCCD+'], '+'DISCFLAG : ['+sDISCFLAG+'] ');
                end;
              end
              else if sDISCFLAG = '01' then begin //당일
                if (sDISCCD = '05') then begin
                   logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + dmTables.qryOCS.FieldByName('DISCCD').AsString);
                   sDCCODE[I-1]      := sDISCCD;
                   sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                        Copy(sRCPTDD, 5, 2) + '-' +
                                        Copy(sRCPTDD, 7, 2);
                   sPID[I-1] := nPID;
                   Inc(I);
                end;
              end;
              dmTables.qryOCS.Next;
            end;

          end else begin
            logStr := logStr + #13#10 + ('OCS 당일 할인정보 테이블내 현재 차량 정보 없음!: 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
            bIsPatientUse := 0;
            edtOcsCar.Text := '차량아님';
            edtOcsCode.Text :='';
          end;
          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 끝 (쿼리 시간) : ' + OCSTIME);

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 전날 할인정보 쿼리 시작 (쿼리 시간) : ' + OCSTIME);
          dmTables.qryOCS.Close;
          dmTables.qryOCS.SQL.Clear;
          dmTables.qryOCS.SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
          dmTables.qryOCS.SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS_PAST Where PID ' + tempString + ' ');
          dmTables.qryOCS.SQL.Add(' '')');
          logStr := logStr + #13#10 + ('OCS 전날 할인정보 획득 쿼리 : ' + dmTables.qryOCS.SQL.Text);
          dmTables.qryOCS.Open;

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 전날 할인정보 쿼리 중간 (쿼리 시간) : ' + OCSTIME);
          if dmTables.qryOCS.RecordCount > 0 then begin
            SetLength(sDCCODE_PAST, dmTables.qryOCS.RecordCount);
            SetLength(sRECEIPTDATE_PAST, dmTables.qryOCS.RecordCount);
            SetLength(sPID_PAST, dmTables.qryOCS.RecordCount);
            I := 1;

            SQL_Field2 := dmTables.qryOCS.FieldByName('DISCFLAG');
            SQL_Field3 := dmTables.qryOCS.FieldByName('DISCCD');
            SQL_Field4 := dmTables.qryOCS.FieldByName('RCPTDD');
            SQL_Field  := dmTables.qryOCS.FieldByName('PID');
            SQL_Field5 := dmTables.qryOCS.FieldByName('HANDICAPRYN');
            while not dmTables.qryOCS.Eof do begin
              //21.03.15 디비속도향상
              //디비 속도 향상
              sDISCFLAG := SQL_Field2.AsString;
              sDISCCD   := SQL_Field3.AsString;
              sRCPTDD   := SQL_Field4.AsString;
              nPID      := SQL_Field.AsString;
              sHANDICAPRYN   := SQL_Field5.AsString;
              if (sDISCCD ='03') or (sDISCCD ='04') then
              begin
                  edtOcsCar.Text := '차량';
              end;
              if sDISCFLAG = '02' then begin //시간
                if //(sDISCCD = '01') or
                   //(sDISCCD = '02') or
                   (sDISCCD = '03') or
                   (sDISCCD = '04') then begin
                   logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   ExceptLogging('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   sDCCODE_PAST[I-1]      := sDISCCD; //tempString;
                   sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                             Copy(sRCPTDD, 5, 2) + '-' +
                                             Copy(sRCPTDD, 7, 2);
                   bOcsCodeUse   := 1;
                  Inc(I);
                end else begin
                  logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+sDISCCD+'], '+'DISCFLAG : ['+sDISCFLAG+'] ');
                end;
              end
              else if sDISCFLAG = '01' then begin //당일
                if (sDISCCD = '05') then begin
                   logStr := logStr + #13#10 + ('전날: '+'['+IntToStr(I)+'] : ' + dmTables.qryOCS.FieldByName('DISCCD').AsString);
                   ExceptLogging('전날: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                   sDCCODE_PAST[I-1]      := sDISCCD;
                   sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                             Copy(sRCPTDD, 5, 2) + '-' +
                                             Copy(sRCPTDD, 7, 2);
                   sPID_PAST[I-1] := nPID;
                   Inc(I);
                end;
              end;
              dmTables.qryOCS.Next;
            end;
          end else begin
            logStr := logStr + #13#10 + ('OCS 전날 할인정보 테이블내 현재 차량 정보 없음!: '+'차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
            bIsPatientUse := 0;
            edtOcsCar.Text := '차량아님';
            edtOcsCode.Text :='';
          end;
        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 쿼리 끝 (쿼리 시간) : ' + OCSTIME);
        dmTables.qryOCS.EnableControls;
      except
        on E: Exception do begin
          Exit;
        end;
      end;

      bIsPast := False;
      asDCCODE := Length(sDCCODE);
      //if Length(sDCCODE) = 0 then begin
      if asDCCODE = 0 then begin
        //당일 할인이 한개도 없을경우, 전날할인을 본다
        sDCCODE      := sDCCODE_PAST;
        sRECEIPTDATE := sRECEIPTDATE_PAST;
        sPID         := sPID_PAST;
        bIsPast      := True;
      end;
      asDCCODE := Length(sDCCODE);
      asDCCODE_PAST := Length(sDCCODE_PAST);

      nDCTKNO := sPATIENTNO[0];
      ExceptLogging('OCS 할인 환자번호 : ' + nDCTKNO);

      OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
      ExceptLogging('OCS 차량여부 끝 (쿼리 시간) : ' + OCSTIME);
      ExceptLogging(logStr);
      {$ENDREGION}
  Except
    on E: Exception do begin
      ExceptLogging('OCSDCProc_CAR_Ex : ' + E.Message);
      Exit;
    end;
  end;
end;

procedure TfrmMainNew.OCSDCProc_Ex(sNowTKno: String);
var
  I, J, nTempDCNo, nAdmDateCount,    //임시저장용 할인코드
  nAdmDateTime, nTotRemainTime, nRemainDCValue, nAlreadyDCValue : Integer;    //남은 시간(1일 이상 주차 시),  //입원일기간 총 보호자차감 잔여분,   //입원일 재입차시 잔여 할인값, //입원일 재입차시 사용한 할인값
  logStr, sAdmStartDate, sAdmEndDate,   //입원할인시작일
  nprocdate, nprocTime, nprocdate_nprocTime, nFirstpdateTime  : aString;  //보호자 할인 처리 변수
  //디비 속도 향상
  SQL_Field6, SQL_Field7, SQL_Field8, SQL_Field9, SQL_Field10: TField;
  SQL_Field11 : TField;
  OCS_CAR_DCDetail : Integer;
begin
 try
   ExceptLogging('***************************************************************');
   ExceptLogging('대전성모병원 OCS 정보 처리 시작');
   sAdmStartDate := '';
   sAdmEndDate   := '';
   nAdmDateCount := 0;
   bIsPatient := False;

   nAlreadyDCValue := 0;
   nRemainDCValue  := 0;
   nowUseTime := 0;
   overUseTime := 0;
   //재입차시 반복부여 가능
   nDCValue := 0; //총 주어진 할인 주차 시간
   //OCS 중복할인 처리 변수
   sDCInTime2 := '';
   sDCOutTime2:= '';
   //수동처리
   nmanualUse := 0;
   nsAdmDateCount := 0;  //구간요금 초기화
   //환자번호 하나당 차량 3대까지 할인 적용
   OCS_CAR_DCDetail := 0;
   //디비 속도 처리
   SQL_Field6 := TField.Create(self);
   SQL_Field7 := TField.Create(self);
   SQL_Field8 := TField.Create(self);
   SQL_Field9 := TField.Create(self);
   SQL_Field10 := TField.Create(self);

   SQL_Field11 := TField.Create(self);
   nISCCD := '';

   //테스트
   {SetLength(sDCCODE, 1);
   SetLength(sRECEIPTDATE, 1);
   sDCCODE[0] := '03';
   sRECEIPTDATE[0]:= '2021-05-26';
   asDCCODE := 1;
   nDCTKNO :='1413904';
   sNowLprCarNo1 := lbCarNo.Caption;}

   {$REGION '채번된 환자번호로 OCS할인'}
   ExceptLogging('환자 코드 길이 : '+ inttostr(asDCCODE));
   if asDCCODE > 0 then begin
      for I := 0 to asDCCODE - 1 do begin
          nTempDCNo := 0;
          if (bIsAdmission = True) and ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin
            logStr := logStr + #13#10 + ('입퇴원 할인받은 차량은 중복입원할인 불가능.');
          end else begin
            if ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin
              //입원할인 처리 진입한경우 변수할당하여 입원할인 중복처리 불가하도록..
              bIsAdmission := True;
              //OCS에서 입원시작일 정보 가져오기
              if (sDCCODE[I] = '03') then begin //할인코드 03인경우 수납일 = 입원일임.
                sAdmStartDate := sRECEIPTDATE[I];
              end else if (sDCCODE[I] = '04') then begin
                if asDCCODE_PAST > 0 then begin
                  for J := 0 to asDCCODE_PAST - 1 do begin
                    if (sDCCODE_PAST[J] = '03') and (sPID_PAST[J] = sPID[I]) then begin
                      sAdmStartDate := sRECEIPTDATE_PAST[J]; //입원일 변수 할당
                    end;
                  end;
                  if sAdmStartDate = '' then begin
                    sAdmStartDate := sRECEIPTDATE[I];
                  end;
                end else begin
                  sAdmStartDate := sRECEIPTDATE[I];
                end;
              end;
              //OCS에서 퇴원일 정보 가져오기
              if bIsPast then begin
                sAdmEndDate := MG_AddDate(Copy(aString(lbOutTime.Caption), 1, 10), -1);
              end else begin
                sAdmEndDate := Copy(aString(lbOutTime.Caption), 1, 10);
              end;

              logStr := logStr + #13#10 + ('입원일자 : ' + sAdmStartDate+ ', 퇴원일자 : ' + sAdmEndDate);
               //가져와진 입원일자랑 입차일자 비교 시작
              if sAdmStartDate >= Copy(aString(lbInTime.Caption), 1, 10) then begin
                sAdmStartDate := sAdmStartDate;
              end else begin
                sAdmStartDate := Copy(aString(lbInTime.Caption), 1, 10);
              end;

              //퇴원일자 조정 : 전날할인 들고왔을 경우에 시작일이 퇴원일보다 더클경우 문제발생
              if sAdmEndDate < sAdmStartDate then
                sAdmEndDate := sAdmStartDate;

              //보호자(6H), OCS 입원(6H) 할인은 입차후 24시간 할인 적용 시키도록 적용
              if (sDCCODE[I] = '03') or (sDCCODE[I] = '04') then
              begin
                ExceptLogging('OCS Code: '+sDCCODE[I]);
                //보호자 할인 (6h)할인은 입차 후 24시간으로 계산 후 할인 적용  11.05
                //우선 할인 적용 있는지 확인 여부
                nprocdate := '';
                nprocTime := '';
                nFirstpdateTime := '';
                nprocdate_nprocTime:='';
                //21.05.26 환자 번호 하나당 3대 차량까지만 할인 적용
                ExceptLogging('OCS 입원날짜 '+sAdmStartDate);
                ExceptLogging('OCS 입원날짜(출차) '+sAdmEndDate);
                ExceptLogging('OCS 환자번호 '+nDCTKNO);
                dmTables.qryOCSProc.DisableControls;
                dmTables.qryOCSProc.Close;
                dmTables.qryOCSProc.SQL.Clear;
                dmTables.qryOCSProc.SQL.Add('SELECT distinct CarNo, DCTKNo, RealDCMin  from DCDetail ');
                dmTables.qryOCSProc.SQL.Add('where ProcDate = :V1 and DCTKNo = :V2 ');
                dmTables.qryOCSProc.SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04''))  ');
                dmTables.qryOCSProc.Parameters.ParamByName('V1').Value := sAdmEndDate;
                dmTables.qryOCSProc.Parameters.ParamByName('V2').Value := nDCTKNO;
                ExceptLogging(dmTables.qryOCSProc.sql.Text);
                dmTables.qryOCSProc.Open;
                if dmTables.qryOCSProc.RecordCount > 3 then begin  //3대 차량일 경우
                  while not dmTables.qryOCSProc.eof do
                  begin
                    SQL_Field11 := dmTables.qryOCSProc.FieldByName('CarNo');
                    ExceptLogging('환자번호 하나당 OCS 할인 차량 확인 : '+sNowLprCarNo1);
                    if sNowLprCarNo1 = SQL_Field11.AsString then
                    begin
                       OCS_CAR_DCDetail := 1;
                       ExceptLogging('환자번호 하나당 OCS 할인 차량이므로 적용 : '+sNowLprCarNo1);
                    end;
                    dmTables.qryOCSProc.Next;
                  end;

                  if OCS_CAR_DCDetail = 0 then
                  begin
                     ExceptLogging(' 환자번호 하나당OCS 할인 차량 초과(3대)이므로 적용 안됨 : '+sNowLprCarNo1);
                     Break;
                  end;
                end;

                //입원 당시 날짜로 입차 최초의 할인 시간 및 날짜 조회 입차 후 24시간(1일) 계산  11.05
                dmTables.qryOCSProc.Close;
                dmTables.qryOCSProc.SQL.Clear;
                dmTables.qryOCSProc.SQL.Add('SELECT Top 1 * from IONDATA');
                dmTables.qryOCSProc.SQL.Add('where ProcDate = :V1 and InCarNo1 = :V2  ');
                dmTables.qryOCSProc.SQL.Add('order by procdate asc, proctime asc   ');
                dmTables.qryOCSProc.Parameters.ParamByName('v1').Value := sAdmStartDate;
                dmTables.qryOCSProc.Parameters.ParamByName('v2').Value := sNowLprCarNo1;
                ExceptLogging(dmTables.qryOCSProc.sql.Text);
                dmTables.qryOCSProc.Open;
                nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                    IncHour(StrToDateTime(aString(lbInTime.Caption)), 24));
                ExceptLogging('OCS 할인 할인 횟수 : '+inttostr(nAdmDateCount));

                if dmTables.qryOCSProc.RecordCount > 0 then begin
                  //21.03.15 디비 속도 향상
                  SQL_Field6 := dmTables.qryOCSProc.FieldByName('procdate');   //날짜
                  SQL_Field7 := dmTables.qryOCSProc.FieldByName('procTime');   //시간
                  nprocdate  := SQL_Field6.AsString;
                  nprocTime  := SQL_Field7.AsString;
                  nFirstpdateTime := nprocdate+' '+nprocTime;      //마지막 입차 날짜, 시간
                  //최초 입차 후 24시간 계산
                  ExceptLogging('최초 입차 : '+ nFirstpdateTime);
                  nprocdate_nprocTime := DateTimetostr(IncHour(StrToDateTime(nprocdate+' '+nprocTime), 24));
                  ExceptLogging('최초 입차 후 24시간 후: '+ nprocdate_nprocTime);

                  //마지막 입차 후 24시간 후의 날짜 보다 현재 입차가 날짜가 크면 보호자 할인 시간 0분적용
                  if IncHour(StrToDateTime(aString(nFirstpdateTime)), 24) < StrToDateTime(aString(lbInTime.Caption)) then
                  begin
                       nAdmDateCount := 0;
                  end
                  else
                  begin
                      nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                  StrToDateTime(aString(lbOutTime.Caption)));
                      if nAdmDateCount = 0 then
                      begin

                         nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                     StrToDateTime(aString(lbOutTime.Caption))) + 1;
                      end
                      else
                      begin
                         nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                     StrToDateTime(aString(lbOutTime.Caption)));
                      end;
                      ExceptLogging('OCS 할인 할인 횟수(최초 입차 날짜 기준) : '+inttostr(nAdmDateCount));

                      nFirstpdateTime := nFirstpdateTime;
                      nprocdate_nprocTime := DateTimeToStr(IncHour(StrToDateTime(aString(nFirstpdateTime)), 24 * nAdmDateCount));
                      ExceptLogging('보호자입차2 : '+nFirstpdateTime);
                      ExceptLogging('보호자입차(24시간 후)2 : '+nprocdate_nprocTime);
                  end;
                  //보호자 할인 입차 후 24시간이내에      11.05
                  //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                  dmTables.qryOCSProc.Close;
                  dmTables.qryOCSProc.SQL.Clear;
                  dmTables.qryOCSProc.SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                  dmTables.qryOCSProc.SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                  dmTables.qryOCSProc.SQL.Add('FROM DCDetail ');
                  dmTables.qryOCSProc.SQL.Add('WHERE 1=1 ');
                  if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                    dmTables.qryOCSProc.SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                  end else begin
                    dmTables.qryOCSProc.SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                  end;
                  dmTables.qryOCSProc.SQL.Add('AND ProcDate +'' ''+ProcTime BETWEEN :v1 and :v2');
                  dmTables.qryOCSProc.SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                  dmTables.qryOCSProc.SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                  dmTables.qryOCSProc.Parameters.ParamByName('v1').Value := nFirstpdateTime;
                  dmTables.qryOCSProc.Parameters.ParamByName('v2').Value := nprocdate_nprocTime;  //입차 후 24시간
                  ExceptLogging(dmTables.qryOCSProc.sql.Text);
                  dmTables.qryOCSProc.Open;
                end
                else  //최조 입차 기록이 없을 경우
                begin
                   //보호자 할인 입차 후 24시간이내에      11.05
                  //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                  //입차 기준으로 할인 시간 확인
                  nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                              StrToDateTime(aString(lbOutTime.Caption)));
                  ExceptLogging('OCS 할인 할인 횟수 3: '+inttostr(nAdmDateCount));
                  if nAdmDateCount = 0 then
                  begin
                     nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                                 StrToDateTime(aString(lbOutTime.Caption))) + 1;
                     ExceptLogging('OCS 할인 할인 횟수4 : '+inttostr(nAdmDateCount));
                  end;

                  dmTables.qryOCSProc.Close;
                  dmTables.qryOCSProc.SQL.Clear;
                  dmTables.qryOCSProc.SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                  dmTables.qryOCSProc.SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                  dmTables.qryOCSProc.SQL.Add('FROM DCDetail ');
                  dmTables.qryOCSProc.SQL.Add('WHERE 1=1 ');
                  if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                    dmTables.qryOCSProc.SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                  end else begin
                    dmTables.qryOCSProc.SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                  end;
                  dmTables.qryOCSProc.SQL.Add('AND ProcDate +'' ''+ProcTime BETWEEN :v1 and :v2');
                  dmTables.qryOCSProc.SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                  dmTables.qryOCSProc.SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                  dmTables.qryOCSProc.Parameters.ParamByName('v1').Value := aString(lbInTime.Caption);   //최초 입차
                  dmTables.qryOCSProc.Parameters.ParamByName('v2').Value := IncHour(StrToDateTime(aString(lbInTime.Caption)), 24);     //입차 후 24시간
                  ExceptLogging(dmTables.qryOCSProc.sql.Text);
                  dmTables.qryOCSProc.Open;
                end;
              end
              else
              begin
                nAdmDateCount := DaysBetween(StrToDateTime(sAdmEndDate + ' 00:00:00'),
                                             StrToDateTime(sAdmStartDate + ' 00:00:00')) + 1;
                ExceptLogging('OCS 할인 할인 횟수 : '+inttostr(nAdmDateCount));
                //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                dmTables.qryOCSProc.Close;
                dmTables.qryOCSProc.SQL.Clear;
                dmTables.qryOCSProc.SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                dmTables.qryOCSProc.SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                dmTables.qryOCSProc.SQL.Add('FROM DCDetail ');
                dmTables.qryOCSProc.SQL.Add('WHERE 1=1 ');
                if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                  dmTables.qryOCSProc.SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                end else begin
                  dmTables.qryOCSProc.SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                end;
                dmTables.qryOCSProc.SQL.Add('AND ProcDate BETWEEN :v1 and :v2');
                dmTables.qryOCSProc.SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                dmTables.qryOCSProc.SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                dmTables.qryOCSProc.Parameters.ParamByName('v1').Value := sAdmStartDate;
                dmTables.qryOCSProc.Parameters.ParamByName('v2').Value := sAdmEndDate;
                ExceptLogging(dmTables.qryOCSProc.sql.Text);
                dmTables.qryOCSProc.Open;
              end;
              logStr := logStr + #13#10 + ('입원할인 시작일자 : ' + sAdmStartDate+', 입원할인 종료일자 : ' + sAdmEndDate+', 입원할인 적용일수 : ' + IntToStr(nAdmDateCount));

              //12.29 OCS 할인 시간 주차시간 1일 이상시 남은 시간 6시간 이내의 차량 할인 적용
              nAdmDateTime  := 0;
              nsAdmDateTime := 0;
              if nDayEx >= 1 then
              begin
                if nHourEx <= 6 then   //6시간까지 할인 적용
                begin
                   nAdmDateTime := nHourEx * 60 + nMinEx;
                   ExceptLogging(IntToStr(nDayEx)+' 일 '+'남은 주차시간(분) '+ IntToStr(nAdmDateTime));
                   nsAdmDateTime := nAdmDateTime;
                end
                else //6시간 초과시
                begin
                   nAdmDateTime := 360;
                   ExceptLogging(IntToStr(nDayEx)+' 일 '+'남은 주차시간(분)_6시간 초과  '+ IntToStr(nAdmDateTime));
                end;
                nsAdmDateCount := nDayEx;
                ExceptLogging('구간 요금 일수 : '+ inttostr(nsAdmDateCount));
              end;

              nTotRemainTime := 360 * nAdmDateCount + nAdmDateTime;
              if dmTables.qryOCSProc.RecordCount > 0 then begin
                //21.03.15 디비 속도 향상
                SQL_Field8 := dmTables.qryOCSProc.FieldByName('dcsum');
                nAlreadyDCValue := SQL_Field8.AsInteger;
                //당일 재입차시 남은시간 (360분)내 할인 적용
                if (nDayEx < 1) and (nAlreadyDCValue >= 360)  then
                begin
                    nAlreadyDCValue := 360 - (nAlreadyDCValue mod 360);
                    ExceptLogging('[당일 재입차시 남은 시간] : ' +  inttostr(nAlreadyDCValue));
                end
                else
                begin
                    nRemainDCValue := nTotRemainTime - nAlreadyDCValue; //기존사용한 시간 차감
                end;
              end else begin
                //결과가 없는 경우
                nAlreadyDCValue := 0;
                nRemainDCValue := nTotRemainTime; //매일 보호자에게 부여되는 무료출차시간 360분*일수
              end;
              ExceptLogging('[총가용시간(분)] '+ IntToStr(nTotRemainTime));
              ExceptLogging('[이전 사용시간/남은시간(분)] '+IntToStr(nAlreadyDCValue) + '/'+IntToStr(nRemainDCValue));

              dmTables.qryOCSProc.Close;
              dmTables.qryOCSProc.SQL.Clear;
              if sDCInTime2 <> '' then   //OCS 중복 할인(01,02코드시) 시
              begin
                 if lbOutTime.Caption < sDCInTime  then    //출차 시간보다 입차 시간이 큰 경우
                 begin
                    sDCInTime := lbOutTime.Caption;
                 end;
                 dmTables.qryOCSProc.SQL.Add('select datediff(mi,'+QuotedStr(sDCInTime)+' , '+QuotedStr(lbOutTime.Caption)+')' );

              end
              else  //OCS 중복 할인 안할시
              begin
                 //자동입차
                 dmTables.qryOCSProc.SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                 //수동 입차
                 //SQL.Add('select datediff(mi,'+QuotedStr(lbInTime.Caption)+' , '+QuotedStr(lbOutTime.Caption)+')' );
              end;
              dmTables.qryOCSProc.Open;
              ExceptLogging(dmTables.qryOCSProc.SQL.Text);
              if dmTables.qryOCSProc.RecordCount > 0 then begin
                nowUseTime := dmTables.qryOCSProc.Fields[0].AsInteger;
                ExceptLogging('[현재주차시간(분)] '+IntToStr(nowUseTime));
                if nowUseTime > (nTotRemainTime - nAlreadyDCValue) then begin
                  overuseTime := abs(nTotRemainTime-nAlreadyDCValue-nowUseTime);
                  nAlreadyDCValue := nTotRemainTime;
                end else if nowUseTime = (nTotRemainTime - nAlreadyDCValue) then begin
                  nAlreadyDCValue := nTotRemainTime;
                  overUseTime := 0;
                end else begin
                  nAlreadyDCValue := nAlreadyDCValue + nowUseTime;
                  nRemainDCValue := nTotRemainTime - nAlreadyDCValue;
                  overUseTime := 0;
                end;
                ExceptLogging('[사용시간/초과사용시간(분)] '+IntToStr(nAlreadyDCValue)+'/'+IntToStr(overuseTime));
              end;

              //10.19 초과 사용 시간(분) 경우  (남은 주차 시간 계산)
              if nAlreadyDCValue > 0 then begin
                //입원일 당일이 입원재입차인경우, 해당시간만큼 차감하여 계산.
                //21.01.09 보호자 시간이 없거나 주차시간 초과 한 경우
                if (nRemainDCValue > 0)  then begin
                  nISCCD := sDCCODE[I]; //보호자 할인 적용
                  //nRemainDCValue := OCSAdminDCDetail(nRemainDCValue);     //차감할인 적용
                  //21.04.02
                    nRemainDCValue := OCSAdminDCDetail_Ex(nRemainDCValue);     //차감할인 적용
                                      OCSAdminDCDetail_DCTime(nTotalTimeDC2); //차감할인 적용
                end
                else
                begin
                   ExceptLogging('보호자 남은시간(분) '+inttostr(nRemainDCValue)+ ' OCS할인적용 안됨');
                end;
              end
              else
              begin
                //입원 후 24시간 후 입차 시 할인 적용이 안되도록 설정(최초 요금 부과)
                if sDCInTime <> '' then  //OCS중복 할인
                begin
                end
                else
                begin
                  edtProcYogum.Text := inttostr(nTotYogum2);
                  nProcYogum := nTotYogum2;
                  lbDCName.Caption := '';
                  edtDC.Text:='';
                end;
              end;
              edtDCRemain.Text := IntToStr(nRemainDCValue);
              ExceptLogging('[실제남은시간] '+ edtDCRemain.Text);
            end else begin
              //일반할인
              //재입차시 반복부여 가능
              ExceptLogging('OCS Code: '+sDCCODE[I]);
              ExceptLogging('OCS 입원일자: '+sRECEIPTDATE[I]);

              dmTables.qryOCSProc.Close;
              dmTables.qryOCSProc.SQL.Clear;
              dmTables.qryOCSProc.SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
              dmTables.qryOCSProc.Parameters.ParamByName('DCCODE').Value := sDCCODE[I];
              dmTables.qryOCSProc.Open;

              if dmTables.qryOCSProc.RecordCount > 0 then begin
                //21.03.15 디비 속도 향상
                SQL_Field9 := dmTables.qryOCSProc.FieldByName('DCNo');
                nTempDCNo := SQL_Field9.AsInteger;
                nISCCD    := sDCCODE[I];
                nOcsCode  := sDCCODE[I];
                if sDCCODE[0] = '06' then
                begin
                   ExceptLogging('단독 OCS(06)재증명(1H) 할인 처리 시작일자: '+sDCInTime2);
                   sDCInTime2 :='';
                   ExceptLogging('단독 OCS(06)재증명(1H) 할인 처리 시작일자 후: '+sDCInTime2);
                end;
              end else begin
                logStr := logStr + #13#10 + ('OCS할인코드 ['+sDCCODE[I]+']넥스파 할인코드 매칭안됨 확인요망.');
              end;
              if nTempDCNo > 0 then begin
                OCSDCDetail(nTempDCNo);
              end;
            end;
          end;
          dmTables.qryOCSProc.EnableControls;
      end;
      //2020-04-28 대전성모 수정사항 : OCS연동할인 후 추가할인키 입력인 안되도록 설정
      sYounmCount := 0;
      DCEnable(False);
   end else begin
     logStr := logStr + #13#10 + ('환자 주차료 할인 테이블내 현재 차량 정보 없음!: '+'OCS할인처리 중단.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
     nISCCD :=''; //OCS할인코드
     sDCInTime2 := '';//OCS중복 할인 초기화
   end;
   {$ENDREGION}
 finally
    sPATIENTNO := nil;
    sDCCODE := nil;
    dmTables.qryOCSProc.Active := False;

    sDCCODE_PAST := nil; //병원에 등록된 OCS할인정보 변수 초기화
    sRECEIPTDATE := nil;   //병원에 등록된 수납일자 변수
    sRECEIPTDATE_PAST := nil; //병원에 등록된 수납일자 변수

    logStr := logStr + #13#10 + ('OCS 할인처리 종료');
    ExceptLogging(logStr);
 end;
end;

procedure TfrmMainNew.OCSDCProc_Ex_Bar(sNowTKno, barC: String);
var
  I, J, nTempDCNo, nAdmDateCount,    //임시저장용 할인코드
  nAdmDateTime, nTotRemainTime, nRemainDCValue, nAlreadyDCValue : Integer;    //남은 시간(1일 이상 주차 시),  //입원일기간 총 보호자차감 잔여분,   //입원일 재입차시 잔여 할인값, //입원일 재입차시 사용한 할인값
  logStr, sAdmStartDate, sAdmEndDate,   //입원할인시작일
  nprocdate, nprocTime, nprocdate_nprocTime, nFirstpdateTime, tempString  : aString;  //보호자 할인 처리 변수
  //디비 속도 향상
  SQL_Field6, SQL_Field7, SQL_Field8, SQL_Field9, SQL_Field10: TField;
begin
   tempString := barC;
   ExceptLogging('***************************************************************');
   ExceptLogging('[바코드할인] 대전성모병원 OCS 정보 처리 시작');
   sAdmStartDate := '';
   sAdmEndDate   := '';
   nAdmDateCount := 0;
   bIsPatient := False;

   nAlreadyDCValue := 0;
   nRemainDCValue  := 0;
   nowUseTime := 0;
   overUseTime := 0;
   //재입차시 반복부여 가능
   nDCValue := 0; //총 주어진 할인 주차 시간
   //OCS 중복할인 처리 변수
   sDCInTime2 := '';
   sDCOutTime2:= '';
   //수동처리
   nmanualUse := 0;
   asDCCODE := 0;
   //OCS 환자번호 변수
   nDCTKNO := '';
   nOcsCode  := '';

   //디비 속도 처리
   SQL_Field := TField.Create(self);
   SQL_Field2 := TField.Create(self);
   SQL_Field3 := TField.Create(self);
   SQL_Field4 := TField.Create(self);
   SQL_Field5 := TField.Create(self);

   SQL_Field6 := TField.Create(self);
   SQL_Field7 := TField.Create(self);
   SQL_Field8 := TField.Create(self);
   SQL_Field9 := TField.Create(self);
   SQL_Field10 := TField.Create(self);
   try
   {$REGION '채번된 환자번호로 OCS할인'}
     ExceptLogging('채번된 환자번호로 OCS할인정보 획득 시작');
     nDCTKNO := barC;
     ExceptLogging('OCS 할인 환자번호(바코드) : ' + nDCTKNO);
     try
        bIsAdmission := False;
        dmTables.qryOCS.DisableControls;
        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 연동 당일 바코드 할인 코드 시작(쿼리 시간) : ' + OCSTIME);

        dmTables.qryOCS.Close;
        dmTables.qryOCS.SQL.Clear;
        dmTables.qryOCS.SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
        dmTables.qryOCS.SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS Where PID = ''' + QuotedStr(tempString) + ''' ');
        dmTables.qryOCS.SQL.Add('ORDER BY DISCCD ASC, RCPTDD ASC, RCPTTM ASC '')');
        ExceptLogging('OCS 당일 할인정보 획득 쿼리 : ' + dmTables.qryOCS.SQL.Text);
        dmTables.qryOCS.Open;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 연동 당일 바코드 할인 코드 중간(쿼리 시간) : ' + OCSTIME);

        if dmTables.qryOCS.RecordCount > 0 then begin
          SetLength(sDCCODE, dmTables.qryOCS.RecordCount);
          SetLength(sRECEIPTDATE, dmTables.qryOCS.RecordCount);
          SetLength(sPID, dmTables.qryOCS.RecordCount);
          //bIsPatientUse := 1;
          I := 1;

          SQL_Field2 := dmTables.qryOCS.FieldByName('DISCFLAG');
          SQL_Field3 := dmTables.qryOCS.FieldByName('DISCCD');
          SQL_Field4 := dmTables.qryOCS.FieldByName('RCPTDD');
          SQL_Field  := dmTables.qryOCS.FieldByName('PID');
          SQL_Field5 := dmTables.qryOCS.FieldByName('HANDICAPRYN');
          //21.03.17 수정
          while not dmTables.qryOCS.Eof do begin
           //디비 속도 향상
            sDISCFLAG := SQL_Field2.AsString;
            sDISCCD   := SQL_Field3.AsString;
            sRCPTDD   := SQL_Field4.AsString;
            nPID      := SQL_Field.AsString;
            sHANDICAPRYN   := SQL_Field5.AsString;

            if sDISCFLAG = '02' then begin //시간
              if (sDISCCD = '01') or
                 (sDISCCD = '02') or
                 (sDISCCD = '03') or
                 (sDISCCD = '04') or
                 (sDISCCD = '06')then begin //DISCCD (06-외래(제증명)) 1시간 할인
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE[I-1]      := sDISCCD; //tempString;

                sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID[I-1] := nPID;
                Inc(I);
              end else begin
                ExceptLogging('병원에서 제공한 할인코드가 상이함.. 할인 불가능');
                ExceptLogging('DISCCD : ['+sDISCCD+'] ');
                ExceptLogging('DISCFLAG : ['+sDISCFLAG+'] ');
              end;
            end else if sDISCFLAG = '01' then begin //당일
              if (sDISCCD = '05') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE[I-1]      := sDISCCD;
                sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID[I-1] := nPID;
                Inc(I);
              end;
            end;
            dmTables.qryOCS.Next;
          end;

        end else begin
          bIsPatientUse := 0;
          ExceptLogging('OCS 당일 할인정보 테이블내 현재 차량 정보 없음! ');
          ExceptLogging('.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
        end;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 바코드 할인 코드 시작(쿼리 시간) : ' + OCSTIME);
        dmTables.qryOCS.Close;
        dmTables.qryOCS.SQL.Clear;
        dmTables.qryOCS.SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
        dmTables.qryOCS.SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS_PAST Where PID = ''' + QuotedStr(tempString)+''' ');
        dmTables.qryOCS.SQL.Add(' '')');
        ExceptLogging('OCS 전날 할인정보 획득 쿼리 : ' + dmTables.qryOCS.SQL.Text);
        dmTables.qryOCS.Open;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 바코드 할인 코드 중간(쿼리 시간) : ' + OCSTIME);

        if dmTables.qryOCS.RecordCount > 0 then begin
          SetLength(sDCCODE_PAST, dmTables.qryOCS.RecordCount);
          SetLength(sRECEIPTDATE_PAST, dmTables.qryOCS.RecordCount);
          SetLength(sPID_PAST, dmTables.qryOCS.RecordCount);
          I := 1;
          //21.03.17 수정
          SQL_Field2 := dmTables.qryOCS.FieldByName('DISCFLAG');
          SQL_Field3 := dmTables.qryOCS.FieldByName('DISCCD');
          SQL_Field4 := dmTables.qryOCS.FieldByName('RCPTDD');
          SQL_Field  := dmTables.qryOCS.FieldByName('PID');
          SQL_Field5 := dmTables.qryOCS.FieldByName('HANDICAPRYN');

          while not dmTables.qryOCS.Eof do begin
           //디비 속도 향상
            sDISCFLAG := SQL_Field2.AsString;
            sDISCCD   := SQL_Field3.AsString;
            sRCPTDD   := SQL_Field4.AsString;
            nPID      := SQL_Field.AsString;
            sHANDICAPRYN   := SQL_Field5.AsString;

            if sDISCFLAG = '02' then begin //시간
              if //(sDISCCD = '01') or
                 //(sDISCCD = '02') or
                 (sDISCCD = '03') or
                 (sDISCCD = '04') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE_PAST[I-1]      := sDISCCD; //tempString;

                sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID_PAST[I-1] := nPID;
                Inc(I);
              end else begin
                ExceptLogging('병원에서 제공한 할인코드가 상이함.. 할인 불가능');
                ExceptLogging('DISCCD : ['+sDISCCD+'] ');
                ExceptLogging('DISCFLAG : ['+sDISCFLAG+'] ');
              end;
            end else if sDISCFLAG = '01' then begin //당일
              if (sDISCCD = '05') then begin
                ExceptLogging(sDISCFLAG+' '+'['+IntToStr(I)+'] : ' + sDISCCD);
                sDCCODE_PAST[I-1]      := sDISCCD;
                sRECEIPTDATE_PAST[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                     Copy(sRCPTDD, 5, 2) + '-' +
                                     Copy(sRCPTDD, 7, 2);
                sPID_PAST[I-1] := nPID;
                Inc(I);
              end;
            end;
            dmTables.qryOCS.Next;
          end;
        end;

        asDCCODE := Length(sDCCODE);
        if asDCCODE = 0 then begin
          //당일 할인이 한개도 없을경우, 전날할인을 본다
          sDCCODE      := sDCCODE_PAST;
          sRECEIPTDATE := sRECEIPTDATE_PAST;
          sPID         := sPID_PAST;
          bIsPast      := True;
        end;
        asDCCODE := Length(sDCCODE);
        asDCCODE_PAST := Length(sDCCODE_PAST);
        OCSDCProc_Ex(sNowTKno);   //OCS 할인 코드 처리
        {$ENDREGION}
     except
        on E: Exception do begin
          ExceptLogging('채번된 환자번호로 바코드 OCS할인정보 획득 중 오류 발생 : ' + E.Message);
          Exit;
        end;
     end;
   finally
     sPATIENTNO := nil;
     sDCCODE := nil;
     dmTables.qryOCS.Active := False;
     ExceptLogging('OCS 할인처리 종료');
   end;
end;

function TfrmMainNew.GracetimeCheck(sInTime: AnsiString; sNow: AnsiString): Boolean;
begin
  try
    Result:= False;

    case DayOfWeek(Now) of
      1: begin
           if ((FormatDateTime('HH:NN', Now) >= GTime.GT6) and (FormatDateTime('HH:NN', Now) <= GTime.GT7)) then
           begin
             if (FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(sInTime) + StrToTime(GTime.GT8)) >= Copy(sNow, 1, 16)) then
               Result:= True
             else
               Result:= False;
           end
           else
           begin
             if FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(sInTime) + StrToTime(GTime.GT1)) >= Copy(sNow, 1, 16) then
               Result:= True
             else
               Result:= False;
           end;
      end;

      2..6: begin
              if FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(sInTime) + StrToTime(GTime.GT1)) >= Copy(sNow, 1, 16) then
                Result:= True
              else
                Result:= False;
      end;

      7: begin
           if ((FormatDateTime('HH:NN', Now) >= GTime.GT3) and (FormatDateTime('HH:NN', Now) <= GTime.GT4)) then
           begin
             if (FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(sInTime) + StrToTime(GTime.GT5)) >= Copy(sNow, 1, 16)) then
               Result:= True
             else
               Result:= False;
           end
           else
           begin
             if FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(sInTime) + StrToTime(GTime.GT1)) >= Copy(sNow, 1, 16) then
               Result:= True
             else
               Result:= False;
           end;
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.GracetimeCheck: ' + E.Message);
  end;
end;

procedure TfrmMainNew.InCarList;    //입차 내역 조회
var
  i : Integer;
begin
    with dmTables.ADOQuery1 do
    begin
       Close;
       SQL.Clear;
       SQL.Add('  	   select InUnitName, ProcDate, ProcTime, GroupName, name, InCarNo1, CompName, DeptName, CarType2, ExpDateT   from (   ');
       SQL.Add('Select b.UnitName as InUnitName, a.ProcDate, a.ProcTime, a.GroupName, a.name,                                              ');
       SQL.Add('       a.InCarNo1,  a.CompName, a.DeptName, ''정기차량''  as CarType2, d.ExpDateT                                          ');
       SQL.Add('  from IOSData a Inner Merge join UnitInfo b ON a.UnitNo = b.UnitNo                                                        ');
       SQL.Add('                 Left outer join CustInfo d ON d.Carno = a.InCarNo1                                                        ');
       SQL.Add('  where ProcDate >= :N1 and ProcDate <=  :N2 and  a.TKType = 2  and b.Myno = :N5 and b.UnitKind = 8                        ');
       SQL.Add('  union                                                                                                                    ');
       SQL.Add('Select b.UnitName as InUnitName, a.ProcDate, a.ProcTime, '''', '''',                                                       ');
       SQL.Add('       a.InCarNo1, a.Reserve2, a.Reserve3, ''일반차량'' as CarType2, ''''                                                  ');
       SQL.Add('  from IONData a Inner Merge join UnitInfo b ON a.UnitNo = b.UnitNo                                                        ');
       SQL.Add('  where ProcDate >=  :N3 and ProcDate <=  :N4 and b.Myno = :N6  and b.UnitKind = 8                                         ');
       SQL.Add(')IOS_N                                                                                                                     ');
       SQL.Add('order by procdate desc, procTime desc                                                                                      ');

       Parameters.ParamByName('N1').Value:= FormatDateTime('yyyy-mm-dd', now);
       Parameters.ParamByName('N2').Value:= FormatDateTime('yyyy-mm-dd', now);

       Parameters.ParamByName('N3').Value:= FormatDateTime('yyyy-mm-dd', now);
       Parameters.ParamByName('N4').Value:= FormatDateTime('yyyy-mm-dd', now);

       Parameters.ParamByName('N5').Value:= nCurrUnitNo;
       Parameters.ParamByName('N6').Value:= nCurrUnitNo;
       Open;

       if eof then
       begin
         //ShowMessage('데이터가 없습니다.');
         Exit;
       end;

       i := 1;
       while not eof do
       begin
         with sgIn do
         begin

            Cells[0, 0]  := '차량종류';
            Cells[1, 0] := '입차일자';
            Cells[2, 0] := '입차시각';
            Cells[3, 0] := '차량번호';
            Cells[4, 0] := '소속';
            Cells[5, 0] := '성명';
            Cells[6, 0] := '유효기간';
            Cells[7, 0] := '출입상태';

            Cells[0, i] := FieldByName('CarType2').AsString;
            Cells[1, i] := FieldByName('ProcDate').AsString;
            Cells[2, i] := FieldByName('ProcTime').AsString;
            Cells[3, i] := FieldByName('InCarNo1').AsString;
            Cells[4, i] := FieldByName('CompName').AsString+' '+FieldByName('DeptName').AsString;
            Cells[5, i] := FieldByName('Name').AsString;
            Cells[6, i] := FieldByName('ExpDateT').AsString;
            Cells[7, i] := '입 차';

            Alignments[0, i] := taCenter;
            Alignments[1, i] := taCenter;
            Alignments[2, i] := taCenter;
            Alignments[3, i] := taCenter;
            Alignments[4, i] := taCenter;
            Alignments[5, i] := taCenter;
            Alignments[6, i] := taCenter;
            Alignments[7, i] := taCenter;
         end;
         inc(i);
         Next;
       end;

      with sgIn do
      begin
         ColCount := 8;
         RowCount := i;
      end;
      First;
    end;
end;

procedure TfrmMainNew.InitProc;
begin
  try
    //제어판의 시간형식 설정...
    SetLocaleInfo(LOCALE_SYSTEM_DEFAULT, LOCALE_STIMEFORMAT, 'HH:mm:ss');
//    DateSeparator  := '-';
//    TimeSeparator  := ':';
//    ShortDateFormat:= 'YYYY-MM-DD';
//    LongDateFormat := 'YYYY-MM-DD';
//    ShortTimeFormat:= 'HH:NN:SS';
//    LongTimeFormat := 'HH:NN:SS';
  except
    on E: Exception do ExceptLogging('TfrmMainNew.InitProc: ' + E.Message);
  end;
end;

procedure TfrmMainNew.FreeOpenOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte);
var
  sNow, sInCarNo, sInTKNo, sInDate, sInTime, sParking, sInFile, sImgFile1,
    sImgFile2, sLocalFile, sTime, sDir, sYogum: aString;
  nDay, nHour, nMin, nOutCnt: Cardinal;
  nInUnitNo, i: Word;
  hr: HRESULT;
  sDspIP: aString;
begin
  try
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = nowLpr.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        Break;
      end;
    end;
  except
    on E: Exception do
    begin
      ShowMessage('LPR 설정을 확인하여 주세요!');
      Exit;
    end;
  end;

  // 일반차량 출차처리...
  try
    with dmTables.qryManualOut do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from Gracetime where ParkNo = :N1');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
        with GTime do
        begin
          GT1 :=  FieldByName('GT1').AsString;
          GT2 :=  FieldByName('GT2').AsString;
          GT3 :=  FieldByName('GT3').AsString;
          GT4 :=  FieldByName('GT4').AsString;
          GT5 :=  FieldByName('GT5').AsString;
          GT6 :=  FieldByName('GT6').AsString;
          GT7 :=  FieldByName('GT7').AsString;
          GT8 :=  FieldByName('GT8').AsString;
          GT9 :=  FieldByName('GT9').AsInteger;
//          GT10 := FieldByName('GT10').AsString;
//          GT11 := FieldByName('GT11').AsString;
        end
        else
          ClearGTime;
    end;

    // 화면표시
    lbCarNo.Caption := sLprCarNo1;
    lbOutCarNo.Caption := sLprCarNo1;
    lbInTime.Caption := sManualInTime;
    sNow := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
    lbOutTime.Caption := sNow;
    sParking := '';
//    nParkingMin := 0;
//    nParkingMin := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 16), 0, 1, 0, 0) + ':01') - StrToDateTime(lbInTime.Caption)) * 24 * 60);
//    nDay := nParkingMin div (24 * 60);
//    nHour := (nParkingMin mod (24 * 60)) div 60;
//    nMin := (nParkingMin mod (24 * 60)) mod 60;

    lbParkingTime.Caption := '고정개방시간차량';

    sNowLprFile1 := sLprFile1;
    sNowLprCarNo1 := sLprCarNo1;
    sNowLprFile2 := sLprFile2;
    sNowLprCarNo2 := sLprCarNo2;
    sNowIOTime := sIOTime;
    nNowLprNo := nLprNo;
    nNowLprInOut := nLprInOut;
    nNowLprRecog1 := nLprRecog1;
    nNowLprRecog2 := nLprRecog2;
    sNowInTKNo := sManualTKNo;
    nNowInUnitNo := nCurrUnitNo;
    sNowInDate := Copy(sManualInTime, 1, 10);
    sNowInTime := Copy(sManualInTime, 12, 8);
    sNowInCarNo := sLprCarNo1;
    sNowOutDate := Copy(sNow, 1, 10);
    sNowOutTime := Copy(sNow, 12, 8);

    //주차요금 계산전에 기존 할인자료 등 클리어한다.
    for i := 1 to 50 do
      RDCCnt[i].nDCNowCnt := 0;

    ClearGTime;
    ClearDCProc;


    nProcYogum := nTotYogum;
    edtTotYogum.Text := IntToStr(nTotYogum);
    edtTotYogum.AutoThousandSeparator := True;
    edtProcYogum.Text := FormatFloat('#,##0', nTotYogum);
    //edtProcYogum.AutoThousandSeparator := True;
    sYogum := IntToStr(nTotYogum);

    for i := 1 to 6 do
      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;

    for i := 1 to Length(sYogum) do
    begin
      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
        (sYogum, Length(sYogum) - (i - 1), 1);
    end;

    for i := 1 to nUseBtnCnt do
    begin
      TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := True;
      TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := True;
    end;
    lbOutCarType.Caption := '일반차량';

    if edtProcYogum.Text = '0' then
      DspProc(2, 4, '회차허용차량' + MG_Left(sLprCarNo1, 12), sDspIP);

    btnProc.Enabled := True;

    if bCancel then
      btnCancel.Enabled := True;

    DCEnable(True);

    if bBarcodeDC then
    begin
      edtBarcode.Text := '';
      edtBarcode.SetFocus;
    end;
    sProcTime := sNow;
    sDCOutTime := sNow;
    sDCInTime := lbInTime.Caption;
    if bTest then
    begin
      nPayType := 1;
      MoneyProc(nowLpr);
    end;
  except
    on E: Exception do
      ExceptLogging('ManualOut: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.FreeTimeProc(csLPR: TClientSocket);
var
  i, nOutCnt: Integer;
  sParkName, sParkAddr, sRegNo, sAdmin, sTelephone, sReceipt, sCarNo: String;
  sSend: String;
  //정기차량 관련 변수
  nGroupNo : Integer;
  sGroupName, sCompName, sDeptName, sName : aString;
begin
  try
    nMCnt := nMCnt + 1;
    lbMCnt.Caption := FormatFloat('#,##0', nMCnt) + ' 건';
    // nMTot := nMTot + StrToInt(MG_StrTrim(edtProcYogum.Text, ','));
    // lbMTot.Caption := IntToStr(nMTot) + ' 원';
    nOutCnt := 0;

    // DB Write...
    with dmTables.qryMoneyProc do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from TKProc where ParkNo = :N1 and UnitNo = :N2 and ');
      SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
      Parameters.ParamByName('N5').Value := sNowInTKNo;
      Open;

      if RecordCount <= 0 then
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into TKProc ');
        SQL.Add
          ('(ParkNo, UnitNo, ProcDate, ProcTime, TKType, CarType, FeeNo, ');
        SQL.Add
          ('TKNo, TKParkNo, TKUnitNo, CarNo, InDate, InTime, ParkingMin, ');
        SQL.Add
          ('TotFee, TotDC, RealFee, RecvAmt, Change, DCCnt, MNo, UnPaid, ');
        SQL.Add('ChkClosing, CommercialTariff, SpecialTariff, PayType, Reserve2) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, ');
        SQL.Add(':N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
        SQL.Add(':N21, :N22, :N23, :N24, :N25, :N26, :N27)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nTKType;
        Parameters.ParamByName('N6').Value := 1;
        Parameters.ParamByName('N7').Value := nFeeNo;
        Parameters.ParamByName('N8').Value := sNowInTKNo;
        Parameters.ParamByName('N9').Value := nCurrParkNo;
        Parameters.ParamByName('N10').Value := nNowInUnitNo;
        Parameters.ParamByName('N11').Value := sNowInCarNo;
        Parameters.ParamByName('N12').Value := sNowInDate;
        Parameters.ParamByName('N13').Value := sNowInTime;
        Parameters.ParamByName('N14').Value := nParkingMin;
        Parameters.ParamByName('N15').Value := StrToInt
          (MG_StrTrim(edtTotYogum.Text, ','));
        Parameters.ParamByName('N16').Value := StrToInt
          (MG_StrTrim(edtTotYogum.Text, ','));
        Parameters.ParamByName('N17').Value := 0;
        Parameters.ParamByName('N18').Value := 0;
        Parameters.ParamByName('N19').Value := 0;
        Parameters.ParamByName('N20').Value := 0;
        Parameters.ParamByName('N21').Value := nCurrMNo;
        Parameters.ParamByName('N22').Value := 0;
        Parameters.ParamByName('N23').Value := 0;
        Parameters.ParamByName('N24').Value := 0;
        Parameters.ParamByName('N25').Value := 0;
        Parameters.ParamByName('N26').Value := 1;
        Parameters.ParamByName('N27').Value := '무료시간출차';
        ExecSQL;
      end;

      if nUseFeeItem > 0 then begin
        Close;
        SQL.Clear;
        SQL.Add(
          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
        SQL.Add(
          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
        SQL.Add(
          'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nNowInUnitNo;
        Parameters.ParamByName('N3').Value := sNowInDate;
        Parameters.ParamByName('N4').Value := sNowInTime;
        Parameters.ParamByName('N5').Value := 2;
        Parameters.ParamByName('N6').Value := 1;
        Parameters.ParamByName('N7').Value := nCurrParkNo;
        Parameters.ParamByName('N8').Value := 2;
        Parameters.ParamByName('N9').Value := sCarNo;
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from IOSData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
        SQL.Add('ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nNowInUnitNo;
        Parameters.ParamByName('N3').Value := sNowInDate;
        Parameters.ParamByName('N4').Value := sNowInTime;
        Parameters.ParamByName('N5').Value := sNowInTKNo;
        Open;

        if RecordCount > 0 then
        begin
          // InData에 입차자료가 있으면...
          Close;
          SQL.Clear;
          SQL.Add(
            'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, '); //, OutChk = :N4
          SQL.Add(
            'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, '
            );
          SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10 '); //, Reserve1 = :N16
          SQL.Add(
            'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
          Parameters.ParamByName('N1').Value := nNowLprNo;
          Parameters.ParamByName('N2').Value := FormatDateTime('YYYY-MM-DD', Now);
          Parameters.ParamByName('N3').Value := FormatDateTime('HH:NN:SS', Now);

          // 무료시간출차...
          Parameters.ParamByName('N5').Value := sNowLprFile1;
          Parameters.ParamByName('N6').Value := sNowLprCarNo1;
          Parameters.ParamByName('N7').Value := sNowLprFile2;
          Parameters.ParamByName('N8').Value := sNowLprCarNo2;
          Parameters.ParamByName('N9').Value := nNowLprRecog1;
          Parameters.ParamByName('N10').Value := nNowLprRecog2;
          Parameters.ParamByName('N11').Value := nCurrParkNo;
          Parameters.ParamByName('N12').Value := nNowInUnitNo;
          Parameters.ParamByName('N13').Value := sNowInDate;
          Parameters.ParamByName('N14').Value := sNowInTime;
          Parameters.ParamByName('N15').Value := sNowInTKNo;

          ExecSQL;
        end
        else
        begin
          // InData에 발권자료가 없으면...
          Close;
          SQL.Clear;
          SQL.Add('Select ci.*, gg.GroupName from CustInfo as ci left join GGroup as gg on ci.GroupNo = gg.GroupNo');

          if sNowLprCarNo2 <> '' then
          begin
            SQL.Add('where ((ci.CarNo = :N1) or (ci.CarNo = :N2))  and ((ci.ExpDateF <= :N3) and ');
            SQL.Add('(ci.ExpDateT >= :N4)) and ci.TKType = 2 and ci.ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sNowLprCarNo1;
            Parameters.ParamByName('N2').Value := sNowLprCarNo2;
            Parameters.ParamByName('N3').Value := sNowInDate;
            Parameters.ParamByName('N4').Value := sNowInTime;
            Parameters.ParamByName('N5').Value := nCurrParkNo;
          end
          else
          if sNowLprCarNo1 <> '' then
          begin
            SQL.Add('where (ci.CarNo = :N1) and ((ci.ExpDateF <= :N3)  and (ci.ExpDateT >= :N4)) and ');
            SQL.Add('ci.TKType = 2 and ci.ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sNowLprCarNo1;
            Parameters.ParamByName('N3').Value := sNowInDate;
            Parameters.ParamByName('N4').Value := sNowInTime;
            Parameters.ParamByName('N5').Value := nCurrParkNo;
          end;
          Open;

          if RecordCount > 0 then begin
            nGroupNo := FieldByName('GroupNo').AsInteger;
            sGroupName := FieldByName('GroupName').AsString;
            sCompName := FieldByName('CompName').AsString;
            sDeptName := FieldByName('DeptName').AsString;
            sName := FieldByName('Name').AsString;

            Close;
            SQL.Clear;
            SQL.Add(
              'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
            SQL.Add(
              'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, InIOStatusNo, ');
            SQL.Add('InImage1, InRecog1, Reserve1, Reserve2) ');
            SQL.Add(
              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18)');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nNowInUnitNo;
            Parameters.ParamByName('N3').Value := sNowInDate;
            Parameters.ParamByName('N4').Value := sNowInTime;
            Parameters.ParamByName('N5').Value := sNowInTKNo;
            Parameters.ParamByName('N6').Value := 2;
            Parameters.ParamByName('N7').Value := 2;
            Parameters.ParamByName('N8').Value := nGroupNo;
            Parameters.ParamByName('N9').Value := sGroupName;
            Parameters.ParamByName('N10').Value := sCompName;
            Parameters.ParamByName('N11').Value := sDeptName;
            Parameters.ParamByName('N12').Value := sName;
            Parameters.ParamByName('N13').Value := sNowLprCarNo1;
            Parameters.ParamByName('N14').Value := 1;
            Parameters.ParamByName('N15').Value := sOrgFile;
            Parameters.ParamByName('N16').Value := 4;
            Parameters.ParamByName('N17').Value := FormatDateTime
              ('YYYY-MM-DD HH:NN:SS', Now);
            Parameters.ParamByName('N18').Value := IntToStr(nCurrMNo);
            ExecSQL;
          end else begin
            ExceptLogging('오류 : 정기차량 정보 찾을 수 없음.');
          end;
        end;
      end else begin
        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from IONData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
        SQL.Add('ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nNowInUnitNo;
        Parameters.ParamByName('N3').Value := sNowInDate;
        Parameters.ParamByName('N4').Value := sNowInTime;
        Parameters.ParamByName('N5').Value := sNowInTKNo;
        Open;

        if RecordCount > 0 then
        begin
          // InData에 입차자료가 있으면...
          Close;
          SQL.Clear;
          SQL.Add(
            'Update IONData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
          SQL.Add(
            'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, '
            );
          SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N16 ');
          SQL.Add(
            'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
          Parameters.ParamByName('N1').Value := nNowLprNo;
          Parameters.ParamByName('N2').Value := FormatDateTime('YYYY-MM-DD', Now);
          Parameters.ParamByName('N3').Value := FormatDateTime('HH:NN:SS', Now);

          // 무료시간출차...
          Parameters.ParamByName('N4').Value := 5;
          Parameters.ParamByName('N5').Value := sNowLprFile1;
          Parameters.ParamByName('N6').Value := sNowLprCarNo1;
          Parameters.ParamByName('N7').Value := sNowLprFile2;
          Parameters.ParamByName('N8').Value := sNowLprCarNo2;
          Parameters.ParamByName('N9').Value := nNowLprRecog1;
          Parameters.ParamByName('N10').Value := nNowLprRecog2;
          Parameters.ParamByName('N11').Value := nCurrParkNo;
          Parameters.ParamByName('N12').Value := nNowInUnitNo;
          Parameters.ParamByName('N13').Value := sNowInDate;
          Parameters.ParamByName('N14').Value := sNowInTime;
          Parameters.ParamByName('N15').Value := sNowInTKNo;

          if bMiProc then
            Parameters.ParamByName('N16').Value := '미인식처리'
          else if bManualOut then
            Parameters.ParamByName('N16').Value := '수동출차'
          else
            Parameters.ParamByName('N16').Value := '';
          ExecSQL;
        end
        else
        begin
          // InData에 발권자료가 없으면...
          Close;
          SQL.Clear;
          SQL.Add('Insert Into IONData ');
          SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, ');
          SQL.Add('InImage1, InCarNo1, InImage2, InCarNo2, Status, OutUnitNo, ');
          SQL.Add(
            'OutDate, OutTime, OutChk, OutImage1, OutCarNo1, OutImage2, OutCarNo2, ');
          SQL.Add('InRecog1, OutRecog1, InRecog2, OutRecog2, Reserve1) ');
          SQL.Add(
            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
          SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
          SQL.Add(':N21, :N22, :N23, :N24, :N25)');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nNowInUnitNo;
          Parameters.ParamByName('N3').Value := sNowInDate;
          Parameters.ParamByName('N4').Value := sNowInTime;
          Parameters.ParamByName('N5').Value := sNowInTKNo;
          Parameters.ParamByName('N6').Value := nTKType;
          Parameters.ParamByName('N7').Value := 1;
          Parameters.ParamByName('N8').Value := '';
          Parameters.ParamByName('N9').Value := '';
          Parameters.ParamByName('N10').Value := '';
          Parameters.ParamByName('N11').Value := '';
          Parameters.ParamByName('N12').Value := 1;
          Parameters.ParamByName('N13').Value := nNowLprNo;
          Parameters.ParamByName('N14').Value := FormatDateTime
            ('YYYY-MM-DD', Now);
          Parameters.ParamByName('N15').Value := FormatDateTime('HH:NN:SS', Now);

          // 무료시간출차...
          Parameters.ParamByName('N16').Value := 5;
          Parameters.ParamByName('N17').Value := sNowLprFile1;
          Parameters.ParamByName('N18').Value := sNowLprCarNo1;
          Parameters.ParamByName('N19').Value := sNowLprFile2;
          Parameters.ParamByName('N20').Value := sNowLprCarNo2;
          Parameters.ParamByName('N21').Value := 3;
          Parameters.ParamByName('N22').Value := 3;
          Parameters.ParamByName('N23').Value := nNowLprRecog1;
          Parameters.ParamByName('N24').Value := nNowLprRecog2;

          if bMiProc then
            Parameters.ParamByName('N25').Value := '미인식처리'
          else if bManualOut then
            Parameters.ParamByName('N25').Value := '수동출차'
          else
            Parameters.ParamByName('N25').Value := '';
          ExecSQL;
        end;
      end;
    end;

    if nUseFeeItem > 0 then begin
      NGridData('3' + sNowLprCarNo1 + '^' + FormatDateTime('YYYY-MM-DD', Now)
          + ' ' + FormatDateTime('HH:NN:SS', Now) + '^무료개방출차');
    end else begin
      NGridData('2' + sNowLprCarNo1 + '^' + FormatDateTime('YYYY-MM-DD', Now)
          + ' ' + FormatDateTime('HH:NN:SS', Now) + '^무료개방출차');
    end;
//    NGridData('2' + sNowInCarNo + '^' + FormatDateTime('YYYY-MM-DD', Now)
//        + ' ' + FormatDateTime('HH:NN:SS', Now) + '^무료개방출차');

    // 차단기 열림.
    OutOpen(csLPR);

    if bAutoReceipt and (sPrtData <> '') then
    begin
      btnReceiptClick(Self);
    end;
    InspectionLog('무료시간출차_정산요금: 0');
    ClearFormData;
  except
    on E: Exception do
      ExceptLogging('FreeTimeProc: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.MinwonProc(csLPR: TClientSocket);
var
  i, nOutCnt: Integer;
  sParkName, sParkAddr, sRegNo, sAdmin, sTelephone, sReceipt, sCarNo: String;
  sSend: String;
begin
  try
    nMCnt := nMCnt + 1;
    lbMCnt.Caption := FormatFloat('#,##0', nMCnt) + ' 건';
    // nMTot := nMTot + StrToInt(MG_StrTrim(edtProcYogum.Text, ','));
    // lbMTot.Caption := IntToStr(nMTot) + ' 원';
    nOutCnt := 0;
    ClearDCProc;

    // DB Write...
    with dmTables.qryMoneyProc do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from TKProc where ParkNo = :N1 and UnitNo = :N2 and ');
      SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := sNowOutDate;
      Parameters.ParamByName('N4').Value := sNowOutTime;
      Parameters.ParamByName('N5').Value := sNowInTKNo;
      Open;

      if RecordCount <= 0 then
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into TKProc ');
        SQL.Add
          ('(ParkNo, UnitNo, ProcDate, ProcTime, TKType, CarType, FeeNo, ');
        SQL.Add
          ('TKNo, TKParkNo, TKUnitNo, CarNo, InDate, InTime, ParkingMin, ');
        SQL.Add
          ('TotFee, TotDC, RealFee, RecvAmt, Change, DCCnt, MNo, UnPaid, ');
        SQL.Add(
          'ChkClosing, CommercialTariff, SpecialTariff, PayType, Reserve1) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, ');
        SQL.Add(':N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
        SQL.Add(':N21, :N22, :N23, :N24, :N25, :N26, :N27)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := sNowOutDate;
        Parameters.ParamByName('N4').Value := sNowOutTime;
        Parameters.ParamByName('N5').Value := nTKType;
        Parameters.ParamByName('N6').Value := 1;
        Parameters.ParamByName('N7').Value := nFeeNo;
        Parameters.ParamByName('N8').Value := sNowInTKNo;
        Parameters.ParamByName('N9').Value := nCurrParkNo;
        Parameters.ParamByName('N10').Value := nNowInUnitNo;
        Parameters.ParamByName('N11').Value := sNowInCarNo;
        Parameters.ParamByName('N12').Value := sNowInDate;
        Parameters.ParamByName('N13').Value := sNowInTime;
        Parameters.ParamByName('N14').Value := nParkingMin;
        Parameters.ParamByName('N15').Value := StrToInt
          (MG_StrTrim(edtTotYogum.Text, ','));
        Parameters.ParamByName('N16').Value := StrToInt
          (MG_StrTrim(edtTotYogum.Text, ','));
        Parameters.ParamByName('N17').Value := 0;
        Parameters.ParamByName('N18').Value := 0;
        Parameters.ParamByName('N19').Value := 0;
        Parameters.ParamByName('N20').Value := 1;
        Parameters.ParamByName('N21').Value := nCurrMNo;
        Parameters.ParamByName('N22').Value := 0;
        Parameters.ParamByName('N23').Value := 0;
        Parameters.ParamByName('N24').Value := 0;
        Parameters.ParamByName('N25').Value := 0;
        Parameters.ParamByName('N26').Value := 1;
        Parameters.ParamByName('N27').Value := '민원처리';
        ExecSQL;
      end;

      Close;
      SQL.Clear;
      SQL.Add(
        'Select * from IONData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
      SQL.Add('ProcTime = :N4 and TKNo = :N5');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := nNowInUnitNo;
      Parameters.ParamByName('N3').Value := sNowInDate;
      Parameters.ParamByName('N4').Value := sNowInTime;
      Parameters.ParamByName('N5').Value := sNowInTKNo;
      Open;

      if RecordCount > 0 then
      begin
        // InData에 입차자료가 있으면...
        Close;
        SQL.Clear;
        SQL.Add(
          'Update IONData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
        SQL.Add(
          'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, '
          );
        SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N16 ');
        SQL.Add(
          'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
        Parameters.ParamByName('N1').Value := nNowLprNo;
        Parameters.ParamByName('N2').Value := sNowOutDate;
        Parameters.ParamByName('N3').Value := sNowOutTime;

        // 민원출차...
        Parameters.ParamByName('N4').Value := 6;
        Parameters.ParamByName('N5').Value := sNowLprFile1;
        Parameters.ParamByName('N6').Value := sNowLprCarNo1;
        Parameters.ParamByName('N7').Value := sNowLprFile2;
        Parameters.ParamByName('N8').Value := sNowLprCarNo2;
        Parameters.ParamByName('N9').Value := nNowLprRecog1;
        Parameters.ParamByName('N10').Value := nNowLprRecog2;
        Parameters.ParamByName('N11').Value := nCurrParkNo;
        Parameters.ParamByName('N12').Value := nNowInUnitNo;
        Parameters.ParamByName('N13').Value := sNowInDate;
        Parameters.ParamByName('N14').Value := sNowInTime;
        Parameters.ParamByName('N15').Value := sNowInTKNo;

        if bMiProc then
          Parameters.ParamByName('N16').Value := '미인식처리'
        else if bManualOut then
          Parameters.ParamByName('N16').Value := '수동출차'
        else
          Parameters.ParamByName('N16').Value := '';
        ExecSQL;
      end
      else
      begin
        // InData에 발권자료가 없으면...
        Close;
        SQL.Clear;
        SQL.Add('Insert Into IONData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, ');
        SQL.Add('InImage1, InCarNo1, InImage2, InCarNo2, Status, OutUnitNo, ');
        SQL.Add(
          'OutDate, OutTime, OutChk, OutImage1, OutCarNo1, OutImage2, OutCarNo2, ');
        SQL.Add('InRecog1, OutRecog1, InRecog2, OutRecog2, Reserve1) ');
        SQL.Add(
          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
        SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
        SQL.Add(':N21, :N22, :N23, :N24, :N25)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nNowInUnitNo;
        Parameters.ParamByName('N3').Value := sNowInDate;
        Parameters.ParamByName('N4').Value := sNowInTime;
        Parameters.ParamByName('N5').Value := sNowInTKNo;
        Parameters.ParamByName('N6').Value := nTKType;
        Parameters.ParamByName('N7').Value := 1;
        Parameters.ParamByName('N8').Value := '';
        Parameters.ParamByName('N9').Value := '';
        Parameters.ParamByName('N10').Value := '';
        Parameters.ParamByName('N11').Value := '';
        Parameters.ParamByName('N12').Value := 1;
        Parameters.ParamByName('N13').Value := nNowLprNo;
        Parameters.ParamByName('N14').Value := sNowOutDate;
        Parameters.ParamByName('N15').Value := sNowOutTime;

        // 민원출차...
        Parameters.ParamByName('N16').Value := 6;
        Parameters.ParamByName('N17').Value := sNowLprFile1;
        Parameters.ParamByName('N18').Value := sNowLprCarNo1;
        Parameters.ParamByName('N19').Value := sNowLprFile2;
        Parameters.ParamByName('N20').Value := sNowLprCarNo2;
        Parameters.ParamByName('N21').Value := 3;
        Parameters.ParamByName('N22').Value := 3;
        Parameters.ParamByName('N23').Value := nNowLprRecog1;
        Parameters.ParamByName('N24').Value := nNowLprRecog2;

        if bMiProc then
          Parameters.ParamByName('N25').Value := '미인식처리'
        else if bManualOut then
          Parameters.ParamByName('N25').Value := '수동출차'
        else
          Parameters.ParamByName('N25').Value := '';
        ExecSQL;
      end;
    end;
    NGridData('2' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
        '^0원');

    // 차단기 열림.
    OutOpen(csLPR);

    if bAutoReceipt and (sPrtData <> '') then
    begin
      btnReceiptClick(Self);
    end;
    InspectionLog('민원출차_정산요금: 0');
    ClearFormData;
  except
    on E: Exception do
      ExceptLogging('MinwonProc: ' + aString(E.Message));
  end;
end;

// nCmd: 1-BarOpen
procedure TfrmMainNew.UnitCtrl(nCmd, nFCNo, nUnitNo, nMNo: Word;
  sData: AnsiString);
var
  sFCIp, sSend: aString;
  nFCPort: Word;
  nResponse: Smallint;
  i: Byte;
  bSend: Boolean;
begin
  try
    if nFCNo = nCurrUnitNo then
    begin
      // 현재 요금계산기에 연결된 LPR이면 LPR을 찾아서 명령 전송...
      bSend := False;

      case nCmd of
        1:
          begin
            for i := 1 to 5 do
            begin
              with frmMainNew do
              begin
                if TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Socket.SendText(sSend);
//                    inopen(TClientSocket(FindComponent('csInLpr' + IntToStr(i)))) ;
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;

            if not bSend then
              for i := 1 to 3 do
              begin
                with frmMainNew do
                begin
                  if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                  begin
                    if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                       TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                    begin
                      sSend := 'BAR_OPEN-1';
                      TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                      bSend := True;
                      Break;
                    end
                    else
                      ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                  end;
                end;
              end;

            if bSend then
            begin
              with dmTables.qryBarProc do
              begin
                Close;
                SQL.Clear;
                SQL.Add('Insert BarProc ');
                SQL.Add(
                  '(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
                Parameters.ParamByName('N1').Value := nCurrParkNo;
                Parameters.ParamByName('N2').Value := nUnitNo;
                Parameters.ParamByName('N3').Value := FormatDateTime
                  ('YYYY-MM-DD', Now);
                Parameters.ParamByName('N4').Value := FormatDateTime
                  ('HH:NN:SS', Now);
                Parameters.ParamByName('N5').Value := 1;
                Parameters.ParamByName('N6').Value := nMNo;
                Parameters.ParamByName('N7').Value := 0;

                if sData <> '' then
                  Parameters.ParamByName('N8').Value := sData
                else
                  Parameters.ParamByName('N8').Value := '수동오픈';
                ExecSQL;
              end;
            end;
          end;
      end;
    end
    else
    begin
      // 다른 요금계산기에 연결된 LPR이면 해당 요금계산기로 명령 전송...
      with qryCtrl do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from UnitInfo where UnitNo = :N1');
        Parameters.ParamByName('N1').Value := nFCNo;
        Open;

        if RecordCount > 0 then
        begin
          sFCIp := MG_StrTrim(FieldByName('IPNo').AsString, ' ');
          nFCPort := FieldByName('PortNo').AsInteger;

          if is_ping(sFCIp) then
          begin
            try
              idTC.Disconnect;
              idTC.Host := sFCIp;
              idTC.Port := nFCPort;
              idTC.Connect;

              if idTC.Connected then
              begin
                sSend := STX + MG_InsZero(IntToStr(nCmd), 2) + MG_InsZero
                  (IntToStr(nUnitNo), 5) + MG_InsZero(IntToStr(nMNo), 3)
                  + sData + ETX;
                idTC.IOHandler.WriteLnRFC(sSend, enDefault);
                idTC.Disconnect;
              end;
            except
              on E: Exception do
                ExceptLogging('TfrmMain.UnitCtrl: ' + aString(E.Message));
            end;
          end
          else
            ExceptLogging('UnitCtrl(' + IntToStr(nCmd) + ')시 네트워크 오류!');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.UnitCtrl: ' + aString(E.Message));
  end;
end;

function TfrmMainNew.unknownRevData(inData: string): Boolean;
begin
  if (Pos('CH',inData)>0) and (Pos('.jpg',inData)>0) then begin
    Result := True;
  end else begin
    Result := False;
  end;
end;

procedure TfrmMainNew.CancelDataProc;
begin
  with dmTables.qryCancelData do
  begin
    Close;
    SQL.Clear;
    SQL.Add('Insert Into CancelData ');
    SQL.Add(
      '(ParkNo, UnitNo, CanelDate, CancelTime, MNo, InDate, InTime, InImage1, InCarNo1, ');
    SQL.Add(
      'InImage2, InCarNo2, TKNo, OutImage1, OutCarNo1, OutImage2, OutCarNo2, ');
    SQL.Add('ParkingMin, ParkingAmt, DCAmt, CancelReason) ');
    SQL.Add(
      'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, '
      );
    SQL.Add(':N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20)');
    Parameters.ParamByName('N1').Value := nCurrParkNo;
    Parameters.ParamByName('N2').Value := nCurrUnitNo;
    Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
    Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
    Parameters.ParamByName('N5').Value := nCurrMNo;
    Parameters.ParamByName('N6').Value := sNowInDate;
    Parameters.ParamByName('N7').Value := sNowInTime;
    Parameters.ParamByName('N8').Value := sNowInFile;
    Parameters.ParamByName('N9').Value := sNowInCarNo;
    Parameters.ParamByName('N10').Value := '';
    Parameters.ParamByName('N11').Value := '';
    Parameters.ParamByName('N12').Value := sNowInTKNo;
    Parameters.ParamByName('N13').Value := sNowLprFile1;
    Parameters.ParamByName('N14').Value := sNowLprCarNo1;
    Parameters.ParamByName('N15').Value := sNowLprFile2;
    Parameters.ParamByName('N16').Value := sNowLprCarNo2;
    Parameters.ParamByName('N17').Value := nNowParkingMin;
    Parameters.ParamByName('N18').Value := StrToInt
      (MG_StrTrim(edtProcYogum.Text, ','));
    Parameters.ParamByName('N19').Value := StrToInt
      (MG_StrTrim(edtDCYogum.Text, ','));
    Parameters.ParamByName('N20').Value := sCancelReason;
    ExecSQL;
  end;
end;

procedure TfrmMainNew.CenterControl(AControl: TControl);
begin

  if Assigned( AControl.Parent )
  then
    begin
      // remove alignment
      AControl.Align := alNone;
      // remove the anchors
      AControl.Anchors := [];
      // center on parent
      AControl.Left := ( AControl.Parent.ClientWidth - AControl.Width ) div 2;
      AControl.Top := ( AControl.Parent.ClientHeight - AControl.Height ) div 2;
    end
  else
    //raise Exception.Create( 'Control needs a Parent!' );
    ExceptLogging('패널 중앙 위치 실패');

end;

procedure TfrmMainNew.ICMPReply(ASender: TComponent;
  const ReplyStatus: TReplyStatus);
begin
  case ReplyStatus.ReplyStatusType of
    rsTimeOut:
      ping_success := False;
    rsErrorUnreachable:
      ping_success := False;
    rsEcho:
      ping_success := True;
  end;
end;

procedure TfrmMainNew.idTSExecute(AContext: TIdContext);
var
  sRecv, sRemortIP, sSend, sData: aString;
  nCmd, nUnitNo, nMNo: Word;
  i: Byte;
  bSend: Boolean;
begin
  try
    sRecv := AContext.Connection.IOHandler.ReadString
      (AContext.Connection.IOHandler.InputBuffer.Size, enUTF8);

    if sRecv = '' then
      Exit;

    if Pos(STX, sRecv) > 0 then
      sCtrl := sRecv
    else
      sCtrl := sCtrl + sRecv;

    if (Pos(STX, sCtrl) <= 0) or (Pos(ETX, sCtrl) <= 0) then
      Exit;

    sRemortIP := AContext.Binding.PeerIP;
    ExceptLogging('CtrlRecv: ' + sCtrl + ':' + sRemortIP);
    nCmd := StrToInt(Copy(sRecv, 2, 2));
    nUnitNo := StrToInt(Copy(sRecv, 4, 5));
    nMNo := StrToInt(Copy(sRecv, 9, 3));

    if Pos(ETX, sCtrl) > 12 then
    begin
      // 데이터가 있으면...
      sData := Copy(sCtrl, 12, Pos(ETX, sCtrl) - 12);
    end
    else
      sData := '';

    bSend := False;

    case nCmd of
      1:
        begin
          for i := 1 to 5 do
          begin
            with frmMainNew do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                .Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_OPEN-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                    .Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging
                    (TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                      .Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
            for i := 1 to 3 do
            begin
              with frmMainNew do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add(
                '(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime
                ('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime
                ('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
    end;

    sCtrl := '';
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.idTSExecute: ' + aString(E.Message));
  end;
end;

function TfrmMainNew.is_Ping(ip: AnsiString): Boolean;
var
   Handle : THandle;
   DW : DWORD;
   REP : ICMPECHO;
   IPLong: LongInt;
begin
  Result:= False;
  StatusLogging('Ping 시간 체크1-' + IntToStr(GetTickCount));

  Handle := IcmpCreateFile;

  if Handle = INVALID_HANDLE_VALUE then Exit;

  IPLong := inet_addr(PAnsiChar( ip ));
  DW := IcmpSendEcho(Handle, IPLong, nil, 0, nil, @rep, Sizeof(Rep), nPingTimeOut );

  if rep.status = 0 then begin
    if IP = '' then begin
      Result := False;
    end else begin
      Result := True;
    end;
  end else
    Result:= False;

  StatusLogging('Ping 시간 체크2-' + IntToStr(GetTickCount));
  IcmpCloseHandle(Handle);
end;

{
function TfrmMainNew.is_ping(IP: AnsiString): Boolean;
begin
  Result := False;
  ExceptLogging('Ping 시간 체크1-' + IntToStr(GetTickCount));

  try
    with ICMP do
    begin
      OnReply := ICMPReply;
      ReceiveTimeOut := 5;
      //Host := wString(IP);
      Host := IP;
      Ping;
    end;
    Result := ping_success;
    ExceptLogging('Ping 시간 체크2-' + IntToStr(GetTickCount));
  except
    on E: Exception do
      ExceptLogging('TfrmMain.is_ping: ' + aString(E.Message));
  end;
end;
}

function TfrmMainNew.IntToBool(nNo: Integer): Boolean;
begin
  if nNo = 0 then
    Result := False
  else
    Result := True;
end;

// 절사처리
function TfrmMainNew.JulsaProc(nOrgAmt: Integer): Integer;
var
  nJulsaAmt: Integer;
begin
  try
    Result := 0;

    case nJulsaType of
      0:
        begin
          // 사용안함.
          nJulsaAmt := 0;
        end;

      1:
        begin
          // 1원단위
          case nRoundType of
            0:
              nJulsaAmt := nOrgAmt mod 10;
            1:
              begin
                nJulsaAmt := nOrgAmt mod 10;

                if nJulsaAmt > 0 then
                begin
                  nJulsaAmt := nJulsaAmt + (10 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end
                else
                  nJulsaAmt := 0;
              end;
            2:
              begin
                nJulsaAmt := nOrgAmt mod 10;

                if nJulsaAmt >= 5 then
                begin
                  nJulsaAmt := nJulsaAmt + (10 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end;
              end;
          end;
        end;

      2:
        begin
          // 10원단위
          case nRoundType of
            0:
              nJulsaAmt := nOrgAmt mod 100;
            1:
              begin
                nJulsaAmt := nOrgAmt mod 100;

                if nJulsaAmt > 0 then
                begin
//                  nJulsaAmt := nJulsaAmt + (100 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end
                else
                  nJulsaAmt := 0;
              end;
            2:
              begin
                nJulsaAmt := nOrgAmt mod 100;

                if nJulsaAmt >= 50 then
                begin
                  nJulsaAmt := nJulsaAmt + (100 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end;
              end;
          end;
        end;

      3:
        begin
          // 100원단위
          case nRoundType of
            0:
              nJulsaAmt := nOrgAmt mod 1000;
            1:
              begin
                nJulsaAmt := nOrgAmt mod 1000;

                if nJulsaAmt > 0 then
                begin
                  nJulsaAmt := nJulsaAmt + (1000 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end
                else
                  nJulsaAmt := 0;
              end;
            2:
              begin
                nJulsaAmt := nOrgAmt mod 1000;

                if nJulsaAmt >= 500 then
                begin
                  nJulsaAmt := nJulsaAmt + (1000 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end;
              end;
          end;
        end;

      4:
        begin
          // 500원단위
          case nRoundType of
            0:
              nJulsaAmt := nOrgAmt mod 500;
            1:
              begin
                nJulsaAmt := nOrgAmt mod 500;

                if nJulsaAmt > 0 then
                begin
                  nJulsaAmt := nJulsaAmt + (500 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end
                else
                  nJulsaAmt := 0;
              end;
            2:
              begin
                nJulsaAmt := nOrgAmt mod 500;

                if nJulsaAmt >= 250 then
                begin
                  nJulsaAmt := nJulsaAmt + (500 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end;
              end;
          end;
        end;

      5:
        begin
          // 1000원단위
          case nRoundType of
            0:
              nJulsaAmt := nOrgAmt mod 10000;
            1:
              begin
                nJulsaAmt := nOrgAmt mod 10000;

                if nJulsaAmt > 0 then
                begin
                  nJulsaAmt := nJulsaAmt + (10000 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end
                else
                  nJulsaAmt := 0;
              end;
            2:
              begin
                nJulsaAmt := nOrgAmt mod 10000;

                if nJulsaAmt >= 5000 then
                begin
                  nJulsaAmt := nJulsaAmt + (10000 - nJulsaAmt);
                  nJulsaAmt := nJulsaAmt * -1;
                end;
              end;
          end;
        end;
    end;
    Result := nJulsaAmt;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.JulsaProc: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.lbReceiptDblClick(Sender: TObject);
var
  i, nSel: Integer;
  sSend: aString;
begin
  nSel := 0;

  for i := 0 to (lbReceipt.Items.Count - 1) do
  begin
    if lbReceipt.Selected[i] then
      nSel := i + 1;
  end;
  sSend := RReceipt[nSel].sRpt;

  if ComPrn.Open and (sSend <> '') then
  begin
    ComPrn.PutString(sSend);
    sSend := '';
  end;
  mnuDetailClick(Self);
end;

procedure TfrmMainNew.dcBtnClick(dcBtn: TAdvShapeButton; dcMnu: TMenuItem);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa,nValue,nValue1: Integer;
  sName, sYogum , sReserveDiscount: aString;
  nDCFeeno, nDCType : Integer;
  i: Byte;
begin
  try
    nValue := 0;
    nValue1 := 0;
    overUseTime := 0;
    with dmTables.qryDCTemp do begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= dcBtn.Tag - 100;
      Open;

      if RecordCount > 0 then begin
        nValue:= FieldByName('DCValue').AsInteger;
        nValue1:= FieldByName('DCValue1').AsInteger;
        sReserveDiscount := FieldByName('Reserve3').AsString;
        nDCFeeno           := FieldByName('FeeNo').AsInteger;
        //추가사항 할인명 확인
        nDCType:= FieldByName('DCType').AsInteger;
        sName:= FieldByName('DCName').AsString;

        if FieldByName('OcsCode').AsString = 'NA' then begin
          bNationalUse := True;
        end else if FieldByName('OcsCode').AsString = 'HD' then begin
          bHandicapUse := True;
        end;

        //11.29 OCS CODE 할인 수동으로 적용 시 최대 요금으로 계산해서 부과
        if (FieldByName('OcsCode').AsString ='01') or (FieldByName('OcsCode').AsString ='02') or
           (FieldByName('OcsCode').AsString ='03') or (FieldByName('OcsCode').AsString ='04') then
        begin
           nProcYogum := nTotYogum;
           bIsPatientUse := 1;
        end
        else
        begin
           bIsPatientUse := 0;
        end;

        if nDCType = 1 then
        begin
          Close;
          SQL.Clear;
          SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
          Open;
          if RecordCount > 0 then begin
            nowUseTime := Fields[0].AsInteger;
            ExceptLogging('[현재주차시간(분)] '+IntToStr(nowUseTime));
            if nowUseTime > nValue then
            begin
               overUseTime := nowUseTime - nValue; //남은 추차시간 = 총  주차시간 -  할인 시간
               ExceptLogging('[남은 주차시간(분)] '+IntToStr(overUseTime));
            end
            else
            begin
               //남은 추차시간 = 할인 시간 - 총  주차시간
               ExceptLogging('[남은 주차시간(분)2] '+IntToStr(nValue - nowUseTime));
            end;
          end;
        end;
      end;
    end;
    InspectionLog('할인코드 및 할인명 : ' + IntToStr(dcBtn.Tag - 100) + ', ' + IntToStr(nValue1) + ', ' +IntToStr(nDCType)+ ', ' +sName );
    sReserveDiscount :='9';
    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;
    if sReserveDiscount = '1' then
    begin
      if bFreeOneDiscount then
      begin
        InspectionLog('무료권할인제한횟수초과: ' + dcBtn.Text );
        ShowMessage('무료권 할인제한횟수를 초과하였습니다');
        Exit;
      end
      else
      begin
        if nProcYogum > 0 then
        begin
          sName := dcBtn.Text;
          if (nDCCntMax <> 0 ) and (nDCCntMax = nDCCnt) then
          begin
            lbDCName.Caption := '최대할인초과';
            ExceptLogging('최대할인초과');
            Exit;
          end;
          //Case dcBtn.GroupIndex of
          Case nDCType of
            0:
              begin // 금액할인.
                nDCCnt := nDCCnt + 1;

                if nProcYogum >= StrToInt(dcBtn.Hint) then
                begin
                  nProcYogum := nProcYogum - StrToInt(dcBtn.Hint);
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  nDCYogum := nDCYogum + StrToInt(dcBtn.Hint);
                  nDCYogum := nDCYogum + nJulsa;

                  //edtProcYogum.Text := IntToStr(nProcYogum);
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  //edtProcYogum.AutoThousandSeparator := True;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do
                  begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := StrToInt(dcBtn.Hint) + nJulsa;
                    nRealDCAmt := StrToInt(dcBtn.Hint) + nJulsa;
                    nRealDCMin := 0;
                    nDCType := 0;
                    nTypeCode := dcBtn.HelpContext;   //할인종류 구분 : 0 기본할인 1: 충전할인 2: 후불할인
                    nDCKind :=  1;                    // 버튼/웹 구분 : 1 : 버튼 할인, 2 웹할인
                  end;
                end
                else
                begin
                  nDCYogum := nDCYogum + nProcYogum;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := StrToInt(dcBtn.Hint);
                    nRealDCAmt := nProcYogum;
                    nRealDCMin := 0;
                    nDCType := 0;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;

            1:
              begin // 시간할인.
                nDCCnt := nDCCnt + 1;
                //sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(dcBtn.Hint), 0, 0);
                sDCOutTime := MG_AddTime(lbOutTime.Caption, 0, -StrToInt(dcBtn.Hint), 0, 0);
                sDCInTime  := MG_AddTime(sDCInTime, 0, StrToInt(dcBtn.Hint), 0, 0);
                if sDCOutTime < lbintime.Caption then
                begin
                  nTimeDC := nProcYogum;

                  DCProc[nDCCnt].nRealDCMin := StrToInt(dcBtn.Hint) + Trunc
                    ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                        - StrToDateTime(lbInTime.Caption)) * 24 * 60);
                end
                else
                begin
                  nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                    PAnsiChar(Copy(sDCOutTime, 1, 16)));
                  DCProc[nDCCnt].nRealDCMin := StrToInt(dcBtn.Hint);
//                  nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                    PAnsiChar(Copy(sDCOutTime, 1, 16)));
                end;

                if nProcYogum >= nTimeDC then
                begin
                  nProcYogum := nProcYogum - nTimeDC;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  nDCYogum := nDCYogum + nTimeDC;
                  nDCYogum := nDCYogum + nJulsa;
                  //edtProcYogum.Text := IntToStr(nProcYogum);
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  //edtProcYogum.AutoThousandSeparator := True;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do
                  begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                        (sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nTimeDC + nJulsa;
                    nRealDCAmt := nTimeDC + nJulsa;
                    nDCType := 1;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                end
                else
                begin
                  nDCYogum := nDCYogum + nTimeDC;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nTimeDC;
                    nRealDCAmt := nProcYogum;
                    nDCType := 1;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;

            2:
              begin // 퍼센트할인.
                nDCCnt := nDCCnt + 1;
                nPerDC := (nProcYogum * StrToInt(dcBtn.Hint)) div 100;

                if nProcYogum >= nPerDC then
                begin
                  nProcYogum := nProcYogum - nPerDC;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  nDCYogum := nDCYogum + nPerDC;
                  nDCYogum := nDCYogum + nJulsa;
                  //edtProcYogum.Text := IntToStr(nProcYogum);
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  //edtProcYogum.AutoThousandSeparator := True;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do
                  begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                        (sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nPerDC + nJulsa;
                    nRealDCAmt := nPerDC + nJulsa;
                    nDCType := 2;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                end
                else
                begin
                  nDCYogum := nDCYogum + nPerDC;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nPerDC;
                    nRealDCAmt := nProcYogum;
                    nDCType := 2;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;
            3:
              begin // 복합할인 = 시간할인 + % 할인
                nDCCnt := nDCCnt + 1;
                sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(dcBtn.Hint), 0, 0);
                if sDCOutTime < lbintime.Caption then
                begin
                  nTimeDC := 0;
                end
                else
                begin
//                  nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                    PAnsiChar(Copy(sDCOutTime, 1, 16)));
                  nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                    PAnsiChar(Copy(sDCOutTime, 1, 16)));
                end;
                nTimeDC := nTimeDC  * nValue1 div 100;

                if nProcYogum >= nTimeDC then
                begin
                  nDCYogum := nDCYogum +(nProcYogum- nTimeDC);
                  nDCYogum := nDCYogum + nJulsa;
                  nProcYogum := nTimeDC;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  //edtProcYogum.Text := IntToStr(nProcYogum);
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  //edtProcYogum.AutoThousandSeparator := True;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);
    //              nProcYogum := nProcYogum - nTimeDC;
    //              nJulsa := JulsaProc(nProcYogum);
    //              nProcYogum := nProcYogum - nJulsa;
    //              nDCYogum := nDCYogum + nTimeDC;
    //              nDCYogum := nDCYogum + nJulsa;
    //              //edtProcYogum.Text := IntToStr(nProcYogum);
    //              edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
    //              //edtProcYogum.AutoThousandSeparator := True;
    //              edtDCYogum.Text := IntToStr(nDCYogum);
    //              edtDCYogum.AutoThousandSeparator := True;
    //              sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do
                  begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                        (sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nTimeDC + nJulsa;
                    nRealDCAmt := nTimeDC + nJulsa;
                    nDCType := 3;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                end
                else
                begin
                  nDCYogum := nDCYogum + 0;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nTimeDC;
                    nRealDCAmt := nProcYogum;
                    nDCType := 3;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;
            4:
              begin // 고객부담. (시간할인 부분 고정금액)
                nDCCnt := nDCCnt + 1;
                sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(dcBtn.Hint), 0, 0);
                sDCInTime  := MG_AddTime(sDCInTime, 0, StrToInt(dcBtn.Hint), 0, 0);
                nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                      PAnsiChar(Copy(sDCInTime, 1, 16)));
//                nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                      PAnsiChar(Copy(sDCInTime, 1, 16)));
    //            nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
    //                                              PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
                if nProcYogum >= nTimeDC then
                begin

                  nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
                  nProcYogum := nProcYogum - nTimeDC + nValue1;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
    //              nDCYogum := nDCYogum + nTimeDC - nValue1 - 1000;
                  nDCYogum := nDCYogum + nJulsa;
                  //edtProcYogum.Text := IntToStr(nProcYogum);
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  //edtProcYogum.AutoThousandSeparator := True;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do
                  begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                        (sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    nDCAmt := nTimeDC -nValue1  + nJulsa;
                    nRealDCAmt := nDCYogum + nJulsa;
                    nDCType := 4;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                end
                else
                begin
                  if nValue1 > nProcYogum  then
                  begin
                    nDCYogum := nDCYogum;
                    nProcYogum := nProcYogum;
                  end
                  else
                  begin
                    nDCYogum := nDCYogum + nProcYogum - nValue1;
                    nProcYogum := nValue1;
                  end;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
    //              nProcYogum := nValue1;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);
                  lbDCName.Caption := sName;

                  for i := 1 to 6 do
                  begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do
                  begin
                    with frmMainNew do
                    begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i)))
                        .Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                        (sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;

                  with DCProc[nDCCnt] do
                  begin
                    nDCNo := dcBtn.Tag - 100;
                    sDCName := sName;
                    if nValue1 > nTimeDC then
                    begin
                      nDCAmt := 0;
                    end
                    else
                    begin
                      nDCAmt := nTimeDC -nValue1 ;
                    end;
                    nRealDCAmt := nDCYogum;
                    nDCType := 4;
                    nTypeCode := dcBtn.HelpContext;
                    nDCKind :=  1;
                  end;
                end;
              end;
          end;
          InspectionLog('할인요금: ' + edtDCYogum.Text);

          // 할인키별 적용가능횟수 처리...
          for i := 1 to 50 do
          begin
            if RDCCnt[i].nDCNo = dcBtn.Tag then
            begin
              RDCCnt[i].nDCNowCnt := RDCCnt[i].nDCNowCnt + 1;

              if (RDCCnt[i].nDCUseCnt <> 0) and
                (RDCCnt[i].nDCUseCnt = RDCCnt[i].nDCNowCnt) then
              begin
                dcBtn.Enabled := False;
                dcMnu.Enabled := False;
              end;
            end;
          end;

          if edtDC.Text = '' then
          begin
            edtDC.Text := sName;
          end
          else
          begin
            edtDC.Text := edtDC.Text + ', ' + sName;
          end;
          bFreeOneDiscount := True;
        end;
      end;
    end
    else
    begin
      if nProcYogum > 0 then
      begin
        sName := dcBtn.Text;
        if (nDCCntMax <> 0 ) and (nDCCntMax = nDCCnt) then
        begin
          lbDCName.Caption := '최대할인초과';
          ExceptLogging('최대할인초과');
          Exit;
        end;
        //Case dcBtn.GroupIndex of
        Case nDCType of
          0:
            begin // 금액할인.
              nDCCnt := nDCCnt + 1;

              if nProcYogum >= StrToInt(dcBtn.Hint) then
              begin
                nProcYogum := nProcYogum - StrToInt(dcBtn.Hint);
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + StrToInt(dcBtn.Hint);
                nDCYogum := nDCYogum + nJulsa;

                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := StrToInt(dcBtn.Hint) + nJulsa;
                  nRealDCAmt := StrToInt(dcBtn.Hint) + nJulsa;
                  nDCType := 0;
                  nTypeCode := dcBtn.HelpContext;   //할인종류 구분 : 0 기본할인 1: 충전할인 2: 후불할인
                  nDCKind :=  1;                    // 버튼/웹 구분 : 1 : 버튼 할인, 2 웹할인
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nProcYogum;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := StrToInt(dcBtn.Hint);
                  nRealDCAmt := nProcYogum;
                  nDCType := 0;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          1:
            begin // 시간할인.
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(lbOutTime.Caption, 0, -StrToInt(dcBtn.Hint), 0, 0);
              //sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(dcBtn.Hint), 0, 0);
              sDCInTime  := MG_AddTime(sDCInTime, 0, StrToInt(dcBtn.Hint), 0, 0);

              if sDCOutTime < lbintime.Caption then
              begin
                nTimeDC := nProcYogum;

                DCProc[nDCCnt].nRealDCMin := StrToInt(dcBtn.Hint) + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
              end
              else
              begin
                if overUseTime > 0 then
                begin
                  nTimeDC := DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                 PAnsiChar(Copy(sDCOutTime, 1, 16)),3);
                end
                else
                begin
                  nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                              PAnsiChar(Copy(sDCOutTime, 1, 16)),3);

                end;
                DCProc[nDCCnt].nRealDCMin := StrToInt(dcBtn.Hint);
//                  nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                    PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;

  //            nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
  //                                  PAnsiChar(Copy(sDCInTime, 1, 16)));
  //            nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
  //                                              PAnsiChar(Copy(sDCOutTime, 1, 16)));

              //nTimeDC := ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(sDCOutTime, 1, 16)),
              //  PAnsiChar(sNowOutDate + ' ' + Copy(sNowOutTime, 1, 5)));
              ExceptLogging('자동버튼할인 계산일: ~'+sDCOutTime);
              nTimeDC := Abs(nTimeDC);
              if nProcYogum >= nTimeDC then
              begin
                //nProcYogum := nProcYogum - nTimeDC;
                if overUseTime = 0 then //할인 시간이 초과 되지 않는 경우
                begin
                    nProcYogum := nProcYogum - nTimeDC;
                    nDCYogum := nDCYogum + nTimeDC;     //할인 금액
                end
                else   //할인 시간이 초과
                begin
                    nProcYogum := nTimeDC;
                    nDCYogum := nTotYogum - nTimeDC; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
                end;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                //nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  if overUseTime > 0 then
                  begin
                    nDCAmt := nTotYogum;
                    nRealDCAmt := nTotYogum - nTimeDC;
                  end
                  else
                  begin
                    nDCAmt := nTimeDC + nJulsa;
                    nRealDCAmt := nTimeDC + nJulsa;
                  end;
                  //nDCAmt := nTimeDC + nJulsa;
                  //nRealDCAmt := nTimeDC + nJulsa;
                  nDCType := 1;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCType := 1;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          2:
            begin // 퍼센트할인.
              nDCCnt := nDCCnt + 1;
              nPerDC := (nProcYogum * StrToInt(dcBtn.Hint)) div 100;

              if nProcYogum >= nPerDC then
              begin
                nProcYogum := nProcYogum - nPerDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nPerDC;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := nPerDC + nJulsa;
                  nRealDCAmt := nPerDC + nJulsa;
                  nDCType := 2;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nPerDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := nPerDC;
                  nRealDCAmt := nProcYogum;
                  nDCType := 2;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;
          3:
            begin // 복합할인 = 시간할인 + % 할인
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(dcBtn.Hint), 0, 0);
              if sDCOutTime < lbintime.Caption then
              begin
                nTimeDC := 0;
              end
              else
              begin
                nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
//                nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;
              nTimeDC := nTimeDC  * nValue1 div 100;

              if nProcYogum >= nTimeDC then
              begin
                nDCYogum := nDCYogum +(nProcYogum- nTimeDC);
                nDCYogum := nDCYogum + nJulsa;
                nProcYogum := nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);
  //              nProcYogum := nProcYogum - nTimeDC;
  //              nJulsa := JulsaProc(nProcYogum);
  //              nProcYogum := nProcYogum - nJulsa;
  //              nDCYogum := nDCYogum + nTimeDC;
  //              nDCYogum := nDCYogum + nJulsa;
  //              //edtProcYogum.Text := IntToStr(nProcYogum);
  //              edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
  //              //edtProcYogum.AutoThousandSeparator := True;
  //              edtDCYogum.Text := IntToStr(nDCYogum);
  //              edtDCYogum.AutoThousandSeparator := True;
  //              sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCType := 3;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + 0;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCType := 3;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;
          4:
            begin // 고객부담. (시간할인 부분 고정금액)
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(dcBtn.Hint), 0, 0);
              sDCInTime  := MG_AddTime(sDCInTime, 0, StrToInt(dcBtn.Hint), 0, 0);
              nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
  //            nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
  //                                              PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              if nProcYogum >= nTimeDC then
              begin

                nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
                nProcYogum := nProcYogum - nTimeDC + nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
  //              nDCYogum := nDCYogum + nTimeDC - nValue1 - 1000;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  nDCAmt := nTimeDC -nValue1  + nJulsa;
                  nRealDCAmt := nDCYogum + nJulsa;
                  nDCType := 4;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
              end
              else
              begin
                if nValue1 > nProcYogum  then
                begin
                  nDCYogum := nDCYogum;
                  nProcYogum := nProcYogum;
                end
                else
                begin
                  nDCYogum := nDCYogum + nProcYogum - nValue1;
                  nProcYogum := nValue1;
                end;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
  //              nProcYogum := nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);
                lbDCName.Caption := sName;

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := dcBtn.Tag - 100;
                  sDCName := sName;
                  if nValue1 > nTimeDC then
                  begin
                    nDCAmt := 0;
                  end
                  else
                  begin
                    nDCAmt := nTimeDC -nValue1 ;
                  end;
                  nRealDCAmt := nDCYogum;
                  nDCType := 4;
                  nTypeCode := dcBtn.HelpContext;
                  nDCKind :=  1;
                end;
              end;
            end;
        end;
        InspectionLog('할인요금: ' + edtDCYogum.Text);

        // 할인키별 적용가능횟수 처리...
        for i := 1 to 50 do
        begin
          if RDCCnt[i].nDCNo = dcBtn.Tag then
          begin
            RDCCnt[i].nDCNowCnt := RDCCnt[i].nDCNowCnt + 1;

            if (RDCCnt[i].nDCUseCnt <> 0) and
              (RDCCnt[i].nDCUseCnt = RDCCnt[i].nDCNowCnt) then
            begin
              dcBtn.Enabled := False;
              dcMnu.Enabled := False;
            end;
          end;
        end;

        if edtDC.Text = '' then
        begin
          edtDC.Text := sName;
        end
        else
        begin
          edtDC.Text := edtDC.Text + ', ' + sName;
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('dcBtnClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnBar10Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar10.ImageIndex, btnBar10.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar11Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar11.ImageIndex, btnBar11.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar12Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar12.ImageIndex, btnBar12.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar13Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar13.ImageIndex, btnBar13.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar14Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar14.ImageIndex, btnBar14.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar15Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar15.ImageIndex, btnBar15.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar16Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar16.ImageIndex, btnBar16.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar17Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar17.ImageIndex, btnBar17.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar18Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar18.ImageIndex, btnBar18.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar1Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar1.ImageIndex, btnBar1.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar2Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar2.ImageIndex, btnBar2.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar3Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar3.ImageIndex, btnBar3.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar4Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar4.ImageIndex, btnBar4.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar5Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar5.ImageIndex, btnBar5.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar6Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar6.ImageIndex, btnBar6.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar7Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar7.ImageIndex, btnBar7.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar8Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar8.ImageIndex, btnBar8.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBar9Click(Sender: TObject);
var
  sReason: aString;
begin
  if bManualOpen then
    sReason := InputBox('수동오픈사유', '차단기수동오픈사유를 입력하여주세요!', '')
  else
    sReason := '';

  UnitCtrl(1, btnBar9.ImageIndex, btnBar9.Tag, nCurrMNo, sReason);
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnBarClick(Sender: TObject);
begin
  try
    pnBar.Visible := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnBarClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnBarCloseClick(Sender: TObject);
begin
  pnBar.Visible := False;
end;

procedure TfrmMainNew.btnCarSearchClick(Sender: TObject);
begin
  try
    dmTables.qryUnitInfo.Open;
    imgLost.Picture.Assign(Nil);
    edtLostCarNo.Text := '';
    pnLost.Visible := True;
    edtLostCarNo.SetFocus;
    edtLostCarNo.SelectAll;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnLostClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnClosingClick(Sender: TObject);
begin
  bClosing := False;
  NextModalDialog(TfrmClosing.Create(Self));

  if bClosing then
  begin
    with qryMainTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Insert Into ProcData ');
      SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
      SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
      Parameters.ParamByName('N5').Value := nCurrMNo;
      Parameters.ParamByName('N6').Value := '로그아웃' ;
      ExecSQL;
    end;
    nLoginResult := 0;
    NextModalDialog(TfrmLogin.Create(Self));

    if nLoginResult <> 1 then
    begin
      ShowMessage('근무자확인에 실패하여 프로그램을 종료합니다.');
      Close;
      Exit;
    end
    else
    begin
      ExceptLogging('근무시작: ' + sCurrMName);
      edtMName.Text := '근무자 - ' + sCurrMName;

      bAutoCalc := IntToBool(iSetup.ReadInteger('PARKING', '자동요금계산', 1));
      bZeroOpen := IntToBool(iSetup.ReadInteger('PARKING', '0원자동오픈', 1));
      bClosingText := IntToBool(iSetup.ReadInteger('PARKING', '마감내용파일저장', 0));
      bClosingReprint := IntToBool(iSetup.ReadInteger('PARKING', '마감재출력', 0));
      bReceiptReprint := IntToBool(iSetup.ReadInteger('PARKING', '영수증재출력', 0));
      bCarSearch := IntToBool(iSetup.ReadInteger('PARKING', '차량검색', 1));
      bManualIn := IntToBool(iSetup.ReadInteger('PARKING', '수동입차', 0));
      nFCProcType := iSetup.ReadInteger('PARKING', '정산방식', 0);
      bCancel := IntToBool(iSetup.ReadInteger('PARKING', '정산취소', 1));
      bCancelReason := IntToBool(iSetup.ReadInteger('PARKING', '정산취소사유입력', 0));
      bCancelCheck := IntToBool(iSetup.ReadInteger('PARKING', '정산취소확인', 0));
      bCancelSave := IntToBool(iSetup.ReadInteger('PARKING', '정산취소로그저장', 0));
      bManualOpen := IntToBool(iSetup.ReadInteger('PARKING', '수동개방사유입력', 0));
      bCredit := IntToBool(iSetup.ReadInteger('PARKING', '신용카드결재', 0));
      bCashReceipt := IntToBool(iSetup.ReadInteger('PARKING', '현금영수증발행', 0));
      bBarcodeDC := IntToBool(iSetup.ReadInteger('PARKING', '바코드할인권사용', 0));
      bInterimClosing := IntToBool(iSetup.ReadInteger('PARKING', '중간마감', 0));
      bInterimPrint := IntToBool(iSetup.ReadInteger('PARKING', '중간마감출력', 0));

      if not bCredit then
      begin
        Label8.Top := 413;
        lbMCnt.Top := 413;
        lbMTot.Top := 413;
        Label9.Top := 464;
        lbMCreditCnt.Top := 464;
        lbMCreditTot.Top := 464;
        Label9.Visible := False;
        lbMCreditCnt.Visible := False;
        lbMCreditTot.Visible := False;
      end
      else
      begin
        Label8.Caption:= '현    금:'
      end;

      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from ParkInfo where ParkNo = :N1 Order By ParkNo');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Open;

        if RecordCount > 0 then
        begin
          nItemMax0 := FieldByName('DayMax').AsInteger;
          nTotMax0 := FieldByName('TotMax').AsInteger;
          nDCCntMax := FieldByName('DCCntMax').AsInteger;
          bZeroReceipt := IntToBool(FieldByName('ReceiptZero').AsInteger);
          bAutoReceipt := IntToBool(FieldByName('ReceiptAuto').AsInteger);
          nJulsaType := FieldByName('JunkType').AsInteger;
          nRoundType := FieldByName('RoundType').AsInteger;
          bTax := not IntToBool(FieldByName('TaxType').AsInteger);
          nTimeDCType := FieldByName('TimeDCType').AsInteger;
          bDCReason := IntToBool(FieldByName('DCReason').AsInteger);
          nLossTicket := FieldByName('LostCalc').AsInteger;
          nLossTicketAmt := FieldByName('LostAmount').AsInteger;

          if FieldByName('Reserve1').AsString <> '정상운영' then
            bOperation := False;

          if FieldByName('Reserve2').AsString = '테스트' then
            bTest := True;

          if FieldByName('Reserve5').AsString = '1' then
          begin
            bFreeTime := True;
            sFreeTimeS := FieldByName('Reserve3').AsString;
            sFreeTimeE := FieldByName('Reserve4').AsString;

            if sFreeTimeS > sFreeTimeE then
              bFreeTimeChk := True;
          end;
        end
        else
          ExceptLogging('설치된 주차장이 없음!');
      end;

      with dmTables.qryTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '로그인';
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add('Select Sum(RealFee), Count(*) from TKProc where ProcDate = :N1 and ');
        SQL.Add('MNo = :N2 and ChkClosing = :N3 and PayType = :N4 and UnitNo = :N5 ');
        Parameters.ParamByName('N1').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N2').Value := nCurrMNo;
        Parameters.ParamByName('N3').Value := 0;
        Parameters.ParamByName('N4').Value := 1;
        Parameters.ParamByName('N5').Value:= nCurrUnitNo;
        Open;

        if RecordCount > 0 then
        begin
          nMTot := FieldByName('COLUMN1').AsInteger;
          nMCnt := FieldByName('COLUMN2').AsInteger;
          lbMTot.Caption := FormatFloat('#,##0', nMTot) + ' 원';
          lbMCnt.Caption := FormatFloat('#,##0', nMCnt) + ' 건';
        end
        else
        begin
          lbMTot.Caption := '0 원';
          lbMCnt.Caption := '0 건';
        end;

        Close;
        SQL.Clear;
        SQL.Add('Select Sum(RealFee), Count(*) from TKProc where ProcDate = :N1 and ');
        SQL.Add('MNo = :N2 and ChkClosing = :N3 and PayType = :N4 and UnitNo = :N5 ');
        Parameters.ParamByName('N1').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N2').Value := nCurrMNo;
        Parameters.ParamByName('N3').Value := 0;
        Parameters.ParamByName('N4').Value := 2;
        Parameters.ParamByName('N5').Value:= nCurrUnitNo;
        Open;

        if RecordCount > 0 then
        begin
          nMCreditTot := FieldByName('COLUMN1').AsInteger;
          nMCreditCnt := FieldByName('COLUMN2').AsInteger;
          lbMCreditTot.Caption := FormatFloat('#,##0', nMCreditTot) + ' 원';
          lbMCreditCnt.Caption := FormatFloat('#,##0', nMCreditCnt) + ' 건';
        end
        else
        begin
          lbMCreditTot.Caption := '0 원';
          lbMCreditCnt.Caption := '0 건';
        end;
      end;

      sGeunmuStart := iSetup.ReadString('PARKING', IntToStr(nCurrMNo) + '_근무시작', '');
      sGeunmuMagam := iSetup.ReadString('PARKING', IntToStr(nCurrMNo) + '_마감', '');

      if sGeunmuStart = '' then
      begin
        sGeunmuStart := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
        iSetup.WriteString('PARKING', IntToStr(nCurrMNo) + '_근무시작', sGeunmuStart);
      end
      else
      begin
        if sGeunmuStart < sGeunmuMagam then
        begin
          sGeunmuStart := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
          iSetup.WriteString('PARKING', IntToStr(nCurrMNo) + '_근무시작', sGeunmuStart);
        end;
      end;
    end;
  end;
end;

procedure TfrmMainNew.btnManualCancelClick(Sender: TObject);
begin
  edtManualCarNo.Text := '';
  pnManual.Visible := False;
end;

procedure TfrmMainNew.btnManualInClick(Sender: TObject);
begin
  pnManual.Visible := True;
  edtManualCarNo.Text := '';
  edtManualCarNo.SetFocus;
  edtManualCarNo.SelectAll;
end;

procedure TfrmMainNew.btnManualOutClick(Sender: TObject);
begin
  nmanualUse := 1;
  lbDCName.Caption := '';
  pnManualOut.Visible := True;
  edtManualOutCarNo.Text :='';
  edtOutDate.Date := Now;
  edtOutTime.Text := '';
  edtOutTime.SetFocus;
  edtOutTime.SelectAll;
end;

procedure TfrmMainNew.btnSCClick(Sender: TObject);
begin
  try
    if edtSCCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtSCCarNo.SetFocus;
      Exit;
    end;

    with dmTables.qrySCSearch do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where ParkNo = :N1 and CarNo like ' + MG_MakeStr
          ('%' + Trim(edtSCCarNo.Text) + '%'));
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Open;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnSCClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnSCOutClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = nowLpr.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
    sResult := RecvLprProc(sOutLprFile, sOutLprCarNo, '', '', sTime,
      nowLpr.Tag, 2, 3, 3, sDspIP, nowLpr, True);
    GridData(sResult);
    ClearFormData;
    btnSCOut.Enabled := False;
    dmTables.qrySCSearch.Close;
    pnSCSearch.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnSCOutClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnSCSearchClick(Sender: TObject);
begin
  sManualSCCarNo := '';
  edtSCCarNo.Text := '';
  btnSCOut.Enabled := False;
  pnSCSearch.Visible := True;
  edtSCCarNo.SetFocus;
  edtSCCarNo.SelectAll;
end;

procedure TfrmMainNew.btn10Click(Sender: TObject);
begin
   try
      btnClick(btn10, mnuDC10);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
   except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
   end;
end;

procedure TfrmMainNew.btn11Click(Sender: TObject);
begin
   try
      btnClick(btn11, mnuDC11);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
   except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
   end;
end;

procedure TfrmMainNew.btn12Click(Sender: TObject);
begin
  try
      btnClick(btn12, mnuDC12);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn13Click(Sender: TObject);
begin
   try
      btnClick(btn13, mnuDC13);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
   except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
   end;
end;

procedure TfrmMainNew.btn14Click(Sender: TObject);
begin
  //btnClick(btn14, mnuDC14);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

   try
      btnClick(btn14, mnuDC14);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
   except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
   end;
end;

procedure TfrmMainNew.btn15Click(Sender: TObject);
begin
//  btnClick(btn15, mnuDC15);
//  ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  try
      btnClick(btn15, mnuDC15);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn16Click(Sender: TObject);
begin
//  btnClick(btn16, mnuDC16);
//  ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

  try
      btnClick(btn16, mnuDC16);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn1Click(Sender: TObject);
begin
//  btnClick(btn1, mnuDC1);
//  ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  try
      btnClick(btn1, mnuDC1);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn2Click(Sender: TObject);
begin
//  btnClick(btn2, mnuDC2);
//  ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  try
      btnClick(btn2, mnuDC2);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn3Click(Sender: TObject);
begin
  //btnClick(btn3, mnuDC3);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  try
      btnClick(btn3, mnuDC3);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn4Click(Sender: TObject);
begin
  //btnClick(btn4, mnuDC4);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  try
      btnClick(btn4, mnuDC4);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn5Click(Sender: TObject);
begin
  //btnClick(btn5, mnuDC5);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

  try
      btnClick(btn5, mnuDC5);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn6Click(Sender: TObject);
begin
  //btnClick(btn6, mnuDC6);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

  try
      btnClick(btn6, mnuDC6);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn7Click(Sender: TObject);
begin
  //btnClick(btn7, mnuDC7);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

  try
      btnClick(btn7, mnuDC7);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn8Click(Sender: TObject);
begin
  //btnClick(btn8, mnuDC8);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

  try
      btnClick(btn8, mnuDC8);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btn9Click(Sender: TObject);
begin
  //btnClick(btn9, mnuDC9);
  //ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');

  try
      btnClick(btn9, mnuDC9);
      ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭');
  except
      on e: Exception  do
      begin
         ExceptLogging(TAdvShapeButton(Sender).Text+' 클릭에러'+e.Message);
      end;
  end;
end;

procedure TfrmMainNew.btnCancelClick(Sender: TObject);
begin
  try
    if bCancelCheck then
    begin
      if MessageDlg('정산을 취소할까요?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
      begin
        if bCancelReason then
        begin
          // 정산취소 사유입력
          sCancelReason := InputBox('정산취소사유', '정산취소사유를 입력하여주세요!', '');
        end;

        if bCancelSave then
        begin
          // 정산취소 데이터 저장
          CancelDataProc;
        end;
        InspectionLog('정산취소');
        with qryMainTemp do
        begin
          Close;
          SQL.Clear;
          SQL.Add('delete UsedBarcodeData where TKNo = :N1 ') ;
          SQL.Add(' and procdate + '' '' + proctime >= :N2 ');
          Parameters.ParamByName('N1').Value:= sNowInTKNo;
          Parameters.ParamByName('N2').Value:= lbInTime.Caption;
          ExecSQL;
        end;
        ClearFormData;
      end;
    end
    else
    begin
      if bCancelReason then
      begin
        // 정산취소 사유입력
        sCancelReason := InputBox('정산취소사유', '정산취소사유를 입력하여주세요!', '');
      end;

      if bCancelSave then
      begin
        // 정산취소 데이터 저장
        CancelDataProc;
      end;
      InspectionLog('정산취소');
      with qryMainTemp do
      begin
  //      Close;
  //      SQL.Clear;
  //      SQL.Add('delete UsedBarcodeData where TKNo = :N1 ') ;
  //      SQL.Add(' and procdate + '' '' + proctime >= :N2 ');
  //      Parameters.ParamByName('N1').Value:= sNowInTKNo;
  //      Parameters.ParamByName('N2').Value:= lbInTime.Caption;
  //      ExecSQL;
        //정산취소를 하면 인서트된 바코드가 삭제가안되..
        Close;
        SQL.Clear;
        SQL.Add('delete UsedBarcodeData where barcodeData = :N2 ') ;
        Parameters.ParamByName('N2').Value:= bufBarc;
        if ExecSQL > 0 then begin
          ExceptLogging('[바코드삭제] '+bufBarc);
          sBarcodeTK := '';
        end;
      end;
      //취소 시 할인명, 할인내역 초기화
      edtDC.Text :='';
      lbDCName.Caption :='';
      ClearFormData;
    end;
  except
    on e: Exception do
    begin
       ExceptLogging('btnCancel '+e.Message);
    end;
  end;
end;

procedure TfrmMainNew.btnClick(btn: TAdvShapeButton; mnu: TMenuItem);
var
  sYogum, sFeeName: aString;
  i: Byte;
  asYogum : Integer;
begin
  try
    edtDC.Text:='';
    lbDCName.Caption:='';

    if btn.Tag = 255 then
    begin
      // 민원처리...
      MinwonProc(nowLpr);
      Exit;
    end
    else if btn.Tag > 100 then
    begin
      nProcYogum := StrToInt(MG_StrTrim(edtProcYogum.Text, ','));
      nDCYogum := StrToInt(MG_StrTrim(edtDCYogum.Text, ','));
      dcBtnClick(btn, mnu);

      if (edtProcYogum.Text = '0') and (bDCZeroButtonOpen = True) then begin
        ExceptLogging('버튼 할인후 잔여요금 0원 자동정산');
        btnProcClick(btnProc);
      end;
    end
    else
    begin
      ClearDCProc;
      lbDCName.Caption := '';

      for i := 1 to 15 do
      begin
        with frmMainNew do
        begin
          if TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Tag > 100 then
          begin
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := True;
            TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := True;
          end;
        end;
      end;
      {
        nDCYogum:= 0;
        edtDCYogum.Text:= '0';
        edtDC.Text:= '';
        }

      if btn.Tag <> 0 then
      begin
        with dmTables.qryFeeItem do
        begin
          Close;
          SQL.Clear;
          SQL.Add('Select * from FeeItem where ParkNo = :N1 and FeeNo = :N2');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := btn.Tag;
          Open;

          if RecordCount > 0 then
          begin
            nFeeNo := btn.Tag;
            sFeeName := FieldByName('FeeName').AsString;
            nItemMax := FieldByName('ItemMax').AsInteger;
            nTotMax := FieldByName('TotMax').AsInteger;
          end
          else
          begin
            nFeeNo := 0;
            sFeeName := '';
            nItemMax := 0;
            nTotMax := 0;
          end;
          InspectionLog(sFeeName + ' 선택');
        end;

        {
          for i := 2 to 15 do
          begin
          with frmMainNew do
          begin
          if TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Tag > 100 then
          begin
          TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := False;
          TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := False;
          end;
          end;
          end;
          }
      end
      else
      begin
        nFeeNo := 0;
        nItemMax := nItemMax0;
        nTotMax := nTotMax0;
        InspectionLog('일반요금 선택');
        bIsPatientUse := 0;

        {
          for i := 2 to 15 do
          begin
          with frmMainNew do
          begin
          if TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Tag > 100 then
          begin
          TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := False;
          TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := False;
          end;
          end;
          end;
          }
      end;

      //주차요금 계산전에 기존 할인자료 등 클리어한다.
      for i := 1 to 50 do
        RDCCnt[i].nDCNowCnt := 0;

      ClearGTime;
      ClearDCProc;
      if not bApsPay then
      begin
        if bFreeTime then
        begin
          if sFreeTimeE > Copy(sNowInTime, 1, 5) then
            nTotYogum := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + sFreeTimeE),
                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)))
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + sFreeTimeE),
//                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)))
          else
            nTotYogum := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
//                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
        end
        else
          nTotYogum := DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
                                                           PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),1);
//          nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
//                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
      end
      else
      begin
        if bFreeTime then
        begin
          if sFreeTimeE > Copy(sAPSPayTime, 1, 5) then
            nTotYogum := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + sFreeTimeE),
                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)))
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + sFreeTimeE),
//                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)))
          else
            nTotYogum := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5)),
                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5)),
//                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
        end
        else
        begin
          nTotYogum := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5)),
                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
//          nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5)),
//                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
        end;
      end;

      nProcYogum := nTotYogum;
      edtTotYogum.Text := IntToStr(nTotYogum);
      edtTotYogum.AutoThousandSeparator := True;
      //edtProcYogum.Text := IntToStr(nTotYogum);
      edtProcYogum.Text := FormatFloat('#,##0', nTotYogum);
      sProcTime := lbOutTime.Caption;
      sDCOutTime:= lbOutTime.Caption;
      sDCInTime :=  lbInTime.Caption;
      sDCInTime2:= '';
      //edtProcYogum.AutoThousandSeparator := True;
      InspectionLog('주차요금: ' + edtTotYogum.Text);
      sYogum := IntToStr(nTotYogum);
      DCProcess(sNowInTKNo);
      sYogum := IntToStr(nProcYogum);
//      WebDCProc(sNowInTKNo);
      asYogum := Length(sYogum);
      for i := 1 to 6 do
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;

      if (sYogum = '0') and (bDCZeroAutoOpen = True) then begin
        //lbYogum 라벨들 전부 비활성화 (출차처리됨)
      end else begin
        //for i := 1 to Length(sYogum) do
        for i := 1 to asYogum do
        begin
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
            (sYogum, Length(sYogum) - (i - 1), 1);
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.FcModeChange(nMode: Byte);
var
  i : Integer;
  sDspIP : array[1..3] of aString;
  nDspPort : array[1..3] of Integer;
  nDspTag : array[1..3] of Integer;
begin
  try
    if nMode = 1 then
    begin
      //무인운영
      nFCMode:= 1;
      btnOp.Tag:= 1;
      btnOp.Font.Color:= clRed;
      btnOp.Caption:= '무인운영';
//      csOutDsp1.Socket.Close;
      iSetup.WriteInteger('PARKING', '유인운영', 0);
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '무인운영';
        ExecSQL;
      end;

//      try
//        for I := 1 to 3 do begin
//          if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then begin
//            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := False;
//          end;
//        end;
//      except
//        on E: Exception do begin
//          ExceptLogging('전광판 재연결시 오류 발생 : ' + E.Message);
//        end;
//      end;
//
//      tOutDsp.Enabled := False;
//      ExceptLogging('무인모드 전환 전광판 및 타이머 kill');
    end
    else
    begin
      //유인운영
      nFCMode:= 0;
      btnOp.Tag:= 0;
      btnOp.Font.Color:= clBlue;
      btnOp.Caption:= '유인운영';
//      csOutDsp1.Active:= True;
      iSetup.WriteInteger('PARKING', '유인운영', 1);
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '유인운영';
        ExecSQL;
      end;

//      try
//        for I := 1 to 3 do begin
//          //전광판 초기화 후 재연결
//          sDspIP[I]   := TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host;
//          nDspPort[I] := TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Port;
//          nDspTag[I]  := TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Tag;
//
//          TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Create(nil);
//          TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host := sDspIP[I];
//          TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Port := nDspPort[I];
//          TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Tag  := nDspTag[I];
//          TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
//        end;
//      except
//        on E: Exception do begin
//          ExceptLogging('전광판 재연결시 오류 발생 : ' + E.Message);
//        end;
//      end;
//
//      tOutDsp.Enabled := True;
//      ExceptLogging('유인모드 전환 전광판 및 타이머 Connect');
    end;
  except
    on E: Exception do ExceptLogging('FcModeChange: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.FixedDCDetail(nDCNo: Integer);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa, nValue,nValue1, nTimeDC1,nTypeCode: Integer;
  sName, sYogum, sUpche, sCheckDate: aString;
  i, nChk, nDCType: Byte;
begin
  try
    with dmTables.qryDCTemp do begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= nDCNo;
      Open;

      if RecordCount > 0 then begin
        nDCType:= FieldByName('DCType').AsInteger;
        sName:= FieldByName('DCName').AsString;
        nValue:= FieldByName('DCValue').AsInteger;
        nValue1 := FieldByName('DCValue1').AsInteger;
        nTypeCode := FieldByName('DCTypeCode').AsInteger;
      end;
    end;

    InspectionLog('고정할인: ' + IntToStr(nDCNo) + ', ' +
                               IntToStr(nValue) + ', ' +
                               sName );

      if nProcYogum > 0 then begin
        Case nDCType of
          0:
            begin // 금액할인.
              nDCCnt := nDCCnt + 1;

              if nProcYogum >= nValue then begin
                nProcYogum := nProcYogum - nValue;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nValue;
                nDCYogum := nDCYogum + nJulsa;

                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo       := nDCNo;
                  sDCName     := sName;
                  nDCAmt      := nValue + nJulsa;
                  nRealDCAmt  := nValue + nJulsa;
                  nDCType     := 0;
                  nDCKind     := 3;
                  nTypeCode   := nTypeCode;
                end;
              end else begin
                nDCYogum := nDCYogum + nProcYogum;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nValue;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 0;
                  nDCKind     := 3;
                  nTypeCode   := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          1:    { TODO  : 웹할인 - 시간할인 }
            begin // 시간할인.
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              if sDCOutTime < lbintime.Caption then
              begin
                nTimeDC := nProcYogum;

                DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
                DCProc[nDCCnt].nRealDCMin := nValue;
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;

              if nProcYogum >= nTimeDC then begin
                nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCType     := 1;
                  nDCKind     := 3;
                  nTypeCode   := nTypeCode;
                end;
              end else begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 1;
                  nDCKind     := 3;
                  nTypeCode   := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          2:
            begin // 퍼센트할인.
              nDCCnt := nDCCnt + 1;
              nPerDC := (nProcYogum * nValue) div 100;

              if nProcYogum >= nPerDC then begin
                nProcYogum := nProcYogum - nPerDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nPerDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nPerDC + nJulsa;
                  nRealDCAmt := nPerDC + nJulsa;
                  nDCType     := 2;
                  nDCKind     := 3;
                  nTypeCode   := nTypeCode;
                end;
              end else begin
                nDCYogum := nDCYogum + nPerDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nPerDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 2;
                  nDCKind     := 3;
                  nTypeCode   := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          3:
            begin // 복합할인 = 시간할인 + % 할인
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              if sDCOutTime <lbintime.Caption then
              begin
                nTimeDC := nProcYogum;
              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;
//              nTimeDC := nProcYogum - Retur14nFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              nTimeDC := nTimeDC + ((nProcYogum - nTimeDC) * nValue1 div 100);

              if nProcYogum >= nTimeDC then
              begin
                nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := nDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCKind    := 3;
                  nDCType    := 3;
                  nTypeCode  := nTypeCode;
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCKind    := 3;
                  nDCType    := 3;
                  nTypeCode  := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          4:
            begin // 고객부담. (시간할인 부분 고정금액)
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              sDCInTime  := MG_AddTime(sDCInTime, 0, nValue, 0, 0);
              nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              if nProcYogum >= nTimeDC then
              begin
                nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
                nProcYogum := nProcYogum - nTimeDC + nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := nDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC -nValue1+ nJulsa;
                  nRealDCAmt := nDCYogum + nJulsa;
                  nDCKind    := 3;
                  nDCType    := 4;
                  nTypeCode  := nTypeCode;
                end;

//                with DCProc[nDCCnt] do
//                begin
//                  nDCNo      := RWebDCData[nCnt].nWebDCNo;
//                  sDCName    := sName;
//                  nDCAmt     := nTimeDC + nJulsa;
//                  nRealDCAmt := nTimeDC + nJulsa;
//                  nDCKind    := 2;
//                  nSeq       := RWebDCData[i].nSeq;
//                  sSeq       := RWebDCData[i].sSeq;
//                  nDCType    := 4;
//                  nTypeCode  := nTypeCode;
//                  sStoreName := RWebDCData[i].sStoreName;
//                  DCKey       := RWebDCData[nCnt].DCKey;
//                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nProcYogum - nValue1;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                nProcYogum := nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;

                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := nDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC -nValue1 ;
                  nRealDCAmt := nDCYogum;
                  nDCKind    := 3;
                  nDCType    := 4;
                  nTypeCode  := nTypeCode;
                end;
//                nProcYogum := 0 + nValue1;
//                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);//'0';
              end;
            end;


        end;

        InspectionLog('고정요금: ' + edtDCYogum.Text);
        lbDCName.Caption:= '고정요금할인';
      end;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.WebDCDetail: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.FixedDCProc(sCarno: String);
var
  nInCnt, nLprNo: Word;
  sLprDate, sWeekDay,sUseStartTime,sUseEndTime: String;
  i,nLimitedDayCount,nLimitedMonthCount,nDCNo : Integer;
  bCheck : Boolean;
begin
  bCheck := false;
  with dmTables.qryNormalIn1 do
  begin
    Close;
    SQL.Clear;
    //오피스(타워)할인
    Close;
    SQL.Clear;
    SQL.Add('Select top(1) * from DcFixed where CarNo = :N1 and ((StartYmd <= :N2) and (EndYmd >= :N3)) ');
//    SQL.Add(' and ((UseParkNo = 0 ) or (UseParkNo = :N4)) ');
    SQL.Add(' and ((UseStartTime <= :N5) and (UseEndTime >= :N6)) ');
    Parameters.ParamByName('N1').Value:= sCarno;
    Parameters.ParamByName('N2').Value:= FormatDateTime('YYYY-MM-DD', Now);
    Parameters.ParamByName('N3').Value:= FormatDateTime('YYYY-MM-DD', Now);
//    Parameters.ParamByName('N4').Value:= nUseParkNo;
    Parameters.ParamByName('N5').Value:= FormatDateTime('HH:NN', Now);
    Parameters.ParamByName('N6').Value:= FormatDateTime('HH:NN', Now);
    Open;
    if RecordCount > 0 then
    begin
      sWeekDay := FieldByName('UseWeekDay').AsString;
      nLimitedDayCount := FieldByName('LimitedDayCount').AsInteger;
      nLimitedMonthCount := FieldByName('LimitedMonthCount').AsInteger;
      nDCNo := FieldByName('DCNo').AsInteger;
      bCheck := DCFixedCheck(sWeekDay ,sCarno ,nLimitedDayCount ,nLimitedMonthCount);
    end;
    end;
    if bCheck then
    begin
      bFixedUse := True;
      FixedDCDetail(nDCNo);
    end;
//var
//  nTotCnt, nDCNo, nDCValue, nDCCnt,nParnas, i, j, nTemp1, nTemp2, nDiscountMoney: Integer;
//  sTempWeb, sTemp, sDCName, sUpche, sWebInfo: String;
//begin
//  try
//    i := 0;
//    with dmTables.qryDCTemp do
//    begin
//      Close;
//      SQL.Clear;
//      //오피스(타워)할인
//      Close;
//      SQL.Clear;
//      SQL.Add('Select * from tblstorediscountpublish where norkey = :N1 and DelYn = 0 and outYmd is null ');
//      Parameters.ParamByName('N1').Value:= sWebDC;
//      Open;
//      if RecordCount >0 then
//      begin
//        bWebUse1 := True;
//        while not Eof do
//        begin
//          i := i + 1;
////          ShowMessage(IntToStr(i));
//          RWebDCData[i].nWebDCNo := StrToInt(trim(FieldByName('DiscountCode').AsString));
//          RWebDCData[i].nWebDCValue := FieldByName('DiscountValue').AsInteger;
//          RWebDCData[i].sWebDCMessage := FieldByName('DiscountName').AsString;
//          RWebDCData[i].nWebDCType := FieldByName('DiscountType').AsInteger;
//          RWebDCData[i].sSeq := FieldByName('Sequence').AsString;
//          RWebDCData[i].nSeq := i;
//          RWebDCData[i].nTypeCode := FieldByName('DCTypeCode').AsInteger;    //Added Woo.YH 웹할인처 구분값
//          RWebDCData[i].sStoreName := FieldByName('StoreName').AsString;
//          RWebDCData[i].DCKey      := FieldByName('DCKEY').AsString;
//          Next;
//        end;
//      end;
//    end;
//
//    nTotCnt:= i;
//    if nTotCnt > 0 then
//    begin
//      for j := 1 to nTotCnt do
//        WebDCDetail(j);
//    end;
//  except
//    on E: Exception do ExceptLogging('TfrmMainNew.WebDCProc: ' + aString(E.Message));
//  end;
end;

procedure TfrmMainNew.FormAlign;
begin
  pnlReceipt.Top := (frmMainNew.ClientHeight - pnlReceipt.Height) div 2;
  pnlReceipt.Left := (frmMainNew.ClientWidth - pnlReceipt.Width) div 2;
  pnModify.Top := (frmMainNew.ClientHeight - pnModify.Height) div 2;
  pnModify.Left := (frmMainNew.ClientWidth - pnModify.Width) div 2;
  pnManual.Top := (frmMainNew.ClientHeight - pnManual.Height) div 2;
  pnManual.Left := (frmMainNew.ClientWidth - pnManual.Width) div 2;
  pnManualOut.Top := (frmMainNew.ClientHeight - pnManualOut.Height) div 2;
  pnManualOut.Left := (frmMainNew.ClientWidth - pnManualOut.Width) div 2;
  pnLost.Top := (frmMainNew.ClientHeight - pnLost.Height) div 2;
  pnLost.Left := (frmMainNew.ClientWidth - pnLost.Width) div 2;
  pnBar.Top := (frmMainNew.ClientHeight - pnBar.Height) div 2;
  pnBar.Left := (frmMainNew.ClientWidth - pnBar.Width) div 2;
  pnSCSearch.Top := (frmMainNew.ClientHeight - pnSCSearch.Height) div 2;
  pnSCSearch.Left := (frmMainNew.ClientWidth - pnSCSearch.Width) div 2;
  pnManualProc.Top := (frmMainNew.ClientHeight - pnManualProc.Height) div 2;
  pnManualProc.Left := (frmMainNew.ClientWidth - pnManualProc.Width) div 2;
end;

procedure TfrmMainNew.PartGridData(sResult: String);
var
  sCarNo, sIOTime, sStatus, sTemp, sDate, sTime: String;
  nPos: Byte;
begin
  sCarNo := Copy(sResult, 2, Pos('^', sResult) - 2);
  sTemp := Copy(sResult, Pos('^', sResult) + 1, Length(sResult) -
      (Pos('^', sResult)));
  sIOTime := Copy(sTemp, 1, Pos('^', sTemp) - 1);
  sDate := Copy(sIOTime, 1, 10);
  sTime := Copy(sIOTime, 12, 8);
  nPos := Pos('^', sTemp);
  sStatus := Copy(sTemp, nPos + 1, Length(sTemp) - nPos);

  with sgIn do
  begin
    InsertRows(1, 1, True);
    Cells[0, 1] := '일반차량';
    Cells[1, 1] := sDate;
    Cells[2, 1] := sTime;
    Cells[3, 1] := sCarNo;
    Cells[4, 1] := '';
    Cells[5, 1] := '';
    Cells[6, 1] := '';
    Cells[7, 1] := sStatus;
  end;
  sgIn.Alignments[0, 1] := taCenter;
  sgIn.Alignments[1, 1] := taCenter;
  sgIn.Alignments[2, 1] := taCenter;
  sgIn.Alignments[3, 1] := taCenter;
  sgIn.Alignments[4, 1] := taCenter;
  sgIn.Alignments[5, 1] := taCenter;
  sgIn.Alignments[6, 1] := taCenter;
  sgIn.Alignments[7, 1] := taCenter;
  //동의대 미인식 차량 컬러 삭제
  sgIn.RowColor[1] := clRed;
end;

procedure TfrmMainNew.N1Click(Sender: TObject);
begin
  bGoodCredit := False;
  NextModalDialog(TfrmCancel_SMT.Create(Self));
  if bGoodCredit then
  begin
    if ComPrn.Open and (sCreditPrt <> '') then
    begin
      ComPrn.PutString(sCreditPrt);
      sCreditPrt := '';
    end;
    bGoodCredit := False;
  end
  else
  begin
     bGoodCredit:= False;
  end;
end;

//OCS테스트
procedure TfrmMainNew.N2Click(Sender: TObject);
begin
      //
end;

procedure TfrmMainNew.N3Click(Sender: TObject);
begin
//바코드 수동
end;

procedure TfrmMainNew.NGridData(sResult: String);
var
  sCarNo, sIOTime, sStatus, sTemp, sDate, sTime: String;
  nPos, nIO: Byte;
begin
  if Length(sResult) > 4 then
  begin
    nIO := StrToInt(Copy(sResult, 1, 1));
    sCarNo := Copy(sResult, 2, Pos('^', sResult) - 2);
    sTemp := Copy(sResult, Pos('^', sResult) + 1, Length(sResult) -
        (Pos('^', sResult)));
    sIOTime := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    sDate := Copy(sIOTime, 1, 10);
    sTime := Copy(sIOTime, 12, 8);
    nPos := Pos('^', sTemp);
    sStatus := Copy(sTemp, nPos + 1, Length(sTemp) - nPos);

    if nIO = 1 then
    begin
      with sgIn do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '일반차량';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
      end;
      sgIn.Alignments[0, 1] := taCenter;
      sgIn.Alignments[1, 1] := taCenter;
      sgIn.Alignments[2, 1] := taCenter;
      sgIn.Alignments[3, 1] := taCenter;
      sgIn.Alignments[4, 1] := taCenter;
      sgIn.Alignments[5, 1] := taCenter;
      sgIn.Alignments[6, 1] := taCenter;
      sgIn.Alignments[7, 1] := taCenter;
    end
    else if nIO = 2 then
    begin
      with sgOut do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '일반차량';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
      end;
      sgOut.Alignments[0, 1] := taCenter;
      sgOut.Alignments[1, 1] := taCenter;
      sgOut.Alignments[2, 1] := taCenter;
      sgOut.Alignments[3, 1] := taCenter;
      sgOut.Alignments[4, 1] := taCenter;
      sgOut.Alignments[5, 1] := taCenter;
      sgOut.Alignments[6, 1] := taCenter;
      sgOut.Alignments[7, 1] := taCenter;
    end
    else if nIO = 3 then
    begin
      with sgOut do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '정기차량';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
      end;
      sgOut.Alignments[0, 1] := taCenter;
      sgOut.Alignments[1, 1] := taCenter;
      sgOut.Alignments[2, 1] := taCenter;
      sgOut.Alignments[3, 1] := taCenter;
      sgOut.Alignments[4, 1] := taCenter;
      sgOut.Alignments[5, 1] := taCenter;
      sgOut.Alignments[6, 1] := taCenter;
      sgOut.Alignments[7, 1] := taCenter;
      sgOut.RowColor[1] := clGreen;
    end;
  end;
end;

procedure TfrmMainNew.GridData(sResult: String);
var
  sCarNo, sName, sCompName, sExpDate, sStatus, sTemp, sIODate, sIOTime: String;
  nPos, nIO: Byte;
begin
  if Length(sResult) > 6 then
  begin
    nIO := StrToInt(Copy(sResult, 1, 1));
    sIODate := Copy(sResult, 2, Pos('^', sResult) - 2);
    sTemp := Copy(sResult, Pos('^', sResult) + 1, Length(sResult) -
        (Pos('^', sResult)));
    sIOTime := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp))
      );
    sCarNo := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp))
      );
    sName := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp))
      );
    sCompName := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    nPos := Pos('^', sTemp);
    sTemp := Copy(sTemp, nPos + 1, (Length(sTemp) - (nPos)) + 2);
    sExpDate := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    nPos := Pos('^', sTemp);
    sStatus := Copy(sTemp, nPos + 1, Length(sTemp) - nPos);

    if nIO = 1 then
    begin
      with sgIn do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '정기차량';
        Cells[1, 1] := sIODate;
        Cells[2, 1] := sIOTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := sCompName;
        Cells[5, 1] := sName;
        Cells[6, 1] := sExpDate;
        Cells[7, 1] := sStatus;
      end;
      sgIn.Alignments[0, 1] := taCenter;
      sgIn.Alignments[1, 1] := taCenter;
      sgIn.Alignments[2, 1] := taCenter;
      sgIn.Alignments[3, 1] := taCenter;
      sgIn.Alignments[4, 1] := taCenter;
      sgIn.Alignments[5, 1] := taCenter;
      sgIn.Alignments[6, 1] := taCenter;
      sgIn.Alignments[7, 1] := taCenter;
        //동의대 정기차량 초록색 요청
      sgIn.RowColor[1] := clGreen;
    end
    else
    begin
      with sgOut do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '정기차량';
        Cells[1, 1] := sIODate;
        Cells[2, 1] := sIOTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := sCompName;
        Cells[5, 1] := sName;
        Cells[6, 1] := sExpDate;
        Cells[7, 1] := sStatus;
      end;
      sgOut.Alignments[0, 1] := taCenter;
      sgOut.Alignments[1, 1] := taCenter;
      sgOut.Alignments[2, 1] := taCenter;
      sgOut.Alignments[3, 1] := taCenter;
      sgOut.Alignments[4, 1] := taCenter;
      sgOut.Alignments[5, 1] := taCenter;
      sgOut.Alignments[6, 1] := taCenter;
      sgOut.Alignments[7, 1] := taCenter;
      //동의대 정기차량 초록색 요청
      sgOut.RowColor[1] := clGreen;
    end;
  end;
end;

procedure TfrmMainNew.WaitClear;
var
  i: Byte;
begin
  for i := 1 to 20 do
  begin
    RSCWait[i].sSCFile1 := '';
    RSCWait[i].sSCCarNo1 := '';
    RSCWait[i].sSCFile2 := '';
    RSCWait[i].sSCCarNo2 := '';
    RSCWait[i].sSCIOTime := '';
    RSCWait[i].nSCLprNo := 0;
    RSCWait[i].nSCInOut := 0;
    RSCWait[i].nSCRecog1 := 0;
    RSCWait[i].nSCRecog2 := 0;
    RSCWait[i].sSCDspIP := '';
    RSCWait[i].bBarOpen := False;
  end;

  for i := 1 to 20 do
  begin
    RNCInWait[i].sNCFile1 := '';
    RNCInWait[i].sNCCarNo1 := '';
    RNCInWait[i].sNCFile2 := '';
    RNCInWait[i].sNCCarNo2 := '';
    RNCInWait[i].sNCIOTime := '';
    RNCInWait[i].nNCLprNo := 0;
    RNCInWait[i].nNCInOut := 0;
    RNCInWait[i].nNCRecog1 := 0;
    RNCInWait[i].nNCRecog2 := 0;
    RNCInWait[i].sNCDspIP := '';
    RNCInWait[i].bBarOpen := False;
    RNCInWait[i].nFeeNo := 0;

    RNCOutWait[i].sNCFile1 := '';
    RNCOutWait[i].sNCCarNo1 := '';
    RNCOutWait[i].sNCFile2 := '';
    RNCOutWait[i].sNCCarNo2 := '';
    RNCOutWait[i].sNCIOTime := '';
    RNCOutWait[i].nNCLprNo := 0;
    RNCOutWait[i].nNCInOut := 0;
    RNCOutWait[i].nNCRecog1 := 0;
    RNCOutWait[i].nNCRecog2 := 0;
    RNCOutWait[i].sNCDspIP := '';
    RNCOutWait[i].bBarOpen := False;
    RNCOutWait[i].nFeeNo := 0;
  end;
end;

procedure TfrmMainNew.WebDCDetail(nCnt: Integer);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa, nValue,nValue1, nTimeDC1,nTypeCode: Integer;
  sName, sYogum, sUpche, sCheckDate: aString;
  i, nChk, nDCType: Byte;
  nDCFeeno  : Integer;
  //디비 속도 향상
  OCS_DC_Field, OCS_DC_Field2, OCS_DC_Field3, OCS_DC_Field4, OCS_DC_Field5, OCS_DC_Field6, OCS_DC_Field7: TField;
  asYogum, sDCYogum : Integer;
begin
  try
//    sCheckDate:= MG_AddDate(sNowInDate, 1);
    //디비 속도 향상
    OCS_DC_Field := TField.Create(Self);
    OCS_DC_Field2 := TField.Create(Self);
    OCS_DC_Field3 := TField.Create(Self);
    OCS_DC_Field4 := TField.Create(Self);
    OCS_DC_Field5 := TField.Create(Self);
    OCS_DC_Field6 := TField.Create(Self);
    OCS_DC_Field7 := TField.Create(Self);

    with dmTables.qryDCTemp do begin
      dmTables.qryDCTemp.DisableControls;
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= RWebDCData[nCnt].nWebDCNo;
      Open;

      if RecordCount > 0 then begin
        //21.03.15 디비 속도 향상
        OCS_DC_Field := FieldByName('DCType');
        OCS_DC_Field2 := FieldByName('DCName');
        OCS_DC_Field3 := FieldByName('DCValue');
        OCS_DC_Field4 := FieldByName('DCValue1');
        OCS_DC_Field5 := FieldByName('DCTypeCode');
        OCS_DC_Field6 := FieldByName('FeeNo');

        nDCType := OCS_DC_Field.AsInteger;
        sName   := OCS_DC_Field2.AsString;
        nValue  := OCS_DC_Field3.AsInteger;
        nValue1 := OCS_DC_Field4.AsInteger;
        nTypeCode := OCS_DC_Field5.AsInteger;
        nDCFeeno  := OCS_DC_Field6.AsInteger;

//        nDCType:= FieldByName('DCType').AsInteger;
//        sName:= FieldByName('DCName').AsString;
//        nValue:= FieldByName('DCValue').AsInteger;
//        nValue1 := FieldByName('DCValue1').AsInteger;
//        nTypeCode := FieldByName('DCTypeCode').AsInteger;
//        nDCFeeno           := FieldByName('FeeNo').AsInteger;

        //11.25 웹할인 시간 할인코드
        if nDCType = 1 then
        begin
          Close;
          SQL.Clear;
          if sDCInTime2 <> '' then  //ocs중복할인 시
          begin
             //SQL.Add('select datediff(mi,'+QuotedStr(sDCInTime2)+' , '+QuotedStr(lbOutTime.Caption)+')' );
             SQL.Add('select datediff(ss,'+QuotedStr(sDCInTime2)+' , '+QuotedStr(lbOutTime.Caption)+') / 60 ' );
          end
          else
          begin
             //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
             SQL.Add('select datediff(ss,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ') / 60' );
          end;
          //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
          Open;
          if RecordCount > 0 then begin
            //nowUseTime := Fields[0].AsInteger;
            //21.03.15 디비 속도 향상
            OCS_DC_Field6 := Fields[0];
            nowUseTime := OCS_DC_Field6.AsInteger;
            ExceptLogging('[총 할인 주차시간(분)] '+IntToStr(nValue));
            ExceptLogging('[현재주차시간(분)] '+IntToStr(nowUseTime));
            if nowUseTime > nValue then
            begin
               overUseTime := nowUseTime - nValue; //남은 추차시간 = 총  주차시간 -  할인 시간
               ExceptLogging('[남은 주차시간(분)] '+IntToStr(overUseTime));
            end
            else
            begin
               //남은 추차시간 = 할인 시간 - 총  주차시간
               ExceptLogging('[남은 주차시간(분)2] '+IntToStr(nValue - nowUseTime));
            end;
          end;
        end;
      end;
      dmTables.qryDCTemp.EnableControls;
    end;

    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;
//    sName:= RWebDCData[nCnt].sWebDCName;
//    nValue:= RWebDCData[nCnt].nWebDCValue;
//    sUpChe:= RWebDCData[nCnt].sWebName;
    InspectionLog('웹할인: ' + IntToStr(RWebDCData[nCnt].nWebDCNo) + ', ' +
                               IntToStr(nValue) + ', ' +
                               sName );

      if nProcYogum > 0 then begin
        Case nDCType of
          0:
            begin // 금액할인.
              nDCCnt := nDCCnt + 1;

              if nProcYogum >= nValue then begin
                nProcYogum := nProcYogum - nValue;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nValue;
                nDCYogum := nDCYogum + nJulsa;

                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo       := RWebDCData[nCnt].nWebDCNo;
                  sDCName     := sName;
                  nDCAmt      := nValue + nJulsa;
                  nRealDCAmt  := nValue + nJulsa;
                  nDCType     := 0;
                  nSeq        := RWebDCData[nCnt].nSeq;
                  sSeq        := RWebDCData[nCnt].sSeq;
                  nDCKind     := 2;
                  nTypeCode   := nTypeCode;
                  sStoreName  := RWebDCData[nCnt].sStoreName;
                end;
              end else begin
                nDCYogum := nDCYogum + nProcYogum;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := RWebDCData[nCnt].nWebDCNo;
                  sDCName := sName;
                  nDCAmt := nValue;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 0;
                  nSeq        := RWebDCData[nCnt].nSeq;
                  sSeq        := RWebDCData[nCnt].sSeq;
                  nDCKind     := 2;
                  nTypeCode   := nTypeCode;
                  sStoreName  := RWebDCData[nCnt].sStoreName;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          1:    { TODO  : 웹할인 - 시간할인 }
            begin // 시간할인.
              nDCCnt := nDCCnt + 1;
              InspectionLog('웹 할인횟수 : ' + IntToStr(nDCCnt));
              InspectionLog('주차요금(웹 할인전) : ' + IntToStr(nProcYogum));
              InspectionLog('웹 할인전 OCS 할인 시간(웹 할인전) : ' + sDCInTime2);

              //sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);

              //sDCOutTime := MG_AddTime(lbOutTime.Caption, 0, -nValue, 0, 0);

              //ocs할인 시간 후 웹 할인 시간 더해서 중복 할인
              if sDCInTime2 <> '' then
              begin
                sDCInTime2:= MG_AddTime(sDCInTime2, 0, nValue, 0, 0);
                sDCOutTime2 := MG_AddTime(sDCOutTime2, 0, -nValue, 0, 0);
                sDCOutTime  := sDCOutTime2;
              end
              else
              begin
                 sDCOutTime  := MG_AddTime(lbOutTime.Caption, 0, -nValue, 0, 0);
              end;

              if sDCOutTime < lbintime.Caption then
              begin
                nTimeDC := nProcYogum;
                DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);

              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
                  if sDCInTime2 <> '' then    //OCS연동 할인, 웹할인 중복 할인
                  begin
                       //nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sDCInTime2), 1, 16)),
                       bIsPatientUse := 1;
                       nISCCD := '';
//                       nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sDCInTime2), 1, 16)),
//                                                                       PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),4);
                        nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                        PAnsiChar(Copy(aString(sDCOutTime2), 1, 16)),4);

                       InspectionLog('웹 할인+ OCS 할인 요금(OCS 할인 시간 이후 ~ 웹 할인전) : ' + inttostr(nTimeDC));
                  end
                  else   //웹할인만 할인
                  begin
                    nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                                PAnsiChar(Copy(aString(sDCOutTime), 1, 16)),2);
                    sDCInTime2 := '';
                    InspectionLog('웹 할인 요금(웹할인 입차 이후  ~ 웹 할인전) : ' + inttostr(nTimeDC));
                  end;

//                  nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                                              PAnsiChar(Copy(aString(sDCOutTime), 1, 16)),2);
                  DCProc[nDCCnt].nRealDCMin := nValue;
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//              nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)));

              if nProcYogum >= nTimeDC then begin
                ExceptLogging('웹할인 OCS중복 날짜 확인'+ sDCInTime2);
                if sDCInTime2 <> '' then  //OCS 중복 할인 시
                begin
                  ExceptLogging('웹할인 적용(OCS중복) 현재금액:'+inttostr(nProcYogum) +' 할인금액:'+inttostr(nTimeDC));
                  sDCYogum := StrToInt( StringReplace(edtDCYogum.Text, ',', '', [rfReplaceAll]) );
                  //sDCYogum := nTotYogum - nTimeDC - sDCYogum;
                  if sDCOutTime < lbintime.Caption then
                  begin
                     //sDCYogum   := nProcYogum - sDCYogum;
                     sDCYogum   := nTotYogum - sDCYogum;
                     nProcYogum := nProcYogum - nTimeDC;
                     nDCYogum   := sDCYogum;  // 추가사항
                  end
                  else
                  begin
                     sDCYogum   := nTotYogum - nTimeDC - sDCYogum;
                     nProcYogum := nTimeDC;
                     nDCYogum   := nTotYogum - nTimeDC;  // 추가사항
                  end;
                  ExceptLogging('웹할인 적용(OCS중복) 최종금액 :'+inttostr(nProcYogum) +' 할인금액:'+inttostr(nDCYogum));
                end
                else
                begin
                   ExceptLogging('웹할인 적용(OCS중복안됨) 현재금액:'+inttostr(nProcYogum) +' 할인금액:'+inttostr(nTimeDC));
                   nProcYogum := nProcYogum - nTimeDC;
                   nDCYogum := nDCYogum + nTimeDC;
                   ExceptLogging('웹할인 적용(OCS중복안됨) 최종금액 :'+inttostr(nProcYogum) +' 할인금액:'+inttostr(nDCYogum));
                end;

                //nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                //nDCYogum := nTotYogum - nTimeDC;  // 추가사항
                //nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                if nDCYogum < 0 then //할인요금은 절대 -금액 될수없다!
                  nDCYogum := 0;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);
                asYogum := Length(sYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                //for i := 1 to Length(sYogum) do begin
                for i := 1 to asYogum do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := RWebDCData[nCnt].nWebDCNo;
                  sDCName := sName;
                  if sDCInTime2 <> '' then  //OCS 중복 할인 시
                  begin
                    //추가사항
                    nDCAmt := sDCYogum;
                    nRealDCAmt := sDCYogum;
                    //nDCAmt := nTotYogum - nTimeDC;
                    //nRealDCAmt := nTotYogum - nTimeDC;
                  end
                  else
                  begin
                    nDCAmt := nTimeDC + nJulsa;
                    nRealDCAmt := nTimeDC + nJulsa;
                  end;


                  nDCType     := 1;
                  nSeq        := RWebDCData[nCnt].nSeq;
                  sSeq        := RWebDCData[nCnt].sSeq;
                  nDCKind     := 2;
                  nTypeCode   := nTypeCode;
                  sStoreName  := RWebDCData[nCnt].sStoreName;
                end;
              end else begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := RWebDCData[nCnt].nWebDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 1;
                  nSeq        := RWebDCData[nCnt].nSeq;
                  sSeq        := RWebDCData[nCnt].sSeq;
                  nDCKind     := 2;
                  nTypeCode   := nTypeCode;
                  sStoreName  := RWebDCData[nCnt].sStoreName;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          2:
            begin // 퍼센트할인.
              nDCCnt := nDCCnt + 1;
              nPerDC := (nProcYogum * nValue) div 100;

              if nProcYogum >= nPerDC then begin
                nProcYogum := nProcYogum - nPerDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nPerDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := RWebDCData[nCnt].nWebDCNo;
                  sDCName := sName;
                  nDCAmt := nPerDC + nJulsa;
                  nRealDCAmt := nPerDC + nJulsa;
                  nDCType     := 2;
                  nSeq        := RWebDCData[nCnt].nSeq;
                  sSeq        := RWebDCData[nCnt].sSeq;
                  nDCKind     := 2;
                  nTypeCode   := nTypeCode;
                  sStoreName  := RWebDCData[nCnt].sStoreName;
                end;
              end else begin
                nDCYogum := nDCYogum + nPerDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := RWebDCData[nCnt].nWebDCNo;
                  sDCName := sName;
                  nDCAmt := nPerDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 2;
                  nSeq        := RWebDCData[nCnt].nSeq;
                  sSeq        := RWebDCData[nCnt].sSeq;
                  nDCKind     := 2;
                  nTypeCode   := nTypeCode;
                  sStoreName  := RWebDCData[nCnt].sStoreName;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          3:
            begin // 복합할인 = 시간할인 + % 할인
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              if sDCOutTime <lbintime.Caption then
              begin
                nTimeDC := nProcYogum;
              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              nTimeDC := nTimeDC + ((nProcYogum - nTimeDC) * nValue1 div 100);

              if nProcYogum >= nTimeDC then
              begin
                nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := RWebDCData[nCnt].nWebDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCKind    := 2;
                  nSeq       := RWebDCData[i].nSeq;
                  sSeq       := RWebDCData[i].sSeq;
                  nDCType    := 3;
                  nTypeCode  := nTypeCode;
                  sStoreName := RWebDCData[i].sStoreName;
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := RWebDCData[nCnt].nWebDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCKind    := 2;
                  nSeq       := RWebDCData[i].nSeq;
                  sSeq       := RWebDCData[i].sSeq;
                  nDCType    := 3;
                  nTypeCode  := nTypeCode;
                  sStoreName := RWebDCData[i].sStoreName;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          4:
            begin // 고객부담. (시간할인 부분 고정금액)
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              sDCInTime  := MG_AddTime(sDCInTime, 0, nValue, 0, 0);
              nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              if nProcYogum >= nTimeDC then
              begin
                nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
                nProcYogum := nProcYogum - nTimeDC + nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := RWebDCData[nCnt].nWebDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC -nValue1+ nJulsa;
                  nRealDCAmt := nDCYogum + nJulsa;
                  nDCKind    := 2;
                  nSeq       := RWebDCData[i].nSeq;
                  sSeq       := RWebDCData[i].sSeq;
                  nDCType    := 4;
                  nTypeCode  := nTypeCode;
                  sStoreName := RWebDCData[i].sStoreName;
                end;

//                with DCProc[nDCCnt] do
//                begin
//                  nDCNo      := RWebDCData[nCnt].nWebDCNo;
//                  sDCName    := sName;
//                  nDCAmt     := nTimeDC + nJulsa;
//                  nRealDCAmt := nTimeDC + nJulsa;
//                  nDCKind    := 2;
//                  nSeq       := RWebDCData[i].nSeq;
//                  sSeq       := RWebDCData[i].sSeq;
//                  nDCType    := 4;
//                  nTypeCode  := nTypeCode;
//                  sStoreName := RWebDCData[i].sStoreName;
//                  DCKey       := RWebDCData[nCnt].DCKey;
//                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nProcYogum - nValue1;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                nProcYogum := nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;

                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := RWebDCData[nCnt].nWebDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC -nValue1 ;
                  nRealDCAmt := nDCYogum;
                  nDCKind    := 2;
                  nSeq       := RWebDCData[i].nSeq;
                  sSeq       := RWebDCData[i].sSeq;
                  nDCType    := 4;
                  nTypeCode  := nTypeCode;
                  sStoreName := RWebDCData[i].sStoreName;
                end;
//                nProcYogum := 0 + nValue1;
//                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);//'0';
              end;
            end;


        end;
        //21.03.12 웹할인 할인명 설정
        if edtDC.Text = '' then
        begin
          edtDC.Text := sName;
        end
        else
        begin
          edtDC.Text := edtDC.Text + ', ' + sName;
        end;

        InspectionLog('웹할인요금: ' + edtDCYogum.Text);
        //lbDCName.Caption:= '웹할인';
        //21.03.12 OCS 할인명과 웹할인 명 같이 쓰기
        lbDCName.Caption:= lbDCName.Caption + '웹할인';

      end;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.WebDCDetail: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.WebDCProc(sWebDC: String);
var
  nTotCnt, nDCNo, nDCValue, nDCCnt,nParnas, i, j, nTemp1, nTemp2, nDiscountMoney: Integer;
  sTempWeb, sTemp, sDCName, sUpche, sWebInfo: String;
   //디비 속도 향상
  WEB_DC_Field, WEB_DC_Field2, WEB_DC_Field3, WEB_DC_Field4, WEB_DC_Field5, WEB_DC_Field6, WEB_DC_Field7: TField;
begin
  try
    i := 0;
    ExceptLogging('sWebDC : '+sWebDC);
    {WEB_DC_Field := TField.Create(self);
    WEB_DC_Field2 := TField.Create(self);
    WEB_DC_Field3 := TField.Create(self);
    WEB_DC_Field4 := TField.Create(self);
    WEB_DC_Field5 := TField.Create(self);
    WEB_DC_Field6 := TField.Create(self);
    WEB_DC_Field7 := TField.Create(self);}
    with dmTables.qryDCTemp do
    begin
      //Close;
      //SQL.Clear;
      //오피스(타워)할인
      Close;
      SQL.Clear;
      SQL.Add('Select * from tblstorediscountpublish where norkey = :N1 and DelYn = 0 and outYmd is null ');
      ExceptLogging(SQL.Text);
      Parameters.ParamByName('N1').Value:= sWebDC;
      Open;
      if RecordCount > 0 then
      begin
        bWebUse1 := True;
        {WEB_DC_Field := FieldByName('DiscountCode');
        WEB_DC_Field2 := FieldByName('DiscountValue');
        WEB_DC_Field3 := FieldByName('DiscountName');
        WEB_DC_Field4 := FieldByName('DiscountType');
        WEB_DC_Field5 := FieldByName('Sequence');
        WEB_DC_Field6 := FieldByName('DCTypeCode');
        WEB_DC_Field7 := FieldByName('StoreName'); }

        while not Eof do
        begin
          i := i + 1;
//          ShowMessage(IntToStr(i));

          {RWebDCData[i].nWebDCNo := StrToInt(trim(WEB_DC_Field.AsString));
          RWebDCData[i].nWebDCValue := WEB_DC_Field2.AsInteger;
          RWebDCData[i].sWebDCMessage := WEB_DC_Field3.AsString;
          RWebDCData[i].nWebDCType := WEB_DC_Field4.AsInteger;
          RWebDCData[i].sSeq := WEB_DC_Field5.AsString;
          RWebDCData[i].nSeq := i;
          RWebDCData[i].nTypeCode := WEB_DC_Field6.AsInteger;    //Added Woo.YH 웹할인처 구분값
          RWebDCData[i].sStoreName := WEB_DC_Field7.AsString;}

          RWebDCData[i].nWebDCNo := StrToInt(trim(FieldByName('DiscountCode').AsString));
          RWebDCData[i].nWebDCValue := FieldByName('DiscountValue').AsInteger;
          RWebDCData[i].sWebDCMessage := FieldByName('DiscountName').AsString;
          RWebDCData[i].nWebDCType := FieldByName('DiscountType').AsInteger;
          RWebDCData[i].sSeq := FieldByName('Sequence').AsString;
          RWebDCData[i].nSeq := i;
          RWebDCData[i].nTypeCode := FieldByName('DCTypeCode').AsInteger;    //Added Woo.YH 웹할인처 구분값
          RWebDCData[i].sStoreName := FieldByName('StoreName').AsString;
          ExceptLogging('웹할인데이터 있음 : '+IntToStr(RWebDCData[i].nWebDCNo) +' '+IntToStr(RWebDCData[i].nWebDCValue)+' '+RWebDCData[i].sWebDCMessage+' '+
          IntToStr(RWebDCData[i].nWebDCType)+' '+RWebDCData[i].sSeq+' '+IntToStr(RWebDCData[i].nSeq)+' '+IntToStr(RWebDCData[i].nTypeCode)+' '+RWebDCData[i].sStoreName);
          Next;
        end;
      end;
    end;

    nTotCnt:= i;
    if nTotCnt > 0 then
    begin
      for j := 1 to nTotCnt do
        WebDCDetail(j);
    end;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.WebDCProc: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.GridClear;
var
  i, j: Byte;
begin
  with sgIn do
  begin
    Cells[0, 0] := '차량종류';
    Cells[1, 0] := '입차일자';
    Cells[2, 0] := '입차시각';
    Cells[3, 0] := '차량번호';
    Cells[4, 0] := '소    속';
    Cells[5, 0] := '성명';
    Cells[6, 0] := '유효기간';
    Cells[7, 0] := '출입상태';

    for i := 1 to RowCount - 1 do
    begin
      for j := 0 to ColCount - 1 do
      begin
        Cells[j, i] := '';
      end;
    end;
  end;
  sgIn.Alignments[0, 0] := taCenter;
  sgIn.Alignments[1, 0] := taCenter;
  sgIn.Alignments[2, 0] := taCenter;
  sgIn.Alignments[3, 0] := taCenter;
  sgIn.Alignments[4, 0] := taCenter;
  sgIn.Alignments[5, 0] := taCenter;
  sgIn.Alignments[6, 0] := taCenter;
  sgIn.Alignments[7, 0] := taCenter;

  with sgOut do
  begin
    Cells[0, 0] := '차량종류';
    Cells[1, 0] := '출차일자';
    Cells[2, 0] := '출차시각';
    Cells[3, 0] := '차량번호';
    Cells[4, 0] := '소    속';
    Cells[5, 0] := '성명';
    Cells[6, 0] := '유효기간';
    Cells[7, 0] := '주차요금';

    for i := 1 to RowCount - 1 do
    begin
      for j := 0 to ColCount - 1 do
      begin
        Cells[j, i] := '';
      end;
    end;
  end;
  sgOut.Alignments[0, 0] := taCenter;
  sgOut.Alignments[1, 0] := taCenter;
  sgOut.Alignments[2, 0] := taCenter;
  sgOut.Alignments[3, 0] := taCenter;
  sgOut.Alignments[4, 0] := taCenter;
  sgOut.Alignments[5, 0] := taCenter;
  sgOut.Alignments[6, 0] := taCenter;
  sgOut.Alignments[7, 0] := taCenter;
end;

procedure TfrmMainNew.T_ProcClear;
begin
  with T_Proc do
  begin
    bHuilProc := False;
    bWEProc := False;
    sWESTTime := '';
    nDayMax := 0;
    nTotMax := 0;
    nNormalCnt := 0;
    nHolidayCnt := 0;
    nNowNDiv := 1;
    nNowHDiv := 1;
  end;
  nYogum := 0;
  sChkDateTime := '';
  sNextDateTime := '';
end;

procedure TfrmMainNew.ClearGTime;
begin
  with GTime do
  begin
    GT1  := '00:00';
    GT2  := '00:00';
    GT3  := '00:00';
    GT4  := '23:59';
    GT5  := '00:00';
    GT6  := '00:00';
    GT7  := '23:59';
    GT8  := '00:00';
    GT9  := 0;
    GT10 := '00:00';
    GT11 := '00:00';
  end;
end;

procedure TfrmMainNew.comMSReaderTriggerAvail(CP: TObject; Count: Word);
var
  sRecv, sTime: AnsiString;
  i: Integer;
  tTime: TDateTime;
  nTDUnitNo: Byte;
  sTDTKNo, sTDTKDate, sTDTKTime: aString;
begin
  try
    sRecv:= '';

    for i:= 1 to Count do
      sRecv:= sRecv + comMSReader.GetChar;

    sMGTK:= sMGTK + sRecv;

    //ExceptLogging('< 바코드 STX POS : ' + IntToStr(Pos(STX, sBarcodeTK)));
    //ExceptLogging('< 바코드 ETX POS : ' + IntToStr(Pos(ETX, sBarcodeTK)));
    //ExceptLogging('< 바코드 데이터 수신 : ' + toHex(sBarcodeTK));

    // ACK, NACK 처리 안하고 앞 1Byte 잘라냄.
    if (sMGTK[1] = AnsiChar($06)) or (sMGTK[1] = AnsiChar($15)) then
    begin
      case sMGTK[1] of
        AnsiChar($06):
        begin
          VRM100PLog('[VRM-100P] Terminal -> Host : Recv ACK');
        end;
        AnsiChar($15):
        begin
          VRM100PLog('[VRM-100P] Terminal -> Host : Recv NACK');
        end;
      end;
      // 자르는 부분
      if Length(aString(sMGTK)) > 1 then
      begin
        sMGTK := Copy(sMGTK, Pos(STX, sMGTK), Length(aString(sMGTK)));
      end;
    end;

    // 첫 Byte가 STX이고, 전체 데이터에서 ETX가 존재하며, ETX가 STX 뒤인경우.
    if (Pos(STX, sMGTK) = 1)
      AND (Pos(ETX, sMGTK) > Pos(STX, sMGTK)) then
    begin
      // ExceptLogging('Terminal -> Host : Bytes = ' + toHex(sBarcodeTK));
      VRM100PLog('[VRM-100P] Terminal -> Host : Command = ' + sMGTK[2]);
      // 두번째 Byte는 Ascii 형태의 Command
      case sMGTK[2] of
        'r': // read
          begin
            edtMGReader.Text := copy(sMGTK, 3, 27);
            VRM100PLog('[VRM-100P] Terminal -> Host : Read = ' + edtMGReader.Text);
            // 정상적으로 읽은경우 함수 호출
            btnMGReaderClick(self);

          end;
        'e': // error
          begin
            VRM100PLog('[VRM-100P] Terminal -> Host : Error');
            case sMGTK[3] of
              'a': begin VRM100PLog('[VRM-100P] Error : 카드데이타 check sum 오류'); ShowMessage('[VRM-100P] Error : 카드데이타 check sum 오류'); end;
              'b': begin VRM100PLog('[VRM-100P] Error : 프린트 오류'); ShowMessage('[VRM-100P] Error : 프린트 오류'); end;
              'c': begin VRM100PLog('[VRM-100P] Error : Download 데이타 저장 오류'); ShowMessage('[VRM-100P] Error : Download 데이타 저장 오류'); end;
              'd': begin VRM100PLog('[VRM-100P] Error : Card 걸림'); ShowMessage('[VRM-100P] Error : Card 걸림'); end;
              'e': begin VRM100PLog('[VRM-100P] Error : RTC 시간 손상'); ShowMessage('[VRM-100P] Error : RTC 시간 손상'); end;
              'f': begin VRM100PLog('[VRM-100P] Error : 이상 기온'); ShowMessage('[VRM-100P] Error : 이상 기온'); end;
              'g': begin VRM100PLog('[VRM-100P] Error : 카드데이타오류, 데이타 없음'); ShowMessage('[VRM-100P] Error : 카드데이타오류, 데이타 없음'); end;
              'i': begin VRM100PLog('[VRM-100P] Error : 통신명령어 오류(알수 없는 명령)'); ShowMessage('[VRM-100P] Error : 통신명령어 오류(알수 없는 명령)'); end;
              'j': begin VRM100PLog('[VRM-100P] Error : 자기 데이타 기록 오류'); ShowMessage('[VRM-100P] Error : 자기 데이타 기록 오류'); end;
              'k': begin VRM100PLog('[VRM-100P] Error : 발행 오류'); ShowMessage('[VRM-100P] Error : 발행 오류'); end;
              'l': begin VRM100PLog('[VRM-100P] Error : 프린트라인 오류'); ShowMessage('[VRM-100P] Error : 프린트라인 오류'); end;
              'm': begin VRM100PLog('[VRM-100P] Error : 카드없음'); ShowMessage('[VRM-100P] Error : 카드없음'); end;
            end;
          end;
        'o': // status
          begin
            VRM100PLog('[VRM-100P] Terminal -> Host : Status');
            case sMGTK[3] of
              'Q': begin VRM100PLog('[VRM-100P] Status : 거래 완료'); end;
              'R': begin VRM100PLog('[VRM-100P] Status : 카드삽입을 기다림'); end;
              'W': begin VRM100PLog('[VRM-100P] Status : 현재명령완료(수신가능상태)'); end;
              'X': begin VRM100PLog('[VRM-100P] Status : 수신불가능,현재명령수행시작'); end;
            end;
          end;
        else // etc
          begin

          end;
      end;

      // 어떤 데이터가 들어오던 그냥 ACK 전송. Retry 버림.
      // Force ACK transfer 필요시 NACK 로직 구현
      comMSReader.PutString(AnsiChar($06));
      VRM100PLog('[VRM-100P] Host -> Terminal : Send ACK');

      // 할인권 배출
      // 데이터를 읽었거나, error 이면서 Card 걸림 또는 카드없음이 아닌경우.
      // card 걸림이나 카드없음이 날아왔을때 ack를 보내는 것은 괜찮으나, 카드 배출 날리면
      // 똑같은 카드 없다고 계속 보내서 무한루프 돌게됨.
      if comMSReader.Open and
        (sMGTK[2] = 'r') or
        ((sMGTK[2] = 'e') and (sMGTK[3] <> 'm' ) and (sMGTK[3] <> 'd' )) then
      begin
        // sleep 없이 날렸더니 전문이 씹힘.
        sleep(100);
        // VRM-100P
        // VRM_Omit_Card = STX + AnsiChar($58) + ETX + AnsiChar($59);
        // ETX 다음에 붙은 0x59는 LRC임.
        // LRC는 전문 모두 XOR하여 사용.
        comMSReader.PutString(VRM_Omit_Card);
        VRM100PLog('[VRM-100P] Host -> Terminal : Omit');
      end
      else if not comMSReader.Open then
      begin
        VRM100PLog('[VRM-100P] Com is Disconnected');
        ShowMessage('[VRM-100P] Com is Disconnected. 프로그램을 다시 실행하십시오.');
      end;
      // 할인권을 연속으로 넣으면 한번씩 전문이 두개 붙어서 날아와서 예외처리.
      // 처리한 전문을 ETX 다음 바이트(LRC) 까지 잘라버리고 뒷 전문을 저장해둠.
      if (Length(aString(sMGTK)) > Pos(ETX, sMGTK) + 1) then
      begin
        sMGTK := Copy(sMGTK, Pos(ETX, sMGTK) + 2, Length(aString(sMGTK)));
      end
      // 전문의 길이가 딱 맞으면 Clear.
      else
      begin
        sMGTK := '';
      end;
    end
    // 전문이 완성되지 않은경우
    // ex) STX와 DATA는 받았으나 ETX 혹은 LRC가 아직 안들어온 경우.
    else
    begin
      // 전문이 유실되어 STX가 첫 Byte가 아닌 중간에 껴있는경우 STX앞 삭제.
      if Pos(STX, sMGTK) > 1 then
      begin
        sMGTK := Copy(sMGTK, Pos(STX, sMGTK), Length(aString(sMGTK)));
      end;
      // 델파이 Com 컴포넌트가 계속 폴링을 하는 방식으로 보여지는데
      // 함수를 종료하는 exit는 없어도 무관해 보이지만
      // 원래 바코드 리더기 함수에 적혀있길래 그냥 내비둠.
      Exit;
    end;

  except
    on E: Exception  do ExceptLogging('TfrmMainNew.comScannerTriggerAvail: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.comScannerTriggerAvail(CP: TObject; Count: Word);
var
  sRecv: AnsiString;
  i: Integer;
  nDCNo : Integer;
  sProcDate, sBarcodeTKNo, sNowDate, sPreDate : aString;

  sOCSCarNo : aString;
  sLastUPDT : aString;
  nSeqNo : Integer;

  //디비 속도 향상 (OCS)
  SQL_Field, SQL_Field2, SQL_Field3, SQL_Field4, SQL_Field5: TField;
  //디비 속도 향상
  SQL_Field6, SQL_Field7, SQL_Field8, SQL_Field9, SQL_Field10: TField;
  sDISCFLAG, sDISCCD, sRCPTDD, nPID, sHANDICAPRYN : aString;
  sDspIP : aString;
begin
  //바코드값이 STX ETX가 없으므로, 바코드 인식시 문자열 'CR'을 추가로 들어오게 만들어 ETX처럼 사용하게 하도록 설정필요
  try
  try
    overUseTime := 0; //장례식장 바코드 주차 초과 시간 초기화
    bIsPatientUse := 0; //OCS할인 처리여부
    sDCInTime2 := '';
    //sRecv:= '';
    for i:= 1 to Count do
      sRecv:= sRecv + comScanner.GetChar;

    sBarcodeTK:= sBarcodeTK + sRecv;
    ExceptLogging('[바코드데이터] ' + '('+sBarcodeTK+')' + toHex(sBarcodeTK));

    //if (Pos(CR, sBarcodeTK) > 0) and (Pos(LF, sBarcodeTK) > 0)  then begin
    if (Pos(CR, sBarcodeTK) > 0) and (Pos(LF, sBarcodeTK) > 0)   then begin
      if (edtProcYogum.Text <> '0') then begin
        //디비 속도 향상
        SQL_Field := TField.Create(self);
        SQL_Field2 := TField.Create(self);
        SQL_Field3 := TField.Create(self);
        SQL_Field4 := TField.Create(self);
        SQL_Field5 := TField.Create(self);


        ExceptLogging('요금정산중['+lbInCarNo.Caption+', '+edtProcYogum.Text+'] : ' + toHex(sBarcodeTK));
        //대전성모병원 바코드타입 2개
        //1. 넥스파 발권 바코드(장례식장용, 2H, 16자리)
        //2. 대전성모 환자 진료영수증 양식(길이값 제외 양식 자체가 없음)
        //3. 전액 무료 바코드 추가
  //      Sleep(1000);
        if Length(sBarcodeTK) = 18 then begin
          {$REGION '넥스파 발권 바코드(장례식장) 시간별 할인 바코드'}
//          CodeSite.Send('통과',sBarcodeTK);
//          sBarcodeTK:='';
//          Exit;

          if Pos(CR, sBarcodeTK) <= 0 then begin
            Exit;
          end;

          if Pos(CR, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(CR, sBarcodeTK) - 1);
          end;

          if Pos(LF, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(LF, sBarcodeTK) - 1);
          end;

          bufBarc := sBarcodeTK;
          ExceptLogging('[최종바코드] '+bufBarc);

          //바코드할인권 기존 13자리에서 16자리로 변경
          if Length(sBarcodeTK) < 16 then begin
            ShowMessage('유효한 할인권이 아닙니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
            ExceptLogging('바코드 자리수 에러 : ' + IntToStr(Length(sBarcodeTK)));
            sBarcodeTK:= '';
            Exit;
          end;

          //바코드할인권...
          //16자리의 정의
          //예) 9913071601000002   -> 앞에 처음 두자리는 할인권 식별자며 99 or 82로 들어온 16자리 바코드는 할인권으로 간주함
          //                       -> 앞에서 세번부터 1자리인 1은 장비코드 처리
          //                       -> 앞에서 네번째부터 2자리인 30은 할인코드 사용(01~99)
          //                       -> 앞에서 여섯번째자리 부터 6글자는 발행일자로 YYMMDD
          //                       -> 그 다음 다섯자리는 일련번호

          if (Length(sBarcodeTK) = 16) and
             ((Pos('99', sBarcodeTK) > 0) or
              (Pos('82', sBarcodeTK) > 0)) then begin
            //넥스파 바코드 할인권
            with dmTables.qryDCTemp do begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from UsedBarcodeData where barcodeData = :N1 ') ;
              Parameters.ParamByName('N1').Value:= sBarcodeTK;
              Open;

              //바코드 중복체크
              if RecordCount > 0 then
              begin
                ShowMessage('이미 사용된 바코드입니다. 확인해 주세요');
                ExceptLogging('이미 사용된 바코드 데이터 : ' + sBarcodeTK);
                sBarcodeTK:= '';
                Exit;
              end
              else
              begin
                if sNowInTKNo <> '' then begin
                  //입차데이터 있을시에만 바코드 처리가능.
                  Close;
                  SQL.Clear;
                  SQL.Add('Select * from UsedBarcodeData where TKNo = :TKNo ') ;
                  Parameters.ParamByName('TKNo').Value:= sNowInTKNo;
                  Open;

                  if RecordCount > 0 then begin
                    //현재입차 이미 바코드 등록되어 있음.
                    ShowMessage('이미 바코드 할인을 받은 차량입니다. 확인해 주세요');
                    ExceptLogging('바코드로 기할인처리된 차량 : ' + sNowInTKNo);
                    sBarcodeTK:= '';
                    Exit;
                  end else begin
                    Close;
                    SQL.Clear;
                    SQL.Add('Insert Into UsedBarcodeData ');
                    SQL.Add
                      ('(ParkNo, ProcDate, ProcTime, TKNo, barcodeData, Amt) ');
                    SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
                    Parameters.ParamByName('N1').Value := nCurrParkNo;
                    Parameters.ParamByName('N2').Value := Copy(lbInTime.Caption , 1, 10);
                    Parameters.ParamByName('N3').Value := Copy(lbInTime.Caption , 12, 8);;
                    Parameters.ParamByName('N4').Value := sNowInTKNo;
                    Parameters.ParamByName('N5').Value := sBarcodeTK;
                    Parameters.ParamByName('N6').Value := 0;
                    ExecSQL;
                  end;
                end else begin
                  ExceptLogging('현재 요금계산중이 아님 : ' + sBarcodeTK);
                  sBarcodeTK:= '';
                  Exit;
                end;
              end;
            end;

      //      nDCNo := StrToInt(Copy(sBarcodeTK, 4, 2));
      //      sProcDate := Copy(sBarcodeTK, 6, 6);
      //      sBarcodeTKNo := Copy(sBarcodeTK, 12, 5);

      //      BarCodeDCDetail(nDCNo);
            BarCodeDCProc(sNowInTKNo,bufBarc);
            sBarcodeTK:= '';
          end else begin
            ShowMessage('할인권 데이터 오류입니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
            sBarcodeTK:= '';
            Exit;
          end;
          {$ENDREGION}
        end else if Length(sBarcodeTK) = 19 then begin
          {$REGION '넥스파 발권 바코드 전액무료'}

          if Pos(CR, sBarcodeTK) <= 0 then begin
            Exit;
          end;

          if Pos(CR, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(CR, sBarcodeTK) - 1);
          end;

          if Pos(LF, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(LF, sBarcodeTK) - 1);
          end;

          bufBarc := sBarcodeTK;
          ExceptLogging('[최종바코드(전액무료)] '+bufBarc);

          //바코드할인권 17자리
          if Length(sBarcodeTK) < 17 then begin
            ShowMessage('유효한 할인권이 아닙니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
            ExceptLogging('바코드 자리수 에러 : ' + IntToStr(Length(sBarcodeTK)));
            sBarcodeTK:= '';
            Exit;
          end;

          if (Length(sBarcodeTK) = 17) and
             ((Pos('99', sBarcodeTK) > 0) or
              (Pos('82', sBarcodeTK) > 0)) then begin
             //넥스파 바코드 할인권 (전액무료)
             ExceptLogging('전액무료 바코드 데이터 : ' + sBarcodeTK);
             bufBarc := sBarcodeTK;
             BarCodeDCProc(sNowInTKNo,bufBarc);
             sBarcodeTK:= '';
             sRecv:= '';
             Exit;
          end;
          {$ENDREGION}
        end else if (Length(sBarcodeTK) >= 3) and (Length(sBarcodeTK) <= 17) then begin
          {$REGION '대전성모 바코드 양식'}
          //프린터에서 CR설정을 했으므로 CR이안들어오면 ETX가 없는것 > 문자열 저장후 추가데이터 수신대기
          //대전성모병원 바코드 양식 : 길이 3~10자리..
          //자릿수 제외 STX 혹은 key value 등 데이터값 규약이 아예없음.(그냥 숫자 n자리~n자리)
          if Pos(CR, sBarcodeTK) <= 0 then begin
            Exit;
          end;

          if Pos(CR, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(CR, sBarcodeTK) - 1);
          end;

          if Pos(LF, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(LF, sBarcodeTK) - 1);
          end;

          bufBarc := sBarcodeTK;
          ExceptLogging('[최종바코드] '+bufBarc);

          //환자번호 가져오기
          {for i := 1 to 50 do //환자번호 가져오기
          begin
            DCProc[i].sDCTKNo := bufBarc;
          end;

          //10.20 바코드로 당일 중복 불가
          with dmTables.qryDCTemp do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from UsedBarcodeData WITH(NOLOCK) where barcodeData = :N1 and ProcDate = :N2 ') ;
            Parameters.ParamByName('N1').Value:= sBarcodeTK;
            Parameters.ParamByName('N2').Value:= FormatDateTime('yyyy-mm-dd', now);
            Open;

            if RecordCount > 0 then
            begin
              ShowMessage('이미사용된바코드입니다.'+ #13#10 + '바코드 : '+ bufBarc);
              sBarcodeTK :='';
              EndProgress;
              Exit;
            end
            else
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert Into UsedBarcodeData ');
              SQL.Add
                ('(ParkNo, ProcDate, ProcTime, TKNo, barcodeData, Amt) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := FormatDateTime('yyyy-mm-dd', now);//Copy(lbInTime.Caption , 1, 10);
              Parameters.ParamByName('N3').Value := FormatDateTime('hh:mm:ss', now);//Copy(lbInTime.Caption , 12, 8);
              Parameters.ParamByName('N4').Value := sNowInTKNo;
              Parameters.ParamByName('N5').Value := sBarcodeTK;
              Parameters.ParamByName('N6').Value := 0;//StrToInt(sBarcodeDCAmt);
              ExecSQL;
            end;
          end;}

//          ExceptLogging('병원 바코드 데이터 ['+IntToStr(Length(bufBarc))+'] : ' + bufBarc);

          //OCS 연동기능 사용시 : 병원쪽에 PID(sBarcodeTK)로 값 조회하여 가져와진 정보로 할인
          //OCS 연동기능 미사용시 : 외래할인(DCNo 1)처리
          if bOCSUse then begin
            {$REGION 'OCS 연동'}
            //OCS TO DO
//            ExceptLogging('OCS연동 사용');

            if nBarcodeOCSPIDIndex = 4 then begin
              nBarcodeOCSPIDIndex := 1;
            end else begin
              nBarcodeOCSPIDIndex := nBarcodeOCSPIDIndex + 1;
            end;

  //          sBarcodeOCSPID[i] := sBarcodeTK;

            nSeqNo := 0;
            with dmTables.qryOCSselect do begin
              //2020-03-31 수정사항 (현장반영 2020-04-07 이후 예정)
              //성모병원측에서 차번없이 PID당 3개씩 PMCMPKBS테이블에 Insert해주기로 함.
              //따라서 케이스는 총 4대까지 나올 수 있음

              //1) PID에 등록된 차량이 없는 경우 => SEQNO가 가장 작은(1) 결과에 업데이트
              //2) PID에 1대 등록된 경우         => SEQNO가 중간인(2) 결과에 업데이트
              //3) PID에 2대 등록된 경우         => SEQNO가 큰(3) 결과에 업데이트
              //4) PID에 3대 등록된 경우         => Updated Date가 가장 옛날인 결과에 업데이트

              //5) 예외처리.. Insert가 안된경우 : Update 하지않음
              //6) 예외처리.. PID당 결과값이 3보다 적거나 많은경우
              Close;
              SQL.Clear;

              SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMCMPKBS where PID = '''+QuotedStr(bufBarc)+''' Order By LASTUPDTDT ASC, SEQNO ASC '')');
              ExceptLogging('[바코드할인] PMCMPKBS 바코드조회 ' + SQL.Text);
              Open;
              if RecordCount > 0 then begin  //무조건 3이 나올것 3개까지 등록가능=>병원에서 3개 무조건  insert하기로
                First;
                bIsPatientUse := 1; //OCS할인 처리
                //가장 오래된 수정일자 가져옴.. 3대 전부 등록되어 있을 경우 사용
                sLastUPDT := Copy(FieldByName('LASTUPDTDT').AsString, 1, 26);  //.... timestamp 소숫점 자리수를 oracle 내에서 상호 다르게줌... (컬럼 자체와 .SSxFF로 조회했을때 자릿수가 달라 Char형으론 조회안됨)

                while not Eof do begin
                  if (Length(FieldByName('CARNO').AsString) < 4) and //차번이 비어있고
                     (nSeqNo = 0)                                   //SeqNo가 이전에 할당받은 적이 없는
                  then begin                                         //Order By ASC라 순서대로 확인..
                    nSeqNo := FieldByName('SEQNO').AsInteger;        //가장 작은 SeqNo 하나만을 저장
                  end;
                  Next;
                end;

                ExceptLogging('[바코드할인] PMCMPKBS조회 할인적용 PID: '+bufBarc);
                //5) PID가 등록되지 않은 경우
                if edtDC.Text = '' then begin
                  ExceptLogging('[바코드할인] 사전할인 미적용으로 PMOVPKDS조회 할인재적용');
                  dmTables.qryOCSselect.Close;
                  dmTables.qryOCSselect.SQL.Clear;
                  dmTables.qryOCSselect.SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMOVPKDS where PID = '''+QuotedStr(bufBarc)+''' '')');
                  ExceptLogging(dmTables.qryOCSselect.SQL.Text);
                  dmTables.qryOCSselect.Open;
                  if dmTables.qryOCSselect.RecordCount > 0 then begin //해당바코드 데이터 = PID 가 있다면 할인
                    SQL_Field := FieldByName('DISCCD');

                    while not eof do
                    begin
                      sDISCCD := SQL_Field.AsString;
                      ExceptLogging('[할인코드]  '+sDISCCD);
                      if sDISCCD = '01' then begin //외래4시간
                        bIsPatientUse := 0; //OCS할인 처리
                        //btnClick(btn2,mnuDC2);
                      end else if sDISCCD = '02' then begin //외래6시간
                        bIsPatientUse := 0; //OCS할인 처리
                        //btnClick(btn3,mnuDC3);
                      end else if sDISCCD = '03' then begin //입원6시간
                         bIsPatientUse := 1; //OCS할인 처리
                        //OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '04' then begin //퇴원6시간
                         bIsPatientUse := 1; //OCS할인 처리
                        //OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '05' then begin //전액무료
                        btnClick(btn6,mnuDC6);
                      end else begin
                      end;
                      Next;
                    end;

                    if sDISCCD <> '05' then     //전액 무료 이외의 OCS 할인
                    begin
                      //OCSDCProcEx(sNowInTKNo,bufBarc); //바코드로 중복 할인 여부 체크
                      OCSDCProc_Ex_Bar(sNowInTKNo,bufBarc); //바코드로 중복 할인 여부 체크
                    end;

                    {while not eof do
                    begin
                      ExceptLogging('[할인코드]  '+sDISCCD);
                      if sDISCCD = '01' then begin //외래4시간
                        btnClick(btn2,mnuDC2);
                      end else if sDISCCD = '02' then begin //외래6시간
                        btnClick(btn3,mnuDC3);
                      end else if sDISCCD = '03' then begin //입원6시간
                        OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '04' then begin //퇴원6시간
                        OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '05' then begin //전액무료
                        btnClick(btn6,mnuDC6);
                      end else begin
                      end;
                      Next;
                    end;}

//                        ExceptLogging('[할인코드]  '+dmTables.qryOCSselect.FieldByName('DISCCD').AsString);
//                        if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '01' then begin //외래4시간
//                          btnClick(btn2,mnuDC2);
//                        end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '02' then begin //외래6시간
//                          btnClick(btn3,mnuDC3);
//                        end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '03' then begin //입원6시간
//                          OCSDCProcEx(sNowInTKNo,bufBarc);
//                        end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '04' then begin //퇴원6시간
//                          OCSDCProcEx(sNowInTKNo,bufBarc);
//                        end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '05' then begin //전액무료
//                          btnClick(btn6,mnuDC6);
//                        end else begin
//                        end;
//    //                    if dmTables.qryOCSselect.FieldByName('HANDICAPRYN').AsString = 'Y' then begin //장애인50%
//    //                      btnClick(btn5,mnuDC5);
//    //                    end;

                  end else begin
                    ExceptLogging('[바코드인식불가] '+bufBarc);
                    MessageBoxTimeOut(Application.Handle, '바코드 인식불가로 재시도바랍니다!'+#13#10+'(2초뒤 화면이 닫힙니다.)', '', 0, 0, 2000);
                    sBarcodeTK:= '';
                    sRecv:= '';
                    Exit;
                  end;
                end;

//                while not Eof do begin
//                  if (Length(FieldByName('CARNO').AsString) < 4) and //차번이 비어있고
//                     (nSeqNo = 0)                                   //SeqNo가 이전에 할당받은 적이 없는
//                  then begin                                         //Order By ASC라 순서대로 확인..
//                    nSeqNo := FieldByName('SEQNO').AsInteger;        //가장 작은 SeqNo 하나만을 저장
//                  end;
//                  Next;
//                end;
//
//                ExceptLogging('[바코드할인] PMCMPKBS조회 할인적용 PID: '+bufBarc);
//                //5) PID가 등록되지 않은 경우
//                if edtDC.Text = '' then begin
//                  ExceptLogging('[바코드할인] 사전할인 미적용으로 PMOVPKDS조회 할인재적용');
//                  dmTables.qryOCSselect.Close;
//                  dmTables.qryOCSselect.SQL.Clear;
//                  dmTables.qryOCSselect.SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMOVPKDS where PID = '''+QuotedStr(bufBarc)+''' '')');
//                  ExceptLogging(dmTables.qryOCSselect.SQL.Text);
//                  dmTables.qryOCSselect.Open;
//                  if dmTables.qryOCSselect.RecordCount > 0 then begin //해당바코드 데이터 = PID 가 있다면 할인
//                    ExceptLogging('[할인코드]  '+dmTables.qryOCSselect.FieldByName('DISCCD').AsString);
//                    if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '01' then begin //외래4시간
//                      btnClick(btn2,mnuDC2);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '02' then begin //외래6시간
//                      btnClick(btn3,mnuDC3);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '03' then begin //입원6시간
//                      OCSDCProcEx(sNowInTKNo,bufBarc);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '04' then begin //퇴원6시간
//                      OCSDCProcEx(sNowInTKNo,bufBarc);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '05' then begin //전액무료
//                      btnClick(btn6,mnuDC6);
//                    end else begin
//                    end;
////                    if dmTables.qryOCSselect.FieldByName('HANDICAPRYN').AsString = 'Y' then begin //장애인50%
////                      btnClick(btn5,mnuDC5);
////                    end;
//                  end else begin
//                    ExceptLogging('[바코드인식불가] '+bufBarc);
//                    MessageBoxTimeOut(Application.Handle, '바코드 인식불가로 재시도바랍니다!'+#13#10+'(2초뒤 화면이 닫힙니다.)', '', 0, 0, 2000);
//                    sBarcodeTK:= '';
//                    sRecv:= '';
//                    Exit;
//                  end;
//                end;

                Close;
                SQL.Clear;
                SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMCMPKBS where PID = '''+QuotedStr(bufBarc)+''' AND CARNO = '''+QuotedStr(sNowLprCarNo1)+''' '')');
                Open;

                if RecordCount > 0 then begin
                  //bIsPatientUse := 1; //OCS할인 처리
                  ExceptLogging('[바코드할인] 기등록차량 할인적용안함 [PID : '+bufBarc+'] [차번 : ' + sNowLprCarNo1 + ']');
                  //수정여부확인(바코드 찍히니 요금이 부과되는 경우가 발생함)
                  //btnClick(btn1, mnuDC1);
                  Exit;
                end else begin
                  //bIsPatientUse := 1; //OCS할인 처리
                  ExceptLogging('[바코드할인] PMCMPKBS에 데이터없음! [PID : '+bufBarc+'] [차번 : ' + sNowLprCarNo1 + ']');
                  if nSeqNo = 0 then begin
                    //while문 돌면서 차번이 비어있는 SeqNo가 없었다. = 3대 풀로 등록되어 있다.
                    //Where절에 LASTUPDTDT를 사용하여 업데이트.
                    Close;
                    SQL.Clear;
                    SQL.Text :=
                      'UPDATE OPENQUERY(' + sLinkedDBName + ',' +
                      ' ''SELECT * FROM '+sOCSDBName+'.PMCMPKBS WHERE PID = ''''' + bufBarc + ''''' ' +
                                                          'AND TO_CHAR(LASTUPDTDT, ''''YYYY-MM-DD HH24:MI:SSxFF'''') = ''''' + sLastUPDT + ''''' '') ' +
                      'SET CARNO = ''' + sNowLprCarNo1 + ''', LASTUPDTDT = GETDATE(), LASTUPDTRID = ''NEXPA'' ';
//                    ExceptLogging('SQL : ' + SQL.Text);
                    ExecSQL;

                    ExceptLogging('['+bufBarc+'] : 차번 OCS 등록 완료 ['+sNowLprCarNo1+'] ..기존데이터 1건 Update');
  //                  btnClick(btn1, mnuDC1);
                  end else begin
                    //while문 돌면서 차번이 비어있는 SeqNo를 찾았다 = 해당 SeqNo가 비어있다.
                    //Where절에 SeqNo를 사용하여 업데이트.
                    Close;
                    SQL.Clear;
                    SQL.Text :=
                      'UPDATE OPENQUERY(' + sLinkedDBName + ',' +
                      ' ''SELECT * FROM '+sOCSDBName+'.PMCMPKBS WHERE PID = ''''' + bufBarc + ''''' AND SEQNO = ''''' + IntToStr(nSeqNo) + ''''' '') ' +
                      'SET CARNO = ''' + sNowLprCarNo1 + ''', LASTUPDTDT = GETDATE(), LASTUPDTRID = ''NEXPA'' ';
//                    ExceptLogging('SQL : ' + SQL.Text);
                    ExecSQL;

                    ExceptLogging('['+bufBarc+'] : 차번 OCS 등록 완료 ['+sNowLprCarNo1+'] ..신규데이터 1건 Update');
  //                  btnClick(btn1, mnuDC1);
                  end;
                end;
                sBarcodeTK := '';
              end else begin
                ExceptLogging('[바코드할인] PMCMPKBS에 데이터없어서 PMOVPKDS조회 할인적용 PID: '+bufBarc);
                //5) PID가 등록되지 않은 경우
                if edtDC.Text = '' then begin
                  ExceptLogging('[바코드할인] 사전할인 미적용으로 PMOVPKDS조회 할인재적용');
                  dmTables.qryOCSselect.Close;
                  dmTables.qryOCSselect.SQL.Clear;
                  dmTables.qryOCSselect.SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMOVPKDS where PID = '''+QuotedStr(bufBarc)+''' '')');
                  ExceptLogging(dmTables.qryOCSselect.SQL.Text);
                  dmTables.qryOCSselect.Open;
                  if dmTables.qryOCSselect.RecordCount > 0 then begin //해당바코드 데이터 = PID 가 있다면 할인
                      SQL_Field := FieldByName('DISCCD');
                      while not eof do
                      begin
                        sDISCCD := SQL_Field.AsString;
                        ExceptLogging('[할인코드]  '+sDISCCD);
                        if sDISCCD = '01' then begin //외래4시간
                          bIsPatientUse := 0; //OCS할인 처리
                          //btnClick(btn2,mnuDC2);
                        end else if sDISCCD = '02' then begin //외래6시간
                          bIsPatientUse := 0; //OCS할인 처리
                          //btnClick(btn3,mnuDC3);
                        end else if sDISCCD = '03' then begin //입원6시간
                           bIsPatientUse := 1; //OCS할인 처리
                          //OCSDCProcEx(sNowInTKNo,bufBarc);
                        end else if sDISCCD = '04' then begin //퇴원6시간
                           bIsPatientUse := 1; //OCS할인 처리
                          //OCSDCProcEx(sNowInTKNo,bufBarc);
                        end else if sDISCCD = '05' then begin //전액무료
                          btnClick(btn6,mnuDC6);
                        end else begin
                        end;
                        Next;
                      end;

                      if sDISCCD <> '05' then    //전액 무료 이외의 OCS 할인
                      begin
                        //OCSDCProcEx(sNowInTKNo,bufBarc); //바코드로 중복 할인 여부 체크
                        OCSDCProc_Ex_Bar(sNowInTKNo,bufBarc); //바코드로 중복 할인 여부 체크
                      end;

//                    ExceptLogging('[할인코드]  '+dmTables.qryOCSselect.FieldByName('DISCCD').AsString);
//                    if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '01' then begin //외래4시간
//                      btnClick(btn2,mnuDC2);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '02' then begin //외래6시간
//                      btnClick(btn3,mnuDC3);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '03' then begin //입원6시간
//                      OCSDCProcEx(sNowInTKNo,bufBarc);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '04' then begin //퇴원6시간
//                      OCSDCProcEx(sNowInTKNo,bufBarc);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '05' then begin //전액무료
//                      btnClick(btn6,mnuDC6);
//                    end else begin
//                    end;
////                    if dmTables.qryOCSselect.FieldByName('HANDICAPRYN').AsString = 'Y' then begin //장애인50%
////                      btnClick(btn5,mnuDC5);
////                    end;
                  end else begin
                    ExceptLogging('[바코드인식불가] '+bufBarc);
                    MessageBoxTimeOut(Application.Handle, '바코드 인식불가로 재시도바랍니다!'+#13#10+'(3초뒤 화면이 닫힙니다.)', '', 0, 0, 2000);
                    sBarcodeTK:= '';
                    sRecv:= '';
                    Exit;
                  end;
                end;
                sBarcodeTK := '';
              end;

              {for i := 1 to 10 do
              begin
                if RLpr[i].nUnitNo = nowLpr.Tag then
                begin
                  sDspIP := RLpr[i].sDspIP;
                  Break;
                end;
              end;
              DspProc(2, 4, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP);}

              if (edtProcYogum.Text = '0') and (bDCZeroButtonOpen = True) then begin
                //DspProc(2, 4, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP);
                ExceptLogging('바코드 버튼 할인후 잔여요금 0원 자동정산');
                btnProcClick(btnProc);
              end;
            end;
            {$ENDREGION}
          end else begin
            {$REGION 'OCS연동 미사용'}
            ExceptLogging('OCS연동 미사용');
            with dmTables.qryDCTemp do begin
              //환자데이터 바코드 중복체크 삭제.. 병원 PID(sBarcodeTK)가 주민번호처럼 환자당 고유인데,
              //재방문한 환자를 전부 차단처리하게되어 제거함
              if sNowInTKNo <> '' then begin
                //입차데이터 있을시에만 바코드 처리가능.
                Close;
                SQL.Clear;
                SQL.Add('Insert Into UsedBarcodeData ');
                SQL.Add
                ('(ParkNo, ProcDate, ProcTime, TKNo, barcodeData, Amt) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
                Parameters.ParamByName('N1').Value := nCurrParkNo;
                Parameters.ParamByName('N2').Value := Copy(lbInTime.Caption , 1, 10);
                Parameters.ParamByName('N3').Value := Copy(lbInTime.Caption , 12, 8);;
                Parameters.ParamByName('N4').Value := sNowInTKNo;
                Parameters.ParamByName('N5').Value := sBarcodeTK;
                Parameters.ParamByName('N6').Value := 0;
                ExecSQL;
                BarCodeDCProc(sNowInTKNo,bufBarc);
              end else begin
                ExceptLogging('현재 요금계산중이 아님 : ' + sBarcodeTK);
              end;
            end;
            {$ENDREGION}
          end;

          sBarcodeTK:= '';
          sRecv:= '';
          Exit;
          {$ENDREGION}
        end else begin
          ExceptLogging(sBarCodeTK + '바코드 데이터 판별불가');
          sBarcodeTK:= '';
          sRecv:= '';
        end;
      end else begin
        ExceptLogging('요금정산중이 아님 : ' + tohex(sBarcodeTK));
        sBarcodeTK := '';
        sRecv:= '';
      end;
      sBarcodeTK := '';
      sRecv:= '';
    end;
  except
    on E: Exception  do begin
      sBarcodeTK := '';
      sRecv:= '';
      ExceptLogging('TfrmMainNew.comScannerTriggerAvail: ' + aString(E.Message));
    end;
  end;
  finally
    //sBarcodeTK := ''; //바코드 데이터  초기화
    //sRecv:= '';
    dmTables.qryOCSselect.Active := False;
  end;
end;

procedure TfrmMainNew.csApsConnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('APS Connect');

  if sApsSendData <> '' then
  begin
    csAps.Socket.SendText(sApsSendData);
    ExceptLogging('운영모드 변경 전송: ' + sApsSendData);
    sApsSendData:= '';
  end;
end;

procedure TfrmMainNew.csApsDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('APS Disconnect');
end;

procedure TfrmMainNew.csApsError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('Aps SocketError: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMainNew.csApsRead(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  //무인요금계산기에서 응답이 들어오면 운영모드를 변경한다...
  try
    sRecv:= Socket.ReceiveText;

    if Pos(STX, sRecv) > 0 then
      sApsRecv := sRecv
    else
      sApsRecv := sApsRecv + sRecv;

    if (Pos(STX, sApsRecv) <= 0) or (Pos(ETX, sApsRecv) <= 0) then
      Exit;

    ExceptLogging('무인정산기 수신 데이터: ' + sApsRecv);

    if sApsRecv = (STX + 'START OK' + ETX) then
    begin
      //무인운영
      FcModeChange(1);
      sApsRecv :='';
    end
    else if sApsRecv = (STX + 'END OK' + ETX) then
    begin
      //유인운영
      FcModeChange(0);
      sApsRecv :='';
    end
    else if sApsRecv = (STX + 'OPENGATE' + ETX) then
    begin
      bMode := False;   //개방운영 변경 응답 수신
      ExceptLogging('개방운영 운영모드 변경 무인기 응답 수신');
      btnMode.Caption := '개방운영';
      btnMode.Tag := 2;
      iSetup.WriteInteger('PARKING', '정산운영', 0);
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '개방운영';
        ExecSQL;
      end;
      ExceptLogging('개방운영 운영모드 변경 처리 완료');
    end
    else if sApsRecv = (STX + 'ENDGATE' + ETX) then
    begin
      bMode := True;    //정산운영 변경 응답 수신
      ExceptLogging('정산운영 변경 확인 무인정산기 응답 수신완료');
      btnMode.Caption := '정산운영' ;
      btnMode.Tag := 1;
      iSetup.WriteInteger('PARKING', '정산운영', 1);
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '정산운영';
        ExecSQL;
      end;
    end;
  except
    on E: Exception do ExceptLogging('csApsRead: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.csInDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp1_Disconnect');
end;

procedure TfrmMainNew.csInDsp1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging((TClientSocket(sender).Host) + ':' + IntToStr(TClientSocket(sender).Port) + ' 소켓 연결끊김 = '+IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMainNew.csInDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp2_Disconnect');
end;

procedure TfrmMainNew.csInDsp2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InDsp2SocketError: ' + IntToStr(ErrorCode));
     ErrorCode := 0;
end;

procedure TfrmMainNew.csInDsp3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp3_Disconnect');
end;

procedure TfrmMainNew.csInDsp3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InDsp3SocketError: ' + IntToStr(ErrorCode));
     ErrorCode := 0;
end;

procedure TfrmMainNew.csInDsp4Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp4_Disconnect');
end;

procedure TfrmMainNew.csInDsp4Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InDsp4SocketError: ' + IntToStr(ErrorCode));
     ErrorCode := 0;
end;

procedure TfrmMainNew.csInDsp5Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp5_Disconnect');
end;

procedure TfrmMainNew.csInDsp5Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InDsp5SocketError: ' + IntToStr(ErrorCode));
     ErrorCode := 0;
end;

procedure TfrmMainNew.csInLpr1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InLpr1_Disconnect');
end;

procedure TfrmMainNew.csInLpr1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging((TClientSocket(sender).Host) + ':' + IntToStr(TClientSocket(sender).Port) + ' 소켓 연결끊김 = '+IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMainNew.csInLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  nCarNoLength : Integer;
  sSend: aString;
begin
  try
  try
    tAlive.Enabled := false;
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sInLPRRecv1 := sRecv;

    if Length(sInLPRRecv1) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csInLpr1.Tag) + ' Recv: ' + sInLPRRecv1);
    end else begin
      StatusLogging('LPR' + IntToStr(csInLpr1.Tag) + ' Recv: ' + sInLPRRecv1);
    end;

    if Length(sInLPRRecv1) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr1.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr1.Tag;
      sLprData := sInLPRRecv1;
      sLprIP := csInLpr1.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr1;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen1 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          if nInProcUse then begin
            with dmTables.qryRecvInLPR1 do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from IONData WITH(NOLOCK) ');
              SQL.Add('where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3 and ParkNo = :N4');
              Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N3').Value := sCarNo1;
              Parameters.ParamByName('N4').Value := nCurrParkNo;
              Open;

              if RecordCount > 0 then
              begin
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
                SQL.Add(
                  'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5 and ParkNo = :N7');
                Parameters.ParamByName('N1').Value := sCarNo2;
                Parameters.ParamByName('N2').Value := sFile2;
                Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
                Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
                Parameters.ParamByName('N5').Value := sCarNo1;
                Parameters.ParamByName('N6').Value := nRecog2;
                Parameters.ParamByName('N7').Value := nCurrParkNo;
                ExecSQL;
              end;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          bInBarOpen1 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
//          // 숭실대 입차 이미지 표시 시작
//          try
//            if is_ping(sLprIP) then
//            begin
//              if FileExists(sImgFile1) then
//              begin
//                imgIn.Picture.LoadFromFile(sImgFile1);
//                lbInCarNo.Caption := sCarNo1;
//              end
//              else
//              begin
//                imgIn.Picture.Assign(Nil);
//                ExceptLogging('File 없음: ' + sImgFile1);
//              end;
//            end
//            else
//            begin
//              imgIn.Picture.Assign(Nil);
//              ExceptLogging('File 없음: ' + sImgFile1);
//            end;
//          except
//            on E: Exception do
//              ExceptLogging('File Load: (' + sImgFile1 + ') ' + aString(E.Message));
//          end;
//          // 숭실대 입차 이미지 표시 종료
          ExceptLogging('File: ' + sImgFile1);
          sFile1 := sImgFile1;
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;
//        nCarNoLength:= Length(sCarNo1);
//        if nCarNoLength =12 then
//        BEGIN
//          ShowMessage(Copy(sCarNo1, 1, 8));
//        END;

        with dmTables.qryInLpr1Proc do
        begin
          Close;
          SQL.Clear;
          // 정기차량조회
          SQL.Add('Select * from CustInfo WITH(NOLOCK) ');

          // 차량 후면 번호가 있으면 차량전면후면 번호로 정기차량 조회
          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          // 차량 전면 번호가 있으면 정기차량 조회
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;

          if RecordCount > 0 then
          begin
            // 등록된 정기차량이면...
            // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
            if bSCProcWait then
            begin
              if nSCWaitPoint = 20 then
                nSCWaitPoint := 1
              else
                nSCWaitPoint := nSCWaitPoint + 1;

              RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
              RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
              RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
              RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
              RSCWait[nSCWaitPoint].sSCIOTime := sTime;
              RSCWait[nSCWaitPoint].nSCLprNo := nNo;
              RSCWait[nSCWaitPoint].nSCInOut := nIO;
              RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
              RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
              RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
              RSCWait[nSCWaitPoint].csSCLPR := csLPR;
              RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen1;

              if not tSCWait.Enabled then
                tSCWait.Enabled := True;
            end
            else
            begin
              sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen1);

              // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
              // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
              GridData(sResult);
            end;
          end
          else
          begin
            // 일반차량 처리...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen1);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv1 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sInLPRRecv1 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('InLPR1 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('InLPR1 - ' + E.Message);
  end;

  finally
     tAlive.Enabled := True;
  end;
end;

procedure TfrmMainNew.csInLpr2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InLpr2_Disconnect');
end;

procedure TfrmMainNew.csInLpr2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InLpr2_SocketError: ' + IntToStr(ErrorCode));
end;

procedure TfrmMainNew.csInLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
  try
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sInLPRRecv2 := sRecv;

    if Length(sInLPRRecv2) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csInLpr2.Tag) + ' Recv: ' + sInLPRRecv2);
    end else begin
      StatusLogging('LPR' + IntToStr(csInLpr2.Tag) + ' Recv: ' + sInLPRRecv2);
    end;

    if Length(sInLPRRecv2) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr2.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr2.Tag;
      sLprData := sInLPRRecv2;
      sLprIP := csInLpr2.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr2;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen2 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          if nInProcUse then begin      
            with dmTables.qryRecvInLPR2 do
            begin
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
              Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N3').Value := sCarNo1;
              Open;

              if RecordCount > 0 then
              begin
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
                SQL.Add(
                  'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
                Parameters.ParamByName('N1').Value := sCarNo2;
                Parameters.ParamByName('N2').Value := sFile2;
                Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
                Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
                Parameters.ParamByName('N5').Value := sCarNo1;
                Parameters.ParamByName('N6').Value := nRecog2;
                ExecSQL;
              end;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          bInBarOpen2 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        with dmTables.qryInLpr2Proc do
        begin
          Close;
          SQL.Clear;
          // 정기차량조회
          SQL.Add('Select * from CustInfo ');

          // 차량 후면 번호가 있으면 차량전면후면 번호로 정기차량 조회
          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          // 차량 전면 번호가 있으면 정기차량 조회
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;
//          Close;
//          SQL.Clear;
//          SQL.Add('Select * from CustInfo ');
//
//          if sCarNo2 <> '' then
//          begin
//            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N2').Value := sCarNo2;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end
//          else
//          if sCarNo1 <> '' then
//          begin
//            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end;

          if RecordCount > 0 then
          begin
            // 등록된 정기차량이면...
            // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
            if bSCProcWait then
            begin
              if nSCWaitPoint = 20 then
                nSCWaitPoint := 1
              else
                nSCWaitPoint := nSCWaitPoint + 1;

              RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
              RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
              RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
              RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
              RSCWait[nSCWaitPoint].sSCIOTime := sTime;
              RSCWait[nSCWaitPoint].nSCLprNo := nNo;
              RSCWait[nSCWaitPoint].nSCInOut := nIO;
              RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
              RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
              RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
              RSCWait[nSCWaitPoint].csSCLPR := csLPR;
              RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen2;

              if not tSCWait.Enabled then
                tSCWait.Enabled := True;
            end
            else
            begin
              sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen2);

              // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
              // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
              GridData(sResult);
            end;
          end
          else
          begin
            // 일반차량 처리...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen2);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr2Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv2 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sInLPRRecv2 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('InLPR2 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('InLPR2 - ' + E.Message);
  end;

  finally

  end;
end;

procedure TfrmMainNew.csInLpr3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InLpr3_Disconnect');
end;

procedure TfrmMainNew.csInLpr3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InLpr3_SocketError: ' + IntToStr(ErrorCode));
end;

procedure TfrmMainNew.csInLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
  try
    sRecv := Socket.ReceiveText;
    sInLPRRecv3 := sRecv;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    if Length(sInLPRRecv3) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csInLpr3.Tag) + ' Recv: ' + sInLPRRecv3);
    end else begin
      StatusLogging('LPR' + IntToStr(csInLpr3.Tag) + ' Recv: ' + sInLPRRecv3);
    end;

    if Length(sInLPRRecv3) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr3.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr3.Tag;
      sLprData := sInLPRRecv3;
      sLprIP := csInLpr3.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr3;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen3 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
            
          if nInProcUse then begin          
            with dmTables.qryRecvInLPR3 do
            begin
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
              Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N3').Value := sCarNo1;
              Open;

              if RecordCount > 0 then
              begin
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
                SQL.Add(
                  'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
                Parameters.ParamByName('N1').Value := sCarNo2;
                Parameters.ParamByName('N2').Value := sFile2;
                Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
                Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
                Parameters.ParamByName('N5').Value := sCarNo1;
                Parameters.ParamByName('N6').Value := nRecog2;
                ExecSQL;
              end;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          bInBarOpen3 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        with dmTables.qryInLpr3Proc do
        begin
          Close;
          SQL.Clear;
          // 정기차량조회
          SQL.Add('Select * from CustInfo ');

          // 차량 후면 번호가 있으면 차량전면후면 번호로 정기차량 조회
          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          // 차량 전면 번호가 있으면 정기차량 조회
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;
//          Close;
//          SQL.Clear;
//          SQL.Add('Select * from CustInfo ');
//
//          if sCarNo2 <> '' then
//          begin
//            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N2').Value := sCarNo2;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end
//          else
//          if sCarNo1 <> '' then
//          begin
//            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end;

          if RecordCount > 0 then
          begin
            // 등록된 정기차량이면...
            // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
            if bSCProcWait then
            begin
              if nSCWaitPoint = 20 then
                nSCWaitPoint := 1
              else
                nSCWaitPoint := nSCWaitPoint + 1;

              RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
              RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
              RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
              RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
              RSCWait[nSCWaitPoint].sSCIOTime := sTime;
              RSCWait[nSCWaitPoint].nSCLprNo := nNo;
              RSCWait[nSCWaitPoint].nSCInOut := nIO;
              RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
              RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
              RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
              RSCWait[nSCWaitPoint].csSCLPR := csLPR;
              RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen3;

              if not tSCWait.Enabled then
                tSCWait.Enabled := True;
            end
            else
            begin
              sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen3);

              // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
              // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
              GridData(sResult);
            end;
          end
          else
          begin
            // 일반차량 처리...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen3;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen3);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr3Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv3 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sInLPRRecv3 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('InLPR3 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('InLPR3 - ' + E.Message);
  end;

  finally

  end;
end;



procedure TfrmMainNew.csInLpr4Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InLpr4_Disconnect');
end;

procedure TfrmMainNew.csInLpr4Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InLpr4_SocketError: ' + IntToStr(ErrorCode));
end;

procedure TfrmMainNew.csInLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
  try
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sInLPRRecv4 := sRecv;

    if Length(sInLPRRecv4) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csInLpr4.Tag) + ' Recv: ' + sInLPRRecv4);
    end else begin
      StatusLogging('LPR' + IntToStr(csInLpr4.Tag) + ' Recv: ' + sInLPRRecv4);
    end;

    if Length(sInLPRRecv4) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr4.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr4.Tag;
      sLprData := sInLPRRecv4;
      sLprIP := csInLpr4.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr4;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        bInBarOpen4 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          if nInProcUse then begin
            with dmTables.qryRecvInLPR4 do
            begin
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
              Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N3').Value := sCarNo1;
              Open;

              if RecordCount > 0 then
              begin
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
                SQL.Add(
                  'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
                Parameters.ParamByName('N1').Value := sCarNo2;
                Parameters.ParamByName('N2').Value := sFile2;
                Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
                Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
                Parameters.ParamByName('N5').Value := sCarNo1;
                Parameters.ParamByName('N6').Value := nRecog2;
                ExecSQL;
              end;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          bInBarOpen4 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        with dmTables.qryInLpr4Proc do
        begin
          Close;
          SQL.Clear;
          // 정기차량조회
          SQL.Add('Select * from CustInfo ');

          // 차량 후면 번호가 있으면 차량전면후면 번호로 정기차량 조회
          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          // 차량 전면 번호가 있으면 정기차량 조회
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;
//          Close;
//          SQL.Clear;
//          SQL.Add('Select * from CustInfo ');
//
//          if sCarNo2 <> '' then
//          begin
//            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N2').Value := sCarNo2;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end
//          else
//          if sCarNo1 <> '' then
//          begin
//            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end;

          if RecordCount > 0 then
          begin
            // 등록된 정기차량이면...
            // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
            if bSCProcWait then
            begin
              if nSCWaitPoint = 20 then
                nSCWaitPoint := 1
              else
                nSCWaitPoint := nSCWaitPoint + 1;

              RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
              RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
              RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
              RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
              RSCWait[nSCWaitPoint].sSCIOTime := sTime;
              RSCWait[nSCWaitPoint].nSCLprNo := nNo;
              RSCWait[nSCWaitPoint].nSCInOut := nIO;
              RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
              RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
              RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
              RSCWait[nSCWaitPoint].csSCLPR := csLPR;
              RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen4;

              if not tSCWait.Enabled then
                tSCWait.Enabled := True;
            end
            else
            begin
              sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen4);

              // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
              // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
              GridData(sResult);
            end;
          end
          else
          begin
            // 일반차량 처리...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen4;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen4);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr4Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv4 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sInLPRRecv4 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('InLPR4 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('InLPR4 - ' + E.Message);
  end;

  finally

  end;
end;

procedure TfrmMainNew.csInLpr5Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InLpr5_Disconnect');
end;

procedure TfrmMainNew.csInLpr5Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('InLpr5_SocketError: ' + IntToStr(ErrorCode));
end;

procedure TfrmMainNew.csInLpr5Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
  try
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sInLPRRecv5 := sRecv;

    if Length(sInLPRRecv5) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csInLpr5.Tag) + ' Recv: ' + sInLPRRecv5);
    end else begin
      StatusLogging('LPR' + IntToStr(csInLpr5.Tag) + ' Recv: ' + sInLPRRecv5);
    end;

    if Length(sInLPRRecv5) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr5.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr5.Tag;
      sLprData := sInLPRRecv5;
      sLprIP := csInLpr5.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr5;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        bInBarOpen5 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
            
          if nInProcUse then begin          
            with dmTables.qryRecvInLPR5 do
            begin
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
              Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N3').Value := sCarNo1;
              Open;

              if RecordCount > 0 then
              begin
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
                SQL.Add(
                  'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
                Parameters.ParamByName('N1').Value := sCarNo2;
                Parameters.ParamByName('N2').Value := sFile2;
                Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
                Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
                Parameters.ParamByName('N5').Value := sCarNo1;
                Parameters.ParamByName('N6').Value := nRecog2;
                ExecSQL;
              end;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          bInBarOpen5 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        with dmTables.qryInLpr5Proc do
        begin
          Close;
          SQL.Clear;
          // 정기차량조회
          SQL.Add('Select * from CustInfo ');

          // 차량 후면 번호가 있으면 차량전면후면 번호로 정기차량 조회
          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          // 차량 전면 번호가 있으면 정기차량 조회
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;
//          Close;
//          SQL.Clear;
//          SQL.Add('Select * from CustInfo ');
//
//          if sCarNo2 <> '' then
//          begin
//            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N2').Value := sCarNo2;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end
//          else
//          if sCarNo1 <> '' then
//          begin
//            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3) and (ExpDateT >= :N4)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
//            Open;
//          end;

          if RecordCount > 0 then
          begin
            // 등록된 정기차량이면...
            // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
            if bSCProcWait then
            begin
              if nSCWaitPoint = 20 then
                nSCWaitPoint := 1
              else
                nSCWaitPoint := nSCWaitPoint + 1;

              RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
              RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
              RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
              RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
              RSCWait[nSCWaitPoint].sSCIOTime := sTime;
              RSCWait[nSCWaitPoint].nSCLprNo := nNo;
              RSCWait[nSCWaitPoint].nSCInOut := nIO;
              RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
              RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
              RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
              RSCWait[nSCWaitPoint].csSCLPR := csLPR;
              RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen5;

              if not tSCWait.Enabled then
                tSCWait.Enabled := True;
            end
            else
            begin
              sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen5);

              // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
              // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
              GridData(sResult);
            end;
          end
          else
          begin
            // 일반차량 처리...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen5;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen5);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr5Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv5 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sInLPRRecv5 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('InLPR5 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('InLPR5 - ' + E.Message);
  end;

  finally

  end;
end;

procedure TfrmMainNew.csOutDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp1_Disconnect');
end;

procedure TfrmMainNew.csOutDsp1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging((TClientSocket(sender).Host) + ':' + IntToStr(TClientSocket(sender).Port) + ' 소켓 연결끊김 = '+IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMainNew.csOutDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp2_Disconnect');
end;

procedure TfrmMainNew.csOutDsp2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('OutDsp2SocketError: ' + IntToStr(ErrorCode));
     ErrorCode := 0;
end;

procedure TfrmMainNew.csOutDsp3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp3_Disconnect');
end;

procedure TfrmMainNew.csOutDsp3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('OutDsp3SocketError: ' + IntToStr(ErrorCode));
     ErrorCode := 0;
end;

procedure TfrmMainNew.csOutLpr1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutLpr1_Disconnect');
end;

procedure TfrmMainNew.csOutLpr1Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging((TClientSocket(sender).Host) + ':' + IntToStr(TClientSocket(sender).Port) + ' 소켓 연결끊김 = '+IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMainNew.csOutLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
  nGroupNo, nNowCarFeeNo :Integer;
  //디비 속도 향상
  OutLpr_Field, OutLpr_Field2: TField;
begin
  try
    OutLpr_Field  := TField.Create(self);
    OutLpr_Field2 := TField.Create(self);

  try
    {$REGION 'LPR데이터 파싱'}
    tAlive.Enabled := false;
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sOutLPRRecv1 := sRecv;
    nNowCarFeeNo := 0;

    if Length(sOutLPRRecv1) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csOutLpr1.Tag) + ' Recv: ' + sOutLPRRecv1);
    end else begin
      StatusLogging('LPR' + IntToStr(csOutLpr1.Tag) + ' Recv: ' + sOutLPRRecv1);
    end;

    if nFCMode = 1 then begin
      exit;
    end;

    if Length(sOutLPRRecv1) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr1.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr1.Tag;
      sLprData := sOutLPRRecv1;
      sLprIP := csOutLpr1.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr1;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;
        BarCodeDC_Yogum := 0; //장례식장 요금 적용 초기화

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR1 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData WITH(NOLOCK) where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
          sFile1 := sImgFile1;
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
          sFile2 := sImgFile2;
        end;

        {$ENDREGION}


        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        //nIO를 LPR정보가 아닌 수신데이터 채널로 변경할경우,
        //동일 LPR에서 입차 출차 정보를 보내도 분기 처리가 가능해진다.
        //다만 현재 LPR에서 가져오게 되어있는데, 현재상태로는 출차에서 입차처리 접근하면 설정이 잘못된 부분임.

        with dmTables.qryOutLpr1Proc do
        begin
          dmTables.qryOutLpr1Proc.DisableControls;
          Close;
          SQL.Clear;
          SQL.Add('Select * from CustInfo WITH(NOLOCK) ');

          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2))  and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3)  and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;
          if RecordCount > 0 then
          begin
            ExceptLogging('정기차량 확인 ['+sCarNo1+', '+sCarNo2+']');
            // 등록된 정기차량이면...
            sExpDateF := FieldByName('ExpDateF').AsString;
            sExpDateT := FieldByName('ExpDateT').AsString;
            nGroupNo :=  FieldByName('GroupNo').AsInteger;
            with dmTables.qryRecvLpr2 do
            begin
              Close;
              SQL.Clear;
              //GGroupDepth
              SQL.Add('Select * from GGroup WITH(NOLOCK) where ParkNo = :N1 and GroupNo = :N2');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nGroupNo;
              Open;

              if RecordCount > 0 then
              begin
                //nNowCarFeeNo := FieldByName('useFeeItem').AsInteger;
                //nUseMiddle := FieldByName('useMiddle').AsInteger;
                //21.03.15 디비속도향상
                OutLpr_Field := FieldByName('useFeeItem');
                OutLpr_Field2 := FieldByName('useMiddle');

                nNowCarFeeNo := OutLpr_Field.AsInteger;
                nUseMiddle := OutLpr_Field2.AsInteger;
              end;
            end;
            if (sExpDateF <= FormatDateTime('YYYY-MM-DD', Now)) and
              (sExpDateT >= FormatDateTime('YYYY-MM-DD', Now)) and (nUseMiddle = 0) and (nNowCarFeeNo = 0) then
            begin
              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                ExceptLogging('일반 정기차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 정기차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                  nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True);

                // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
                // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
                GridData(sResult);
              end;
            end
            else
            begin
              ExceptLogging('정기차량 예외 처리 시작(요금부과, 중간입차, 기간만료) ['+sCarNo1+', '+sCarNo2+']');
              // 일반차량처리...
              if nIO = 1 then
              begin
                {$REGION '접근불가'}
                ExceptLogging('출차LPR 로 입차 데이터 수신.. 장비 설정 확인 필요');
                if bNCInProcWait then
                begin
                  ExceptLogging('정기 미등록차량 입차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].bBarOpen := True;
                  RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  ExceptLogging('정기 미등록차량 입차 처리 ['+sCarNo1+', '+sCarNo2+']');
                  NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True);

                  //만약 이쪽으로 접근시, 정기차량 요금부과에 대해서는 RecvLprProc함수로 입차처리해주는게 맞음.
                  //현재는 그냥 분기처리로 인해 일반차량 입차처리가 되어버림)
                end;
                {$ENDREGION}
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  ExceptLogging('정기 미등록차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].nNCCharo := 1;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                  RNCOutWait[nNCOutWaitPoint].nFeeNo := nNowCarFeeNo;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  nUseFeeItem := nNowCarFeeNo;
                  ExceptLogging('정기 미등록차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                  nNowCharo := 1;
                  NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True);
                end;
              end;
            end;
          end
          else
          begin
            ExceptLogging('미등록차량 확인 ['+sCarNo1+', '+sCarNo2+']');
            // 일반차량 처리...
            if nIO = 1 then
            begin
              {$REGION '접근불가'}
              ExceptLogging('출차LPR 로 입차 데이터 수신.. 장비 설정 확인 필요');
              if bNCInProcWait then
              begin
                ExceptLogging('일반 미등록차량 입차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := True;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 미등록차량 입차 처리 ['+sCarNo1+', '+sCarNo2+']');
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
              {$ENDREGION}
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                ExceptLogging('일반 미등록차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].nNCCharo := 1;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                nNowCharo := 1;
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
          dmTables.qryOutLpr1Proc.EnableControls;
        end;
      except
        on E: Exception do
          ExceptLogging('csOutLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv1 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sOutLPRRecv1 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('OutLPR1 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('OutLPR1 - ' + E.Message);
  end;
  finally
     tAlive.Enabled := True;
  end;
end;

procedure TfrmMainNew.csOutLpr2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutLpr2_Disconnect');
end;

procedure TfrmMainNew.csOutLpr2Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr2_SocketError: ' + IntToStr(ErrorCode));
end;

procedure TfrmMainNew.csOutLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
  nGroupNo, nNowCarFeeNo: Integer;
begin
  try
  try
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sOutLPRRecv2 := sRecv;
    nNowCarFeeNo := 0;

    if Length(sOutLPRRecv2) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csOutLpr2.Tag) + ' Recv: ' + sOutLPRRecv2);
    end else begin
      StatusLogging('LPR' + IntToStr(csOutLpr2.Tag) + ' Recv: ' + sOutLPRRecv2);
    end;

    if nFCMode = 1 then begin
      exit;
    end;

    if Length(sOutLPRRecv2) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr2.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr2.Tag;
      sLprData := sOutLPRRecv2;
      sLprIP := csOutLpr2.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr2;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR2 do
          begin
            Close;
            SQL.Clear;
            SQL.Add(
              'Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add(
                'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add(
                'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        with dmTables.qryOutLpr2Proc do
        begin
          Close;
          SQL.Clear;
          SQL.Add('Select * from CustInfo ');

          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2))  and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3)  and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;
//          if sCarNo2 <> '' then
//          begin
//            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N2').Value := sCarNo2;
//            Open;
//          end
//          else
//          if sCarNo1 <> '' then
//          begin
//            SQL.Add('where CarNo = :N1 and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Open;
//          end;

          if RecordCount > 0 then
          begin
            ExceptLogging('정기차량 확인 ['+sCarNo1+', '+sCarNo2+']');
            // 등록된 정기차량이면...
            sExpDateF := FieldByName('ExpDateF').AsString;
            sExpDateT := FieldByName('ExpDateT').AsString;
            nGroupNo :=  FieldByName('GroupNo').AsInteger;
            with dmTables.qryRecvLpr2 do
            begin
              Close;
              SQL.Clear;
              //GGroupDepth
              SQL.Add('Select * from GGroup where ParkNo = :N1 and GroupNo = :N2');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nGroupNo;
              Open;

              if RecordCount > 0 then
              begin
                nNowCarFeeNo := FieldByName('useFeeItem').AsInteger;
                nUseMiddle := FieldByName('useMiddle').AsInteger;
              end;
            end;

            if (sExpDateF <= FormatDateTime('YYYY-MM-DD', Now)) and
              (sExpDateT >= FormatDateTime('YYYY-MM-DD', Now)) and (nUseMiddle = 0) and (nNowCarFeeNo = 0) then
            begin
              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                ExceptLogging('일반 정기차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 정기차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                  nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True);

                // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
                // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
                GridData(sResult);
              end;
            end
            else
            begin
              ExceptLogging('정기차량 예외 처리 시작(요금부과, 중간입차, 기간만료) ['+sCarNo1+', '+sCarNo2+']');
              // 일반차량 처리...
              if nIO = 1 then
              begin
                ExceptLogging('출차LPR 로 입차 데이터 수신.. 장비 설정 확인 필요');
                if bNCInProcWait then
                begin
                  ExceptLogging('정기 미등록차량 입차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].bBarOpen := True;
                  RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  ExceptLogging('정기 미등록차량 입차 처리 ['+sCarNo1+', '+sCarNo2+']');
                  NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  ExceptLogging('정기 미등록차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].nNCCharo := 2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                  RNCOutWait[nNCOutWaitPoint].nFeeNo := nNowCarFeeNo;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  nUseFeeItem := nNowCarFeeNo;
                  ExceptLogging('정기 미등록차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                  nNowCharo := 2;
                  NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True);
                end;
              end;
            end;
          end
          else
          begin
            ExceptLogging('미등록차량 확인 ['+sCarNo1+', '+sCarNo2+']');
            // 일반차량 처리...
            if nIO = 1 then
            begin
              ExceptLogging('출차LPR 로 입차 데이터 수신.. 장비 설정 확인 필요');
              if bNCInProcWait then
              begin
                ExceptLogging('일반 미등록차량 입차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := True;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 미등록차량 입차 처리 ['+sCarNo1+', '+sCarNo2+']');
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                ExceptLogging('일반 미등록차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].nNCCharo := 2;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 미등록차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                nNowCharo := 2;
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csOutLpr2Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv2 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sOutLPRRecv2 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('OutLPR2 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('OutLPR2 - ' + E.Message);
  end;

  finally

  end;
end;

procedure TfrmMainNew.csOutLpr3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutLpr3_Disconnect');
end;

procedure TfrmMainNew.csOutLpr3Error(Sender: TObject; Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
  var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr3_SocketError: ' + IntToStr(ErrorCode));
end;

procedure TfrmMainNew.csOutLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT: aString;
  i: Byte;
  sCarNo1, sCarNo2, sTime,  sResult, sTest, sDir, sLocal1,
    sLocal2: aString;
  sFile1, sFile2, sImgFile1, sImgFile2,sTemp: String;
  nRecog1, nRecog2, nIO: Byte;
  hr: HRESULT;
  sSend: aString;
  nGroupNo, nNowCarFeeNo :Integer;
begin
  try
  try
    nNowCarFeeNo := 0;
    sRecv := Socket.ReceiveText;
    if unknownRevData(sRecv) = False then begin
      sRecv := '';
      Exit;
    end else begin

    end;

    sOutLPRRecv3 := sRecv;

    if Length(sOutLPRRecv3) > 15 then begin
      ExceptLogging('LPR' + IntToStr(csOutLpr3.Tag) + ' Recv: ' + sOutLPRRecv3);
    end else begin
      StatusLogging('LPR' + IntToStr(csOutLpr3.Tag) + ' Recv: ' + sOutLPRRecv3);
    end;

    if nFCMode = 1 then begin
      exit;
    end;

    if Length(sOutLPRRecv3) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr3.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csOutLpr3.Tag;
      sLprData := sOutLPRRecv3;
      sLprIP := csOutLpr3.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr3;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR3 do
          begin
            Close;
            SQL.Clear;
            SQL.Add(
              'Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add(
                'Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add(
                'where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 6, 2)
          + '\' + Copy(sTime, 9, 2) + '\' + IntToStr(nNo);

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        sImgFile1 := sDir + '\' + sLocal1;
        sImgFile2 := sDir + '\' + sLocal2;

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
            nIO := RLpr[i].nIO;
        end;

        with dmTables.qryOutLpr3Proc do
        begin
          Close;
          SQL.Clear;
          SQL.Add('Select * from CustInfo ');

          if sCarNo2 <> '' then
          begin
            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2))  and ((ExpDateF <= :N3) and ');
            SQL.Add('(ExpDateT >= :N4)) and TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N2').Value := sCarNo2;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end
          else
          if sCarNo1 <> '' then
          begin
            SQL.Add('where (CarNo = :N1) and ((ExpDateF <= :N3)  and (ExpDateT >= :N4)) and ');
            SQL.Add('TKType = 2 and ParkNo = :N5');
            Parameters.ParamByName('N1').Value := sCarNo1;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := nCurrParkNo;
            Open;
          end;

//          if sCarNo2 <> '' then
//          begin
//            SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Parameters.ParamByName('N2').Value := sCarNo2;
//            Open;
//          end
//          else
//          if sCarNo1 <> '' then
//          begin
//            SQL.Add('where CarNo = :N1 and TKType = 2');
//            Parameters.ParamByName('N1').Value := sCarNo1;
//            Open;
//          end;

          if RecordCount > 0 then
          begin
            ExceptLogging('정기차량 확인 ['+sCarNo1+', '+sCarNo2+']');
            // 등록된 정기차량이면...
            sExpDateF := FieldByName('ExpDateF').AsString;
            sExpDateT := FieldByName('ExpDateT').AsString;
            nGroupNo :=  FieldByName('GroupNo').AsInteger;
            with dmTables.qryRecvLpr2 do
            begin
              Close;
              SQL.Clear;
              //GGroupDepth
              SQL.Add('Select * from GGroup where ParkNo = :N1 and GroupNo = :N2');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nGroupNo;
              Open;

              if RecordCount > 0 then
              begin
                nNowCarFeeNo := FieldByName('useFeeItem').AsInteger;
                nUseMiddle := FieldByName('useMiddle').AsInteger;
              end;
            end;

            if (sExpDateF <= FormatDateTime('YYYY-MM-DD', Now)) and
              (sExpDateT >= FormatDateTime('YYYY-MM-DD', Now)) and (nUseMiddle = 0) and (nNowCarFeeNo = 0) then
            begin
              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                ExceptLogging('일반 정기차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 정기차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                sResult := RecvLprProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime,
                  nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True);

                // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
                // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
                GridData(sResult);
              end;
            end
            else
            begin
              ExceptLogging('정기차량 예외 처리 시작(요금부과, 중간입차, 기간만료) ['+sCarNo1+', '+sCarNo2+']');
              // 일반차량 처리...
              if nIO = 1 then
              begin
                {$REGION '접근불가'}
                if bNCInProcWait then
                begin
                  ExceptLogging('정기 미등록차량 입차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].bBarOpen := True;
                  RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  ExceptLogging('정기 미등록차량 입차 처리 ['+sCarNo1+', '+sCarNo2+']');
                  NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True);
                end;
                {$ENDREGION}
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  ExceptLogging('정기 미등록차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].nNCCharo := 3;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                  RNCOutWait[nNCOutWaitPoint].nFeeNo := nNowCarFeeNo;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  ExceptLogging('정기 미등록차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                  nNowCharo := 3;
                  nUseFeeItem := nNowCarFeeNo;
                  NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True);
                end;
              end;
            end;
          end
          else
          begin
            ExceptLogging('미등록차량 확인 ['+sCarNo1+', '+sCarNo2+']');
            // 일반차량 처리...
            if nIO = 1 then
            begin
              ExceptLogging('출차LPR 로 입차 데이터 수신.. 장비 설정 확인 필요');
              if bNCInProcWait then
              begin
                ExceptLogging('일반 미등록차량 입차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].bBarOpen := True;
                RNCInWait[nNCInWaitPoint].nFeeNo := 0;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 미등록차량 입차 처리 ['+sCarNo1+', '+sCarNo2+']');
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end
            else if nIO = 2 then
            begin
              if bNCOutProcWait then
              begin
                ExceptLogging('일반 미등록차량 출차대기 처리 ['+sCarNo1+', '+sCarNo2+']');
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCOutWait[nNCOutWaitPoint].sNCFile1 := sFile1;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCOutWait[nNCOutWaitPoint].sNCFile2 := sFile2;
                RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCOutWait[nNCOutWaitPoint].nNCCharo := 3;
                RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                RNCOutWait[nNCOutWaitPoint].nFeeNo := 0;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                ExceptLogging('일반 미등록차량 출차 처리 ['+sCarNo1+', '+sCarNo2+']');
                nNowCharo := 3;
                NormalProc(sFile1, sCarNo1, sFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, True);
              end;
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csOutLpr3Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv3 = 'LPR_R' then
      begin
        Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now))
          );
        ExceptLogging('시간동기화 전송');
      end;
    end;
    sOutLPRRecv3 := '';
  except
    on E: ESocketError do
    begin
      ExceptLogging('OutLPR3 - ' + E.Message);
    end;

    on E: Exception do ExceptLogging('OutLPR3 - ' + E.Message);
  end;
  finally

  end;
end;

procedure TfrmMainNew.DBAdvGrid1Click(Sender: TObject);
begin
  if dmTables.qrySCSearch.RecordCount > 0 then
  begin
    sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
    btnSCOut.Enabled := True;
  end
  else
    sManualSCCarNo := '';
end;

procedure TfrmMainNew.DBAdvGrid2Click(Sender: TObject);
begin
  if dmTables.qrySCSearch1.RecordCount > 0 then
  begin
    sManualSCCarNo := dmTables.qrySCSearch1.FieldByName('CarNo').AsString;
    btnManualSCOut.Enabled := True;
  end
  else
  begin
    sManualSCCarNo := '';
    btnManualSCOut.Enabled := False;
  end;
//  if dmTables.qrySCSearch.RecordCount > 0 then
//  begin
//    sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
//    btnManualSCOut.Enabled := True;
//  end
//  else
//  begin
//    sManualSCCarNo := '';
//    btnManualSCOut.Enabled := False;
//  end;
end;

// 바코드할인권 처리...
procedure TfrmMainNew.BarCodeDCDetail(nDiscountCode: Integer);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa, nValue,nValue1, nTimeDC1,nTypeCode: Integer;
  sName, sYogum, sUpche, sCheckDate: aString;
  i, nChk, nDCType: Byte;
  sReserveDiscount : aString;
  nDCFeeno : Integer;
begin
  try
    with dmTables.qryDCTemp do begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= nDiscountCode;
      Open;

      if RecordCount > 0 then begin
        nDCType:= FieldByName('DCType').AsInteger;
        sName:= FieldByName('DCName').AsString;
        nValue:= FieldByName('DCValue').AsInteger;
        sReserveDiscount := FieldByName('Reserve3').AsString;
        nDCFeeno           := FieldByName('FeeNo').AsInteger;
      end;

      //11.25 장례식장, 시간별 할인 바코드
      //시간별 할인 후 남은 시간 주차 요금 부과
      //이전에 로그 기록을 보니 바코드 찍으면 100% 할인이나 추가 요금을 부과하는 경우가 발생함.
      if nDCType = 1 then
      begin
        Close;
        SQL.Clear;
        SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
        Open;
        if RecordCount > 0 then begin
          nowUseTime := Fields[0].AsInteger;
          ExceptLogging('[총 할인 주차시간(분)] '+IntToStr(nValue));
          ExceptLogging('[현재주차시간(분)] '+IntToStr(nowUseTime));
          if nowUseTime > nValue then
          begin
             overUseTime := nowUseTime - nValue; //남은 추차시간 = 총  주차시간 -  할인 시간
             ExceptLogging('[남은 주차시간(분)] '+IntToStr(overUseTime));
          end
          else
          begin
              //남은 추차시간 = 할인 시간 - 총  주차시간
             ExceptLogging('[남은 주차시간(분)2] '+IntToStr(nValue - nowUseTime));
          end;

        end;
      end;
    end;

    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;

    InspectionLog('바코드할인: ' + IntToStr(nDiscountCode) + ', ' +
                               IntToStr(nValue) + ', ' +
                               sName );
    if sReserveDiscount = '1' then
    begin
      if bFreeOneDiscount then
      begin
        InspectionLog('무료권할인제한횟수초과: ' + IntToStr(nDiscountCode) + ', ' +
                                   IntToStr(nValue) + ', ' +
                                   sName );
        ShowMessage('무료권할인제한횟수초과');
        Exit;
      end
      else
      begin
        if nProcYogum > 0 then begin
          Case nDCType of
            0:
              begin // 금액할인.
                nDCCnt := nDCCnt + 1;

                if nProcYogum >= nValue then begin
                  nProcYogum := nProcYogum - nValue;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  nDCYogum := nDCYogum + nValue;
                  nDCYogum := nDCYogum + nJulsa;

                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do begin
                    with frmMainNew do begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do begin
                    nDCNo       := nDiscountCode;
                    sDCName     := sName;
                    nDCAmt      := nValue + nJulsa;
                    nRealDCAmt  := nValue + nJulsa;
                    nDCType     := 0;
                  end;
                end else begin
                  nDCYogum := nDCYogum + nProcYogum;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do begin
                    with frmMainNew do begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do begin
                    nDCNo := nDiscountCode;
                    sDCName := sName;
                    nDCAmt := nValue;
                    nRealDCAmt := nProcYogum;
                    nDCType     := 0;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;

            1:    { TODO  : 웹할인 - 시간할인 }
              begin // 시간할인.
                nDCCnt := nDCCnt + 1;
                //sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
                sDCOutTime := MG_AddTime(lbOutTime.Caption, 0, -nValue, 0, 0);
                if sDCOutTime <lbintime.Caption then
                begin
                  nTimeDC := nProcYogum;
                  DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
                end
                else
                begin
                    //바코드 할인 1. 야간에(00~07), (18~24)는 무조건 최대요금 2000원 적용
                    //바코드 할인 2. 평일에는 10분당 300원 적용
                    nISCCD := '';
                    bIsPatientUse := 0;
                    BarCodeDC_Yogum := 1;
                    if overUseTime > 0 then
                    begin
                      nTimeDC := DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                     PAnsiChar(Copy(sDCOutTime, 1, 16)),3);
                    end
                    else
                    begin
                      nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)),3);

                    end;
                    DCProc[nDCCnt].nRealDCMin := nValue;

//                  nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                                              PAnsiChar(Copy(sDCOutTime, 1, 16)),2);
//                  DCProc[nDCCnt].nRealDCMin := nValue;
//                  nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                      PAnsiChar(Copy(sDCOutTime, 1, 16)));
                end;

                if nProcYogum >= nTimeDC then begin
                  if overUseTime = 0 then //할인 시간이 초과 되지 않는 경우
                  begin
                      nProcYogum := nProcYogum - nTimeDC;
                      nDCYogum := nDCYogum + nTimeDC;     //할인 금액
                  end
                  else   //할인 시간이 초과
                  begin
                      nProcYogum := nTimeDC;
                      nDCYogum := nTotYogum - nTimeDC; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
                  end;
                  //nProcYogum := nProcYogum - nTimeDC;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  //nDCYogum := nDCYogum + nTimeDC;
                  nDCYogum := nDCYogum + nJulsa;
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do begin
                    with frmMainNew do begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                        Copy(sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do begin
                    nDCNo := nDiscountCode;
                    sDCName := sName;
                    if overUseTime > 0 then
                    begin
                      nDCAmt := nTotYogum - nTimeDC;
                      nRealDCAmt := nTotYogum - nTimeDC;
                    end
                    else
                    begin
                      nDCAmt := nTimeDC + nJulsa;
                      nRealDCAmt := nTimeDC + nJulsa;
                    end;
                    sDCTKNo := bufBarc;
                    //nDCAmt := nTimeDC + nJulsa;
                    //nRealDCAmt := nTimeDC + nJulsa;
                    nDCType     := 1;
                  end;
                end else begin
                  nDCYogum := nDCYogum + nTimeDC;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do begin
                    with frmMainNew do begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do begin
                    nDCNo := nDiscountCode;
                    sDCName := sName;
                    nDCAmt := nTimeDC;
                    nRealDCAmt := nProcYogum;
                    sDCTKNo := bufBarc;
                    nDCType     := 1;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;

            2:
              begin // 퍼센트할인.
                nDCCnt := nDCCnt + 1;
                nPerDC := (nProcYogum * nValue) div 100;

                if nProcYogum >= nPerDC then begin
                  nProcYogum := nProcYogum - nPerDC;
                  nJulsa := JulsaProc(nProcYogum);
                  nProcYogum := nProcYogum - nJulsa;
                  nDCYogum := nDCYogum + nPerDC;
                  nDCYogum := nDCYogum + nJulsa;
                  edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;
                  sYogum := IntToStr(nProcYogum);

                  for i := 1 to 6 do begin
                    with frmMainNew do
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                  end;

                  for i := 1 to Length(sYogum) do begin
                    with frmMainNew do begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                        Copy(sYogum, Length(sYogum) - (i - 1), 1);
                    end;
                  end;
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do begin
                    nDCNo := nDiscountCode;
                    sDCName := sName;
                    nDCAmt := nPerDC + nJulsa;
                    nRealDCAmt := nPerDC + nJulsa;
                    nDCType     := 2;
                  end;
                end else begin
                  nDCYogum := nDCYogum + nPerDC;
                  edtDCYogum.Text := IntToStr(nDCYogum);
                  edtDCYogum.AutoThousandSeparator := True;

                  for i := 6 downto 2 do begin
                    with frmMainNew do begin
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                    end;
                  end;
                  lbYogum1.Caption := '0';
                  lbDCName.Caption := sName;

                  with DCProc[nDCCnt] do begin
                    nDCNo := nDiscountCode;
                    sDCName := sName;
                    nDCAmt := nPerDC;
                    nRealDCAmt := nProcYogum;
                    nDCType     := 2;
                  end;
                  nProcYogum := 0;
                  edtProcYogum.Text := '0';
                end;
              end;
          end;
          InspectionLog('바코드할인요금: ' + edtDCYogum.Text);
          if edtDC.Text = '' then
          begin
            edtDC.Text := sName;
          end
          else
          begin
            edtDC.Text := edtDC.Text + ', ' + sName;
          end;
          lbDCName.Caption:= '바코드할인';
          bFreeOneDiscount := True;
          bBarcodeDiscount := True;
        end;
      end;
    end
    else
    begin
      if nProcYogum > 0 then begin
        Case nDCType of
          0:
            begin // 금액할인.
              nDCCnt := nDCCnt + 1;

              if nProcYogum >= nValue then begin
                nProcYogum := nProcYogum - nValue;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nValue;
                nDCYogum := nDCYogum + nJulsa;

                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo       := nDiscountCode;
                  sDCName     := sName;
                  nDCAmt      := nValue + nJulsa;
                  nRealDCAmt  := nValue + nJulsa;
                  nDCType     := 0;
                end;
              end else begin
                nDCYogum := nDCYogum + nProcYogum;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDiscountCode;
                  sDCName := sName;
                  nDCAmt := nValue;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 0;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          1:    { TODO  : 웹할인 - 시간할인 }
            begin // 시간할인.
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
//              nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));

              // Modified by LJH 2019-11-02 16:58:43 DCOutTime가 InTime보다 줄어든경우, Outtime~intime로 시간계산하는문제 확인.
              if sDCOutTime < lbintime.Caption then
              begin
                nTimeDC := nProcYogum;
                DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
                DCProc[nDCCnt].nRealDCMin := nValue;
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;

              if nProcYogum >= nTimeDC then begin
                nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDiscountCode;
                  sDCName := sName;
                  nDCAmt := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCType     := 1;
                end;
              end else begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDiscountCode;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 1;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          2:
            begin // 퍼센트할인.
              nDCCnt := nDCCnt + 1;
              nPerDC := (nProcYogum * nValue) div 100;

              if nProcYogum >= nPerDC then begin
                nProcYogum := nProcYogum - nPerDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nPerDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDiscountCode;
                  sDCName := sName;
                  nDCAmt := nPerDC + nJulsa;
                  nRealDCAmt := nPerDC + nJulsa;
                  nDCType     := 2;
                end;
              end else begin
                nDCYogum := nDCYogum + nPerDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDiscountCode;
                  sDCName := sName;
                  nDCAmt := nPerDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 2;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;
        end;
        InspectionLog('바코드할인요금: ' + edtDCYogum.Text);
        lbDCName.Caption:= '바코드할인';
        bBarcodeDiscount := True;
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.BarCodeDCDetail: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.BarCodeDCProc(sNowTKno,codeStr: String);
var
  nDCNo : Integer;
begin
  if Length(codeStr) = 17 then begin     //21.05.31 전액 무료 바코드 17자리
    nDCNo := StrToInt(Copy(codeStr, 4, 2)); //7;
    ExceptLogging('바코드 데이터 확인(전액무료) : 할인권[' + IntToStr(nDCNo)+ '] 할인처리 시작');
    BarCodeDCDetail(nDCNo);
  end else if Length(codeStr) >= 16 then begin
    nDCNo := StrToInt(Copy(codeStr, 4, 2));

    ExceptLogging('바코드 데이터 확인 : 할인권[' + IntToStr(nDCNo)+ '] 할인처리 시작');
    BarCodeDCDetail(nDCNo);
  end else begin
  //OCS로 이관
    if bOCSUse then begin
      ExceptLogging('대전성모병원 OCS 연동처리');
    end else begin
      ExceptLogging('대전성모병원 바코드 데이터 처리.. DCNo : [1]');
      nDCNo := 1;

      ExceptLogging('바코드 데이터 확인 : 할인권[' + IntToStr(nDCNo)+ '] 할인처리 시작');
      BarCodeDCDetail(nDCNo);
    end;
  end;
end;

procedure TfrmMainNew.BarcodeProc(sSerial, sExpDate, sDCType,
  sDCAmt: AnsiString);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa: Integer;
  sName, sYogum: aString;
  i: Byte;
begin
  try
    if sExpDate < FormatDateTime('YYMMDD', Now) then
    begin
      ShowMessage('유효기간이 경과된 할인권입니다.  유효기간:20' + MG_StrToStr
          (sExpDate, '##-##-##'));
      Exit;
    end;

    for i := 1 to 50 do
    begin
      if DCProc[i].sDCTKNo = sSerial then
      begin
        ShowMessage('방금 사용된 할인권입니다.');
        Exit;
      end;
    end;

    with dmTables.qryDCTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCDetail where DCTKNo = :N1');
      Parameters.ParamByName('N1').Value := sSerial;
      Open;

      if RecordCount > 0 then
      begin
        ShowMessage('이미 사용된 할인권입니다.');
        Exit;
      end;
    end;

    if nProcYogum > 0 then
    begin
      // sName := '할인권할인';

      Case StrToInt(sDCType) of
        0:
          begin // 금액할인.
            nDCCnt := nDCCnt + 1;

            if StrToInt(sDCAmt) = 1200 then
              sDCAmt := '1800';

            if StrToInt(sDCAmt) = 2400 then
              sDCAmt := '3600';

            sName := IntToStr(StrToInt(sDCAmt)) + '원 할인';

            if nProcYogum >= StrToInt(sDCAmt) then
            begin
              nProcYogum := nProcYogum - StrToInt(sDCAmt);
              nJulsa := JulsaProc(nProcYogum);
              nProcYogum := nProcYogum - nJulsa;
              nDCYogum := nDCYogum + StrToInt(sDCAmt);
              nDCYogum := nDCYogum + nJulsa;

              //edtProcYogum.Text := IntToStr(nProcYogum);
              edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
              //edtProcYogum.AutoThousandSeparator := True;
              edtDCYogum.Text := IntToStr(nDCYogum);
              edtDCYogum.AutoThousandSeparator := True;
              sYogum := IntToStr(nProcYogum);

              for i := 1 to 6 do
              begin
                with frmMainNew do
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := False;
              end;

              for i := 1 to Length(sYogum) do
              begin
                with frmMainNew do
                begin
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := True;
                  TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                    (sYogum, Length(sYogum) - (i - 1), 1);
                end;
              end;
              lbDCName.Caption := sName; // edtDCYogum.Text + '원';

              with DCProc[nDCCnt] do
              begin
                nDCNo := 0;
                sDCName := sName;
                nDCAmt := StrToInt(sDCAmt) + nJulsa;
                nRealDCAmt := StrToInt(sDCAmt) + nJulsa;
                sDCTKNo := sSerial;
                nDCType := 0;
              end;
            end
            else
            begin
              nDCYogum := nDCYogum + nProcYogum;
              edtDCYogum.Text := IntToStr(nDCYogum);

              for i := 6 downto 2 do
              begin
                with frmMainNew do
                begin
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := False;
                  TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                end;
              end;
              lbYogum1.Caption := '0';
              lbDCName.Caption := sName; // edtDCYogum.Text + '원';

              with DCProc[nDCCnt] do
              begin
                nDCNo := 0;
                sDCName := sName;
                nDCAmt := StrToInt(sDCAmt);
                nRealDCAmt := nProcYogum;
                sDCTKNo := sSerial;
                nDCType := 0;
              end;
              nProcYogum := 0;
              edtProcYogum.Text := '0';
            end;
          end;

        1:
          begin // 시간할인.
            nDCCnt := nDCCnt + 1;
            sName := IntToStr(StrToInt(sDCAmt)) + '분 할인';
            sDCOutTime := MG_AddTime(sDCOutTime, 0, -StrToInt(sDCAmt), 0, 0);
            if sDCOutTime <lbintime.Caption then
            begin
              nTimeDC := nProcYogum;
              DCProc[nDCCnt].nRealDCMin := StrToInt(sDCAmt) + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
            end
            else
            begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
              nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                PAnsiChar(Copy(sDCOutTime, 1, 16)));
              DCProc[nDCCnt].nRealDCMin := StrToInt(sDCAmt);
//              nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)));
            end;
            // nTimeDC := ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(sDCOutTime, 1, 16)),
            // PAnsiChar(sNowOutDate + ' ' + Copy(sNowOutTime, 1, 5)));

//            nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                              PAnsiChar(Copy(sDCOutTime, 1, 16)));
//            nTimeDC := ReturnFee
//              (nCurrParkNo, nFeeNo, PAnsiChar(Copy(sDCOutTime, 1, 16)),
//              PAnsiChar(sTimeDCOutDate + ' ' + Copy(sTimeDCOutTime, 1, 5)));
            sTimeDCOutDate := Copy(sDCOutTime, 1, 10);
            sTimeDCOutTime := Copy(sDCOutTime, 12, 8);

            if nProcYogum >= nTimeDC then
            begin
              nProcYogum := nProcYogum - nTimeDC;
              nJulsa := JulsaProc(nProcYogum);
              nProcYogum := nProcYogum - nJulsa;
              nDCYogum := nDCYogum + nTimeDC;
              nDCYogum := nDCYogum + nJulsa;
              //edtProcYogum.Text := IntToStr(nProcYogum);
              edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
              //edtProcYogum.AutoThousandSeparator := True;
              edtDCYogum.Text := IntToStr(nDCYogum);
              edtDCYogum.AutoThousandSeparator := True;
              sYogum := IntToStr(nProcYogum);

              for i := 1 to 6 do
              begin
                with frmMainNew do
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := False;
              end;

              for i := 1 to Length(sYogum) do
              begin
                with frmMainNew do
                begin
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := True;
                  TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                    (sYogum, Length(sYogum) - (i - 1), 1);
                end;
              end;
              lbDCName.Caption := sName; // edtDCYogum.Text + '원';

              with DCProc[nDCCnt] do
              begin
                nDCNo := 0;
                sDCName := sName;
                //nDCAmt := nTimeDC + nJulsa;
                //nRealDCAmt := nTimeDC + nJulsa;
                if overUseTime > 0 then
                begin
                  nDCAmt := nTotYogum;
                  nRealDCAmt := nTotYogum - nTimeDC;
                end
                else
                begin
                  nDCAmt := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                end;
                sDCTKNo := sSerial;
                nDCType := 1;
              end;
            end
            else
            begin
              nDCYogum := nDCYogum + nTimeDC;
              edtDCYogum.Text := IntToStr(nDCYogum);

              for i := 6 downto 2 do
              begin
                with frmMainNew do
                begin
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := False;
                  TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                end;
              end;
              lbYogum1.Caption := '0';
              lbDCName.Caption := sName; // edtDCYogum.Text + '원';

              with DCProc[nDCCnt] do
              begin
                nDCNo := 0;
                sDCName := sName;
                nDCAmt := nTimeDC;
                nRealDCAmt := nProcYogum;
                sDCTKNo := sSerial;
                nDCType := 1;
              end;
              nProcYogum := 0;
              edtProcYogum.Text := '0';
            end;
          end;

        2:
          begin // 퍼센트할인.
            nDCCnt := nDCCnt + 1;
            sName := IntToStr(StrToInt(sDCAmt)) + '% 할인';
            nPerDC := (nProcYogum * StrToInt(sDCAmt)) div 100;

            if nProcYogum >= nPerDC then
            begin
              nProcYogum := nProcYogum - nPerDC;
              nJulsa := JulsaProc(nProcYogum);
              nProcYogum := nProcYogum - nJulsa;
              nDCYogum := nDCYogum + nPerDC;
              nDCYogum := nDCYogum + nJulsa;
              //edtProcYogum.Text := IntToStr(nProcYogum);
              edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
              //edtProcYogum.AutoThousandSeparator := True;
              edtDCYogum.Text := IntToStr(nDCYogum);
              edtDCYogum.AutoThousandSeparator := True;
              sYogum := IntToStr(nProcYogum);

              for i := 1 to 6 do
              begin
                with frmMainNew do
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := False;
              end;

              for i := 1 to Length(sYogum) do
              begin
                with frmMainNew do
                begin
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := True;
                  TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                    (sYogum, Length(sYogum) - (i - 1), 1);
                end;
              end;
              lbDCName.Caption := sName; // edtDCYogum.Text + '원';

              with DCProc[nDCCnt] do
              begin
                nDCNo := 0;
                sDCName := sName;
                nDCAmt := nPerDC + nJulsa;
                nRealDCAmt := nPerDC + nJulsa;
                sDCTKNo := sSerial;
                nDCType := 2;
              end;
            end
            else
            begin
              nDCYogum := nDCYogum + nPerDC;
              edtDCYogum.Text := IntToStr(nDCYogum);

              for i := 6 downto 2 do
              begin
                with frmMainNew do
                begin
                  TLabel(FindComponent('lbYogum' + IntToStr(i)))
                    .Visible := False;
                  TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                end;
              end;
              lbYogum1.Caption := '0';
              lbDCName.Caption := sName; // edtDCYogum.Text + '원';

              with DCProc[nDCCnt] do
              begin
                nDCNo := 0;
                sDCName := sName;
                nDCAmt := nPerDC;
                nRealDCAmt := nProcYogum;
                sDCTKNo := sSerial;
                nDCType := 2;
              end;
              nProcYogum := 0;
              edtProcYogum.Text := '0';
            end;
          end;
      end;

      if edtDC.Text = '' then
      begin
        edtDC.Text := sName;
      end
      else
      begin
        edtDC.Text := edtDC.Text + ', ' + sName;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('BarcodeProc: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.BarCodeTest;
var
  sRecv: AnsiString;
  i: Integer;
  nDCNo : Integer;
  sProcDate, sBarcodeTKNo, sNowDate, sPreDate : aString;

  sOCSCarNo : aString;
  sLastUPDT : aString;
  nSeqNo : Integer;

  sPATIENTNO  : array of aString;   //환자번호 변수
  sDCCODE, sDCCODE_PAST : array of aString;   //병원에 등록된 OCS할인정보 변수
  sRECEIPTDATE, sRECEIPTDATE_PAST : array of aString;   //병원에 등록된 수납일자 변수
  sPID, sPID_PAST : array of aString;   //병원에 등록된 PID변수
  logStr: string;
begin
  //바코드값이 STX ETX가 없으므로, 바코드 인식시 문자열 'CR'을 추가로 들어오게 만들어 ETX처럼 사용하게 하도록 설정필요
  try
  try
    sRecv:= '';
    edtProcYogum.Text :='1';
    sBarcodeTK:= sBarcodeTK + sRecv;
//    ExceptLogging('[바코드데이터] ' + '('+sBarcodeTK+')' + toHex(sBarcodeTK));

    if (Pos(CR, sBarcodeTK) > 0) and (Pos(LF, sBarcodeTK) > 0) or (Length(sBarcodeTK) > 0) then begin
      //if (edtProcYogum.Text <> '0') then begin
      if (edtProcYogum.Text <> '0') then begin

        ExceptLogging('요금정산중['+lbInCarNo.Caption+', '+edtProcYogum.Text+'] : ' + toHex(sBarcodeTK));
        //대전성모병원 바코드타입 2개
        //1. 넥스파 발권 바코드(장례식장용, 2H, 16자리)
        //2. 대전성모 환자 진료영수증 양식(길이값 제외 양식 자체가 없음)
  //      Sleep(1000);
        //if Length(sBarcodeTK) = 18 then begin
        if Length(sBarcodeTK) = 16 then begin
          {$REGION '넥스파 발권 바코드(장례식장)'}
//          CodeSite.Send('통과',sBarcodeTK);
//          sBarcodeTK:='';
//          Exit;

          {if Pos(CR, sBarcodeTK) <= 0 then begin
            Exit;
          end;}

          if Pos(CR, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(CR, sBarcodeTK) - 1);
          end;

          if Pos(LF, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(LF, sBarcodeTK) - 1);
          end;

          bufBarc := sBarcodeTK;
          ExceptLogging('[최종바코드] '+bufBarc);

          //바코드할인권 기존 13자리에서 16자리로 변경
          if Length(sBarcodeTK) < 16 then begin
            ShowMessage('유효한 할인권이 아닙니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
            ExceptLogging('바코드 자리수 에러 : ' + IntToStr(Length(sBarcodeTK)));
            sBarcodeTK:= '';
            Exit;
          end;

          //바코드할인권...
          //16자리의 정의
          //예) 9913071601000002   -> 앞에 처음 두자리는 할인권 식별자며 99 or 82로 들어온 16자리 바코드는 할인권으로 간주함
          //                       -> 앞에서 세번부터 1자리인 1은 장비코드 처리
          //                       -> 앞에서 네번째부터 2자리인 30은 할인코드 사용(01~99)
          //                       -> 앞에서 여섯번째자리 부터 6글자는 발행일자로 YYMMDD
          //                       -> 그 다음 다섯자리는 일련번호

          if (Length(sBarcodeTK) = 16) and
             ((Pos('99', sBarcodeTK) > 0) or
              (Pos('82', sBarcodeTK) > 0)) then begin
            //넥스파 바코드 할인권
            {with dmTables.qryDCTemp do begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from UsedBarcodeData where barcodeData = :N1 ') ;
              Parameters.ParamByName('N1').Value:= sBarcodeTK;
              Open;

              //바코드 중복체크
              if RecordCount > 0 then
              begin
                ShowMessage('이미 사용된 바코드입니다. 확인해 주세요');
                ExceptLogging('이미 사용된 바코드 데이터 : ' + sBarcodeTK);
                sBarcodeTK:= '';
                Exit;
              end
              else
              begin
                if sNowInTKNo <> '' then begin
                  //입차데이터 있을시에만 바코드 처리가능.
                  Close;
                  SQL.Clear;
                  SQL.Add('Select * from UsedBarcodeData where TKNo = :TKNo ') ;
                  Parameters.ParamByName('TKNo').Value:= sNowInTKNo;
                  Open;

                  if RecordCount > 0 then begin
                    //현재입차 이미 바코드 등록되어 있음.
                    ShowMessage('이미 바코드 할인을 받은 차량입니다. 확인해 주세요');
                    ExceptLogging('바코드로 기할인처리된 차량 : ' + sNowInTKNo);
                    sBarcodeTK:= '';
                    Exit;
                  end else begin
                    Close;
                    SQL.Clear;
                    SQL.Add('Insert Into UsedBarcodeData ');
                    SQL.Add
                      ('(ParkNo, ProcDate, ProcTime, TKNo, barcodeData, Amt) ');
                    SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
                    Parameters.ParamByName('N1').Value := nCurrParkNo;
                    Parameters.ParamByName('N2').Value := Copy(lbInTime.Caption , 1, 10);
                    Parameters.ParamByName('N3').Value := Copy(lbInTime.Caption , 12, 8);;
                    Parameters.ParamByName('N4').Value := sNowInTKNo;
                    Parameters.ParamByName('N5').Value := sBarcodeTK;
                    Parameters.ParamByName('N6').Value := 0;
                    ExecSQL;
                  end;
                end else begin
                  ExceptLogging('현재 요금계산중이 아님 : ' + sBarcodeTK);
                  sBarcodeTK:= '';
                  Exit;
                end;
              end;
            end;}

      //      nDCNo := StrToInt(Copy(sBarcodeTK, 4, 2));
      //      sProcDate := Copy(sBarcodeTK, 6, 6);
      //      sBarcodeTKNo := Copy(sBarcodeTK, 12, 5);

      //      BarCodeDCDetail(nDCNo);

            BarCodeDCProc(sNowInTKNo,bufBarc);
            sBarcodeTK:= '';
          end else begin
            ShowMessage('할인권 데이터 오류입니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
            sBarcodeTK:= '';
            Exit;
          end;
          {$ENDREGION}
        end else if (Length(sBarcodeTK) >= 3) and (Length(sBarcodeTK) <= 17) then begin
          {$REGION '대전성모 바코드 양식'}
          //프린터에서 CR설정을 했으므로 CR이안들어오면 ETX가 없는것 > 문자열 저장후 추가데이터 수신대기
          //대전성모병원 바코드 양식 : 길이 3~10자리..
          //자릿수 제외 STX 혹은 key value 등 데이터값 규약이 아예없음.(그냥 숫자 n자리~n자리)
          {if Pos(CR, sBarcodeTK) <= 0 then begin
            Exit;
          end;

          if Pos(CR, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(CR, sBarcodeTK) - 1);
          end;

          if Pos(LF, sBarcodeTK) > 0 then begin
            sBarcodeTK := Copy(sBarcodeTK, 1, Pos(LF, sBarcodeTK) - 1);
          end;}

          bufBarc := sBarcodeTK;
          ExceptLogging('[최종바코드] '+bufBarc);

          //환자번호 가져오기
          for i := 1 to 50 do //환자번호 가져오기
          begin
            DCProc[i].sDCTKNo := bufBarc;
          end;
          //10.20 바코드로 당일 중복 불가
          {with dmTables.qryDCTemp do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from UsedBarcodeData where barcodeData = :N1 and ProcDate = :N2 ') ;
            Parameters.ParamByName('N1').Value:= sBarcodeTK;
            Parameters.ParamByName('N2').Value:= FormatDateTime('yyyy-mm-dd', now);
            Open;

            if RecordCount > 0 then
            begin
              ShowMessage('이미사용된바코드입니다.'+ #13#10 + '바코드 : '+ bufBarc);
              sBarcodeTK :='';
              EndProgress;
              Exit;
            end
            else
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert Into UsedBarcodeData ');
              SQL.Add
                ('(ParkNo, ProcDate, ProcTime, TKNo, barcodeData, Amt) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := FormatDateTime('yyyy-mm-dd', now);//Copy(lbInTime.Caption , 1, 10);
              Parameters.ParamByName('N3').Value := FormatDateTime('hh:mm:ss', now);//Copy(lbInTime.Caption , 12, 8);
              Parameters.ParamByName('N4').Value := sNowInTKNo;
              Parameters.ParamByName('N5').Value := sBarcodeTK;
              Parameters.ParamByName('N6').Value := 0;//StrToInt(sBarcodeDCAmt);
              ExecSQL;
            end;
          end;}

//          ExceptLogging('병원 바코드 데이터 ['+IntToStr(Length(bufBarc))+'] : ' + bufBarc);

          //OCS 연동기능 사용시 : 병원쪽에 PID(sBarcodeTK)로 값 조회하여 가져와진 정보로 할인
          //OCS 연동기능 미사용시 : 외래할인(DCNo 1)처리
          if bOCSUse then begin
            {$REGION 'OCS 연동'}
            //OCS TO DO
//            ExceptLogging('OCS연동 사용');

            if nBarcodeOCSPIDIndex = 4 then begin
              nBarcodeOCSPIDIndex := 1;
            end else begin
              nBarcodeOCSPIDIndex := nBarcodeOCSPIDIndex + 1;
            end;

  //          sBarcodeOCSPID[i] := sBarcodeTK;

            nSeqNo := 0;
            with dmTables.qryOCSselect do begin
              //2020-03-31 수정사항 (현장반영 2020-04-07 이후 예정)
              //성모병원측에서 차번없이 PID당 3개씩 PMCMPKBS테이블에 Insert해주기로 함.
              //따라서 케이스는 총 4대까지 나올 수 있음

              //1) PID에 등록된 차량이 없는 경우 => SEQNO가 가장 작은(1) 결과에 업데이트
              //2) PID에 1대 등록된 경우         => SEQNO가 중간인(2) 결과에 업데이트
              //3) PID에 2대 등록된 경우         => SEQNO가 큰(3) 결과에 업데이트
              //4) PID에 3대 등록된 경우         => Updated Date가 가장 옛날인 결과에 업데이트

              //5) 예외처리.. Insert가 안된경우 : Update 하지않음
              //6) 예외처리.. PID당 결과값이 3보다 적거나 많은경우
              Close;
              SQL.Clear;

              SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMCMPKBS where PID = '''+QuotedStr(bufBarc)+''' Order By LASTUPDTDT ASC, SEQNO ASC '')');
//              ExceptLogging('[바코드할인] PMCMPKBS 바코드조회 ' + SQL.Text);
              Open;
              if RecordCount > 0 then begin  //무조건 3이 나올것 3개까지 등록가능=>병원에서 3개 무조건  insert하기로
                First;
                bIsPatientUse := 1; //OCS할인 처리
                //가장 오래된 수정일자 가져옴.. 3대 전부 등록되어 있을 경우 사용
                sLastUPDT := Copy(FieldByName('LASTUPDTDT').AsString, 1, 26);  //.... timestamp 소숫점 자리수를 oracle 내에서 상호 다르게줌... (컬럼 자체와 .SSxFF로 조회했을때 자릿수가 달라 Char형으론 조회안됨)

                while not Eof do begin
                  if (Length(FieldByName('CARNO').AsString) < 4) and //차번이 비어있고
                     (nSeqNo = 0)                                   //SeqNo가 이전에 할당받은 적이 없는
                  then begin                                         //Order By ASC라 순서대로 확인..
                    nSeqNo := FieldByName('SEQNO').AsInteger;        //가장 작은 SeqNo 하나만을 저장
                  end;
                  Next;
                end;

                ExceptLogging('[바코드할인] PMCMPKBS조회 할인적용 PID: '+bufBarc);
                //5) PID가 등록되지 않은 경우
                if edtDC.Text = '' then begin
                  ExceptLogging('[바코드할인] 사전할인 미적용으로 PMOVPKDS조회 할인재적용');
                  dmTables.qryOCSselect.Close;
                  dmTables.qryOCSselect.SQL.Clear;
                  dmTables.qryOCSselect.SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMOVPKDS where PID = '''+QuotedStr(bufBarc)+''' '')');
//                  ExceptLogging(dmTables.qryOCSselect.SQL.Text);
                  dmTables.qryOCSselect.Open;

                  if dmTables.qryOCSselect.RecordCount > 0 then begin //해당바코드 데이터 = PID 가 있다면 할인
                    //12.08 바코드 OCS 할인 코드가 하나만 생성되는 것이 아닌 여러 코드가 생김
                    {SetLength(sDCCODE_PAST, RecordCount);
                    SetLength(sRECEIPTDATE_PAST, RecordCount);
                    SetLength(sPID_PAST, RecordCount);
                    while not Eof do begin
                      if FieldByName('DISCFLAG').AsString = '02' then begin //시간
                        if (FieldByName('DISCCD').AsString = '01') or
                           (FieldByName('DISCCD').AsString = '02') or
                           (FieldByName('DISCCD').AsString = '03') or
                           (FieldByName('DISCCD').AsString = '04') then begin
                          logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                          sDCCODE[I-1]      := FieldByName('DISCCD').AsString; //tempString;
                          sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 7, 2);
                          sPID[I-1] := FieldByName('PID').AsString;
                          Inc(I);
                        end else begin
                          logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
                        end;
                      end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
                        if (FieldByName('DISCCD').AsString = '05') then begin
                          logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                          sDCCODE[I-1]      := FieldByName('DISCCD').AsString;
                          sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 7, 2);
                          sPID[I-1] := FieldByName('PID').AsString;
                          Inc(I);
                        end;
                      end;
                    end;}
                    SQL_Field := FieldByName('DISCCD');
                    while not eof do
                    begin
                      sDISCCD := SQL_Field.AsString;
                      ExceptLogging('[할인코드]  '+sDISCCD);
                      if sDISCCD = '01' then begin //외래4시간
                        bIsPatientUse := 0; //OCS할인 처리
                        //btnClick(btn2,mnuDC2);
                      end else if sDISCCD = '02' then begin //외래6시간
                        bIsPatientUse := 0; //OCS할인 처리
                        //btnClick(btn3,mnuDC3);
                      end else if sDISCCD = '03' then begin //입원6시간
                         bIsPatientUse := 1; //OCS할인 처리
                        //OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '04' then begin //퇴원6시간
                         bIsPatientUse := 1; //OCS할인 처리
                        //OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '05' then begin //전액무료
                        btnClick(btn6,mnuDC6);
                      end else begin
                      end;
                      Next;
                    end;

                    if sDISCCD <> '05' then     //전액 무료 이외의 OCS 할인
                    begin
                      OCSDCProc_Ex_Bar(sNowInTKNo,bufBarc); //바코드로 중복 할인 여부 체크
                    end;

                    {ExceptLogging('[할인코드]  '+dmTables.qryOCSselect.FieldByName('DISCCD').AsString);
                    if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '01' then begin //외래4시간
                      btnClick(btn2,mnuDC2);
                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '02' then begin //외래6시간
                      btnClick(btn3,mnuDC3);
                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '03' then begin //입원6시간
                      OCSDCProcEx(sNowInTKNo,bufBarc);
                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '04' then begin //퇴원6시간
                      OCSDCProcEx(sNowInTKNo,bufBarc);
                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '05' then begin //전액무료
                      btnClick(btn6,mnuDC6);
                    end else begin
                    end;}
//                    if dmTables.qryOCSselect.FieldByName('HANDICAPRYN').AsString = 'Y' then begin //장애인50%
//                      btnClick(btn5,mnuDC5);
//                    end;
                  end else begin
                    ExceptLogging('[바코드인식불가] '+bufBarc);
                    MessageBoxTimeOut(Application.Handle, '바코드 인식불가로 재시도바랍니다!'+#13#10+'(2초뒤 화면이 닫힙니다.)', '', 0, 0, 2000);
                  end;
                end;

                Close;
                SQL.Clear;
                SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMCMPKBS where PID = '''+QuotedStr(bufBarc)+''' AND CARNO = '''+QuotedStr(sNowLprCarNo1)+''' '')');
                Open;

                if RecordCount > 0 then begin
                  ExceptLogging('[바코드할인] 기등록차량 할인적용안함 [PID : '+bufBarc+'] [차번 : ' + sNowLprCarNo1 + ']');
                  btnClick(btn1, mnuDC1);
                end else begin
                  ExceptLogging('[바코드할인] PMCMPKBS에 데이터없음! [PID : '+bufBarc+'] [차번 : ' + sNowLprCarNo1 + ']');
                  if nSeqNo = 0 then begin
                    //while문 돌면서 차번이 비어있는 SeqNo가 없었다. = 3대 풀로 등록되어 있다.
                    //Where절에 LASTUPDTDT를 사용하여 업데이트.
                    Close;
                    SQL.Clear;
                    SQL.Text :=
                      'UPDATE OPENQUERY(' + sLinkedDBName + ',' +
                      ' ''SELECT * FROM '+sOCSDBName+'.PMCMPKBS WHERE PID = ''''' + bufBarc + ''''' ' +
                                                          'AND TO_CHAR(LASTUPDTDT, ''''YYYY-MM-DD HH24:MI:SSxFF'''') = ''''' + sLastUPDT + ''''' '') ' +
                      'SET CARNO = ''' + sNowLprCarNo1 + ''', LASTUPDTDT = GETDATE(), LASTUPDTRID = ''NEXPA'' ';
//                    ExceptLogging('SQL : ' + SQL.Text);
                    ExecSQL;

                    ExceptLogging('['+bufBarc+'] : 차번 OCS 등록 완료 ['+sNowLprCarNo1+'] ..기존데이터 1건 Update');
  //                  btnClick(btn1, mnuDC1);
                  end else begin
                    //while문 돌면서 차번이 비어있는 SeqNo를 찾았다 = 해당 SeqNo가 비어있다.
                    //Where절에 SeqNo를 사용하여 업데이트.
                    Close;
                    SQL.Clear;
                    SQL.Text :=
                      'UPDATE OPENQUERY(' + sLinkedDBName + ',' +
                      ' ''SELECT * FROM '+sOCSDBName+'.PMCMPKBS WHERE PID = ''''' + bufBarc + ''''' AND SEQNO = ''''' + IntToStr(nSeqNo) + ''''' '') ' +
                      'SET CARNO = ''' + sNowLprCarNo1 + ''', LASTUPDTDT = GETDATE(), LASTUPDTRID = ''NEXPA'' ';
//                    ExceptLogging('SQL : ' + SQL.Text);
                    ExecSQL;

                    ExceptLogging('['+bufBarc+'] : 차번 OCS 등록 완료 ['+sNowLprCarNo1+'] ..신규데이터 1건 Update');
  //                  btnClick(btn1, mnuDC1);
                  end;
                end;
                sBarcodeTK := '';
              end else begin
                ExceptLogging('[바코드할인] PMCMPKBS에 데이터없어서 PMOVPKDS조회 할인적용 PID: '+bufBarc);
                //5) PID가 등록되지 않은 경우
                if edtDC.Text = '' then begin
                  ExceptLogging('[바코드할인] 사전할인 미적용으로 PMOVPKDS조회 할인재적용');
                  dmTables.qryOCSselect.Close;
                  dmTables.qryOCSselect.SQL.Clear;
                  dmTables.qryOCSselect.SQL.Add('Select * From openquery(' + sLinkedDBName + ', ''Select * From '+sOCSDBName+'.PMOVPKDS where PID = '''+QuotedStr(bufBarc)+''' '')');
                  ExceptLogging(dmTables.qryOCSselect.SQL.Text);
                  dmTables.qryOCSselect.Open;
                  if dmTables.qryOCSselect.RecordCount > 0 then begin //해당바코드 데이터 = PID 가 있다면 할인
                     //12.08 바코드 OCS 할인 코드가 하나만 생성되는 것이 아닌 여러 코드가 생김
                    {SetLength(sDCCODE_PAST, RecordCount);
                    SetLength(sRECEIPTDATE_PAST, RecordCount);
                    SetLength(sPID_PAST, RecordCount);
                    while not Eof do begin
                      if FieldByName('DISCFLAG').AsString = '02' then begin //시간
                        if (FieldByName('DISCCD').AsString = '01') or
                           (FieldByName('DISCCD').AsString = '02') or
                           (FieldByName('DISCCD').AsString = '03') or
                           (FieldByName('DISCCD').AsString = '04') then begin
                          logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                          sDCCODE[I-1]      := FieldByName('DISCCD').AsString; //tempString;
                          sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 7, 2);
                          sPID[I-1] := FieldByName('PID').AsString;
                          Inc(I);
                        end else begin
                          logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
                        end;
                      end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
                        if (FieldByName('DISCCD').AsString = '05') then begin
                          logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                          sDCCODE[I-1]      := FieldByName('DISCCD').AsString;
                          sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
                                               Copy(FieldByName('RCPTDD').AsString, 7, 2);
                          sPID[I-1] := FieldByName('PID').AsString;
                          Inc(I);
                        end;
                      end;
                    end;}
                    SQL_Field := FieldByName('DISCCD');
                    while not eof do
                    begin
                      sDISCCD := SQL_Field.AsString;
                      ExceptLogging('[할인코드]  '+sDISCCD);
                      if sDISCCD = '01' then begin //외래4시간
                        bIsPatientUse := 1; //OCS할인 처리
                        //btnClick(btn2,mnuDC2);
                      end else if sDISCCD = '02' then begin //외래6시간
                        bIsPatientUse := 1; //OCS할인 처리
                        //btnClick(btn3,mnuDC3);
                      end else if sDISCCD = '03' then begin //입원6시간
                         bIsPatientUse := 1; //OCS할인 처리
                        //OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '04' then begin //퇴원6시간
                         bIsPatientUse := 1; //OCS할인 처리
                        //OCSDCProcEx(sNowInTKNo,bufBarc);
                      end else if sDISCCD = '05' then begin //전액무료
                        btnClick(btn6,mnuDC6);
                      end else begin
                      end;
                      Next;
                    end;

                    if sDISCCD <> '05' then     //전액 무료 이외의 OCS 할인
                    begin
                      OCSDCProc_Ex_Bar(sNowInTKNo,bufBarc); //바코드로 중복 할인 여부 체크
                    end;


//                    ExceptLogging('[할인코드]  '+dmTables.qryOCSselect.FieldByName('DISCCD').AsString);
//                    if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '01' then begin //외래4시간
//                      btnClick(btn2,mnuDC2);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '02' then begin //외래6시간
//                      btnClick(btn3,mnuDC3);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '03' then begin //입원6시간
//                      OCSDCProcEx(sNowInTKNo,bufBarc);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '04' then begin //퇴원6시간
//                      OCSDCProcEx(sNowInTKNo,bufBarc);
//                    end else if dmTables.qryOCSselect.FieldByName('DISCCD').AsString = '05' then begin //전액무료
//                      btnClick(btn6,mnuDC6);
//                    end else begin
//                    end;
//                    if dmTables.qryOCSselect.FieldByName('HANDICAPRYN').AsString = 'Y' then begin //장애인50%
//                      btnClick(btn5,mnuDC5);
//                    end;
                  end else begin
                    ExceptLogging('[바코드인식불가] '+bufBarc);
                    MessageBoxTimeOut(Application.Handle, '바코드 인식불가로 재시도바랍니다!'+#13#10+'(3초뒤 화면이 닫힙니다.)', '', 0, 0, 2000);
                  end;
                end;
                sBarcodeTK := '';
                if (edtProcYogum.Text = '0') and (bDCZeroAutoOpen = True) then begin
                  ExceptLogging('할인후 잔여요금 0원 자동정산');
                  btnProcClick(btnProc);
                end;
              end;
            end;
            {$ENDREGION}
          end else begin
            {$REGION 'OCS연동 미사용'}
            ExceptLogging('OCS연동 미사용');
            with dmTables.qryDCTemp do begin
              //환자데이터 바코드 중복체크 삭제.. 병원 PID(sBarcodeTK)가 주민번호처럼 환자당 고유인데,
              //재방문한 환자를 전부 차단처리하게되어 제거함
              if sNowInTKNo <> '' then begin
                //입차데이터 있을시에만 바코드 처리가능.
                Close;
                SQL.Clear;
                SQL.Add('Insert Into UsedBarcodeData ');
                SQL.Add
                ('(ParkNo, ProcDate, ProcTime, TKNo, barcodeData, Amt) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
                Parameters.ParamByName('N1').Value := nCurrParkNo;
                Parameters.ParamByName('N2').Value := Copy(lbInTime.Caption , 1, 10);
                Parameters.ParamByName('N3').Value := Copy(lbInTime.Caption , 12, 8);;
                Parameters.ParamByName('N4').Value := sNowInTKNo;
                Parameters.ParamByName('N5').Value := sBarcodeTK;
                Parameters.ParamByName('N6').Value := 0;
                ExecSQL;
                BarCodeDCProc(sNowInTKNo,bufBarc);
              end else begin
                ExceptLogging('현재 요금계산중이 아님 : ' + sBarcodeTK);
              end;
            end;
            {$ENDREGION}
          end;

          sBarcodeTK:= '';
          Exit;
          {$ENDREGION}
        end else begin
          ExceptLogging(sBarCodeTK + '바코드 데이터 판별불가');
          sBarcodeTK:= '';
        end;
      end else begin
        ExceptLogging('요금정산중이 아님 : ' + tohex(sBarcodeTK));
        sBarcodeTK := '';
      end;
      sBarcodeTK := '';
    end;
    ExceptLogging(logStr);
  except
    on E: Exception  do begin
      sBarcodeTK := '';
      ExceptLogging('TfrmMainNew.comScannerTriggerAvail: ' + aString(E.Message));
    end;
  end;
  finally
    dmTables.qryOCSselect.Active := False;
  end;
end;

procedure TfrmMainNew.edtBarcodeKeyPress(Sender: TObject; var Key: Char);
var
  sBarcodeData, sNo, sExp, sType, sAmt: aString;
begin
  if (Key = #13) and btnProc.Enabled then
  begin
    if (edtBarcode.Text = '') then
      btnProcClick(Self)
    else
    begin
      // 할인권 처리...
      sBarcodeData := edtBarcode.Text;

      if Length(sBarcodeData) < 20 then
      begin
        ShowMessage('할인권 데이터 오류입니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
        edtBarcode.Text := '';
        edtBarcode.SetFocus;
        Exit;
      end
      else
      begin
        if not MG_NumberCheck(sBarcodeData) then
        begin
          ShowMessage('할인권 데이터 오류입니다.' + #13#10 + '할인권을 다시 읽혀주세요!');
          edtBarcode.Text := '';
          edtBarcode.SetFocus;
          Exit;
        end;
        sNo := Copy(sBarcodeData, 1, 7);
        sExp := Copy(sBarcodeData, 8, 6);
        sType := Copy(sBarcodeData, 14, 1);
        sAmt := Copy(sBarcodeData, 15, 6);
        edtBarcode.Text := '';

        BarcodeProc(sNo, sExp, sType, sAmt);
      end;
    end;
  end
  else if (Key = #27) and btnCancel.Enabled then
  begin
    btnCancelClick(Self);
  end
  else
  begin
    edtBarcode.Text := edtBarcode.Text + Key;
  end;
end;

procedure TfrmMainNew.edtLostCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnSeekClick(Self);
end;

procedure TfrmMainNew.edtManualCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnManualOKClick(Self);
end;

procedure TfrmMainNew.edtManualOutTimeKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnManualOutProcClick(Self);
end;

procedure TfrmMainNew.edtManualProcCarNoKeyPress
  (Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnManualSeekClick(Self);
end;

procedure TfrmMainNew.edtOutTimeKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnManualOutOkClick(Self);
end;

procedure TfrmMainNew.edtProcYogumChange(Sender: TObject);
var
  sDspIP: aString;
  i: Byte;
begin
  for i := 1 to 10 do
  begin
    if RLpr[i].nUnitNo = nowLpr.Tag then
    begin
      sDspIP := RLpr[i].sDspIP;
      Break;
    end;
  end;

  if edtProcYogum.Text <> '0' then
    DspProc(2, 3, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP)
  else
    DspProc(2, 4, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP);
end;

procedure TfrmMainNew.edtSCCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnSCClick(Self);
end;

procedure TfrmMainNew.ClearDCProc;
var
  i: Integer;
begin
  for i := 1 to 50 do
  begin
    with DCProc[i] do
    begin
      nDCNo := 0;
      sDCName := '';
      nDCAmt := 0;
      nRealDCAmt := 0;
      nRealDCMin := 0;
      nDCType := 0;
      nTime := 0;
      sDCTKNo := '';
      sDCTKIssueDate := '';
      sDCTKIssueTime := '';
      nDCKind := 0;
      sSeq := '';
      nSeq := 0;
      nTypeCode := 0;
      sStoreName:= ' ';
    end;
    RDCCnt[i].nDCNowCnt := 0;
  end;
  for i := 1 to 10 do
  begin
    with RWebDCData[i] do
    begin
      nWebDCNo      := 0;
      nWebDCValue   := 0;
      sWebDCMessage := '';
      nWebDCType    := 0;
      sSeq          := '';
      nSeq          := 0;
      nTypeCode     := 0;
      sStoreName    :='';
    end;
  end;
  for I := 1 to 10 do
  begin
    with RBarCodeDCData[i] do
    begin
      nBarCodeDCNo := 0;
      sBarCodeDCMessage:= '';
    end;
  end;

  sDCOutTime:= sNowOutDate + ' ' + sNowOutTime;
  nDCCnt := 0;
  nDCYogum := 0;
  edtDCYogum.Text := '0';
  //edtDC.Text := '';
  bBarcodeDiscount := false;
  bFreeOneDiscount := False;
end;

procedure TfrmMainNew.Button1Click(Sender: TObject);
begin
  ic1.Picture.LoadFromFile(sCurrRunDir + '\img\입차아이콘 on.png');
end;

procedure TfrmMainNew.Button2Click(Sender: TObject);
begin
  ic1.Picture.LoadFromFile(sCurrRunDir + '\img\입차아이콘.png');
  ic2.Picture.LoadFromFile(sCurrRunDir + '\img\정산아이콘 on.png');
end;

procedure TfrmMainNew.Button3Click(Sender: TObject);
begin
  ic3.Picture.LoadFromFile(sCurrRunDir + '\img\영수증아이콘 on.png');
  ic2.Picture.LoadFromFile(sCurrRunDir + '\img\정산아이콘.png');
end;

procedure TfrmMainNew.Button5Click(Sender: TObject);
var
  tmpTk: string;
begin
  qryMainTemp.Close;
  qryMainTemp.SQL.Text := 'select top 1 tkno from IONData Where InCarNo1 = :v1 order by ProcDate + ProcTime DESC';
  qryMainTemp.Parameters.ParamByName('v1').Value := '11가1111';
  qryMainTemp.Open;
  tmpTk := qryMainTemp.Fields[0].AsString;

  qryMainTemp.Close;
  qryMainTemp.SQL.Text := 'UPDATE IONData set ProcTime = CONVERT(NVARCHAR(8),DATEADD(HH,-5,GETDATE()),108) where TKNo = :v1';
  qryMainTemp.Parameters.ParamByName('v1').Value := tmpTk;
  qryMainTemp.ExecSQL;
end;

procedure TfrmMainNew.Button6Click(Sender: TObject);
begin
  //test_OcsNo := InputBox('ocs차번 입력','대전성모병원 ocs차번 입력하세요','');
  //바코드 테스트
  //sBarcodeTK := '8218020111600352';
  //sBarcodeTK := '8218020111600323';
  //sBarcodeTK := '1413904';
  //sBarcodeTK := '8218021031700471';
  //BarcodeTest;
  //BarCodeDCDetail(80);
  //OCSDCProc('1');
  //nowUseTime := 360;
  //nSecEx :=10;
  //OCSAdminDCDetail_Ex(1);
  //OCSDCProc_Ex('1');
  //sBarcodeTK := '82107210520000050';
  //BarCodeDCProc('',sBarcodeTK);
end;

procedure TfrmMainNew.ClearFormData(flag:Integer=0);
var
  i: Byte;
begin
   try
    nPayType := 1;
  //  lbDCName.Caption := '';
    //lbOutCarNo.Caption := '';
    //lbOutCarType.Caption:= '';
    lbInCarNo.Caption := '';
    nDCCnt := 0;
    nParkingMin := 0;
    nProcYogum := 0;
    nDCYogum := 0;
    nFeeNo := 0;
    nTKType := 1;
    edtProcYogum.Text := '0';
    edtDCYogum.Text := '0';
    edtTotYogum.Text := '0';
    //edtDC.Text := '';  //할인명
    sNowInDate := '';
    sNowInTime := '';
    sCancelReason := '';
    sTimeDCOutDate := '';
    sTimeDCOutTime := '';
    edtBarcode.Text := '';
    bMiProc := False;
    edtCharo.Color := clWhite;
    edtCharo.Text := '';
    bWebUse     := false;
    bWebUse1    := false;
    bFixedUse   := false;
    bCompactCar := false;
    bFreeFee    := false;

    nUseFeeItem := 0;
    nUseMiddle := 0;
    sUseFeeComp := '';
    sUseFeeName := '';
    sUseFeeExpire := '';

    for i := 1 to 6 do
    begin
      TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
      TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
    end;

    for i := 1 to 16 do
    begin
      TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := False;
      TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := False;
    end;

    for i := 1 to 50 do
      RDCCnt[i].nDCNowCnt := 0;

    ClearGTime;
    ClearDCProc;
    btnCancel.Enabled := False;
    btnProc.Enabled := False;
    edtMGReader.Text := '';

    if bNCOutProcWait then
    begin
      bNCOutProcWait := False;

      if nNCOutWaitPoint <> nNCOutWaitFlag then
      begin
        tNCOutWait.Enabled := True;
      end;
    end;

    ic3.Picture.LoadFromFile(sCurrRunDir + '\img\영수증아이콘.png');

    sBarcodeTK := '';

    bNationalUse := False;
    bHandicapUse := False;

    if flag = 0 then
      edtDCRemain.Text := '';

    if bOCSUse then begin
      nBarcodeOCSPIDIndex := 0;
      for i := 1 to 5 do begin
        sBarcodeOCSPID[i] := '';
      end;
    end;

    sDCInTime := '';
    sDCInTime2 := '';
    sDCOutTime := '';

  //  SMT_Recv := nil;
  //  SMT_Recv := TStringList.Create;
   except
     on E: Exception do
     begin
       ExceptLogging('ClearFormData '+E.Message);
     end;
   end;
end;

procedure TfrmMainNew.btnCloseClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmMainNew.btnLostCancelClick(Sender: TObject);
begin
  bMiProc := False;
  dmTables.qryLost1.Close;
  imgLost.Picture.Assign(Nil);
  pnLost.Visible := False;
end;

procedure TfrmMainNew.btnLostProcClick(Sender: TObject);
var
  sResult: aString;
  sDspIP: aString;
  i: Byte;
begin
  for i := 1 to 10 do
  begin
    if RLpr[i].nUnitNo = nowLpr.Tag then
    begin
      sDspIP := RLpr[i].sDspIP;
      Break;
    end;
  end;

  //sNowIOTime, nNowLprNo, nNowLprInOut, nNowLprRecog1, nNowLprRecog2, sDspIP, nowLpr
  //를 선언해서 처리해야 한다...

  try
    pnLost.Visible := False;
    bMiProc := True;

    with dmTables.qryLprProc do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo ');
      SQL.Add('where CarNo = :N1 and ParkNo = :N2 and ((ExpDateF <= :N3) and (ExpDateT >= :N4))');
      Parameters.ParamByName('N1').Value := sLostInCarNo;
      Parameters.ParamByName('N2').Value := nCurrParkNo;
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
      Open;

      if RecordCount > 0 then
      begin
        // 등록된 정기차량이면...
        sResult := RecvLprProc(sNowLprFile1, sLostInCarNo, sNowLprFile2,
          sNowLprCarNo2, sNowIOTime, nNowLprNo, 2, nNowLprRecog1,
          nNowLprRecog2, sDspIP, nowLpr, True);
          //숭실대 입차시에만  이미지 표출 안함
        imgIn.Picture := imgOut.Picture;
        GridData(sResult);
        ClearFormData;
      end
      else
      begin
        // 일반차량 처리...
        NormalProc(sNowLprFile1, sLostInCarNo, '', '', sNowIOTime, nNowLprNo,
          2, nNowLprRecog1, nNowLprRecog2, sDspIP, nowLpr, True);
        // 숭실대 입차시에만 입차 이미지 표시 출차시 표시안함.
        imgIn.Picture := imgLost.Picture;
      end;
    end;
    dmTables.qryLost.Close;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnLostProcClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnManualOKClick(Sender: TObject);
var
  sTKNo, sProcDate, sProcTime, sInCarNo: String;
begin
  try
//    sTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
    sTKNo := FormatDateTime('YYYYMMDDHHNNSS', Now)+ IntToStr(nCurrUnitNo) ;
    sProcDate := FormatDateTime('YYYY-MM-DD', Now);
    sProcTime := FormatDateTime('HH:NN:SS', Now);
    sInCarNo := MG_StrTrim(edtManualCarNo.Text, ' ');

    with dmTables do
    begin
      with qryDCTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into IONData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
        SQL.Add('CarType, Status, OutChk, InImage1, InCarNo1, Reserve2) ');
        SQL.Add(
          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := sProcDate;
        Parameters.ParamByName('N4').Value := sProcTime;
        Parameters.ParamByName('N5').Value := sTKNo;
        Parameters.ParamByName('N6').Value := 1;
        Parameters.ParamByName('N7').Value := 1;
        Parameters.ParamByName('N8').Value := 1;
        Parameters.ParamByName('N9').Value := 0;
        Parameters.ParamByName('N10').Value := '';
        Parameters.ParamByName('N11').Value := sInCarNo;
        Parameters.ParamByName('N12').Value := '수동입차';
        ExecSQL;
      end;
      ExceptLogging('수동입차: ' + sProcDate + ', ' + sProcTime + ', ' + sInCarNo);
      ShowMessage('수동입차처리를 완료하였습니다.');
    end;
    // InOpen;
    NGridData('1' + sInCarNo + '^' + sProcDate + ' ' + sProcTime + '^수동입차');
    pnManual.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualOKClick: ' + E.Message);
  end
end;

procedure TfrmMainNew.btnManualOutCancelClick(Sender: TObject);
begin
  edtOutTime.Text := '';
  pnManualOut.Visible := False;
end;

procedure TfrmMainNew.btnManualOutOkClick(Sender: TObject);
var
  sCheck: TDateTime;
begin
  try
    if Length(MG_StrTrim(edtManualOutCarNo.Text, ' ')) < 8 then
    begin
      ShowMessage('차량번호를 정확히 입력하여주세요!');
      edtManualOutCarNo.SetFocus;
      Exit;
    end;
    try
      sCheck := StrToTime(edtOutTime.Text + ':00');
    except
      on E: Exception do
      begin
        ShowMessage('입차시각을 정확히 입력하여주세요!');
        edtOutTime.SetFocus;
        edtOutTime.SelectAll;
        Exit;
      end;
    end;

    if (FormatDateTime('YYYY-MM-DD', Now) = edtOutDate.Text) and (edtOutTime.Text > FormatDateTime('HH:NN', Now)) then
    begin
      ShowMessage('입차시각을 정확히 입력하여주세요!');
      edtOutTime.SetFocus;
      edtOutTime.SelectAll;
      Exit;
    end;
    nTKType := 9;
    nCarType := 1;
//    sManualTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
    sManualTKNo := FormatDateTime('YYYYMMDDHHNNSS', Now)+ IntToStr(nCurrUnitNo) ;
    sNowInTKNo := sManualTKNo;
    sManualInTime := FormatDateTime('YYYY-MM-DD', edtOutDate.Date)
      + ' ' + edtOutTime.Text + ':00';
    sNowInDate := Copy(sManualInTime, 1, 10);
    sNowInTime := Copy(sManualInTime, 12, 8);
    sNowLprCarNo1 := edtManualOutCarNo.Text ;
    sNowLprCarNo2 := edtManualOutCarNo.Text;
//    sNowLprCarNo1 := '수동출차';
//    sNowLprCarNo2 := '수동출차';
    ManualOut(sNowLprFile1, sNowLprCarNo1, sNowLprFile2, sNowLprCarNo2,
      sNowIOTime, nNowLprNo, 2, nNowLprRecog1, nNowLprRecog2);
    pnManualOut.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualOutOkClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.btnManualOutProcClick(Sender: TObject);
var
  sCheck: TDateTime;
begin
  try

    if Length(MG_StrTrim(edtManualOutCarNo1.Text, ' ')) < 8 then
    begin
      ShowMessage('차량번호를 정확히 입력하여주세요!');
      edtManualOutCarNo1.SetFocus;
      Exit;
    end;

    try
      sCheck := StrToTime(edtManualOutTime.Text + ':00');
    except
      on E: Exception do
      begin
        ShowMessage('입차시각을 정확히 입력하여주세요!');
        edtManualOutTime.SetFocus;
        edtManualOutTime.SelectAll;
        Exit;
      end;
    end;

    if (FormatDateTime('YYYY-MM-DD', Now) = FormatDateTime('YYYY-MM-DD', edtManualProcDate.Date)) and
       (edtManualOutTime.Text > FormatDateTime('HH:NN', Now)) then
    begin
      ShowMessage('입차시각을 정확히 입력하여주세요!');
      edtManualOutTime.SetFocus;
      edtManualOutTime.SelectAll;
      Exit;
    end;

    nTKType := 9;
    nCarType := 1;
    sManualTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
    sNowInTKNo := sManualTKNo;
    sManualInTime := FormatDateTime('YYYY-MM-DD', edtManualProcDate.Date)
      + ' ' + edtManualOutTime.Text + ':00';
    sNowInDate := Copy(sManualInTime, 1, 10);
    sNowInTime := Copy(sManualInTime, 12, 8);
    sNowLprCarNo1 := '수동출차';
    sNowLprCarNo2 := '수동출차';
    ManualOut(sNowLprFile1, sNowLprCarNo1, sNowLprFile2, sNowLprCarNo2,
      sNowIOTime, nNowLprNo, 2, nNowLprRecog1, nNowLprRecog2);
    edtManualProcCarNo.Text:= '';
    pnManualProc.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualOutProcClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.btnManualProcCancelClick(Sender: TObject);
begin
  btnManualSCOut.Enabled := False;
  btnManualProc.Enabled := False;
  dmTables.qryLost1.Close;
  dmTables.qrySCSearch1.Close;
  edtManualProcCarNo.Text:= '';
  pnManualProc.Visible := False;
  ClearFormData;
end;

procedure TfrmMainNew.btnManualProcClick(Sender: TObject);
var
  sResult: aString;
  sDspIP: aString;
  i: Byte;
begin
  for i := 1 to 10 do
  begin
    if RLpr[i].nUnitNo = nowLpr.Tag then
    begin
      sDspIP := RLpr[i].sDspIP;
      Break;
    end;
  end;

  try
    edtManualProcCarNo.Text:= '';
    pnManualProc.Visible := False;
    bMiProc := True;

    with dmTables.qryLprProc do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo ');
      SQL.Add('where CarNo = :N1');
      SQL.Add(' and ((ExpDateF <= :N3) and (ExpDateT >= :N4))');
      Parameters.ParamByName('N1').Value := sLostInCarNo;
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
      Open;

      if RecordCount > 0 then
      begin
        // 등록된 정기차량이면...
        sResult := RecvLprProc(sNowLprFile1, sLostInCarNo, sNowLprFile2,
          sNowLprCarNo2, sNowIOTime, nNowLprNo, 2, nNowLprRecog1,
          nNowLprRecog2, sDspIP, nowLpr, True);
        //숭실대 출차 시 입차 이미지 표시안함
        imgIn.Picture := imgOut.Picture;
        GridData(sResult);
        ClearFormData;
      end
      else
      begin
        // 일반차량 처리...
        NormalProc(sNowLprFile1, sLostInCarNo, '', '', sNowIOTime, nNowLprNo,
          2, nNowLprRecog1, nNowLprRecog2, sDspIP, nowLpr, True);
      end;
    end;
    btnManualSCOut.Enabled := False;
    btnManualProc.Enabled := False;
    dmTables.qryLost.Close;
    dmTables.qrySCSearch.Close;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualProcClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnManualSCOutClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = nowLpr.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
    sResult := RecvLprProc(sOutLprFile, sOutLprCarNo, '', '', sTime,
      nowLpr.Tag, 2, 3, 3, sDspIP, nowLpr, True);
    GridData(sResult);
    ClearFormData;
    btnManualSCOut.Enabled := False;
    btnManualProc.Enabled := False;
    dmTables.qryLost.Close;
    dmTables.qrySCSearch.Close;
    edtManualProcCarNo.Text:= '';
    pnManualProc.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnSCOutClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.btnManualSeekClick(Sender: TObject);
var
  sIn, sResult, sTime, sTemp: aString;
  sDspIP: aString;
  i: Byte;
begin
  for i := 1 to 10 do
  begin
    if RLpr[i].nUnitNo = nowLpr.Tag then
    begin
      sDspIP := RLpr[i].sDspIP;
      Break;
    end;
  end;

  try
    if edtManualProcCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtManualProcCarNo.SetFocus;
      Exit;
    end;

    // 일반차량을 조회일자부터 오늘날짜까지 조회토록 한다...
    with dmTables.qryLost1 do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from ( ');
      SQL.Add(' select  B.TKNo , B.UnitNo ,B.InRecog1, b.InRecog2, b.InImage1, b.InImage2 ');
      SQL.Add('  ,(Select UnitName from unitinfo where unitno =B.UnitNo) UnitName  ');
      SQL.Add('  ,B.ProcDate, B.ProcTime ,B.InCarNo1 , B.INCARNo2,  0 usemiddle ');
      SQL.Add(' from IONData B where OutChk = 0 and TKType = :N1 and Status = :N2 and ');
      SQL.Add('((ProcDate >= :N3) and (ProcDate <= :N4)) and ');
      SQL.Add('((InCarNo1 like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%') + ') or ');
      SQL.Add('(InCarNo2 like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%') + ')) ');
      SQL.Add(' union ');
      SQL.Add(' select c.TKNo ,c.UnitNo,c.InRecog1, c.InRecog2, c.InImage1, c.InImage2 ');
      SQL.Add(' ,(Select UnitName from unitinfo where unitno =C.UnitNo) UnitName ');
      SQL.Add(' ,C.ProcDate, C.ProcTime ,C.InCarNo1 , C.INCARNo2  ');
      SQL.Add(' , (SELECT useMiddle  FROM GGroup  WHERE c.GroupNo = GGroup.GroupNo and useMiddle = 1) AS usemiddle ');
      SQL.Add(' from IOSData c where OutDate is null and  ');
      SQL.Add('((ProcDate >= :N5) and (ProcDate <= :N6)) and ');
      SQL.Add('((InCarNo1 like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%') + ') or ');
      SQL.Add('(InCarNo2 like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%') + ')) ');
      SQL.Add(' ) Z ');
      Parameters.ParamByName('N1').Value := 1;
      Parameters.ParamByName('N2').Value := 1;
      if nSeekDay > 0 then
        Parameters.ParamByName('N3').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1)
      else
        Parameters.ParamByName('N3').Value := '2012-01-01';
      Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
      if nSeekDay > 0 then
        Parameters.ParamByName('N5').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1)
      else
        Parameters.ParamByName('N5').Value := '2012-01-01';
      Parameters.ParamByName('N6').Value := FormatDateTime('YYYY-MM-DD', Now);
      Open;

      if RecordCount > 0 then
      begin
        First;
        btnManualProc.Enabled := True;
        dgNManualProc.SetFocus;
        dgNManualProcClick(Self);
      end;
    end;
//    with dmTables.qryLost do
//    begin
//      Close;
//      SQL.Clear;
//      SQL.Add('Select * from IONData where OutChk = :N1 and TKType = :N2 and Status = :N3 and ');
//      SQL.Add('((ProcDate >= :N4) and (ProcDate <= :N5)) and ');
//      SQL.Add('((InCarNo1 like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%') + ') or ');
//      SQL.Add('(InCarNo2 like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%') + ')) ');
//      SQL.Add(' and ParkNo = :N6 ');
//      SQL.Add('Order By ProcDate Desc, ProcTime Desc');
//      Parameters.ParamByName('N1').Value := 0;
//      Parameters.ParamByName('N2').Value := 1;
//      Parameters.ParamByName('N3').Value := 1;
//
//      if nSeekDay > 0 then
//        Parameters.ParamByName('N4').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1)
//      else
//        Parameters.ParamByName('N4').Value := '2012-01-01';
//      Parameters.ParamByName('N5').Value := FormatDateTime('YYYY-MM-DD', Now);
//      Parameters.ParamByName('N6').Value := nCurrParkNo;
//      Open;
//
//      if RecordCount > 0 then
//      begin
//        First;
//        btnManualProc.Enabled := True;
//        dgNManualProc.SetFocus;
//        dgNManualProcClick(Self);
//      end;
//    end;

    with dmTables.qrySCSearch1 do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo AS A ');
      SQL.Add(' INNER JOIN GGroup AS B ');
      SQL.Add(' ON a.GroupNo = B.GroupNo ');
      SQL.Add(' Where a.ParkNo = :N1 and B.useMiddle = 0  and CarNo like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%'));
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        First;
        btnManualSCOut.Enabled := True;
        sManualSCCarNo := dmTables.qrySCSearch1.FieldByName('CarNo').AsString;
      end
      else
      begin
        sManualSCCarNo := '';
        btnManualSCOut.Enabled := False;
      end;
    end;

//    with dmTables.qrySCSearch do
//    begin
//      Close;
//      SQL.Clear;
//      SQL.Add('Select * from CustInfo ');
//      SQL.Add('where ParkNo = :N1 and CarNo like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%'));
//      Parameters.ParamByName('N1').Value := nCurrParkNo;
//      Open;
//
//      if RecordCount > 0 then
//      begin
//        First;
//        btnManualSCOut.Enabled := True;
//        sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
//      end
//      else
//      begin
//        sManualSCCarNo := '';
//        btnManualSCOut.Enabled := False;
//      end;
//    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnManualSeekClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.btnMCancelClick(Sender: TObject);
begin
  edtMCarNo.Text := '';
  pnModify.Visible := False;
  imgModify.Picture.Assign(Nil);
  nGridCheck := 0;
end;

procedure TfrmMainNew.btnMGReaderClick(Sender: TObject);
var
  sIssueDate, sDCType, sDCCode, sParkNo, sNumber : aString;
begin
  sIssueDate := copy(edtMGReader.Text, 1, 14);
  sDCType    := copy(edtMGReader.Text, 15, 1);
  sDCCode    := copy(edtMGReader.Text, 16, 2);
  sParkNo    := copy(edtMGReader.Text, 18, 4);
  sNumber    := copy(edtMGReader.Text, 22, 6);

  VRM100PLog('=====================================');
  VRM100PLog('마그네틱리더기');
  VRM100PLog('발급일자 :' + sIssueDate);
  VRM100PLog('할인타입 :' + sDCType);
  VRM100PLog('할인코드 :' + sDCCode);
  VRM100PLog('주차장코드:' + sParkNo);
  VRM100PLog('일련번호:' + sNumber);
  VRM100PLog('=====================================');
  MGDCDetail(sIssueDate, sDCType , sDCCode , sParkNo , sNumber);
//  ddd
//  ShowMessage(edtMGReader.Text);
end;

procedure TfrmMainNew.btnMinimizeClick(Sender: TObject);
begin
  frmMainNew.WindowState := wsMinimized;
end;

procedure TfrmMainNew.btnModeClick(Sender: TObject);
var
  sMode : astring;
begin
  // Modified by LJH 2019-11-06 10:38:21 무인쪽에서 수정요청.. 무인기 응답받고 운영모드 변경하도록.
  if bMode then begin
    sMode := '개방운영';
  end else begin
    sMode := '정산운영';
  end;

  if MessageDlg( btnMode.Caption + '에서 ' + sMode + '로 변경하시겠습니까?', mtConfirmation, [mbYes, mbNo], 0) <> mrYes then
  begin
     frmMainNew.SetFocusedControl(btnproc);
     Exit;
  end;
  frmMainNew.SetFocusedControl(btnproc);

  if bMode then
  begin
    sApsSendData:= STX + 'OPENGATE' + ETX;
  end
  else
  begin
    sApsSendData:= STX + 'ENDGATE' + ETX;
  end;
  if csAps.Active then
    csAps.Active:= False;

  if is_Ping(sOutApsIP) then
  begin
    csAps.Active:= True;
  end
  else begin
    ExceptLogging('무인요금계산기 Ping 안됨. 운영모드 자체 변경');
    bMode := not bMode;
    if bMode then begin
      ExceptLogging('정산운영 자체 변경완료');
      btnMode.Caption := '정산운영' ;
      btnMode.Tag := 1;
      iSetup.WriteInteger('PARKING', '정산운영', 1);
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '정산운영';
        ExecSQL;
      end;
    end
    else begin
      ExceptLogging('개방운영 자체 변경완료');
      btnMode.Caption := '개방운영';
      btnMode.Tag := 2;
      iSetup.WriteInteger('PARKING', '정산운영', 0);
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '개방운영';
        ExecSQL;
      end;
    end;
  end;
//   if btnMode.Tag = 1 then begin
//     sMode := '개방운영'
//   end
//   else begin
//     sMode := '정산운영'
//   end;
//
//   if MessageDlg( btnMode.Caption + '에서 ' + sMode + '로 변경하시겠습니까?', mtConfirmation, [mbYes, mbNo], 0) <> mrYes then
//   begin
//      frmMainNew.SetFocusedControl(btnproc);
//      Exit;
//   end;
//   frmMainNew.SetFocusedControl(btnproc);
//
//   bMode := not bMode;
//   if bMode then begin
//     btnMode.Caption := '정산운영' ;
//     btnMode.Tag := 1;
//     iSetup.WriteInteger('PARKING', '정산운영', 1);
//     with qryMainTemp do
//     begin
//       Close;
//       SQL.Clear;
//       SQL.Add('Insert Into ProcData ');
//       SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
//       SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
//       Parameters.ParamByName('N1').Value := nCurrParkNo;
//       Parameters.ParamByName('N2').Value := nCurrUnitNo;
//       Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//       Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
//       Parameters.ParamByName('N5').Value := nCurrMNo;
//       Parameters.ParamByName('N6').Value := '정산운영';
//       ExecSQL;
//     end;
//   end
//   else begin
//     btnMode.Caption := '개방운영';
//     btnMode.Tag := 2;
//     iSetup.WriteInteger('PARKING', '정산운영', 0);
//     with qryMainTemp do
//     begin
//       Close;
//       SQL.Clear;
//       SQL.Add('Insert Into ProcData ');
//       SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
//       SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
//       Parameters.ParamByName('N1').Value := nCurrParkNo;
//       Parameters.ParamByName('N2').Value := nCurrUnitNo;
//       Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
//       Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
//       Parameters.ParamByName('N5').Value := nCurrMNo;
//       Parameters.ParamByName('N6').Value := '개방운영';
//       ExecSQL;
//     end;
//   end;

//  if bMode then
//  begin
//    sApsSendData:= STX + 'ENDGATE' + ETX;
//  end
//  else
//  begin
//    sApsSendData:= STX + 'OPENGATE' + ETX;
//  end;
//  if csAps.Active then
//    csAps.Active:= False;
//
//  if is_Ping(sOutApsIP) then
//  begin
//    csAps.Active:= True;
//  end
//  else
//    ExceptLogging('무인요금계산기 Ping 안됨');
end;

procedure TfrmMainNew.btnMOKClick(Sender: TObject);
var
  sCardNo, sName, sCompName, sDeptName, sGroupName, sExpDateT: aString;
  nGroupNo, i: Integer;
  bSC: Boolean;
begin
  try
    bSC:= False;

    with dmTables.qryModify do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo = :N1 and ');
      SQL.Add('ExpDateF <= :N2 and ExpDateT >= :N3 and TKType = :N4 and ParkNo = :N5');
      Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
      Parameters.ParamByName('N2').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := 2;
      Parameters.ParamByName('N5').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        // 정기차량 처리
        sCardNo := FieldByName('TKNo').AsString;
        nGroupNo := FieldByName('GroupNo').AsInteger;
        sName := FieldByName('Name').AsString;
        sCompName := FieldByName('CompName').AsString;
        sDeptName := FieldByName('DeptName').AsString;
        sExpDateT:= FieldByName('ExpDateT').AsString;

        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from GGroup where ParkNo = :N1 and GroupNo = :N2 and Reserve1 is null');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nGroupNo;
        Open;

        if RecordCount > 0 then
          sGroupName := FieldByName('GroupName').AsString;

        Close;
        SQL.Clear;
        SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
        SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
        SQL.Add('where ParkNo = :N6 and TKType = :N7 and TKNo = :N8');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nOrgUnitNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := 1;
        Parameters.ParamByName('N6').Value := nCurrParkNo;
        Parameters.ParamByName('N7').Value := 2;
        Parameters.ParamByName('N8').Value := sCardNo;
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add
          ('Select * from IOSData where ParkNo = :N1 and UnitNo = :N2 and ');
        SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nOrgUnitNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sCardNo;
        Open;

        if RecordCount <= 0 then
        begin
          Close;
          SQL.Clear;
          SQL.Add(
            'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
          SQL.Add(
            'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, InIOStatusNo, ');
          SQL.Add('InImage1, InRecog1, Reserve1, Reserve2) ');
          SQL.Add(
            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18)');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nOrgUnitNo;
          Parameters.ParamByName('N3').Value := sOrgDate;
          Parameters.ParamByName('N4').Value := sOrgTime;
          Parameters.ParamByName('N5').Value := sCardNo;
          Parameters.ParamByName('N6').Value := 2;
          Parameters.ParamByName('N7').Value := 2;
          Parameters.ParamByName('N8').Value := nGroupNo;
          Parameters.ParamByName('N9').Value := sGroupName;
          Parameters.ParamByName('N10').Value := sCompName;
          Parameters.ParamByName('N11').Value := sDeptName;
          Parameters.ParamByName('N12').Value := sName;
          Parameters.ParamByName('N13').Value := MG_StrTrim
            (edtMCarNo.Text, ' ');
          Parameters.ParamByName('N14').Value := 1;
          Parameters.ParamByName('N15').Value := sOrgFile;
          Parameters.ParamByName('N16').Value := 4;
          Parameters.ParamByName('N17').Value := FormatDateTime
            ('YYYY-MM-DD HH:NN:SS', Now);
          Parameters.ParamByName('N18').Value := IntToStr(nCurrMNo);
          ExecSQL;
        end;

        Close;
        SQL.Clear;
        SQL.Add(
          'Delete from IONData where ParkNo = :N1 and ProcDate = :N2 and ProcTime = :N3 and ');
        SQL.Add('((InCarNo1 = :N4) or (InCarNo2 = :N5))');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := sOrgDate;
        Parameters.ParamByName('N3').Value := sOrgTime;
        Parameters.ParamByName('N4').Value := sOrgCarNo;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        //Parameters.ParamByName('N4').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        //Parameters.ParamByName('N5').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        ExecSQL;
      end
      else
      begin
        // 일반차량 처리
        Close;
        SQL.Clear;
        SQL.Add(
          'Update IONData Set InCarNo1 = :N1, Reserve5 = :N7, Reserve4 = :N8, Reserve3 = :N9, InRecog1 = 1 ');
        SQL.Add(
          'Where ParkNo = :N2 and ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
        Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        Parameters.ParamByName('N2').Value := nCurrParkNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        Parameters.ParamByName('N7').Value := '차량번호수정';
        Parameters.ParamByName('N8').Value := FormatDateTime
          ('YYYY-MM-DD HH:NN:SS', Now);
        Parameters.ParamByName('N9').Value := IntToStr(nCurrMNo);
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add(
          'Update IONData Set InCarNo2 = :N1, Reserve5 = :N7, Reserve4 = :N8, Reserve3 = :N9, InRecog2 = 1 ');
        SQL.Add(
          'Where ParkNo = :N2 and ProcDate = :N3 and ProcTime = :N4 and InCarNo2 = :N5');
        Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        Parameters.ParamByName('N2').Value := nCurrParkNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        Parameters.ParamByName('N7').Value := '차량번호수정';
        Parameters.ParamByName('N8').Value := FormatDateTime
          ('YYYY-MM-DD HH:NN:SS', Now);
        Parameters.ParamByName('N9').Value := IntToStr(nCurrMNo);
        ExecSQL;
      end;

      if nGridCheck = 1 then
      begin
        for i := 2 to sgIn.RowCount do
        begin
          if (MG_StrTrim(sgIn.Cells[3, i - 1], ' ') = sOrgCarNo) and
            (sgIn.Cells[1, i - 1] = sOrgDate) and
            (sgIn.Cells[2, i - 1] = sOrgTime) then
          begin
            sgIn.Cells[3, i - 1] := MG_StrTrim(edtMCarNo.Text, ' ');
            sgIn.RowColor[i - 1] := clWhite;

            if bSC then
            begin
              sgIn.Cells[0, i -1]:= '정기차량';
              sgIn.Cells[4, i -1]:= sCompName;
              sgIn.Cells[5, i -1]:= sName;
              sgIn.Cells[6, i -1]:= sExpDateT;
            end;
          end;
        end;
      end
      else if nGridCheck = 2 then
      begin
        sgOut.RemoveRows(nModRow, 1);
      end;

      edtMCarNo.Text := '';
      imgModify.Picture.Assign(Nil);
      pnModify.Visible := False;
      nGridCheck := 0;
      sOrgCarNo := '';
      sOrgDate := '';
      sOrgTime := '';
      sOrgFile := '';
      nOrgUnitNo := 0;

      // 메시지 없애달라는 요청... 2012-06-30  황이성 주임
      // ShowMessage('차량번호 수정을 완료하였습니다.');
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnMOKClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.btnOpClick(Sender: TObject);
var
  sMode : astring;
begin
  if btnOp.Tag = 0 then
  begin
    sApsSendData:= STX + 'START' + ETX;
  end
  else
  begin
    sApsSendData:= STX + 'END' + ETX;
  end;

  if csAps.Active then
    csAps.Active:= False;

  if is_Ping(sOutApsIP) then
  begin
    csAps.Active:= True;
  end
  else
    ExceptLogging('무인요금계산기 Ping 안됨');
end;

procedure TfrmMainNew.btnProcClick(Sender: TObject);
var
  frmCash_SMT: TfrmCash_SMT;
  frmCredit_SMT: TfrmCredit_SMT;
begin
  ExceptLogging('TfrmMainNew.btnProcClick : 정산완료 버튼클릭');
  try
    if nCreditlinkage then
    begin
      // 신용카드 결재
      if bCredit then
      begin
        if nProcYogum > 0 then
        begin
          NextModalDialog(TfrmPaySelect.Create(Self));
        end
        else
        begin
          nPayType := 1;
          MoneyProc(nowLpr);
          Exit;
        end;
      end;

      if nPayType > 0 then
      begin
        if nPayType = 1 then       //현금
        begin
          nCashType:= 0;
          if bCashReceipt then
          begin
            if NextModalDialog(TfrmCashSelect.Create(Self)) = 2 then
              Exit;


          end;
//          NextModalDialog(TfrmCashSelect.Create(Self));
          if nCashType > 0 then
          begin
            //현금영수증 발행
            sCreditParkingTime := lbParkingTime.Caption;
            bGoodCashReceipt:= False;
            nTRADEType := TRADE_APP;  //현금거래

            frmCash_SMT := TfrmCash_SMT.Create(nil);
            if frmCash_SMT.ShowModal = mrOk then begin

            end;

//            NextModalDialog(TfrmCash_SMT.Create(Self));
//            NextModalDialog(TfrmCash_Kicc.Create(Self));

            if bGoodCashReceipt then
            begin
              if comPrn.Open and (sCashReceipt <> '') then
              begin
                comPrn.PutString(sCashReceipt);
                mnuCashReceipt.Enabled:= True;
              end;
              MoneyProc(nowLpr);
              bGoodCashReceipt:= False;
            end;
          end
          else
            MoneyProc(nowLpr);
        end
        else if nPayType = 2 then    //카드
        begin
          sCreditParkingTime := lbParkingTime.Caption;
          bGoodCredit := False;
          nTRADEType := TRADE_APP;         //카드결제

          frmCredit_SMT := TfrmCredit_SMT.Create(nil);
          if frmCredit_SMT.ShowModal = mrOk then begin

          end;

//          NextModalDialog(TfrmCredit_SMT.Create(Self));
//          NextModalDialog(TfrmCredit_Kicc.Create(Self));

          if bGoodCredit then
          begin
            if ComPrn.Open and (sCreditPrt <> '') then
            begin
              ComPrn.PutString(sCreditPrt);
              mnuCreditReceipt.Enabled:= True;
            end;
            MoneyProc(nowLpr);
            bGoodCredit := False;
          end;
        end;
      end
      else
        btnProc.SetFocus;
    end
    else
    begin
      if bCredit then
      begin
        if nProcYogum > 0 then
          NextModalDialog(TfrmPaySelect.Create(Self))
        else
          nPayType := 1;
      end;

      // 지불종류 현금
      if nPayType > 0 then
        MoneyProc(nowLpr)
      else
        btnProc.SetFocus;
    end;
    sBarcodeTK := '';
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnProcClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.btnReceiptClick(Sender: TObject);
var
  i: Byte;
begin
  ExceptLogging('영수증 재발행' + sPrtData);
  if ComPrn.Open and (sPrtData <> '') then
    ComPrn.PutString(AnsiChar($1B)+AnsiChar($61)+AnsiChar($00)+sPrtData);

  if not bReceiptReprint then
  begin
    sPrtData := '';
    btnReceipt.Enabled := False;
  end;
end;

procedure TfrmMainNew.btnSeekClick(Sender: TObject);
var
  sIn, sResult, sTime, sTemp: aString;
  sDspIP: aString;
  i: Byte;
begin
  for i := 1 to 10 do
  begin
    if RLpr[i].nUnitNo = nowLpr.Tag then
    begin
      sDspIP := RLpr[i].sDspIP;
      Break;
    end;
  end;

  try
    if edtLostCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtLostCarNo.SetFocus;
      Exit;
    end;

    with dmTables.qryTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo AS A ');
      SQL.Add(' INNER JOIN GGroup AS B ');
      SQL.Add(' ON a.GroupNo = B.GroupNo ');
      SQL.Add(' Where a.ParkNo = :N1 and B.useMiddle = 0  and CarNo = :N2');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := edtLostCarNo.Text;
      Open;
//      Close;
//      SQL.Clear;
//      SQL.Add('Select * from CustInfo where CarNo = :N1 and ParkNo = :N2');
//      Parameters.ParamByName('N1').Value := edtLostCarNo.Text;
//      Parameters.ParamByName('N2').Value := nCurrParkNo;
//      Open;

      if RecordCount > 0 then
      begin
        // 정기차량 처리
        sOutLprCarNo := edtLostCarNo.Text;
        sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
        sResult := RecvLprProc(sOutLprFile, sOutLprCarNo, '', '', sTime,
          nowLpr.Tag, 2, 3, 3, sDspIP, nowLpr, True);
        GridData(sResult);
        ClearFormData;
        pnLost.Visible := False;
      end
      else
      begin
        // 조회일자부터 오늘날짜까지 조회토록 한다...
        with dmTables.qryLost1 do
        begin
          Close;
          SQL.Clear;
          SQL.Add('Select * from ( ');
          SQL.Add(' select  B.TKNo , B.UnitNo ,B.InRecog1, b.InRecog2, b.InImage1, b.InImage2 ');
          SQL.Add('  ,(Select UnitName from unitinfo where unitno =B.UnitNo) UnitName  ');
          SQL.Add('  ,B.ProcDate, B.ProcTime ,B.InCarNo1 , B.INCARNo2,  0 usemiddle ');
          SQL.Add(' from IONData B where OutChk = 0 and TKType = :N1 and Status = :N2 and ');
          SQL.Add('((ProcDate >= :N3) and (ProcDate <= :N4)) and ');
          SQL.Add('((InCarNo1 like ' + MG_MakeStr('%' + Trim(edtLostCarNo.Text) + '%') + ') or ');
          SQL.Add('(InCarNo2 like ' + MG_MakeStr('%' + Trim(edtLostCarNo.Text) + '%') + ')) ');
          SQL.Add(' union ');
          SQL.Add(' select c.TKNo ,c.UnitNo,c.InRecog1, c.InRecog2, c.InImage1, c.InImage2 ');
          SQL.Add(' ,(Select UnitName from unitinfo where unitno =C.UnitNo) UnitName ');
          SQL.Add(' ,C.ProcDate, C.ProcTime ,C.InCarNo1 , C.INCARNo2  ');
          SQL.Add(' , (SELECT useMiddle  FROM GGroup  WHERE c.GroupNo = GGroup.GroupNo and useMiddle = 1) AS usemiddle ');
          SQL.Add(' from IOSData c where OutDate is null and  ');
          SQL.Add('((ProcDate >= :N5) and (ProcDate <= :N6)) and ');
          SQL.Add('((InCarNo1 like ' + MG_MakeStr('%' + Trim(edtLostCarNo.Text) + '%') + ') or ');
          SQL.Add('(InCarNo2 like ' + MG_MakeStr('%' + Trim(edtLostCarNo.Text) + '%') + ')) ');
          SQL.Add(' ) Z ');
          Parameters.ParamByName('N1').Value := 1;
          Parameters.ParamByName('N2').Value := 1;
          if nSeekDay > 0 then
            Parameters.ParamByName('N3').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1)
          else
            Parameters.ParamByName('N3').Value := '2012-01-01';
          Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
          if nSeekDay > 0 then
            Parameters.ParamByName('N5').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1)
          else
            Parameters.ParamByName('N5').Value := '2012-01-01';
          Parameters.ParamByName('N6').Value := FormatDateTime('YYYY-MM-DD', Now);
          Open;
          if RecordCount > 0 then
          begin
            First;
            btnLostProc.Enabled := True;
            dgLost.SetFocus;
            dgLostClick(Self);
          end;
        end;
//        with dmTables.qryLost do
//        begin
//          Close;
//          SQL.Clear;
//          SQL.Add('Select * from IONData where OutChk = :N1 and TKType = :N2 and Status = :N3 and ');
//          SQL.Add('((ProcDate >= :N4) and (ProcDate <= :N5)) and ');
//          SQL.Add('((InCarNo1 like ' + MG_MakeStr('%' + Trim(edtLostCarNo.Text) + '%') + ') or ');
//          SQL.Add('(InCarNo2 like ' + MG_MakeStr('%' + Trim(edtLostCarNo.Text) + '%') + ')) ');
//          SQL.Add(' and ParkNo = :N6 ');
//          SQL.Add('Order By ProcDate Desc, ProcTime Desc');
//          Parameters.ParamByName('N1').Value := 0;
//          Parameters.ParamByName('N2').Value := 1;
//          Parameters.ParamByName('N3').Value := 1;
//
//          if nSeekDay > 0 then
//            Parameters.ParamByName('N4').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1)
//          else
//            Parameters.ParamByName('N4').Value := '2012-01-01';
//
//          Parameters.ParamByName('N5').Value := FormatDateTime('YYYY-MM-DD', Now);
//          Parameters.ParamByName('N6').Value := nCurrParkNo;
//          Open;
//
//          if RecordCount > 0 then
//          begin
//            First;
//            btnLostProc.Enabled := True;
//            dgLost.SetFocus;
//            dgLostClick(Self);
//          end;
//        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.btnSeekClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  if not bDirectClose then
  begin
    if MessageDlg('요금계산기 프로그램을 종료할까요?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
    begin
      ExceptLogging('Program Close');
      with qryMainTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into ProcData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
        Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
        Parameters.ParamByName('N5').Value := nCurrMNo;
        Parameters.ParamByName('N6').Value := '로그아웃' ;
        ExecSQL;
      end;
      CanClose := True;
    end
    else
      CanClose := False;
  end
  else
  begin
    ExceptLogging('Program Close');
    with qryMainTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Insert Into ProcData ');
      SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, MNo ,ProcReason) ');
      SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6)');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
      Parameters.ParamByName('N5').Value := nCurrMNo;
      Parameters.ParamByName('N6').Value := '로그아웃' ;
      ExecSQL;
    end;
    CanClose := True;
  end;
end;

procedure TfrmMainNew.FormCreate(Sender: TObject);
begin
  try
    CreateFileMapping($FFFFFFFF, nil, PAGE_READWRITE, 0, 1, 'Parking_FC');

    if GetLastError = ERROR_ALREADY_EXISTS then
    begin
      ShowMessage('요금계산기프로그램이 이미 실행중입니다.'#13#13#10 + '확인하여주세요!');
      halt;
    end;
    sCurrRunDir := aString(ExtractFileDir(Application.ExeName));

    if not DirectoryExists('Log') then
      MkDir('Log');
    if not DirectoryExists('Check') then
      MkDir('Check');
    if not DirectoryExists('Temp') then
      MkDir('Temp');
    if not DirectoryExists('Closing') then
      MkDir('Closing');
    if not DirectoryExists('VRM100P') then
      MkDir('VRM100P');
  except
    on E: Exception do
      ExceptLogging('TfrmMain.FormCreate: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.FormKeyPress(Sender: TObject; var Key: Char);
var
  sCheck: String;
begin
  if (Key = #13) and btnProc.Enabled then
    btnProcClick(Self);

  if (Key = #27) then
  begin
    if pnSCSearch.Visible then
      btnSCCancelClick(Self)
    else if pnBar.Visible then
      btnBarCloseClick(Self)
    else if pnLost.Visible then
      btnLostCancelClick(Self)
    else if pnManual.Visible then
      btnManualCancelClick(Self)
    else if pnManualOut.Visible then
      btnManualOutCancelClick(Self)
    else
    begin
      if btnCancel.Enabled then
        btnCancelClick(Self);
    end;
    frmMainNew.SetFocus;
  end;
end;

procedure TfrmMainNew.FormKeyUp(Sender: TObject; var Key: Word; Shift: TShiftState);
begin
  if (Key = 80) and mnuReceipt.Enabled then
    btnReceiptClick(Self);
end;

procedure TfrmMainNew.FormMouseDown(Sender: TObject; Button: TMouseButton;
  Shift: TShiftState; X, Y: Integer);
begin
//  ReleaseCapture;
//  SendMessage(Handle, WM_NCLBUTTONDOWN, HTCAPTION, 0);
end;

procedure TfrmMainNew.FormShow(Sender: TObject);
var
  sDBString: aString;
  i, j: Integer;
  nWebDCCount : Integer;      //웹할인 버튼 적용 용
  sTemp1, sTemp2: String;
  SystemTime: TSystemTime;
  sDateTime, sYear, sMonth, sDay, sHour, sMin, sSec, sError: String;
    // 신용카드용
  nResult: Integer;
  pMsg: PAnsiChar;
  sMsg: aString;
  csList: TObjectList<TClientSocket>;

begin
  try
    ExceptLogging('Program Start!');
    FormAlign;
    GridClear;
    WaitClear;
    InitProc;

    nCOMMERCIAL := 0;
    nFREECIAL := 0;
    lbInTime.Caption := '';
    lbOutTime.Caption := '';
    lbParkingTime.Caption := '';
    lbDCName.Caption := '';
    lbOutCarNo.Caption := '';
    lbInCarNo.Caption := '';
    lbCarNo.Caption := '';

    iSetup := TIniFile.Create(ExtractFileDir(Application.ExeName) + '\ParkSet.ini');
    sDBIP  := iSetup.ReadString('PARKING', 'DB IP', '');
    sDBID  := iSetup.ReadString('PARKING', 'DB ID', '');
    sDBPW  := iSetup.ReadString('PARKING', 'DB PW', '');
    sDBName:= iSetup.ReadString('PARKING', 'DB Name', '');
    nCurrUnitNo := iSetup.ReadInteger('PARKING', 'UnitNo', 0);
    sImageDir := iSetup.ReadString('PARKING', 'LPRImage', 'C:\LPRImage');
    sLogoFile := iSetup.ReadString('PARKING', 'Logo File', '');
    sHostIP := MG_StrTrim(iSetup.ReadString('PARKING', 'Host IP', ''), ' ');
    nHostPort := iSetup.ReadInteger('PARKING', 'Host Port', 0);
    nKiccPort:= iSetup.ReadInteger('PARKING', 'KICC Port', 0);
    nKiccBaud:= iSetup.ReadInteger('PARKING', 'KICC Baud', 57600);

    //클라이언트 소켓 리스트 담기
    csList := TObjectList<TClientSocket>.Create();

    if not DirectoryExists(sImageDir) then
    begin
      if not ForceDirectories(sImageDir) then
        ExceptLogging('이미지저장폴더 생성실패: ' + sImageDir);
    end;

    if sDBIP = '' then
      sDBIP := aString(InputBox('DB설정 입력', 'DB IP 또는 DB서버명을 입력하여주세요', ''));

    if sDBID = '' then
      sDBID := aString(InputBox('DB ID 입력', 'DB 접속용 ID를 입력하여주세요', ''));

    if sDBPW = '' then
      sDBPW := aString(InputBox('DB Password 입력', 'DB 접속용 Password를 입력하여주세요', ''));

    if sDBName = '' then
      sDBName := aString(InputBox('DB Name 입력', 'DB명을  입력하여주세요', ''));

    if (sDBIP <> '') and (sDBID <> '') and (sDBPW <> '') and (sDBName <> '') then
    begin
      try
        // DB연결...
        dmTables.ADODB.Connected := False;
        sDBString := 'Provider=SQLOLEDB.1;Persist Security Info=True;';
        sDBString := sDBString + 'User ID=' + sDBID;
        sDBString := sDBString + ';Password=' + sDBPW;
        sDBString := sDBString + ';Initial Catalog=' + sDBName;
        sDBString := sDBString + ';Data Source=' + sDBIP;
        dmTables.ADODB.ConnectionString := wString(sDBString);
        ExceptLogging(sDBString);
        dmTables.ADODB.Connected := True;
      except
        on E: Exception do
        begin
          ExceptLogging('DB Connect Error:' + aString(E.Message));
          ShowMessage('데이터베이스 연결에 실패하였습니다. 확인하여주세요.');
          Exit;
        end;
      end;
      iSetup.WriteString('PARKING', 'DB IP', sDBIP);
      iSetup.WriteString('PARKING', 'DB ID', sDBID);
      iSetup.WriteString('PARKING', 'DB PW', sDBPW);
      iSetup.WriteString('PARKING', 'DB Name', sDBName);
    end;

    if (sDBIP = '') then
    begin
      ShowMessage('DB IP 또는 서버명을 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    if (sDBID = '') then
    begin
      ShowMessage('DB 접속용 ID를 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    if (sDBPW = '') then
    begin
      ShowMessage('DB 접속용 Password를 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    if (sDBName = '') then
    begin
      ShowMessage('DB명을 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;
    bAutoCalc := IntToBool(iSetup.ReadInteger('PARKING', '자동요금계산', 1));
    bZeroOpen := IntToBool(iSetup.ReadInteger('PARKING', '0원자동오픈', 1));
    bClosingText := IntToBool(iSetup.ReadInteger('PARKING', '마감내용파일저장', 0));
    bClosingReprint := IntToBool(iSetup.ReadInteger('PARKING', '마감재출력', 0));
    bReceiptReprint := IntToBool(iSetup.ReadInteger('PARKING', '영수증재출력', 0));
    bCarSearch := IntToBool(iSetup.ReadInteger('PARKING', '차량검색', 1));
    bManualIn := IntToBool(iSetup.ReadInteger('PARKING', '수동입차', 0));
    nFCProcType := iSetup.ReadInteger('PARKING', '정산방식', 0);
    bCancel := IntToBool(iSetup.ReadInteger('PARKING', '정산취소', 1));
    bCancelReason := IntToBool(iSetup.ReadInteger('PARKING', '정산취소사유입력', 0));
    bCancelCheck := IntToBool(iSetup.ReadInteger('PARKING', '정산취소확인', 0));
    bCancelSave := IntToBool(iSetup.ReadInteger('PARKING', '정산취소로그저장', 0));
    bManualOpen := IntToBool(iSetup.ReadInteger('PARKING', '수동개방사유입력', 0));
    bCredit := IntToBool(iSetup.ReadInteger('PARKING', '신용카드결재', 0));
    bCashReceipt := IntToBool(iSetup.ReadInteger('PARKING', '현금영수증발행', 0));
    bBarcodeDC := IntToBool(iSetup.ReadInteger('PARKING', '바코드할인권사용', 0));
    bInterimClosing := IntToBool(iSetup.ReadInteger('PARKING', '중간마감', 0));
    bInterimPrint := IntToBool(iSetup.ReadInteger('PARKING', '중간마감출력', 0));
    sAutoCar := iSetup.ReadString('PARKING', '자동통과차량', '');
    bFCMode := IntToBool(iSetup.ReadInteger('PARKING', '유인운영', 1));
    bMode := IntToBool(iSetup.ReadInteger('PARKING', '정산운영', 1));
    nCreditlinkage := IntToBool(iSetup.ReadInteger('PARKING', '신용카드연동', 1));
    nInProcUse := IntToBool(iSetup.ReadInteger('PARKING', '입차처리', 0));
    sLinkedDBName := iSetup.ReadString('PARKING', 'LINKED DB Name', 'DJSM_OCS');
    sOCSDBName := iSetup.ReadString('PARKING', 'OCS DB Name', 'PAM');
    bOCSUse := IntToBool(iSetup.ReadInteger('PARKING', 'OCS연동', 0));

    bDCZeroAutoOpen := IntToBool(iSetup.ReadInteger('PARKING', '할인요금0원시자동오픈', 0));
    bDCZeroButtonOpen := IntToBool(iSetup.ReadInteger('PARKING', '버튼할인요금0원시자동오픈', 0));

//    nUseParkNo := iSetup.ReadInteger('PARKING', 'UseParkNo', 0);
//    ClearFormData;
    if not bCredit then
    begin
      Label8.Top := 413;
      lbMCnt.Top := 413;
      lbMTot.Top := 413;
      Label9.Top := 464;
      lbMCreditCnt.Top := 464;
      lbMCreditTot.Top := 464;
      Label9.Visible := False;
      lbMCreditCnt.Visible := False;
      lbMCreditTot.Visible := False;
    end
    else
    begin
      Label8.Caption:= '현    금:'
    end;

    with qryMainTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select convert(varchar(30), getdate(), 120) tnow');
      Open;

      sDateTime := FieldByName('tNow').AsString;
      sYear := Copy(sDateTime, 1, 4);
      sMonth := Copy(sDateTime, 6, 2);
      sDay := Copy(sDateTime, 9, 2);
      sHour := Copy(sDateTime, 12, 2);
      sMin := Copy(sDateTime, 15, 2);
      sSec := Copy(sDateTime, 18, 2);

      with SystemTime do
      begin
        wYear := StrToInt(sYear);
        wMonth := StrToInt(sMonth);
        wDay := StrToInt(sDay);
        wDayOfWeek := DayOfWeek(Now) - 1;
        wHour := StrToInt(sHour);
        wMinute := StrToInt(sMin);
        wSecond := StrToInt(sSec);
        wMilliseconds := 0;
      end;
//      SetLocalTime(SystemTime);

      nChkTime := GetTickCount + 3600000;

      Close;
      SQL.Clear;
      SQL.Add('Select * from UnitInfo where UnitNo = :N1');
      Parameters.ParamByName('N1').Value:= nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        nCurrParkNo:= FieldByName('ParkNo').AsInteger;
//        nConnectNo := FieldByName('ConnectNo').AsInteger;
//        nUseParkNo := FieldByName('UseParkNo').AsInteger;
      end
      else
      begin
        ShowMessage('설치된 요금계산기가 없습니다. 관리PC에서 확인하여 주세요!');
        Close;
        Exit;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * from ParkInfo where ParkNo = :N1');
      Parameters.ParamByName('N1').Value:= nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        sParkName := FieldByName('ParkName').AsString;
        sParkAddr := FieldByName('ParkAddr').AsString;
        sRegNo := FieldByName('RegNo').AsString;
        sAdmin := FieldByName('Admin').AsString;
        sTelephone := FieldByName('Telephone').AsString;
        sReceipt := FieldByName('Receipt').AsString;

        nItemMax0 := FieldByName('DayMax').AsInteger;
        nTotMax0 := FieldByName('TotMax').AsInteger;
        nDCCntMax := FieldByName('DCCntMax').AsInteger;
        bZeroReceipt := IntToBool(FieldByName('ReceiptZero').AsInteger);
        bAutoReceipt := IntToBool(FieldByName('ReceiptAuto').AsInteger);
        nJulsaType := FieldByName('JunkType').AsInteger;
        nRoundType := FieldByName('RoundType').AsInteger;
        bTax := not IntToBool(FieldByName('TaxType').AsInteger);
        nTimeDCType := FieldByName('TimeDCType').AsInteger;
        bDCReason := IntToBool(FieldByName('DCReason').AsInteger);
        nLossTicket := FieldByName('LostCalc').AsInteger;
        nLossTicketAmt := FieldByName('LostAmount').AsInteger;
        nSCRemain:= FieldByName('RemainDsp').AsInteger;
        nClosingType:= FieldByName('ClosingType').AsInteger;
        nSeekDay:= FieldByName('SeekDay').AsInteger;
        nMiddleParkingTime :=  FieldByName('middleparktime').AsInteger;
        if FieldByName('Reserve1').AsString <> '정상운영' then
          bOperation := False;

        if FieldByName('Reserve2').AsString = '테스트' then
          bTest := True;

        if FieldByName('Reserve5').AsString = '1' then
        begin
          bFreeTime := True;
          sFreeTimeS := FieldByName('Reserve3').AsString;
          sFreeTimeE := FieldByName('Reserve4').AsString;

          if sFreeTimeS > sFreeTimeE then
            bFreeTimeChk := True;
        end;
      end
      else
        ExceptLogging('설치된 주차장이 없음!');
    end;
    nLoginResult := 0;
    NextModalDialog(TfrmLogin.Create(Self));

    if nLoginResult = 0 then
    begin
      ShowMessage('로그인에 실패하여 프로그램을 종료합니다.');
      bDirectClose:= True;
      Close;
      Exit;
    end
    else
    begin
      DBConnect(PAnsiChar(sDBIP));
      ExceptLogging('근무시작: ' + sCurrMName);
      edtMName.Text := ' 근무자 - ' + sCurrMName;
    end;

    if (sLogoFile <> '') and FileExists(sLogoFile) then
      imgLogo.Picture.LoadFromFile(sLogoFile);

    if nManagerAuthority > 1 then
      btnSetup.Enabled := False;

    if not bCarSearch then
      btnCarSearch.Enabled := False;

    if not bManualIn then
      btnManualIn.Enabled := False;

    sGeunmuStart := iSetup.ReadString('PARKING', IntToStr(nCurrMNo) + '_근무시작',
      '');
    sGeunmuMagam := iSetup.ReadString('PARKING', IntToStr(nCurrMNo) + '_마감',
      '');

    if sGeunmuStart = '' then
    begin
      sGeunmuStart := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
      iSetup.WriteString('PARKING', IntToStr(nCurrMNo) + '_근무시작', sGeunmuStart);
    end
    else
    begin
      if sGeunmuStart < sGeunmuMagam then
      begin
        sGeunmuStart := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
        iSetup.WriteString('PARKING', IntToStr(nCurrMNo) + '_근무시작',
          sGeunmuStart);
      end;
    end;

    with qryMainTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add(
        'Select Sum(RealFee), Count(*) from TKProc where ProcDate = :N1 and ');
      SQL.Add('MNo = :N2 and ChkClosing = :N3 and PayType = :N4 and ParkNo = :N5 and UnitNo = :N6');
      Parameters.ParamByName('N1').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N2').Value := nCurrMNo;
      Parameters.ParamByName('N3').Value := 0;
      Parameters.ParamByName('N4').Value := 1;
      Parameters.ParamByName('N5').Value := nCurrParkNo;
      Parameters.ParamByName('N6').Value:=  nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        nMTot := FieldByName('COLUMN1').AsInteger;
        nMCnt := FieldByName('COLUMN2').AsInteger;
        lbMTot.Caption := FormatFloat('#,##0', nMTot) + ' 원';
        lbMCnt.Caption := FormatFloat('#,##0', nMCnt) + ' 건';
      end
      else
      begin
        lbMTot.Caption := '0 원';
        lbMCnt.Caption := '0 건';
      end;

      Close;
      SQL.Clear;
      SQL.Add(
        'Select Sum(RealFee), Count(*) from TKProc where ProcDate = :N1 and ');
      SQL.Add('MNo = :N2 and ChkClosing = :N3 and PayType = :N4 and ParkNo = :N5 and UnitNo = :N6');
      Parameters.ParamByName('N1').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N2').Value := nCurrMNo;
      Parameters.ParamByName('N3').Value := 0;
      Parameters.ParamByName('N4').Value := 2;
      Parameters.ParamByName('N5').Value := nCurrParkNo;
      Parameters.ParamByName('N6').Value:=  nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        nMCreditTot := FieldByName('COLUMN1').AsInteger;
        nMCreditCnt := FieldByName('COLUMN2').AsInteger;
        lbMCreditTot.Caption := FormatFloat('#,##0', nMCreditTot) + ' 원';
        lbMCreditCnt.Caption := FormatFloat('#,##0', nMCreditCnt) + ' 건';
      end
      else
      begin
        lbMCreditTot.Caption := '0 원';
        lbMCreditCnt.Caption := '0 건';
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select ParkNo, UnitNo, UnitKind, ComPort, Baudrate, IPNo, PortNo ');
      SQL.Add('From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3  Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 13; // 출구무인...
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        sOutApsIp  := MG_StrTrim(FieldByName('IPNo').AsString, ' ');
        nOutApsPort:= FieldByName('PortNo').AsInteger;
        csAps.Host := sOutApsIP;
        csAps.Port := nOutApsPort;
        ExceptLogging('출구무인정산기: IP-' + sOutApsIp + ', Port-' + IntToStr(nOutApsPort));
      end
      else
        ExceptLogging('설치된 출구무인정산기 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select ParkNo, UnitNo, UnitKind, ComPort, Baudrate ');
      SQL.Add('From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 17; // 바코드스캐너
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        try
          comScanner.Open := False;
          comScanner.ComNumber := FieldByName('ComPort').AsInteger;
          comScanner.Baud := FieldByName('BaudRate').AsInteger;
          comScanner.Open := True;
        except
          on E: Exception do
            ExceptLogging('바코드스캐너 포트오픈 에러: ' + aString(E.Message));
        end;
      end
      else
        ExceptLogging('바코드스캐너가 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select ParkNo, UnitNo, UnitKind, ComPort, Baudrate ');
      SQL.Add('From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 19; // 마그네틱리더기
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        try
          comMSReader.Open := False;
          comMSReader.ComNumber := FieldByName('ComPort').AsInteger;
          comMSReader.Baud := FieldByName('BaudRate').AsInteger;
          comMSReader.Open := True;
        except
          on E: Exception do
            ExceptLogging('마그네틱리더기포트오픈 에러: ' + aString(E.Message));
        end;
      end
      else
        ExceptLogging('마그네틱리더기 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select ParkNo, UnitNo, UnitKind, ComPort, Baudrate ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3  Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 6; // 영수증프린터
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        try
          ComPrn.Open := False;
          ComPrn.ComNumber := FieldByName('ComPort').AsInteger;
          ComPrn.Baud := FieldByName('BaudRate').AsInteger;
          ComPrn.Open := True;
        except
          on E: Exception do
            ExceptLogging('영수증프린터 포트오픈 에러: ' + aString(E.Message));
        end;
      end
      else
        ExceptLogging('설치된 영수증프린터가 없음!');

      for i := 1 to 10 do
      begin
        RLpr[i].nUnitNo := 0;
        RLpr[i].nIO := 0;
      end;
      j := 1;

      sError := '';

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1  and MyNo = :N2 and ParkNo = :N3  Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 8; // 입구LPR
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMainNew do
          begin
            TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;

            if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;

            RLpr[j].nUnitNo := FieldByName('UnitNo').AsInteger;
            RLpr[j].sDspIP := FieldByName('Reserve1').AsString;
            RLpr[j].nIO := 1;
          end;
          csList.Add(TClientSocket(FindComponent('csInLpr' + IntToStr(i))));

          i := i + 1;
          j := j + 1;

          if i > 5 then
            Break;
          Next;
        end;
        bLPR := True;
      end
      else
        ExceptLogging('설치된 입구 LPR이 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3  Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 9; // 출구LPR
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;
        nowLpr := csOutLpr1;

        while not Eof do
        begin
          with frmMainNew do
          begin
            TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;

            if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;

            RLpr[j].nUnitNo := FieldByName('UnitNo').AsInteger;
            RLpr[j].sDspIP := FieldByName('Reserve1').AsString;
            RLpr[j].nIO := 2;
          end;
          csList.Add(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))));
          i := i + 1;
          j := j + 1;

          if i > 3 then
            Break;
          Next;
        end;
        bLPR := True;
      end
      else
        ExceptLogging('설치된 출구 LPR이 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3  Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 10; // 입구전광판
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMainNew do
          begin
            sTemp1 := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;

            if is_ping(TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
          end;
          i := i + 1;

          if i > 5 then
            Break;
          Next;
        end;
        bInDsp := True;
        mnuInDsp.Enabled := True;
        tInDsp.Enabled := True;
      end
      else
      begin
        bInDsp := False;
        ExceptLogging('설치된 입구전광판이 없음!');
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3  Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 11; // 출구전광판
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMainNew do
          begin
            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;

            if is_ping(TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString +
                ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
          end;
          i := i + 1;

          if i > 3 then
            Break;
          Next;
        end;
        bOutDsp := True;
        mnuOutDsp.Enabled := True;
        tOutDsp.Enabled := True;
      end
      else
      begin
        bOutDsp := False;
        ExceptLogging('설치된 출구전광판이 없음!');
      end;

      if sError <> '' then
        ShowMessage(sError);

      with lbReceipt do
      begin
        Items.Clear;

        for i := 1 to 10 do
        begin
          if RReceipt[i].sInOutTime <> '' then
            Items.Add(RReceipt[i].sInOutTime);
        end;
      end;
      nUseBtnCnt := 0;

      try
        with qryMainTemp do begin
          Close;
          SQL.Clear;
          SQL.Text := 'select count(*) from INFORMATION_SCHEMA.COLUMNS where table_name=:v1 and column_name=:v2';
          Parameters.ParamByName('v1').Value := 'FeeItem';
          Parameters.ParamByName('v2').Value := 'ButtonUse';
          Open;
          if Fields[0].Value = 0 then begin
            Close;
            SQL.Text := 'ALTER TABLE FeeItem ADD ButtonUse tinyint not null default 0';
            ExecSQL;
            ExceptLogging('요금제별 버튼 사용여부 DB컬럼 추가완료 : [dbo].[FeeItem].[ButtonUse]');
            ShowMessage('요금제별 버튼 사용여부 기능을 활성화를 위해 DB컬럼을 추가하였습니다. ' + #13#10 + ' [dbo].[FeeItem].[ButtonUse]');
          end;
        end;
      except
        on E: Exception do begin
          ExceptLogging('요금제별 버튼 사용여부 DB컬럼 추가중 : ' + E.Message);
        end;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * from FeeItem where ParkNo = :N1 and ButtonUse = 1 Order By FeeNo');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Open;
      i := 2;

      if RecordCount > 0 then
      begin
        nUseBtnCnt := RecordCount;

        while not Eof do
        begin
          with frmMainNew do
          begin
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Font.Color :=
              clGreen;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Text :=
              FieldByName('FeeName').AsString;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Tag :=
              FieldByName('FeeNo').AsInteger;
            TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Caption :=
              FieldByName('FeeName').AsString;
            TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Visible := True;
          end;
          Inc(i);
          Next;
        end;
      end;
      nFeeNo := 0;
      nItemMax := 0;
      nTotMax := 0;

      for j := 1 to 50 do
      begin
        RDCCnt[j].nDCNo := 0;
        RDCCnt[j].nDCUseCnt := 0;
        RDCCnt[j].nDCNowCnt := 0;
      end;
      //일반버튼할인만 가져오기//
      Close;
      SQL.Clear;
//      SQL.Add('Select * from DCInfo where ParkNo = :N2 Order By DCNo');
      SQL.Add('Select * from DCInfo where ParkNo = :N2 and RealUse = 1 and ButtonUse = 1 Order By VisibleCnt asc, DCNo asc ');    //유인정산기 할인버튼만 등록
      Parameters.ParamByName('N2').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        nDCList := RecordCount;
        nUseBtnCnt := nUseBtnCnt + nDCList;
        j := 1;
        First;

        while not Eof do
        begin
          with frmMainNew do
          begin
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Font.Color := clWhite;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Text := FieldByName('DCName').AsString;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Tag := FieldByName('DCNo').AsInteger + 100;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).GroupIndex := FieldByName('DCType').AsInteger;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Hint := IntToStr(FieldByName('DCValue').AsInteger);
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).ComponentIndex := FieldByName('DCUseCnt').AsInteger;
            TAdvShapeButton(FindComponent('btn' + IntToStr(i))).HelpContext := FieldByName('DCTypeCode').AsInteger;
            TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Caption := FieldByName('DCName').AsString;
            TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Visible := True;

            RDCCnt[j].nDCNo := FieldByName('DCNo').AsInteger + 100;
            RDCCnt[j].nDCUseCnt := FieldByName('DCUseCnt').AsInteger;
          end;
          Inc(i);
          Inc(j);
          Next;
        end;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 8; // 입구LPR
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMainNew do
          begin
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Caption := FieldByName('UnitName').AsString;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Hint := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).GroupIndex := FieldByName('PortNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).ImageIndex := FieldByName('MyNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Visible := True;
          end;
          i := i + 1;
          Next;
        end;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 9; // 출구LPR
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        while not Eof do
        begin
          with frmMainNew do
          begin
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Caption := FieldByName('UnitName').AsString;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Hint := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).GroupIndex := FieldByName('PortNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).ImageIndex := FieldByName('MyNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Visible := True;
          end;
          i := i + 1;
          Next;
        end;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * from UnitInfo where UnitNo = :N1');
      Parameters.ParamByName('N1').Value := nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        idTS.Active := False;
        idTS.DefaultPort := FieldByName('PortNo').AsInteger;
        idTS.Active := True;
      end;
    end;

    if bFCMode then
    begin
      FcModeChange(0);
    end
    else
    begin
      FcModeChange(1);
    end;

    if bMode then
    begin
      btnMode.Caption := '정산운영' ;
      btnMode.Tag := 1;
    end
    else
    begin
      btnMode.Caption := '개방운영';
      btnMode.Tag := 2;
    end;

    if nCreditlinkage then begin
      try
        m_nType := TRADE_LINK_CONFIRM;   //장비연결 코드
        nTRADEType := m_nType;
        frmCredit_SMT := TfrmCredit_SMT.Create(self);  //장비연결 코드
        frmCredit_SMT.TradeMain('9001'); //장비연결 코드
      except
        on E: Exception do begin
          ExceptLogging('### Smartro 신용카드 모듈 Load 실패 ###-' + aString(E.Message));
        end;
      end;
    end;
//    if nCreditlinkage then
//    begin
//      try
//        GetMem(pMsg, 4096);
//        nResult:= KLoad(nKiccPort, nKiccBaud, pMsg);
//        sMsg:= pMsg;
//
//        if nResult = 0 then
//        begin
//          InspectionLog('### KICC 신용카드 모듈 Load 성공 ###-' + sMsg);
//          bCreditLoad:= True;
//        end
//        else
//        begin
//          InspectionLog('### KICC 신용카드 모듈 Load 실패 ###-' + sMsg);
//          ShowMessage('신용카드 단말기 연결에 이상이 발생하여 '+#13#10+
//                      '신용카드 결제가 불가능합니다. '+#13#10+
//                      '관리자에 문의하여 주세요!');
//          bCreditLoad:= False;
//        end;
//      finally
//        FreeMem(pMsg);
//      end;
//    end;
    ClearFormData;
//    GridClear;

    //InCarList; //입차 조회
    //OutCarList; //출차 조회

    //LPR과의 연결이 끊기지않게 주기적으로 신호를 보낸다.
    lprLiveThd := TThread.CreateAnonymousThread(
      procedure
      var
        i:Integer;
      begin
        while not Application.Terminated do begin
          try
            Sleep(1000*15);
            for i := 0 to csList.Count-1 do begin
              if csList[i] <> nil then begin
                if TClientSocket(csList[i]).Active = False then begin
                  TClientSocket(csList[i]).Active := True; //재접속하고
                end else begin
                  TClientSocket(csList[i]).Socket.SendText('OK'); //얼라이브 보내자
//                  codesite.Send(TClientSocket(csList[i]).Host+','+IntToStr(TClientSocket(csList[i]).Port));
                end;
              end;
            end;
          except
            on E: Exception do
              ExceptLogging((TClientSocket(Parent.Controls[i]).Host) + ' 소켓 전송시 오류: ' + aString(E.Message));
          end;
        end;
      end);
    lprLiveThd.FreeOnTerminate := True;
    lprLiveThd.Start;
    Sleep(100);
    if lprLiveThd.Started = True then
      ExceptLogging('LPR재접속 쓰레드시작');

  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.FormShow: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.mnuSetupClick(Sender: TObject);
begin
  NextModalDialog(TfrmSetup.Create(Self));

  if bSetupChange and (nCurrMNo <> 99) then
  begin
    ShowMessage('환경설정이 변경되어 프로그램을 종료합니다.'#13#10 + '프로그램을 다시 시작하여 주세요!');
    bDirectClose:= True;
    Close;
  end;
end;

procedure TfrmMainNew.mnuUnitInfoClick(Sender: TObject);
begin
  NextModalDialog(TfrmUnitInfo.Create(Self));

  if bSetupChange and (nCurrMNo <> 99) then
  begin
    ShowMessage('환경설정이 변경되어 프로그램을 종료합니다.'#13#10 + '프로그램을 다시 시작하여 주세요!');
    bDirectClose:= True;
    Close;
  end;
end;

procedure TfrmMainNew.mnuSCSearchClick(Sender: TObject);
begin
  btnSCSearchClick(Self);
end;

procedure TfrmMainNew.mnuBarProcClick(Sender: TObject);
begin
  btnBarClick(Self);
end;

procedure TfrmMainNew.mnuClosingClick(Sender: TObject);
begin
  btnClosingClick(Self);
end;

procedure TfrmMainNew.mnuClosingPrtClick(Sender: TObject);
begin
  NextModalDialog(TfrmClosingPrint.Create(Self));
end;

procedure TfrmMainNew.mnuCarSearchClick(Sender: TObject);
begin
  btnCarSearchClick(Self);
end;

procedure TfrmMainNew.mnuManualInClick(Sender: TObject);
begin
  btnManualInClick(Self);
end;

procedure TfrmMainNew.mnuManualOutClick(Sender: TObject);
begin
  btnManualOutClick(Self);
end;

procedure TfrmMainNew.mnuSearchClick(Sender: TObject);
begin
  edtManualProcDate.Date := Now;
  edtManualOutCarNo1.Text := '';
  edtManualOutTime.Text := '  :  ';
  pnManualProc.Visible := True;
  edtManualProcCarNo.SetFocus;
end;

procedure TfrmMainNew.mnuDetailClick(Sender: TObject);
begin
  // 영수증...
  if mnuDetail.Tag = 0 then
  begin
    mnuDetail.Tag := 1;
    pnlReceipt.Visible := True;
    mnuDetail.Caption := '지난 영수증 숨기기';
  end
  else
  begin
    mnuDetail.Tag := 0;
    pnlReceipt.Visible := False;
    mnuDetail.Caption := '지난 영수증 보기';
  end;
end;

procedure TfrmMainNew.mnuInDspClick(Sender: TObject);
begin
  NextModalDialog(TfrmInDspSet.Create(Self));
end;

procedure TfrmMainNew.mnuOutDspClick(Sender: TObject);
begin
  NextModalDialog(TfrmDspSet.Create(Self));
end;

procedure TfrmMainNew.mnuReceiptPrtClick(Sender: TObject);
begin
  sReceiptPrt:= '';
  NextModalDialog(TfrmReceiptPrt.Create(Self));

  if (sReceiptPrt <> '') and comPrn.Open then
    comPrn.PutString(sReceiptPrt);
end;

procedure TfrmMainNew.tAliveTimer(Sender: TObject);
begin
    TrimAppMemorySize; //메모리 최적화
end;

procedure TfrmMainNew.tDbCheckTimer(Sender: TObject);
var
  sDBString : String;
begin
  try
    with dmTables.qryDbCheck do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select parkno from parkinfo');
      Open;
    end;

  except
    on E: Exception do
    begin
      ExceptLogging('tDbCheckTimer : DB접속 오류 : ' + aString(E.Message));

      sDBIP  := iSetup.ReadString('PARKING', 'DB IP', '');
      sDBID  := iSetup.ReadString('PARKING', 'DB ID', '');
      sDBPW  := iSetup.ReadString('PARKING', 'DB PW', '');
      sDBName:= iSetup.ReadString('PARKING', 'DB Name', '');

      dmTables.ADODB.Connected := False;
      sDBString := 'Provider=SQLOLEDB.1;Persist Security Info=True;';
      sDBString := sDBString + 'User ID=' + sDBID;
      sDBString := sDBString + ';Password=' + sDBPW;
      sDBString := sDBString + ';Initial Catalog=' + sDBName;
      sDBString := sDBString + ';Data Source=' + sDBIP;
      dmTables.ADODB.ConnectionString := wString(sDBString);
      dmTables.ADODB.Connected := True;

      ExceptLogging('tDbCheckTimer : 재접속 시도 완료');
    end;
  end;
end;

procedure TfrmMainNew.tInDspTimer(Sender: TObject);
var
  sSend, sDspData, sSpeed, sTime, sEffect: aString;
  sDsp1, sDsp2, sColor1, sColor2, sTemp1, sTemp2: aString;
  i: Byte;
begin
  try
    tInDsp.Enabled := False;
    sSend := '';
    sSpeed := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'IN_DSP_SPEED', 0)), 2);
    sTime := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'IN_DSP_TIME', 0)), 2);

    sDsp1 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'IN_DSP_1_1', '')), AnsiChar(39));
    sDsp2 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'IN_DSP_1_2', '')), AnsiChar(39));
    sTemp1 := iSetup.ReadString('PARKING', 'IN_DSP_COLOR_1_1', '');
    sTemp2 := iSetup.ReadString('PARKING', 'IN_DSP_COLOR_1_2', '');
    sColor1 := '';
    sColor2 := '';

    for i := 1 to 12 do
    begin
      sColor1 := sColor1 + AnsiChar(StrToInt('$0' + Copy(sTemp1, i, 1)));
    end;

    for i := 1 to 12 do
    begin
      sColor2 := sColor2 + AnsiChar(StrToInt('$0' + Copy(sTemp2, i, 1)));
    end;

    sEffect := AnsiChar($00) + // AnsiChar(StrToInt('$' + edtDspNo.Text)) + //문구블록
      AnsiChar($00) + // 배경이미지
      AnsiChar($00) + // 문구저장위치
      AnsiChar($61) + // AnsiChar(StrToInt('$' + edttt.Text)) + //폰트크기
      AnsiChar($00) + // 화면분할위치
      AnsiChar($00) + // 완성형
      AnsiChar($80) + // 분할화면효과없음
      AnsiChar($01) + // 메인화면효과
      AnsiChar(StrToInt('$' + sSpeed)) + // 속도
      AnsiChar(StrToInt('$' + sTime)) + // 정지시간
      AnsiChar($00); // 문구수직위치
    sSend := MakeDSPData(AnsiChar($53), sEffect, sColor1 + sColor2,
      sDsp1 + sDsp2);

    for i := 1 to 5 do
    begin
      if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active then
        TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend);
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.tInDspTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.tNCInWaitTimer(Sender: TObject);
begin
  try
    tNCInWait.Enabled := False;

    if not bNCInProcWait then
    begin
      ExceptLogging('일반차량 입차대기자료 처리: ' + IntToStr(nNCInWaitFlag)
          + ', ' + IntToStr(nNCInWaitPoint));

      if nNCInWaitPoint <> nNCInWaitFlag then
      begin
        if nNCInWaitFlag = 20 then
          nNCInWaitFlag := 1
        else
          nNCInWaitFlag := nNCInWaitFlag + 1;

        if RNCInWait[nNCInWaitFlag].sNCIOTime <> '' then
        begin
          NormalProc(RNCInWait[nNCInWaitFlag].sNCFile1,
            RNCInWait[nNCInWaitFlag].sNCCarNo1,
            RNCInWait[nNCInWaitFlag].sNCFile2, RNCInWait[nNCInWaitFlag]
              .sNCCarNo2, RNCInWait[nNCInWaitFlag].sNCIOTime,
            RNCInWait[nNCInWaitFlag].nNCLprNo,
            RNCInWait[nNCInWaitFlag].nNCInOut, RNCInWait[nNCInWaitFlag]
              .nNCRecog1, RNCInWait[nNCInWaitFlag].nNCRecog2,
            RNCInWait[nNCInWaitFlag].sNCDspIP, RNCInWait[nNCInWaitFlag]
              .csNCLPR, RNCInWait[nNCInWaitFlag].bBarOpen);

          RNCInWait[nNCInWaitFlag].sNCFile1 := '';
          RNCInWait[nNCInWaitFlag].sNCCarNo1 := '';
          RNCInWait[nNCInWaitFlag].sNCFile2 := '';
          RNCInWait[nNCInWaitFlag].sNCCarNo2 := '';
          RNCInWait[nNCInWaitFlag].sNCIOTime := '';
          RNCInWait[nNCInWaitFlag].nNCLprNo := 0;
          RNCInWait[nNCInWaitFlag].nNCInOut := 0;
          RNCInWait[nNCInWaitFlag].nNCRecog1 := 0;
          RNCInWait[nNCInWaitFlag].nNCRecog2 := 0;
          RNCInWait[nNCInWaitFlag].sNCDspIP := '';
          RNCInWait[nNCInWaitFlag].bBarOpen := False;
          RNCInWait[nNCInWaitPoint].nFeeNo := 0;
        end;

        if nNCInWaitPoint <> nNCInWaitFlag then
          tNCInWait.Enabled := True;
      end
      else
        tNCInWait.Enabled := False;
    end
    else
      tNCInWait.Enabled := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.tNCInWaitTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.tNCOutWaitTimer(Sender: TObject);
begin
  try
    tNCOutWait.Enabled := False;

    if not bNCOutProcWait then
    begin
      ExceptLogging('일반차량 출차대기자료 처리: ' + IntToStr(nNCOutWaitFlag)
          + ', ' + IntToStr(nNCOutWaitPoint));

      if nNCOutWaitPoint <> nNCOutWaitFlag then
      begin
        if nNCOutWaitFlag = 20 then
          nNCOutWaitFlag := 1
        else
          nNCOutWaitFlag := nNCOutWaitFlag + 1;

        if RNCOutWait[nNCOutWaitFlag].sNCIOTime <> '' then
        begin
          nNowCharo := RNCOutWait[nNCOutWaitPoint].nNCCharo;
          nUseFeeItem := RNCOutWait[nNCOutWaitFlag].nFeeNo;
          NormalProc(RNCOutWait[nNCOutWaitFlag].sNCFile1,
            RNCOutWait[nNCOutWaitFlag].sNCCarNo1,
            RNCOutWait[nNCOutWaitFlag].sNCFile2, RNCOutWait[nNCOutWaitFlag]
              .sNCCarNo2, RNCOutWait[nNCOutWaitFlag].sNCIOTime,
            RNCOutWait[nNCOutWaitFlag].nNCLprNo, RNCOutWait[nNCOutWaitFlag]
              .nNCInOut, RNCOutWait[nNCOutWaitFlag].nNCRecog1,
            RNCOutWait[nNCOutWaitFlag].nNCRecog2,
            RNCOutWait[nNCOutWaitFlag].sNCDspIP,
            RNCOutWait[nNCOutWaitFlag].csNCLPR, RNCOutWait[nNCOutWaitFlag]
              .bBarOpen);

          RNCOutWait[nNCOutWaitFlag].sNCFile1 := '';
          RNCOutWait[nNCOutWaitFlag].sNCCarNo1 := '';
          RNCOutWait[nNCOutWaitFlag].sNCFile2 := '';
          RNCOutWait[nNCOutWaitFlag].sNCCarNo2 := '';
          RNCOutWait[nNCOutWaitFlag].sNCIOTime := '';
          RNCOutWait[nNCOutWaitFlag].nNCLprNo := 0;
          RNCOutWait[nNCOutWaitFlag].nNCInOut := 0;
          RNCOutWait[nNCOutWaitFlag].nNCRecog1 := 0;
          RNCOutWait[nNCOutWaitFlag].nNCRecog2 := 0;
          RNCOutWait[nNCOutWaitFlag].sNCDspIP := '';
          RNCOutWait[nNCOutWaitFlag].bBarOpen := False;
          RNCOutWait[nNCOutWaitFlag].nFeeNo := 0;
        end;

        if nNCOutWaitPoint <> nNCOutWaitFlag then
          tNCOutWait.Enabled := True;
      end
      else
      begin
        tNCOutWait.Enabled := False;
      end;
    end
    else
      tNCOutWait.Enabled := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.tNCOutWaitTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.tOutDspTimer(Sender: TObject);
var
  sSend, sDspData, sSpeed, sTime, sEffect: aString;
  sDsp1, sDsp2, sColor1, sColor2, sTemp1, sTemp2: aString;
  i: Byte;
begin
  try
    tOutDsp.Enabled := False;
    sSend := '';
    sSpeed := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'DSP_SPEED', 0))
        , 2);
    sTime := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'DSP_TIME', 0)),
      2);

    sDsp1 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'DSP_1_1', '')),
      AnsiChar(39));
    sDsp2 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'DSP_1_2', '')),
      AnsiChar(39));
    sTemp1 := iSetup.ReadString('PARKING', 'DSP_COLOR_1_1', '');
    sTemp2 := iSetup.ReadString('PARKING', 'DSP_COLOR_1_2', '');
    sColor1 := '';
    sColor2 := '';

    for i := 1 to 12 do
    begin
      sColor1 := sColor1 + AnsiChar(StrToInt('$0' + Copy(sTemp1, i, 1)));
    end;

    for i := 1 to 12 do
    begin
      sColor2 := sColor2 + AnsiChar(StrToInt('$0' + Copy(sTemp2, i, 1)));
    end;

    sEffect := AnsiChar($00) + // AnsiChar(StrToInt('$' + edtDspNo.Text)) + //문구블록
      AnsiChar($00) + // 배경이미지
      AnsiChar($00) + // 문구저장위치
      AnsiChar($61) + // AnsiChar(StrToInt('$' + edttt.Text)) + //폰트크기
      AnsiChar($00) + // 화면분할위치
      AnsiChar($00) + // 완성형
      AnsiChar($80) + // 분할화면효과없음
      AnsiChar($01) + // 메인화면효과
      AnsiChar(StrToInt('$' + sSpeed)) + // 속도
      AnsiChar(StrToInt('$' + sTime)) + // 정지시간
      AnsiChar($00); // 문구수직위치
    sSend := MakeDSPData(AnsiChar($53), sEffect, sColor1 + sColor2,
      sDsp1 + sDsp2);

    for i := 1 to 3 do
    begin
      if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then
        TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText
          (sSend);
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.tOutDspTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.TrimAppMemorySize;
var
  MainHandle : THandle;
begin
  try
    MainHandle := OpenProcess(PROCESS_ALL_ACCESS, false, GetCurrentProcessID) ;
    SetProcessWorkingSetSize(MainHandle, $FFFFFFFF, $FFFFFFFF) ;
    CloseHandle(MainHandle) ;
    //ExceptLogging('Trimmed Memory Successfull!');
  except
    //ExceptLogging('Failed to trim Memory!');
  end;
  Application.ProcessMessages;
end;

procedure TfrmMainNew.tSCWaitTimer(Sender: TObject);
var
  sResult: String;
begin
  try
    tSCWait.Enabled := False;

    if not bSCProcWait then
    begin
      ExceptLogging('정기차량 대기자료 처리: ' + IntToStr(nSCWaitFlag) + ', ' + IntToStr
          (nSCWaitPoint));

      if nSCWaitPoint <> nSCWaitFlag then
      begin
        if nSCWaitFlag = 20 then
          nSCWaitFlag := 1
        else
          nSCWaitFlag := nSCWaitFlag + 1;

        if RSCWait[nSCWaitFlag].sSCIOTime <> '' then
        begin
          sResult := RecvLprProc(RSCWait[nSCWaitFlag].sSCFile1,
            RSCWait[nSCWaitFlag].sSCCarNo1, RSCWait[nSCWaitFlag].sSCFile2,
            RSCWait[nSCWaitFlag].sSCCarNo2, RSCWait[nSCWaitFlag].sSCIOTime,
            RSCWait[nSCWaitFlag].nSCLprNo, RSCWait[nSCWaitFlag].nSCInOut,
            RSCWait[nSCWaitFlag].nSCRecog1, RSCWait[nSCWaitFlag].nSCRecog2,
            RSCWait[nSCWaitFlag].sSCDspIP, RSCWait[nSCWaitFlag].csSCLPR,
            RSCWait[nSCWaitFlag].bBarOpen);
          GridData(sResult);
          RSCWait[nSCWaitFlag].sSCFile1 := '';
          RSCWait[nSCWaitFlag].sSCCarNo1 := '';
          RSCWait[nSCWaitFlag].sSCFile2 := '';
          RSCWait[nSCWaitFlag].sSCCarNo2 := '';
          RSCWait[nSCWaitFlag].sSCIOTime := '';
          RSCWait[nSCWaitFlag].nSCLprNo := 0;
          RSCWait[nSCWaitFlag].nSCInOut := 0;
          RSCWait[nSCWaitFlag].nSCRecog1 := 0;
          RSCWait[nSCWaitFlag].nSCRecog2 := 0;
          RSCWait[nSCWaitFlag].sSCDspIP := '';
          RSCWait[nSCWaitFlag].bBarOpen := False;
        end;

        if nSCWaitPoint <> nSCWaitFlag then
          tSCWait.Enabled := True;
      end
      else
        tSCWait.Enabled := False;
    end
    else
      tSCWait.Enabled := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.tSCWaitTimer: ' + aString(E.Message));
  end;
end;

function TfrmMainNew.RecvLprProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; bOpen: Boolean): String;
var
  sRecv, sSend, sName, sFileIP: aString;
  nSTXPos, nETXPos, nParkNo, nUnitNo: Integer;

  sCardNo, sLastUseTime, sSTime, sETime, sCarNo, sMarkNo, sGroupName,
    sSCInDate, sSCInTime, sCompName, sDeptName, sExpDateF, sExpDateT, sLprDate,
    sLprTime, sTemp, sInFile, sIssueMoney: aString;
  nInOut, nStatus, nAPB, nWP, nSYoil, nEYoil, nCarNo, nGroupNo: Integer;
//  nGroupNo1,nGroupNo2,nGroupNo3,nGroupNo4: Integer;
  nLastUnitNo: Byte;
  nIBCRC: Word;
  bHoliday: Boolean;
  nUseFlag, nLastStatus: Byte;
  nDayBetween: Cardinal;
  //디비 속도 향상
  RecvLpr_Field, RecvLpr_Field2, RecvLpr_Field3, RecvLpr_Field4, RecvLpr_Field5,
  RecvLpr_Field6, RecvLpr_Field7, RecvLpr_Field8, RecvLpr_Field9, RecvLpr_Field10,
  RecvLpr_Field11, RecvLpr_Field12, RecvLpr_Field13, RecvLpr_Field14, RecvLpr_Field15,
  RecvLpr_Field16, RecvLpr_Field17, RecvLpr_Field18, RecvLpr_Field19: TField;
begin
  try
    try
      bSCProcWait := True;
      // 정기차량 처리....
      ExceptLogging('정기차량시작: ' + sLprCarNo1 + ', ' + sLprCarNo2);
      Result := '^^^^^^';
      nParkNo := nCurrParkNo;
      nUnitNo := nLprNo;
      nInOut := nLprInOut;
      nCarNo := 0;
      nLastUnitNo := 0;
      sCardNo := '';
      sMarkNo := '';
      bHoliday := False;
      sLprDate := Copy(sIOTime, 1, 10);
      sLprTime := Copy(sIOTime, 12, 8);

      //디비 속도 향상
      RecvLpr_Field  := TField.Create(self);
      RecvLpr_Field2 := TField.Create(self);
      RecvLpr_Field3 := TField.Create(self);
      RecvLpr_Field4 := TField.Create(self);
      RecvLpr_Field5 := TField.Create(self);
      RecvLpr_Field6 := TField.Create(self);
      RecvLpr_Field7 := TField.Create(self);
      RecvLpr_Field8 := TField.Create(self);
      RecvLpr_Field9 := TField.Create(self);
      RecvLpr_Field10 := TField.Create(self);
      RecvLpr_Field11 := TField.Create(self);
      RecvLpr_Field12 := TField.Create(self);
      RecvLpr_Field13 := TField.Create(self);
      RecvLpr_Field14 := TField.Create(self);
      RecvLpr_Field15 := TField.Create(self);
      RecvLpr_Field16 := TField.Create(self);
      RecvLpr_Field17 := TField.Create(self);
      RecvLpr_Field18 := TField.Create(self);
      RecvLpr_Field19 := TField.Create(self);

      with dmTables.qryRecvLpr1 do
      begin
        Close;
        SQL.Clear;

        if sLprCarNo2 <> '' then
        begin
          SQL.Add('Select * from CustInfo WITH(NOLOCK) ');
          SQL.Add('where (CarNo = :N1) or (CarNo = :N2) and TKType = 2 and ParkNo = :N3');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
          Parameters.ParamByName('N2').Value := sLprCarNo2;
          Parameters.ParamByName('N3').Value := nCurrParkNo;
        end
        else
        begin
          SQL.Add('Select * from CustInfo WITH(NOLOCK) where CarNo = :N1 and TKType = 2 and ParkNo = :N2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
          Parameters.ParamByName('N2').Value := nCurrParkNo;
        end;
        Open;

        if RecordCount > 0 then
        begin
          //21.03.15 디비 속도 향상
          RecvLpr_Field := FieldByName('TKNo');
          RecvLpr_Field2 := FieldByName('MarkNo');
          RecvLpr_Field3 := FieldByName('Status');
          RecvLpr_Field4 := FieldByName('APB');
          RecvLpr_Field5 := FieldByName('IOStatusNo');
          RecvLpr_Field6 := FieldByName('LastUseDate');
          RecvLpr_Field7 := FieldByName('LastUseTime');
          RecvLpr_Field8 := FieldByName('WPNo');
          RecvLpr_Field9 := FieldByName('GroupNo');
          RecvLpr_Field10 := FieldByName('Name');
          RecvLpr_Field11 := FieldByName('LastUnitNo');
          RecvLpr_Field12 := FieldByName('CompName');
          RecvLpr_Field13 := FieldByName('DeptName');
          RecvLpr_Field14 := FieldByName('ExpDateF');
          RecvLpr_Field15 := FieldByName('ExpDateT');
          RecvLpr_Field16 := FieldByName('CarNo');
          RecvLpr_Field17 := FieldByName('IssueAmt');

          sCardNo := RecvLpr_Field.AsString;
          sMarkNo := RecvLpr_Field2.AsString;
          nStatus := RecvLpr_Field3.AsInteger;
          nAPB    := RecvLpr_Field4.AsInteger;
          nLastStatus  := RecvLpr_Field5.AsInteger;
          sLastUseTime := RecvLpr_Field6.AsString + ' ' + RecvLpr_Field7.AsString;
          nWP := RecvLpr_Field8.AsInteger;
          nGroupNo := RecvLpr_Field9.AsInteger;
          sName    := RecvLpr_Field10.AsString;
          nLastUnitNo := RecvLpr_Field11.AsInteger;
          sCompName := RecvLpr_Field12.AsString;
          sDeptName := RecvLpr_Field13.AsString;
          sExpDateF := RecvLpr_Field14.AsString;
          sExpDateT := RecvLpr_Field15.AsString;
          sCarNo    := RecvLpr_Field16.AsString;
          sIssueMoney := RecvLpr_Field17.AsString;


//          sCardNo := FieldByName('TKNo').AsString;
//          sMarkNo := FieldByName('MarkNo').AsString;
//          nStatus := FieldByName('Status').AsInteger;
//          nAPB := FieldByName('APB').AsInteger;
//          nLastStatus := FieldByName('IOStatusNo').AsInteger;
//          sLastUseTime := FieldByName('LastUseDate')
//            .AsString + ' ' + FieldByName('LastUseTime').AsString;
//          nWP := FieldByName('WPNo').AsInteger;
////          nGroupNo1 := FieldByName('GroupNo1').AsInteger;
////          nGroupNo2 := FieldByName('GroupNo2').AsInteger;
////          nGroupNo3 := FieldByName('GroupNo3').AsInteger;
////          nGroupNo4 := FieldByName('GroupNo4').AsInteger;
//          nGroupNo := FieldByName('GroupNo').AsInteger;
//          sName := FieldByName('Name').AsString;
//          nLastUnitNo := FieldByName('LastUnitNo').AsInteger;
//          sCompName := FieldByName('CompName').AsString;
//          sDeptName := FieldByName('DeptName').AsString;
//          sExpDateF := FieldByName('ExpDateF').AsString;
//          sExpDateT := FieldByName('ExpDateT').AsString;
//          sCarNo := FieldByName('CarNo').AsString;
//          sIssueMoney := FieldByName('IssueAmt').AsString;
//          Result := sLprDate + '^' + sLprTime + '^' + sCarNo + '^' + sName +
//            '^' + sCompName + '^' + sExpDateT + '까지^';
        end;
//        Close;
//        SQL.Clear;
//        //GGroupDepth
//        SQL.Add('Select * from GGroupDepth where ParkNo = :N1 and GroupDepthNo = :N2');
//        Parameters.ParamByName('N1').Value := nCurrParkNo;
//        Parameters.ParamByName('N2').Value := nGroupNo1;
//        Open;
//
//        if RecordCount > 0 then
//        begin
//          sCompName := FieldByName('GroupName').AsString;
//        end;
          Result := sLprDate + '^' + sLprTime + '^' + sCarNo + '^' + sName +
            '^' + sCompName + '^' + sExpDateT + '까지^';
      end;

      if sExpDateT = FormatDateTime('YYYY-MM-DD', Now) then
        nDayBetween:= 0
      else
        nDayBetween:= DaysBetween(Now, StrToDate(sExpDateT))+1;

      with dmTables do
      begin
        nSYoil := 1;
        nEYoil := 7;
        sSTime := '00:00';
        sETime := '23:59';

        with qryRecvLpr2 do
        begin
          Close;
          SQL.Clear;
          //GGroupDepth
          SQL.Add('Select * from GGroup WITH(NOLOCK) where ParkNo = :N1 and GroupNo = :N2');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nGroupNo;
          Open;

          if RecordCount > 0 then
          begin
            //sGroupName := FieldByName('GroupName').AsString;
            //nGroupType := FieldByName('GroupType').AsInteger;
            //21.03.15 디비 속도 향상
            RecvLpr_Field18 := FieldByName('GroupName');
            RecvLpr_Field19 := FieldByName('GroupType');
            sGroupName := RecvLpr_Field19.AsString;
            nGroupType := RecvLpr_Field19.AsInteger;
//            nUseFeeItem := FieldByName('UseFeeItem').AsInteger;
          end;
        end;

        // 현재 사용기간내에 있으면...
        if (sExpDateF <= FormatDateTime('YYYY-MM-DD', Now)) and
          (sExpDateT >= FormatDateTime('YYYY-MM-DD', Now)) then
        begin
          // 입출구 구분(입구용:1, 출구용:2)
          if nInOut = 1 then
          begin
            if ((nSYoil <= DayOfWeek(Now)) and (nEYoil >= DayOfWeek(Now)) and
                (sSTime <= FormatDateTime('HH:NN', Now)) and
                (sETime >= FormatDateTime('HH:NN', Now))) then
            begin
              // 상태(발매:0, 사용중:1, 전체봉쇄:3, 입차봉쇄:4, 출차봉쇄:5)
              Case nStatus of
                0:
                  begin // 발매
                   if nInProcUse then begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add(
                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');

                        // APB가 "1회조정(2)" 이면 APB를 "자동(1)"으로 변경한다.
                        if nAPB = 2 then
                          SQL.Add(', APB = :N10 ');

                        SQL.Add(
                          'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                        Parameters.ParamByName('N1').Value := nCurrParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 1;
                        Parameters.ParamByName('N6').Value := 1;
                        Parameters.ParamByName('N7').Value := nCurrParkNo;
                        Parameters.ParamByName('N8').Value := 2;
                        Parameters.ParamByName('N9').Value := sCarNo;

                        if nAPB = 2 then
                          Parameters.ParamByName('N10').Value := 1;
                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                        SQL.Add(
                          'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                        SQL.Add(
                          'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                        SQL.Add(
                          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                        SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17)');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;
                        Parameters.ParamByName('N6').Value := 2;
                        Parameters.ParamByName('N7').Value := nGroupNo;
                        Parameters.ParamByName('N8').Value := sGroupName;
                        Parameters.ParamByName('N9').Value := sCompName;
                        Parameters.ParamByName('N10').Value := sDeptName;
                        Parameters.ParamByName('N11').Value := sName;
                        Parameters.ParamByName('N12').Value := sLprCarNo1;
                        Parameters.ParamByName('N13').Value := 1;
                        Parameters.ParamByName('N14').Value := sLprFile1;
                        Parameters.ParamByName('N15').Value := sLprCarNo2;
                        Parameters.ParamByName('N16').Value := sLprFile2;
                        Parameters.ParamByName('N17').Value := sCardNo;
                        ExecSQL;
                      end;
//
                      if nSCRemain >= nDayBetween then
                        DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                      else
                        DspProc(1, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                      if bOpen then
                        InOpen(csLPR);
                    end;
                    Result := '1' + Result + '입 차';
                  end;

                1, 5:
                  begin // 정상, 출차봉쇄
                    if nAPB = 1 then // 자동
                    begin
                      if (nLastStatus = 1) or (nLastStatus = 8) then
                      // 주차장, APB위반 입차거부
                      begin
                        if nInProcUse then begin
                          with qryRecvLpr2 do
                          begin
                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                            SQL.Add(
                              'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                            SQL.Add(
                              'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 9;
                            Parameters.ParamByName('N6').Value := nParkNo;
                            Parameters.ParamByName('N7').Value := 2;
                            Parameters.ParamByName('N8').Value := sCarNo;
                            ExecSQL;

                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                            SQL.Add(
                              'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                            SQL.Add(
                              'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) '
                              );
                            SQL.Add(
                              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                            SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 2;
                            Parameters.ParamByName('N7').Value := nGroupNo;
                            Parameters.ParamByName('N8').Value := sGroupName;
                            Parameters.ParamByName('N9').Value := sCompName;
                            Parameters.ParamByName('N10').Value := sDeptName;
                            Parameters.ParamByName('N11').Value := sName;
                            Parameters.ParamByName('N12').Value := sLprCarNo1;
                            Parameters.ParamByName('N13').Value := 7;
                            Parameters.ParamByName('N14').Value := sLprFile1;
                            Parameters.ParamByName('N15').Value := sLprCarNo2;
                            Parameters.ParamByName('N16').Value := sLprFile2;
                            Parameters.ParamByName('N17').Value := sCardNo;
                            ExecSQL;
                          end;
  //
                          if nSCRemain >= nDayBetween then
                            DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                          else
                            DspProc(1, 1, 'APB위반차량 ' + MG_Left(sCarNo, 12), sDspIP);
                        end;
                        Result := '1' + Result + 'APB위반';
                        ExceptLogging('##### APB 위반 차량 #####');
                      end
                      else
                      begin
                        // 최종사용상태가 주차장 또는 APB위반 입차거부가 아니면 입차처리한다.
                          if nInProcUse then begin
                          with qryRecvLpr2 do
                          begin
                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                            SQL.Add(
                              'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                            SQL.Add(
                              'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 1;
                            Parameters.ParamByName('N6').Value := 1;
                            Parameters.ParamByName('N7').Value := nParkNo;
                            Parameters.ParamByName('N8').Value := 2;
                            Parameters.ParamByName('N9').Value := sCarNo;
                            ExecSQL;

                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                            SQL.Add(
                              'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                            SQL.Add(
                              'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) '
                              );
                            SQL.Add(
                              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                            SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 2;
                            Parameters.ParamByName('N7').Value := nGroupNo;
                            Parameters.ParamByName('N8').Value := sGroupName;
                            Parameters.ParamByName('N9').Value := sCompName;
                            Parameters.ParamByName('N10').Value := sDeptName;
                            Parameters.ParamByName('N11').Value := sName;
                            Parameters.ParamByName('N12').Value := sLprCarNo1;
                            Parameters.ParamByName('N13').Value := 1;
                            Parameters.ParamByName('N14').Value := sLprFile1;
                            Parameters.ParamByName('N15').Value := sLprCarNo2;
                            Parameters.ParamByName('N16').Value := sLprFile2;
                            Parameters.ParamByName('N17').Value := sCardNo;
                            ExecSQL;
                          end;
  //
                          if nSCRemain >= nDayBetween then
                            DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                          else
                            DspProc(1, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                          if bOpen then
                            InOpen(csLPR);
                        end;
                        Result := '1' + Result + '입 차';
                      end;
                    end
                    else if nAPB = 2 then
                    begin
                      // APB가 1회조정이면 APB를 자동으로 변경한다.
                      if nInProcUse then begin
                        with qryRecvLpr2 do
                        begin
                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                          SQL.Add(
                            'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                          SQL.Add(
                            'Status = :N6, APB = :N10 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 1;
                          Parameters.ParamByName('N6').Value := 1;
                          Parameters.ParamByName('N7').Value := nParkNo;
                          Parameters.ParamByName('N8').Value := 2;
                          Parameters.ParamByName('N9').Value := sCarNo;
                          Parameters.ParamByName('N10').Value := 1;
                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                          SQL.Add(
                            'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                          SQL.Add(
                            'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                          SQL.Add(
                            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                          SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 2;
                          Parameters.ParamByName('N7').Value := nGroupNo;
                          Parameters.ParamByName('N8').Value := sGroupName;
                          Parameters.ParamByName('N9').Value := sCompName;
                          Parameters.ParamByName('N10').Value := sDeptName;
                          Parameters.ParamByName('N11').Value := sName;
                          Parameters.ParamByName('N12').Value := sLprCarNo1;
                          Parameters.ParamByName('N13').Value := 1;
                          Parameters.ParamByName('N14').Value := sLprFile1;
                          Parameters.ParamByName('N15').Value := sLprCarNo2;
                          Parameters.ParamByName('N16').Value := sLprFile2;
                          Parameters.ParamByName('N17').Value := sCardNo;
                          ExecSQL;
                        end;
  //
                        if nSCRemain >= nDayBetween then
                          DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                        else
                          DspProc(1, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                        if bOpen then
                          InOpen(csLPR);
                      end;
                      Result := '1' + Result + '입 차';
                    end
                    else if nAPB = 3 then
                    begin
                      // APB사용안함이면 입차처리한다.
                      if nInProcUse then begin
                        with qryRecvLpr2 do
                        begin
                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                          SQL.Add(
                            'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                          SQL.Add(
                            'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 1;
                          Parameters.ParamByName('N6').Value := 1;
                          Parameters.ParamByName('N7').Value := nParkNo;
                          Parameters.ParamByName('N8').Value := 2;
                          Parameters.ParamByName('N9').Value := sCarNo;
                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                          SQL.Add(
                            'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                          SQL.Add(
                            'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                          SQL.Add(
                            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                          SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 2;
                          Parameters.ParamByName('N7').Value := nGroupNo;
                          Parameters.ParamByName('N8').Value := sGroupName;
                          Parameters.ParamByName('N9').Value := sCompName;
                          Parameters.ParamByName('N10').Value := sDeptName;
                          Parameters.ParamByName('N11').Value := sName;
                          Parameters.ParamByName('N12').Value := sLprCarNo1;
                          Parameters.ParamByName('N13').Value := 1;
                          Parameters.ParamByName('N14').Value := sLprFile1;
                          Parameters.ParamByName('N15').Value := sLprCarNo2;
                          Parameters.ParamByName('N16').Value := sLprFile2;
                          Parameters.ParamByName('N17').Value := sCardNo;
                          ExecSQL;
                        end;
  //
                        if nSCRemain >= nDayBetween then
                          DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                        else
                          DspProc(1, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                        if bOpen then
                          InOpen(csLPR);
                      end;
                      Result := '1' + Result + '입 차';
                    end;
                  end;

                2:
                  begin // 기간만료
                    if nInProcUse then begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add(
                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');

                        // APB가 "1회조정(2)" 이면 APB를 "자동(1)"으로 변경한다.
                        if nAPB = 2 then
                          SQL.Add(', APB = :N10 ');

                        SQL.Add(
                          'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                        Parameters.ParamByName('N1').Value := nCurrParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 1;
                        Parameters.ParamByName('N6').Value := 1;
                        Parameters.ParamByName('N7').Value := nCurrParkNo;
                        Parameters.ParamByName('N8').Value := 2;
                        Parameters.ParamByName('N9').Value := sCarNo;

                        if nAPB = 2 then
                          Parameters.ParamByName('N10').Value := 1;
                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                        SQL.Add(
                          'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                        SQL.Add(
                          'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                        SQL.Add(
                          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                        SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17)');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;
                        Parameters.ParamByName('N6').Value := 2;
                        Parameters.ParamByName('N7').Value := nGroupNo;
                        Parameters.ParamByName('N8').Value := sGroupName;
                        Parameters.ParamByName('N9').Value := sCompName;
                        Parameters.ParamByName('N10').Value := sDeptName;
                        Parameters.ParamByName('N11').Value := sName;
                        Parameters.ParamByName('N12').Value := sLprCarNo1;
                        Parameters.ParamByName('N13').Value := 1;
                        Parameters.ParamByName('N14').Value := sLprFile1;
                        Parameters.ParamByName('N15').Value := sLprCarNo2;
                        Parameters.ParamByName('N16').Value := sLprFile2;
                        Parameters.ParamByName('N17').Value := sCardNo;
                        ExecSQL;
                      end;
  //
                      if nSCRemain >= nDayBetween then
                        DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                      else
                        DspProc(1, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                      if bOpen then
                        InOpen(csLPR);
                    end;
                    Result := '1' + Result + '입 차';
                  end;

                3, 4:
                  begin // 전체봉쇄, 입차봉쇄
                    if nInProcUse then begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add(
                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                        SQL.Add(
                          'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 9;
                        Parameters.ParamByName('N6').Value := nParkNo;
                        Parameters.ParamByName('N7').Value := 2;
                        Parameters.ParamByName('N8').Value := sCarNo;
                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                        SQL.Add(
                          'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                        SQL.Add(
                          'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                        SQL.Add(
                          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                        SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;
                        Parameters.ParamByName('N6').Value := 2;
                        Parameters.ParamByName('N7').Value := nGroupNo;
                        Parameters.ParamByName('N8').Value := sGroupName;
                        Parameters.ParamByName('N9').Value := sCompName;
                        Parameters.ParamByName('N10').Value := sDeptName;
                        Parameters.ParamByName('N11').Value := sName;
                        Parameters.ParamByName('N12').Value := sLprCarNo1;
                        Parameters.ParamByName('N13').Value := 9;
                        Parameters.ParamByName('N14').Value := sLprFile1;
                        Parameters.ParamByName('N15').Value := sLprCarNo2;
                        Parameters.ParamByName('N16').Value := sLprFile2;
                        Parameters.ParamByName('N17').Value := sCardNo;
                        ExecSQL;
                      end;
  //
                      if nSCRemain >= nDayBetween then
                        DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                      else
                        DspProc(1, 1, '봉쇄차량    ' + MG_Left(sCarNo, 12), sDspIP);
                    end;
                    Result := '1' + Result + '봉쇄차량';
                    ExceptLogging('##### 전체 또는 입차봉쇄 카드 #####');
                  end;
              end;
            end
            else
            begin
              if nInProcUse then begin
                with qryRecvLpr2 do
                begin
                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                  SQL.Add(
                    'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                  SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                  Parameters.ParamByName('N1').Value := nParkNo;
                  Parameters.ParamByName('N2').Value := nUnitNo;
                  Parameters.ParamByName('N3').Value := sLprDate;
                  Parameters.ParamByName('N4').Value := sLprTime;
                  Parameters.ParamByName('N5').Value := 18;
                  Parameters.ParamByName('N7').Value := nParkNo;
                  Parameters.ParamByName('N8').Value := 2;
                  Parameters.ParamByName('N9').Value := sCarNo;
                  ExecSQL;

                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                  SQL.Add(
                    'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                  SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                  SQL.Add(
                    'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                  SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                  Parameters.ParamByName('N1').Value := nParkNo;
                  Parameters.ParamByName('N2').Value := nUnitNo;
                  Parameters.ParamByName('N3').Value := sLprDate;
                  Parameters.ParamByName('N4').Value := sLprTime;
                  Parameters.ParamByName('N5').Value := 2;
                  Parameters.ParamByName('N6').Value := 2;
                  Parameters.ParamByName('N7').Value := nGroupNo;
                  Parameters.ParamByName('N8').Value := sGroupName;
                  Parameters.ParamByName('N9').Value := sCompName;
                  Parameters.ParamByName('N10').Value := sDeptName;
                  Parameters.ParamByName('N11').Value := sName;
                  Parameters.ParamByName('N12').Value := sLprCarNo1;
                  Parameters.ParamByName('N13').Value := 5;
                  Parameters.ParamByName('N14').Value := sLprFile1;
                  Parameters.ParamByName('N15').Value := sLprCarNo2;
                  Parameters.ParamByName('N16').Value := sLprFile2;
                  Parameters.ParamByName('N17').Value := sCardNo;
                  ExecSQL;
                end;
  //
                if nSCRemain >= nDayBetween then
                  DspProc(1, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                else
                  DspProc(1, 1, '사용시간위반' + MG_Left(sCarNo, 12), sDspIP);
              end;
              Result := '1' + Result + 'WP위반';
              ExceptLogging('##### 사용시간대(WP) 위반 #####');
            end;
          end
          else if nInOut = 2 then // 출구용
          begin
            if Copy(sLprFile1, 1, 4) = 'http' then
            begin
                sTemp := Copy(sLprFile1, 6, Length(sLprFile1) - 5);
                sLprFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
                sLprFile1 := sLprFile1 + Copy
                  (sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) -
                    (Pos(':9080', sTemp) + 4));
                sLprFile1 := MG_StrConvert(sLprFile1, '/', '\');
                ExceptLogging(sLprFile1);
            end;

            lbOutCarType.Caption := '정기차량';
            lbOutCarNo.Caption := sCarNo;
            sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);
//
//            try
//              if is_ping(sFileIP) then
//              begin
//                if FileExists(sLprFile1) then
//                begin
//                  imgOut.Picture.LoadFromFile(sLprFile1);
//                end
//                else
//                begin
//                  imgOut.Picture.Assign(Nil);
//                  ExceptLogging('File 없음: ' + sLprFile1);
//                end;
//              end
//              else
//              begin
//                imgOut.Picture.Assign(Nil);
//                ExceptLogging('File 없음: ' + sLprFile1);
//              end;
//            except
//              on E: Exception do
//                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
//            end;

            if ((nSYoil <= DayOfWeek(Now)) and (nEYoil >= DayOfWeek(Now)) and
                (sSTime <= FormatDateTime('HH:NN', Now)) and
                (sETime >= FormatDateTime('HH:NN', Now))) then
            begin
              Case nStatus of
                0:
                  begin // 발매
                    //차단기 전광판 상위로 이동
                    if nSCRemain >= nDayBetween then
                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                    else
                      DspProc(2, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);
                    OutOpen(csLPR);

                    with qryRecvLpr2 do
                    begin
                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                      SQL.Add(
                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
                      SQL.Add(
                        'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 2;
                      Parameters.ParamByName('N6').Value := 1;
                      Parameters.ParamByName('N7').Value := nParkNo;
                      Parameters.ParamByName('N8').Value := 2;
                      Parameters.ParamByName('N9').Value := sCarNo;
                      ExecSQL;

                      Close;
                      SQL.Clear;
                      SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                      SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                      SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                      SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                      SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                      SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 2;
                      Parameters.ParamByName('N6').Value := 2;
                      Parameters.ParamByName('N7').Value := nGroupNo;
                      Parameters.ParamByName('N8').Value := sGroupName;
                      Parameters.ParamByName('N9').Value := sCompName;
                      Parameters.ParamByName('N10').Value := sDeptName;
                      Parameters.ParamByName('N11').Value := sName;
                      Parameters.ParamByName('N12').Value := sCarNo;
                      Parameters.ParamByName('N13').Value := 1;
                      Parameters.ParamByName('N14').Value := '';
                      Parameters.ParamByName('N15').Value := nUnitNo;
                      Parameters.ParamByName('N16').Value := sLprDate;
                      Parameters.ParamByName('N17').Value := sLprTime;
                      Parameters.ParamByName('N18').Value := sLprFile1;
                      Parameters.ParamByName('N19').Value := sLprCarNo1;
                      Parameters.ParamByName('N20').Value := 2;
                      Parameters.ParamByName('N21').Value := sLprFile2;
                      Parameters.ParamByName('N22').Value := sLprCarNo2;
                      Parameters.ParamByName('N23').Value := sCardNo;
                      ExecSQL;
                    end;
                    //Result := '2' + Result + '출 차'; //sIssueMoney
                    Result := '2' + Result + '출차';

//                    if nSCRemain >= nDayBetween then
//                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
//                    else
//                      DspProc(2, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);
//                    OutOpen(csLPR);
                  end;

                1, 4:
                  begin // 사용중, 입차봉쇄
                    Result := '2' + Result + '출차';
                    if nSCRemain >= nDayBetween then
                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                    else
                      DspProc(2, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                    OutOpen(csLPR);
                    with qryRecvLpr2 do
                    begin
                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                      SQL.Add(
                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                      SQL.Add(
                        'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 2;
                      Parameters.ParamByName('N6').Value := 1;
                      Parameters.ParamByName('N7').Value := nParkNo;
                      Parameters.ParamByName('N8').Value := 2;
                      Parameters.ParamByName('N9').Value := sCarNo;
                      ExecSQL;

                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) and ParkNo = :N3 ');
                      SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                      Parameters.ParamByName('N1').Value := sCarNo;
                      Parameters.ParamByName('N2').Value := sCarNo;
                      Parameters.ParamByName('N3').Value := nParkNo;
                      Open;

                      if RecordCount > 0 then
                      begin
                        First;

                        if FieldByName('OutDate').AsString = '' then
                        begin
                          // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                          sSCInDate := FieldByName('ProcDate').AsString;
                          sSCInTime := FieldByName('ProcTime').AsString;
                          nLastUnitNo := FieldByName('UnitNo').AsInteger;
                          sInFile := FieldByName('InImage1').AsString;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                          SQL.Add(
                            'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                          SQL.Add(
                            'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                          SQL.Add(
                            'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10 and ParkNo = :N14');
                          Parameters.ParamByName('N1').Value := nUnitNo;
                          Parameters.ParamByName('N2').Value := sLprDate;
                          Parameters.ParamByName('N3').Value := sLprTime;
                          Parameters.ParamByName('N4').Value := 2;
                          Parameters.ParamByName('N5').Value := sLprFile1;
                          Parameters.ParamByName('N6').Value := sLprCarNo1;
                          Parameters.ParamByName('N7').Value := sCarNo;
                          Parameters.ParamByName('N8').Value := sSCInDate;
                          Parameters.ParamByName('N9').Value := sSCInTime;
                          Parameters.ParamByName('N10').Value := nLastUnitNo;
                          Parameters.ParamByName('N11').Value := sCarNo;
                          Parameters.ParamByName('N12').Value := sLprFile2;
                          Parameters.ParamByName('N13').Value := sLprCarNo2;
                          Parameters.ParamByName('N14').Value := nParkNo;
                          ExecSQL;
//                          데이터 변형
                          if Copy(sInFile, 1, 4) = 'http' then
                          begin
                            ExceptLogging('정기차량 입차 파일 확인 File: ' + sInFile);
                            sTemp:= Copy(sInFile, 6, Length(sInFile)-5);
                            sInFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
                            sInFile:= sInFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
                            sInFile:= MG_StrConvert(sInFile, '/', '\');
                            ExceptLogging('HTTP 형식 입차 File: ' + sInFile);
                          end
                          else
                          begin
                            sInFile  := sInFile;
                          end;
                          sFileIP:= Copy(sInFile, 3, Pos('\MSIMAGE', sInFile)-3);

//
//                          sTemp := Copy(sInFile, 6, Length(sInFile) - 5);
//                          sInFile := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
//                          sInFile := sInFile + Copy
//                            (sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) -
//                              (Pos(':9080', sTemp) + 4));
//                          sInFile := MG_StrConvert(sInFile, '/', '\');
//                          ExceptLogging('File: ' + sInFile);
//                          sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);

                          //숭실대학교 출차 시 입차 이미지 표출 안함
                          try
                            if is_ping(sFileIP) then
                            begin
                              if FileExists(sInFile) then
                              begin
                                imgIn.Picture.LoadFromFile(sInFile);
                              end
                              else
                              begin
                                imgIn.Picture.Assign(Nil);
                                ExceptLogging('File 없음: ' + sInFile);
                              end;
                            end
                            else
                            begin
                              imgIn.Picture.Assign(Nil);
                              ExceptLogging('File 없음: ' + sInFile);
                            end;
                          except
                            on E: Exception do
                              ExceptLogging('File Load: (' + sInFile + ') ' + aString(E.Message));
                          end;
                        end
                        else
                        begin
                          // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                            Close;
                            SQL.Clear;
                            SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                            SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                            SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                            SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                            SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                            SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 2;
                            Parameters.ParamByName('N7').Value := nGroupNo;
                            Parameters.ParamByName('N8').Value := sGroupName;
                            Parameters.ParamByName('N9').Value := sCompName;
                            Parameters.ParamByName('N10').Value := sDeptName;
                            Parameters.ParamByName('N11').Value := sName;
                            Parameters.ParamByName('N12').Value := sCarNo;
                            Parameters.ParamByName('N13').Value := 2;   // Modified by LJH 2020-04-01 16:39:01 8->2 왜 APB위반인지?
                            Parameters.ParamByName('N14').Value := '';
                            Parameters.ParamByName('N15').Value := nUnitNo;
                            Parameters.ParamByName('N16').Value := sLprDate;
                            Parameters.ParamByName('N17').Value := sLprTime;
                            Parameters.ParamByName('N18').Value := sLprFile1;
                            Parameters.ParamByName('N19').Value := sLprCarNo1;
                            Parameters.ParamByName('N20').Value := 2;   // Modified by LJH 2020-04-01 16:39:01 8->2 왜 APB위반인지?
                            Parameters.ParamByName('N21').Value := sLprFile2;
                            Parameters.ParamByName('N22').Value := sLprCarNo2;
                            Parameters.ParamByName('N23').Value := sCardNo;
                            ExecSQL;
                        end;
                      end;
                    end;
                      //Result := '2' + Result + '출 차';     //sIssueMoney
//                      Result := '2' + Result + '출차';
//                      if nSCRemain >= nDayBetween then
//                        DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
//                      else
//                        DspProc(2, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);
//
//                      OutOpen(csLPR);
                  end;

                2:
                  begin // 기간만료
                    Result := '2' + Result + '출차';
                    if nSCRemain >= nDayBetween then
                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                    else
                      DspProc(2, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);

                    OutOpen(csLPR);
                    with qryRecvLpr2 do
                    begin
                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                      SQL.Add(
                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
                      SQL.Add(
                        'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 2;
                      Parameters.ParamByName('N6').Value := 1;
                      Parameters.ParamByName('N7').Value := nParkNo;
                      Parameters.ParamByName('N8').Value := 2;
                      Parameters.ParamByName('N9').Value := sCarNo;
                      ExecSQL;

                      Close;
                      SQL.Clear;
                      SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                      SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                      SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                      SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                      SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                      SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 2;
                      Parameters.ParamByName('N6').Value := 2;
                      Parameters.ParamByName('N7').Value := nGroupNo;
                      Parameters.ParamByName('N8').Value := sGroupName;
                      Parameters.ParamByName('N9').Value := sCompName;
                      Parameters.ParamByName('N10').Value := sDeptName;
                      Parameters.ParamByName('N11').Value := sName;
                      Parameters.ParamByName('N12').Value := sCarNo;
                      Parameters.ParamByName('N13').Value := 1;
                      Parameters.ParamByName('N14').Value := '';
                      Parameters.ParamByName('N15').Value := nUnitNo;
                      Parameters.ParamByName('N16').Value := sLprDate;
                      Parameters.ParamByName('N17').Value := sLprTime;
                      Parameters.ParamByName('N18').Value := sLprFile1;
                      Parameters.ParamByName('N19').Value := sLprCarNo1;
                      Parameters.ParamByName('N20').Value := 2;
                      Parameters.ParamByName('N21').Value := sLprFile2;
                      Parameters.ParamByName('N22').Value := sLprCarNo2;
                      Parameters.ParamByName('N23').Value := sCardNo;
                      ExecSQL;
                    end;
                    //Result := '2' + Result + '출 차';    //sIssueMoney
//                    Result := '2' + Result + sIssueMoney;
//                    if nSCRemain >= nDayBetween then
//                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
//                    else
//                      DspProc(2, 1, '정기등록차량' + MG_Left(sCarNo, 12), sDspIP);
//
//                    OutOpen(csLPR);
                  end;

                3, 5:
                  begin // 전체봉쇄, 출차봉쇄
                    if nSCRemain >= nDayBetween then
                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
                    else
                      DspProc(2, 1, '  봉쇄차량  ' + MG_Left(sCarNo, 12), sDspIP);

                    with qryRecvLpr2 do
                    begin
                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                      SQL.Add(
                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                      SQL.Add(
                        'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 10;
                      Parameters.ParamByName('N6').Value := nParkNo;
                      Parameters.ParamByName('N7').Value := 2;
                      Parameters.ParamByName('N8').Value := sCarNo;
                      ExecSQL;

                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Select * from IOSData WITH(NOLOCK) where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) and ParkNo = :N3 ');
                      SQL.Add('Order By InDate Desc, InTime Desc');
                      Parameters.ParamByName('N1').Value := sCarNo;
                      Parameters.ParamByName('N2').Value := sCarNo;
                      Parameters.ParamByName('N3').Value := nParkNo;
                      Open;

                      if RecordCount > 0 then
                      begin
                        First;

                        if FieldByName('OutDate').AsString = '' then
                        begin
                          // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                          sSCInDate := FieldByName('ProcDate').AsString;
                          sSCInTime := FieldByName('ProcTime').AsString;
                          nLastUnitNo := FieldByName('UnitNo').AsInteger;
                          sInFile := FieldByName('InImage1').AsString;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                          SQL.Add(
                            'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                          SQL.Add(
                            'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                          SQL.Add(
                            'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10 and ParkNo = :N14');
                          Parameters.ParamByName('N1').Value := nUnitNo;
                          Parameters.ParamByName('N2').Value := sLprDate;
                          Parameters.ParamByName('N3').Value := sLprTime;
                          Parameters.ParamByName('N4').Value := 10;
                          Parameters.ParamByName('N5').Value := sLprFile1;
                          Parameters.ParamByName('N6').Value := sLprCarNo1;
                          Parameters.ParamByName('N7').Value := sCarNo;
                          Parameters.ParamByName('N8').Value := sSCInDate;
                          Parameters.ParamByName('N9').Value := sSCInTime;
                          Parameters.ParamByName('N10').Value := nLastUnitNo;
                          Parameters.ParamByName('N11').Value := sCarNo;
                          Parameters.ParamByName('N12').Value := sLprFile2;
                          Parameters.ParamByName('N13').Value := sLprCarNo2;
                          Parameters.ParamByName('N14').Value := nParkNo;
                          ExecSQL;

                          if Copy(sInFile, 1, 4) = 'http' then
                          begin
                            ExceptLogging('정기차량 입차 파일 확인 File: ' + sInFile);
                            sTemp:= Copy(sInFile, 6, Length(sInFile)-5);
                            sInFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
                            sInFile:= sInFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
                            sInFile:= MG_StrConvert(sInFile, '/', '\');
                            ExceptLogging('HTTP 형식 입차 File: ' + sInFile);
                          end
                          else
                          begin
                            sInFile  := sInFile;
                          end;
                          sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);

                          //숭실대학교 출차 시 입차이미지 표출 안함
                          try
                            if is_ping(sFileIP) then
                            begin
                              if FileExists(sInFile) then
                              begin
                                imgIn.Picture.LoadFromFile(sInFile);
                              end
                              else
                              begin
                                imgIn.Picture.Assign(Nil);
                                ExceptLogging('File 없음: ' + sInFile);
                              end;
                            end
                            else
                            begin
                              imgIn.Picture.Assign(Nil);
                              ExceptLogging('File 없음: ' + sInFile);
                            end;
                          except
                            on E: Exception do
                              ExceptLogging('File Load: (' + sInFile + ') ' + aString(E.Message));
                          end;
                        end
                        else
                        begin
                          // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                          Close;
                          SQL.Clear;
                          SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                          SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                          SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                          SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                          SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 2;
                          Parameters.ParamByName('N7').Value := nGroupNo;
                          Parameters.ParamByName('N8').Value := sGroupName;
                          Parameters.ParamByName('N9').Value := sCompName;
                          Parameters.ParamByName('N10').Value := sDeptName;
                          Parameters.ParamByName('N11').Value := sName;
                          Parameters.ParamByName('N12').Value := sCarNo;
                          Parameters.ParamByName('N13').Value := 2;  // Modified by LJH 2020-04-01 16:39:01 10->2 왜 봉쇄중 출차시도인지?
                          Parameters.ParamByName('N14').Value := '';
                          Parameters.ParamByName('N15').Value := nUnitNo;
                          Parameters.ParamByName('N16').Value := sLprDate;
                          Parameters.ParamByName('N17').Value := sLprTime;
                          Parameters.ParamByName('N18').Value := sLprFile1;
                          Parameters.ParamByName('N19').Value := sLprCarNo1;
                          Parameters.ParamByName('N20').Value := 2;  // Modified by LJH 2020-04-01 16:39:01 10->2 왜 봉쇄중 출차시도인지?
                          Parameters.ParamByName('N21').Value := sLprFile2;
                          Parameters.ParamByName('N22').Value := sLprCarNo2;
                          Parameters.ParamByName('N23').Value := sCardNo;
                          ExecSQL;
                        end;
                      end;
                    end;
                    Result := '2' + Result + '봉쇄중';

//                    if nSCRemain >= nDayBetween then
//                      DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
//                    else
//                      DspProc(2, 1, '  봉쇄차량  ' + MG_Left(sCarNo, 12), sDspIP);

                    ExceptLogging('##### 전체 또는 출차봉쇄 카드(출차) #####');
                  end;
              end;
            end
            else
            begin
              with qryRecvLpr2 do
              begin
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                SQL.Add(
                  'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                Parameters.ParamByName('N1').Value := nParkNo;
                Parameters.ParamByName('N2').Value := nUnitNo;
                Parameters.ParamByName('N3').Value := sLprDate;
                Parameters.ParamByName('N4').Value := sLprTime;
                Parameters.ParamByName('N5').Value := 6;
                Parameters.ParamByName('N7').Value := nParkNo;
                Parameters.ParamByName('N8').Value := 2;
                Parameters.ParamByName('N9').Value := sCarNo;
                ExecSQL;

                Close;
                SQL.Clear;
                SQL.Add('Select * from IOSData WITH(NOLOCK) where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) and ParkNo = :N3 ');
                SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                Parameters.ParamByName('N1').Value := sCarNo;
                Parameters.ParamByName('N2').Value := sCarNo;
                Parameters.ParamByName('N3').Value := nParkNo;
                Open;

                if RecordCount > 0 then
                begin
                  First;

                  if FieldByName('OutDate').AsString = '' then
                  begin
                    // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                    sSCInDate := FieldByName('ProcDate').AsString;
                    sSCInTime := FieldByName('ProcTime').AsString;
                    nLastUnitNo := FieldByName('UnitNo').AsInteger;
                    sInFile := FieldByName('InImage1').AsString;

                    Close;
                    SQL.Clear;
                    SQL.Add(
                      'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                    SQL.Add(
                      'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                    SQL.Add
                      ('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                    SQL.Add(
                      'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10 and ParkNo = :N14');
                    Parameters.ParamByName('N1').Value := nUnitNo;
                    Parameters.ParamByName('N2').Value := sLprDate;
                    Parameters.ParamByName('N3').Value := sLprTime;
                    Parameters.ParamByName('N4').Value := 6;
                    Parameters.ParamByName('N5').Value := sLprFile1;
                    Parameters.ParamByName('N6').Value := sLprCarNo1;
                    Parameters.ParamByName('N7').Value := sCarNo;
                    Parameters.ParamByName('N8').Value := sSCInDate;
                    Parameters.ParamByName('N9').Value := sSCInTime;
                    Parameters.ParamByName('N10').Value := nLastUnitNo;
                    Parameters.ParamByName('N11').Value := sCarNo;
                    Parameters.ParamByName('N12').Value := sLprFile2;
                    Parameters.ParamByName('N13').Value := sLprCarNo2;
                    Parameters.ParamByName('N14').Value := nParkNo;
                    ExecSQL;

                    if Copy(sInFile, 1, 4) = 'http' then
                    begin
                      ExceptLogging('정기차량 입차 파일 확인 File: ' + sInFile);
                      sTemp:= Copy(sInFile, 6, Length(sInFile)-5);
                      sInFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
                      sInFile:= sInFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
                      sInFile:= MG_StrConvert(sInFile, '/', '\');
                      ExceptLogging('HTTP 형식 입차 File: ' + sInFile);
                    end
                    else
                    begin
                      sInFile  := sInFile;
                    end;
                    sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);


                    //숭실대학교 출차 시 입차이미지 표출 안함
                    try
                      if is_ping(sFileIP) then
                      begin
                        if FileExists(sInFile) then
                        begin
                          imgIn.Picture.LoadFromFile(sInFile);
                        end
                        else
                        begin
                          imgIn.Picture.Assign(Nil);
                          ExceptLogging('File 없음: ' + sInFile);
                        end;
                      end
                      else
                      begin
                        imgIn.Picture.Assign(Nil);
                        ExceptLogging('File 없음: ' + sInFile);
                      end;
                    except
                      on E: Exception do
                        ExceptLogging('File Load: (' + sInFile + ') ' + aString(E.Message));
                    end;
                  end
                  else
                  begin
                    // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                     Close;
                    SQL.Clear;
                    SQL.Add(
                      'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                    SQL.Add(
                      'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                    SQL.Add(
                      'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                    SQL.Add(
                      'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                    SQL.Add(
                      'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                    SQL.Add(
                      ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                    Parameters.ParamByName('N1').Value := nParkNo;
                    Parameters.ParamByName('N2').Value := nUnitNo;
                    Parameters.ParamByName('N3').Value := sLprDate;
                    Parameters.ParamByName('N4').Value := sLprTime;
                    Parameters.ParamByName('N5').Value := 2;
                    Parameters.ParamByName('N6').Value := 2;
                    Parameters.ParamByName('N7').Value := nGroupNo;
                    Parameters.ParamByName('N8').Value := sGroupName;
                    Parameters.ParamByName('N9').Value := sCompName;
                    Parameters.ParamByName('N10').Value := sDeptName;
                    Parameters.ParamByName('N11').Value := sName;
                    Parameters.ParamByName('N12').Value := sCarNo;
                    Parameters.ParamByName('N13').Value := 2;   // Modified by LJH 2020-04-01 16:40:26 6->2 왜 W/P 위반인지?
                    Parameters.ParamByName('N14').Value := '';
                    Parameters.ParamByName('N15').Value := nUnitNo;
                    Parameters.ParamByName('N16').Value := sLprDate;
                    Parameters.ParamByName('N17').Value := sLprTime;
                    Parameters.ParamByName('N18').Value := sLprFile1;
                    Parameters.ParamByName('N19').Value := sLprCarNo1;
                    Parameters.ParamByName('N20').Value := 2;   // Modified by LJH 2020-04-01 16:40:26 6->2 왜 W/P 위반인지?
                    Parameters.ParamByName('N21').Value := sLprFile2;
                    Parameters.ParamByName('N22').Value := sLprCarNo2;
                    Parameters.ParamByName('N23').Value := sCardNo;
                    ExecSQL;
                  end;
                end;
              end;
              Result := '2' + Result + '시간위반';

              if nSCRemain >= nDayBetween then
                DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sCarNo, 12), sDspIP)
              else
                DspProc(2, 1, '사용시간위반' + MG_Left(sCarNo, 12), sDspIP);

              ExceptLogging('##### 사용시간대(WP) 위반(출차) #####');
            end;
            //출구이미지 표출 아래로 이동
            try
              if is_ping(sFileIP) then
              begin
                if FileExists(sLprFile1) then
                begin
                  imgOut.Picture.LoadFromFile(sLprFile1);
                end
                else
                begin
                  imgOut.Picture.Assign(Nil);
                  ExceptLogging('File 없음: ' + sLprFile1);
                end;
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                ExceptLogging('File 없음: ' + sLprFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;
          end
          else if nInOut = 3 then // 재인식기
          begin
            //
          end;
        end
        else
        begin
          // 카드사용기간 오류처리..
          with qryRecvLpr2 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
            SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
            SQL.Add('where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
            Parameters.ParamByName('N1').Value := nParkNo;
            Parameters.ParamByName('N2').Value := nUnitNo;
            Parameters.ParamByName('N3').Value := sLprDate;
            Parameters.ParamByName('N4').Value := sLprTime;
            Parameters.ParamByName('N5').Value := 3;
            Parameters.ParamByName('N6').Value := nParkNo;
            Parameters.ParamByName('N7').Value := 2;
            Parameters.ParamByName('N8').Value := sCarNo;
            ExecSQL;

            Close;
            SQL.Clear;
            SQL.Add('Select * from IOSData WITH(NOLOCK) where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) and ParkNo = :N3 ');
            SQL.Add('Order By ProcDate Desc, ProcTime Desc');
            Parameters.ParamByName('N1').Value := sCarNo;
            Parameters.ParamByName('N2').Value := sCarNo;
            Parameters.ParamByName('N3').Value := nParkNo;
            Open;

            if RecordCount > 0 then
            begin
              First;

              if FieldByName('OutDate').AsString = '' then
              begin
                // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                sSCInDate := FieldByName('ProcDate').AsString;
                sSCInTime := FieldByName('ProcTime').AsString;
                nLastUnitNo := FieldByName('UnitNo').AsInteger;
                sInFile := FieldByName('InImage1').AsString;

                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                SQL.Add(
                  'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                SQL.Add('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                SQL.Add('ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10 and ParkNo = :N14');
                Parameters.ParamByName('N1').Value := nUnitNo;
                Parameters.ParamByName('N2').Value := sLprDate;
                Parameters.ParamByName('N3').Value := sLprTime;
                Parameters.ParamByName('N4').Value := 3;
                Parameters.ParamByName('N5').Value := sLprFile1;
                Parameters.ParamByName('N6').Value := sLprCarNo1;
                Parameters.ParamByName('N7').Value := sCarNo;
                Parameters.ParamByName('N8').Value := sSCInDate;
                Parameters.ParamByName('N9').Value := sSCInTime;
                Parameters.ParamByName('N10').Value := nLastUnitNo;
                Parameters.ParamByName('N11').Value := sCarNo;
                Parameters.ParamByName('N12').Value := sLprFile2;
                Parameters.ParamByName('N13').Value := sLprCarNo2;
                Parameters.ParamByName('N14').Value := nParkNo;
                ExecSQL;

                if Copy(sInFile, 1, 4) = 'http' then
                begin
                  ExceptLogging('정기차량 입차 파일 확인 File: ' + sInFile);
                  sTemp:= Copy(sInFile, 6, Length(sInFile)-5);
                  sInFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
                  sInFile:= sInFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
                  sInFile:= MG_StrConvert(sInFile, '/', '\');
                  ExceptLogging('HTTP 형식 입차 File: ' + sInFile);
                end
                else
                begin
                  sInFile  := sInFile;
                end;
                sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);

//                sTemp := Copy(sInFile, 6, Length(sInFile) - 5);
//                sInFile := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
//                sInFile := sInFile + Copy
//                  (sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) -
//                    (Pos(':9080', sTemp) + 4));
//                sInFile := MG_StrConvert(sInFile, '/', '\');
//                ExceptLogging('File: ' + sInFile);
//                sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);


                //숭실대학교 출차 시 입차이미지 표출 안함
                try
                  if is_ping(sFileIP) then
                  begin
                    if FileExists(sInFile) then
                    begin
                      imgIn.Picture.LoadFromFile(sInFile);
                    end
                    else
                    begin
                      imgIn.Picture.Assign(Nil);
                      ExceptLogging('File 없음: ' + sInFile);
                    end;
                  end
                  else
                  begin
                    imgIn.Picture.Assign(Nil);
                    ExceptLogging('File 없음: ' + sInFile);
                  end;
                except
                  on E: Exception do
                    ExceptLogging('File Load: (' + sInFile + ') ' + aString(E.Message));
                end;
              end
              else
              begin
                // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                Close;
                SQL.Clear;
                SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                Parameters.ParamByName('N1').Value := nParkNo;
                Parameters.ParamByName('N2').Value := nUnitNo;
                Parameters.ParamByName('N3').Value := sLprDate;
                Parameters.ParamByName('N4').Value := sLprTime;
                Parameters.ParamByName('N5').Value := 2;
                Parameters.ParamByName('N6').Value := 2;
                Parameters.ParamByName('N7').Value := nGroupNo;
                Parameters.ParamByName('N8').Value := sGroupName;
                Parameters.ParamByName('N9').Value := sCompName;
                Parameters.ParamByName('N10').Value := sDeptName;
                Parameters.ParamByName('N11').Value := sName;
                Parameters.ParamByName('N12').Value := sCarNo;
                Parameters.ParamByName('N13').Value := 3;
                Parameters.ParamByName('N14').Value := '';
                Parameters.ParamByName('N15').Value := nUnitNo;
                Parameters.ParamByName('N16').Value := sLprDate;
                Parameters.ParamByName('N17').Value := sLprTime;
                Parameters.ParamByName('N18').Value := sLprFile1;
                Parameters.ParamByName('N19').Value := sLprCarNo1;
                Parameters.ParamByName('N20').Value := 3;
                Parameters.ParamByName('N21').Value := sLprFile2;
                Parameters.ParamByName('N22').Value := sLprCarNo2;
                Parameters.ParamByName('N23').Value := sCardNo;
                ExecSQL;
              end;
            end;
          end;

          if nInOut = 1 then
          begin
            Result := '1' + Result + '유효기간';
            DspProc(1, 1, '사용기간위반' + MG_Left(sCarNo, 12), sDspIP);
          end
          else if nInOut = 2 then
          begin
            Result := '2' + Result + '유효기간';
            DspProc(2, 1, '사용기간위반' + MG_Left(sCarNo, 12), sDspIP);
          end;
          ExceptLogging('##### 사용기간 오류 - 사용시작일: ' + sExpDateF + ', 사용종료일: ' +
              sExpDateT + ' #####');
        end;
      end;
      ExceptLogging('정기차량처리: ' + sLprCarNo1 + ', ' + sLprCarNo2);
    except
      on E: Exception do
        ExceptLogging('RecvLprProc: ' + aString(E.Message));
    end;

  finally
    bSCProcWait := False;
  end;
end;

procedure TfrmMainNew.btnSCCancelClick(Sender: TObject);
begin
  sManualSCCarNo := '';
  pnSCSearch.Visible := False;
end;

procedure TfrmMainNew.sgInDblClickCell(Sender: TObject; ARow, ACol: Integer);
var
  sTemp, sFileIP, sTempFile: aString;
begin
  if ARow > 0 then
  begin
    nGridCheck := 1;
    nModRow := ARow;

    if (MG_StrTrim(sgIn.Cells[7, ARow], ' ') = '입차') then
    begin
      if sgIn.Cells[0, ARow] <> '일반차량' then
      begin
        ShowMessage('일반차량의 차량번호만 수정이 가능합니다.');
        Exit;
      end;
      sOrgCarNo := MG_StrTrim(sgIn.Cells[3, ARow], ' ');
      sOrgDate := sgIn.Cells[1, ARow];
      sOrgTime := sgIn.Cells[2, ARow];
      edtMCarNo.Text := sOrgCarNo;

      with dmTables.qryTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from IONdata WITH(NOLOCK) where ParkNo = :N1 and ((InCarNo1 = :N2) or ');
        SQL.Add('(InCarNo2 = :N3)) and ProcDate = :N4 and ProcTime = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := sOrgCarNo;
        Parameters.ParamByName('N3').Value := sOrgCarNo;
        Parameters.ParamByName('N4').Value := sOrgDate;
        Parameters.ParamByName('N5').Value := sOrgTime;
        Open;

        if RecordCount > 0 then
        begin
          sOrgFile := FieldByName('InImage1').AsString;
          nOrgUnitNo := FieldByName('UnitNo').AsInteger;
        end;
      end;

      try
//        sTemp := Copy(sOrgFile, 6, Length(sOrgFile) - 5);
//        sTempFile := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
//        sTempFile := sTempFile + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
//            (sTemp) - (Pos(':9080', sTemp) + 4));
//        sTempFile := MG_StrConvert(sTempFile, '/', '\');
//        ExceptLogging('File: ' + sTempFile);
//        sFileIP:= Copy(sTempFile, 3, Pos('\MSImage', sTempFile)-3);
        if Copy(sOrgFile, 1, 4) = 'http' then
        begin
          ExceptLogging('일반차량 입차 파일 확인 File: ' + sOrgFile);
          sTemp:= Copy(sOrgFile, 6, Length(sOrgFile)-5);
          sTempFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
          sTempFile:= sTempFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
          sTempFile:= MG_StrConvert(sTempFile, '/', '\');
          ExceptLogging('HTTP 형식 입차 File: ' + sTempFile);
        end
        else
        begin
          sTempFile  := sOrgFile;
        end;
        sFileIP:= Copy(sTempFile, 3, Pos('\MSImage', sTempFile)-3);
        if is_ping(sFileIP) then
        begin
          if FileExists(sTempFile) then
          begin
            imgModify.Picture.LoadFromFile(sTempFile);
          end
          else
          begin
            imgModify.Picture.Assign(Nil);
            ExceptLogging('File 없음: ' + sTempFile);
          end;
        end
        else
        begin
          imgModify.Picture.Assign(Nil);
          ExceptLogging('File 없음: ' + sTempFile);
        end;
      except
        on E: Exception do
          ExceptLogging('sgInDblClickCell_ModifyImageLoad: ' + aString(E.Message));
      end;
      pnModify.Visible := True;
      edtMCarNo.SetFocus;
      edtMCarNo.SelectAll;
    end
    else
      ShowMessage('입차 차량번호만 수정이 가능합니다.');
  end;
end;

procedure TfrmMainNew.MichulProc(sCarNo, sProcDate, sProcTime: AnsiString);
begin
  if (sCarNo <> '') and (sCarNo <> '0000000000') then
  begin
    try
      with dmTables.qryMichulProc do
      begin
        Close;
        SQL.Clear;
        SQL.Add
          ('Update IONData Set OutChk = :N1, OutDate = :N2, OutTime = :N3 ');
        SQL.Add('where ((InCarNo1 = :N4) or (InCarNo2 = :N5)) and OutChk = 0');
        Parameters.ParamByName('N1').Value := 7;
        Parameters.ParamByName('N2').Value := sProcDate;
        Parameters.ParamByName('N3').Value := sProcTime;
        Parameters.ParamByName('N4').Value := sCarNo;
        Parameters.ParamByName('N5').Value := sCarNo;
        ExecSQL;
      end;
    except
      on E: Exception do
        ExceptLogging('TfrmMainNew.MichulProc: ' + aString(E.Message));
    end;
  end;
end;

procedure TfrmMainNew.NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket);
var
  sNow, sInCarNo, sInTKNo, sInDate, sInTime, sParking, sInFile, sImgFile1,
    sImgFile2, sLocalFile, sTime, sDir, sYogum, sTemp, sFileIP, sOutFile,sLprCarNo1Check : aString;
  nDay, nHour, nMin, nSec, nOutCnt,nMiddleRealtime: Cardinal;
  sSCInDate, sSCInTime, sGroupName, sCompName, sDeptName, sName, sCardNo, sExpDateT , sResult: aString;
  nGroupNo : Integer;
  nInUnitNo, i: Word;
  hr: HRESULT;
  nLastUnitNo: Byte;

  //정기차량 처리용 변수
  nDayBetween: Cardinal;

  //디비 속도 향상
  NormalOut_Field, NormalOut_Field2, NormalOut_Field3, NormalOut_Field4, NormalOut_Field5,
  NormalOut_Field6, NormalOut_Field7, NormalOut_Field8, NormalOut_Field9, NormalOut_Field10 : TField;
  nOutChk : Integer;
  nTKNo, nInImage1, nInImage2, nProcDate, nProcTime, nOutDate, nOutTime : aString;
  asYogum : Integer;
begin
  // 일반차량 출차처리...
  try
//    DJSM_FeeCalc(0, '2020-01-21 03:00:00', '2020-01-25 00:15:00');
    ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량 출차처리 시작' );
    bNCOutProcWait := True;
    nowLpr := csLPR;
    lbOutCarType.Caption := '일반차량';
    lbDCName.Caption := '';
    bApsPay := false;
    bCompactCar := false;
    bFixedUse := false;
    bUseMiddle := false;
    nMiddleRealtime := 0;
    nISCCD :='';//ocs 할인코드
    nTotYogum2 :=0;//최초 요금 초기화

     //디비 속도 향상
    NormalOut_Field  := TField.Create(self);
    NormalOut_Field2 := TField.Create(self);
    NormalOut_Field3 := TField.Create(self);
    NormalOut_Field4 := TField.Create(self);
    NormalOut_Field5 := TField.Create(self);
    NormalOut_Field6 := TField.Create(self);
    NormalOut_Field7 := TField.Create(self);
    NormalOut_Field8 := TField.Create(self);
    NormalOut_Field9 := TField.Create(self);
    NormalOut_Field10 := TField.Create(self);

    if (not bMiProc) then
    begin
      if ((sLprCarNo1 = '0000000000') and (sLprCarNo2 = '')) or
        ((sLprCarNo2 = '0000000000') and (sLprCarNo1 = '')) or
        ((sLprCarNo1 = '0000000000') and (sLprCarNo2 = '0000000000')) or
        ((sLprCarNo1 = '') and (sLprCarNo2 = '')) or
        ((Pos('X', sLprCarNo1) > 0) and (sLprCarNo2 = '')) or
        ((Pos('X', sLprCarNo2) > 0) and (sLprCarNo1 = '')) then
      begin
        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량 미인식 : 미인식 출차');
        if bTest then
        begin
          OutOpen(nowLpr);
          bNCOutProcWait := False;
          Exit;
        end;

        if bFreeTime then
        begin
          if bFreeTimeChk then
          begin
            // 시작시각이 크다.
            if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) or
              (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
            begin
              OutOpen(nowLpr);
              bNCOutProcWait := False;
              Exit;
            end;
          end
          else
          begin
            if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) and
              (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
            begin
              OutOpen(nowLpr);
              bNCOutProcWait := False;
              Exit;
            end;
          end;
        end;

        //부경대학교 개방운영 추가
        if not bMode then begin
          OutOpen(nowLpr);
          bNCOutProcWait := False;
          Exit;
        end;

        if bOperation then
        begin
          case nNowCharo of
            1:
              edtCharo.Color := clWhite;
            2:
              edtCharo.Color := clYellow;
            3:
              edtCharo.Color := clAqua;
          end;
          edtCharo.Text := IntToStr(nNowCharo) + '번 차로';

           // 미인식차량 처리...
           if Copy(sLprFile1, 1, 4) = 'http' then
           begin
              sTemp := Copy(sLprFile1, 6, Length(sLprFile1) - 5);
              sLprFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
              sLprFile1 := sLprFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
                  (sTemp) - (Pos(':9080', sTemp) + 4));
              sLprFile1 := MG_StrConvert(sLprFile1, '/', '\');
              ExceptLogging('sLprFile1: '+sLprFile1);
              //sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);
           end;
           sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);
          try
            if is_ping(sFileIP) then
            begin
              if FileExists(sLprFile1) then
              begin
                imgOut.Picture.LoadFromFile(sLprFile1);
                imgManual.Picture.LoadFromFile(sLprFile1);
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                imgManual.Picture.Assign(Nil);
                ExceptLogging('File 없음: ' + sLprFile1);
              end;
            end
            else
            begin
              imgOut.Picture.Assign(Nil);
              imgManual.Picture.Assign(Nil);
              ExceptLogging('File 없음: ' + sLprFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;
          // ShowMessage('미인식차량입니다. 차량검색 또는 수동출차로 처리하여주세요!');
          //부경대학교 개방운영 추가
          if not bMode then begin
          //FreeTimeProc(nowLpr);
            OutOpen(nowLpr);
            bNCOutProcWait := False;
            Exit;
          end;

          edtManualProcDate.Date := Now;
          edtManualOutCarNo1.Text := sLprCarNo1;
          edtManualOutTime.Text := '  :  ';
          pnManualProc.Visible := True;  //미인식
          edtManualProcCarNo.SetFocus;
        end;

        sNowLprFile1 := sLprFile1;
        sNowLprCarNo1 := sLprCarNo1;
        sNowLprFile2 := sLprFile2;
        sNowLprCarNo2 := sLprCarNo2;
        sNowIOTime := sIOTime;
        nNowLprNo := nLprNo;
        nNowLprInOut := nLprInOut;
        nNowLprRecog1 := nLprRecog1;
        nNowLprRecog2 := nLprRecog2;
        sNowInTKNo := '';
        nNowInUnitNo := nCurrUnitNo;
        sNowInDate := '';
        sNowInTime := '';
        sNowInCarNo := '';
        sNowOutDate := '';
        sNowOutTime := '';
        sNowInFile := '';
        Exit;
      end;
    end;

    with dmTables.qryNormalOut1 do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from Gracetime WITH(NOLOCK) where ParkNo = :N1');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
        with GTime do
        begin
          GT1  := FieldByName('GT1').AsString;
          GT2  := FieldByName('GT2').AsString;
          GT3  := FieldByName('GT3').AsString;
          GT4  := FieldByName('GT4').AsString;
          GT5  := FieldByName('GT5').AsString;
          GT6  := FieldByName('GT6').AsString;
          GT7  := FieldByName('GT7').AsString;
          GT8  := FieldByName('GT8').AsString;
          GT9  := FieldByName('GT9').AsInteger;
          //동일문 회차 시간 추가
//          GT10 := FieldByName('GT10').AsString;
//          GT11 := FieldByName('GT11').AsString;
        end
      else
        ClearGTime;

//      ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 정기차량 중간입차 확인 시작');
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo AS A ');
      SQL.Add(' INNER JOIN GGroup AS B ');
      SQL.Add(' ON a.GroupNo = B.GroupNo ');
      SQL.Add(' Where CarNo = :N1 and B.useMiddle = 1 and TKType = 2 and a.ParkNo = :N2 and ');
      SQL.Add(' ((ExpDateF <= :N3 ) and (ExpDateT >= :N4 )) ');
      Parameters.ParamByName('N1').Value := sLprCarNo1; //nCurrParkNo
      Parameters.ParamByName('N2').Value := nCurrParkNo;
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);;
      Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);;
      Open;

      if RecordCount > 0 then begin
        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 정기차량 중간입차 확인 완료');
        bUseMiddle := True;
      end else begin
//        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 정기차량 중간입차차량 아님');
        bUseMiddle := False;
      end;

      if bUseMiddle then
      begin
        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 중간입차 처리시작');
        {$REGION '층별입차'}
        Close;
        SQL.Clear;
        SQL.Add('Select * from IOSData WITH(NOLOCK) where OutDate is null and ');
        if not bMiProc then
        begin
          if sLprCarNo2 <> '' then
          begin
            SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3) or (InCarNo1 = :N4) or (InCarNo2 = :N5)) ');
            Parameters.ParamByName('N2').Value := sLprCarNo1;
            Parameters.ParamByName('N3').Value := sLprCarNo1;
            Parameters.ParamByName('N4').Value := sLprCarNo2;
            Parameters.ParamByName('N5').Value := sLprCarNo2;
          end
          else
          begin
            SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3)) ');
            Parameters.ParamByName('N2').Value := sLprCarNo1;
            Parameters.ParamByName('N3').Value := sLprCarNo1;
          end;

          if nSeekDay > 0 then
          begin
            SQL.Add(' and ProcDate >= :N8 ');
            Parameters.ParamByName('N8').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1);
          end;
        end
        else
        begin
          SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3)) ');
          SQL.Add('and ProcDate = :N6 and ProcTime = :N7 ');
          Parameters.ParamByName('N2').Value := sLostInCarNo;
          Parameters.ParamByName('N3').Value := sLostInCarNo;
          Parameters.ParamByName('N1').Value := 0;
          Parameters.ParamByName('N6').Value := sLostInDate;
          Parameters.ParamByName('N7').Value := sLostInTime;
        end;
        SQL.Add(' and ParkNo = :N0 ');
        SQL.Add('Order By ProcDate Desc, ProcTime Desc');
        Parameters.ParamByName('N0').Value := nCurrParkNo;
        Open;

        if RecordCount > 0 then
        begin
          ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 중간입차 입차데이터 확인');
          nInUnitNo := FieldByName('UnitNo').AsInteger;
          nNowInUnitNo := nInUnitNo;
          if bOperation then
          begin
            sInTKNo := FormatDateTime('YYYYMMDDHHNNSS', Now)+ IntToStr(nCurrUnitNo)+'99';
            sNowInTKNo := sInTKNo;
          end;

          if nLprRecog1 = 1 then
          begin
            sInCarNo := sLprCarNo1;
            sInFile := FieldByName('InImage1').AsString;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end
          else if nLprRecog2 = 1 then
          begin
            sInCarNo := sLprCarNo2;
            sInFile := FieldByName('InImage2').AsString;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end
          else
          begin
            sInCarNo := sLprCarNo1;
            sInFile := FieldByName('InImage1').AsString;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end;
          sInDate := FieldByName('ProcDate').AsString;
          sInTime := FieldByName('ProcTime').AsString;
          sNowInDate := sInDate;
          sNowInTime := sInTime;
          Close;
          SQL.Clear;
          SQL.Add(' select count(*), sum(parkingtime), incarNo1 from V_SpecialIONData ') ;
          SQL.Add(' Where outchk = 1 and procdate+ ' + quotedstr(' ')+ ' + Proctime >= :N1 and ');
          SQL.Add(' outDate+ ' + quotedstr(' ')+ ' +  outTime <= :N2 and incarNo1 =  :N3 ');
          SQL.Add(' group by incarno1 ');
          Parameters.ParamByName('N1').Value := sInDate +' ' +sInTime ;
          Parameters.ParamByName('N2').Value := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
          Parameters.ParamByName('N3').Value := sInCarNo;
//          ExceptLogging(SQL.Text);
          Open;

          if RecordCount > 0 then
          begin
            nMiddleRealtime := FieldByName('COLUMN2').AsInteger;
            ExceptLogging('층별 주차시간 : ' + IntToStr(nMiddleRealtime));
          end
          else
          begin
//            ShowMessage('자료없음');
            nMiddleRealtime := 0;
            ExceptLogging('층별 주차시간 : ' + IntToStr(nMiddleRealtime));
          end;
  //        sInDate := FieldByName('ProcDate').AsString;
  //        sInTime := FieldByName('ProcTime').AsString;
  //        sNowInDate := sInDate;
  //        sNowInTime := sInTime;
          //2017.02.14 차량 관련 Connect No 추출
        end
        else
        begin
          ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 중간입차 입차데이터 없음 - 정기차량 입차미인식 처리');
          // 입차자료 없음...
          sNowLprFile1 := sLprFile1;
          sNowLprCarNo1 := sLprCarNo1;
          sNowLprFile2 := sLprFile2;
          sNowLprCarNo2 := sLprCarNo2;
          sNowIOTime := sIOTime;
          nNowLprNo := nLprNo;
          nNowLprInOut := nLprInOut;
          nNowLprRecog1 := nLprRecog1;
          nNowLprRecog2 := nLprRecog2;
          sNowInTKNo := '';
          nNowInUnitNo := 0;
          sNowInDate := '';
          sNowInTime := '';
          sNowInCarNo := '';
          sNowInFile := '';


          if bTest then
          begin
            OutOpen(nowLpr);
            bNCOutProcWait := False;
            Exit;
          end;

          if bFreeTime then
          begin
            if bFreeTimeChk then
            begin
              // 시작시각이 크다.
              if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) or
                (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
              begin
                OutOpen(nowLpr);
                bNCOutProcWait := False;
                Exit;
              end;
            end
            else
            begin
              if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) and
                (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
              begin
                OutOpen(nowLpr);
                bNCOutProcWait := False;
                Exit;
              end;
            end;
          end;
          if bOperation then
          begin
            bInDataZero := True;
            if Copy(sLprFile1, 1, 4) = 'http' then
            begin
                sTemp := Copy(sLprFile1, 6, Length(sLprFile1) - 5);
                sLprFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
                sLprFile1 := sLprFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
                    (sTemp) - (Pos(':9080', sTemp) + 4));
                sLprFile1 := MG_StrConvert(sLprFile1, '/', '\');
                ExceptLogging(sLprFile1);
            end;
             sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);
            try
              if is_ping(sFileIP) then
              begin
                if FileExists(sLprFile1) then
                begin
                  imgOut.Picture.LoadFromFile(sLprFile1);
                  imgManual.Picture.LoadFromFile(sLprFile1);
                end
                else
                begin
                  imgOut.Picture.Assign(Nil);
                  imgManual.Picture.Assign(Nil);
                  ExceptLogging('File 없음: ' + sLprFile1);
                end;
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                imgManual.Picture.Assign(Nil);
                ExceptLogging('File 없음: ' + sLprFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;
            //부경대학교 개방운영 추가
            if not bMode then begin
  //            FreeOpenOut(sNowLprFile1, sNowLprCarNo1, sNowLprFile2, sNowLprCarNo2,
  //              sNowIOTime, nNowLprNo, 2, nNowLprRecog1, nNowLprRecog2);
              FreeTimeProc(nowLpr);
              OutOpen(nowLpr);
              bNCOutProcWait := False;
              ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 중간입차 개방운영 처리중단');
              Exit;
            end;
            // ShowMessage('입차자료가 없습니다. 확인하여주세요!');
            edtManualProcDate.Date := Now;
            edtManualOutCarNo1.Text := sLprCarNo1;
            edtManualOutTime.Text := '  :  ';
            pnManualProc.Visible := True;
            edtManualProcCarNo.SetFocus;
          end;
          Exit;
        end;
        {$ENDREGION}
      end else if nUseFeeItem <> 0 then begin
        {$REGION '정기차량 요금부과'}
        // Added by LJH 2019-12-31 15:50:21 정기차량 요금부과(GS 롯데마트 요청사항)
        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 요금부과 정기차량');
        Close;
        SQL.Clear;

        //미출차 요금대상 정기차량 입출차 데이터 검색
        SQL.Add('Select * from IOSData WITH(NOLOCK) ');
        SQL.Add('Where 1=1 ');
        SQL.Add('and OutDate is null and OutTime is null and ParkNo = :nParkNo ');
        Parameters.ParamByName('nParkNo').Value := nCurrParkNo;

        if not bMiProc then
        begin
          if sLprCarNo2 <> '' then
          begin
            SQL.Add('and ((InCarNo1 = :nCarNo1) or (InCarNo1 = :nCarNo2)) ');
            Parameters.ParamByName('N2').Value := sLprCarNo1;
            Parameters.ParamByName('N3').Value := sLprCarNo1;
            Parameters.ParamByName('N4').Value := sLprCarNo2;
            Parameters.ParamByName('N5').Value := sLprCarNo2;
          end
          else
          begin
            SQL.Add('and (InCarNo1 = :nCarNo1) ');
            Parameters.ParamByName('nCarNo1').Value := sLprCarNo1;
          end;
          // 출차 n일전 자료까지만 조회
          if nSeekDay > 0 then
          begin
            SQL.Add('and ProcDate >= :N8 ');
            Parameters.ParamByName('N8').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay * -1);
          end;
        end
        else
        begin
          SQL.Add('and (InCarNo1 = :nCarNo1) ');
          SQL.Add('and ProcDate = :sLostInDate and ProcTime = :sLostInTime ');
          Parameters.ParamByName('nCarNo1').Value := sLostInCarNo;
          Parameters.ParamByName('sLostInDate').Value := sLostInDate;
          Parameters.ParamByName('sLostInTime').Value := sLostInTime;
        end;
        Open;

        if RecordCount > 0 then begin
          //입차자료 있음 => 요금계산
          ExceptLogging('정기차량 요금부과차량 [' + sLprCarNo1 + ', ' + sLprCarNo2 + '] 요금계산 시작');

          nInUnitNo := FieldByName('UnitNo').AsInteger;
          nNowInUnitNo := nInUnitNo;

          if bOperation then
          begin
            sInTKNo := FieldByName('TKNo').AsString;
            sNowInTKNo := sInTKNo;
          end;

          if nLprRecog1 = 1 then
          begin
            sInCarNo := sLprCarNo1;
            sInFile := FieldByName('InImage1').AsString;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end
          else if nLprRecog2 = 1 then
          begin
            sInCarNo := sLprCarNo2;
            sInFile := FieldByName('InImage2').AsString;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end
          else
          begin
            sInCarNo := sLprCarNo1;
            sInFile := FieldByName('InImage1').AsString;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end;

          sInDate := FieldByName('ProcDate').AsString;
          sInTime := FieldByName('ProcTime').AsString;

          // 이후 처리 지속
        end else begin
          //입차자료 없음
          ExceptLogging('정기차량 요금부과차량 [' + sLprCarNo1 + ', ' + sLprCarNo2 + '] 입차데이터 없음... 자동출차처리');

          Close;
          SQL.Clear;
          SQL.Add('Select * from CustInfo WITH(NOLOCK) where CarNo = :N1 and TKType = 2 and ParkNo = :N2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
          Parameters.ParamByName('N2').Value := nCurrParkNo;
          Open;

          if RecordCount > 0 then begin
            if FieldByName('ExpDateT').AsString = FormatDateTime('YYYY-MM-DD', Now) then begin
              nDayBetween := 0;
            end else begin
              nDayBetween:= DaysBetween(Now, StrToDate(FieldByName('ExpDateT').AsString))+1;
            end;

//            if nSCRemain >= nDayBetween then
//              DspProc(2, 1, MG_Right(IntToStr(nDayBetween) + '일남음', 12) + MG_Left(sLprCarNo1, 12), sDspIP)
//            else
//              DspProc(2, 1, '정기등록차량' + MG_Left(sLprCarNo1, 12), sDspIP);
            OutOpen(csLPR);

            NGridData('3' + sLprCarNo1 + '^' + FormatDateTime('YYYY-MM-DD', Now) + ' ' + FormatDateTime('HH:NN:SS', Now) + '^회차차량');
            DspProc(2, 1, '회차허용차량' + MG_Left(sInCarNo, 12), sDspIP);

            Close;
            SQL.Clear;
            SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
            SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
            SQL.Add('Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nNowLprNo;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
            Parameters.ParamByName('N5').Value := 2;
            Parameters.ParamByName('N6').Value := 1;
            Parameters.ParamByName('N7').Value := nCurrParkNo;
            Parameters.ParamByName('N8').Value := 2;
            Parameters.ParamByName('N9').Value := sLprCarNo1;
            ExecSQL;

            // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
            Close;
            SQL.Clear;
            SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
            SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
            SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
            SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
            SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
            SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nNowLprNo;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
            Parameters.ParamByName('N5').Value := 2;
            Parameters.ParamByName('N6').Value := 2;
            Parameters.ParamByName('N7').Value := nGroupNo;
            Parameters.ParamByName('N8').Value := sGroupName;
            Parameters.ParamByName('N9').Value := sCompName;
            Parameters.ParamByName('N10').Value := sDeptName;
            Parameters.ParamByName('N11').Value := sName;
            Parameters.ParamByName('N12').Value := sLprCarNo1;
            Parameters.ParamByName('N13').Value := 8;
            Parameters.ParamByName('N14').Value := '';
            Parameters.ParamByName('N15').Value := nNowLprNo;
            Parameters.ParamByName('N16').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N17').Value := FormatDateTime('HH:NN:SS', Now);
            Parameters.ParamByName('N18').Value := sLprFile1;
            Parameters.ParamByName('N19').Value := sLprCarNo1;
            Parameters.ParamByName('N20').Value := 8;
            Parameters.ParamByName('N21').Value := sLprFile2;
            Parameters.ParamByName('N22').Value := sLprCarNo2;
            Parameters.ParamByName('N23').Value := sCardNo;
            ExecSQL;

            bNCOutProcWait := False;
            Exit;
          end else begin
            ExceptLogging('정기차량 데이터 오류.. ' + sLprCarNo1 + ', nUseFeeItem 초기화 상태 확인 필요' );
            bNCOutProcWait := False;
            Exit;
          end;
        end;
        {$ENDREGION}
      end else begin
//        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 일반차량 요금계산 시작');
        {$REGION '일반차량 요금부과'}
        if bOperation then
        begin
          Close;
          SQL.Clear;
          //사전정산 및 출차 안한 자료 검색
          SQL.Add('Select * from IONData WITH(NOLOCK) where ((OutChk = :N1) or (OutChk = :N9)) and ');
        end
        else
        begin
          Close;
          SQL.Clear;
          //사전정산 및 출차 안한 자료 검색
          SQL.Add('Select * from FreeIOData WITH(NOLOCK) where ((OutChk = :N1) or (OutChk = :N9)) and ');
        end;

        if not bMiProc then
        begin
          if sLprCarNo2 <> '' then
          begin
            SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3) or (InCarNo1 = :N4) or (InCarNo2 = :N5)) ');
            Parameters.ParamByName('N1').Value := 0;
            Parameters.ParamByName('N2').Value := sLprCarNo1;
            Parameters.ParamByName('N3').Value := sLprCarNo1;
            Parameters.ParamByName('N4').Value := sLprCarNo2;
            Parameters.ParamByName('N5').Value := sLprCarNo2;
            Parameters.ParamByName('N9').Value := 8;
          end
          else
          begin
            SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3)) ');
            Parameters.ParamByName('N1').Value := 0;
            Parameters.ParamByName('N2').Value := sLprCarNo1;
            Parameters.ParamByName('N3').Value := sLprCarNo1;
            Parameters.ParamByName('N9').Value := 8;
          end;

          if nSeekDay > 0 then
          begin
            SQL.Add(' and ProcDate >= :N8 ');
            Parameters.ParamByName('N8').Value := MG_AddDate(FormatDateTime('YYYY-MM-DD', Now), nSeekDay*-1);
          end;
        end
        else
        begin
          SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3)) ');
          SQL.Add('and ProcDate = :N6 and ProcTime = :N7 ');
          Parameters.ParamByName('N2').Value := sLostInCarNo;
          Parameters.ParamByName('N3').Value := sLostInCarNo;
          Parameters.ParamByName('N1').Value := 0;
          Parameters.ParamByName('N6').Value := sLostInDate;
          Parameters.ParamByName('N7').Value := sLostInTime;
          Parameters.ParamByName('N9').Value := 8;
        end;
        SQL.Add(' and ParkNo = :N0 ');
        SQL.Add('Order By ProcDate Desc, ProcTime Desc');
        Parameters.ParamByName('N0').Value := nCurrParkNo;
        Open;

        if RecordCount > 0 then
        begin
          //21.03.15 디비 속도 향상
          NormalOut_Field := FieldByName('UnitNo');
          NormalOut_Field2 := FieldByName('CarType');
          NormalOut_Field3 := FieldByName('OutChk');
          NormalOut_Field4 := FieldByName('TKNo');
          NormalOut_Field5 := FieldByName('InImage1');
          NormalOut_Field6 := FieldByName('InImage2');
          NormalOut_Field7 := FieldByName('ProcDate');
          NormalOut_Field8 := FieldByName('ProcTime');
          NormalOut_Field9 := FieldByName('OutDate');
          NormalOut_Field10 := FieldByName('OutTime');

          nInUnitNo := NormalOut_Field.AsInteger;
          nCarType := NormalOut_Field2.AsInteger;
          nOutChk := NormalOut_Field3.AsInteger;
          nTKNo := NormalOut_Field4.AsString;
          nInImage1 := NormalOut_Field5.AsString;
          nInImage2 := NormalOut_Field6.AsString;
          nProcDate := NormalOut_Field7.AsString;
          nProcTime := NormalOut_Field8.AsString;
          nOutDate := NormalOut_Field9.AsString;
          nOutTime := NormalOut_Field10.AsString;

          //nInUnitNo := FieldByName('UnitNo').AsInteger;
          nNowInUnitNo := nInUnitNo;
          //경차 확인 경차일 경우 요금제로 처리
          //if FieldByName('CarType').AsInteger = 0 then
          if nCarType = 0 then
          begin
            bCompactCar := True;
          end
          else
          begin
            bCompactCar := false;
          end;
          //사전 정산 여부 판단
          //if FieldByName('OutChk').AsInteger = 8 then
          if nOutChk = 8 then
            bApsPay := True
          else
            bApsPay := False;

          if bOperation then
          begin
            //sInTKNo := FieldByName('TKNo').AsString;
            sInTKNo := nTKNo;
            sNowInTKNo := sInTKNo;
          end;

          if nLprRecog1 = 1 then
          begin
            sInCarNo := sLprCarNo1;
            //sInFile := FieldByName('InImage1').AsString;
            sInFile := nInImage1;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end
          else if nLprRecog2 = 1 then
          begin
            sInCarNo := sLprCarNo2;
            //sInFile := FieldByName('InImage2').AsString;
            sInFile := nInImage2;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end
          else
          begin
            sInCarNo := sLprCarNo1;
            //sInFile := FieldByName('InImage1').AsString;
            sInFile := nInImage1;
            sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
            sNowInCarNo := sInCarNo;
            sNowInFile := sInFile;
          end;
          if not bApsPay then
          begin
            //sInDate := FieldByName('ProcDate').AsString;
            //sInTime := FieldByName('ProcTime').AsString;
             sInDate := nProcDate;
             sInTime := nProcTime;
          end
          else
          begin
//            sInDate := FieldByName('ProcDate').AsString;
//            sInTime := FieldByName('ProcTime').AsString;
//            sApsPayDate := FieldByName('OutDate').AsString;
//            sAPSPayTime := FieldByName('OutTime').AsString;

             sInDate := nProcDate;
             sInTime := nProcTime;
             sApsPayDate := nOutDate;
             sAPSPayTime := nOutTime;
             //sOutDate := nOutDate;
             //sOutTime := nOutTime;
          end;
          sNowInDate := sInDate;
          sNowInTime := sInTime;
  //        sInDate := FieldByName('ProcDate').AsString;
  //        sInTime := FieldByName('ProcTime').AsString;
  //        sNowInDate := sInDate;
  //        sNowInTime := sInTime;
          //2017.02.14 차량 관련 Connect No 추출
        end
        else
        begin
          // 입차자료 없음...
          sNowLprFile1 := sLprFile1;
          sNowLprCarNo1 := sLprCarNo1;
          sNowLprFile2 := sLprFile2;
          sNowLprCarNo2 := sLprCarNo2;
          sNowIOTime := sIOTime;
          nNowLprNo := nLprNo;
          nNowLprInOut := nLprInOut;
          nNowLprRecog1 := nLprRecog1;
          nNowLprRecog2 := nLprRecog2;
          sNowInTKNo := '';
          nNowInUnitNo := 0;
          sNowInDate := '';
          sNowInTime := '';
          sNowInCarNo := '';
          sNowInFile := '';


          if bTest then
          begin
            OutOpen(nowLpr);
            bNCOutProcWait := False;
            Exit;
          end;

          if bFreeTime then
          begin
            if bFreeTimeChk then
            begin
              // 시작시각이 크다.
              if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) or
                (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
              begin
                OutOpen(nowLpr);
                bNCOutProcWait := False;
                Exit;
              end;
            end
            else
            begin
              if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) and
                (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
              begin
                OutOpen(nowLpr);
                bNCOutProcWait := False;
                Exit;
              end;
            end;
          end;
          if bOperation then
          begin
            bInDataZero := True;
            if Copy(sLprFile1, 1, 4) = 'http' then
            begin
              sTemp := Copy(sLprFile1, 6, Length(sLprFile1) - 5);
              sLprFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
              sLprFile1 := sLprFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
                  (sTemp) - (Pos(':9080', sTemp) + 4));
              sLprFile1 := MG_StrConvert(sLprFile1, '/', '\');
            end;
            sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);
            try
              if is_ping(sFileIP) then
              begin
                if FileExists(sLprFile1) then
                begin
                  imgOut.Picture.LoadFromFile(sLprFile1);
                  imgManual.Picture.LoadFromFile(sLprFile1);
                end
                else
                begin
                  imgOut.Picture.Assign(Nil);
                  imgManual.Picture.Assign(Nil);
                  ExceptLogging('File 없음: ' + sLprFile1);
                end;
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                imgManual.Picture.Assign(Nil);
                ExceptLogging('File 없음: ' + sLprFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;
            //부경대학교 개방운영 추가
            if not bMode then begin
  //            FreeOpenOut(sNowLprFile1, sNowLprCarNo1, sNowLprFile2, sNowLprCarNo2,
  //              sNowIOTime, nNowLprNo, 2, nNowLprRecog1, nNowLprRecog2);
              FreeTimeProc(nowLpr);
              OutOpen(nowLpr);
              bNCOutProcWait := False;
              Exit;
            end;
            // ShowMessage('입차자료가 없습니다. 확인하여주세요!');
            edtManualProcDate.Date := Now;
            edtManualOutCarNo1.Text := sLprCarNo1;
            edtManualOutTime.Text := '  :  ';
            pnManualProc.Visible := True;
            edtManualProcCarNo.SetFocus;
          end;
          Exit;
        end;
        {$ENDREGION}
      end;
      {$ENDREGION}
    end;

    //부경대학교 개방처리 관련 자료 빠지는 부분 추가
    sNowLprFile1 := sLprFile1;
    sNowLprCarNo1 := sLprCarNo1;
    sNowLprFile2 := sLprFile2;
    sNowLprCarNo2 := sLprCarNo2;
    sNowIOTime := sIOTime;
    nNowLprNo := nLprNo;
    nNowLprInOut := nLprInOut;
    nNowLprRecog1 := nLprRecog1;
    nNowLprRecog2 := nLprRecog2;
    sNowInTKNo := '';
    nNowInUnitNo := 0;
    sNowInDate := '';
    sNowInTime := '';
    sNowInCarNo := '';
    sNowInFile := '';

    if Copy(sInFile, 1, 4) = 'http' then
    begin
//      ExceptLogging('일반차량 입차 파일 확인File: ' + sInFile);
      sTemp:= Copy(sInFile, 6, Length(sInFile)-5);
      sInFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
      sInFile:= sInFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
      sInFile:= MG_StrConvert(sInFile, '/', '\');
      ExceptLogging('입차이미지: ' + sInFile);

      //추가사항
      nsInCarNo := StringReplace(sInFile, '.jpg', '',[rfReplaceAll, rfIgnoreCase]);
      nsInCarNo := Copy(nsInCarNo, Pos('_', sInCarNo) + 16 , Length(nsInCarNo));
      ExceptLogging('HTTP 형식 입차 차량번호: ' + sInCarNo);
    end
    else
    begin
     //추가사항
      nsInCarNo := StringReplace(sInFile, '.jpg', '',[rfReplaceAll, rfIgnoreCase]);
      nsInCarNo := Copy(nsInCarNo, Pos('_', nsInCarNo) + 16 , Length(nsInCarNo));
      ExceptLogging('입차 차량번호: ' + nsInCarNo);
    end;
  //    ShowMessage(IntToStr(Pos('\MSIMAGE', sInFile)));
    sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);
    //숭실대학교 출차시 입차이미지 표출 안함
    try
      if is_ping(sFileIP) then
      begin
        if FileExists(sInFile) then
        begin
          imgIn.Picture.LoadFromFile(sInFile);
        end
        else
        begin
          imgIn.Picture.Assign(Nil);
          ExceptLogging('입차 이미지 File 없음: ' + sInFile);
        end;
      end
      else
      begin
        imgIn.Picture.Assign(Nil);
        ExceptLogging('파일로드시 LPR과 Ping Error(' + sFileIP + '): ' + sInFile);
      end;
    except
      on E: Exception do
        ExceptLogging('입차 이미지 File Load: (' + sInFile + ') ' + aString(E.Message));
    end;

    if Copy(sLprFile1, 1, 4) = 'http' then
    begin
      sTemp := Copy(sLprFile1, 6, Length(sLprFile1) - 5);
      sOutFile := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
      sOutFile := sOutFile + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
      sOutFile := MG_StrConvert(sOutFile, '/', '\');
      ExceptLogging('출차이미지: ' + sOutFile);
      sFileIP:= Copy(sOutFile, 3, Pos('\MSImage', sOutFile)-3);
    end
    else
    begin
      sOutFile := sLprFile1;
      sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);
    end;

    try
      if is_ping(sFileIP) then
      begin
        if FileExists(sOutFile) then
        begin
          imgOut.Picture.LoadFromFile(sOutFile);
          imgManual.Picture.LoadFromFile(sOutFile);
        end
        else
        begin
          imgOut.Picture.Assign(Nil);
          imgManual.Picture.Assign(Nil);
          ExceptLogging('출차 이미지 File 없음: ' + sOutFile);
        end;
      end
      else
      begin
        imgOut.Picture.Assign(Nil);
        imgManual.Picture.Assign(Nil);
        ExceptLogging('출차 이미지 파일로드시 LPR과 Ping Error(' + sFileIP + '): ' + sOutFile);
      end;
    except
      on E: Exception do
        ExceptLogging('출차 이미지 로드 에러: ' + aString(E.Message));
    end;

    // 화면표시
    lbInCarNo.Caption := sInCarNo;

    case nNowCharo of
      1:
        edtCharo.Color := clWhite;
      2:
        edtCharo.Color := clYellow;
      3:
        edtCharo.Color := clAqua;
    end;
    edtCharo.Text := IntToStr(nNowCharo) + '번 차로';

    if (sInDate < '2012-06-04') or ((sInDate = '2012-06-04') and
        (sInTime < '07:00:00')) then
    begin
      if FormatDateTime('YYYY-MM-DD HH:NN:SS', Now) > '2016-03-01 07:00:00' then
        lbInTime.Caption := '2016-03-01 07:00:00'
      else begin
        if not bApsPay then
          lbInTime.Caption := sInDate + ' ' + sInTime
        else
          lbInTime.Caption := sApsPayDate + ' ' + sAPSPayTime
      end;
    end
    else
    begin
      if not bApsPay then
        lbInTime.Caption := sInDate + ' ' + sInTime
      else
        lbInTime.Caption := sApsPayDate + ' ' + sAPSPayTime
    end;

    sNow := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
    lbOutTime.Caption := sNow;
    sParking := '';
    nParkingMin := 0;
    bRound := False;

    // Modified by LJH 2020-04-10 11:06:44
    // 표출하는 주차시간 계산식 변경함.
    // DJSM_FeeCalc함수에서 30분 무료출차 하는 로직이 있는데, 분만 30분 차이나고 초가 달라지는경우 31분인데 무료출차됨
    // 계산상으로는 Tariff에 별도요청하는거니, 표출되는 값만 변경
    // => 예시) 2020-04-04 20:00:00 입차 2020-04-04 20:30:01 출차
    //    기존) 31분 표출되고 회차처리
    //    변경) 30분 표출되고 회차처리
    //    변경) 29분 표출되고 회차처리
    {nParkingMin :=
    Trunc(
      (StrToDateTime(MG_AddTime(Copy(sNow, 1, 16), 0, 1, 0, 0) + ':01')
       - StrToDateTime(Copy(lbInTime.Caption, 1, 16) + ':01')) * 24 * 60);}
//       - StrToDateTime(lbInTime.Caption)) * 24 * 60);

//    nParkingMin := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 16), 0, 0, 0, 0))
//     - StrToDateTime(Copy(lbInTime.Caption,1,16))) * 24 * 60);

    nParkingMin := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 19), 0, 0, 0, 0))
    - StrToDateTime(Copy(lbInTime.Caption,1,19))) * 24 * 60);
    nSec := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 19), 0, 0, 0, 0))
    - StrToDateTime(Copy(lbInTime.Caption,1,19))) * 24 * 60 * 60);

    nNowParkingMin := nParkingMin;
    nDay := nParkingMin div (24 * 60);
    nHour := (nParkingMin mod (24 * 60)) div 60;
    nMin := (nParkingMin mod (24 * 60)) mod 60;
    nSec := nSec mod 60;

    nDayEx  := 0;
    nHourEx := 0;
    nMinEx  := 0;
    nSecEx  := 0;

    if nDay > 0 then
      sParking := sParking + IntToStr(nDay) + '일 ';
    if nHour > 0 then
      sParking := sParking + IntToStr(nHour) + '시간 ';
    if nMin > 0 then
      sParking := sParking + IntToStr(nMin) + '분';
//    if nSec > 0 then
//      sParking := sParking + IntToStr(nSec) + '초';
    lbParkingTime.Caption := sParking;
    InspectionLog('출차정보: ' + sInCarNo + ', ' + lbInTime.Caption + ', ' + sNow);


    nDayEx := nDay;
    nHourEx := nHour;
    nMinEx := nMin;
    nSecEx := nSec;

    ExceptLogging('출차정보 주차 시간 : ' + sInCarNo + ', ' + Inttostr(nHourEx) + ', ' + Inttostr(nMinEx)+' '+Inttostr(nSecEx));
    if nDay = 0 then
    begin
      if nHour = 0 then
      begin
        if nMinEx <= 29 then
        begin
           bRound := True;
        end;
      end;
    end;

    if bFreeTime then
    begin
      if bFreeTimeChk then
      begin
        // 시작시각이 크다.
        if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) or
          (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
        begin
          FreeTimeProc(nowLpr);
          // MichulProc(sInCarNo);
          bNCOutProcWait := False;
          Exit;
        end;
      end
      else
      begin
        if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) and
          (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
        begin
          FreeTimeProc(nowLpr);
          // MichulProc(sInCarNo);
          bNCOutProcWait := False;
          Exit;
        end;
      end;
    end;
    if
       (((chkHoliday(Copy(sNow, 1, 10))) or ((DayOfWeek(Now) = 1))) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT8)) >= Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT8)) > Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT8)) > Copy(sNow, 1, 19)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) and (not bApsPay)) or
       //29분까지 강제 회차 지정
       (bRound)then
    begin
      ExceptLogging('일요일 또는 휴일');
    end;
    if
       //토요일
       ((not chkHoliday(Copy(sNow, 1, 10))) and ((DayOfWeek(Now) = 7)) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT5)) >= Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT5)) > Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT5)) > Copy(sNow, 1, 19)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16))  and (not bApsPay)) or
       //29분까지 강제 회차 지정
       (bRound) then
    begin
       ExceptLogging('토요일');
    end;
    if
       //평일
       (((not chkHoliday(Copy(sNow, 1, 10))) and ((DayOfWeek(Now) >= 2) and (DayOfWeek(Now) <= 6))) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) >= Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 19)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) and (not bApsPay)) or
       //29분까지 강제 회차 지정
       (bRound)then
    begin
       ExceptLogging('평일');
    end;
    if
       //사전무인정산
       ((FormatDateTime('YYYY-MM-DD HH:NN',
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT2)) >= Copy(sNow, 1, 16))
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT2)) > Copy(sNow, 1, 16))
        //StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT2)) > Copy(sNow, 1, 19))
        and bApsPay)  or
        //29분까지 강제 회차 지정
       (bRound)        then
    begin
      ExceptLogging('사전정산차량');
      lbDCName.Caption := '사전정산차량';
    end;
    if
        //일요일 또는 휴일
       (((chkHoliday(Copy(sNow, 1, 10))) or ((DayOfWeek(Now) = 1))) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT8)) >= Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT8)) > Copy(sNow, 1, 16)) or
        StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT8)) > Copy(sNow, 1, 19)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) and (not bApsPay)) or

       //토요일
       ((not chkHoliday(Copy(sNow, 1, 10))) and ((DayOfWeek(Now) = 7)) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT5)) >= Copy(sNow, 1, 16)) or
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT5)) > Copy(sNow, 1, 16)) or
        StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT5)) > Copy(sNow, 1, 19)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16))  and (not bApsPay)) or

       //평일
       (((not chkHoliday(Copy(sNow, 1, 10))) and ((DayOfWeek(Now) >= 2) and (DayOfWeek(Now) <= 6))) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) >= Copy(sNow, 1, 16)) or
       // StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 16)) or
        StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 19)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) and (not bApsPay)) or

       //사전무인정산
       ((FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT2)) >= Copy(sNow, 1, 16))
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT2)) > Copy(sNow, 1, 16))
        StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT2)) > Copy(sNow, 1, 19))
        and bApsPay)           or
        //영업차량 회차 처리
       ((FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT11)) >= Copy(sNow, 1, 16)) and
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT11)) > Copy(sNow, 1, 16)) and
        StrToDateTime(Copy(lbInTime.Caption, 1, 19)) + StrToTime(GTime.GT11)) > Copy(sNow, 1, 19)) and
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) )     or
       //중간통과차량 회차 처리
       (((nMiddleRealtime + nMiddleParkingtime) >= nNowParkingMin) and bUseMiddle ) or
       //29분까지 강제 회차 지정
       (bRound)
    then
    begin
      ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 회차처리');
      // 회차허용차량...
      // DB Write...
      with dmTables.qryNormalOut2 do
      begin
        if bUseMiddle then
        begin
          ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량: 중간입출차 처리');
//          DspProc(2, 1, '정기등록차량' + MG_Left(sInCarNo, 12), sDspIP);
          Close;
          SQL.Clear;
          SQL.Add('Select * from CustInfo WITH(NOLOCK) where CarNo = :N1 and TKType = 2 and ParkNo = :N2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
          Parameters.ParamByName('N2').Value := nCurrParkNo;
          Open;

          if RecordCount > 0 then
          begin
            nGroupNo := FieldByName('GroupNo').AsInteger;
            sCompName := FieldByName('CompName').AsString;
            sDeptName := FieldByName('DeptName').AsString;
            sName := FieldByName('Name').AsString;
            sCardNo := FieldByName('TKNo').AsString;
            sExpDateT := FieldByName('ExpDateT').AsString;
            sResult := Copy(sNow, 1, 10) + '^' + Copy(sNow, 12, 8) + '^' + sLprCarNo1 + '^' + sName + '^' + sCompName + '^' + sExpDateT + '까지^';
            sResult :=  '2' + sResult + '출 차';

            Close;
            SQL.Clear;
            SQL.Add('Select * from GGroup WITH(NOLOCK) where ParkNo = :N1 and GroupNo = :N2');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nGroupNo;
            Open;

            if RecordCount > 0 then
            begin
              sGroupName := FieldByName('GroupName').AsString;
            end;
          end;

          OutOpen(csLPR);

          with dmTables.qryRecvLpr2 do
          begin
            Close;
            SQL.Clear;
            SQL.Add(
              'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
            SQL.Add(
              'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
            SQL.Add(
              'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nCurrUnitNo;
            Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
            Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
            Parameters.ParamByName('N5').Value := 2;
            Parameters.ParamByName('N6').Value := 1;
            Parameters.ParamByName('N7').Value := nCurrParkNo;
            Parameters.ParamByName('N8').Value := 2;
            Parameters.ParamByName('N9').Value := sInCarNo;
            ExecSQL;

            Close;
            SQL.Clear;
            SQL.Add(
              'Select * from IOSData WITH(NOLOCK) where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) and ParkNo = :N3 ');
            SQL.Add('Order By ProcDate Desc, ProcTime Desc');
            Parameters.ParamByName('N1').Value := sInCarNo;
            Parameters.ParamByName('N2').Value := sInCarNo;
            Parameters.ParamByName('N3').Value := nCurrParkNo;
            Open;

            if RecordCount > 0 then
            begin
              First;

              if FieldByName('OutDate').AsString = '' then
              begin
                // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                sSCInDate := FieldByName('ProcDate').AsString;
                sSCInTime := FieldByName('ProcTime').AsString;
                nLastUnitNo := FieldByName('UnitNo').AsInteger;
                sInFile := FieldByName('InImage1').AsString;

                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                SQL.Add(
                  'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                SQL.Add(
                  'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                SQL.Add(
                  'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10 and ParkNo = :N14');
                Parameters.ParamByName('N1').Value := nCurrUnitNo;
                Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
                Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
                Parameters.ParamByName('N4').Value := 2;
                Parameters.ParamByName('N5').Value := sLprFile1;
                Parameters.ParamByName('N6').Value := sLprCarNo1;
                Parameters.ParamByName('N7').Value := sLprCarNo1;
                Parameters.ParamByName('N8').Value := sSCInDate;
                Parameters.ParamByName('N9').Value := sSCInTime;
                Parameters.ParamByName('N10').Value := nLastUnitNo;
                Parameters.ParamByName('N11').Value := sLprCarNo1;
                Parameters.ParamByName('N12').Value := sLprFile2;
                Parameters.ParamByName('N13').Value := sLprCarNo2;
                Parameters.ParamByName('N14').Value := nCurrParkNo;
                ExecSQL;

//              데이터 변형
                if Copy(sInFile, 1, 4) = 'http' then
                begin
                  ExceptLogging('정기차량 입차 파일 확인 File: ' + sInFile);
                  sTemp:= Copy(sInFile, 6, Length(sInFile)-5);
                  sInFile:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
                  sInFile:= sInFile + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
                  sInFile:= MG_StrConvert(sInFile, '/', '\');
                  ExceptLogging('HTTP 형식 입차 File: ' + sInFile);
                end
                else
                begin
                  sInFile  := sInFile;
                end;
                sFileIP:= Copy(sInFile, 3, Pos('\MSImage', sInFile)-3);

                //숭실대학교 출차 시 입차 이미지 표출 안함
                try
                  if is_ping(sFileIP) then
                  begin
                    if FileExists(sInFile) then
                    begin
                      imgIn.Picture.LoadFromFile(sInFile);
                    end
                    else
                    begin
                      imgIn.Picture.Assign(Nil);
                      ExceptLogging('File 없음: ' + sInFile);
                    end;
                  end
                  else
                  begin
                    imgIn.Picture.Assign(Nil);
                    ExceptLogging('File 없음: ' + sInFile);
                  end;
                except
                  on E: Exception do
                    ExceptLogging('File Load: (' + sInFile + ') ' + aString(E.Message));
                end;
              end
              else
              begin
                // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                 Close;
                 SQL.Clear;
                 SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                 SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                 SQL.Add('InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                 SQL.Add('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                 SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                 SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                 Parameters.ParamByName('N1').Value := nCurrParkNo;
                 Parameters.ParamByName('N2').Value := nCurrUnitNo;
                 Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);;
                 Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);;
                 Parameters.ParamByName('N5').Value := 2;
                 Parameters.ParamByName('N6').Value := 2;
                 Parameters.ParamByName('N7').Value := nGroupNo;
                 Parameters.ParamByName('N8').Value := sGroupName;
                 Parameters.ParamByName('N9').Value := sCompName;
                 Parameters.ParamByName('N10').Value := sDeptName;
                 Parameters.ParamByName('N11').Value := sName;
                 Parameters.ParamByName('N12').Value := sInCarNo;
                 Parameters.ParamByName('N13').Value := 1;
                 Parameters.ParamByName('N14').Value := '';
                 Parameters.ParamByName('N15').Value := nCurrUnitNo;
                 Parameters.ParamByName('N16').Value := Copy(sNow, 1, 10);
                 Parameters.ParamByName('N17').Value := Copy(sNow, 12, 8);
                 Parameters.ParamByName('N18').Value := sLprFile1;
                 Parameters.ParamByName('N19').Value := sLprCarNo1;
                 Parameters.ParamByName('N20').Value := 2;
                 Parameters.ParamByName('N21').Value := sLprFile2;
                 Parameters.ParamByName('N22').Value := sLprCarNo2;
                 Parameters.ParamByName('N23').Value := sCardNo;
                 ExecSQL;
              end;
            end;
          end;
        end
        else
        begin
          ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 요금정산 차량: 회차처리');
          if bOperation then
          begin
            // 정상운영시 처리...
            Close;
            SQL.Clear;
            SQL.Add(
              'Select * from TKProc WITH(NOLOCK) where ParkNo = :N1 and UnitNo = :N2 and ');
            SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nCurrUnitNo;
            Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
            Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
            Parameters.ParamByName('N5').Value := sInTKNo;
            Open;

            if RecordCount <= 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert Into TKProc ');
              SQL.Add(
                '(ParkNo, UnitNo, ProcDate, ProcTime, TKType, CarType, FeeNo, ');
              SQL.Add(
                'TKNo, TKParkNo, TKUnitNo, CarNo, InDate, InTime, ParkingMin, ');
              SQL.Add(
                'TotFee, TotDC, RealFee, RecvAmt, Change, DCCnt, MNo, UnPaid, ');
              SQL.Add('ChkClosing, CommercialTariff, SpecialTariff, PayType, Reserve2) ');
              SQL.Add(
                'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, ');
              SQL.Add(
                ':N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
              SQL.Add(':N21, :N22, :N23, :N24, :N25, :N26, :N27)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nCurrUnitNo;
              Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
              Parameters.ParamByName('N5').Value := nTKType;
              Parameters.ParamByName('N6').Value := nCarType;
              Parameters.ParamByName('N7').Value := nFeeNo;
              Parameters.ParamByName('N8').Value := sInTKNo;
              Parameters.ParamByName('N9').Value := nCurrParkNo;
              Parameters.ParamByName('N10').Value := nInUnitNo;
              Parameters.ParamByName('N11').Value := sInCarNo;
              Parameters.ParamByName('N12').Value := sInDate;
              Parameters.ParamByName('N13').Value := sInTime;
              Parameters.ParamByName('N14').Value := nParkingMin;
              Parameters.ParamByName('N15').Value := 0;
              Parameters.ParamByName('N16').Value := 0;
              Parameters.ParamByName('N17').Value := 0;
              Parameters.ParamByName('N18').Value := 0;
              Parameters.ParamByName('N19').Value := 0;
              Parameters.ParamByName('N20').Value := 0;
              Parameters.ParamByName('N21').Value := nCurrMNo;
              Parameters.ParamByName('N22').Value := 0;
              Parameters.ParamByName('N23').Value := 0;
              Parameters.ParamByName('N24').Value := 0;
              Parameters.ParamByName('N25').Value := 0;
              Parameters.ParamByName('N26').Value := 1;
              if not bApsPay then
                Parameters.ParamByName('N27').Value := '회차'
              else
                Parameters.ParamByName('N27').Value := '사전정산후출차';
              ExecSQL;
            end;

            if nUseFeeItem > 0 then begin
              {$REGION '정기차량 요금부과'}
              //정기차량 요금부과시 수동출차 및 회차처리만.(미인식 없음)
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IOSData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
              SQL.Add('ProcTime = :N4 and TKNo = :N5');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nInUnitNo;
              Parameters.ParamByName('N3').Value := sInDate;
              Parameters.ParamByName('N4').Value := sInTime;
              Parameters.ParamByName('N5').Value := sInTKNo;
              Open;

              if RecordCount > 0 then
              begin
                // InData에 입차자료가 있으면...
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');  //, OutChk = :N4
                SQL.Add(
                  'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
                SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10 ');         //, Reserve1 = :N16
                SQL.Add(
                  'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
                Parameters.ParamByName('N1').Value := nLprNo;
                Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
                Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
//                Parameters.ParamByName('N4').Value := 4;
                Parameters.ParamByName('N5').Value := sLprFile1;
                Parameters.ParamByName('N6').Value := sLprCarNo1;
                Parameters.ParamByName('N7').Value := sLprFile2;
                Parameters.ParamByName('N8').Value := sLprCarNo2;
                Parameters.ParamByName('N9').Value := nLprRecog1;
                Parameters.ParamByName('N10').Value := nLprRecog2;
                Parameters.ParamByName('N11').Value := nCurrParkNo;
                Parameters.ParamByName('N12').Value := nInUnitNo;
                Parameters.ParamByName('N13').Value := sInDate;
                Parameters.ParamByName('N14').Value := sInTime;
                Parameters.ParamByName('N15').Value := sInTKNo;

//                if bMiProc then
//                  Parameters.ParamByName('N16').Value := '미인식처리'
//                else if bManualOut then
//                  Parameters.ParamByName('N16').Value := '수동출차'
//                else
//                  Parameters.ParamByName('N16').Value := '';
                ExecSQL;

                //웹할인 없음(못들어감.)
              end;
              {$ENDREGION}
            end else begin
              {$REGION '일반차량 요금부과'}
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IONData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
              SQL.Add('ProcTime = :N4 and TKNo = :N5');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nInUnitNo;
              Parameters.ParamByName('N3').Value := sInDate;
              Parameters.ParamByName('N4').Value := sInTime;
              Parameters.ParamByName('N5').Value := sInTKNo;
              Open;

              if RecordCount > 0 then
              begin
                // InData에 입차자료가 있으면...
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IONData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
                SQL.Add(
                  'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
                SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N16 ');
                SQL.Add(
                  'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
                Parameters.ParamByName('N1').Value := nLprNo;
                Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
                Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
                Parameters.ParamByName('N4').Value := 4;
                Parameters.ParamByName('N5').Value := sLprFile1;
                Parameters.ParamByName('N6').Value := sLprCarNo1;
                Parameters.ParamByName('N7').Value := sLprFile2;
                Parameters.ParamByName('N8').Value := sLprCarNo2;
                Parameters.ParamByName('N9').Value := nLprRecog1;
                Parameters.ParamByName('N10').Value := nLprRecog2;
                Parameters.ParamByName('N11').Value := nCurrParkNo;
                Parameters.ParamByName('N12').Value := nInUnitNo;
                Parameters.ParamByName('N13').Value := sInDate;
                Parameters.ParamByName('N14').Value := sInTime;
                Parameters.ParamByName('N15').Value := sInTKNo;

                if bMiProc then
                  Parameters.ParamByName('N16').Value := '미인식처리'
                else if bManualOut then
                  Parameters.ParamByName('N16').Value := '수동출차'
                else
                  Parameters.ParamByName('N16').Value := '';
                ExecSQL;

                //웹할인 처리 안된 자료를 출차 기준으로 업데이트 한다.
                Close;
                SQL.Clear;
                SQL.Add
                  ('Update tblStoreDiscountPublish Set OutYmd = :N1, OutHms = :N2, Remark = :N3 ');
                SQL.Add('where NorKey = :N4 and DelYn = 0 and outYmd is null ');
                Parameters.ParamByName('N1').Value := Copy(sNow, 1, 10);;
                Parameters.ParamByName('N2').Value := Copy(sNow, 12, 8);;
                Parameters.ParamByName('N3').Value := '회차';
                Parameters.ParamByName('N4').Value := sInTKNo;
                ExecSQL;
              end
              else
              begin
                // InData에 입차자료가 없으면...
                ExceptLogging('TfrmMain.NormalOut: 입차자료없음-' + sLprCarNo1 + ', ' +
                    sLprCarNo2);
              end;
              {$ENDREGION}
            end;
          end else begin
            // 개방운영시 처리...
            if nUseFeeItem > 0 then begin
              {$REGION '정기차량 요금부과'}
              //정기차량 요금부과시 수동출차 및 회차처리만.(미인식 없음)
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IOSData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
              SQL.Add('ProcTime = :N4 and TKNo = :N5');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nInUnitNo;
              Parameters.ParamByName('N3').Value := sInDate;
              Parameters.ParamByName('N4').Value := sInTime;
              Parameters.ParamByName('N5').Value := sInTKNo;
              Open;

              if RecordCount > 0 then
              begin
                // InData에 입차자료가 있으면...
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');  //, OutChk = :N4
                SQL.Add(
                  'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
                SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10 ');         //, Reserve1 = :N16
                SQL.Add(
                  'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
                Parameters.ParamByName('N1').Value := nLprNo;
                Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
                Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
//                Parameters.ParamByName('N4').Value := 4;
                Parameters.ParamByName('N5').Value := sLprFile1;
                Parameters.ParamByName('N6').Value := sLprCarNo1;
                Parameters.ParamByName('N7').Value := sLprFile2;
                Parameters.ParamByName('N8').Value := sLprCarNo2;
                Parameters.ParamByName('N9').Value := nLprRecog1;
                Parameters.ParamByName('N10').Value := nLprRecog2;
                Parameters.ParamByName('N11').Value := nCurrParkNo;
                Parameters.ParamByName('N12').Value := nInUnitNo;
                Parameters.ParamByName('N13').Value := sInDate;
                Parameters.ParamByName('N14').Value := sInTime;
                Parameters.ParamByName('N15').Value := sInTKNo;
                ExecSQL;

                //웹할인 없음(못들어감.)
              end;
              {$ENDREGION}
            end else begin
              {$REGION '일반차량 요금부과'}
              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from FreeIOData Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
              SQL.Add('ProcTime = :N4 ');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nInUnitNo;
              Parameters.ParamByName('N3').Value := sInDate;
              Parameters.ParamByName('N4').Value := sInTime;
              Open;

              if RecordCount > 0 then
              begin
                // InData에 입차자료가 있으면...
                Close;
                SQL.Clear;
                SQL.Add(
                  'Update FreeIOData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
                SQL.Add(
                  'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
                SQL.Add(
                  'OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N15, ParkingMin = :N16, ParkingAmt = :N17 ');
                SQL.Add(
                  'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14');
                Parameters.ParamByName('N1').Value := nLprNo;
                Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
                Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
                Parameters.ParamByName('N4').Value := 4;
                Parameters.ParamByName('N5').Value := sLprFile1;
                Parameters.ParamByName('N6').Value := sLprCarNo1;
                Parameters.ParamByName('N7').Value := sLprFile2;
                Parameters.ParamByName('N8').Value := sLprCarNo2;
                Parameters.ParamByName('N9').Value := nLprRecog1;
                Parameters.ParamByName('N10').Value := nLprRecog2;
                Parameters.ParamByName('N11').Value := nCurrParkNo;
                Parameters.ParamByName('N12').Value := nInUnitNo;
                Parameters.ParamByName('N13').Value := sInDate;
                Parameters.ParamByName('N14').Value := sInTime;

                if bMiProc then
                  Parameters.ParamByName('N15').Value := '미인식처리'
                else if bManualOut then
                  Parameters.ParamByName('N15').Value := '수동출차'
                else
                  Parameters.ParamByName('N15').Value := '';

                Parameters.ParamByName('N16').Value := nParkingMin;
                Parameters.ParamByName('N17').Value := 0;
                ExecSQL;

                //웹할인 처리 안된 자료를 출차 기준으로 업데이트 한다.
                //웹할인 처리 안된 자료를 출차 기준으로 업데이트 한다.
                Close;
                SQL.Clear;
                SQL.Add
                  ('Update tblStoreDiscountPublish Set OutYmd = :N1, OutHms = :N2, Remark = :N3 ');
                SQL.Add('where NorKey = :N4 and DelYn = 0 and outYmd is null ');
                Parameters.ParamByName('N1').Value := Copy(sNow, 1, 10);;
                Parameters.ParamByName('N2').Value := Copy(sNow, 12, 8);;
                Parameters.ParamByName('N3').Value := '회차';
                Parameters.ParamByName('N4').Value := sInTKNo;
                ExecSQL;
              end
              else
              begin
                // InData에 입차자료가 없으면...
                ExceptLogging('TfrmMain.NormalOut: 입차자료없음-' + sLprCarNo1 + ', ' +
                    sLprCarNo2);
              end;
              {$ENDREGION}
            end;
          end;
        end;
      end;

      for i := 1 to 6 do
      begin
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
      end;
      lbYogum1.Caption := '0';
      lbYogum1.Visible := True;
      OutOpen(csLPR);
      if bUseMiddle then
      begin
        GridData(sResult);
        DspProc(2, 1, '정기등록차량' + MG_Left(sInCarNo, 12), sDspIP);
        InspectionLog('정기등록차량(중간게이트)');
      end
      else
      begin
        //lbDCName에 회차차량 문구요청 2020-02-01 허진범과장 대전성모병원, CLearformdata에서 초기화하지 않고 normalout, btnmanualout 처리할때 초기화(다음차량 출차시 초기화)
        if not bApsPay then
        begin
          NGridData('2' + sInCarNo + '^' + Copy(sNow, 1, 10) + ' ' + Copy(sNow, 12, 8) + '^회차차량');
          DspProc(2, 1, '회차허용차량' + MG_Left(sInCarNo, 12), sDspIP);
          lbDCName.Caption := '회차차량';
          InspectionLog('회차차량');
        end else if nUseFeeItem > 0 then begin
          NGridData('3' + sInCarNo + '^' + Copy(sNow, 1, 10) + ' ' + Copy(sNow, 12, 8) + '^회차차량');
          DspProc(2, 1, '회차허용차량' + MG_Left(sInCarNo, 12), sDspIP);
          InspectionLog('회차차량');
          lbDCName.Caption := '회차차량';
        end else begin
          NGridData('2' + sInCarNo + '^' + Copy(sNow, 1, 10) + ' ' + Copy(sNow, 12, 8) + '^사전정산차량');
          DspProc(2, 1, '사전정산차량' + MG_Left(sInCarNo, 12), sDspIP);
          InspectionLog('사전정산차량');
        end;
      end;

      sPrtData := '';
      // MichulProc(sInCarNo);
      ClearFormData;
      //회차 처리 종료
    end
    else
    begin
      //요금부과
      sNowLprFile1 := sLprFile1;
      sNowLprCarNo1 := sLprCarNo1;
      sNowLprFile2 := sLprFile2;
      sNowLprCarNo2 := sLprCarNo2;
      sNowIOTime := sIOTime;
      nNowLprNo := nLprNo;
      nNowLprInOut := nLprInOut;
      nNowLprRecog1 := nLprRecog1;
      nNowLprRecog2 := nLprRecog2;
      sNowInTKNo := sInTKNo;
      nNowInUnitNo := nInUnitNo;
      sNowInDate := sInDate;
      sNowInTime := sInTime;
      sNowInCarNo := sInCarNo;
      sNowOutDate := Copy(sNow, 1, 10);
      sNowOutTime := Copy(sNow, 12, 8);
      sTimeDCOutDate := sNowOutDate;
      sTimeDCOutTime := sNowOutTime;
      sLprFile1 := sOutFile;
      sNowLprFile1 := sOutFile;
      if bCompactCar then
      begin
        nFeeNo := 1;
      end;

      //주차요금 계산전에 기존 할인자료 등 클리어한다.
      for i := 1 to 50 do
        RDCCnt[i].nDCNowCnt := 0;

      ClearGTime;
      ClearDCProc;

      if nUseFeeItem > 0 then begin
        ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 정기차량 요금부과 차량: 요금제번호. ['+IntToStr(nUseFeeItem)+']');
        nFeeNo := nUseFeeItem;
      end;

//      ExceptLogging(sLprCarNo1 + ', ' + sLprCarNo2 + ' 차량 요금제 번호 : [' + IntToStr(nFeeNo) + ']');
       //일반차량 최대 요금 부과 여부 구간 상관없이......

      bIsPatientUse := 0;//OCS차량구분 초기화
      bOcsCodeUse := 0; //OCS차량구분 초기화2
      nDCInTime := '';
      nDCInTime := lbInTime.Caption;
      ExceptLogging('OCS 계산일(06 코드): ~'+nDCInTime);
      if bOCSUse then begin
        //OCSDCProc_CAR(sNowInTKNo);//ocs할인 차량인지 , 일반차량인지 구분, 일반차량 최대 요금 부과(구간상관없이)
        OCSDCProc_CAR_Ex(sNowInTKNo);
      end;

      if not bApsPay then
      begin
        if bFreeTime then
        begin
          if sFreeTimeE > Copy(sNowInTime, 1, 5) then
            nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                      nFeeNo,
                                      sNowInDate + ' ' + sFreeTimeE,
                                      Copy(sNow, 1, 16))
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + sFreeTimeE),
//                                 PAnsiChar(Copy(sNow, 1, 16)))
          else
            nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                      nFeeNo,
                                      sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
                                      Copy(sNow, 1, 16));
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
//                                 PAnsiChar(Copy(sNow, 1, 16)));
        end
        else

          if bOcsCodeUse = 1 then
          begin
            nTotYogum := DJSM_FeeCalcEx(nCurrParkNo,
                                    nFeeNo,
                                    sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
                                    sNowOutDate+ ' ' + Copy(sNowoutTime, 1, 5), 4);
          end
          else
          begin
             nTotYogum := DJSM_FeeCalcEx(nCurrParkNo,
                                    nFeeNo,
                                    sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
                                    sNowOutDate+ ' ' + Copy(sNowoutTime, 1, 5), 1);
          end;

//          nTotYogum := DJSM_FeeCalcEx(nCurrParkNo,
//                                    nFeeNo,
//                                    sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
//                                    sNowOutDate+ ' ' + Copy(sNowoutTime, 1, 5), 1);

//          nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
//                               PAnsiChar(Copy(sNow, 1, 16)));
      end
      else
      begin
        if bFreeTime then
        begin
          if sFreeTimeE > Copy(sAPSPayTime, 1, 5) then
            nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                      nFeeNo,
                                      sAPSPayDate + ' ' + sFreeTimeE,
                                      Copy(sNow, 1, 16))
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + sFreeTimeE),
//                                 PAnsiChar(Copy(sNow, 1, 16)))
          else
            nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                      nFeeNo,
                                      sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5),
                                      Copy(sNow, 1, 16));
//            nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5)),
//                                 PAnsiChar(Copy(sNow, 1, 16)));
        end
        else
        begin
          nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                    nFeeNo,
                                    sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5),
                                    Copy(sNow, 1, 16));
//          nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sAPSPayDate + ' ' + Copy(sAPSPayTime, 1, 5)),
//                               PAnsiChar(Copy(sNow, 1, 16)));
        end;
      end;
//      //동의대
//      //sLprCarNo1Check := AnsiString(Copy(sLprCarNo1, Length(sLprCarNo1) -5, 2));
//      //if Pos(Copy(sLprCarNo1, Length(sLprCarNo1) -4, 1), sAutoCar ) > 0 then begin
//      if Pos(Copy(sLprCarNo1, Length(sLprCarNo1) -5, 2), sAutoCar ) > 0 then begin
//        nTotYogum := 0;
//      end;

//      nOpenMax0
      //21.08.04 전광판의 요금이 표출이 되고 나서 프로그램에서 요금이 표출된다고 해서 미리 요금 초기화작업
      for i := 1 to 6 do
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;

      if bMode then
      begin
        nTotYogum2 := nTotYogum; //최초 요금 저장
        nProcYogum := nTotYogum;
        edtTotYogum.Text := IntToStr(nTotYogum);
        edtTotYogum.AutoThousandSeparator := True;
        //edtProcYogum.Text := IntToStr(nTotYogum);
        edtProcYogum.Text := FormatFloat('#,##0', nTotYogum);
        //edtProcYogum.AutoThousandSeparator := True;
        sYogum := IntToStr(nTotYogum);
        sProcTime := sNow;
//        sDCOutTime := sNow;
        sDCInTime :=  lbInTime.Caption;

        //21.08.04 전광판의 요금이 표출이 되고 나서 프로그램에서 요금이 표출된다고 함
        //전광판 요금 표출 시 프로그램에서도 바로 보이도록 조치
        //즉, 할인 전 요금도 표출하도록 조치
        for i := 1 to asYogum do
        begin
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
            (sYogum, Length(sYogum) - (i - 1), 1);
        end;

        if nUseFeeItem > 0 then begin
          lbDCName.Caption :='요금정기차량'
        end else begin
          DCProcess(sNowInTKNo); //요금계산로직
          sYogum := IntToStr(nProcYogum);
          asYogum:= Length(sYogum);
        end;

        {if bUseMiddle then
        begin
          lbDCName.Caption :='층별정기차량'
        end
        else if nUseFeeItem > 0 then begin
          lbDCName.Caption :='요금정기차량'
        end else begin
          if nFeeNo = 1 then
          begin
            lbDCName.Caption :='경차'
          end;

          DCProcess(sNowInTKNo); //요금계산로직
          sYogum := IntToStr(nProcYogum);
          asYogum:= Length(sYogum);
        end; }
      end
      else
      begin
        FreeTimeProc(nowLpr);
        bNCOutProcWait := False;
        Exit;
      end;

//      //부경대학교 개방운영 처리
//      if not bMode then begin
//        FreeTimeProc(nowLpr);
//        bNCOutProcWait := False;
//        Exit;
//      end;
      //할인된 주차요금 표시
      for i := 1 to 6 do
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;

      //for i := 1 to Length(sYogum) do
      for i := 1 to asYogum do
      begin
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
          (sYogum, Length(sYogum) - (i - 1), 1);
      end;

      if bOperation then
      begin
        for i := 1 to nUseBtnCnt do
        begin
          TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := True;
          TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := True;
        end;
      end;
      lbOutCarType.Caption := '일반차량';

      //if edtProcYogum.Text <> '0' then
      //  DspProc(2, 3, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP)
      //else
      if edtProcYogum.Text = '0' then
      begin
        if nDCCnt > 0 then
        begin
          DspProc(2, 4, '사전할인차량' + MG_Left(sInCarNo, 12), sDspIP);
          ExceptLogging('TfrmMain.NormalOut: 전광판문구표출 => 사전할인차량' );
        end
        else
        begin
          //DspProc(2, 4, '회차허용차량' + MG_Left(sInCarNo, 12), sDspIP);
          //ExceptLogging('TfrmMain.NormalOut: 전광판문구표출 => 회차허용차량' );
        end;
      end;

      InspectionLog('주차요금: ' + edtProcYogum.Text);

      if bOperation then
      begin
        // 정상운영시 처리...
//        if nTotYogum > 0 then
        if nProcYogum > 0 then
        begin
          btnProc.Enabled := True;

          if bCancel then
            btnCancel.Enabled := True;

          DCEnable(True);

          if bBarcodeDC then
          begin
            edtBarcode.Text := '';
            edtBarcode.SetFocus;
          end;

          if bTest then
          begin
            nPayType := 1;
            MoneyProc(nowLpr);
          end;
        end
        else
        begin
          if bZeroOpen then
          begin
            // 주차요금 0원시 자동오픈이면...
            bZeroOut := True;
            MoneyProc(nowLpr);
            bZeroOut := False;
          end;
        end;
      end
      else
      begin
        // 개방운영시 처리...
        // DB Write...
        with dmTables.qryNormalOut2 do
        begin
          Close;
          SQL.Clear;
          SQL.Add(
            'Select * from FreeIOData WITH(NOLOCK) Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
          SQL.Add('ProcTime = :N4 ');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nInUnitNo;
          Parameters.ParamByName('N3').Value := sInDate;
          Parameters.ParamByName('N4').Value := sInTime;
          Open;

          if RecordCount > 0 then
          begin
            // InData에 입차자료가 있으면...
            Close;
            SQL.Clear;
            SQL.Add(
              'Update FreeIOData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
            SQL.Add(
              'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
            SQL.Add(
              'OutRecog1 = :N9, OutRecog2 = :N10, Reserve3 = :N15, ParkingMin = :N16, ParkingAmt = :N17 ');
            SQL.Add(
              'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14');
            Parameters.ParamByName('N1').Value := nLprNo;
            Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
            Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
            Parameters.ParamByName('N4').Value := 4;
            Parameters.ParamByName('N5').Value := sLprFile1;
            Parameters.ParamByName('N6').Value := sLprCarNo1;
            Parameters.ParamByName('N7').Value := sLprFile2;
            Parameters.ParamByName('N8').Value := sLprCarNo2;
            Parameters.ParamByName('N9').Value := nLprRecog1;
            Parameters.ParamByName('N10').Value := nLprRecog2;
            Parameters.ParamByName('N11').Value := nCurrParkNo;
            Parameters.ParamByName('N12').Value := nInUnitNo;
            Parameters.ParamByName('N13').Value := sInDate;
            Parameters.ParamByName('N14').Value := sInTime;
            Parameters.ParamByName('N15').Value := '';
            Parameters.ParamByName('N16').Value := nParkingMin;
            Parameters.ParamByName('N17').Value := nTotYogum;
            ExecSQL;
          end
          else
          begin
            // InData에 입차자료가 없으면...
            ExceptLogging('TfrmMain.NormalOut: 입차자료없음-' + sLprCarNo1 + ', ' +
                sLprCarNo2);
          end;
        end;
        OutOpen(csLPR);
        if nUseFeeItem > 0 then begin
          NGridData('3' + sInCarNo + '^' + Copy(sNow, 1, 10) + ' ' + Copy
              (sNow, 12, 8) + '^0원');
        end else begin
          NGridData('2' + sInCarNo + '^' + Copy(sNow, 1, 10) + ' ' + Copy
              (sNow, 12, 8) + '^0원');
        end;
        sPrtData := '';
        // MichulProc(sInCarNo);
        bNCOutProcWait := False;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('NormalOut: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.NormalProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; bOpen: Boolean);
var
  sTKNo, sLprDate, sLprTime, sSend, sTemp, sFileIP: aString;
  nInCnt: Word;
begin
  try
    ExceptLogging('일반차량: ' + sLprCarNo1 + ', ' + sLprCarNo2);
    sLprDate := Copy(sIOTime, 1, 10);
    sLprTime := Copy(sIOTime, 12, 8);

    if nLprInOut = 1 then
    begin
      // 입차처리...
      try
        bNCInProcWait := True;
        //미출차 정리는 입차프로그램에서 처리

        if nInProcUse then begin
          // 동일한 차량번호로 입차된 기존 미출차차량은 미출차정리로 처리...
          if (sLprCarNo1 <> '') and (sLprCarNo1 <> '0000000000') then
            MichulProc(sLprCarNo1, sLprDate, sLprTime);

          if (sLprCarNo2 <> '') and (sLprCarNo2 <> '0000000000') then
            MichulProc(sLprCarNo2, sLprDate, sLprTime);

          sTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
        end;
        sTKNo := FormatDateTime('YYYYMMDDHHNNSS', Now)+ IntToStr(nCurrUnitNo);

        if (nLprRecog1 = 1) or (nLprRecog2 = 1) then
        begin
          if nLprRecog1 = 1 then
          begin
            NGridData('1' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime +
                '^입 차');
          end
          else if nLprRecog2 = 1 then
          begin
            NGridData('1' + sLprCarNo2 + '^' + sLprDate + ' ' + sLprTime +
                '^입 차');
          end;
        end
        else
        begin
          PartGridData('1' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime +
              '^입 차');
        end;

        if nInProcUse then begin
          InOpen(csLPR);
          DspProc(1, 2, '  일반차량  ' + MG_Left(sLprCarNo1, 12), sDspIP);

          with dmTables.qryNormal do begin
            Close;
            SQL.Clear;
            SQL.Add('Insert Into IONData ');
            SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, InImage1, InCarNo1, ');
            SQL.Add('InImage2, InCarNo2, Status, InRecog1, InRecog2, Reserve1,Reserve2,Reserve3) ');
            SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17)');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nLprNo;
            Parameters.ParamByName('N3').Value := sLprDate;
            Parameters.ParamByName('N4').Value := sLprTime;
            Parameters.ParamByName('N5').Value := sTKNo;
            Parameters.ParamByName('N6').Value := 1;
            Parameters.ParamByName('N7').Value := 1;
            Parameters.ParamByName('N8').Value := sLprFile1;
            Parameters.ParamByName('N9').Value := sLprCarNo1;
            Parameters.ParamByName('N10').Value := sLprFile2;
            Parameters.ParamByName('N11').Value := sLprCarNo2;
            Parameters.ParamByName('N12').Value := 1;
            Parameters.ParamByName('N13').Value := nLprRecog1;
            Parameters.ParamByName('N14').Value := nLprRecog2;
            Parameters.ParamByName('N15').Value := '';
            Parameters.ParamByName('N16').Value := '';
            Parameters.ParamByName('N17').Value := '';
            ExecSQL;
          end;
        end;
        ExceptLogging('일반차량입차: ' + sLprCarNo1 + ', ' + sLprCarNo2);
      finally
        bNCInProcWait := False;

        // 입차시의 이미지는 표시하지 않는다.  2012-05-07 UI 관련 미팅시 송우식 과장...
        // 일반차량 출차시 출차이미지와 함께 입차이미지를 표시한다....
      end;
    end
    else if nLprInOut = 2 then
    begin
      // 출차처리...
      try
        NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2, sIOTime,
          nLprNo, nLprInOut, nLprRecog1, nLprRecog2, sDspIP, csLPR);
        ExceptLogging('일반차량출차: ' + sLprCarNo1 + ', ' + sLprCarNo2);
      finally
        {
        sTemp := Copy(sLprFile1, 6, Length(sLprFile1) - 5);
        sLprFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
        sLprFile1 := sLprFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
            (sTemp) - (Pos(':9080', sTemp) + 4));
        sLprFile1 := MG_StrConvert(sLprFile1, '/', '\');

        sTemp := Copy(sLprFile2, 6, Length(sLprFile2) - 5);
        sLprFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
        sLprFile2 := sLprFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
            (sTemp) - (Pos(':9080', sTemp) + 4));
        sLprFile2 := MG_StrConvert(sLprFile2, '/', '\');
        }

        try
          if nLprRecog1 = 1 then
          begin
            lbInCarNo.Caption := nsInCarNo;
            lbCarNo.Caption := sLprCarNo1;
            lbOutCarNo.Caption := sLprCarNo1;

            {
            sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);

            if is_ping(sFileIP) then
            begin
              if FileExists(sLprFile1) then
              begin
                imgOut.Picture.LoadFromFile(sLprFile1);
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                ExceptLogging('파일없음: ' + sLprFile1);
              end;
            end
            else
            begin
              imgOut.Picture.Assign(Nil);
              ExceptLogging('파일없음: ' + sLprFile1);
            end;
            }
          end
          else if nLprRecog2 = 1 then
          begin
            lbInCarNo.Caption := nsInCarNo;
            lbCarNo.Caption := sLprCarNo2;
            lbOutCarNo.Caption := sLprCarNo2;

            {
            sFileIP:= Copy(sLprFile2, 3, Pos('\MSImage', sLprFile2)-3);

            if is_ping(sFileIP) then
            begin
              if FileExists(sLprFile2) then
              begin
                imgOut.Picture.LoadFromFile(sLprFile2);
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                ExceptLogging('파일없음: ' + sLprFile2);
              end;
            end
            else
            begin
              imgOut.Picture.Assign(Nil);
              ExceptLogging('파일없음: ' + sLprFile2);
            end;
            }
          end
          else
          begin
            lbInCarNo.Caption := nsInCarNo;
            lbCarNo.Caption := sLprCarNo1;
            lbOutCarNo.Caption := sLprCarNo1;

            {
            sFileIP:= Copy(sLprFile1, 3, Pos('\MSImage', sLprFile1)-3);

            if is_ping(sFileIP) then
            begin
              if FileExists(sLprFile1) then
              begin
                imgOut.Picture.LoadFromFile(sLprFile1);
              end
              else
              begin
                imgOut.Picture.Assign(Nil);
                ExceptLogging('파일없음: ' + sLprFile1);
              end;
            end
            else
            begin
              imgOut.Picture.Assign(Nil);
              ExceptLogging('파일없음: ' + sLprFile1);
            end;
            }
          end;
          nsInCarNo := '';
        except
          on E: Exception do
            ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('NormalProc: ' + aString(E.Message));
  end;
end;

function TfrmMainNew.chkHoliday(sDate: aString): Boolean; // 휴일: True, 평일
begin
  with dmTables.qryHoliday do
  begin
    Close;
    SQL.Clear;
    SQL.Add('Select * from Holiday WITH(NOLOCK) where ParkNo = :N1 and HDate = :N2');
    Parameters.ParamByName('N1').Value := 1;
    Parameters.ParamByName('N2').Value := sDate;
    Open;
    if RecordCount > 0 then
      Result := True
    else
      Result := False;
  end;
end;

procedure TfrmMainNew.DCEnable(bCheck: Boolean);
var
  i: Byte;
begin
  for i := 1 to 16 do
  begin
    with frmMainNew do
    begin
      TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := bCheck;
      TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := bCheck;
    end;
  end;
end;

function TfrmMainNew.DCFixedCheck(sUseWeekDay,sCarNo: AnsiString; nDayCount,
  nMonthCount: Integer): Boolean;
begin
  try
    Result:= True;
    if Copy(sUseWeekDay,dayofweek(now),1) = '0' then
    begin
      Result:= False;
      Exit;
    end;
    with dmTables.qryDCTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select count(*) nDayCnt from DCDetail WITH(NOLOCK) where CarNo = :N1 and ProcDate = :N2 ');
      Parameters.ParamByName('N1').Value:= sCarNo;
      Parameters.ParamByName('N2').Value:= FormatDateTime('YYYY-MM-DD', Now);
      Open;
      if nDayCount <> 0 then
      begin
        if nDayCount <= FieldByName('nDayCnt').AsInteger then
        begin
          Result:= False;
          Exit;
        end;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select count(*) nMonthCnt from DCDetail WITH(NOLOCK) where CarNo = :N1 and ');
      SQL.Add(' ((ProcDate <= :N2) and (ProcDate >= :N3)) ') ;
      Parameters.ParamByName('N1').Value:= sCarNo;
      Parameters.ParamByName('N2').Value:= FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N3').Value:= FormatDateTime('YYYY-MM-DD', Now);
      Open;
      if nMonthCount <> 0 then
      begin
        if nMonthCount <= FieldByName('nMonthCnt').AsInteger then
        begin
          Result:= False;
          Exit;
        end;
      end;
    end;
    Result:= True;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.GracetimeCheck: ' + E.Message);
  end;
end;

procedure TfrmMainNew.DCProcess(sNowTKno: String);
var
  sDspIP: aString;
  i: Integer;
begin
  try
    //할인하기전에 변수초기화
    nDCYogum := 0;
    nowUseTime := 0;//초과 시간에 대한 초기화

    if bOCSUse then begin
      //OCSDCProc(sNowInTKNo); //ocs연동
      OCSDCProc_Ex(sNowInTKNo); //ocs연동
    end;
    //sNowInTKNo := '00120020515063501';
    //sNowInTKNo :='2021031812393110';
    WebDCProc(sNowInTKNo); //웹할인
    //FixedDCProc(sNowLprCarNo1); //고정할인
  //  BarCodeDCProc(sNowInTKNo);

    {for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = nowLpr.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        Break;
      end;
    end;

    if edtProcYogum.Text <> '0' then
    begin
      DspProc(2, 4, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP);
    end;}

    if (edtProcYogum.Text = '0') and (bDCZeroAutoOpen = True) then begin
      //DspProc(2, 4, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP);
      ExceptLogging('할인후 잔여요금 0원 자동정산');
      btnProcClick(btnProc);
    end;
  //  WebDCProc(sNowInTKNo);
  //  if bWebUse1 then
  //  begin
  //    WebDCProc(sNowInTKNo);
  //    ExceptLogging('웹할인 처리 후 고정 처리 안함');
  //  end
  //  else
  //  begin
  //    FixedDCProc(sNowLprCarNo1);
  ////    ShowMessage('1111');
  ////    ExceptLogging('웹할인 없으므로 고정 처리 시작');
  //  end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.DCProcess: ' + E.Message);
  end;
end;

procedure TfrmMainNew.dgLostClick(Sender: TObject);
var
  sIn, sTime, sDir, sTemp, sFileIP: aString;
  nNo: Byte;
begin
  try
    if dmTables.qryLost1.RecordCount > 0 then
      with dmTables.qryLost1 do
      begin
        nNo := FieldByName('UnitNo').AsInteger;

        if FieldByName('InRecog1').AsInteger = 1 then
        begin
          sIn := FieldByName('InImage1').AsString;
          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
          sLostInCarNo := FieldByName('InCarNo1').AsString;
          nLostInRecog := 1;
        end
        else if FieldByName('InRecog2').AsInteger = 1 then
        begin
          sIn := FieldByName('InImage2').AsString;
          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
          sLostInCarNo := FieldByName('InCarNo2').AsString;
          nLostInRecog := 1;
        end
        else
        begin
          sIn := FieldByName('InImage1').AsString;
          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
          sLostInCarNo := FieldByName('InCarNo1').AsString;
          nLostInRecog := FieldByName('InRecog1').AsInteger;
        end;
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 5, 2)
          + '\' + Copy(sTime, 7, 2) + '\' + IntToStr(nNo);
        sLostInDate := FieldByName('ProcDate').AsString;
        sLostInTime := FieldByName('ProcTime').AsString;
        nLostInUnitNo := nNo;
        sLostInFile := sIn;
        if FieldByName('usemiddle').asinteger = 0 then
        begin
          sLostInTKNo := FieldByName('TKNo').AsString;
        end
        else
        begin
          sLostInTKNo :='00000';
        end;

        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        try
          if Copy(sIn, 1, 4) = 'http' then
          begin
            ExceptLogging('일반차량 입차 파일 확인 File: ' + sIn);
            sTemp:= Copy(sIn, 6, Length(sIn)-5);
            sIn:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
            sIn:= sIn + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
            sIn:= MG_StrConvert(sIn, '/', '\');
            ExceptLogging('HTTP 형식 입차 File: ' + sIn);
          end;
          sFileIP:= Copy(sIn, 3, Pos('\MSImage', sIn)-3);
//          sTemp := Copy(sIn, 6, Length(sIn) - 5);
//          sIn := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
//          sIn := sIn + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) -
//              (Pos(':9080', sTemp) + 4));
//          sIn := MG_StrConvert(sIn, '/', '\');
//          ExceptLogging('File: ' + sIn);
//          sFileIP:= Copy(sIn, 3, Pos('\MSImage', sIn)-3);

          if is_ping(sFileIP) then
          begin
            if FileExists(sIn) then
            begin
              imgLost.Picture.LoadFromFile(sIn);
            end
            else
            begin
              imgLost.Picture.Assign(Nil);
              ExceptLogging('File 없음: ' + sIn);
            end;
          end
          else
          begin
            imgLost.Picture.Assign(Nil);
            ExceptLogging('File 없음: ' + sIn);
          end;
        except
          on E: Exception do
            ExceptLogging('TfrmMain.Lost_FileDownload: ' + aString(E.Message));
        end;
      end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.dgLostClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.dgNManualProcClick(Sender: TObject);
var
  sIn, sTime, sDir, sTemp, sFileIP: aString;
  nNo: Byte;
begin
  try
    if dmTables.qryLost1.RecordCount > 0 then
      with dmTables.qryLost1 do
      begin
        nNo := FieldByName('UnitNo').AsInteger;

        if FieldByName('InRecog1').AsInteger = 1 then
        begin
          sIn := FieldByName('InImage1').AsString;
          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
          sLostInCarNo := FieldByName('InCarNo1').AsString;
          nLostInRecog := 1;
        end
        else if FieldByName('InRecog2').AsInteger = 1 then
        begin
          sIn := FieldByName('InImage2').AsString;
          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
          sLostInCarNo := FieldByName('InCarNo2').AsString;
          nLostInRecog := 1;
        end
        else
        begin
          sIn := FieldByName('InImage1').AsString;
          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
          sLostInCarNo := FieldByName('InCarNo1').AsString;
          nLostInRecog := FieldByName('InRecog1').AsInteger;
        end;
        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 5, 2)
          + '\' + Copy(sTime, 7, 2) + '\' + IntToStr(nNo);
        sLostInDate := FieldByName('ProcDate').AsString;
        sLostInTime := FieldByName('ProcTime').AsString;
        nLostInUnitNo := nNo;
        sLostInFile := sIn;
        if FieldByName('usemiddle').asinteger = 0 then
        begin
          sLostInTKNo := FieldByName('TKNo').AsString;
        end
        else
        begin
          sLostInTKNo :='00000';
        end;



        if not DirectoryExists(sDir) then
        begin
          if not ForceDirectories(sDir) then
            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
        end;

        //숭실대학교 출차시 입차이미지 표출 안함
        try
          if Copy(sIn, 1, 4) = 'http' then
          begin
            ExceptLogging('일반차량 입차 파일 확인 File: ' + sIn);
            sTemp:= Copy(sIn, 6, Length(sIn)-5);
            sIn:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
            sIn:= sIn + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
            sIn:= MG_StrConvert(sIn, '/', '\');
            ExceptLogging('HTTP 형식 입차 File: ' + sIn);
          end;
          sFileIP:= Copy(sIn, 3, Pos('\MSImage', sIn)-3);
//          sTemp := Copy(sIn, 6, Length(sIn) - 5);
//          sIn := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
//          sIn := sIn + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) -
//              (Pos(':9080', sTemp) + 4));
//          sIn := MG_StrConvert(sIn, '/', '\');
//          ExceptLogging('File: ' + sIn);
//          sFileIP:= Copy(sIn, 3, Pos('\MSImage', sIn)-3);

          if is_ping(sFileIP) then
          begin
            if FileExists(sIn) then
            begin
              imgIn.Picture.LoadFromFile(sIn);
              imgNManual.Picture.LoadFromFile(sIn);
            end
            else
            begin
              imgIn.Picture.Assign(Nil);
              imgNManual.Picture.Assign(Nil);
              ExceptLogging('File 없음: ' + sIn);
            end;
          end
          else
          begin
            imgIn.Picture.Assign(Nil);
            imgNManual.Picture.Assign(Nil);
            ExceptLogging('File 없음: ' + sIn);
          end;
        except
          on E: Exception do
            ExceptLogging('TfrmMain.Lost_FileDownload: ' + aString(E.Message)
              );
        end;
      end;
//    if dmTables.qryLost.RecordCount > 0 then
//      with dmTables.qryLost do
//      begin
//        nNo := FieldByName('UnitNo').AsInteger;
//
//        if FieldByName('InRecog1').AsInteger = 1 then
//        begin
//          sIn := FieldByName('InImage1').AsString;
//          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
//          sLostInCarNo := FieldByName('InCarNo1').AsString;
//          nLostInRecog := 1;
//        end
//        else if FieldByName('InRecog2').AsInteger = 1 then
//        begin
//          sIn := FieldByName('InImage2').AsString;
//          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
//          sLostInCarNo := FieldByName('InCarNo2').AsString;
//          nLostInRecog := 1;
//        end
//        else
//        begin
//          sIn := FieldByName('InImage1').AsString;
//          sTime := Copy(sIn, Pos('_', sIn) + 1, 14);
//          sLostInCarNo := FieldByName('InCarNo1').AsString;
//          nLostInRecog := FieldByName('InRecog1').AsInteger;
//        end;
//        sDir := sImageDir + '\' + Copy(sTime, 1, 4) + '\' + Copy(sTime, 5, 2)
//          + '\' + Copy(sTime, 7, 2) + '\' + IntToStr(nNo);
//        sLostInDate := FieldByName('ProcDate').AsString;
//        sLostInTime := FieldByName('ProcTime').AsString;
//        nLostInUnitNo := nNo;
//        sLostInFile := sIn;
//        sLostInTKNo := FieldByName('TKNo').AsString;
//
//        if not DirectoryExists(sDir) then
//        begin
//          if not ForceDirectories(sDir) then
//            ExceptLogging('이미지저장폴더 생성실패: ' + sDir);
//        end;
//
//        //숭실대학교 출차시 입차이미지 표출 안함
//        try
//          if Copy(sIn, 1, 4) = 'http' then
//          begin
//            ExceptLogging('일반차량 입차 파일 확인 File: ' + sIn);
//            sTemp:= Copy(sIn, 6, Length(sIn)-5);
//            sIn:= Copy(sTemp, 1, Pos(':9080', sTemp)-1);
//            sIn:= sIn + Copy(sTemp, Pos(':9080', sTemp)+5, Length(sTemp)-(Pos(':9080', sTemp)+4));
//            sIn:= MG_StrConvert(sIn, '/', '\');
//            ExceptLogging('HTTP 형식 입차 File: ' + sIn);
//          end;
//          sFileIP:= Copy(sIn, 3, Pos('\MSIMAGE', sIn)-3);
////          sTemp := Copy(sIn, 6, Length(sIn) - 5);
////          sIn := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
////          sIn := sIn + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) -
////              (Pos(':9080', sTemp) + 4));
////          sIn := MG_StrConvert(sIn, '/', '\');
////          ExceptLogging('File: ' + sIn);
////          sFileIP:= Copy(sIn, 3, Pos('\MSImage', sIn)-3);
//
//          if is_ping(sFileIP) then
//          begin
//            if FileExists(sIn) then
//            begin
//              imgIn.Picture.LoadFromFile(sIn);
//              imgNManual.Picture.LoadFromFile(sIn);
//            end
//            else
//            begin
//              imgIn.Picture.Assign(Nil);
//              imgNManual.Picture.Assign(Nil);
//              ExceptLogging('File 없음: ' + sIn);
//            end;
//          end
//          else
//          begin
//            imgIn.Picture.Assign(Nil);
//            imgNManual.Picture.Assign(Nil);
//            ExceptLogging('File 없음: ' + sIn);
//          end;
//        except
//          on E: Exception do
//            ExceptLogging('TfrmMain.Lost_FileDownload: ' + aString(E.Message)
//              );
//        end;
//      end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.dgNManualProcClick: ' + E.Message);
  end;
end;

procedure TfrmMainNew.InOpen(csLPR: TClientSocket);
begin
  try
    if is_ping(csLpr.Host) then
    begin
      csLPR.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('입구차단기 Open');
    end
    else begin
      ExceptLogging(csLpr.Host + ' LPR 차단기 오픈시 네트워크 오류!');
      if is_ping(csLpr.Host) then
      begin
        csLPR.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('입구차단기 ReOpen');
      end
      else
        ExceptLogging(csLpr.Host + ' LPR 차단기 재오픈시 네트워크 오류!');
    end;
  except
    on E: Exception do
      ExceptLogging('InOpen: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.OutCarList;
var
 i : Integer;
begin
    with dmTables.ADOQuery2 do
    begin
       Close;
       SQL.Clear;
       SQL.Add('  	   select OutUnitName, OutDate, OutTime, GroupName, name, OutCarNo1, CompName, DeptName, CarType2, ExpDateT   from ( ');
       SQL.Add('Select b.UnitName as OutUnitName, a.OutDate, a.OutTime, a.GroupName, a.name,                                              ');
       SQL.Add('       a.OutCarNo1,  a.CompName, a.DeptName, ''정기차량''  as CarType2, d.ExpDateT                                        ');
       SQL.Add('  from IOSData a Inner Merge join UnitInfo b ON a.outUnitNo = b.UnitNo                                                    ');
       SQL.Add('                 Left outer join CustInfo d ON d.Carno = a.OutCarNo1                                                      ');
       SQL.Add('  where OutDate >= :N1 and OutDate <= :N2 and  a.TKType = 2  and b.Myno = :N5 and b.UnitKind = 9                          ');
       SQL.Add('  union                                                                                                                  ');
       SQL.Add('Select b.UnitName as OutUnitName, a.OutDate, a.OutTime, '''', '''',                                                      ');
       SQL.Add('       a.OutCarNo1, a.Reserve2, a.Reserve3, ''일반차량'' as CarType2, ''''                                               ');
       SQL.Add('  from IONData a Inner Merge join UnitInfo b ON a.outUnitNo = b.UnitNo                                                   ');
       SQL.Add('  where OutDate >= :N3 and OutDate <= :N4 and b.Myno = :N6  and b.UnitKind = 9                                           ');
       SQL.Add(')IOS_N                                                                                                                   ');
       SQL.Add('order by OutDate desc, OutTime desc                                                                                      ');

       Parameters.ParamByName('N1').Value:= FormatDateTime('yyyy-mm-dd', now);
       Parameters.ParamByName('N2').Value:= FormatDateTime('yyyy-mm-dd', now);

       Parameters.ParamByName('N3').Value:= FormatDateTime('yyyy-mm-dd', now);
       Parameters.ParamByName('N4').Value:= FormatDateTime('yyyy-mm-dd', now);

       Parameters.ParamByName('N5').Value:= nCurrUnitNo;
       Parameters.ParamByName('N6').Value:= nCurrUnitNo;
       Open;

       if eof then
       begin
         //ShowMessage('데이터가 없습니다.');
         Exit;
       end;

       i := 1;
       while not eof do
       begin
         with sgOut do
         begin
            Cells[0, 0]  := '차량종류';
            Cells[1, 0] := '출차일자';
            Cells[2, 0] := '출차시각';
            Cells[3, 0] := '차량번호';
            Cells[4, 0] := '소속';
            Cells[5, 0] := '성명';
            Cells[6, 0] := '유효기간';
            Cells[7, 0] := '출입상태';


            Cells[0, i] := FieldByName('CarType2').AsString;
            Cells[1, i] := FieldByName('OutDate').AsString;
            Cells[2, i] := FieldByName('OutTime').AsString;
            Cells[3, i] := FieldByName('OutCarNo1').AsString;
            Cells[4, i] := FieldByName('CompName').AsString+' '+FieldByName('DeptName').AsString;
            Cells[5, i] := FieldByName('Name').AsString;
            Cells[6, i] := FieldByName('ExpDateT').AsString;
            Cells[7, i] := '출 차';

            Alignments[0, i] := taCenter;
            Alignments[1, i] := taCenter;
            Alignments[2, i] := taCenter;
            Alignments[3, i] := taCenter;
            Alignments[4, i] := taCenter;
            Alignments[5, i] := taCenter;
            Alignments[6, i] := taCenter;
            Alignments[7, i] := taCenter;

         end;
         inc(i);
         Next;
       end;

      with sgOut do
      begin
         ColCount := 8;
         RowCount := i;
      end;
    end;
end;

procedure TfrmMainNew.OutOpen(csLPR: TClientSocket);
begin
  try
    if is_Ping(csLpr.Host) then
    begin
      csLPR.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('출구차단기 Open');
    end
    else begin
      ExceptLogging(csLpr.Host + ' LPR 차단기 오픈시 네트워크 오류!');
      if is_ping(csLpr.Host) then
      begin
        csLPR.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('출구차단기 ReOpen');
      end
      else
        ExceptLogging(csLpr.Host + ' LPR 차단기 재오픈시 네트워크 오류!');
    end;
    with dmTables.qryparkcnt do
    begin
      Close;
      SQL.Clear;
      SQL.Add('update parkcnt set  UseArea= UseArea-1  ');
      SQL.Add(  'where ParkNo=:N1 and ParkAreaId=:N2  ');
      Parameters.ParamByName('N1').Value := 1;
      Parameters.ParamByName('N2').Value := 1;
      ExecSQL;
    end;

  except
    on E: Exception do
      ExceptLogging('OutOpen: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.MoneyProc(csLPR: TClientSocket);
var
  i, nOutCnt: Integer;
  sParkName, sParkAddr, sRegNo, sAdmin, sTelephone, sReceipt, sCarNo: String;
  sSend: String;
  logStr: String;
begin
  // 현금으로 계산...
  try
    logStr := '';
    ExceptLogging('MoneyProc : 결제 Start');
    if nPayType = 1 then
    begin
      logStr := ('MoneyProc : 결제구분 : 현금');
      nMCnt := nMCnt + 1;
      lbMCnt.Caption := FormatFloat('#,##0', nMCnt) + ' 건';
      nMTot := nMTot + StrToInt(MG_StrTrim(edtProcYogum.Text, ','));
      lbMTot.Caption := FormatFloat('#,##0', nMTot) + ' 원';
      logStr := logStr + #13#10 + ('MoneyProc :  현금 ['+lbMCnt.Caption+']회 ['+lbMTot.Caption+']원');
    end
    else if nPayType = 2 then
    begin
      logStr := logStr + #13#10 + ('MoneyProc : 결제구분 : 카드');
      nMCreditCnt := nMCreditCnt + 1;
      lbMCreditCnt.Caption := FormatFloat('#,##0', nMCreditCnt) + ' 건';
      nMCreditTot := nMCreditTot + StrToInt(MG_StrTrim(edtProcYogum.Text, ','));
      lbMCreditTot.Caption := FormatFloat('#,##0', nMCreditTot) + ' 원';
      logStr := logStr + #13#10 + ('MoneyProc :  현금 ['+lbMCreditCnt.Caption+']회 ['+lbMCreditTot.Caption+']원');
    end;
    nOutCnt := 0;

    // DB Write...
    with dmTables.qryMoneyProc do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from TKProc WITH(NOLOCK) where ParkNo = :N1 and UnitNo = :N2 and ');
      SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := sNowOutDate;
      Parameters.ParamByName('N4').Value := sNowOutTime;
      Parameters.ParamByName('N5').Value := sNowInTKNo;
      Open;

      if RecordCount <= 0 then
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into TKProc ');
        SQL.Add
          ('(ParkNo, UnitNo, ProcDate, ProcTime, TKType, CarType, FeeNo, ');
        SQL.Add
          ('TKNo, TKParkNo, TKUnitNo, CarNo, InDate, InTime, ParkingMin, ');
        SQL.Add
          ('TotFee, TotDC, RealFee, RecvAmt, Change, DCCnt, MNo, UnPaid, ');
        SQL.Add(
          'ChkClosing, CommercialTariff, SpecialTariff, PayType, Reserve2) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, ');
        SQL.Add(':N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
        SQL.Add(':N21, :N22, :N23, :N24, :N25, :N26, :N27)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := sNowOutDate;
        Parameters.ParamByName('N4').Value := sNowOutTime;
        Parameters.ParamByName('N5').Value := nTKType;
        Parameters.ParamByName('N6').Value := 1;
        Parameters.ParamByName('N7').Value := nFeeNo;
        Parameters.ParamByName('N8').Value := sNowInTKNo;
        Parameters.ParamByName('N9').Value := nCurrParkNo;
        Parameters.ParamByName('N10').Value := nNowInUnitNo;
        Parameters.ParamByName('N11').Value := sNowInCarNo;
        Parameters.ParamByName('N12').Value := sNowInDate;
        Parameters.ParamByName('N13').Value := sNowInTime;
        Parameters.ParamByName('N14').Value := nParkingMin;
        Parameters.ParamByName('N15').Value := StrToInt
          (MG_StrTrim(edtTotYogum.Text, ','));
        Parameters.ParamByName('N16').Value := StrToInt
          (MG_StrTrim(edtDCYogum.Text, ','));
        Parameters.ParamByName('N17').Value := StrToInt
          (MG_StrTrim(edtProcYogum.Text, ','));
        Parameters.ParamByName('N18').Value := StrToInt
          (MG_StrTrim(edtProcYogum.Text, ','));
        Parameters.ParamByName('N19').Value := 0;
        Parameters.ParamByName('N20').Value := nDCCnt;
        Parameters.ParamByName('N21').Value := nCurrMNo;
        Parameters.ParamByName('N22').Value := 0;
        Parameters.ParamByName('N23').Value := 0;
        Parameters.ParamByName('N24').Value := 0;
        if bFreeFee then
        begin
          logStr := logStr + #13#10 + ('MoneyProc : 무료출차');
          Parameters.ParamByName('N25').Value := 1;
        end
        else
        begin
          logStr := logStr + #13#10 + ('MoneyProc : 유료출차');
          Parameters.ParamByName('N25').Value := 0;
        end;
        Parameters.ParamByName('N26').Value := nPayType;

        if bZeroOut then begin
          logStr := logStr + #13#10 + ('MoneyProc : 회차');
          Parameters.ParamByName('N27').Value := '회차'
        end else begin
          logStr := logStr + #13#10 + ('MoneyProc : 정산차량');
          Parameters.ParamByName('N27').Value := '';
        end;
        ExecSQL;
      end else begin
        logStr := logStr + #13#10 + ('MoneyProc : DB에 동일한 정산정보 있음 : 기록안함');
      end;

      logStr := logStr + #13#10 + ('MoneyProc : 할인처리 확인시작');
      if nDCCnt > 0 then
      begin
        logStr := logStr + #13#10 + ('MoneyProc : 할인 횟수 ['+IntToStr(nDCCnt)+']회.. 할인처리 시작');
        for i := 1 to nDCCnt do begin
          logStr := logStr + #13#10 + ('['+IntToStr(i)+']번째 할인처리 시작');
          //if DCProc[i].nDCAmt > 0 then
          if DCProc[i].sDCName <> '' then
          begin
            logStr := logStr + #13#10 + ('['+IntToStr(i)+']번째 할인명 : ' +DCProc[i].sDCName);
            Close;
            SQL.Clear;
            SQL.Add('Insert Into DCDetail ');
            SQL.Add
              ('(ParkNo, UnitNo, ProcDate, ProcTime, DCSeq, TKNo, CarNo, ');
            SQL.Add(
              'DCNo, DCAmt, RealDCAmt, DCTKNo, DCTKIssueDate, DCTKIssueTime, DCType, MNo, ChkClosing, Reserve5, ');
            SQL.Add(
              '   Reserve4, Reserve1, DCTypeCode,discountMtd, RealDCMin) ');
            SQL.Add(
              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22)');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nCurrUnitNo;
            Parameters.ParamByName('N3').Value := sNowOutDate;
            Parameters.ParamByName('N4').Value := sNowOutTime;
            Parameters.ParamByName('N5').Value := i;
            Parameters.ParamByName('N6').Value := sNowInTKNo;
            Parameters.ParamByName('N7').Value := sNowInCarNo;
            Parameters.ParamByName('N8').Value := DCProc[i].nDCNo;
            Parameters.ParamByName('N9').Value := DCProc[i].nDCAmt;
            Parameters.ParamByName('N10').Value := DCProc[i].nRealDCAmt;
            Parameters.ParamByName('N11').Value := DCProc[i].sDCTKNo;
            Parameters.ParamByName('N12').Value := DCProc[i].sDCTKIssueDate;
            Parameters.ParamByName('N13').Value := DCProc[i].sDCTKIssueTime;
            Parameters.ParamByName('N14').Value := DCProc[i].nDCType;
            Parameters.ParamByName('N15').Value := nCurrMNo;
            Parameters.ParamByName('N16').Value := 0;
            Parameters.ParamByName('N17').Value := DCProc[i].sDCName;
            if DCProc[i].nDCKind = 1 then                               //할인방법에 따라 Reserve4에 기록
            begin
              logStr := logStr + #13#10 + ('['+IntToStr(i)+']번째 할인['+DCProc[i].sDCName+'] : ButtonType');
              Parameters.ParamByName('N18').Value := 'ButtonType';
              Parameters.ParamByName('N21').Value := 2;
            end
            else if DCProc[i].nDCKind = 2 then
            begin
              logStr := logStr + #13#10 + ('['+IntToStr(i)+']번째 할인['+DCProc[i].sDCName+'] : Web');
              Parameters.ParamByName('N18').Value := 'Web';
              Parameters.ParamByName('N21').Value := 1;
            end
            else if DCProc[i].nDCKind = 3 then
            begin
              logStr := logStr + #13#10 + ('['+IntToStr(i)+']번째 할인['+DCProc[i].sDCName+'] : Fixed');
              Parameters.ParamByName('N18').Value := 'Fixed';
              Parameters.ParamByName('N21').Value := 10;
            end
            else
            begin
              logStr := logStr + #13#10 + ('['+IntToStr(i)+']번째 할인['+DCProc[i].sDCName+'] : Magnetic');
              Parameters.ParamByName('N18').Value := 'Magnetic';
              Parameters.ParamByName('N21').Value := 3;
            end;
            Parameters.ParamByName('N19').Value := DCProc[i].nSeq;              //우선순위 처리
            Parameters.ParamByName('N20').Value := DCProc[i].nTypeCode;         //할인유형처리 0: 기본할인, 1: 충전할인, 2: 후불할인
            Parameters.ParamByName('N22').Value := DCProc[i].nRealDCMin;
//            Parameters.ParamByName('N22').Value := DCProc[i].sStoreName;        //할인처명 이름
//            Parameters.ParamByName('N23').Value := nUseParkNo;                  //위치 : 1 용당/ 2 대현
            ExecSQL;

            if DCProc[i].sSeq <>'' then                 //웹할인
            begin
              Close;
              SQL.Clear;
              SQL.Add
                ('Update tblStoreDiscountPublish Set OutYmd = :N1, OutHms = :N2, Reserve5 = :N3 ');
              SQL.Add('where NorKey = :N4 and DelYn = 0 and outYmd is null ');
              if DCProc[i].sSeq = '0' then
              begin
                SQL.Add(' and  Reserve1 = 0 ');
              end
              else
              begin
                SQL.Add(' and  Sequence = :N5 ');
              end;

              Parameters.ParamByName('N1').Value := sNowOutDate;
              Parameters.ParamByName('N2').Value := sNowOutTime;
              Parameters.ParamByName('N3').Value := DCProc[i].nSeq;
              Parameters.ParamByName('N4').Value := sNowInTKNo;
              if DCProc[i].sSeq <> '0'  then
              begin
                Parameters.ParamByName('N5').Value := DCProc[i].sSeq;
              end;
              ExecSQL;
            end;
          end;
        end;

        //처리되지 않은 금액할인 값이 존재하면 업데이트 한다.
        Close;
        SQL.Clear;
        SQL.Add
          ('Update tblStoreDiscountPublish Set OutYmd = :N1, OutHms = :N2, Reserve5 = :N3 ');
        SQL.Add('where NorKey = :N4 and DelYn = 0 and outYmd is null ');
        Parameters.ParamByName('N1').Value := sNowOutDate;
        Parameters.ParamByName('N2').Value := sNowOutTime;
        Parameters.ParamByName('N3').Value := DCProc[i].nSeq;
        Parameters.ParamByName('N4').Value := sNowInTKNo;
        ExecSQL;
      end else begin
        logStr := logStr + #13#10 + ('MoneyProc : 할인없음.. 확인종료');
      end;
      logStr := logStr + #13#10 + ('MoneyProc : 할인처리 확인종료');



      logStr := logStr + #13#10 + ('MoneyProc : 중간입차 확인시작');
      if bUseMiddle then
      begin
        logStr := logStr + #13#10 + ('MoneyProc : 중간입차확인');
        Close;
        SQL.Clear;
        SQL.Add(
          'Delete from IOSData where ParkNo = :N1 and ProcDate = :N2 and ProcTime = :N3 and ');
        SQL.Add('((InCarNo1 = :N4) or (InCarNo2 = :N5))');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := sNowInDate;
        Parameters.ParamByName('N3').Value := sNowInTime;
        Parameters.ParamByName('N4').Value := sNowInCarNo;
        Parameters.ParamByName('N5').Value := sNowInCarNo;
        ExecSQL;
      end else begin
        logStr := logStr + #13#10 + ('MoneyProc : 중간입차 아님');
      end;
      logStr := logStr + #13#10 + ('MoneyProc : 중간입차 확인종료');

      logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 확인 시작');
      if nUseFeeItem > 0 then begin
        {$REGION '정기차량 요금부과'}
        logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 대상차량 확인');
        //정기차량 요금부과시 수동출차 및 회차처리만.(미인식 없음)
        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from IOSData WITH(NOLOCK) Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
        SQL.Add('ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nNowInUnitNo;
        Parameters.ParamByName('N3').Value := sNowInDate;
        Parameters.ParamByName('N4').Value := sNowInTime;
        Parameters.ParamByName('N5').Value := sNowInTKNo;
        Open;

        if RecordCount > 0 then
        begin
          logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 대상차량 입차자료 확인');
          // InData에 입차자료가 있으면...
          Close;
          SQL.Clear;
          SQL.Add(
            'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');  //, OutChk = :N4
          SQL.Add(
            'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
          SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10 ');         //, Reserve1 = :N16
          SQL.Add(
            'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
          Parameters.ParamByName('N1').Value := nNowLprNo;
          Parameters.ParamByName('N2').Value := Copy(sNowOutDate, 1, 10);
          Parameters.ParamByName('N3').Value := Copy(sNowOutTime, 12, 8);
          Parameters.ParamByName('N5').Value := sNowLprFile1;
          Parameters.ParamByName('N6').Value := sNowLprCarNo1;
          Parameters.ParamByName('N7').Value := sNowLprFile2;
          Parameters.ParamByName('N8').Value := sNowLprCarNo2;
          Parameters.ParamByName('N9').Value := nNowLprRecog1;
          Parameters.ParamByName('N10').Value := nNowLprRecog2;
          Parameters.ParamByName('N11').Value := nCurrParkNo;
          Parameters.ParamByName('N12').Value := nNowInUnitNo;
          Parameters.ParamByName('N13').Value := sNowInDate;
          Parameters.ParamByName('N14').Value := sNowInTime;
          Parameters.ParamByName('N15').Value := sNowInTKNo;
          ExecSQL;
        end else begin
          logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 대상차량 입차자료 없음');
        end;
        //입차자료 없는차량 올 수 없음
      end else begin
        logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 대상차량 아님.. 일반차량 요금부과');
        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from IONData WITH(NOLOCK) Where ParkNo = :N1 and UnitNo = :N2 and ProcDate = :N3 and ');
        SQL.Add('ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nNowInUnitNo;
        Parameters.ParamByName('N3').Value := sNowInDate;
        Parameters.ParamByName('N4').Value := sNowInTime;
        Parameters.ParamByName('N5').Value := sNowInTKNo;
        Open;

        if RecordCount > 0 then
        begin
          logStr := logStr + #13#10 + ('MoneyProc : 일반차량 입차자료 확인');
          // InData에 입차자료가 있으면...
          Close;
          SQL.Clear;
          SQL.Add(
            'Update IONData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
          SQL.Add(
            'OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, '
            );
          SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N16 ');
          SQL.Add(
            'where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
          Parameters.ParamByName('N1').Value := nNowLprNo;
          Parameters.ParamByName('N2').Value := sNowOutDate;
          Parameters.ParamByName('N3').Value := sNowOutTime;

          if nDCCnt > 0 then
          begin
            // 할인처리
            if StrToInt(MG_StrTrim(edtProcYogum.Text, ',')) > 0 then
            begin
              // 할인처리후 유료출차
              Parameters.ParamByName('N4').Value := 2;
            end
            else
            begin
              // 무료출차
              Parameters.ParamByName('N4').Value := 3;
            end;
          end
          else
          begin
            //할인을 하지않고
            if StrToInt(MG_StrTrim(edtProcYogum.Text, ',')) > 0 then
            begin
              // 주차요금이 있으면 정상출차
              Parameters.ParamByName('N4').Value := 1;
            end
            else
            begin
              // 주차요금이 없으면 무료출차
              Parameters.ParamByName('N4').Value := 3;
            end;
          end;
          Parameters.ParamByName('N5').Value := sNowLprFile1;
          Parameters.ParamByName('N6').Value := sNowLprCarNo1;
          Parameters.ParamByName('N7').Value := sNowLprFile2;
          Parameters.ParamByName('N8').Value := sNowLprCarNo2;
          Parameters.ParamByName('N9').Value := nNowLprRecog1;
          Parameters.ParamByName('N10').Value := nNowLprRecog2;
          Parameters.ParamByName('N11').Value := nCurrParkNo;
          Parameters.ParamByName('N12').Value := nNowInUnitNo;
          Parameters.ParamByName('N13').Value := sNowInDate;
          Parameters.ParamByName('N14').Value := sNowInTime;
          Parameters.ParamByName('N15').Value := sNowInTKNo;

          if bMiProc then
            Parameters.ParamByName('N16').Value := '미인식처리'
          else if bManualOut then
            Parameters.ParamByName('N16').Value := '수동출차'
          else
            Parameters.ParamByName('N16').Value := '';
          ExecSQL;
        end
        else
        begin
          logStr := logStr + #13#10 + ('MoneyProc : 일반차량 입차자료 없음');
          // InData에 발권자료가 없으면...
          Close;
          SQL.Clear;
          SQL.Add('Insert Into IONData ');
          SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, ');
          SQL.Add('InImage1, InCarNo1, InImage2, InCarNo2, Status, OutUnitNo, ');
          SQL.Add(
            'OutDate, OutTime, OutChk, OutImage1, OutCarNo1, OutImage2, OutCarNo2, ');
          SQL.Add('InRecog1, OutRecog1, InRecog2, OutRecog2, Reserve1) ');
          SQL.Add(
            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
          SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
          SQL.Add(':N21, :N22, :N23, :N24, :N25)');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nNowInUnitNo;
          Parameters.ParamByName('N3').Value := sNowInDate;
          Parameters.ParamByName('N4').Value := sNowInTime;
          Parameters.ParamByName('N5').Value := sNowInTKNo;
          Parameters.ParamByName('N6').Value := nTKType;
          Parameters.ParamByName('N7').Value := 1;
          Parameters.ParamByName('N8').Value := sNowInFile;
          Parameters.ParamByName('N9').Value := sNowInCarNo;
          Parameters.ParamByName('N10').Value := '';
          Parameters.ParamByName('N11').Value := '';
          Parameters.ParamByName('N12').Value := 1;
          Parameters.ParamByName('N13').Value := nNowLprNo;
          Parameters.ParamByName('N14').Value := sNowOutDate;
          Parameters.ParamByName('N15').Value := sNowOutTime;

          if nDCCnt > 0 then
          begin
            // 할인처리
            if StrToInt(MG_StrTrim(edtProcYogum.Text, ',')) > 0 then
            begin
              // 할인처리후 유료출차
              Parameters.ParamByName('N16').Value := 2;
            end
            else
            begin
              // 무료출차
              Parameters.ParamByName('N16').Value := 3;
            end;
          end
          else
          begin
            // 할인처리 안함. 정상출차
            Parameters.ParamByName('N16').Value := 1;
          end;
          Parameters.ParamByName('N17').Value := sNowLprFile1;
          Parameters.ParamByName('N18').Value := sNowLprCarNo1;
          Parameters.ParamByName('N19').Value := sNowLprFile2;
          Parameters.ParamByName('N20').Value := sNowLprCarNo2;
          Parameters.ParamByName('N21').Value := 3;
          Parameters.ParamByName('N22').Value := 3;
          Parameters.ParamByName('N23').Value := nNowLprRecog1;
          Parameters.ParamByName('N24').Value := nNowLprRecog2;

          if bMiProc then
            Parameters.ParamByName('N25').Value := '미인식처리'
          else if bManualOut then
            Parameters.ParamByName('N25').Value := '수동출차'
          else
            Parameters.ParamByName('N25').Value := '';
          ExecSQL;
        end;
      end;
    end;

    // 차단기 열림. db처리 다하고 열자..
    OutOpen(nowLpr);
    logStr := logStr + #13#10 + ('MoneyProc : 출차 차단기 개방');

    if (bZeroOut = True) and (nUseFeeItem = 0) then begin
      logStr := logStr + #13#10 + ('MoneyProc : 일반차량 0원 출차');
      {$REGION'일반차량 0원출차'}
      if bFixedUse then
      begin
        NGridData('2' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
            '^고정할인차량')  ;
      end
      else
      begin
        if nDCCnt > 0 then
        begin
          NGridData('2' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
              '^사전할인차량')  ; 
          ExceptLogging('TfrmMain.NormalOut: 리스트내용표출 => 사전할인차량' );
        end
        else
        begin
//          NGridData('2' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
//              '^회차차량')  ;
//          ExceptLogging('TfrmMain.NormalOut: 리스트내용표출 => 회차차량' );
        end;
      end;
      {$ENDREGION}
    end else if (bZeroOut = True) and (nUseFeeItem > 0) then begin
      logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 0원 출차');
      {$REGION '정기차량 요금부과 0원출차'}
      if bFixedUse then
      begin
        NGridData('3' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
            '^고정할인차량')  ;
      end
      else
      begin
        if nDCCnt > 0 then
        begin
          NGridData('3' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
              '^사전할인차량')  ;
          ExceptLogging('TfrmMain.NormalOut: 리스트내용표출 => 사전할인차량' );
        end
        else
        begin
          NGridData('3' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
              '^회차차량')  ;
          ExceptLogging('TfrmMain.NormalOut: 리스트내용표출 => 회차차량' );
        end;
      end;
      {$ENDREGION}
    end else if (bZeroOut = False) and (nUseFeeItem = 0) then begin
      logStr := logStr + #13#10 + ('MoneyProc : 일반차량 요금 출차 : ['+edtProcYogum.Text+']원');
      {$REGION '일반차량 요금출차'}
      NGridData('2' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
          '^' + edtProcYogum.Text + '원');
      {$ENDREGION}
    end else if (bZeroOut = False) and (nUseFeeItem > 0) then begin
      logStr := logStr + #13#10 + ('MoneyProc : 정기차량 요금부과 요금 출차 : ['+edtProcYogum.Text+']원');
      {$REGION '정기차량 요금출차'}
      NGridData('3' + sNowInCarNo + '^' + sNowOutDate + ' ' + sNowOutTime +
          '^' + edtProcYogum.Text + '원');
      {$ENDREGION}
    end;
    // MichulProc(sNowInCarNo);

    logStr := logStr + #13#10 + ('MoneyProc : 영수증 확인');
    //if (bZeroReceipt and (StrToInt(MG_StrTrim(edtTotYogum.Text, ',')) > 0)) or
    if bZeroReceipt or
      (StrToInt(MG_StrTrim(edtProcYogum.Text, ',')) > 0) then
    begin
      logStr := logStr + #13#10 + ('MoneyProc : 요금대상이거나 0원시에도 영수증 나옴.');
      if ComPrn.Open and (StrToInt(MG_StrTrim(edtProcYogum.Text, ',')) > 0) then begin
        logStr := logStr + #13#10 + ('MoneyProc : 돈통 개방');
        ComPrn.PutString(WTP_Cash_Open);
      end;

      logStr := logStr + #13#10 + ('MoneyProc : 주차장정보 획득시작');
      with dmTables.qryMoneyProc do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from ParkInfo where ParkNo = :N1');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Open;

        if RecordCount > 0 then
        begin
          sParkName := FieldByName('ParkName').AsString;
          sParkAddr := FieldByName('ParkAddr').AsString;
          sRegNo := FieldByName('RegNo').AsString;
          sAdmin := FieldByName('Admin').AsString;
          sTelephone := FieldByName('Telephone').AsString;
          sReceipt := FieldByName('Receipt').AsString;

          logStr := logStr + #13#10 + ('MoneyProc : 주차장정보 ['+sParkName+'] ['+sParkAddr+'] ['+sRegNo+'] ['+sAdmin+'] ['+sTelephone+'] ['+sReceipt+']');
        end else begin
          logStr := logStr + #13#10 + ('MoneyProc : 등록된 주차장정보 없음 : 주차장정보 ['+sParkName+'] ['+sParkAddr+'] ['+sRegNo+'] ['+sAdmin+'] ['+sTelephone+'] ['+sReceipt+']');
        end;
      end;
      logStr := logStr + #13#10 + ('MoneyProc : 주차장정보 획득종료');

      logStr := logStr + #13#10 + ('MoneyProc : 영수증 문구 조합 시작');
      if ((nCashType = 0) and (nPayType = 1)) or (not nCreditlinkage) then
      begin
        logStr := logStr + #13#10 + ('MoneyProc : 영수증 출력 시작 ! 신용카드 아닌경우.');
        // 영수증인쇄...
        sPrtData := '' + SI_WTP;
        sPrtData :=
          '========================================' + LF + LF + LF + CR + SO_WTP;
        sPrtData := sPrtData + '    영   수   증' + LF + LF + LF + CR + SI_WTP;

        if Length(sParkName) > 29 then
        begin
          sPrtData := sPrtData + '주차장명 : ' + Copy(sParkName, 1, 29) + LF + CR;

          if Length(sParkName) < 58 then
            sPrtData := sPrtData + '           ' + Copy
              (sParkName, 30, Length(sParkName) - 29) + LF + CR
          else
          begin
            if Length(sParkName) < 87 then
            begin
              sPrtData := sPrtData + '           ' + Copy(sParkName, 30, 29)
                + LF + CR;
              sPrtData := sPrtData + '           ' + Copy
                (sParkName, 60, Length(sParkName) - 58) + LF + CR;
            end
            else
            begin
              sPrtData := sPrtData + '           ' + Copy(sParkName, 30, 29)
                + LF + CR;
              sPrtData := sPrtData + '           ' + Copy(sParkName, 59, 29)
                + LF + CR;
              sPrtData := sPrtData + '           ' + Copy
                (sParkName, 88, Length(sParkName) - 87) + LF + CR;
            end;
          end;
        end
        else
          sPrtData := sPrtData + '주차장명 : ' + sParkName + LF + CR;

        if Length(sParkAddr) > 29 then
        begin
          sPrtData := sPrtData + ' 주   소 : ' + Copy(sParkAddr, 1, 29) + LF + CR;

          if Length(sParkAddr) < 58 then
            sPrtData := sPrtData + '           ' + Copy
              (sParkAddr, 30, Length(sParkAddr) - 29) + LF + CR
          else
          begin
            if Length(sParkAddr) < 87 then
            begin
              sPrtData := sPrtData + '           ' + Copy(sParkAddr, 30, 29)
                + LF + CR;
              sPrtData := sPrtData + '           ' + Copy
                (sParkAddr, 60, Length(sParkAddr) - 58) + LF + CR;
            end
            else
            begin
              sPrtData := sPrtData + '           ' + Copy(sParkAddr, 30, 29)
                + LF + CR;
              sPrtData := sPrtData + '           ' + Copy(sParkAddr, 59, 29)
                + LF + CR;
              sPrtData := sPrtData + '           ' + Copy
                (sParkAddr, 88, Length(sParkAddr) - 87) + LF + CR;
            end;
          end;
        end
        else
          sPrtData := sPrtData + ' 주   소 : ' + sParkAddr + LF + CR;

        sPrtData := sPrtData + '등록번호 : ' + sRegNo + LF + CR;

        if Length(sAdmin) > 29 then
        begin
          sPrtData := sPrtData + '대표자명 : ' + Copy(sAdmin, 1, 29) + LF + CR;
          sPrtData := sPrtData + '           ' + Copy
            (sAdmin, 30, Length(sAdmin) - 29) + LF + CR;
        end
        else
          sPrtData := sPrtData + '대표자명 : ' + sAdmin + LF + CR;

        sPrtData := sPrtData + '전화번호 : ' + sTelephone + LF + CR;
        sPrtData := sPrtData + '입차일시 : ' + sNowInDate + ' ' + sNowInTime + LF +
          CR;
        sPrtData := sPrtData + '출차일시 : ' + sNowOutDate + ' ' + sNowOutTime + LF +
          CR;
        sPrtData := sPrtData + '주차시간 : ' + lbParkingTime.Caption + LF + CR;
        sPrtData := sPrtData + '근 무 자 : ' + sCurrMName + LF + CR;
        sPrtData := sPrtData + '차량번호 : ' + sNowLprCarNo1 + LF + CR;

        //if edtDCYogum.Text <> '0' then
        if nDCCnt > 0 then
        begin
          sPrtData := sPrtData + '전체요금 : ' + edtTotYogum.Text + '원' + LF + CR;
          sPrtData := sPrtData + '할인금액 : ' + edtDCYogum.Text + '원' + LF + CR;

          InspectionLog('할인 횟수 : ' + IntToStr(nDCCnt));

          if nDCCnt > 0 then
            for i := 1 to nDCCnt do
              //if DCProc[i].nDCAmt > 0 then
              if DCProc[i].sDCName <> '' then
              begin
                if i = 1 then
                  sPrtData:= sPrtData + '할인내용 : ' + DCProc[i].sDCName + LF + CR
                else
                  sPrtData := sPrtData +'          ' + DCProc[i].sDCName + LF + CR;
              end;
          {
          if Length(aString(edtDC.Text)) > 29 then
          begin
            sPrtData := sPrtData + '할인내용 : ' + Copy(aString(edtDC.Text), 1, 29)
              + LF + CR;
            sPrtData := sPrtData + '           ' + Copy
              (aString(edtDC.Text), 30, Length(aString(edtDC.Text)) - 29)
              + LF + CR;
          end
          else
            sPrtData := sPrtData + '할인내용 : ' + edtDC.Text + LF + CR;
          }
          //21.03.12 수정 OCS 할인 연동, 웹할인 중복 할인명
          {if RWebDCData[2].nWebDCNo > 0 then
          begin
            if sDCInTime2 <> '' then
            begin
               sPrtData := sPrtData + '           ' + DCProc[2].sDCName + LF + CR;
            end;
          end;}

          sPrtData := sPrtData + '받은금액 : ' + edtProcYogum.Text + '원' + LF + LF +
            LF + CR;
        end
        else
          sPrtData := sPrtData + '주차요금 : ' + edtProcYogum.Text + '원' + LF + LF +
            LF + CR;

        if Length(sReceipt) > 40 then
        begin
          sPrtData := sPrtData + Copy(sReceipt, 1, 40) + LF + CR;

          if Length(sReceipt) < 80 then
            sPrtData := sPrtData + Copy(sReceipt, 41, Length(sReceipt) - 40)
              + LF + LF + LF + LF + LF + LF + LF + LF
          else
          begin
            sPrtData := sPrtData + Copy(sReceipt, 41, 40) + LF + CR;
            sPrtData := sPrtData + Copy(sReceipt, 81, Length(sReceipt) - 80)
              + LF + LF + LF + LF + LF + LF + LF + LF;
          end;
        end
        else
          sPrtData := sPrtData + sReceipt + LF + LF + LF + LF + LF + LF + LF + LF;

        sPrtData := sPrtData + FullCut_WTP;

        if lbReceipt.Count = 10 then
          lbReceipt.Items.Delete(lbReceipt.Count - 1);
        lbReceipt.Items.Insert(0, sPrtOutTime + '  ' + MG_Left(sNowLprCarNo1, 12)
            + '  주차요금: ' + edtProcYogum.Text + '원');

        if RReceipt[9].sInOutTime <> '' then
        begin
          RReceipt[10].sInOutTime := RReceipt[9].sInOutTime;
          RReceipt[10].sRpt := RReceipt[9].sRpt;
        end;

        if RReceipt[8].sInOutTime <> '' then
        begin
          RReceipt[9].sInOutTime := RReceipt[8].sInOutTime;
          RReceipt[9].sRpt := RReceipt[8].sRpt;
        end;

        if RReceipt[7].sInOutTime <> '' then
        begin
          RReceipt[8].sInOutTime := RReceipt[7].sInOutTime;
          RReceipt[8].sRpt := RReceipt[7].sRpt;
        end;

        if RReceipt[6].sInOutTime <> '' then
        begin
          RReceipt[7].sInOutTime := RReceipt[6].sInOutTime;
          RReceipt[7].sRpt := RReceipt[6].sRpt;
        end;

        if RReceipt[5].sInOutTime <> '' then
        begin
          RReceipt[6].sInOutTime := RReceipt[5].sInOutTime;
          RReceipt[6].sRpt := RReceipt[5].sRpt;
        end;

        if RReceipt[4].sInOutTime <> '' then
        begin
          RReceipt[5].sInOutTime := RReceipt[4].sInOutTime;
          RReceipt[5].sRpt := RReceipt[4].sRpt;
        end;

        if RReceipt[3].sInOutTime <> '' then
        begin
          RReceipt[4].sInOutTime := RReceipt[3].sInOutTime;
          RReceipt[4].sRpt := RReceipt[3].sRpt;
        end;

        if RReceipt[2].sInOutTime <> '' then
        begin
          RReceipt[3].sInOutTime := RReceipt[2].sInOutTime;
          RReceipt[3].sRpt := RReceipt[2].sRpt;
        end;

        if RReceipt[1].sInOutTime <> '' then
        begin
          RReceipt[2].sInOutTime := RReceipt[1].sInOutTime;
          RReceipt[2].sRpt := RReceipt[1].sRpt;
        end;

        RReceipt[1].sInOutTime := sPrtOutTime + '  주차요금: ' + edtProcYogum.Text +
          '원';
        RReceipt[1].sRpt := sPrtData;
        btnReceipt.Enabled := True;
        logStr := logStr + #13#10 + ('MoneyProc : 영수증 출력 종료 ! 신용카드 아닌경우');
      end;
    end
    else
    begin
      logStr := logStr + #13#10 + ('MoneyProc : 영수증 출력 안함. 현금영수증이거나 신용카드결제');
      sPrtData := '';
      btnReceipt.Enabled := False;
    end;

    InspectionLog('영수증: ' + sPrtData);

    if bAutoReceipt and (sPrtData <> '') then
    begin
      logStr := logStr + #13#10 + ('MoneyProc : 영수증 자동출력');
      btnReceiptClick(Self);
    end;
    logStr := logStr + #13#10 + ('MoneyProc : 정산요금: ' + edtProcYogum.Text);
    InspectionLog('정산요금: ' + edtProcYogum.Text);
    logStr := logStr + #13#10 + ('MoneyProc : 요금정산 완료');
    ClearFormData(1);

    //대전성모병원 차량번호 업데이트부분
    if bNationalUse and bOCSUse then begin
      //국가유공자 등록
      logStr := logStr + #13#10 + ('차량번호 ['+sNowInCarNo+'] OCS내 국가유공자 등록 시작');
      with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Add('UPDATE OPENQUERY('+sLinkedDBName+', ''SELECT * From '+sOCSDBName+'.PMCMPKBS Where CARNO = '''''+sNowInCarNo+''''''') ');
        SQL.Add('Set NATIONTOYN = ''Y'' ');
//        logStr := logStr + #13#10 + ('SQL : ' + SQL.Text);
        ExecSQL;
      end;
      logStr := logStr + #13#10 + ('차량번호 ['+sNowInCarNo+'] OCS내 국가유공자 등록 종료');
    end;

    if bHandicapUse and bOCSUse then begin
      //장애인 등록
      logStr := logStr + #13#10 + ('차량번호 ['+sNowInCarNo+'] OCS내 장애인  등록 시작');
      with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Add('UPDATE OPENQUERY('+sLinkedDBName+', ''SELECT * From '+sOCSDBName+'.PMCMPKBS Where CARNO = '''''+sNowInCarNo+''''''') ');
        SQL.Add('Set HANDICAPRYN = ''Y'' ');
//        logStr := logStr + #13#10 + ('SQL : ' + SQL.Text);
        ExecSQL;
      end;
      logStr := logStr + #13#10 + ('차량번호 ['+sNowInCarNo+'] OCS내 장애인  등록 종료');
    end;
    ExceptLogging(logStr);
  except
    on E: Exception do
      ExceptLogging('MoneyProc: ' + aString(E.Message));
  end;
end;

// nIO: 1-입구, 2-출구    nType: 1-정기차량, 2-일반차량, 3-요금표시, 4-주차요금0원
procedure TfrmMainNew.DspProc(nIO, nType: Byte; sData, sDspIP: aString);
var
  i: Byte;
  sSend: aString;
begin
  try
    case nType of
      1:
        sSend := MakeDSPData(AnsiChar($54), EMDSP1, SCCOLOR, MG_Left(sData, 24));
      2:
        sSend := MakeDSPData(AnsiChar($54), EMDSP1, NOCOLOR, MG_Left(sData, 24));
      3:
        sSend := MakeDSPData(AnsiChar($54), EMDSP0, YOCOLOR, MG_Left(sData, 24));
      4:
        sSend := MakeDSPData(AnsiChar($54), EMDSP1, YOCOLOR, MG_Left(sData, 24));
    end;

    if nIO = 1 then
    begin
      for i := 1 to 5 do
      begin
        with frmMainNew do
        begin
          if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then
          begin
            if is_ping(sDspIP) then
            begin
              if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active then begin
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend);
                ExceptLogging('전광판(' + sDspIP + ') : ' + sData);
              end else begin
                ExceptLogging('전광판(' + sDspIP + ') 전송시 에러 : 연결안됨. ');
              end;
            end
            else
              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
          end;
        end;
      end;
    end
    else if nIO = 2 then
    begin
      for i := 1 to 3 do
      begin
        with frmMainNew do
        begin
          if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host = wString(sDspIP) then
          begin
            if is_ping(sDspIP) then
            begin
              if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then begin
                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
                ExceptLogging('전광판(' + sDspIP + ') : ' + sData);
              end else begin
                ExceptLogging('전광판(' + sDspIP + ') 전송시 에러 : 연결안됨. ');
              end;
              Break;
            end
            else
            begin
              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
              Break;
            end;
          end;
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('DspProc: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.ManualOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte);
var
  sNow, sInCarNo, sInTKNo, sInDate, sInTime, sParking, sInFile, sImgFile1,
    sImgFile2, sLocalFile, sTime, sDir, sYogum: aString;
  nDay, nHour, nMin, nSec, nOutCnt: Cardinal;
  nInUnitNo, i: Word;
  hr: HRESULT;
  sDspIP: aString;
  asYogum : Integer;
begin
  try
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = nowLpr.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        Break;
      end;
    end;
  except
    on E: Exception do
    begin
      ShowMessage('LPR 설정을 확인하여 주세요!');
      Exit;
    end;
  end;
  bUseMiddle := False;
  // 일반차량 출차처리...
  try
    with dmTables.qryManualOut do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from Gracetime where ParkNo = :N1');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
        with GTime do
        begin
          GT1 := FieldByName('GT1').AsString;
          GT2 := FieldByName('GT2').AsString;
          GT3 := FieldByName('GT3').AsString;
          GT4 := FieldByName('GT4').AsString;
          GT5 := FieldByName('GT5').AsString;
          GT6 := FieldByName('GT6').AsString;
          GT7 := FieldByName('GT7').AsString;
          GT8 := FieldByName('GT8').AsString;
          GT9 := FieldByName('GT9').AsInteger;
//          GT10 := FieldByName('GT10').AsString;
//          GT11 := FieldByName('GT11').AsString;
        end
        else
          ClearGTime;
    end;

    // 화면표시
    lbCarNo.Caption := sLprCarNo1;
    lbOutCarNo.Caption := sLprCarNo1;
    lbInTime.Caption := sManualInTime;
    sNow := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);
    //sNow := FormatDateTime('YYYY-MM-DD HH:NN', Now)+':00';
    lbOutTime.Caption := sNow;
    sParking := '';
    nParkingMin := 0;
    bRound := false;
    //nParkingMin := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 16), 0, 1, 0, 0) + ':01') - StrToDateTime(lbInTime.Caption)) * 24 * 60);
    //nParkingMin := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 16), 0, 0, 0, 0)) - StrToDateTime(Copy(lbInTime.Caption,1,16))) * 24 * 60);
    nParkingMin := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 19), 0, 0, 0, 0)) - StrToDateTime(Copy(lbInTime.Caption,1,19))) * 24 * 60);
    nSec := Trunc((StrToDateTime(MG_AddTime(Copy(sNow, 1, 19), 0, 0, 0, 0)) - StrToDateTime(Copy(lbInTime.Caption,1,19))) * 24 * 60 * 60);

    nDay := nParkingMin div (24 * 60);
    nHour := (nParkingMin mod (24 * 60)) div 60;
    nMin := (nParkingMin mod (24 * 60)) mod 60;
    nSec := nSec mod 60;

    if nDay > 0 then
      sParking := sParking + IntToStr(nDay) + '일 ';
    if nHour > 0 then
      sParking := sParking + IntToStr(nHour) + '시간 ';
    if nMin > 0 then
      sParking := sParking + IntToStr(nMin) + '분';
//    if nSec > 0 then
//      sParking := sParking + IntToStr(nSec) + '초';
    nSecEx := nSec;
    lbParkingTime.Caption := sParking;

    nDayEx := nDay;
    nHourEx := nHour;
    nMinEx := nMin;
    nSecEx := nSec;

    if nDay = 0 then
    begin
      if nHour = 0 then
      begin
        if nMinEx <= 29 then
        begin
           bRound := True;
        end;
      end;
    end;

    if bFreeTime then
    begin
      if bFreeTimeChk then
      begin
        // 시작시각이 크다.
        if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) or
          (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
        begin
          FreeTimeProc(nowLpr);
          // MichulProc(sInCarNo);
          bNCOutProcWait := False;
          Exit;
        end;
      end
      else
      begin
        if (sFreeTimeS <= FormatDateTime('HH:NN', Now)) and
          (sFreeTimeE >= FormatDateTime('HH:NN', Now)) then
        begin
          FreeTimeProc(nowLpr);
          // MichulProc(sInCarNo);
          bNCOutProcWait := False;
          Exit;
        end;
      end;
    end;

    {
    if (bFreeTime and
       (FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(Copy(lbInTime.Caption, 1, 11) + sFreeTimeE)
        + StrToTime(GTime.GT1)) > Copy(sNow, 1, 16)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16))) or
       ((not bFreeTime) and
       (FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 16)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16))) then
    }

    //if (FormatDateTime('YYYY-MM-DD HH:NN', StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 16)) or
//    if GracetimeCheck(Copy(lbInTime.Caption, 1, 16), Copy(sNow, 1, 16)) or
//       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) then
//    begin
//    if
//           ((FormatDateTime('YYYY-MM-DD HH:NN',
//        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT10)) > Copy(sNow, 1, 16))
//        and (Not bApsPay))                   then
//    begin
//
//    end
//    else
//    showmessage((FormatDateTime('YYYY-MM-DD HH:NN',
//        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1))));
    if
        //일요일 또는 휴일
       (((chkHoliday(Copy(sNow, 1, 10))) or ((DayOfWeek(Now) = 1))) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT8)) >= Copy(sNow, 1, 16)) or
         StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT8)) > Copy(sNow, 1, 16)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) and (not bApsPay)) or

       //토요일
       ((not chkHoliday(Copy(sNow, 1, 10))) and ((DayOfWeek(Now) = 7)) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT5)) >= Copy(sNow, 1, 16)) or
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT5)) > Copy(sNow, 1, 16)) or
       (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16))  and (not bApsPay)) or

       //평일
       (((not chkHoliday(Copy(sNow, 1, 10))) and ((DayOfWeek(Now) >= 2) and (DayOfWeek(Now) <= 6))) and
       (FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) >= Copy(sNow, 1, 16)) or
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT1)) > Copy(sNow, 1, 16)) or
        (Copy(lbInTime.Caption, 1, 16) = Copy(sNow, 1, 16)) and (not bApsPay)) or

       //사전무인정산
       ((FormatDateTime('YYYY-MM-DD HH:NN',
        //StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT2)) >= Copy(sNow, 1, 16))
        StrToDateTime(Copy(lbInTime.Caption, 1, 16)) + StrToTime(GTime.GT2)) > Copy(sNow, 1, 16))
        and bApsPay)  or
        //29분이하 강제 회차 처리
        (bRound)                 then
    begin
      //회차차량
      // DB Write...
      with dmTables.qryManualOut do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from TKProc where ParkNo = :N1 and UnitNo = :N2 and ');
        SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
        Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
        Parameters.ParamByName('N5').Value := sManualTKNo;
        Open;

        if RecordCount <= 0 then
        begin
          Close;
          SQL.Clear;
          SQL.Add('Insert Into TKProc ');
          SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKType, CarType, FeeNo, ');
          SQL.Add('TKNo, TKParkNo, TKUnitNo, CarNo, InDate, InTime, ParkingMin, ');
          SQL.Add('TotFee, TotDC, RealFee, RecvAmt, Change, DCCnt, MNo, UnPaid, ');
          SQL.Add('ChkClosing, CommercialTariff, SpecialTariff, PayType, Reserve2) ');
          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, ');
          SQL.Add(':N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
          SQL.Add(':N21, :N22, :N23, :N24, :N25, :N26, :N27)');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nCurrUnitNo;
          Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
          Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
          Parameters.ParamByName('N5').Value := nTKType;
          Parameters.ParamByName('N6').Value := nCarType;
          Parameters.ParamByName('N7').Value := nFeeNo;
          Parameters.ParamByName('N8').Value := sManualTKNo;
          Parameters.ParamByName('N9').Value := nCurrParkNo;
          Parameters.ParamByName('N10').Value := nCurrUnitNo;
          Parameters.ParamByName('N11').Value := sLprCarNo1;
          Parameters.ParamByName('N12').Value := Copy(sManualInTime, 1, 10);
          Parameters.ParamByName('N13').Value := Copy(sManualInTime, 12, 8);
          Parameters.ParamByName('N14').Value := nParkingMin;
          Parameters.ParamByName('N15').Value := 0;
          Parameters.ParamByName('N16').Value := 0;
          Parameters.ParamByName('N17').Value := 0;
          Parameters.ParamByName('N18').Value := 0;
          Parameters.ParamByName('N19').Value := 0;
          Parameters.ParamByName('N20').Value := 0;
          Parameters.ParamByName('N21').Value := nCurrMNo;
          Parameters.ParamByName('N22').Value := 0;
          Parameters.ParamByName('N23').Value := 0;
          Parameters.ParamByName('N24').Value := 0;
          Parameters.ParamByName('N25').Value := 0;
          Parameters.ParamByName('N26').Value := 1;
          Parameters.ParamByName('N27').Value := '회차';
          ExecSQL;
        end;

        Close;
        SQL.Clear;
        SQL.Add('Insert Into IONData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, ');
        SQL.Add('InImage1, InCarNo1, InImage2, InCarNo2, Status, OutUnitNo, ');
        SQL.Add('OutDate, OutTime, OutChk, OutImage1, OutCarNo1, OutImage2, OutCarNo2, ');
        SQL.Add('InRecog1, OutRecog1, InRecog2, OutRecog2) ');
        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
        SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, ');
        SQL.Add(':N21, :N22, :N23, :N24)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := Copy(sManualInTime, 1, 10);
        Parameters.ParamByName('N4').Value := Copy(sManualInTime, 12, 8);
        Parameters.ParamByName('N5').Value := sManualTKNo;
        Parameters.ParamByName('N6').Value := nTKType;
        Parameters.ParamByName('N7').Value := nCarType;
        Parameters.ParamByName('N8').Value := '';
        Parameters.ParamByName('N9').Value := '';
        Parameters.ParamByName('N10').Value := '';
        Parameters.ParamByName('N11').Value := '';
        Parameters.ParamByName('N12').Value := 1;
        Parameters.ParamByName('N13').Value := nLprNo;
        Parameters.ParamByName('N14').Value := Copy(sNow, 1, 10);
        Parameters.ParamByName('N15').Value := Copy(sNow, 12, 8);
        Parameters.ParamByName('N16').Value := 4;
        Parameters.ParamByName('N17').Value := sLprFile1;
        Parameters.ParamByName('N18').Value := sLprCarNo1;
        Parameters.ParamByName('N19').Value := sLprFile2;
        Parameters.ParamByName('N20').Value := sLprCarNo2;
        Parameters.ParamByName('N21').Value := 3;
        Parameters.ParamByName('N22').Value := nLprRecog1;
        Parameters.ParamByName('N23').Value := 3;
        Parameters.ParamByName('N24').Value := nLprRecog2;
        ExecSQL;
      end;
      DspProc(2, 1, '회차허용차량' + MG_Left(sLprCarNo1, 12), sDspIP);
      OutOpen(nowLpr);
//      NGridData('2' + sInCarNo + '^' + Copy(sNow, 1, 10) + ' ' + Copy
//          (sNow, 12, 8) + '^회차차량');

      NGridData('2' + sLprCarNo1 + '^' + Copy(sNow, 1, 10) + ' ' + Copy
          (sNow, 12, 8) + '^회차차량');
      sPrtData := '';
      ClearFormData;
    end
    else
    begin
      sNowLprFile1 := sLprFile1;
      sNowLprCarNo1 := sLprCarNo1;
      sNowLprFile2 := sLprFile2;
      sNowLprCarNo2 := sLprCarNo2;
      sNowIOTime := sIOTime;
      nNowLprNo := nLprNo;
      nNowLprInOut := nLprInOut;
      nNowLprRecog1 := nLprRecog1;
      nNowLprRecog2 := nLprRecog2;
      sNowInTKNo := sManualTKNo;
      nNowInUnitNo := nCurrUnitNo;
      sNowInDate := Copy(sManualInTime, 1, 10);
      sNowInTime := Copy(sManualInTime, 12, 8);
      sNowInCarNo := sLprCarNo1;
      sNowOutDate := Copy(sNow, 1, 10);
      sNowOutTime := Copy(sNow, 12, 8);

      //주차요금 계산전에 기존 할인자료 등 클리어한다.
      for i := 1 to 50 do
        RDCCnt[i].nDCNowCnt := 0;

      ClearGTime;
      ClearDCProc;

      bIsPatientUse := 0;
      //sDCInTime := lbInTime.Caption;
      //OCSDCProc_CAR_Ex(sNowInTKNo);//테스트용

      if bFreeTime then
      begin
        if sFreeTimeE > Copy(sNowInTime, 1, 5) then
          nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                    nFeeNo,
                                    sNowInDate + ' ' + sFreeTimeE,
                                    Copy(sNow, 1, 16))
//          nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + sFreeTimeE),
//                               PAnsiChar(Copy(sNow, 1, 16)))
        else
          nTotYogum := DJSM_FeeCalc(nCurrParkNo,
                                    nFeeNo,
                                    sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
                                    Copy(sNow, 1, 16));
//          nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
//                               PAnsiChar(Copy(sNow, 1, 16)));
      end
      else
        nTotYogum := DJSM_FeeCalcEx(nCurrParkNo,
                                  nFeeNo,
                                  sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
                                  Copy(sNow, 1, 16), 1);

//         nTotYogum := DJSM_FeeCalc(nCurrParkNo,
//                                  nFeeNo,
//                                  sNowInDate + ' ' + Copy(sNowInTime, 1, 5),
//                                  Copy(sNow, 1, 16));
//        nTotYogum := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(sNowInDate + ' ' + Copy(sNowInTime, 1, 5)),
//                            - PAnsiChar(Copy(sNow, 1, 16)));

      nProcYogum := nTotYogum;
      edtTotYogum.Text := IntToStr(nTotYogum);
      edtTotYogum.AutoThousandSeparator := True;
      edtProcYogum.Text := FormatFloat('#,##0', nTotYogum);
      //edtProcYogum.AutoThousandSeparator := True;
      sYogum := IntToStr(nTotYogum);
      asYogum := Length(sYogum);



      for i := 1 to 6 do
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;

      //for i := 1 to Length(sYogum) do
      for i := 1 to asYogum do
      begin
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
        TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
          (sYogum, Length(sYogum) - (i - 1), 1);
      end;

      for i := 1 to nUseBtnCnt do
      begin
        TAdvShapeButton(FindComponent('btn' + IntToStr(i))).Enabled := True;
        TMenuItem(FindComponent('mnuDC' + IntToStr(i))).Enabled := True;
      end;

      //DCProcess(sNowInTKNo);//테스트용

      lbOutCarType.Caption := '일반차량';

      //if edtProcYogum.Text <> '0' then
      //  DspProc(2, 3, '주차요금    ' + MG_Right(edtProcYogum.Text + '원', 12), sDspIP)
      //else
      if edtProcYogum.Text = '0' then
        DspProc(2, 4, '회차허용차량' + MG_Left(sLprCarNo1, 12), sDspIP);

      btnProc.Enabled := True;

      if bCancel then
        btnCancel.Enabled := True;

      DCEnable(True);

      if bBarcodeDC then
      begin
        edtBarcode.Text := '';
        edtBarcode.SetFocus;
      end;
      sProcTime := sNow;
      sDCOutTime := sNow;
      sDCInTime := lbInTime.Caption;
      if bTest then
      begin
        nPayType := 1;
        MoneyProc(nowLpr);
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('ManualOut: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.MGDCDetail(sIssueDate, sDCType, sDCCode, sParkNo,
  sNumber: AnsiString);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa, nValue,nValue1, nTimeDC1,nTypeCode: Integer;
  sName, sYogum, sUpche, sCheckDate: aString;
  i, nChk, nDCType: Byte;
begin
  try
    with dmTables.qryDCTemp do begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= StrToInt(sDCCode);
      Open;

      if RecordCount > 0 then begin
        nDCType:= FieldByName('DCType').AsInteger;
        sName:= FieldByName('DCName').AsString;
        nValue:= FieldByName('DCValue').AsInteger;
        nValue1 := FieldByName('DCValue1').AsInteger;
        nTypeCode := FieldByName('DCTypeCode').AsInteger;
      end;
    end;

    InspectionLog('마그네틱할인: ' + sDCCode + ', ' +
                               IntToStr(nValue) + ', ' +
                               sName );

      if nProcYogum > 0 then begin
        Case nDCType of
          0:
            begin // 금액할인.
              nDCCnt := nDCCnt + 1;

              if nProcYogum >= nValue then begin
                nProcYogum := nProcYogum - nValue;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nValue;
                nDCYogum := nDCYogum + nJulsa;

                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo       := nDCNo;
                  sDCName     := sName;
                  nDCAmt      := nValue + nJulsa;
                  nRealDCAmt  := nValue + nJulsa;
                  nDCType     := 0;
                  nDCKind     := 4;
                  nTypeCode   := nTypeCode;
                end;
              end else begin
                nDCYogum := nDCYogum + nProcYogum;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nValue;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 0;
                  nDCKind     := 4;
                  nTypeCode   := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          1:    { TODO  : 웹할인 - 시간할인 }
            begin // 시간할인.
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              if sDCOutTime < lbintime.Caption then
              begin
                nTimeDC := nProcYogum;
                DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
                DCProc[nDCCnt].nRealDCMin := nValue;
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;

              if nProcYogum >= nTimeDC then begin
                nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCType     := 1;
                  nDCKind     := 4;
                  nTypeCode   := nTypeCode;
                end;
              end else begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 1;
                  nDCKind     := 4;
                  nTypeCode   := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          2:
            begin // 퍼센트할인.
              nDCCnt := nDCCnt + 1;
              nPerDC := (nProcYogum * nValue) div 100;

              if nProcYogum >= nPerDC then begin
                nProcYogum := nProcYogum - nPerDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nPerDC;
                nDCYogum := nDCYogum + nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                end;

                for i := 1 to Length(sYogum) do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption :=
                      Copy(sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nPerDC + nJulsa;
                  nRealDCAmt := nPerDC + nJulsa;
                  nDCType     := 2;
                  nDCKind     := 4;
                  nTypeCode   := nTypeCode;
                end;
              end else begin
                nDCYogum := nDCYogum + nPerDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do begin
                  with frmMainNew do begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nPerDC;
                  nRealDCAmt := nProcYogum;
                  nDCType     := 2;
                  nDCKind     := 4;
                  nTypeCode   := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          3:
            begin // 복합할인 = 시간할인 + % 할인
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              if sDCOutTime <lbintime.Caption then
              begin
                nTimeDC := nProcYogum;
              end
              else
              begin
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
//                nTimeDC := nProcYogum - FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                  PAnsiChar(Copy(sDCOutTime, 1, 16)));
              end;
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              nTimeDC := nTimeDC + ((nProcYogum - nTimeDC) * nValue1 div 100);

              if nProcYogum >= nTimeDC then
              begin
                nProcYogum := nProcYogum - nTimeDC;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nTimeDC;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := nDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC + nJulsa;
                  nRealDCAmt := nTimeDC + nJulsa;
                  nDCKind    := 4;
                  nDCType    := 3;
                  nTypeCode  := nTypeCode;
                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nTimeDC;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;

                for i := 6 downto 2 do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
                  end;
                end;
                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo := nDCNo;
                  sDCName := sName;
                  nDCAmt := nTimeDC;
                  nRealDCAmt := nProcYogum;
                  nDCKind    := 4;
                  nDCType    := 3;
                  nTypeCode  := nTypeCode;
                end;
                nProcYogum := 0;
                edtProcYogum.Text := '0';
              end;
            end;

          4:
            begin // 고객부담. (시간할인 부분 고정금액)
              nDCCnt := nDCCnt + 1;
              sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
              sDCInTime  := MG_AddTime(sDCInTime, 0, nValue, 0, 0);
              nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                    PAnsiChar(Copy(sDCInTime, 1, 16)));
//              nTimeDC := nProcYogum - ReturnFee(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                PAnsiChar(Copy(sDCOutTime, 1, 16)))  ;
              if nProcYogum >= nTimeDC then
              begin
                nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
                nProcYogum := nProcYogum - nTimeDC + nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                nDCYogum := nDCYogum + nJulsa;
                //edtProcYogum.Text := IntToStr(nProcYogum);
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                //edtProcYogum.AutoThousandSeparator := True;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to 6 do
                begin
                  with frmMainNew do
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := False;
                end;

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := nDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC -nValue1+ nJulsa;
                  nRealDCAmt := nDCYogum + nJulsa;
                  nDCKind    := 4;
                  nDCType    := 4;
                  nTypeCode  := nTypeCode;
                end;

//                with DCProc[nDCCnt] do
//                begin
//                  nDCNo      := RWebDCData[nCnt].nWebDCNo;
//                  sDCName    := sName;
//                  nDCAmt     := nTimeDC + nJulsa;
//                  nRealDCAmt := nTimeDC + nJulsa;
//                  nDCKind    := 2;
//                  nSeq       := RWebDCData[i].nSeq;
//                  sSeq       := RWebDCData[i].sSeq;
//                  nDCType    := 4;
//                  nTypeCode  := nTypeCode;
//                  sStoreName := RWebDCData[i].sStoreName;
//                  DCKey       := RWebDCData[nCnt].DCKey;
//                end;
              end
              else
              begin
                nDCYogum := nDCYogum + nProcYogum - nValue1;
                edtDCYogum.Text := IntToStr(nDCYogum);
                edtDCYogum.AutoThousandSeparator := True;
                nProcYogum := nValue1;
                nJulsa := JulsaProc(nProcYogum);
                nProcYogum := nProcYogum - nJulsa;
                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
                edtDCYogum.AutoThousandSeparator := True;
                sYogum := IntToStr(nProcYogum);

                for i := 1 to Length(sYogum) do
                begin
                  with frmMainNew do
                  begin
                    TLabel(FindComponent('lbYogum' + IntToStr(i)))
                      .Visible := True;
                    TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                      (sYogum, Length(sYogum) - (i - 1), 1);
                  end;
                end;

                lbYogum1.Caption := '0';
                lbDCName.Caption := sName;

                with DCProc[nDCCnt] do
                begin
                  nDCNo      := nDCNo;
                  sDCName    := sName;
                  nDCAmt     := nTimeDC -nValue1 ;
                  nRealDCAmt := nDCYogum;
                  nDCKind    := 4;
                  nDCType    := 4;
                  nTypeCode  := nTypeCode;
                end;
//                nProcYogum := 0 + nValue1;
//                edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);//'0';
              end;
            end;


        end;

        InspectionLog('마그네틱할인: ' + edtDCYogum.Text);
        lbDCName.Caption:= '마그네틱할인';
        edtMGReader.Text := '';
      end;
  except
    on E: Exception do ExceptLogging('TfrmMainNew.MGDCDetail: ' + aString(E.Message));
  end;
end;

function TfrmMainNew.DJSM_FeeCalc(nParkNo : Integer; nOrignFeeNo : Integer; sStartDateTime, sEndDateTime : AnsiString): Integer;
type
  FEE_ITEM_ROW = Record
    nFeeNo     : Integer;      //FeeItem.FeeNo
    sStartDT   : AnsiString;   //구간시작시간
    sEndDT     : AnsiString;   //구간종료시간
    bSDT_Exist : Boolean;      //입차일자시간대해당여부
    bEDT_Exist : Boolean;      //출차일자시간대해당여부
  end;
var
  I, nTmp, nFee : Integer;
  FeeItem : array of FEE_ITEM_ROW;

  //최초무료시간 저장변수
  sFreeTime, sInTimeTemp : AnsiString;
  nFreeTime : Integer;

  //시간 변환계산용 변수, Timestamp 형 변수를 담기 위해 Int64자료형 지정
  nSD_Unix, nED_Unix, nST_Unix, nET_Unix, nSD_Unix_tmp, nED_Unix_tmp, nST_Unix_tmp, nET_Unix_tmp : Int64;

  sStartDT, sEndDT : aString;
begin
  {$REGION '대전성모병원 요금계산'}
  try
    {$REGION '기본변수 할당'}
    //기존 계산함수 이용시 분단위로 계산하기 때문에 +-1분 정도 오차가 있어 오차범위를 줄이기위해 Timestamp(Unix)를 사용

    //날짜를 동일하게 맞추고(2000-01-01) 시간을 시작시간~종료시간으로 계산하여 시간간의 차이를 계산하기 위한 변수
    nST_Unix := DateTimeToUnix(StrToDateTime('2000-01-01 ' + Copy(sStartDateTime, 12, 8)));
    nET_Unix := DateTimeToUnix(StrToDateTime('2000-01-01 ' + Copy(sEndDateTime,   12, 8)));

    //시간을 정리하고 날짜를 다르게하여 일자 자쳬를 계산하기 위한 변수
    nSD_Unix := DateTimeToUnix(StrToDateTime(Copy(sStartDateTime, 1, 10) + ' 00:00:00'));
    nED_Unix := DateTimeToUnix(StrToDateTime(Copy(sEndDateTime,   1, 10) + ' 00:00:00'));
    {$ENDREGION}
  except
    on E: Exception do begin
      ExceptLogging('기본변수 할당 중 오류 발생');
    end;
  end;

  try
    with dmTables.qryFeeCalc do begin
      {$REGION '요금구간 획득'}
      //입차시간, 출차시간 시간계산 위해 변수에 담아둠.
      Close;
      SQL.Clear;

      //주차일수가 3일 이상 넘어갈시, 입차일자 / 출차일자를 제외한 그 사이일자는 상위FeeNo로 FeeCalc 한번만 호출
      //입/출차일자는 시작 종료시간 반영하여 해당하는 구간마다 별도로 각 하위 FeeNo로 FeeCalc 횟수만큼 반복 호출
                             //해구간 시작시간  //해구간 종료시간    //최초 무료시간
      SQL.Add('Select FeeNo, Reserve2 as StartDT, Reserve3 as EndDT , Reserve4 From FeeItem ');
      SQL.Add('Where 1=1 ');
      SQL.Add(  'AND Reserve1 = :isUsed ');  //상위 Tree형 FeeNo
      SQL.Add('Order by FeeNo ASC ');
      Parameters.ParamByName('isUsed').Value := nOrignFeeNo;//요금사용
      Open;

      if RecordCount > 0 then begin
        // memo : delphi dynamic array 는 무조건 index number가 0부터시작.
        SetLength(FeeItem, RecordCount);

        for I := 0 to Length(FeeItem) - 1 do begin
          if i = 0 then begin
            sFreeTime := FieldByName('Reserve4').AsString;    //최초 무료시간, HH:NN형식
            nFreeTime := MinuteOfTheDay(StrToTime(sFreeTime)); //최초무료시간을 분단위로 변경

            nST_Unix := nST_Unix + (nFreeTime * 60); //최초 무료시간만큼 입차시간을 조정

            if (nSD_Unix = nED_Unix) and (nST_Unix > nET_Unix) then begin //입차시간이 출차시간 초과할경우 요금발생
              nST_Unix := nET_Unix;
            end;
          end;

          //Tree형 요금구조에서 하위FeeNo정보 FeeItem 구조체 배열변수에 할당
          FeeItem[I].nFeeNo       := FieldByName('FeeNo').AsInteger;
          FeeItem[I].sStartDT     := FieldByName('StartDT').AsString;
          FeeItem[I].sEndDT       := FieldByName('EndDT').AsString;

          //입력받은 입출시간과 구간 시작종료시간 비교하기 위해 담아두는 임시변수
          nST_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FieldByName('StartDT').AsAnsiString));
          nET_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FieldByName('EndDT').AsAnsiString));
          //입차일자 시간대 포함여부
          //FeeItem[I].bSDT_Exist : 입차시간이 각 구역별로 포함되는지 여부를 확인하는 변수.
          //입차시간이 구간종료시간보다 작으면 해당구간에 포함되어있다.

          //Example
          //구간정보
          //00:00 ~ 06:59
          //07:00 ~ 17:59
          //18:00 ~ 23:59
          // 예시1 입차시간이 03시인경우, 1,2,3구간 종료시간보다 작다 : 1,2,3구간 전부포함
          // 예시2 입차시간이 09시인경우 1구간 종료시간보다 크고, 2,3구간 종료시간보다 작다 : 2,3구간 포함
          // 해당구분법으로 입차일자에서 입차구간 포함여부를 확인.
          if (nST_Unix - nET_Unix_tmp) <= 0 then  //입차시간 timestamp vs 구간종료시간 timestamp 비교
            FeeItem[I].bSDT_Exist := True         //현재 시작시간이 구간에로 해당하는지 => 추후 요금계산시 시간계산
          else
            FeeItem[I].bSDT_Exist := False;       //해당하지 않는지 => 추후 요금계산시 FeeCalc호출 안함

          //출차일자 시간대 포함여부, 입차와 같은방법으로 계산하되 시간이 반대임.
          if (nET_Unix - nST_Unix_tmp) >= 0 then
            FeeItem[I].bEDT_Exist := True
          else
            FeeItem[I].bEDT_Exist := False;

          Next;
        end;
      end else begin
        //등록된 하위 요금제가 없다. => 원 요금제로 구간 정보 없이 FeeCalc호출하고 Return
        ExceptLogging('요금제 등록안됨');

        Result := FeeCalc(nParkNo, nOrignFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                      PAnsiChar(Copy(lbOutTime.Caption, 1, 16)));
        Exit;
      end;
      {$ENDREGION}
    end;
  except
    on E: Exception do begin
      ExceptLogging('요금구간 획득 중 오류 발생 : ' + E.Message);
    end;
  end;

  try
    with dmTables.qryFeeCalc do begin
      {$REGION '주차요금 산출'}
      //획득된 구간 시간정보, 해당정보로 요금계산 하는 Region..


      // 일최대요금 발생 케이스 3가지
      // 1. 1일 이내 주차 (당일 입출차)
      // 2. 2일 이내 주차 (입차 다음날 출차)
      // 3. 3일 이상 주차 (입차후 n일 이상 주차 후 출차)
      //  * 자정 기준 일자 구분 *

      //시간을 00시로 고정해서 시간 관계 없이 날짜 자체만 비교하도록
      nTmp := nSD_Unix - nED_Unix;  //시간을 00:00:00로 고정했기때문에 무조건 86400 * n으로 값이 리턴됨.
                                                                           //(24H * 60M * 60S) 24시간 초 반환 = 86400
      nFee := 0; //결과요금 변수 초기화
      if nTmp < 0 then nTmp := nTmp * -1; //입출차 시간 역전되는 것 대비해서 음수로 변환

      if nTmp = 0 then begin
        //1. 1일 이내 주차 (당일 입출차)
        // 입차 일자 시간대 해당여부와 출차일자 시간대 해당여부가 전부 OK인 시간대만 요금 계산한다.
        for I := 0 to Length(FeeItem) - 1 do begin
          if FeeItem[I].bSDT_Exist and FeeItem[I].bEDT_Exist then begin
            nST_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sStartDT));
            nET_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sEndDT));

            //구간시작시간과 입차시간 비교
            if nST_Unix_tmp < nST_Unix then begin
              nSD_Unix_tmp := nST_Unix;
            end else begin
              nSD_Unix_tmp := nST_Unix_tmp;
            end;

            if nET_Unix_tmp > nET_Unix then begin
              nED_Unix_tmp := nET_Unix;
            end else begin
              nED_Unix_tmp := nET_Unix_tmp;
            end;

            //시간만 들어있는 timestamp를 시간데이터로 재변환해서 요금계산한다.
            sStartDT := Copy(sStartDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nSD_Unix_tmp));
            sEndDT   := Copy(sEndDateTime,   1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nED_Unix_tmp));
            nFee := nFee + FeeCalc(nParkNo,
                                   FeeItem[I].nFeeNo,
                                   PAnsiChar(Copy(aString(sStartDT), 1, 16)),
                                   PAnsiChar(Copy(aString(sEndDT), 1, 16)));
//            ShowMessage('nFee : ' + IntToStr(nFee));
          end;
        end;
      end else if nTmp = 86400 then begin
        //2. 2일 이내 주차 (입차 다음날 출차)
        //입차일자 요금계산
        for I := 0 to Length(FeeItem) - 1 do begin
          if FeeItem[I].bSDT_Exist then begin
            nST_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sStartDT));
            nET_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sEndDT));

            //구간시작시간과 입차시간 비교
            if nST_Unix_tmp < nST_Unix then begin
              nSD_Unix_tmp := nST_Unix;
            end else begin
              nSD_Unix_tmp := nST_Unix_tmp;
            end;

            //출차시간은 구간종료시간으로.
            nED_Unix_tmp := nET_Unix_tmp;

            //시간만 들어있는 timestamp를 시간데이터로 재변환해서 요금계산한다.
            sStartDT := Copy(sStartDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nSD_Unix_tmp));
            sEndDT   := Copy(sStartDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nED_Unix_tmp));
            nFee := nFee + FeeCalc(nParkNo,
                                   FeeItem[I].nFeeNo,
                                   PAnsiChar(Copy(aString(sStartDT), 1, 16)),
                                   PAnsiChar(Copy(aString(sEndDT), 1, 16)));
          end;
        end;

        //출차일자 요금게산
        for I := 0 to Length(FeeItem) - 1 do begin
          if FeeItem[I].bEDT_Exist then begin
            nST_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sStartDT));
            nET_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sEndDT));

            nSD_Unix_tmp := nST_Unix_tmp;

            if nET_Unix_tmp > nET_Unix then begin
              nED_Unix_tmp := nET_Unix;
            end else begin
              nED_Unix_tmp := nET_Unix_tmp;
            end;

            //시간만 들어있는 timestamp를 시간데이터로 재변환해서 요금계산한다.
            sStartDT := Copy(sEndDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nSD_Unix_tmp));
            sEndDT   := Copy(sEndDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nED_Unix_tmp));
            nFee := nFee + FeeCalc(nParkNo,
                                   FeeItem[I].nFeeNo,
                                   PAnsiChar(Copy(aString(sStartDT), 1, 16)),
                                   PAnsiChar(Copy(aString(sEndDT), 1, 16)));
          end;
        end;
      end else if nTmp > 86400 then begin
        //3. 3일 이상 주차 (입차후 n일 이상 주차 후 출차)
        //입차일자 요금계산
        for I := 0 to Length(FeeItem) - 1 do begin
          if FeeItem[I].bSDT_Exist then begin
            nST_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sStartDT));
            nET_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sEndDT));

            //구간시작시간과 입차시간 비교
            if nST_Unix_tmp < nST_Unix then begin
              nSD_Unix_tmp := nST_Unix;
            end else begin
              nSD_Unix_tmp := nST_Unix_tmp;
            end;

            //출차시간은 구간종료시간으로.
            nED_Unix_tmp := nET_Unix_tmp;

            //시간만 들어있는 timestamp를 시간데이터로 재변환해서 요금계산한다.
            sStartDT := Copy(sStartDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nSD_Unix_tmp));
            sEndDT   := Copy(sStartDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nED_Unix_tmp));
            nFee := nFee + FeeCalc(nParkNo,
                                   FeeItem[I].nFeeNo,
                                   PAnsiChar(Copy(aString(sStartDT), 1, 16)),
                                   PAnsiChar(Copy(aString(sEndDT), 1, 16)));
          end;
        end;

        //중간 날짜들 요금 별도계산
        sStartDT := Copy(FormatDateTime('YYYY-MM-DD', UnixToDateTime(nSD_Unix + 86400)), 1, 10) + ' 00:00:00';
        sEndDT   := Copy(FormatDateTime('YYYY-MM-DD', UnixToDateTime(nED_Unix - 86400)), 1, 10) + ' 23:59:59';
        nFee := nFee + FeeCalc(nParkNo,
                               nOrignFeeNo,
                               PAnsiChar(Copy(aString(sStartDT), 1, 16)),
                               PAnsiChar(Copy(aString(sEndDT), 1, 16)));

        //출차일자 요금계산
        for I := 0 to Length(FeeItem) - 1 do begin
          if FeeItem[I].bEDT_Exist then begin
            nST_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sStartDT));
            nET_Unix_tmp := DateTimeToUnix(StrToDateTime('2000-01-01 ' + FeeItem[I].sEndDT));

            nSD_Unix_tmp := nST_Unix_tmp;

            if nET_Unix_tmp > nET_Unix then begin
              nED_Unix_tmp := nET_Unix;
            end else begin
              nED_Unix_tmp := nET_Unix_tmp;
            end;

            //시간만 들어있는 timestamp를 시간데이터로 재변환해서 요금계산한다.
            sStartDT := Copy(sEndDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nSD_Unix_tmp));
            sEndDT   := Copy(sEndDateTime, 1, 10) + ' ' + FormatDateTime('HH:NN:SS', UnixToDateTime(nED_Unix_tmp));
            nFee := nFee + FeeCalc(nParkNo,
                                   FeeItem[I].nFeeNo,
                                   PAnsiChar(Copy(aString(sStartDT), 1, 16)),
                                   PAnsiChar(Copy(aString(sEndDT), 1, 16)));
          end;
        end;
      end;
//      ShowMessage('Fee: ' + inttostr(nFee));
      {$ENDREGION}
    end;

    Result := nFee;
  except
    on E: Exception do begin
      ExceptLogging('주차요금 산출 중 오류 발생 : ' + E.Message);
    end;
  end;
  {$ENDREGION}
end;

function TfrmMainNew.DJSM_FeeCalcEx(nParkNo, nOrignFeeNo: Integer;
  sStartDateTime, sEndDateTime: AnsiString; iYugum: Integer = 0): Integer;
var
  objFeeItem: FeeItem;
  feeListArr: array of FeeItem;
  i,j,outCalcFee: Integer;
  fEndTime,lStartTime: AnsiString;
  afeeListArr : Integer;

  FeeItem_Field, FeeItem_Field2, FeeItem_Field3, FeeItem_Field4, FeeItem_Field5 : TField;
  FeeItem_Field6, FeeItem_Field7, FeeItem_Field8, FeeItem_Field9, FeeItem_Field10 : TField;

  function DateConvHHNN(dateStr: AnsiString): TDateTime;
  begin
    Result := StrToDateTime(FormatDateTime('hh:nn',StrToDateTime(dateStr)));
  end;

begin
  //1.현재요금제를 모두 불러온다
  //2.해당되는 요금제에 요금을 계산한다.
  //3.기간이 1일이상이면 모두 더한다
  i:=0;
  outCalcFee := 0;
  Result := 0;
  FeeItem_Field  := TField.Create(self);
  FeeItem_Field2 := TField.Create(self);
  FeeItem_Field3 := TField.Create(self);
  FeeItem_Field4 := TField.Create(self);
  FeeItem_Field5 := TField.Create(self);
  FeeItem_Field6 := TField.Create(self);
  FeeItem_Field7 := TField.Create(self);
  FeeItem_Field8 := TField.Create(self);
  FeeItem_Field9 := TField.Create(self);
  FeeItem_Field10 := TField.Create(self);

  with dmTables.qryFeeCalc do begin
    dmTables.qryFeeCalc.DisableControls;
    Close;
    SQL.Clear;
    SQL.Add('Select * From FeeItem ');
    SQL.Add('Where 1=1 ');
    SQL.Add(  'AND Reserve1 = :isUsed ');
    SQL.Add('Order by FeeNo ASC ');
    Parameters.ParamByName('isUsed').Value := nOrignFeeNo;
    Open;
    if RecordCount > 0 then begin //요금제 있을때만 계산
      SetLength(feeListArr,RecordCount);
      ZeroMemory(Pointer(feeListArr), Length(feeListArr) * SizeOf(feeitem));

      FeeItem_Field  := FieldByName('FeeNo');
      FeeItem_Field2 := FieldByName('FeeName');
      FeeItem_Field3 := FieldByName('ItemMax');
      FeeItem_Field4 := FieldByName('SaturdayMax');
      FeeItem_Field5 := FieldByName('HolidayMax');
      FeeItem_Field6 := FieldByName('TotMax');
      FeeItem_Field7 := FieldByName('Reserve1');
      FeeItem_Field8 := FieldByName('Reserve2');
      FeeItem_Field9 := FieldByName('Reserve3');
      FeeItem_Field10 := FieldByName('Reserve4');

      First;
      while not Eof do begin
         objFeeItem.FeeNo := FeeItem_Field.AsInteger;
         objFeeItem.FeeName := FeeItem_Field2.asString;
         objFeeItem.WeekdaysMax := FeeItem_Field3.AsInteger;
         objFeeItem.SaturdayMax := FeeItem_Field4.AsInteger;
         objFeeItem.SundayMax := FeeItem_Field5.AsInteger;
         objFeeItem.TotMax := FeeItem_Field6.AsInteger;
         objFeeItem.GroupNo := FeeItem_Field7.AsInteger;
         objFeeItem.sTime := FeeItem_Field8.asString;
         objFeeItem.eTime := FeeItem_Field9.asString;
         objFeeItem.FreeTime := FeeItem_Field10.asString;

        {objFeeItem.FeeNo := FieldByName('FeeNo').Value;
        objFeeItem.FeeName := FieldByName('FeeName').Value;
        objFeeItem.WeekdaysMax := FieldByName('ItemMax').Value;
        objFeeItem.SaturdayMax := FieldByName('SaturdayMax').Value;
        objFeeItem.SundayMax := FieldByName('HolidayMax').Value;
        objFeeItem.TotMax := FieldByName('TotMax').Value;
        objFeeItem.GroupNo := FieldByName('Reserve1').Value;
        objFeeItem.sTime := FieldByName('Reserve2').Value;
        objFeeItem.eTime := FieldByName('Reserve3').Value;
        objFeeItem.FreeTime := FieldByName('Reserve4').Value;}
        feeListArr[i] := objFeeItem;
        inc(i);
        next;
      end;
      afeeListArr := Length(feeListArr);
      //최초요금발생시 서비스시간부터 차감
      if iYugum = 1 then begin //최초
        ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        sEndDateTime := MG_AddTime(sDCOutTime, 0, -30, 0, 0); //이구간에서 사용
        //sStartDateTime := MG_AddTime(sStartDateTime, 0, 30, 0, 0);
        ExceptLogging('서비스30분 할인적용');
      end else if iYugum = 0 then begin //할인있으면 서비스시간 뺏음
        {if noverYunm = 1 then
        begin
          ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
          sEndDateTime := MG_AddTime(sDCOutTime, 0, 0, 0, 0);
          ExceptLogging('서비스30분 할인적용2');
        end
        else
        begin
          ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
          sEndDateTime := MG_AddTime(sDCOutTime, 0, -30, 0, 0);
          ExceptLogging('서비스30분 할인적용2-1');
        end;}
        ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        sEndDateTime := MG_AddTime(sStartDateTime, 0, overUseTime, 0, 0);
        //sEndDateTime := MG_AddTime(sDCOutTime, 0, -30, 0, 0);
        //sEndDateTime := MG_AddTime(sDCOutTime, 0, 0, 0, 0);
        //sStartDateTime := MG_AddTime(sStartDateTime, 0, 0, 0, 0);
        //ExceptLogging('서비스30분 할인제거');
        ExceptLogging('서비스30분 할인적용 안됨');
      end
      else if iYugum = 2 then begin //장례식장 바코드 할인 건
        sEndDateTime := MG_AddTime(sStartDateTime, 0, overUseTime, 0, 0);
        ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        ExceptLogging('서비스30분 할인적용 안됨2');
      end
      else if iYugum = 3 then begin //할인키 버튼 할인
        ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        ExceptLogging('서비스30분 할인적용 안됨3');
      end  else if iYugum = 5 then begin //OCS 중복할인
        ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        sEndDateTime := MG_AddTime(sEndDateTime, 0, -nDCValue2, 0, 0);
        //sEndDateTime := MG_AddTime(sEndDateTime, 0, overUseTime, 0, 0);
        if sStartDateTime > sEndDateTime then
        begin
           sEndDateTime := MG_AddTime(sStartDateTime, 0, overUseTime, 0, 0);
           //sEndDateTime := sStartDateTime;
        end;
        ExceptLogging('서비스30분 할인적용 안됨5');
      end
      else if iYugum = 6 then begin //시분초계산
        ExceptLogging('요금계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        sEndDateTime := MG_AddTime(sStartDateTime, 0, 0, nSecEx, 0); //이구간에서 사용
        ExceptLogging('서비스30분 할인적용 안됨6');
      end
      else begin //50%할인될때, 기본계산
        ExceptLogging('기본 계산일:'+sStartDateTime + ' ~ '+sEndDateTime);
        ExceptLogging('서비스30분 할인적용 안됨4');
      end;
      sDCInTime2  := sStartDateTime;
      ExceptLogging('할인 시작 계산일: ~'+sDCInTime2);
      //OCS할인코드 있을 시에는 06번코드 OCS 할인 이후 시간 적용
      if(nISCCD='01') or (nISCCD='02') or (nISCCD='03') or (nISCCD='04') then
      begin
        nDCInTime := sEndDateTime;
        //sDCOutTime := sStartDateTime;
        ExceptLogging('OCS 계산일: ~'+nDCInTime);
      end;
      //요금계산기간이 하루인지 2일이상인지 판별
      //일단 대전성모용으로 10분당 300원 하드코딩 ㅠㅠ
      //objFeeItem.Fee := 300;
      if FormatDateTime('yyyy-mm-dd',StrToDateTime(sStartDateTime)) = FormatDateTime('yyyy-mm-dd',StrToDateTime(sEndDateTime)) then begin //하루
        //for i := 0 to Length(feeListArr)-1 do begin
        for i := 0 to afeeListArr-1 do begin
          objFeeItem := feeListArr[i];
          if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.sTime)) <= FormatDateTime('hh:nn',StrToDateTime(sStartDateTime))) then begin //요금계산 시작시간이 해당요금제의 시작시간에 해당
            if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(sEndDateTime))) then begin //요금계산 종료시간이 해당요금제의 종료시간 이전에 해당
              objFeeItem.FeeTime := MinutesBetween(StrToDateTime(sEndDateTime),StrToDateTime(sStartDateTime));

              if (nISCCD ='04') or (nISCCD ='03')  then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
              begin
                 if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                 begin
                    //objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300; //10분당 300원 적용
//                    objFeeItem.Fee := overUseTime div 10 * 300; //10분당 300원 적용
//                    if overUseTime mod 10 > 0 then
//                      objFeeItem.Fee := objFeeItem.Fee + 300;

                    if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                 end
                 else
                 begin
                    if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                 end;
              end
              else
              begin
                if bIsPatientUse = 0 then   //일반차량 요금처리
                begin
                    { objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                        objFeeItem.Fee := objFeeItem.Fee + 300; }

                    if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                    begin

                      if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end
                      else //야간 요금 최대 2000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end
                    else
                    begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;


                  {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                  begin
                    if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                  end
                  else
                  begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                        objFeeItem.Fee := objFeeItem.Fee + 300;
                  end;}
                end
                else
                begin
                  if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                  else begin
                    objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    //if objFeeItem.FeeTime mod 10 > 0 then
                    if objFeeItem.FeeTime mod 10 >= 0 then
                      if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else
                        objFeeItem.Fee := objFeeItem.Fee + 300;
                  end;
                end;
              end;

              {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                objFeeItem.Fee := objFeeItem.WeekdaysMax
              else begin
                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                if objFeeItem.FeeTime mod 10 > 0 then
                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                  else
                    objFeeItem.Fee := objFeeItem.Fee + 300;
              end;}
            end else begin //종료시간이 해당요금제의 종료시간을 넘음
              if FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(sStartDateTime)) then begin
                //해당요금제의 종료시간까지 더함
//                objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
//                objFeeItem.Fee := objFeeItem.WeekdaysMax;
                objFeeItem.FeeTime := MinutesBetween(StrToDateTime(FormatDateTime('yyyy-mm-dd',now) + ' ' +objFeeItem.eTime),StrToDateTime(sStartDateTime));

                if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                begin
                   if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                   begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                   end
                   else
                   begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                   end;
                end
                else
                begin
                  if bIsPatientUse = 0 then   //일반차량 요금처리
                  begin
                    {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                        objFeeItem.Fee := objFeeItem.Fee + 300;}

                    if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                    begin
                      if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end
                      else //야간 요금 최대 2000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end
                    else
                    begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;

                    {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                    begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                    end
                    else
                    begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      if objFeeItem.FeeTime mod 10 > 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;}
                  end
                  else
                  begin
                    if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                  end;
                end;


                {objFeeItem.FeeTime := MinutesBetween(StrToDateTime(FormatDateTime('yyyy-mm-dd',now) + ' ' +objFeeItem.eTime),StrToDateTime(sStartDateTime));
                if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                else begin
                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                  if objFeeItem.FeeTime mod 10 > 0 then
                    if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else
                      objFeeItem.Fee := objFeeItem.Fee + 300;
                end;}
              end;
            end;
          end else begin //종료시간이 해당요금제의 종료시간안에 해당될때
            if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(sEndDateTime))) then begin //종료시간이 해당요금제의 종료시간 이전에 해당
              if FormatDateTime('hh:nn',StrToDateTime(sEndDateTime)) > FormatDateTime('hh:nn',StrToDateTime(objFeeItem.sTime)) then begin
                objFeeItem.FeeTime := MinutesBetween(StrToDateTime(sEndDateTime), StrToDatetime(FormatDateTime('yyyy-mm-dd',Now) + ' ' + objFeeItem.sTime));
                if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                begin
                   if overUseTime > 0 then       //할인 적용 보호자6H 초과 시 초과 시간만큼 요금 적용
                   begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                   end
                   else
                   begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                   end;
                end
                else
                begin
                  if bIsPatientUse = 0 then   //일반차량 요금처리
                  begin
                    {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                        objFeeItem.Fee := objFeeItem.Fee + 300;}

                    if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                    begin
                      if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end
                      else //야간 요금 최대 2000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end
                    else
                    begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;

                    {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                    begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                    end
                    else
                    begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      if objFeeItem.FeeTime mod 10 > 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;}
                  end
                  else
                  begin
                    if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                  end;
                end;


                {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                else begin
                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                  if objFeeItem.FeeTime mod 10 > 0 then
                    if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else
                      objFeeItem.Fee := objFeeItem.Fee + 300;
                end;}
              end;
            end else begin //종료시간이 해당요금제의 종료시간을 넘음
              //해당요금제의 종료시간까지 더함
              objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
              if bIsPatientUse = 0 then   //일반차량 요금처리 + ocs 할인 차량 요금처리(01, 02 ocs code)
              begin
                { objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                if objFeeItem.FeeTime mod 10 > 0 then
                    objFeeItem.Fee := objFeeItem.Fee + 300; }

                if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                begin
                  if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                    begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end
                  else //야간 요금 최대 2000원 적용
                  begin
                    if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                  end;
                end
                else
                begin
                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                  //if objFeeItem.FeeTime mod 10 > 0 then
                  if objFeeItem.FeeTime mod 10 >= 0 then
                      objFeeItem.Fee := objFeeItem.Fee + 300;
                end;



              end
              else //ocs 할인 차량 요금처리(03, 04 ocs code)
              begin
                 objFeeItem.Fee := objFeeItem.WeekdaysMax;
              end;
              //objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
              //objFeeItem.Fee := objFeeItem.WeekdaysMax;
            end;
          end;
          ExceptLogging(IntToStr(i+1)+'구간요금: '+objFeeItem.FeeName+' '+ IntToStr(objFeeItem.Fee));
          feeListArr[i] := objFeeItem;
        end;

        //요금제 구조체에서 해당요금들 계산해서 합산
        //for i := 0 to Length(feeListArr)-1 do begin
        for i := 0 to afeeListArr-1 do begin
          objFeeItem := feeListArr[i];
          outCalcFee := outCalcFee + objFeeItem.Fee;
        end;

      end else begin //2일이상
        for j := 0 to DaysBetween(StrToDateTimeDef(FormatDateTime('yyyy-mm-dd',StrToDateTime(sEndDateTime)),0), StrToDateTimeDef(FormatDateTime('yyyy-mm-dd',StrToDateTime(sStartDateTime)),0)) do begin //주차시간일 몇일인지
          if j = 0 then begin
            //첫째날
            //마지막시간 23:59
            //fEndTime := FormatDateTime('yyyy-mm-dd',StrToDateTime(sEndDateTime)) + ' 23:59';
            fEndTime := FormatDateTime('yyyy-mm-dd',StrToDateTime(sStartDateTime)) + ' 23:59';
            //fEndTime := FormatDateTime('yyyy-mm-dd hh:mm:ss',StrToDateTime(sEndDateTime));
            for i := 0 to Length(feeListArr)-1 do begin
              objFeeItem := feeListArr[i];
              if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.sTime)) <= FormatDateTime('hh:nn',StrToDateTime(sStartDateTime))) then begin //시작시간이 해당요금제의 시작시간에 해당
                if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(fEndTime))) then begin //종료시간이 해당요금제의 종료시간 이전에 해당
                  objFeeItem.FeeTime := MinutesBetween(StrToDateTime(fEndTime),StrToDateTime(sStartDateTime));

                  if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                  begin
                     if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                     begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                     end
                     else
                     begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                     end;
                  end
                  else
                  begin
                    if bIsPatientUse = 0 then   //일반차량 요금처리
                    begin
                        {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                        objFeeItem.Fee := objFeeItem.Fee + 300;}

                        if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                        begin
                          if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                          begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end
                          else //야간 요금 최대 2000원 적용
                          begin
                            if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;
                          end;
                        end
                        else
                        begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;


                      {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end
                      else
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;}
                    end
                    else
                    begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                    end;
                  end;

                  {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                  else begin
                    objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else
                        objFeeItem.Fee := objFeeItem.Fee + 300;
                  end;}
                end else begin //종료시간이 해당요금제의 종료시간을 넘음
                  if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(sStartDateTime))) then begin
                    //해당요금제의 종료시간까지 더함
//                    objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
//                    objFeeItem.Fee := objFeeItem.WeekdaysMax;
                    objFeeItem.FeeTime := MinutesBetween(DateConvHHNN(objFeeItem.eTime),DateConvHHNN(sStartDateTime));
                    if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                    begin
                       if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                       begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                       end
                       else
                       begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                       end;
                    end
                    else
                    begin
                      if bIsPatientUse = 0 then   //일반차량 요금처리
                      begin
                         {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300; }

                        if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                        begin
                          if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                          begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            if objFeeItem.FeeTime mod 10 > 0 then
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end
                          else //야간 요금 최대 2000원 적용
                          begin
                            if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;
                          end;
                        end
                        else
                        begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;

                        {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                        begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                        end
                        else
                        begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end; }
                      end
                      else
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end;

                    {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;}
                  end;
                end;
              end else begin //종료시간이 해당요금제의 종료시간안에 해당될때
                if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(fEndTime))) then begin //종료시간이 해당요금제의 종료시간 이전에 해당
                  //objFeeItem.FeeTime := MinutesBetween(StrToDateTime(fEndTime), StrToDatetime(FormatDateTime('yyyy-mm-dd',Now) + ' ' + objFeeItem.sTime));
                  objFeeItem.FeeTime := MinutesBetween(StrToDateTime(fEndTime), StrToDatetime(FormatDateTime('yyyy-mm-dd',StrToDateTime(fEndTime)) + ' ' + objFeeItem.sTime));
                  if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                  begin
                     if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                     begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                     end
                     else
                     begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                     end;
                  end
                  else
                  begin
                    if bIsPatientUse = 0 then   //일반차량 요금처리
                    begin
                        {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300; }

                      if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                      begin
                        if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                        begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end
                        else //야간 요금 최대 2000원 적용
                        begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                        end;
                      end
                      else
                      begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;

                      {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end
                      else
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;}
                    end
                    else
                    begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                    end;
                  end;

                  {objFeeItem.FeeTime := MinutesBetween(StrToDateTime(fEndTime), StrToDatetime(FormatDateTime('yyyy-mm-dd',Now) + ' ' + objFeeItem.sTime));
                  if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                  else begin
                    objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else
                        objFeeItem.Fee := objFeeItem.Fee + 300;
                  end }
                end else begin //종료시간이 해당요금제의 종료시간을 넘음
                  //해당요금제의 종료시간까지 더함
                  objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
                  objFeeItem.Fee := objFeeItem.WeekdaysMax;
                end;
              end;
              feeListArr[i] := objFeeItem;
            end;

            //for i := 0 to Length(feeListArr)-1 do begin
            for i := 0 to afeeListArr-1 do begin
              objFeeItem := feeListArr[i];
              outCalcFee := outCalcFee + objFeeItem.Fee;
              //ExceptLogging(IntToStr(i+1)+'구간요금: '+ IntToStr(objFeeItem.Fee));
              ExceptLogging(IntToStr(i+1)+'구간요금: '+objFeeItem.FeeName+' '+ IntToStr(objFeeItem.Fee));
              //다음루프를 위해 초기화
              objFeeItem.Fee := 0;
              objFeeItem.FeeTime := 0;

              //다시 배열구조체에 담기
              feeListArr[i] := objFeeItem;
            end;

            ExceptLogging('첫날요금: '+ IntToStr(outcalcfee));

          end else if j = DaysBetween(StrToDateTimeDef(FormatDateTime('yyyy-mm-dd',StrToDateTime(sEndDateTime)),0), StrToDateTimeDef(FormatDateTime('yyyy-mm-dd',StrToDateTime(sStartDateTime)),0)) then begin
            //마지막날
            //처음시간 00:00
            lStartTime := FormatDateTime('yyyy-mm-dd',StrToDateTime(sEndDateTime)) + ' 00:00';
            //for i := 0 to Length(feeListArr)-1 do begin
            for i := 0 to afeeListArr-1 do begin
              objFeeItem := feeListArr[i];
              if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.sTime)) <= FormatDateTime('hh:nn',StrToDateTime(lStartTime))) then begin //시작시간이 해당요금제의 시작시간에 해당
                if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(sEndDateTime))) then begin //종료시간이 해당요금제의 종료시간 이전에 해당
                  objFeeItem.FeeTime := MinutesBetween(StrToDateTime(sEndDateTime),StrToDateTime(lStartTime));
                  if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                  begin
                     if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                     begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                     end
                     else
                     begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                     end;
                  end
                  else
                  begin
                    if bIsPatientUse = 0 then   //일반차량 요금처리
                    begin
                       {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;}

                      if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                      begin
                        if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                        begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end
                        else //야간 요금 최대 2000원 적용
                        begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                        end;
                      end
                      else
                      begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;


                      {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end
                      else
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        if objFeeItem.FeeTime mod 10 > 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end; }
                    end
                    else
                    begin
                      if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else begin
                        objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                          if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end;
                    end;
                  end;

                  {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                  else begin
                    objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                        objFeeItem.Fee := objFeeItem.WeekdaysMax
                      else
                        objFeeItem.Fee := objFeeItem.Fee + 300;
                  end;}
                end else begin //종료시간이 해당요금제의 종료시간을 넘음
                  if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(lStartTime))) then begin
                    //해당요금제의 종료시간까지 더함
//                    objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
//                    objFeeItem.Fee := objFeeItem.WeekdaysMax;
                    //objFeeItem.FeeTime := MinutesBetween(DateConvHHNN(objFeeItem.eTime),DateConvHHNN(sEndDateTime));
                    objFeeItem.FeeTime := MinutesBetween(DateConvHHNN(objFeeItem.eTime),DateConvHHNN(lStartTime));
                    if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                    begin
                       if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                       begin
                          if objFeeItem.WeekdaysMax < overUseTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := overUseTime div 10 * 300;
                            //if overUseTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                       end
                       else
                       begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                       end;
                    end
                    else
                    begin
                      if bIsPatientUse = 0 then   //일반차량 요금처리
                      begin
                         {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300; }

                        if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                        begin
                          if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                          begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end
                          else //야간 요금 최대 2000원 적용
                          begin
                            if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;
                          end;
                        end
                        else
                        begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;


                        {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                        begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                        end
                        else
                        begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;}
                      end
                      else
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end;
                    {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;}

                  end
                  else
                  begin
                    //구간 요금 일때만 적용
                    if sYounmCount = 1 then
                    begin
                      if StrToDateTime(sEndDateTime) < StrToDatetime(Copy(sEndDateTime,1,10) + ' ' + objFeeItem.sTime) then
                      begin
                      end
                      else
                      begin
                        objFeeItem.FeeTime := MinutesBetween(StrToDateTime(sEndDateTime), StrToDatetime(Copy(sEndDateTime,1,10) + ' ' + objFeeItem.sTime));
                        if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                        begin
                           if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                           begin
                              if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                //if objFeeItem.FeeTime mod 10 > 0 then
                                if objFeeItem.FeeTime mod 10 >= 0 then
                                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                                  else
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end;
                           end
                           else
                           begin
                              if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                //if objFeeItem.FeeTime mod 10 > 0 then
                                if objFeeItem.FeeTime mod 10 >= 0 then
                                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                                  else
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end;
                           end;
                        end
                        else
                        begin
                          if bIsPatientUse = 0 then   //일반차량 요금처리
                          begin
                              {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              if objFeeItem.FeeTime mod 10 > 0 then
                                  objFeeItem.Fee := objFeeItem.Fee + 300;}

                            if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                            begin
                              if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                              begin
                                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                //if objFeeItem.FeeTime mod 10 > 0 then
                                if objFeeItem.FeeTime mod 10 >= 0 then
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end
                              else //야간 요금 최대 2000원 적용
                              begin
                                if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else begin
                                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                  //if objFeeItem.FeeTime mod 10 > 0 then
                                  if objFeeItem.FeeTime mod 10 >= 0 then
                                    if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                                    else
                                      objFeeItem.Fee := objFeeItem.Fee + 300;
                                end;
                              end;
                            end
                            else
                            begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;

                            {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                            begin
                              if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                if objFeeItem.FeeTime mod 10 > 0 then
                                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                                  else
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end;
                            end
                            else
                            begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              if objFeeItem.FeeTime mod 10 > 0 then
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;}
                          end
                          else
                          begin
                            if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;
                          end;
                        end;
                      end;
                    end;
                  end;
                end;
              end else begin //종료시간이 해당요금제의 종료시간안에 해당될때
                if (FormatDateTime('hh:nn',StrToDateTime(objFeeItem.eTime)) >= FormatDateTime('hh:nn',StrToDateTime(sEndDateTime))) then begin //종료시간이 해당요금제의 종료시간 이전에 해당
                  if StrToDateTime(sEndDateTime) > StrToDatetime(FormatDateTime('yyyy-mm-dd',Now) + ' ' + objFeeItem.sTime) then begin
                    objFeeItem.FeeTime := MinutesBetween(StrToDateTime(sEndDateTime), StrToDatetime(FormatDateTime('yyyy-mm-dd',Now) + ' ' + objFeeItem.sTime));
                    if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                    begin
                       if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                       begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                       end
                       else
                       begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                       end;
                    end
                    else
                    begin
                      if bIsPatientUse = 0 then   //일반차량 요금처리
                      begin
                          {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;}

                        if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                        begin
                          if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                          begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            //if objFeeItem.FeeTime mod 10 > 0 then
                            if objFeeItem.FeeTime mod 10 >= 0 then
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end
                          else //야간 요금 최대 2000원 적용
                          begin
                            if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;
                          end;
                        end
                        else
                        begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;

                        {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                        begin
                          if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                            objFeeItem.Fee := objFeeItem.WeekdaysMax
                          else begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                            if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else
                                objFeeItem.Fee := objFeeItem.Fee + 300;
                          end;
                        end
                        else
                        begin
                            objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          if objFeeItem.FeeTime mod 10 > 0 then
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;}
                      end
                      else
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end;

                    {if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                    else begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end }
                  end
                  else
                  begin
                    //구간 요금 일때만 적용
                    if sYounmCount = 1 then
                    begin
                      if StrToDateTime(sEndDateTime) < StrToDatetime(Copy(sEndDateTime,1,10) + ' ' + objFeeItem.sTime) then
                      begin
                      end
                      else
                      begin
                        objFeeItem.FeeTime := MinutesBetween(StrToDateTime(sEndDateTime), StrToDatetime(Copy(sEndDateTime,1,10) + ' ' + objFeeItem.sTime));
                        if (nISCCD ='04') or (nISCCD ='03') then  //10.29 보호자 할인 경우 무조건 10분당 300원으로 처리(최대 요금 상관없이)
                        begin
                           if overUseTime > 0 then       //할인 적용 보호자6H 초과 시
                           begin
                              if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                //if objFeeItem.FeeTime mod 10 > 0 then
                                if objFeeItem.FeeTime mod 10 >= 0 then
                                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                                  else
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end;
                           end
                           else
                           begin
                              if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                //if objFeeItem.FeeTime mod 10 > 0 then
                                if objFeeItem.FeeTime mod 10 >= 0 then
                                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                                  else
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end;
                           end;
                        end
                        else
                        begin
                          if bIsPatientUse = 0 then   //일반차량 요금처리
                          begin
                              {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              if objFeeItem.FeeTime mod 10 > 0 then
                                  objFeeItem.Fee := objFeeItem.Fee + 300;}

                            if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                            begin
                              if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                              begin
                                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                //if objFeeItem.FeeTime mod 10 > 0 then
                                if objFeeItem.FeeTime mod 10 >= 0 then
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end
                              else //야간 요금 최대 2000원 적용
                              begin
                                if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else begin
                                  objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                  //if objFeeItem.FeeTime mod 10 > 0 then
                                  if objFeeItem.FeeTime mod 10 >= 0 then
                                    if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                      objFeeItem.Fee := objFeeItem.WeekdaysMax
                                    else
                                      objFeeItem.Fee := objFeeItem.Fee + 300;
                                end;
                              end;
                            end
                            else
                            begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;

                            {if objFeeItem.FeeNo = 2 then //주간 요금 최대 9000원 적용
                            begin
                              if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                                objFeeItem.Fee := objFeeItem.WeekdaysMax
                              else begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                                if objFeeItem.FeeTime mod 10 > 0 then
                                  if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                    objFeeItem.Fee := objFeeItem.WeekdaysMax
                                  else
                                    objFeeItem.Fee := objFeeItem.Fee + 300;
                              end;
                            end
                            else
                            begin
                                objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              if objFeeItem.FeeTime mod 10 > 0 then
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;}
                          end
                          else
                          begin
                            if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else begin
                              objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                              //if objFeeItem.FeeTime mod 10 > 0 then
                              if objFeeItem.FeeTime mod 10 >= 0 then
                                if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                                  objFeeItem.Fee := objFeeItem.WeekdaysMax
                                else
                                  objFeeItem.Fee := objFeeItem.Fee + 300;
                            end;
                          end;
                        end;
                      end;
                    end;
                  end;
                end else begin //종료시간이 해당요금제의 종료시간을 넘음
                  //해당요금제의 종료시간까지 더함
                  objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
                  if bIsPatientUse = 0 then   //일반차량 요금처리 + ocs 할인 차량 요금처리(01, 02 ocs code)
                  begin
                    {objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                    if objFeeItem.FeeTime mod 10 > 0 then
                        objFeeItem.Fee := objFeeItem.Fee + 300; }

                    if BarCodeDC_Yogum = 1 then  //장례식장 할인 여부
                    begin
                      if (objFeeItem.FeeNo = 2) or (objFeeItem.FeeNo = 6) then //주간요금
                      begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                        //if objFeeItem.FeeTime mod 10 > 0 then
                        if objFeeItem.FeeTime mod 10 >= 0 then
                            objFeeItem.Fee := objFeeItem.Fee + 300;
                      end
                      else //야간 요금 최대 2000원 적용
                      begin
                        if objFeeItem.WeekdaysMax < objFeeItem.FeeTime div 10 * 300 then
                          objFeeItem.Fee := objFeeItem.WeekdaysMax
                        else begin
                          objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                          //if objFeeItem.FeeTime mod 10 > 0 then
                          if objFeeItem.FeeTime mod 10 >= 0 then
                            if objFeeItem.Fee + 300 > objFeeItem.WeekdaysMax then
                              objFeeItem.Fee := objFeeItem.WeekdaysMax
                            else
                              objFeeItem.Fee := objFeeItem.Fee + 300;
                        end;
                      end;
                    end
                    else
                    begin
                      objFeeItem.Fee := objFeeItem.FeeTime div 10 * 300;
                      //if objFeeItem.FeeTime mod 10 > 0 then
                      if objFeeItem.FeeTime mod 10 >= 0 then
                          objFeeItem.Fee := objFeeItem.Fee + 300;
                    end;
                  end
                  else //ocs 할인 차량 요금처리(03, 04 ocs code)
                  begin
                     objFeeItem.Fee := objFeeItem.WeekdaysMax;
                  end;

//                  objFeeItem.FeeTime := MinutesBetween(StrToDateTime(objFeeItem.eTime),StrToDateTime(objFeeItem.sTime));
//                  objFeeItem.Fee := objFeeItem.WeekdaysMax;
                end;
              end;
              feeListArr[i] := objFeeItem;
            end;

            //for i := 0 to Length(feeListArr)-1 do begin
            for i := 0 to afeeListArr-1 do begin
              objFeeItem := feeListArr[i];
              outCalcFee := outCalcFee + objFeeItem.Fee;
              //ExceptLogging(IntToStr(i+1)+'구간요금: '+ IntToStr(objFeeItem.Fee));
              ExceptLogging(IntToStr(i+1)+'구간요금: '+objFeeItem.FeeName+' '+ IntToStr(objFeeItem.Fee));

              //다음루프를 위해 초기화
              objFeeItem.Fee := 0;
              objFeeItem.FeeTime := 0;

              //다시 배열구조체에 담기
              feeListArr[i] := objFeeItem;
            end;
            ExceptLogging('마지막날 합산요금: '+ IntToStr(outcalcfee));

          end else begin
            //중간날 하루최대 요금적용 13000원임
            //for i := 0 to Length(feeListArr)-1 do begin
            for i := 0 to afeeListArr-1 do begin
              objFeeItem := feeListArr[i];
              outCalcFee := outCalcFee + objFeeItem.WeekdaysMax;
              //다음루프를 위해 초기화
              objFeeItem.Fee := 0;
              objFeeItem.FeeTime := 0;
              //다시 배열구조체에 담기
              feeListArr[i] := objFeeItem;
            end;
            ExceptLogging('중간날 합산요금: '+ IntToStr(outcalcfee));
          end;
        end;
      end;
      ExceptLogging('주차요금: '+ IntToStr(outcalcfee));
      Result := outcalcfee;
    end;
    dmTables.qryFeeCalc.EnableControls;
  end;

end;

procedure TfrmMainNew.OCSDCProc(sNowTKno: String);
var
  sPATIENTNO  : array of aString;   //환자번호 변수
  sDCCODE, sDCCODE_PAST : array of aString;   //병원에 등록된 OCS할인정보 변수
  sRECEIPTDATE, sRECEIPTDATE_PAST : array of aString;   //병원에 등록된 수납일자 변수
  sPID, sPID_PAST : array of aString;   //병원에 등록된 PID변수
  bIsPast : Boolean;                  //어제할인인지.
  bIsAdmission : Boolean;             //입원할인 처리여부
  I, J : Integer;                     //for 반복문용 변수할당

  tempString  : aString;              //임시저장용 string 변수
  nTempDCNo   : Integer;              //임시저장용 할인코드
  sAdmStartDate : aString;            //입원할인시작일
  sAdmEndDate   : aString;
  nAdmDateCount : Integer;            //입원일 수
  nAdmDateTime : Integer;            //남은 시간(1일 이상 주차 시)

  nAlreadyDCValue: Integer;    //입원일 재입차시 사용한 할인값
  nRemainDCValue : Integer;    //입원일 재입차시 잔여 할인값
  nTotRemainTime: Integer; //입원일기간 총 보호자차감 잔여분

  bIsPatient : Boolean;

  logStr: string;

  sEndDateTime : astring;
  nTimeDC : Integer;
  //보호자 할인 처리 변수
  nprocdate, nprocTime, nprocdate_nprocTime, nFirstpdateTime :astring;
   //디비 속도 향상 (OCS)
  //SQL_Field, SQL_Field2, SQL_Field3, SQL_Field4, SQL_Field5: TField;
  //sDISCFLAG, sDISCCD, sRCPTDD, nPID, sHANDICAPRYN : aString;
  //디비 속도 향상
  SQL_Field6, SQL_Field7, SQL_Field8, SQL_Field9, SQL_Field10: TField;
  asPATIENTNO, asDCCODE, asDCCODE_PAST : Integer;

begin
  logStr := '';
  //대전성모병원 OCS할인처리 시작
  ExceptLogging('***************************************************************');
  ExceptLogging('대전성모병원 OCS 정보 처리 시작');
  sAdmStartDate := '';
  sAdmEndDate   := '';
  nAdmDateCount := 0;
  bIsPatient := False;

  nAlreadyDCValue := 0;
  nRemainDCValue  := 0;
  nowUseTime := 0;
  overUseTime := 0;
  //초기화를 맨앞에해야지! 환자번호 채번할때 데이터있으면 초기화는 아니지않나.. 이러니 계속 장애인,국가유공자할인 뜬거였지..
  bHandicap := False; //장애인 여부 변수 초기화
  bNational := False; //국가유공자 여부 변수 초기화
  sPATIENTNO := nil;  //환자 번호 초기화
  sDCCODE:= nil;      //병원에 등록된 OCS할인정보 변수 초기화
  sDCCODE_PAST := nil; //병원에 등록된 OCS할인정보 변수 초기화
  sRECEIPTDATE := nil;   //병원에 등록된 수납일자 변수
  sRECEIPTDATE_PAST := nil; //병원에 등록된 수납일자 변수
  //nsAdmStartDate := '';//OCS(01,02) 할인 입원날짜 변수
  //재입차시 반복부여 가능
  nDCValue := 0; //총 주어진 할인 주차 시간

  sDCInTime2 := '';
  sDCOutTime2:= '';
  edtDC.Text := '';

  nmanualUse := 0;
  //디비 속도 향상
  SQL_Field := TField.Create(self);
  SQL_Field2 := TField.Create(self);
  SQL_Field3 := TField.Create(self);
  SQL_Field4 := TField.Create(self);
  SQL_Field5 := TField.Create(self);

  SQL_Field6 := TField.Create(self);
  SQL_Field7 := TField.Create(self);
  SQL_Field8 := TField.Create(self);
  SQL_Field9 := TField.Create(self);
  SQL_Field10 := TField.Create(self);

  try
    {$REGION '환자번호 채번'}
    try

      if test_OcsNo <> '' then
        sNowLprCarNo1 := test_OcsNo;

      with dmTables.qryOCS do begin
        dmTables.qryOCS.DisableControls;
        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 연동 할인코드 시작(쿼리 시간) : ' + OCSTIME);

        Close;
        SQL.Clear;
        SQL.Add('SELECT * FROM OPENQUERY('+sLinkedDBName+', ');
        SQL.Add(  ' ''SELECT PID, ');
        SQL.Add(       'COUNT(case when HANDICAPRYN = ''' + QuotedStr('Y') + ''' then 1 end) as HANDCNT, ');
        SQL.Add(       'COUNT(case when NATIONTOYN = ''' + QuotedStr('Y') + ''' then 1 end) as NATCNT ');
        SQL.Add(      'From '+sOCSDBName+'.PMCMPKBS ');
        if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
          SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) +
                      ''' or CarNo = ''' + QuotedStr(sNowLprCarNo2) + ''' ');    //incarno2
        end else begin
          SQL.Add(    'Where CarNo = ''' + QuotedStr(sNowLprCarNo1) + ''' ');
        end;
        SQL.Add(      'Group by PID'' )');
        logStr := logStr + #13#10 + ('환자번호로 장애인/국가유공자 할인검색 : ' + SQL.Text);
        Open;

        if RecordCount > 0 then begin
          I := 1;
          SetLength(sPATIENTNO, RecordCount);
          bIsPatientUse := 1;

          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 연동 할인코드 중간(쿼리 시간) : ' + OCSTIME);

          //디비 속도 향상
          SQL_Field := FieldByName('PID');
          while not Eof do begin
            //디비 속도 향상
            tempString := SQL_Field.AsString;
            //tempString := FieldByName('PID').AsString;
            ExceptLogging('환자번호 : ' + tempString);

            {if (not bHandicap) and (FieldByName('HANDCNT').AsInteger > 0) then begin
              logStr := logStr + #13#10 + ('['+IntToStr(I)+'] : ' + tempString + ', ['+sNowLprCarNo1+'] 차량 장애인 등록여부 확인됨.');
              bHandicap := True;
            end;
            if (not bNational) and (FieldByName('NATCNT').AsInteger > 0) then begin
              logStr := logStr + #13#10 + ('['+IntToStr(I)+'] : ' + tempString + ', ['+sNowLprCarNo1+'] 차량 국가유공자 등록여부 확인됨.');
              bNational := True;
            end;}
            sPATIENTNO[I-1] := tempString;
            bIsPatient := True;
            Inc(I);
            Next;
          end;
        end else begin
          //대전성모 OCS PAM.PMCMPKBS테이블에 환자정보가 없을 수 있음.(신규환자의 경우)
          //병원
          logStr := logStr + #13#10 + ('환자번호 장애인/국가유공자 해당안됨');
          SetLength(sPATIENTNO, 5);
          {for I := 0 to 4 do begin
            sPATIENTNO[I] := sBarcodeOCSPID[I];
          end;} //필요 없는 듯
//          Exit;
        end;
        asPATIENTNO := Length(sPATIENTNO);
        //for I := 0 to Length(sPATIENTNO)-1 do begin //0부터했으면 카운트-1을해야지..
        {for I := 0 to asPATIENTNO-1 do begin
          if not(sPATIENTNO[I] = '') then begin
            bIsPatient := True;
          end;
        end;}

        //실제 테스트시 주석 열어줌
        //OCS 연동 시 차량 번호 없으면 무조건 빠져 나가기
        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 연동 할인코드  끝(쿼리 시간) : ' + OCSTIME);
        dmTables.qryOCS.EnableControls;
        if not bIsPatient then begin
           logStr := logStr + #13#10 + ('환자 주차료 할인 테이블내 현재 차량 정보 없음!: '+'OCS할인처리 중단.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
           Exit;   //임시주석테스트
        end;
      end;
    except
      on E: Exception do begin
        logStr := logStr + #13#10 + ('환자번호 채번중 오류 발생 : ' + E.Message);
        Exit;
      end;
    end;
//    ExceptLogging('환자번호 채번 종료');
    {$ENDREGION}

    {$REGION '채번된 환자번호로 OCS할인'}
    try
      bIsAdmission := False;
      with dmTables.qryOCS do begin
        dmTables.qryOCS.DisableControls;
        tempString := '';
        I := 1;

        //for I := 1 to Length(sPATIENTNO) do begin
        for I := 1 to asPATIENTNO do begin
          if tempString = '' then begin
            tempString := 'IN (';
          end;
          tempString := tempString + '''' + QuotedStr(sPATIENTNO[I-1]) + '''';

          //if not (I = Length(sPATIENTNO)) then begin
          if not (I = asPATIENTNO) then begin
            tempString := tempString + ', ';
          end else begin
            tempString := tempString + ')';
          end;
        end;

//      //임시 테스트 용
        //nPID_str := 'IN (''''557733'''')';
        //nPID_str := 'IN (''''1405327'''')';
        //nPID_str := 'IN (''''289227'''')';
        //nPID_str := 'IN (''''1143595'''')';

         //nPID_str := 'IN (''''1129759'''')';
         //nPID_str := 'IN (''''1398524'''')';
        //bIsPatientUse := 1;
        //nPID_str := 'IN (''''1403044'''')';
        //nPID_str := 'IN (''''108701'''')';
        //tempString := nPID_str;//임시 테스트

        //nPID_str := 'IN (''''713902'''')';
//        nPID_str := 'IN (''''1413904'''')';
//        tempString := nPID_str;//임시 테스트


        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 당일 할인정보 획득 쿼리 시작(쿼리 시간) : ' + OCSTIME);
        //OCS DISCCD 주차할인 사유(01-외래,02-검사/촬영/건진/수술,03-입원/응급 수속,04-입원/응급 퇴원수속,05-기타(예외처리)
        Close;
        SQL.Clear;
        SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
        SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS Where PID ' + tempString + ' ');
        SQL.Add('ORDER BY DISCCD ASC, RCPTDD ASC, RCPTTM ASC '')');
        logStr := logStr + #13#10 + ('OCS 당일 할인정보 획득 쿼리 : ' + SQL.Text);
        Open;

        if RecordCount > 0 then begin
          SetLength(sDCCODE, RecordCount);
          SetLength(sRECEIPTDATE, RecordCount);
          SetLength(sPID, RecordCount);
          I := 1;
          //디비 속도 향상
          OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
          ExceptLogging('OCS 당일 할인정보 획득 쿼리 중간(쿼리 시간) : ' + OCSTIME);

          SQL_Field2 := FieldByName('DISCFLAG');
          SQL_Field3 := FieldByName('DISCCD');
          SQL_Field4 := FieldByName('RCPTDD');
          SQL_Field := FieldByName('PID');
          SQL_Field5 := FieldByName('HANDICAPRYN');

          while not Eof do begin
            //디비 속도 향상
            sDISCFLAG := SQL_Field2.AsString;
            sDISCCD   := SQL_Field3.AsString;
            sRCPTDD   := SQL_Field4.AsString;
            //nPID      := SQL_Field4.AsString;
            nPID      := SQL_Field.AsString;
            sHANDICAPRYN   := SQL_Field5.AsString;
            if sDISCFLAG = '02' then begin //시간
              if (sDISCCD = '01') or
                 (sDISCCD = '02') or
                 (sDISCCD = '03') or
                 (sDISCCD = '04') or
                 (sDISCCD = '06')then begin  //외래(제증명) 1시간 할인적용 추가
                 logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                 sDCCODE[I-1]      := sDISCCD; //tempString;
                 sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                      Copy(sRCPTDD, 5, 2) + '-' +
                                      Copy(sRCPTDD, 7, 2);

//            if FieldByName('DISCFLAG').AsString = '02' then begin //시간
//              if (FieldByName('DISCCD').AsString = '01') or
//                 (FieldByName('DISCCD').AsString = '02') or
//                 (FieldByName('DISCCD').AsString = '03') or
//                 (FieldByName('DISCCD').AsString = '04') then begin
//                logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE[I-1]      := FieldByName('DISCCD').AsString; //tempString;
//                {sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID[I-1] := FieldByName('PID').AsString;
                Inc(I);
              end else begin
                //logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
                logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+sDISCCD+'], '+'DISCFLAG : ['+sDISCFLAG+'] ');
              end;
            end
            else if sDISCFLAG = '01' then begin //당일
              if (sDISCCD = '05') then begin
                 logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                 sDCCODE[I-1]      := sDISCCD; //tempString;
                 sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                      Copy(sRCPTDD, 5, 2) + '-' +
                                      Copy(sRCPTDD, 7, 2);
                 sPID[I-1] := nPID;
                 Inc(I);
              end;
            end;
//            end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
//              if (FieldByName('DISCCD').AsString = '05') then begin
//                logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//
//
//                sDCCODE[I-1]      := FieldByName('DISCCD').AsString;
//                {sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                     Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end;
//            end;

            //if (not bHandicap) and (FieldByName('HANDICAPRYN').AsString = 'Y') then begin
            {if (not bHandicap) and (sHANDICAPRYN = 'Y') then begin
              logStr := logStr + #13#10 + ('['+sNowLprCarNo1+'] 차량 장애인 등록여부 확인됨.');
              bHandicap := True;
            end;}
            Next;
          end;
        end else begin
          logStr := logStr + #13#10 + ('OCS 당일 할인정보 테이블내 현재 차량 정보 없음!: 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
        end;

        OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
        ExceptLogging('OCS 전날 할인정보 획득 쿼리 시작(쿼리 시간) : ' + OCSTIME);
        Close;
        SQL.Clear;
        SQL.Add('Select * From OPENQUERY('+sLinkedDBName+', '' ');
        SQl.Add('Select * From '+sOCSDBName+'.PMOVPKDS_PAST Where PID ' + tempString + ' ');
        SQL.Add(' '')');
        logStr := logStr + #13#10 + ('OCS 전날 할인정보 획득 쿼리 : ' + SQL.Text);
        Open;

        if RecordCount > 0 then begin
          SetLength(sDCCODE_PAST, RecordCount);
          SetLength(sRECEIPTDATE_PAST, RecordCount);
          SetLength(sPID_PAST, RecordCount);
          I := 1;

          SQL_Field2 := FieldByName('DISCFLAG');
          SQL_Field3 := FieldByName('DISCCD');
          SQL_Field4 := FieldByName('RCPTDD');
          SQL_Field := FieldByName('PID');
          SQL_Field5 := FieldByName('HANDICAPRYN');

          while not Eof do begin
            //디비 속도 향상
            sDISCFLAG := SQL_Field.AsString;
            sDISCCD   := SQL_Field2.AsString;
            sRCPTDD   := SQL_Field3.AsString;
            //nPID      := SQL_Field4.AsString;
            nPID      := SQL_Field.AsString;
            sHANDICAPRYN   := SQL_Field5.AsString;
            if sDISCFLAG = '02' then begin //시간
              if (sDISCCD = '01') or
                 (sDISCCD = '02') or
                 (sDISCCD = '03') or
                 (sDISCCD = '04') then begin
                 logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                 ExceptLogging('시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                 sDCCODE[I-1]      := sDISCCD; //tempString;
                 sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                      Copy(sRCPTDD, 5, 2) + '-' +
                                      Copy(sRCPTDD, 7, 2);
                Inc(I);
              end else begin
                logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능'+', DISCCD : ['+sDISCCD+'], '+'DISCFLAG : ['+sDISCFLAG+'] ');
              end;
            end
            else if sDISCFLAG = '01' then begin //당일
              if (sDISCCD = '05') then begin
                 logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
                 ExceptLogging('전날 시간: '+'['+IntToStr(I)+'] : ' + sDISCCD);
                 sDCCODE[I-1]      := sDISCCD;
                 sRECEIPTDATE[I-1] := Copy(sRCPTDD, 1, 4) + '-' +
                                      Copy(sRCPTDD, 5, 2) + '-' +
                                      Copy(sRCPTDD, 7, 2);
                 sPID[I-1] := nPID;
                 Inc(I);
              end;
            end;
            Next;
          end;

//          while not Eof do begin
//            if FieldByName('DISCFLAG').AsString = '02' then begin //시간
//                 //전날 외래(01)나 기타외래(02)만 있을 경우 OCS할인 적용 안함
////              if (FieldByName('DISCCD').AsString = '01') or
////                 (FieldByName('DISCCD').AsString = '02') or
//              if (FieldByName('DISCCD').AsString = '03') or
//                 (FieldByName('DISCCD').AsString = '04') then begin
//                logStr := logStr + #13#10 + ('시간: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE_PAST[I-1]      := FieldByName('DISCCD').AsString; //tempString;
//                {sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID_PAST[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end else begin
//                logStr := logStr + #13#10 + ('병원에서 제공한 할인코드가 상이함.. 할인 불가능: '+'DISCCD : ['+FieldByName('DISCCD').AsString+'], '+'DISCFLAG : ['+FieldByName('DISCFLAG').AsString+'] ');
//              end;
//            end else if FieldByName('DISCFLAG').AsString = '01' then begin //당일
//              if (FieldByName('DISCCD').AsString = '05') then begin
//                logStr := logStr + #13#10 + ('당일: '+'['+IntToStr(I)+'] : ' + FieldByName('DISCCD').AsString);
//                sDCCODE_PAST[I-1]      := FieldByName('DISCCD').AsString;
//                {sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + ' ' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);}
//                sRECEIPTDATE_PAST[I-1] := Copy(FieldByName('RCPTDD').AsString, 1, 4) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 5, 2) + '-' +
//                                          Copy(FieldByName('RCPTDD').AsString, 7, 2);
//                sPID_PAST[I-1] := FieldByName('PID').AsString;
//                Inc(I);
//              end;
//            end;
//            Next;
//          end;
        end else begin
          logStr := logStr + #13#10 + ('OCS 전날 할인정보 테이블내 현재 차량 정보 없음!: '+'차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
        end;
        dmTables.qryOCS.EnableControls;
      end;

      bIsPast := False;
      asDCCODE := Length(sDCCODE);

      //if Length(sDCCODE) = 0 then begin
      if asDCCODE = 0 then begin
        //당일 할인이 한개도 없을경우, 전날할인을 본다
        sDCCODE      := sDCCODE_PAST;
        sRECEIPTDATE := sRECEIPTDATE_PAST;
        sPID         := sPID_PAST;
        bIsPast      := True;
      end;
      OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
      ExceptLogging('OCS 할인처리 시작(쿼리 시간) : ' + OCSTIME);
      asDCCODE := Length(sDCCODE);
      asDCCODE_PAST := Length(sDCCODE_PAST);


      //if Length(sDCCODE) > 0 then begin
      if asDCCODE > 0 then begin
        //for I := 0 to Length(sDCCODE) - 1 do begin
        for I := 0 to asDCCODE - 1 do begin
          nTempDCNo := 0;
          with dmTables.qryOCSProc do begin
            dmTables.qryOCSProc.DisableControls;
            if (bIsAdmission = True) and ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin
              logStr := logStr + #13#10 + ('입퇴원 할인받은 차량은 중복입원할인 불가능.');
            end else begin
              if ((sDCCODE[I] = '03') or (sDCCODE[I] = '04')) then begin
                //입원할인 처리 진입한경우 변수할당하여 입원할인 중복처리 불가하도록..
                bIsAdmission := True;
                //OCS에서 입원시작일 정보 가져오기
                if (sDCCODE[I] = '03') then begin //할인코드 03인경우 수납일 = 입원일임.
                  sAdmStartDate := sRECEIPTDATE[I];
                end else if (sDCCODE[I] = '04') then begin
                  if asDCCODE_PAST > 0 then begin
                    //if Length(sDCCODE_PAST) > 0 then begin
                    //for J := 0 to Length(sDCCODE_PAST) - 1 do begin
                    for J := 0 to asDCCODE_PAST - 1 do begin
                      if (sDCCODE_PAST[J] = '03') and (sPID_PAST[J] = sPID[I]) then begin
                        sAdmStartDate := sRECEIPTDATE_PAST[J]; //입원일 변수 할당
                      end;
                    end;

                    if sAdmStartDate = '' then begin
                      sAdmStartDate := sRECEIPTDATE[I];
                    end;
                  end else begin
                    sAdmStartDate := sRECEIPTDATE[I];
                  end;
                end;
//                 and (sDCCODE_PAST[I] = '03') then begin //당일 할인코드 04, 전날 할인코드 03인경우 전날 데이터 수납일 = 입원일임.
//                  sAdmStartDate := sRECEIPTDATE_PAST[I];
//                end else if (sDCCODE[I] = '04') and not (sDCCODE_PAST[I] = '03') then begin //당일 할인코드 04, 전날 할인코드 03이 아닌경우 당일 데이터가 수납일이됨.
//                  sAdmStartDate := sRECEIPTDATE[I];
//                end;

                //OCS에서 퇴원일 정보 가져오기
                if bIsPast then begin
                  sAdmEndDate := MG_AddDate(Copy(aString(lbOutTime.Caption), 1, 10), -1);
                end else begin
                  sAdmEndDate := Copy(aString(lbOutTime.Caption), 1, 10);
                end;

                logStr := logStr + #13#10 + ('입원일자 : ' + sAdmStartDate+ ', 퇴원일자 : ' + sAdmEndDate);

                //가져와진 입원일자랑 입차일자 비교 시작
                //if sAdmStartDate > Copy(aString(lbInTime.Caption), 1, 10) then begin
                if sAdmStartDate >= Copy(aString(lbInTime.Caption), 1, 10) then begin
                  sAdmStartDate := sAdmStartDate;
                end else begin
                  sAdmStartDate := Copy(aString(lbInTime.Caption), 1, 10);
                  //sAdmStartDate := '2020-11-23';
                end;

                //퇴원일자 조정 : 전날할인 들고왔을 경우에 시작일이 퇴원일보다 더클경우 문제발생
                if sAdmEndDate < sAdmStartDate then
                  sAdmEndDate := sAdmStartDate;

                  //sAdmStartDate :='2020-11-29';
                //보호자(6H), OCS 입원(6H) 할인은 입차후 24시간 할인 적용 시키도록 적용
                if (sDCCODE[I] = '03') or (sDCCODE[I] = '04') then
                begin
                  ExceptLogging('OCS Code: '+sDCCODE[I]);
//                   nAdmDateCount := DaysBetween(StrToDateTime(sAdmEndDate + ' 00:00:00'),
//                                               StrToDateTime(sAdmStartDate + ' 00:00:00')) + 1;
                   {if sAdmEndDate <> sAdmStartDate then
                   begin
                     nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                         IncHour(StrToDateTime(aString(lbInTime.Caption)), 24)) + 1;
                   end
                   else
                   begin
                      nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                         IncHour(StrToDateTime(aString(lbInTime.Caption)), 24));
                   end;}

                   //ExceptLogging('보호자 할인 할인 횟수 : '+inttostr(nAdmDateCount));

                  //보호자 할인 (6h)할인은 입차 후 24시간으로 계산 후 할인 적용  11.05
                  //우선 할인 적용 있는지 확인 여부
                  nprocdate := '';
                  nprocTime := '';
                  nFirstpdateTime := '';
                  nprocdate_nprocTime:='';
                  //입원 당시 날짜로 입차 최초의 할인 시간 및 날짜 조회 입차 후 24시간(1일) 계산  11.05
                  ExceptLogging('OCS 입원날짜 '+sAdmStartDate);

                  Close;
                  SQL.Clear;
                  SQL.Add('SELECT Top 1 * from IONDATA');
                  //SQL.Add('where ProcDate = :V1 AND InCarNo1 = :V2 ');
                  SQL.Add('where ProcDate = :V1 and InCarNo1 = :V2  ');
                  SQL.Add('order by procdate asc, proctime asc   ');
                  //SQL.Add('order by procdate desc, proctime desc   ');
                  Parameters.ParamByName('v1').Value := sAdmStartDate;
                  Parameters.ParamByName('v2').Value := sNowLprCarNo1;
                  ExceptLogging(sql.Text);
                  Open;

                  nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                      IncHour(StrToDateTime(aString(lbInTime.Caption)), 24));

                  ExceptLogging('OCS 할인 할인 횟수 : '+inttostr(nAdmDateCount));

                  if RecordCount > 0 then begin
                    //21.03.15 디비 속도 향상
                    SQL_Field6 := FieldByName('procdate');   //날짜
                    SQL_Field7 := FieldByName('procTime');   //시간
                    nprocdate  := SQL_Field6.AsString;
                    nprocTime  := SQL_Field7.AsString;

                    //nprocdate := FieldByName('procdate').AsString;   //날짜
                    //nprocTime := FieldByName('procTime').AsString;   //시간
                    nFirstpdateTime := nprocdate+' '+nprocTime;      //마지막 입차 날짜, 시간
                    //최초 입차 후 24시간 계산
                    //ExceptLogging('최초 입차 : '+ nprocdate+' '+nprocTime);
                    ExceptLogging('최초 입차 : '+ nFirstpdateTime);
                    nprocdate_nprocTime := DateTimetostr(IncHour(StrToDateTime(nprocdate+' '+nprocTime), 24));
                    ExceptLogging('최초 입차 후 24시간 후: '+ nprocdate_nprocTime);


                    //마지막 입차 후 24시간 후의 날짜 보다 현재 입차가 날짜가 크면 보호자 할인 시간 0분적용
                    if IncHour(StrToDateTime(aString(nFirstpdateTime)), 24) < StrToDateTime(aString(lbInTime.Caption)) then
                    begin
                          nAdmDateCount := 0;
//                        nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
//                                            IncHour(StrToDateTime(aString(lbInTime.Caption)), 24));
//                        ExceptLogging('보호자 할인 할인 횟수 : '+inttostr(nAdmDateCount));
//                        nFirstpdateTime := lbInTime.Caption;
//                        nprocdate_nprocTime := DateTimeToStr(IncHour(StrToDateTime(aString(lbInTime.Caption)), 24));
//                        ExceptLogging('보호자입차 : '+nFirstpdateTime);
//                        ExceptLogging('보호자입차(24시간 후) : '+nFirstpdateTime);
                    end
                    else
                    begin
                        //nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                        nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                    StrToDateTime(aString(lbOutTime.Caption)));

                        if nAdmDateCount = 0 then
                        begin
                           //nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                           nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                       StrToDateTime(aString(lbOutTime.Caption))) + 1;
                        end
                        else
                        begin
                           //nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                           nAdmDateCount:= DaysBetween(StrToDateTime(aString(nFirstpdateTime)),
                                                       StrToDateTime(aString(lbOutTime.Caption)));
                        end;
                        ExceptLogging('OCS 할인 할인 횟수(최초 입차 날짜 기준) : '+inttostr(nAdmDateCount));

                        nFirstpdateTime := nFirstpdateTime;
                        nprocdate_nprocTime := DateTimeToStr(IncHour(StrToDateTime(aString(nFirstpdateTime)), 24 * nAdmDateCount));
                        ExceptLogging('보호자입차2 : '+nFirstpdateTime);
                        ExceptLogging('보호자입차(24시간 후)2 : '+nprocdate_nprocTime);
                    end;

                    //보호자 할인 입차 후 24시간이내에      11.05
                    //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                    Close;
                    SQL.Clear;
                    SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                    SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                    SQL.Add('FROM DCDetail ');
                    SQL.Add('WHERE 1=1 ');
                    if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                    end else begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                    end;
                    //SQL.Add('AND ProcDate + ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND ProcDate +'' ''+ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                    SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                    Parameters.ParamByName('v1').Value := nFirstpdateTime; //nprocdate +' '+nprocTime;   //최초 입차
                    Parameters.ParamByName('v2').Value := nprocdate_nprocTime;        //입차 후 24시간
                    ExceptLogging(sql.Text);
                    Open;
                  end
                  else  //최조 입차 기록이 없을 경우
                  begin
                     //보호자 할인 입차 후 24시간이내에      11.05
                    //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                    //입차 기준으로 할인 시간 확인
                    nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                                StrToDateTime(aString(lbOutTime.Caption)));
                    ExceptLogging('OCS 할인 할인 횟수 3: '+inttostr(nAdmDateCount));
                    if nAdmDateCount = 0 then
                    begin
                       nAdmDateCount:= DaysBetween(StrToDateTime(aString(lbInTime.Caption)),
                                                   StrToDateTime(aString(lbOutTime.Caption))) + 1;
                       ExceptLogging('OCS 할인 할인 횟수4 : '+inttostr(nAdmDateCount));
                    end;

                    Close;
                    SQL.Clear;
                    SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                    SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                    SQL.Add('FROM DCDetail ');
                    SQL.Add('WHERE 1=1 ');
                    if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                    end else begin
                      SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                    end;
                    //SQL.Add('AND ProcDate + ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND ProcDate +'' ''+ProcTime BETWEEN :v1 and :v2');
                    SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                    SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                    Parameters.ParamByName('v1').Value := aString(lbInTime.Caption);   //최초 입차
                    Parameters.ParamByName('v2').Value := IncHour(StrToDateTime(aString(lbInTime.Caption)), 24);     //입차 후 24시간
                    ExceptLogging(sql.Text);
                    Open;
                  end;
                end
                else
                begin
                  nAdmDateCount := DaysBetween(StrToDateTime(sAdmEndDate + ' 00:00:00'),
                                               StrToDateTime(sAdmStartDate + ' 00:00:00')) + 1;
                   ExceptLogging('OCS 할인 할인 횟수 : '+inttostr(nAdmDateCount));
                  //차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                  Close;
                  SQL.Clear;
                  SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                  SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                  SQL.Add('FROM DCDetail ');
                  SQL.Add('WHERE 1=1 ');
                  if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                    SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                  end else begin
                    SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                  end;
                  SQL.Add('AND ProcDate BETWEEN :v1 and :v2');
                  SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                  SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                  Parameters.ParamByName('v1').Value := sAdmStartDate;
                  Parameters.ParamByName('v2').Value := sAdmEndDate;
                  ExceptLogging(sql.Text);
                  Open;
                end;
//                nAdmDateCount := DaysBetween(StrToDateTime(sAdmEndDate + ' 00:00:00'),
//                                             StrToDateTime(sAdmStartDate + ' 00:00:00')) + 1;

                logStr := logStr + #13#10 + ('입원할인 시작일자 : ' + sAdmStartDate+', 입원할인 종료일자 : ' + sAdmEndDate+', 입원할인 적용일수 : ' + IntToStr(nAdmDateCount));

                {//차감할인을 위해 현재차량이 입차일자에 입원할인 몇시간 받았는지 확인.
                Close;
                SQL.Clear;
                SQL.Add('SELECT SUM(RealDCMin) as dcsum FROM ( ');
                SQL.Add('SELECT ROW_NUMBER() OVER (PARTITION BY TKNo ORDER BY DCSeq DESC) AS IdxNo, * ');
                SQL.Add('FROM DCDetail ');
                SQL.Add('WHERE 1=1 ');
                if (sNowLprCarNo2 <> '') and (sNowLprCarNo1 <> sNowLprCarNo2) then begin
                  SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''' or CarNo = '''+sNowLprCarNo2+''') ');
                end else begin
                  SQL.Add('AND (CarNo = '''+sNowLprCarNo1+''') ');
                end;
                SQL.Add('AND ProcDate BETWEEN :v1 and :v2');
                SQL.Add('AND DCNo in (SELECT DCNo FROM DCInfo WHERE OcsCode In (''03'', ''04'')) ');
                SQL.Add(') AS Temp WHERE IdxNo = 1 ');
                Parameters.ParamByName('v1').Value := sAdmStartDate;
                Parameters.ParamByName('v2').Value := sAdmEndDate;
                ExceptLogging(sql.Text);
                Open;}

                //12.29 OCS 할인 시간 주차시간 1일 이상시 남은 시간 6시간 이내의 차량 할인 적용
                nAdmDateTime  := 0;
                nsAdmDateTime := 0;
                if nDayEx >= 1 then
                begin
                  if nHourEx <= 6 then   //6시간까지 할인 적용
                  begin
                     nAdmDateTime := nHourEx * 60 + nMinEx;
                     ExceptLogging(IntToStr(nDayEx)+' 일 '+'남은 주차시간(분) '+ IntToStr(nAdmDateTime));
                     nsAdmDateTime := nAdmDateTime;
                  end
                  else //6시간 초과시
                  begin
                     //nAdmDateTime := nHourEx * 60 + nMinEx;      //총 주차시간
                     //nAdmDateTime := nAdmDateTime - ((nHourEx - 6) * 60); //총 주차 시간 - 6시간 이후 의 남은 시간
                     nAdmDateTime := 360;
                     ExceptLogging(IntToStr(nDayEx)+' 일 '+'남은 주차시간(분)_6시간 초과  '+ IntToStr(nAdmDateTime));
                  end;
                  nsAdmDateCount := nDayEx;
                  ExceptLogging('구간 요금 일수 : '+ inttostr(nsAdmDateCount));
                end;

                //nTotRemainTime := 360 * nAdmDateCount;
                //nsAdmDateCount := nAdmDateCount + nsAdmDateCount;
                ExceptLogging('구간 요금 일수 : '+ inttostr(nsAdmDateCount));
                nTotRemainTime := 360 * nAdmDateCount + nAdmDateTime;
                if RecordCount > 0 then begin
                  //21.03.15 디비 속도 향상
                  SQL_Field8 := FieldByName('dcsum');
                  nAlreadyDCValue := SQL_Field8.AsInteger;
                  //nAlreadyDCValue := FieldByName('dcsum').AsInteger; //사용한 보호자시간
                  //nAlreadyDCValue := FieldByName('dcsum').AsInteger; //사용한 보호자시간
                  nRemainDCValue := nTotRemainTime - nAlreadyDCValue; //기존사용한 시간 차감
                end else begin
                  //결과가 없는 경우
                  nAlreadyDCValue := 0;
                  nRemainDCValue := nTotRemainTime; //매일 보호자에게 부여되는 무료출차시간 360분*일수
                end;
                ExceptLogging('[총가용시간(분)] '+ IntToStr(nTotRemainTime));
                ExceptLogging('[이전 사용시간/남은시간(분)] '+IntToStr(nAlreadyDCValue) + '/'+IntToStr(nRemainDCValue));

                Close;
                SQL.Clear;
                //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );

                if sDCInTime2 <> '' then   //OCS 중복 할인(01,02코드시) 시
                begin
                   if lbOutTime.Caption < sDCInTime  then    //출차 시간보다 입차 시간이 큰 경우
                   begin
                      sDCInTime := lbOutTime.Caption;
                   end;

                   SQL.Add('select datediff(mi,'+QuotedStr(sDCInTime)+' , '+QuotedStr(lbOutTime.Caption)+')' );

                end
                else  //OCS 중복 할인 안할시
                begin
                   //자동입차
                   SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                   //수동 입차
                   //SQL.Add('select datediff(mi,'+QuotedStr(lbInTime.Caption)+' , '+QuotedStr(lbOutTime.Caption)+')' );
                end;
                //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
                Open;
                ExceptLogging(SQL.Text);
                if RecordCount > 0 then begin
                  nowUseTime := Fields[0].AsInteger;
                  ExceptLogging('[현재주차시간(분)] '+IntToStr(nowUseTime));
                  if nowUseTime > (nTotRemainTime - nAlreadyDCValue) then begin
                    overuseTime := abs(nTotRemainTime-nAlreadyDCValue-nowUseTime);
                    nAlreadyDCValue := nTotRemainTime;
                  end else if nowUseTime = (nTotRemainTime - nAlreadyDCValue) then begin
                    nAlreadyDCValue := nTotRemainTime;
                    overUseTime := 0;
                  end else begin
                    nAlreadyDCValue := nAlreadyDCValue + nowUseTime;
                    nRemainDCValue := nTotRemainTime - nAlreadyDCValue;
                    overUseTime := 0;
                  end;
                  ExceptLogging('[사용시간/초과사용시간(분)] '+IntToStr(nAlreadyDCValue)+'/'+IntToStr(overuseTime));
                end;

                //10.19 초과 사용 시간(분) 경우  (남은 주차 시간 계산)
                if nAlreadyDCValue > 0 then begin
                  //입원일 당일이 입원재입차인경우, 해당시간만큼 차감하여 계산.
                  //if nRemainDCValue > 0 then begin
                  //21.01.09 보호자 시간이 없거나 주차시간 초과 한 경우
                  if (nRemainDCValue > 0)  then begin
                    nISCCD := sDCCODE[I]; //보호자 할인 적용
                    nRemainDCValue := OCSAdminDCDetail(nRemainDCValue);     //차감할인 적용
                  end
                  else
                  begin
                     ExceptLogging('보호자 남은시간(분) '+inttostr(nRemainDCValue)+ 'OCS할인적용 안됨');
                  end;
                end
                else
                begin
                  //입원 후 24시간 후 입차 시 할인 적용이 안되도록 설정(최초 요금 부과)
                  if sDCInTime <> '' then
                  begin
                  end
                  else
                  begin
                    edtProcYogum.Text := inttostr(nTotYogum2);
                    nProcYogum := nTotYogum2;
                    lbDCName.Caption := '';
                    edtDC.Text:='';
                  end;

                end;
                edtDCRemain.Text := IntToStr(nRemainDCValue);
                ExceptLogging('[실제남은시간] '+ edtDCRemain.Text);

                { noverYunm := 0;
                if overuseTime > 0 then
                begin

                   sEndDateTime := MG_AddTime(lbOutTime.Caption, 0, overuseTime, 0, 0);
                   ExceptLogging('요금계산일:'+ lbOutTime.Caption + ' ~ '+ sEndDateTime);

                   nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),
                                                                PAnsiChar(Copy(sEndDateTime, 1, 16)));
                   noverYunm := nTimeDC;

                   edtProcYogum.Text := IntToStr(noverYunm);
                   nProcYogum := noverYunm;
                   ExceptLogging('[초과 사용 시간에 대한 주차요금]: '+ IntToStr(noverYunm));
                end;}

                {if nAlreadyDCValue > 0 then begin
                  //입원일 당일이 입원재입차인경우, 해당시간만큼 차감하여 계산.
                  if nRemainDCValue > 0 then begin
                    nRemainDCValue := OCSAdminDCDetail(nRemainDCValue);     //차감할인 적용
                  end;
                end;
                edtDCRemain.Text := IntToStr(nRemainDCValue);
                ExceptLogging('[실제남은시간] '+ edtDCRemain.Text);  }
//                if (sDCCODE[I] = '04') and (nAdmDateCount > 0) then begin
                  //출차일이 퇴원일일경우 퇴원할인으로 변경처리
//                  nAdmDateCount := nAdmDateCount - 1;

//                  Close;
//                  SQL.Clear;
//                  SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
//                  Parameters.ParamByName('DCCODE').Value := '04';
//                  Open;
//
//                  if RecordCount > 0 then begin
//                    nTempDCNo := FieldByName('DCNo').AsInteger;
//                  end else begin
//                    logStr := logStr + #13#10 + ('OCS할인코드 [04]넥스파 할인코드 매칭안됨 확인요망.');
//                  end;
//
//                  if nTempDCNo > 0 then begin
//                    OCSDCDetail(nTempDCNo);
//                  end;
//                end;

//                Close;
//                SQL.Clear;
//                SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
//                Parameters.ParamByName('DCCODE').Value := '03';
//                Open;
//
//                if RecordCount > 0 then begin
//                  nTempDCNo := FieldByName('DCNo').AsInteger;
//                end else begin
//                  logStr := logStr + #13#10 + ('OCS할인코드 [03]넥스파 할인코드 매칭안됨 확인요망.');
//                end;
//
//                if nAdmDateCount > 1 then begin //2일이상 있다가 나가면
//                  if nRemainDCValue > 0 then begin //현재일로 보호자차감시간이 있으면 할인
//                    OCSDCDetailEx(nTempDCNo,nAdmDateCount); //6시간 차감같은경우 한번에 할 수 있도록
//                  end else begin
//                    OCSDCDetailEx(nTempDCNo,nAdmDateCount-1); //6시간 차감같은경우 한번에 할 수 있도록
//                  end;
//                end else if nAdmDateCount = 1 then begin //당일있다가 나가면
//                  if nRemainDCValue > 0 then begin //현재일로 보호자차감시간이 있으면 할인
//                    OCSDCDetailEx(nTempDCNo,nAdmDateCount); //6시간 차감같은경우 한번에 할 수 있도록
//                  end;
//                end;


//                if nAdmDateCount > 0 then begin
//                  for J := 1 to nAdmDateCount do begin
//                    if nTempDCNo > 0 then begin
//                      OCSDCDetail(nTempDCNo);
//                    end;
//                  end;
//                end;
              end else begin
                //일반할인
                //재입차시 반복부여 가능
                ExceptLogging('OCS Code: '+sDCCODE[I]);
                ExceptLogging('OCS 입원일자: '+sRECEIPTDATE[I]);
                //nsAdmStartDate := sRECEIPTDATE[I];

                Close;
                SQL.Clear;
                SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
                Parameters.ParamByName('DCCODE').Value := sDCCODE[I];
                Open;

                if RecordCount > 0 then begin
                  //nTempDCNo := FieldByName('DCNo').AsInteger;
                  //21.03.15 디비 속도 향상
                  SQL_Field9 := FieldByName('DCNo');
                  nTempDCNo := SQL_Field9.AsInteger;
                end else begin
                  logStr := logStr + #13#10 + ('OCS할인코드 ['+sDCCODE[I]+']넥스파 할인코드 매칭안됨 확인요망.');
                end;

                if nTempDCNo > 0 then begin
                  OCSDCDetail(nTempDCNo);
                end;
              end;
            end;
            dmTables.qryOCSProc.EnableControls;
          end;
        end;
        //2020-04-28 대전성모 수정사항 : OCS연동할인 후 추가할인키 입력인 안되도록 설정
        DCEnable(False);
      end else begin
        logStr := logStr + #13#10 + ('환자 주차료 할인 테이블내 현재 차량 정보 없음!: '+'OCS할인처리 중단.... 차번 ['+sNowLprCarNo1+'] 입차일자 ['+lbInTime.Caption+'] TKNO ['+sNowTKno+']');
        nISCCD :=''; //OCS할인코드
      end;
    except
      on E: Exception do begin
        logStr := logStr + #13#10 + ('채번된 환자번호로 OCS할인정보 획득 중 오류 발생 : ' + E.Message);
        Exit;
      end;
    end;
    {$ENDREGION}
    OCSTIME := FormatDateTime('yyyy-mm-dd hh:nn:ss:zzz', Now());
    ExceptLogging('OCS 할인처리 끝(쿼리 시간) : ' + OCSTIME);
    {$REGION '장애인 및 국가유공자 처리'}
    //11.22 장애인 국가 유공자 처리 유인 쪽 에서는 수동으로 할인키로 적용 시키도록 함
    //그 이유: 장애인이 아닌 차량이 할인 적용 된다고 해서 이부분 처리 안함
    //추후에 필요하면 적용 되도록 하는데 지금은 안정화가 필요한 상태
    {if bNational then begin
      with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Text := 'Select * From DCInfo Where OcsCode = :National ';
        Parameters.ParamByName('National').Value := 'NA';
        Open;

        nTempDCNo := 0;
        if RecordCount > 0 then begin
          nTempDCNo := FieldByName('DCNo').AsInteger;
          if nTempDCNo > 0 then begin
            OCSDCDetail(nTempDCNo);
            logStr := logStr + #13#10 + ('국가유공자 할인추가');
          end else begin
          end;
        end else begin
        end;
      end;
    end;

    if bHandicap and not bNational then begin //국가유공자 처리하면 장애인은 처리안함 - 중복불가요청 대전성모병원
      with dmTables.qryOCS do begin
        Close;
        SQL.Clear;
        SQL.Text := 'Select * From DCInfo Where OcsCode = :National ';
        Parameters.ParamByName('National').Value := 'HD';
        Open;

        nTempDCNo := 0;
        if RecordCount > 0 then begin
          nTempDCNo := FieldByName('DCNo').AsInteger;
          if nTempDCNo > 0 then begin
            OCSDCDetail(nTempDCNo);
            logStr := logStr + #13#10 + ('장애인 할인추가');
          end else begin
          end;
        end else begin
          Exit;
        end;
      end;
    end;}
    {$ENDREGION}
  finally
    sPATIENTNO := nil;
    sDCCODE := nil;
    dmTables.qryOCS.Active := False;

    sDCCODE_PAST := nil; //병원에 등록된 OCS할인정보 변수 초기화
    sRECEIPTDATE := nil;   //병원에 등록된 수납일자 변수
    sRECEIPTDATE_PAST := nil; //병원에 등록된 수납일자 변수

    tempString :='';

    logStr := logStr + #13#10 + ('OCS 할인처리 종료');
    ExceptLogging(logStr);
  end;
end;

// OCS할인권 처리...
procedure TfrmMainNew.OCSDCDetail(nDiscountCode: Integer);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa, nValue,nValue1, nTimeDC1,nTypeCode: Integer;
  sName, sYogum, sUpche, sCheckDate: aString;
  i, nChk, nDCType: Byte;
  sReserveDiscount : aString;
  nDCFeeno : Integer;
  //디비 속도 향상
  OCS_DC_Field, OCS_DC_Field2, OCS_DC_Field3, OCS_DC_Field4, OCS_DC_Field5, OCS_DC_Field6: TField;
  asYogum : Integer;
  SoverDCOutTime : aString;
begin
  try
    //디비 속도 향상
    OCS_DC_Field := TField.Create(Self);
    OCS_DC_Field2 := TField.Create(Self);
    OCS_DC_Field3 := TField.Create(Self);
    OCS_DC_Field4 := TField.Create(Self);
    OCS_DC_Field5 := TField.Create(Self);

    with dmTables.qryDCTemp do begin
      dmTables.qryDCTemp.DisableControls;
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= nDiscountCode;
      Open;
      if RecordCount > 0 then begin
        //21.03.15 디비 속도 향상
        OCS_DC_Field := FieldByName('DCType');
        OCS_DC_Field2 := FieldByName('DCName');
        OCS_DC_Field3 := FieldByName('DCValue');
        OCS_DC_Field4 := FieldByName('Reserve3');
        OCS_DC_Field5 := FieldByName('FeeNo');
        OCS_DC_Field6 := FieldByName('DCValue');

        nDCType:= OCS_DC_Field.AsInteger;
        sName  := OCS_DC_Field2.AsString;
        nValue := OCS_DC_Field3.AsInteger;
        sReserveDiscount := OCS_DC_Field4.AsString;
        nDCFeeno         := OCS_DC_Field5.AsInteger;
        //11.28 외래 나 기타외래 시에는 총 합산기준으로 주차요금 계산
        nDCValue := nDCValue + OCS_DC_Field6.AsInteger;
        nDCValue2:= nDCValue;
//        nDCType:= FieldByName('DCType').AsInteger;
//        sName:= FieldByName('DCName').AsString;
//        nValue:= FieldByName('DCValue').AsInteger;
//        sReserveDiscount := FieldByName('Reserve3').AsString;
//        nDCFeeno           := FieldByName('FeeNo').AsInteger;
//        //11.28 외래 나 기타외래 시에는 총 합산기준으로 주차요금 계산
//        nDCValue:= nDCValue + FieldByName('DCValue').AsInteger;
      end;

      //OCS할인 기타외래(4H) 이나 외래 (6H)가 시간이 초과되고  100% 할인 발생함.
      //OCS할인 재증명(6H) 앞에 입원이나 보호자 코드가 있을 시 100% 할인 발생함
      if nDCType = 1 then
      begin
        if nOcsCode = '06' then //재증명(6H)
        begin
          ExceptLogging('OCS Code(06): 재증명(1H) 할인 시작 시작일자:'+nDCInTime);
          Close;
          SQL.Clear;
          //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(nDCInTime)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
          SQL.Add('select datediff(ss,'+QuotedStr(nDCInTime)+' , '+QuotedStr(lbOutTime.Caption)+') / 60 ' );
          ExceptLogging(SQL.Text);
          Open;
        end
        else
        begin
          Close;
          SQL.Clear;
          //SQL.Add('select datediff(mi,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ')' );
          SQL.Add('select datediff(ss,(select max(btime) from (select procdate+' +QuotedStr(' ')+ '+proctime bTime from IONData where procdate+'' ''+ proctime=' +QuotedStr(lbInTime.Caption)+' and InCarNo1 ='+QuotedStr(sNowLprCarNo1)+' and OutDate is NULL ) t1), '+QuotedStr(lbOutTime.Caption)+ ') / 60 ' );
          ExceptLogging(SQL.Text);
          Open;
        end;

        if RecordCount > 0 then begin
          nowUseTime := Fields[0].AsInteger;
          ExceptLogging('[총 할인 시간(분)] '+IntToStr(nDCValue));
          ExceptLogging('[현재주차 시간(분)] '+IntToStr(nowUseTime));
          if nDCValue > nowUseTime then
          begin
             overUseTime := 0;
             ExceptLogging('[남은  주차시간(분)] '+IntToStr(nDCValue - nowUseTime));
          end
          else
          begin
            //overUseTime := nowUseTime - nDCValue; //초과 추차시간 = 총  주차시간 -  총할인 시간
            if nowUseTime > nValue then
            begin
               overUseTime := nowUseTime - nValue; //남은 추차시간 = 총  주차시간 -  할인 시간
               ExceptLogging('[초과  주차시간(분)] '+IntToStr(overUseTime));
            end
            else
            begin
               //overUseTime := nValue - nowUseTime; //남은 추차시간 = 할인 시간 - 총  주차시간
               ExceptLogging('[초과  주차시간(분)2] '+IntToStr(nValue - nowUseTime));
            end;
          end;
        end
        else
        begin
           nDCValue := 0;
           sName := '';
           ExceptLogging('[총 할인 시간(분)] '+IntToStr(nDCValue));
        end;

      end;
      dmTables.qryDCTemp.EnableControls;
    end;
    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;

    InspectionLog('OCS할인: ' + IntToStr(nDiscountCode) + ', ' + IntToStr(nValue) + ', ' + sName );
    if nProcYogum > 0 then
    begin
      Case nDCType of
        0:
        begin // 금액할인.
          nDCCnt := nDCCnt + 1;

          if nProcYogum >= nValue then
          begin
            nProcYogum := nProcYogum - nValue;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nValue;
            nDCYogum := nDCYogum + nJulsa;

            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nValue + nJulsa;
              nRealDCAmt := nValue + nJulsa;
              nDCType := 0;
              nTypeCode := 0;   //할인종류 구분 : 0 기본할인 1: 충전할인 2: 후불할인
              nDCKind :=  1;                    // 버튼/웹 구분 : 1 : 버튼 할인, 2 웹할인
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + nProcYogum;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nValue;
              nRealDCAmt := nProcYogum;
              nDCType := 0;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        1:
        begin // 시간할인.
          nDCCnt := nDCCnt + 1;
          //sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
          if nOcsCode = '06' then //재증명(6H)
          begin
            sDCOutTime := MG_AddTime(lbOutTime.Caption, 0, -nDCValue, 0, 0);
            nDCInTime  := MG_AddTime(nDCInTime, 0, 0, 0, 0);
            ExceptLogging('OCS Code(06): 재증명(1H) 할인계산 시작일자:' + nDCInTime+' 출차일자:'+sDCOutTime);
            if sDCOutTime < lbintime.Caption then
            begin
              ExceptLogging('OCS 06(1H)할인 시각이 입차보다 작음 요금계산' );
              if overUseTime > 0 then    //주차 시간 초과 한 만큼 요금 계산
              begin
                nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(nDCInTime, 1, 16)),
                                                                            PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
                ExceptLogging('OCS 06(1H)할인 시각 초과 요금 '+inttostr(nTimeDC) );
              end
              else
              begin
                 nTimeDC := nProcYogum;
                 DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                    ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                        - StrToDateTime(lbInTime.Caption)) * 24 * 60);
                ExceptLogging('OCS 06(1H)할인 시각 초과 안된요금 '+inttostr(nTimeDC) );
              end;
            end
            else
            begin
              if overUseTime > 0 then
              begin
                nTimeDC := DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(nDCInTime, 1, 16)),
                                                               PAnsiChar(Copy(sDCOutTime, 1, 16)),3);
                ExceptLogging('OCS 06(1H)초과 요금 :' +Inttostr(nTimeDC));

                if nProcYogum <= nTimeDC then
                begin
                    ExceptLogging('OCS 06(1H)할인 요금이 현재요금 '+inttostr(nProcYogum));
                    nProcYogum := nProcYogum + nTimeDC;
                    nTimeDC := nProcYogum;
                    ExceptLogging('OCS 06(1H)할인 요금이 합산요금 '+inttostr(nProcYogum)+ '/'+inttostr(nTimeDC));
                end;

                if nProcYogum >= 13000 then
                begin
                   nTimeDC := nProcYogum;
                   ExceptLogging('OCS 06(1H)할인 1일 요금(13000원)초과  '+inttostr(nTimeDC));
                end;
              end
              else
              begin
                nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(nDCInTime, 1, 16)),
                                                                            PAnsiChar(Copy(sDCOutTime, 1, 16)),3);
                ExceptLogging('OCS 06(1H)할인 요금 :' +Inttostr(nTimeDC));
              end;
            end;
          end
          else
          begin
            sDCOutTime := MG_AddTime(lbOutTime.Caption, 0, -nDCValue, 0, 0);
            sDCInTime  := MG_AddTime(sDCInTime, 0, nDCValue, 0, 0);

            sDCInTime2 := MG_AddTime(sDCInTime, 0, nDCValue, 0, 0);
            sDCOutTime2 := MG_AddTime(lbOutTime.Caption, 0, -nDCValue, 0, 0);

            if sDCOutTime < lbintime.Caption then
            begin
              if overUseTime > 0 then    //주차 시간 초과 한 만큼 요금 계산
              begin
                nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                            PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
              end
              else
              begin
                 nTimeDC := nProcYogum;
                 DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                    ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                        - StrToDateTime(lbInTime.Caption)) * 24 * 60);

              end;
            end
            else
            begin
              {nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                PAnsiChar(Copy(sDCOutTime, 1, 16)));}

              if overUseTime > 0 then
              begin
                nTimeDC := DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                               PAnsiChar(Copy(sDCOutTime, 1, 16)),3);

              end
              else
              begin
                nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                            PAnsiChar(Copy(sDCOutTime, 1, 16)),3);

              end;
  //            nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
  //                                                                        PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
  //
  //            DCProc[nDCCnt].nRealDCMin := nValue;
            end;
          end;

          if nProcYogum >= nTimeDC then
          begin
            if nOcsCode = '06' then //재증명(6H)
            begin
              if overUseTime = 0 then //할인 시간이 초과 되지 않는 경우
              begin
                  ExceptLogging('재증명(1H-06)코드 중복할인시간 초과안됨');
                  nProcYogum := nProcYogum - nTimeDC;
                  nDCYogum := nDCYogum + nTimeDC;     //할인 금액
              end
              else   //할인 시간이 초과
              begin
                 ExceptLogging('재증명(1H-06)코드 중복할인시간 초과');
                 if sDCInTime2 <> '' then //OCS 중복할인 시
                 begin
                    //nProcYogum  := nProcYogum + nTimeDC;
                    nProcYogum  := nTimeDC;
                    nDCYogum := nTotYogum - nProcYogum; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
                    ExceptLogging('중복 재증명(1H-06) 할인 요금: ' +Inttostr(nProcYogum));
                 end
                 else //단독OCS(06) 할인시
                 begin
                    nProcYogum := nTimeDC;
                    nDCYogum := nTotYogum - nTimeDC;
                    ExceptLogging('단독 재증명(1H-06)코드 할인 요금: ' +Inttostr(nProcYogum));
                 end;
              end;
              sDCInTime2  := MG_AddTime(nDCInTime, 0, nDCValue, 0, 0);
              ExceptLogging('OCS Code(06): 재증명(1H) 할인계산 이후 시작일자:' + sDCInTime2+' 출차일자:'+sDCOutTime);
            end
            else
            begin
              if overUseTime = 0 then //할인 시간이 초과 되지 않는 경우
              begin
                  nProcYogum := nProcYogum - nTimeDC;
                  nDCYogum := nDCYogum + nTimeDC;     //할인 금액
              end
              else   //할인 시간이 초과
              begin
                  nProcYogum := nTimeDC;
                  nDCYogum := nTotYogum - nTimeDC; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
              end;
            end;

            //nProcYogum := nProcYogum - nTimeDC;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            //nDCYogum := nDCYogum + nTimeDC;
            nDCYogum := nDCYogum + nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);
            asYogum := Length(sYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            //for i := 1 to Length(sYogum) do
            for i := 1 to asYogum do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;

	            if overUseTime > 0 then
              begin
                nDCAmt := nTotYogum - nTimeDC;
                nRealDCAmt := nTotYogum - nTimeDC;
              end
              else
              begin
                nDCAmt := nTimeDC + nJulsa;
                nRealDCAmt := nTimeDC + nJulsa;
              end;
              //nDCAmt := nTimeDC + nJulsa;
              //nRealDCAmt := nTimeDC + nJulsa;
              nDCType := 1;
              nTypeCode := 0;
              if bufBarc <> '' then   //바코드 태그 구별
              begin
                nDCKind :=  4;
              end
              else     //OCS 연동
              begin
                 nDCKind :=  1;
              end;
              //nDCKind :=  1;

              if nowUseTime >= nDCValue then   //할인 시간이 오바 되었을대
              begin
                 //nRealDCMin := nDCValue;
                 nRealDCMin := nValue;
              end
              else
              begin
                if nowUseTime mod nDCValue > 0 then
                begin
                   nRealDCMin := nowUseTime mod nDCValue;
                end
                else
                begin
                   //nRealDCMin := nDCValue;
                   nRealDCMin := nValue;
                end;
              end;
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + nTimeDC;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC;
              nRealDCAmt := nProcYogum;
              nDCType := 1;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        2:
        begin // 퍼센트할인.
          if edtDC.Text = '' then begin //50%할인 전에 할인내역이 하나도없으면
            nProcYogum := DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                              PAnsiChar(Copy(sDCOutTime, 1, 16)),2);
          end;

          nDCCnt := nDCCnt + 1;
          nPerDC := (nProcYogum * nValue) div 100;

          if nProcYogum >= nPerDC then
          begin
            nProcYogum := nProcYogum - nPerDC;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nPerDC;
            nDCYogum := nDCYogum + nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nPerDC + nJulsa;
              nRealDCAmt := nPerDC + nJulsa;
              nDCType := 2;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + nPerDC;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nPerDC;
              nRealDCAmt := nProcYogum;
              nDCType := 2;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        3:
        begin // 복합할인 = 시간할인 + % 할인
          nDCCnt := nDCCnt + 1;
          sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
          if sDCOutTime < lbintime.Caption then
          begin
            nTimeDC := 0;
          end
          else
          begin
            nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                              PAnsiChar(Copy(sDCOutTime, 1, 16)));
          end;
          nTimeDC := nTimeDC  * nValue1 div 100;

          if nProcYogum >= nTimeDC then
          begin
            nDCYogum := nDCYogum +(nProcYogum- nTimeDC);
            nDCYogum := nDCYogum + nJulsa;
            nProcYogum := nTimeDC;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC + nJulsa;
              nRealDCAmt := nTimeDC + nJulsa;
              nDCType := 3;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + 0;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC;
              nRealDCAmt := nProcYogum;
              nDCType := 3;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        4:
        begin // 고객부담. (시간할인 부분 고정금액)
          nDCCnt := nDCCnt + 1;
          sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
          sDCInTime  := MG_AddTime(sDCInTime, 0, nValue, 0, 0);
          nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                PAnsiChar(Copy(sDCInTime, 1, 16)));
          if nProcYogum >= nTimeDC then
          begin

            nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
            nProcYogum := nProcYogum - nTimeDC + nValue1;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC -nValue1  + nJulsa;
              nRealDCAmt := nDCYogum + nJulsa;
              nDCType := 4;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end
          else
          begin
            if nValue1 > nProcYogum  then
            begin
              nDCYogum := nDCYogum;
              nProcYogum := nProcYogum;
            end
            else
            begin
              nDCYogum := nDCYogum + nProcYogum - nValue1;
              nProcYogum := nValue1;
            end;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);
            lbDCName.Caption := sName;

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              if nValue1 > nTimeDC then
              begin
                nDCAmt := 0;
              end
              else
              begin
                nDCAmt := nTimeDC -nValue1 ;
              end;
              nRealDCAmt := nDCYogum;
              nDCType := 4;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end;
        end;
      end;
      InspectionLog('할인요금: ' + edtDCYogum.Text);

      if edtDC.Text = '' then
      begin
        edtDC.Text := sName;
      end
      else
      begin
        edtDC.Text := edtDC.Text + ', ' + sName;
      end;
    end;
    InspectionLog('할인요금: ' + edtDCYogum.Text);
    if bufBarc <> '' then
    begin
       lbDCName.Caption := sName;
    end
    else
    begin
       lbDCName.Caption := 'OCS연동할인';
    end;

  except
    on E: Exception do ExceptLogging('TfrmMainNew.OCSDCDetail: ' + aString(E.Message));
  end;
end;

procedure TfrmMainNew.OCSDCDetailEx(nDiscountCode, sameDcCnt: Integer);
var
  nTimeDC, // 시간할인시 할인된 금액.
  nPerDC, // 퍼센트할인시 할인된 금액.
  nJulsa, nValue,nValue1, nTimeDC1,nTypeCode: Integer;
  sName, sYogum, sUpche, sCheckDate: aString;
  i, nChk, nDCType: Byte;
  sReserveDiscount : aString;
  nDCFeeno : Integer;
begin
  try
    with dmTables.qryDCTemp do begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from DCInfo where DCNo = :N1');
      Parameters.ParamByName('N1').Value:= nDiscountCode;
      Open;

      if RecordCount > 0 then begin
        nDCType:= FieldByName('DCType').AsInteger;
        sName:= FieldByName('DCName').AsString;
        nValue:= FieldByName('DCValue').AsInteger * sameDcCnt;
        sReserveDiscount := FieldByName('Reserve3').AsString;
        nDCFeeno           := FieldByName('FeeNo').AsInteger;
      end;
    end;
    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;

    InspectionLog('OCS할인: ' + IntToStr(nDiscountCode) + ', ' + IntToStr(nValue) + ', ' + sName );
    if nProcYogum > 0 then
    begin
      Case nDCType of
        0:
        begin // 금액할인.
          nDCCnt := nDCCnt + 1;

          if nProcYogum >= nValue then
          begin
            nProcYogum := nProcYogum - nValue;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nValue;
            nDCYogum := nDCYogum + nJulsa;

            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy(sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nValue + nJulsa;
              nRealDCAmt := nValue + nJulsa;
              nDCType := 0;
              nTypeCode := 0;   //할인종류 구분 : 0 기본할인 1: 충전할인 2: 후불할인
              nDCKind :=  1;                    // 버튼/웹 구분 : 1 : 버튼 할인, 2 웹할인
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + nProcYogum;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nValue;
              nRealDCAmt := nProcYogum;
              nDCType := 0;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        1:
        begin // 시간할인.
          nDCCnt := nDCCnt + 1;
          sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
          sDCInTime  := MG_AddTime(sDCInTime, 0, nValue, 0, 0);
          if sDCOutTime <lbintime.Caption then
          begin
            nTimeDC := nProcYogum;
            DCProc[nDCCnt].nRealDCMin := nValue + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
          end
          else
          begin
            nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                              PAnsiChar(Copy(sDCOutTime, 1, 16)));
          end;
          ExceptLogging('할인요금(장애인,국가유공자 제외): '+IntToStr(nTimeDC));
          if nProcYogum >= nTimeDC then
          begin
            nProcYogum := nProcYogum - nTimeDC;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nTimeDC;
            nDCYogum := nDCYogum + nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            for i := 0 to sameDcCnt-1 do begin
              with DCProc[nDCCnt] do
              begin
                nDCNo := nDiscountCode;
                sDCName := sName;
                nDCAmt := Trunc(nTimeDC/sameDcCnt) + nJulsa;
                nRealDCAmt := Trunc(nTimeDC/sameDcCnt) + nJulsa;
                nDCType := 1;
                nTypeCode := 0;
                nDCKind :=  1;
                DCProc[nDCCnt].nRealDCMin := Trunc(nValue / sameDcCnt);
              end;
              Inc(nDCCnt);
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + nTimeDC;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC;
              nRealDCAmt := nProcYogum;
              nDCType := 1;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        2:
        begin // 퍼센트할인.
          nDCCnt := nDCCnt + 1;
          nPerDC := (nProcYogum * nValue) div 100;

          if nProcYogum >= nPerDC then
          begin
            nProcYogum := nProcYogum - nPerDC;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nPerDC;
            nDCYogum := nDCYogum + nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nPerDC + nJulsa;
              nRealDCAmt := nPerDC + nJulsa;
              nDCType := 2;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + nPerDC;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nPerDC;
              nRealDCAmt := nProcYogum;
              nDCType := 2;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        3:
        begin // 복합할인 = 시간할인 + % 할인
          nDCCnt := nDCCnt + 1;
          sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
          if sDCOutTime < lbintime.Caption then
          begin
            nTimeDC := 0;
          end
          else
          begin
            nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                              PAnsiChar(Copy(sDCOutTime, 1, 16)));
          end;
          nTimeDC := nTimeDC  * nValue1 div 100;

          if nProcYogum >= nTimeDC then
          begin
            nDCYogum := nDCYogum +(nProcYogum- nTimeDC);
            nDCYogum := nDCYogum + nJulsa;
            nProcYogum := nTimeDC;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC + nJulsa;
              nRealDCAmt := nTimeDC + nJulsa;
              nDCType := 3;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end
          else
          begin
            nDCYogum := nDCYogum + 0;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;

            for i := 6 downto 2 do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
              end;
            end;
            lbYogum1.Caption := '0';
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC;
              nRealDCAmt := nProcYogum;
              nDCType := 3;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
            nProcYogum := 0;
            edtProcYogum.Text := '0';
          end;
        end;

        4:
        begin // 고객부담. (시간할인 부분 고정금액)
          nDCCnt := nDCCnt + 1;
          sDCOutTime := MG_AddTime(sDCOutTime, 0, -nValue, 0, 0);
          sDCInTime  := MG_AddTime(sDCInTime, 0, nValue, 0, 0);
          nTimeDC := DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                PAnsiChar(Copy(sDCInTime, 1, 16)));
          if nProcYogum >= nTimeDC then
          begin

            nDCYogum := nProcYogum - (nProcYogum - nTimeDC + nValue1);
            nProcYogum := nProcYogum - nTimeDC + nValue1;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            nDCYogum := nDCYogum + nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;
            lbDCName.Caption := sName;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              nDCAmt := nTimeDC -nValue1  + nJulsa;
              nRealDCAmt := nDCYogum + nJulsa;
              nDCType := 4;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end
          else
          begin
            if nValue1 > nProcYogum  then
            begin
              nDCYogum := nDCYogum;
              nProcYogum := nProcYogum;
            end
            else
            begin
              nDCYogum := nDCYogum + nProcYogum - nValue1;
              nProcYogum := nValue1;
            end;
            edtDCYogum.Text := IntToStr(nDCYogum);
            edtDCYogum.AutoThousandSeparator := True;
            nJulsa := JulsaProc(nProcYogum);
            nProcYogum := nProcYogum - nJulsa;
            edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
            edtDCYogum.AutoThousandSeparator := True;
            sYogum := IntToStr(nProcYogum);
            lbDCName.Caption := sName;

            for i := 1 to 6 do
            begin
              with frmMainNew do
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := False;
            end;

            for i := 1 to Length(sYogum) do
            begin
              with frmMainNew do
              begin
                TLabel(FindComponent('lbYogum' + IntToStr(i)))
                  .Visible := True;
                TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
                  (sYogum, Length(sYogum) - (i - 1), 1);
              end;
            end;

            with DCProc[nDCCnt] do
            begin
              nDCNo := nDiscountCode;
              sDCName := sName;
              if nValue1 > nTimeDC then
              begin
                nDCAmt := 0;
              end
              else
              begin
                nDCAmt := nTimeDC -nValue1 ;
              end;
              nRealDCAmt := nDCYogum;
              nDCType := 4;
              nTypeCode := 0;
              nDCKind :=  1;
            end;
          end;
        end;
      end;
      InspectionLog('할인요금: ' + edtDCYogum.Text);

      for i := 0 to sameDcCnt-1 do begin
        if edtDC.Text = '' then begin
          edtDC.Text := sName;
        end else begin
          edtDC.Text := edtDC.Text + ', ' + sName;
        end;
      end;
    end;
    InspectionLog('할인요금: ' + edtDCYogum.Text);
    lbDCName.Caption := 'OCS연동할인';
  except
    on E: Exception do ExceptLogging('TfrmMainNew.OCSDCDetailEx: ' + aString(E.Message));
  end;

end;

// OCS 병원 중복할인
function TfrmMainNew.OCSAdminDCDetail(nDCValue: Integer): Integer;
var
  i : Integer;
  nTimeDC : Integer;
  nJulsa : Integer;
  sYogum : aString;
  nTempDCNo : Integer;
  sTempDCName : aString;
  nDCFeeNo : Integer;
  //디비 속도 향상
  OCS_DC_Field, OCS_DC_Field2, OCS_DC_Field3: TField;
  asYogum, sDCYogum, sDCYogum2, nYoumTimeDC, nTotalTimeDC : Integer;
  sOCSDCInTime, sOCSDCOutTime : aString;
  sStartDateTime, sStartDateTime2 : aString;
  sCompareDateTime, nTotalnowUseTime : Integer;
begin
  try
    Result := 0;
    nTimeDC := 0;
    //디비 속도 향상
    OCS_DC_Field  := TField.Create(self);
    OCS_DC_Field2 := TField.Create(self);
    OCS_DC_Field3 := TField.Create(self);
    with dmTables.qryOCSDCInfo do begin
      //퇴원수속 할인
      dmTables.qryOCSDCInfo.DisableControls;
      Close;
      SQL.Clear;
      SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
      if (nISCCD = '04') then  //10.26 보호자 할인 적용
      begin
         Parameters.ParamByName('DCCODE').Value := '04';
      end
      else
      begin
         Parameters.ParamByName('DCCODE').Value := '03';
      end;
      //Parameters.ParamByName('DCCODE').Value := '03';
      Open;

      if RecordCount > 0 then begin
        //nTempDCNo := FieldByName('DCNo').AsInteger;
        //sTempDCName := FieldByName('DCName').AsString;
        //nDCFeeNo := FieldByName('FeeNo').AsInteger;
        //21.03.15 디비 속도 향상
        OCS_DC_Field := FieldByName('DCNo');
        OCS_DC_Field2 := FieldByName('DCName');
        OCS_DC_Field3 := FieldByName('FeeNo');
        nTempDCNo   := OCS_DC_Field.AsInteger;
        sTempDCName := OCS_DC_Field2.AsString;
        nDCFeeNo    := OCS_DC_Field3.AsInteger;
        ExceptLogging('OCS할인코드 '+inttostr(nTempDCNo)+', '+sTempDCName);
        InspectionLog('OCS할인코드: '+inttostr(nTempDCNo)+', '+sTempDCName);
      end else begin
        ExceptLogging('OCS할인코드 [03] or [04] 넥스파 할인코드 매칭안됨 확인요망.');
      end;
      dmTables.qryOCSDCInfo.EnableControls;
    end;
    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;
  except
    on E: Exception do begin
      ExceptLogging('OCSAdminDCDetail : DB할인권 조회중 오류발생');
    end;
  end;

  try
    nDCCnt := nDCCnt + 1;
    if sDCInTime2 <> '' then    //ocs중복할인
    begin
      sDCInTime2 := sDCInTime;
      ExceptLogging(sDCInTime);
    end;

    if (nDCValue > 0) and (overUseTime = 0) then begin //아직 보호자 차감시간이 있으면 0원
      nTimeDC := nProcYogum;
      DCProc[nDCCnt].nRealDCMin := nowUseTime;
      Result := nDCValue;
    end else begin //보호자차감시간이 없으면 초과사용시간 요금계산
      if nowUseTime - overUseTime > 0 then begin
        ExceptLogging('보호자 차감 시간 : '+IntToStr(nowUseTime));
        ExceptLogging('보호자 초과 시간 : '+IntToStr(overUseTime));
        sDCOutTime := MG_AddTime(sDCOutTime, 0, -(nowUseTime - overUseTime), 0, 0);
        if sDCInTime2 <> '' then   //OCS 중복 할인(01,02코드시)
        begin
           sDCInTime2 := MG_AddTime(sDCInTime2, 0, (nowUseTime - overUseTime), 0, 0);
           sDCOutTime2:= MG_AddTime(sDCOutTime2, 0, -(nowUseTime - overUseTime), 0, 0);
        end
        else //OCS 중복 할인 안함
        begin
           //sDCInTime  := MG_AddTime(sDCInTime, 0, (nowUseTime - overUseTime), 0, 0);
           //sDCInTime2 := MG_AddTime(sDCInTime2, 0, (nowUseTime - overUseTime), 0, 0);
        end;
        //sDCInTime  := MG_AddTime(sDCInTime, 0, (nowUseTime - overUseTime), 0, 0);
        //sDCInTime2 := MG_AddTime(sDCInTime2, 0, (nowUseTime - overUseTime), 0, 0);    //보호자 차감 시간에 따른 웹할인 중복 할인

        ExceptLogging(sDCInTime);
        ExceptLogging(sDCOutTime);

        ExceptLogging(sDCInTime2);
        ExceptLogging(sDCOutTime2);
        if sDCOutTime < lbintime.Caption then begin   //입차 시간보다 출차시간이 작으면
          {if overUseTime > 0 then    //주차 시간 초과 한 만큼 요금 계산
          begin
//            nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                                        PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
            if sDCInTime2 <> '' then
            begin
//              nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sDCInTime), 1, 16)),
//                                                              PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),4);

              nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                              PAnsiChar(Copy(aString(sDCOutTime2), 1, 16)),4);
            end
            else
            begin
               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
            end;
          end
          else
          begin
            nTimeDC := nProcYogum;
            DCProc[nDCCnt].nRealDCMin := (nowUseTime - overUseTime) + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
            ExceptLogging(IntToStr(DCProc[nDCCnt].nRealDCMin));
          end;}

          nTimeDC := nProcYogum;
          DCProc[nDCCnt].nRealDCMin := (nowUseTime - overUseTime) + Trunc
                ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                    - StrToDateTime(lbInTime.Caption)) * 24 * 60);
          ExceptLogging(IntToStr(DCProc[nDCCnt].nRealDCMin));
        end else begin
          if overUseTime > 0 then    //주차 시간 초과 한 만큼 요금 계산
          begin
//            nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                                        PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));

//             nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                             PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));

            if sDCInTime2 <> '' then      //OCS중복할인
            begin
//              nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sDCInTime), 1, 16)),
//                                                              PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),4);

//               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                               PAnsiChar(Copy(aString(sDCOutTime2), 1, 16)),4);

               //22.03.22 1일 이상 주차 시 1일 보호자(6시간) 차감 구간 나누어서 할인 처리
               nYoumTimeDC := 0;
               nTotalnowUseTime := nowUseTime - overUseTime;
               ExceptLogging('총 주차 시간(구간요금)계산 : '+IntToStr(nTotalnowUseTime));

               if Copy(lbInTime.Caption,1,10) <> Copy(lbOutTime.Caption,1,10) then
               begin
                 if nsAdmDateCount > 0 then //1일 이상
                 begin
                   for I := 0 to nsAdmDateCount do
                   begin
                     //뒤에서 주차 시간 할인(6시간 보호자 및 입원 할인) 구간으로 나누어서 계산
                     sStartDateTime := DateTimeToStr(IncHour(StrToDateTime(aString(lbInTime.Caption)), 24 *(I + 1)));
                     sCompareDateTime := CompareDate(StrToDateTime(lbOutTime.Caption), StrToDateTime(sStartDateTime));

                     if sCompareDateTime = -1 then  //입차 후 24시간 보다 출차 시간이 작은 경우
                     begin
                        if ((nHourEx = 6) and (nMinEx = 0) and (nSecEx = 0) ) or ((nHourEx <= 5) and (nMinEx = 59)) then   //6시간까지 할인 적용
                        begin
                           ExceptLogging(IntToStr(i+1) + '일 총 주차요금 (보호자6시간이전 이라서 요금 적용안함)  : ' + IntToStr(nYoumTimeDC));
                           nTimeDC := nTotalTimeDC;
                        end
                        else
                        begin
                          sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                          //출차 시간보다 출차 할인 시간이 작을 경우
                          if (sOCSDCOutTime < lbOutTime.Caption) or (sOCSDCOutTime > lbOutTime.Caption)  then
                          begin
                              sOCSDCOutTime := lbOutTime.Caption;
                              ExceptLogging(sOCSDCOutTime);
                              //sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -nsAdmDateTime, 0, 0);
                          end;

                          if (sStartDateTime2 > lbOutTime.Caption) then
                          begin
                              sStartDateTime2 := lbOutTime.Caption;
                              ExceptLogging(sStartDateTime2);
                          end;
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          ExceptLogging(IntToStr(i+1) + '일 주차요금(중복할인)2 : ' + IntToStr(nYoumTimeDC));
                          nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                          ExceptLogging(IntToStr(i+1) + '일 총 주차요금(중복할인)2 : ' + IntToStr(nTotalTimeDC));
                          nTimeDC := nTotalTimeDC;
                        end;
                     end
                     else
                     begin
                        if nTotalnowUseTime >= 360 then
                        begin
                           sOCSDCOutTime := MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -360, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(중복할인)계산 : '+IntToStr(nTotalnowUseTime));
                        end
                        else
                        begin
                           sOCSDCOutTime := MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(중복할인)계산2 : '+IntToStr(nTotalnowUseTime));
                        end;

                        if i = 0 then //첫째날
                        begin
                          //sOCSDCInTime:= MG_AddTime(Copy(aString(lbInTime.Caption), 1, 16), 0, nDCValue2, 0, 0);
                          //ExceptLogging('주차 시간(중복할인 후 입차계산)  : '+sOCSDCInTime);
                          sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -(360 + nDCValue2), 0, 0);
                          //sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -360, 0, 0);
                          ExceptLogging('주차 시간(중복할인 후 입차계산)  : '+sOCSDCOutTime);
                          //if sOCSDCInTime >  sOCSDCOutTime then
                          {if sOCSDCInTime >  sOCSDCOutTime then
                          begin
                             sOCSDCOutTime := sOCSDCInTime;
                          end;}
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                          //nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sOCSDCInTime), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end
                        else
                        begin
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end;
                        ExceptLogging(IntToStr(i+1) + '일 주차요금(중복할인) : ' + IntToStr(nYoumTimeDC));
                        if nYoumTimeDC  > 13000 then    //하루에 주차 요금이 13000원 보다 크면 최대 요금(13000원) 부과
                        begin
                           nYoumTimeDC := 13000;
                           ExceptLogging(IntToStr(i+1) + '일 주차요금(중복할인2) : ' + IntToStr(nYoumTimeDC));
                        end;
                        nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                        ExceptLogging(IntToStr(i+1) + '일 총 주차요금(중복할인) : ' + IntToStr(nTotalTimeDC));
                        nTimeDC := nTotalTimeDC;
                     end;
                   end;
                 end
                 else  //1일이 안된경우(중복할인)
                 begin
                    //sOCSDCInTime:= MG_AddTime(Copy(aString(lbInTime.Caption), 1, 16), 0, nDCValue2, 0, 0);
                    //ExceptLogging('주차 시간(당일 중복할인 후 입차계산)  : '+sOCSDCInTime);
                    //sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -(360+nDCValue2), 0, 0);
                    {if overUseTime > 360 then
                    begin
                       overUseTime := overUseTime - 360;
                       ExceptLogging('보호자 할인 시간(중복할인) : '+ inttostr(overUseTime));
                    end
                    else
                    begin
                       overUseTime := 360 - overUseTime;
                       ExceptLogging('보호자 할인 시간(중복할인2) : '+ inttostr(overUseTime));
                    end;
                    //sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -(360+nDCValue2), 0, 0);
                    sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -(overUseTime+nDCValue2), 0, 0);
                    //if sOCSDCInTime > sOCSDCOutTime then
                    if lbInTime.Caption > sOCSDCOutTime then  //입차 시간보다 6시간+중복할인시간이 작을 때
                    begin
                       //sOCSDCOutTime := sOCSDCInTime;
                       sOCSDCOutTime := lbInTime.Caption;
                    end;
                    ExceptLogging('주차 시간(1일안됨 중복할인 후 입차계산2)  : '+sOCSDCOutTime);
                    nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                    PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4); }
                     nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                     PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),5);
                 end;
               end
               else
               begin
                 nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
               end;
            end
            else   //OCS중복할인 안함
            begin
               //21.03.18 1일 이상 주차 시 1일 보호자(6시간) 차감 구간 나누어서 할인 처리
               nYoumTimeDC := 0;
               nTotalnowUseTime := nowUseTime - overUseTime;
               ExceptLogging('총 주차 시간(구간요금)계산 : '+IntToStr(nTotalnowUseTime));
               if Copy(lbInTime.Caption,1,10) <> Copy(lbOutTime.Caption,1,10) then
               begin
                 if nsAdmDateCount > 0 then  //1일 이상 주차시
                 begin
                   for I := 0 to nsAdmDateCount do
                   begin
                     //뒤에서 주차 시간 할인(6시간 보호자 및 입원 할인) 구간으로 나누어서 계산
                     sStartDateTime := DateTimeToStr(IncHour(StrToDateTime(aString(lbInTime.Caption)), 24 *(I + 1)));
                     sCompareDateTime := CompareDate(StrToDateTime(lbOutTime.Caption), StrToDateTime(sStartDateTime));

                     if sCompareDateTime = -1 then  //입차 후 24시간 보다 출차 시간이 작은 경우
                     begin
                        if ((nHourEx = 6) and (nMinEx = 0) and (nSecEx = 0)) or ((nHourEx <= 5) and (nMinEx = 59)) then  //6시간까지 할인 적용
                        begin
                           ExceptLogging(IntToStr(i+1) + '일 총 주차요금 (보호자6시간이전 이라서 요금 적용안함)  : ' + IntToStr(nYoumTimeDC));
                           nTimeDC := nTotalTimeDC;
                        end
                        else
                        begin
                            sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                            //출차 시간보다 출차 할인 시간이 클 경우
                            if (sOCSDCOutTime < lbOutTime.Caption)  or (sOCSDCOutTime > lbOutTime.Caption)  then
                            begin
                                sOCSDCOutTime   := lbOutTime.Caption;
                                ExceptLogging(sOCSDCOutTime);
                                //sOCSDCOutTime   := MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -nsAdmDateTime, 0, 0);
                            end;

                            if (sStartDateTime2 > lbOutTime.Caption) then
                            begin
                                sStartDateTime2 := lbOutTime.Caption;
                                ExceptLogging(sStartDateTime2);
                            end;

                            nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                                PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
      //                      nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
      //                                                                          PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),4);
                            ExceptLogging(IntToStr(i+1) + '일 주차요금(할인시간)2 : ' + IntToStr(nYoumTimeDC));
                            nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                            ExceptLogging(IntToStr(i+1) + '일 총 주차요금(할인시간)2 : ' + IntToStr(nTotalTimeDC));
                            nTimeDC := nTotalTimeDC;
                        end;
                     end
                     else
                     begin
                        //sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -(nowUseTime - overUseTime), 0, 0);
                        //sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -360, 0, 0);
                        if nTotalnowUseTime >= 360 then
                        begin
                           sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -360, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(구간요금)계산 : '+IntToStr(nTotalnowUseTime));
                        end
                        else
                        begin
                           sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(구간요금)계산2 : '+IntToStr(nTotalnowUseTime));
                        end;

                        if i = 0 then     //첫째날
                        begin
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end
                        else
                        begin
                          //nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime), 1, 10)+' '+'00:00'),
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end;
                        ExceptLogging(IntToStr(i+1) + '일 주차요금(할인시간) : ' + IntToStr(nYoumTimeDC));
                        if nYoumTimeDC  > 13000 then    //하루에 주차 요금이 13000원 보다 크면 최대 요금(13000원) 부과
                        begin
                           nYoumTimeDC := 13000;
                           ExceptLogging(IntToStr(i+1) + '일 주차요금(할인시간2) : ' + IntToStr(nYoumTimeDC));
                        end;
                        nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                        ExceptLogging(IntToStr(i+1) + '일 총 주차요금(할인시간) : ' + IntToStr(nTotalTimeDC));
                        nTimeDC := nTotalTimeDC;
                     end;
                   end;
                 end
                 else  //1일이 안된경우
                 begin
                    {sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -360, 0, 0);
                    ExceptLogging(' 1일 안됨 주차 시간  : ' + sOCSDCOutTime);
                    if Copy(aString(lbInTime.Caption), 1, 16) > sOCSDCOutTime then    //입차시간 6시간 차감보다 작을 때
                    begin
                       //sOCSDCOutTime := sOCSDCInTime;
                       sOCSDCOutTime := lbInTime.Caption;
                    end;
                    ExceptLogging(' 1일 안됨 주차 시간  : ' + sOCSDCOutTime);}
                    nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                    PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
                 end;
               end
               else
               begin
                 nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
               end;

               //sDCInTime2 := MG_AddTime(sDCInTime2, 0, (nowUseTime - overUseTime), 0, 0);
//               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
            end;
          end
          else    //보호차 차감 시간(360분) 초과가 안될 시
          begin
            if sDCInTime2 <> '' then     //OCS중복 할인 시
            begin
//               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sDCInTime), 1, 16)),
//                                                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),4);
                  nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                  PAnsiChar(Copy(aString(sDCOutTime2), 1, 16)),4);
            end
            else  //OCS중복 할인 안함
            begin
               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
            end;

//            nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                                                        PAnsiChar(Copy(sDCOutTime, 1, 16)));

          end;
//          nTimeDC := nProcYogum - DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                            PAnsiChar(Copy(sDCOutTime, 1, 16)));
          DCProc[nDCCnt].nRealDCMin := (nowUseTime - overUseTime);
        end;
      end else begin
        sDCOutTime := MG_AddTime(sDCOutTime, 0, -overUseTime, 0, 0);
        sDCInTime  := MG_AddTime(sDCInTime, 0, overUseTime, 0, 0);
        if sDCOutTime <lbintime.Caption then begin
          nTimeDC := nProcYogum;
          DCProc[nDCCnt].nRealDCMin := overUseTime + Trunc
                ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                    - StrToDateTime(lbInTime.Caption)) * 24 * 60);
        end else begin
//          nTimeDC := nProcYogum - DJSM_FeeCalc(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
//                                            PAnsiChar(Copy(sDCOutTime, 1, 16)));
          DCProc[nDCCnt].nRealDCMin := 0;
        end;
      end;
    end;

    nTimeDC := Abs(nTimeDC);

    if nProcYogum >= nTimeDC then
    begin
      if overUseTime = 0 then //할인 시간이 초과 되지 않는 경우
      begin
        nProcYogum := nProcYogum - nTimeDC;
        nDCYogum := nDCYogum + nTimeDC;     //할인 금액
      end
      else   //할인 시간이 초과
      begin
        if sDCInTime2 <> '' then   //ocs 중복 할인시
        begin
          sDCYogum  := StrToInt( StringReplace(edtDCYogum.Text, ',', '', [rfReplaceAll]) );
          sDCYogum2 := sDCYogum;
          //sDCYogum := nTotYogum - nTimeDC - sDCYogum;
          sDCYogum := nTotYogum - nTimeDC - sDCYogum;
          nProcYogum := nTimeDC;
          //nDCYogum   := sDCYogum; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
          nDCYogum   := nTotYogum - nTimeDC;
        end
        else
        begin
          nProcYogum := nTimeDC;
          nDCYogum   := nTotYogum - nTimeDC; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
        end;

        //nDCYogum := nProcYogum - nTimeDC;
      end;
      //nProcYogum := nProcYogum - nTimeDC;
      nJulsa := JulsaProc(nProcYogum);
      nProcYogum := nProcYogum - nJulsa;
      //nDCYogum := nDCYogum + nTimeDC;
      nDCYogum := nDCYogum + nJulsa;
      edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
      edtDCYogum.Text := IntToStr(nDCYogum);
      edtDCYogum.AutoThousandSeparator := True;
      sYogum := IntToStr(nProcYogum);

      for i := 1 to 6 do
      begin
        with frmMainNew do
          TLabel(FindComponent('lbYogum' + IntToStr(i)))
            .Visible := False;
      end;
      asYogum := Length(sYogum);
      //for i := 1 to Length(sYogum) do
      for i := 1 to asYogum do
      begin
        with frmMainNew do
        begin
          TLabel(FindComponent('lbYogum' + IntToStr(i)))
            .Visible := True;
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
            (sYogum, Length(sYogum) - (i - 1), 1);
        end;
      end;
      lbDCName.Caption := sTempDCName;

      with DCProc[nDCCnt] do begin
        nDCNo := nTempDCNo;
        sDCName := sTempDCName;
        if overUseTime > 0 then
        begin
          if sDCInTime2 <> '' then  //ocs 중복 할인시
          begin
            nDCAmt := sDCYogum;
            nRealDCAmt := sDCYogum;
          end
          else
          begin
            nDCAmt := nTotYogum - nTimeDC;
            nRealDCAmt := nTotYogum - nTimeDC;
          end;
          //nDCAmt := nTotYogum - nTimeDC;
          //nRealDCAmt := nTotYogum - nTimeDC;
        end
        else
        begin
          nDCAmt := nTimeDC + nJulsa;
          nRealDCAmt := nTimeDC + nJulsa;
        end;
        //nDCAmt := nTimeDC + nJulsa;
        //nRealDCAmt := nTimeDC + nJulsa;
        nDCType := 1;
        nTypeCode := 0;
        nDCKind :=  1;
      end;

    end
    else
    begin
      nDCYogum := nDCYogum + nTimeDC;
      edtDCYogum.Text := IntToStr(nDCYogum);
      edtDCYogum.AutoThousandSeparator := True;

      for i := 6 downto 2 do
      begin
        with frmMainNew do
        begin
          TLabel(FindComponent('lbYogum' + IntToStr(i)))
            .Visible := False;
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
        end;
      end;
      lbYogum1.Caption := '0';
      lbDCName.Caption := sTempDCName;

      with DCProc[nDCCnt] do
      begin
        nDCNo := nTempDCNo;
        sDCName := sTempDCName;
        nDCAmt := nTimeDC;
        nRealDCAmt := nProcYogum;
        nDCType := 1;
        nTypeCode := 0;
        nDCKind :=  1;
      end;
      nProcYogum := 0;
      edtProcYogum.Text := '0';
    end;

    if (nDCValue > 0) and (overUseTime = 0) then begin //아직 보호자 차감시간이 있으면 0원
      if edtDC.Text = '' then
      begin
        edtDC.Text := sTempDCName;
      end
      else
      begin
        edtDC.Text := edtDC.Text + ', ' + sTempDCName;
      end;
    end else begin

      if edtDC.Text = '' then
      begin
        edtDC.Text := sTempDCName;
      end
      else
      begin
        edtDC.Text := edtDC.Text + ', ' + sTempDCName;
      end;
      if i > 0 then
        DCProc[i] := DCProc[nDCCnt];
        //DCProc[i].nRealDCMin := 360;
      if nDCValue mod 360 > 0 then begin
         DCProc[i].nRealDCMin := nDCValue mod 360;
      end
      else
      begin
         DCProc[i].nRealDCMin := 360;
      end;

      {for i := 1 to (nDCValue div 360) do begin

        if edtDC.Text = '' then
        begin
          edtDC.Text := sTempDCName;
        end
        else
        begin
          edtDC.Text := edtDC.Text + ', ' + sTempDCName;
        end;
        if i > 0 then
          DCProc[i] := DCProc[nDCCnt];
        DCProc[i].nRealDCMin := 360;
      end;
      //nDCCnt := (nDCValue div 360);
      if nDCValue mod 360 > 0 then begin
        if edtDC.Text = '' then
        begin
          edtDC.Text := sTempDCName;
        end
        else
        begin
          edtDC.Text := edtDC.Text + ', ' + sTempDCName;
        end;
        if nDCCnt > 0 then
        begin
          DCProc[i] := DCProc[nDCCnt];
          DCProc[i].nRealDCMin := nDCValue mod 360;
        end;
        //DCProc[i] := DCProc[nDCCnt];
        //DCProc[i].nRealDCMin := nDCValue mod 360;
        inc(nDCCnt);
      end;}

    end;
     InspectionLog('할인요금: ' + edtDCYogum.Text);

  except
    on E: Exception do begin
      ExceptLogging('OCSAdminDCDetail : ' + E.Message);
    end;
  end;
end;
function TfrmMainNew.OCSAdminDCDetail_DCTime(nTimeDC: Integer): Integer;
var
 i, asYogum, sDCYogum,
 sDCYogum2, nJulsa : Integer;
 sYogum : aString;
begin
 try
    nTimeDC := Abs(nTotalTimeDC2);
    InspectionLog('할인 전 요금: ' + IntToStr(nTimeDC));
    if nProcYogum >= nTimeDC then
    begin
      if overUseTime = 0 then //할인 시간이 초과 되지 않는 경우
      begin
        nProcYogum := nProcYogum - nTimeDC;
        nDCYogum := nDCYogum + nTimeDC;     //할인 금액
      end
      else   //할인 시간이 초과
      begin
        if sDCInTime2 <> '' then   //ocs 중복 할인시
        begin
          sDCYogum  := StrToInt( StringReplace(edtDCYogum.Text, ',', '', [rfReplaceAll]) );
          sDCYogum2 := sDCYogum;
          sDCYogum := nTotYogum - nTimeDC - sDCYogum2;
          //sDCYogum := nTotYogum - nTimeDC;
          nProcYogum := nTimeDC;
          //할인 시간 초과시 할인 금액이 맞지 않아서  수정
          nDCYogum   := nTotYogum - nTimeDC;
        end
        else
        begin
          nProcYogum := nTimeDC;
          nDCYogum   := nTotYogum - nTimeDC; //할인 시간 초과시 할인 금액이 맞지 않아서  수정
        end;
      end;
      InspectionLog('할인 후 요금: ' + IntToStr(nProcYogum));
      nJulsa := JulsaProc(nProcYogum);
      nProcYogum := nProcYogum - nJulsa;
      nDCYogum := nDCYogum + nJulsa;
      edtProcYogum.Text := FormatFloat('#,##0', nProcYogum);
      edtDCYogum.Text := IntToStr(nDCYogum);
      edtDCYogum.AutoThousandSeparator := True;
      sYogum := IntToStr(nProcYogum);

      for i := 1 to 6 do
      begin
        with frmMainNew do
          TLabel(FindComponent('lbYogum' + IntToStr(i)))
            .Visible := False;
      end;
      asYogum := Length(sYogum);
      for i := 1 to asYogum do
      begin
        with frmMainNew do
        begin
          TLabel(FindComponent('lbYogum' + IntToStr(i)))
            .Visible := True;
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := Copy
            (sYogum, Length(sYogum) - (i - 1), 1);
        end;
      end;
      lbDCName.Caption := sTempDCName;

      with DCProc[nDCCnt] do begin
        nDCNo := nTempDCNo;
        sDCName := sTempDCName;
        if overUseTime > 0 then
        begin
          if sDCInTime2 <> '' then  //ocs 중복 할인시
          begin
            nDCAmt := sDCYogum;
            nRealDCAmt := sDCYogum;
          end
          else
          begin
            nDCAmt := nTotYogum - nTimeDC;
            nRealDCAmt := nTotYogum - nTimeDC;
          end;
        end
        else
        begin
          nDCAmt := nTimeDC + nJulsa;
          nRealDCAmt := nTimeDC + nJulsa;
        end;
        sDCTKNo := nDCTKNO; //21.05.25 환자할인번호 추가 작업
        nDCType := 1;
        nTypeCode := 0;
        //nDCKind :=  1;
        if bufBarc <> '' then
        begin
          nDCKind :=  4;
        end
        else
        begin
           nDCKind :=  1;
        end;
      end;

    end
    else
    begin
      nDCYogum := nDCYogum + nTimeDC;
      edtDCYogum.Text := IntToStr(nDCYogum);
      edtDCYogum.AutoThousandSeparator := True;

      for i := 6 downto 2 do
      begin
        with frmMainNew do
        begin
          TLabel(FindComponent('lbYogum' + IntToStr(i)))
            .Visible := False;
          TLabel(FindComponent('lbYogum' + IntToStr(i))).Caption := '0';
        end;
      end;
      lbYogum1.Caption := '0';
      lbDCName.Caption := sTempDCName;

      with DCProc[nDCCnt] do
      begin
        nDCNo := nTempDCNo;
        sDCName := sTempDCName;
        nDCAmt := nTimeDC;
        nRealDCAmt := nProcYogum;
        sDCTKNo := nDCTKNO; //21.05.25 환자할인번호 추가 작업
        nDCType := 1;
        nTypeCode := 0;
        if bufBarc <> '' then
        begin
          nDCKind :=  4;
        end
        else
        begin
           nDCKind :=  1;
        end;
        //nDCKind :=  1;
      end;
      nProcYogum := 0;
      edtProcYogum.Text := '0';
    end;

    if (nDCValue > 0) and (overUseTime = 0) then begin //아직 보호자 차감시간이 있으면 0원
        if edtDC.Text = '' then
        begin
          edtDC.Text := sTempDCName;
        end
        else
        begin
          edtDC.Text := edtDC.Text + ', ' + sTempDCName;
        end;
    end else begin
      if edtDC.Text = '' then
      begin
        edtDC.Text := sTempDCName;
      end
      else
      begin
        edtDC.Text := edtDC.Text + ', ' + sTempDCName;
      end;
      if i > 0 then
        DCProc[i] := DCProc[nDCCnt];
      if nDCValue mod 360 > 0 then begin
         DCProc[i].nRealDCMin := nDCValue mod 360;
      end
      else
      begin
         DCProc[i].nRealDCMin := 360;
      end;
    end;
   InspectionLog('할인요금: ' + edtDCYogum.Text);
 except
    on E: Exception do begin
      ExceptLogging('OCSAdminDCDetail_DCTime : ' + E.Message);
    end;
 end;
end;

function TfrmMainNew.OCSAdminDCDetail_Ex(nDCValue: Integer): Integer;
var
  i, nTimeDC, nDCFeeNo,
  nYoumTimeDC, nTotalTimeDC, sCompareDateTime,
  nTotalnowUseTime : Integer;
  sStartDateTime, sStartDateTime2,
  sOCSDCInTime, sOCSDCOutTime : aString;
  //디비 속도 향상
  OCS_DC_Field, OCS_DC_Field2, OCS_DC_Field3: TField;
begin
  try
    Result := 0;
    nTimeDC := 0;
    sYounmCount := 0;
    //디비 속도 향상
    OCS_DC_Field  := TField.Create(self);
    OCS_DC_Field2 := TField.Create(self);
    OCS_DC_Field3 := TField.Create(self);
    //퇴원수속 할인
    dmTables.qryOCSDCInfo.DisableControls;
    dmTables.qryOCSDCInfo.Close;
    dmTables.qryOCSDCInfo.SQL.Clear;
    dmTables.qryOCSDCInfo.SQL.Text := 'Select * From DCInfo Where OcsCode = :DCCODE ';
    if (nISCCD = '04') then  //10.26 보호자 할인 적용
    begin
       dmTables.qryOCSDCInfo.Parameters.ParamByName('DCCODE').Value := '04';
    end
    else
    begin
       dmTables.qryOCSDCInfo.Parameters.ParamByName('DCCODE').Value := '03';
    end;
    dmTables.qryOCSDCInfo.Open;
    if dmTables.qryOCSDCInfo.RecordCount > 0 then begin
      //21.03.15 디비 속도 향상
      OCS_DC_Field  := dmTables.qryOCSDCInfo.FieldByName('DCNo');
      OCS_DC_Field2 := dmTables.qryOCSDCInfo.FieldByName('DCName');
      OCS_DC_Field3 := dmTables.qryOCSDCInfo.FieldByName('FeeNo');
      nTempDCNo   := OCS_DC_Field.AsInteger;
      sTempDCName := OCS_DC_Field2.AsString;
      nDCFeeNo    := OCS_DC_Field3.AsInteger;
      ExceptLogging('OCS할인코드 '+inttostr(nTempDCNo)+', '+sTempDCName);
      InspectionLog('OCS할인코드: '+inttostr(nTempDCNo)+', '+sTempDCName);
    end else begin
      ExceptLogging('OCS할인코드 [03] or [04] 넥스파 할인코드 매칭안됨 확인요망.');
    end;
    dmTables.qryOCSDCInfo.EnableControls;

    if nDCFeeno <> 0 then
    begin
      nFeeNo := nDCFeeno;
    end;
  except
    on E: Exception do begin
      ExceptLogging('OCSAdminDCDetail_Ex : DB할인권 조회중 오류발생');
    end;
  end;
  //주차 요금 할인
  try
    nDCCnt := nDCCnt + 1;
    if sDCInTime2 <> '' then    //ocs중복할인
    begin
      sDCInTime2 := sDCInTime;
      ExceptLogging(sDCInTime);
    end;

    if (nDCValue > 0) and (overUseTime = 0) then begin //아직 보호자 차감시간이 있으면 0원
      if (nowUseTime >= 360) and (nHourEx > 5) and (nMinEx >= 0) and (nSecEx > 0)then   //6시간 차감 할인 후  1초가 지나도 300 원 부과
      begin
         nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 19)),
                                                         PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 19)),6);
      end
      else
      begin
        nTimeDC := nProcYogum;
        DCProc[nDCCnt].nRealDCMin := nowUseTime;
        Result := nDCValue;
      end;
    end else begin //보호자차감시간이 없으면 초과사용시간 요금계산
      if nowUseTime - overUseTime > 0 then begin
        ExceptLogging('보호자 차감 시간 : '+IntToStr(nowUseTime));
        ExceptLogging('보호자 초과 시간 : '+IntToStr(overUseTime));
        sDCOutTime := MG_AddTime(sDCOutTime, 0, -(nowUseTime - overUseTime), 0, 0);
        ExceptLogging(sDCOutTime);
        if sDCInTime2 <> '' then   //OCS 중복 할인(01,02코드시)
        begin
           ExceptLogging(sDCOutTime);
           sDCInTime2 := MG_AddTime(sDCInTime2, 0, (nowUseTime - overUseTime), 0, 0);
           sDCOutTime2:= MG_AddTime(sDCOutTime2, 0, -(nowUseTime - overUseTime), 0, 0);
           ExceptLogging(sDCInTime2);
           ExceptLogging(sDCOutTime2);
        end
        else //OCS 중복 할인 안함
        begin
        end;
        ExceptLogging(sDCInTime);
        ExceptLogging(sDCOutTime);
        if sDCOutTime < lbintime.Caption then begin   //입차 시간보다 출차시간이 작으면
          if overUseTime > 0 then    //주차 시간 초과 한 만큼 요금 계산
          begin
            if sDCInTime2 <> '' then   //OCS 중복할인
            begin
              nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                              PAnsiChar(Copy(aString(sDCOutTime2), 1, 16)),5);
            end
            else  //OCS 중복할인 아님
            begin
               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
            end;
          end
          else   //입차시간이 출차시간보다 크므로 무조건 0원 처리
          begin
            //nTimeDC := nProcYogum;
            nTimeDC := 0;
            DCProc[nDCCnt].nRealDCMin := (nowUseTime - overUseTime) + Trunc
                  ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                      - StrToDateTime(lbInTime.Caption)) * 24 * 60);
            ExceptLogging(IntToStr(DCProc[nDCCnt].nRealDCMin));
          end;

          {nTimeDC := nProcYogum;
          DCProc[nDCCnt].nRealDCMin := (nowUseTime - overUseTime) + Trunc
                ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                    - StrToDateTime(lbInTime.Caption)) * 24 * 60);
          ExceptLogging(IntToStr(DCProc[nDCCnt].nRealDCMin));}
        end else begin
          if overUseTime > 0 then    //주차 시간 초과 한 만큼 요금 계산
          begin
            if sDCInTime2 <> '' then      //OCS중복할인
            begin
               //21.03.22 1일 이상 주차 시 1일 보호자(6시간) 차감 구간 나누어서 할인 처리
               nYoumTimeDC := 0;
               nTotalnowUseTime := nowUseTime - overUseTime;
               ExceptLogging('총 주차 시간(구간요금)계산 : '+IntToStr(nTotalnowUseTime));

               if Copy(lbInTime.Caption,1,10) <> Copy(lbOutTime.Caption,1,10) then
               begin
                 if nsAdmDateCount > 0 then //1일 이상
                 begin
                   //뒤에서 주차 시간 할인(6시간 보호자 및 입원 할인) 구간으로 나누어서 계산
                   for I := 0 to nsAdmDateCount do
                   begin
                     //뒤에서 주차 시간 할인(6시간 보호자 및 입원 할인) 구간으로 나누어서 계산
                     sStartDateTime := DateTimeToStr(IncHour(StrToDateTime(aString(lbInTime.Caption)), 24 *(I + 1)));
                     sCompareDateTime := CompareDate(StrToDateTime(lbOutTime.Caption), StrToDateTime(sStartDateTime));

                     //if sCompareDateTime = -1 then  //입차 후 24시간 보다 출차 시간이 작은 경우
                     if StrToDateTime(lbOutTime.Caption) < StrToDateTime(sStartDateTime) then
                     begin
                        //if nHourEx <= 6 then   //6시간까지 할인 적용
                        ExceptLogging(Inttostr(nHourEx)+' '+Inttostr(nMinEx)+' '+ inttostr(nSecEx));
                        if ((nHourEx = 6) and (nMinEx = 0) and (nSecEx = 0)) or ((nHourEx <= 5) and (nMinEx <= 59)) then  //6시간까지 할인 적용
                        begin
                           ExceptLogging(IntToStr(i+1) + '일 총 주차요금 (보호자6시간이전 이라서 요금 적용안함)  : ' + IntToStr(nYoumTimeDC));
                           nTimeDC := nTotalTimeDC;
                        end
                        else
                        begin
                          //sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                          sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -360, 0, 0);
                        
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          ExceptLogging(IntToStr(i+1) + '일 주차요금(중복할인)2 : ' + IntToStr(nYoumTimeDC));
                          nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                          ExceptLogging(IntToStr(i+1) + '일 총 주차요금(중복할인)2 : ' + IntToStr(nTotalTimeDC));
                          nTimeDC := nTotalTimeDC;
                        end;
                     end
                     else
                     begin
                        if nTotalnowUseTime >= 360 then
                        begin
                           sOCSDCOutTime := MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -360, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(중복할인)계산 : '+IntToStr(nTotalnowUseTime));
                        end
                        else
                        begin
                           sOCSDCOutTime := MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(중복할인)계산2 : '+IntToStr(nTotalnowUseTime));
                        end;

                        if i = 0 then //첫째날
                        begin
                          sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -(360 + nDCValue2), 0, 0);
                          ExceptLogging('주차 시간(중복할인 후 입차계산)  : '+sOCSDCOutTime);

                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end
                        else
                        begin
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end;
                        ExceptLogging(IntToStr(i+1) + '일 주차요금(중복할인) : ' + IntToStr(nYoumTimeDC));
                        if nYoumTimeDC  > 13000 then    //하루에 주차 요금이 13000원 보다 크면 최대 요금(13000원) 부과
                        begin
                           nYoumTimeDC := 13000;
                           ExceptLogging(IntToStr(i+1) + '일 주차요금(중복할인2) : ' + IntToStr(nYoumTimeDC));
                        end;
                        nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                        ExceptLogging(IntToStr(i+1) + '일 총 주차요금(중복할인) : ' + IntToStr(nTotalTimeDC));
                        nTimeDC := nTotalTimeDC;
                     end;
                   end;
                 end
                 else  //1일이 안된경우(중복할인)
                 begin
                     nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                     PAnsiChar(Copy(aString(sDCOutTime), 1, 16)),5);
                                                                     //PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)),5);
                 end;
               end
               else
               begin
                 nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
               end;
            end
            else   //OCS중복할인 안함
            begin
               //21.03.18 1일 이상 주차 시 1일 보호자(6시간) 차감 구간 나누어서 할인 처리
               nYoumTimeDC := 0;
               nTotalnowUseTime := nowUseTime - overUseTime;
               ExceptLogging('총 주차 시간(구간요금)계산 : '+IntToStr(nTotalnowUseTime));
               if Copy(lbInTime.Caption,1,10) <> Copy(lbOutTime.Caption,1,10) then
               begin
                 if nsAdmDateCount > 0 then  //1일 이상 주차시
                 begin
                   for I := 0 to nsAdmDateCount do
                   begin
                     //뒤에서 주차 시간 할인(6시간 보호자 및 입원 할인) 구간으로 나누어서 계산
                     sYounmCount := 1;
                     sStartDateTime := DateTimeToStr(IncHour(StrToDateTime(aString(lbInTime.Caption)), 24 *(I + 1)));
                     sCompareDateTime := CompareDate(StrToDateTime(lbOutTime.Caption), StrToDateTime(sStartDateTime));

                     //if sCompareDateTime = -1 then  //입차 후 24시간 보다 출차 시간이 작은 경우
                     if StrToDateTime(lbOutTime.Caption) < StrToDateTime(sStartDateTime) then
                     begin
                        //if nHourEx <= 6 then   //6시간까지 할인 적용
                        if ((nHourEx = 6) and (nMinEx = 0) and (nSecEx = 0)) or ((nHourEx <= 5) and (nMinEx <= 59)) then  //6시간까지 할인 적용
                        begin
                           ExceptLogging(IntToStr(i+1) + '일 총 주차요금 (보호자6시간이전 이라서 요금 적용안함)  : ' + IntToStr(nYoumTimeDC));
                           nTimeDC := nTotalTimeDC;
                        end
                        else
                        begin
                            //sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                            sOCSDCOutTime:= MG_AddTime(Copy(aString(lbOutTime.Caption), 1, 16), 0, -360, 0, 0);
                            //출차 시간보다 출차 할인 시간이 클 경우
                            nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                                PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                            ExceptLogging(IntToStr(i+1) + '일 주차요금(할인시간)2 : ' + IntToStr(nYoumTimeDC));
                            nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                            ExceptLogging(IntToStr(i+1) + '일 총 주차요금(할인시간)2 : ' + IntToStr(nTotalTimeDC));
                            nTimeDC := nTotalTimeDC;
                        end;
                     end
                     else
                     begin
                        if nTotalnowUseTime >= 360 then
                        begin
                           sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -360, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(구간요금)계산 : '+IntToStr(nTotalnowUseTime));
                        end
                        else
                        begin
                           sOCSDCOutTime:= MG_AddTime(Copy(aString(sStartDateTime), 1, 16), 0, -nTotalnowUseTime, 0, 0);
                           nTotalnowUseTime := nTotalnowUseTime - 360;
                           ExceptLogging('주차 시간(구간요금)계산2 : '+IntToStr(nTotalnowUseTime));
                        end;

                        if i = 0 then     //첫째날
                        begin
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end
                        else
                        begin
                          nYoumTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(sStartDateTime2), 1, 16)),
                                                                              PAnsiChar(Copy(aString(sOCSDCOutTime), 1, 16)),4);
                          sStartDateTime2 := sStartDateTime;
                        end;
                        ExceptLogging(IntToStr(i+1) + '일 주차요금(할인시간) : ' + IntToStr(nYoumTimeDC));
                        if nYoumTimeDC  > 13000 then    //하루에 주차 요금이 13000원 보다 크면 최대 요금(13000원) 부과
                        begin
                           nYoumTimeDC := 13000;
                           ExceptLogging(IntToStr(i+1) + '일 주차요금(할인시간2) : ' + IntToStr(nYoumTimeDC));
                        end;
                        nTotalTimeDC := nTotalTimeDC + nYoumTimeDC;
                        ExceptLogging(IntToStr(i+1) + '일 총 주차요금(할인시간) : ' + IntToStr(nTotalTimeDC));
                        nTimeDC := nTotalTimeDC;
                     end;
                   end;
                 end
                 else  //1일이 안된경우
                 begin
                    nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                    PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
                 end;
               end
               else
               begin
                 nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                 PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
               end;
            end;
          end
          else    //보호차 차감 시간(360분) 초과가 안될 시
          begin
            if sDCInTime2 <> '' then     //OCS중복 할인 시
            begin
                  nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                                  PAnsiChar(Copy(aString(sDCOutTime2), 1, 16)),4);
            end
            else  //OCS중복 할인 안함
            begin
               nTimeDC :=  DJSM_FeeCalcEx(nCurrParkNo, nFeeNo, PAnsiChar(Copy(aString(lbInTime.Caption), 1, 16)),
                                                               PAnsiChar(Copy(aString(lbOutTime.Caption), 1, 16)));
            end;
          end;
          DCProc[nDCCnt].nRealDCMin := (nowUseTime - overUseTime);
        end;
      end else begin
        sDCOutTime := MG_AddTime(sDCOutTime, 0, -overUseTime, 0, 0);
        sDCInTime  := MG_AddTime(sDCInTime, 0, overUseTime, 0, 0);
        if sDCOutTime <lbintime.Caption then begin
          nTimeDC := nProcYogum;
          DCProc[nDCCnt].nRealDCMin := overUseTime + Trunc
                ((StrToDateTime(Copy(sDCOutTime, 1, 16) + ':00')
                    - StrToDateTime(lbInTime.Caption)) * 24 * 60);
        end else begin
          DCProc[nDCCnt].nRealDCMin := 0;
        end;
      end;
    end;
    nTotalTimeDC2 := nTimeDC;
    InspectionLog('주차요금: ' + IntToStr(nTimeDC));
    InspectionLog('할인요금: ' + edtDCYogum.Text);
  except
    on E: Exception do begin
      ExceptLogging('OCSAdminDCDetail_Ex : ' + E.Message);
    end;
  end;
end;

end.
