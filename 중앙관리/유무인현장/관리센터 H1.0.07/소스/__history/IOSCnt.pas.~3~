unit IOSCnt;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms,
  Dialogs, ComCtrls, StdCtrls, Buttons, AdvDateTimePicker, ExtCtrls, Grids,
  BaseGrid, AdvGrid, tmsAdvGridExcel, DB, ADODB, AdvObj;

type
  TfrmIOSCnt = class(TForm)
    SaveDialog1: TSaveDialog;
    qryCount: TADOQuery;
    qryCountCOLUMN1: TIntegerField;
    qryCountCOLUMN2: TIntegerField;
    qryCountCOLUMN3: TIntegerField;
    qryCountCOLUMN4: TIntegerField;
    qryCountCOLUMN5: TIntegerField;
    qryCountCOLUMN6: TIntegerField;
    qryCountCOLUMN7: TIntegerField;
    qryCountCOLUMN8: TIntegerField;
    qryCountCOLUMN9: TIntegerField;
    qryCountCOLUMN10: TIntegerField;
    qryCountCOLUMN11: TIntegerField;
    qryCountCOLUMN12: TIntegerField;
    qryCountCOLUMN13: TIntegerField;
    qryCountCOLUMN14: TIntegerField;
    qryCountCOLUMN15: TIntegerField;
    qryCountCOLUMN16: TIntegerField;
    qryCountCOLUMN17: TIntegerField;
    qryCountCOLUMN18: TIntegerField;
    qryCountCOLUMN19: TIntegerField;
    qryCountCOLUMN20: TIntegerField;
    qryCountCOLUMN21: TIntegerField;
    qryCountCOLUMN22: TIntegerField;
    qryCountCOLUMN23: TIntegerField;
    qryCountCOLUMN24: TIntegerField;
    qryCountCOLUMN25: TIntegerField;
    qryCountCOLUMN26: TIntegerField;
    qryCountCOLUMN27: TIntegerField;
    qryCountCOLUMN28: TIntegerField;
    qryCountCOLUMN29: TIntegerField;
    qryCountCOLUMN30: TIntegerField;
    qryCountCOLUMN31: TIntegerField;
    qryCountCOLUMN32: TIntegerField;
    qryCountCOLUMN33: TIntegerField;
    qryCountCOLUMN34: TIntegerField;
    qryCountCOLUMN35: TIntegerField;
    qryCountCOLUMN36: TIntegerField;
    qryCountCOLUMN37: TIntegerField;
    qryCountCOLUMN38: TIntegerField;
    qryCountCOLUMN39: TIntegerField;
    qryCountCOLUMN40: TIntegerField;
    qryCountCOLUMN41: TIntegerField;
    qryCountCOLUMN42: TIntegerField;
    qryCountCOLUMN43: TIntegerField;
    qryCountCOLUMN44: TIntegerField;
    qryCountCOLUMN45: TIntegerField;
    qryCountCOLUMN46: TIntegerField;
    qryCountCOLUMN47: TIntegerField;
    qryCountCOLUMN48: TIntegerField;
    qryTemp: TADOQuery;
    eCount: TAdvGridExcelIO;
    sgCount: TAdvStringGrid;
    Panel1: TPanel;
    Bevel2: TBevel;
    Label7: TLabel;
    Label8: TLabel;
    edtSDate: TAdvDateTimePicker;
    edtEDate: TAdvDateTimePicker;
    btnSearch: TBitBtn;
    btnExcel: TBitBtn;
    btnClose: TBitBtn;
    sb1: TStatusBar;
    procedure FormShow(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure btnSearchClick(Sender: TObject);
    procedure btnExcelClick(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
  private
    { Private declarations }
  public
    { Public declarations }
  end;

var
  frmIOSCnt: TfrmIOSCnt;
  nTotLpr, nInLpr, nOutLpr: Byte;
  RLpr: Array [1..50] of Word;

implementation
uses
  Global, Tables;

{$R *.dfm}

procedure TfrmIOSCnt.btnCloseClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmIOSCnt.btnExcelClick(Sender: TObject);
begin
  try
    if savedialog1.Execute then
    begin
      eCount.XLSExport(savedialog1.filename + '.xls');
      ShowMessage('¿¢¼¿ÆÄÀÏ·Î ÀúÀå¿Ï·á!');
    end;
  except
    on E: Exception do ExceptLogging('TfrmIOCnt.btnExcelClick: ' + E.Message);
  end;
end;

procedure TfrmIOSCnt.btnSearchClick(Sender: TObject);
var
  i, j, k: Byte;
  nSum, nTotIn, nTotOut, nUnitNo, nTempIn: Cardinal;
  ssTime, sETime: String;
begin
  nTotIn:= 0;
  nTotOut:= 0;

  for i:= 1 to nInLpr do
  begin
    nUnitNo:= RLpr[i];
    {
    case i of
      1: nUnitNo:= 11;
      2: nUnitNo:= 12;
      3: nUnitNo:= 18;
      4: nUnitNo:= 19;
      5: nUnitNo:= 211;
      6: nUnitNo:= 212;
    end;
    }

    with qryTemp do
    begin
      nSum:= 0;

      for j:= 1 to 24 do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select Count(*) nIn from IOSData where (ProcDate >= :N1 and ProcDate <= :N2 and ');
        SQL.Add('ProcTime >= :N4 and ProcTime <= :N5) and ');
        SQL.Add('(InIOStatusNo = 1 and TKType = 2) and ');
        SQL.Add('(UnitNo = :N3) ');
        Parameters.ParamByName('N1').Value:= FormatDateTime('YYYY-MM-DD', edtSDate.Date);
        Parameters.ParamByName('N2').Value:= FormatDateTime('YYYY-MM-DD', edtEDate.Date);
        Parameters.ParamByName('N3').Value:= nUnitNo;
        Parameters.ParamByName('N4').Value:= MG_InsZero(IntToStr(j-1), 2) + ':00:00';
        Parameters.ParamByName('N5').Value:= MG_InsZero(IntToStr(j-1), 2) + ':59:59';
        Open;

        if FieldByName('nIn').AsInteger > 0 then
          sgCount.Cells[i, j]:= FormatFloat('#,##0', FieldByName('nIn').AsInteger)
        else
          sgCount.Cells[i, j]:= '0';

        nSum:= nSum + FieldByName('nIn').AsInteger;
        sgCount.Alignments[i, j]:= taRightJustify;
      end;

      if nSum > 0 then
        sgCount.Cells[i, 25]:= FormatFloat('#,##0', nSum)
      else
        sgCount.Cells[i, 25]:= '0';

      nTotIn:= nTotIn + nSum;
      sgCount.Alignments[i, 25]:= taRightJustify;
    end;
  end;

  for i:= nInLpr+1 to nTotLpr do
  begin
    nUnitNo:= RLpr[i];
    {
    case i of
      7: nUnitNo:= 21;
      8: nUnitNo:= 22;
      9: nUnitNo:= 221;
      10: nUnitNo:= 222;
    end;
    }

    with qryTemp do
    begin
      nSum:= 0;

      for j:= 1 to 24 do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select Count(*) nOut from IOSData where (OutDate >= :N1 and OutDate <= :N2 and ');
        SQL.Add('(OutUnitNo = :N3) and ');
        SQL.Add('OutTime >= :N4 and OutTime <= :N5) and OutIOStatusNo = :N6 and TKType = 2');
        //SQL.Add('and OutUnitNo <> UnitNo');
        Parameters.ParamByName('N1').Value:= FormatDateTime('YYYY-MM-DD', edtSDate.Date);
        Parameters.ParamByName('N2').Value:= FormatDateTime('YYYY-MM-DD', edtEDate.Date);
        Parameters.ParamByName('N3').Value:= nUnitNo;
        Parameters.ParamByName('N4').Value:= MG_InsZero(IntToStr(j-1), 2) + ':00:00';
        Parameters.ParamByName('N5').Value:= MG_InsZero(IntToStr(j-1), 2) + ':59:59';
        Parameters.ParamByName('N6').Value:= 2;
        Open;

        if FieldByName('nOut').AsInteger > 0 then
          sgCount.Cells[i, j]:= FormatFloat('#,##0', FieldByName('nOut').AsInteger)
        else
          sgCount.Cells[i, j]:= '0';

        nSum:= nSum + FieldByName('nOut').AsInteger;
        sgCount.Alignments[i, j]:= taRightJustify;
      end;

      if nSum > 0 then
        sgCount.Cells[i, 25]:= FormatFloat('#,##0', nSum)
      else
        sgCount.Cells[i, 25]:= '0';

      nTotOut:= nTotOut + nSum;
      sgCount.Alignments[i, 25]:= taRightJustify;
    end;
  end;
  sb1.SimpleText:= ' ÃÑÀÔÂ÷: ' + IntToStr(nTotIn) + ',  ÃÑÃâÂ÷: ' + IntToStr(nTotOut);
  btnExcel.Enabled:= True;
end;

procedure TfrmIOSCnt.FormClose(Sender: TObject; var Action: TCloseAction);
begin
  Close;
end;

procedure TfrmIOSCnt.FormShow(Sender: TObject);
var
  i, j: Byte;
begin
  with qryTemp do
  begin
    Close;
    SQL.Clear;
    SQL.Add('select count(*) nLprCnt from (select UnitNo UnitNo from IOSData where UnitNo<>0 and ParkNo = :N1 group by UnitNo    ');
    SQL.Add('union all ');
    SQL.Add('select OutUnitNo UnitNo from IOSData where OutUnitNo<>0 and ParkNo = :N2 group by OutUnitNo) F ');
    Parameters.ParamByName('N1').Value := nCurrParkNo;
    Parameters.ParamByName('N2').Value := nCurrParkNo;
    Open;

    nTotLpr:= FieldByName('nLprCnt').AsInteger;
    sgCount.ColCount:= nTotLpr + 1;

    Close;
    SQL.Clear;
    SQL.Add('select A.UnitNo UnitNo,Max(B.UnitName) UnitName From IOSData A ,UnitInfo B where A.UnitNo<>0 and A.UnitNo=B.UnitNo and A.ParkNo=:N1 group by A.UnitNo  ');
//    Parameters.ParamByName('N1').Value := 8; // ÀÔ±¸LPR
    Parameters.ParamByName('N1').Value := nCurrParkNo;
    Open;
    i:= 1;

    if RecordCount > 0 then
    begin
      nInLpr:= RecordCount;

      while not Eof do
      begin
        RLpr[i]:= FieldByName('UnitNo').AsInteger;
        sgCount.Cells[i, 0]:= FieldByName('UnitName').AsString;
        sgCount.Alignments[i, 0]:= taCenter;
        Inc(i);
        Next;
      end;
    end;

    Close;
    SQL.Clear;
    SQL.Add('select OutUnitNo UnitNo,Max(B.UnitName) UnitName From IOSData A ,UnitInfo B where A.OutUnitNo<>0 and A.OutUnitNo=B.UnitNo and A.ParkNo=:N1 group by A.OutUnitNo ') ;
   // Parameters.ParamByName('N1').Value := 9; // Ãâ±¸LPR
   // Parameters.ParamByName('N2').Value := nCurrParkNo;
      Parameters.ParamByName('N1').Value := nCurrParkNo;
    Open;

    if RecordCount > 0 then
    begin
      nOutLpr:= RecordCount;

      while not Eof do
      begin
        RLpr[i]:= FieldByName('UnitNo').AsInteger;
        sgCount.Cells[i, 0]:= FieldByName('UnitName').AsString;
        sgCount.Alignments[i, 0]:= taCenter;
        Inc(i);
        Next;
      end;
    end;
  end;

  with sgCount do
  begin
    for i:= 0 to 25 do
      Alignments[0, i]:= taCenter;
  end;
  edtSDate.Date:= Now;
  edtEDate.Date:= Now;
end;

end.
