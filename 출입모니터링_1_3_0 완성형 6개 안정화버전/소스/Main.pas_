unit Main;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms, IdGlobal,
  Dialogs, StdCtrls, ExtCtrls, Menus, IdContext, ScktComp, IdServerIOHandler, IdServerIOHandlerSocket, IdServerIOHandlerStack,
  IdCustomTCPServer, IdTCPServer, IdIOHandler, IdIOHandlerSocket, IdIOHandlerStack, IdTCPConnection, IdTCPClient, IdComponent, IdRawBase,
  IdRawClient, IdIcmpClient, IdBaseComponent, IdAntiFreezeBase, IdAntiFreeze, Grids, BaseGrid, AdvGrid, IniFiles, DB, ADODB, AdvToolBtn,
  Buttons, DBAdvGrid, sButton, Winsock, IdStack, IdException, jpeg, acPNG, IdIOHandlerStream, AdvCombo,
  AdvObj, AdPort, OoMisc,sPanel,sLabel, AdvEdit, XMLDoc, xmldom, XMLIntf,
  IdCustomTransparentProxy, IdSocks, IdSocketHandle, IdUDPServer, IdUDPBase, IdUDPClient;

type
  R_SCWait = Record
    sSCFile1: AnsiString;
    sSCCarNo1: AnsiString;
    sSCFile2: AnsiString;
    sSCCarNo2: AnsiString;
    sSCIOTime: AnsiString;
    nSCLprNo: Byte;
    nSCInOut: Byte;
    nSCRecog1: Byte;
    nSCRecog2: Byte;
    nSCLprCnt: Byte;
    sSCDspIP: AnsiString;
    csSCLPR: TClientSocket;
    bBarOpen: Boolean;
  end;

  R_NCWait = Record
    sNCFile1: AnsiString;
    sNCCarNo1: AnsiString;
    sNCFile2: AnsiString;
    sNCCarNo2: AnsiString;
    sNCIOTime: AnsiString;
    nNCLprNo: Byte;
    nNCInOut: Byte;
    nNCRecog1: Byte;
    nNCRecog2: Byte;
    nNCCharo: Byte;
    nNCLprCnt: Byte;
    sNCDspIP: AnsiString;
    csNCLPR: TClientSocket;
    bBarOpen: Boolean;
  end;

  TfrmMain = class(TForm)
    MainMenu1: TMainMenu;
    mnuSetup: TMenuItem;
    N2: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    mnuInDsp: TMenuItem;
    mnuOutDsp: TMenuItem;
    mnuClose: TMenuItem;
    IdAntiFreeze1: TIdAntiFreeze;
    ICMP: TIdIcmpClient;
    IdTc_HyunDai: TIdTCPClient;
    idStack2: TIdIOHandlerStack;
    IdTS_HyunDai: TIdTCPServer;
    IdStack1: TIdServerIOHandlerStack;
    csInLpr1: TClientSocket;
    csOutLpr1: TClientSocket;
    csInDsp1: TClientSocket;
    csOutDsp1: TClientSocket;
    qryMainTemp: TADOQuery;
    qry1: TADOQuery;
    tInDsp: TTimer;
    tOutDsp: TTimer;
    tInAlive1: TTimer;
    tOutAlive1: TTimer;
    tSCWait: TTimer;
    csInLpr2: TClientSocket;
    csInLpr3: TClientSocket;
    csInLpr4: TClientSocket;
    csOutLpr2: TClientSocket;
    csOutLpr3: TClientSocket;
    csInDsp2: TClientSocket;
    csInDsp3: TClientSocket;
    csInDsp4: TClientSocket;
    csInDsp5: TClientSocket;
    csOutDsp2: TClientSocket;
    csOutDsp3: TClientSocket;
    tNCInWait: TTimer;
    tNCOutWait: TTimer;
    qryCtrl: TADOQuery;
    tEZVille: TTimer;
    tInAlive2: TTimer;
    tInAlive3: TTimer;
    tInAlive4: TTimer;
    tInAlive5: TTimer;
    tOutAlive2: TTimer;
    tOutAlive3: TTimer;
    pnTot: TPanel;
    pnIn1: TPanel;
    imgIn1: TImage;
    pnInT1: TPanel;
    imgInL1: TImage;
    pnOut1: TPanel;
    imgOut1: TImage;
    imgInR1: TImage;
    lbIn1: TLabel;
    lbInOpen1: TLabel;
    pnOutT1: TPanel;
    imgOutL1: TImage;
    imgOutR1: TImage;
    lbOut1: TLabel;
    pnManualProc: TPanel;
    Label10: TLabel;
    Panel8: TPanel;
    Panel9: TPanel;
    imgManual: TImage;
    edtManualProcCarNo: TEdit;
    pnSManualProc: TPanel;
    dgManual: TDBAdvGrid;
    btnManualSeek: TBitBtn;
    btnManualSCOut: TBitBtn;
    btnClose: TBitBtn;
    btnManualSCIn: TBitBtn;
    pnSCSearch: TPanel;
    Label7: TLabel;
    DBAdvGrid1: TDBAdvGrid;
    btnSCOut: TsButton;
    btnSCCancel: TsButton;
    btnSC: TBitBtn;
    edtSCCarNo: TEdit;
    btnSCIn: TsButton;
    pnBar: TPanel;
    btnBar1: TAdvToolButton;
    btnBar2: TAdvToolButton;
    btnBar3: TAdvToolButton;
    btnBar4: TAdvToolButton;
    btnBar5: TAdvToolButton;
    btnBar6: TAdvToolButton;
    btnBar7: TAdvToolButton;
    btnBar8: TAdvToolButton;
    btnBarClose: TAdvToolButton;
    btnBar9: TAdvToolButton;
    btnBar10: TAdvToolButton;
    Panel13: TPanel;
    pnHomeInfo: TPanel;
    edtDong: TLabeledEdit;
    edtHo: TLabeledEdit;
    edtCar: TLabeledEdit;
    btnHomeInfoTest: TButton;
    Button1: TButton;
    cmbIO: TAdvComboBox;
    csOutLpr4: TClientSocket;
    tOutAlive4: TTimer;
    lbOutOpen1: TLabel;
    csOutDsp4: TClientSocket;
    PopupMenu1: TPopupMenu;
    mnu1_2: TMenuItem;
    mnu3_2: TMenuItem;
    mnuHomeInfo: TMenuItem;
    pnBottom: TPanel;
    pnList: TPanel;
    btnMode: TButton;
    imgSgIn: TImage;
    imgSgOut: TImage;
    sgIn: TAdvStringGrid;
    sgOut: TAdvStringGrid;
    btnManualIn: TButton;
    pnModify: TsPanel;
    sLabel28: TsLabel;
    Label11: TLabel;
    edtMCarNo: TEdit;
    btnMOK: TsButton;
    btnMCancel: TsButton;
    Panel3: TPanel;
    imgModify: TImage;
    pnInLogo1: TPanel;
    imgLogo1: TImage;
    pnInB1: TPanel;
    lbInHo1: TLabel;
    edtInCarNo1: TEdit;
    pnInG1: TPanel;
    lbInG1: TLabel;
    pnOutB1: TPanel;
    lbOutHo1: TLabel;
    edtOutCarNo1: TEdit;
    pnOutG1: TPanel;
    lbOutG1: TLabel;
    a1: TMenuItem;
    pnManual: TsPanel;
    sLabel31: TsLabel;
    Label3: TLabel;
    edtManualCarNo: TEdit;
    btnManualOK: TsButton;
    btnManualCancel: TsButton;
    pnIn2: TPanel;
    imgIn2: TImage;
    pnInT2: TPanel;
    imgInL2: TImage;
    imgInR2: TImage;
    lbIn2: TLabel;
    lbInOpen2: TLabel;
    pnInB2: TPanel;
    lbInHo2: TLabel;
    edtInCarNo2: TEdit;
    pnInG2: TPanel;
    lbInG2: TLabel;
    csHomeInfo_icon: TClientSocket;
    mnu1_3: TMenuItem;
    lbListIn: TLabel;
    lbListOut: TLabel;
    pnIn3: TPanel;
    imgIn3: TImage;
    pnInT3: TPanel;
    imgInL3: TImage;
    imgInR3: TImage;
    lbIn3: TLabel;
    lbInOpen3: TLabel;
    pnInB3: TPanel;
    lbInHo3: TLabel;
    edtInCarNo3: TEdit;
    pnInG3: TPanel;
    lbInG3: TLabel;
    pnIn4: TPanel;
    imgIn4: TImage;
    pnInT4: TPanel;
    imgInL4: TImage;
    imgInR4: TImage;
    lbIn4: TLabel;
    lbInOpen4: TLabel;
    pnInB4: TPanel;
    lbInHo4: TLabel;
    edtInCarNo4: TEdit;
    pnInG4: TPanel;
    lbInG4: TLabel;
    pnInLogo2: TPanel;
    imgLogo2: TImage;
    pnInLogo3: TPanel;
    imgLogo3: TImage;
    pnOutLogo1: TPanel;
    imgLogo4: TImage;
    pnOut2: TPanel;
    imgOut2: TImage;
    pnOutT2: TPanel;
    imgOutL2: TImage;
    imgOutR2: TImage;
    lbOut2: TLabel;
    lbOutOpen2: TLabel;
    pnOutB2: TPanel;
    lbOutHo2: TLabel;
    edtOutCarNo2: TEdit;
    pnOutG2: TPanel;
    lbOutG2: TLabel;
    pnOut3: TPanel;
    imgOut3: TImage;
    pnOutT3: TPanel;
    imgOutL3: TImage;
    imgOutR3: TImage;
    lbOut3: TLabel;
    lbOutOpen3: TLabel;
    pnOutB3: TPanel;
    lbOutHo3: TLabel;
    edtOutCarNo3: TEdit;
    pnOutG3: TPanel;
    lbOutG3: TLabel;
    pnOut4: TPanel;
    imgOut4: TImage;
    pnOutT4: TPanel;
    imgOutL4: TImage;
    imgOutR4: TImage;
    lbOut4: TLabel;
    lbOutOpen4: TLabel;
    pnOutB4: TPanel;
    lbOutHo4: TLabel;
    edtOutCarNo4: TEdit;
    pnOutG4: TPanel;
    lbOutG4: TLabel;
    pnOutLogo2: TPanel;
    Image1: TImage;
    pnOutLogo3: TPanel;
    Image2: TImage;
    csHomeInfo_EZ: TClientSocket;
    csHomeInfo_Gye: TClientSocket;
    idTC: TIdTCPClient;
    idTS: TIdTCPServer;
    IdTS_kocom: TIdTCPServer;
    IdTC_kocom: TIdTCPClient;
    IdSocksInfo1: TIdSocksInfo;
    tAlive: TTimer;
    btnBind: TButton;
    IdTs_Gyeyoung: TIdTCPServer;
    IdTC_Gyeyoung: TIdTCPClient;
    idUC_ubiz: TIdUDPClient;
    idUS_ubiz: TIdUDPServer;
    IdTS_Beeju: TIdTCPServer;
    IdTC_Beeju: TIdTCPClient;
    procedure mnuOutDspClick(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure csInLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnManualSeekClick(Sender: TObject);
    procedure edtManualProcCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure dgManualClick(Sender: TObject);
    procedure btnManualSCOutClick(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
    procedure edtSCCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure btnSCClick(Sender: TObject);
    procedure DBAdvGrid1Click(Sender: TObject);
    procedure btnSCCancelClick(Sender: TObject);
    procedure btnSCOutClick(Sender: TObject);
    procedure btnBarCloseClick(Sender: TObject);
    procedure btnSCInClick(Sender: TObject);
    procedure btnManualSCInClick(Sender: TObject);
    procedure btnBar1Click(Sender: TObject);
    procedure btnBar2Click(Sender: TObject);
    procedure btnBar3Click(Sender: TObject);
    procedure btnBar4Click(Sender: TObject);
    procedure csInLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTS_HyunDaiExecute(AContext: TIdContext);
    procedure edtInCarNo1KeyPress(Sender: TObject; var Key: Char);
    procedure edtOutCarNo1KeyPress(Sender: TObject; var Key: Char);
    procedure Button1Click(Sender: TObject);
    procedure btnHomeInfoTestClick(Sender: TObject);
    procedure csOutLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure imgOut1Click(Sender: TObject);
    procedure btnModeClick(Sender: TObject);
    procedure csInDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csDspError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnManualCancelClick(Sender: TObject);
    procedure btnManualOKClick(Sender: TObject);
    procedure btnManualInClick(Sender: TObject);
    procedure sgInDblClickCell(Sender: TObject; ARow, ACol: Integer);
    procedure btnMCancelClick(Sender: TObject);
    procedure btnMOKClick(Sender: TObject);
    procedure csInLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr2Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csOutLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure a1Click(Sender: TObject);
    procedure csHomeInfo_iconConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_iconDisconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_iconError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csHomeInfo_iconRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure idTSExecute(AContext: TIdContext);
    procedure btnBindClick(Sender: TObject);
    procedure csHomeInfo_GyeConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_GyeDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure csHomeInfo_GyeError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csHomeInfo_GyeRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTs_GyeyoungExecute(AContext: TIdContext);
    procedure idUC_ubizConnected(Sender: TObject);
    procedure idUC_ubizDisconnected(Sender: TObject);
    procedure idUS_ubizUDPRead(AThread: TIdUDPListenerThread;
      const AData: TIdBytes; ABinding: TIdSocketHandle);
    procedure csHomeInfo_EZConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_EZDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure csHomeInfo_EZRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTS_BeejuExecute(AContext: TIdContext);
  private
    { Private declarations }
    procedure ICMPReply(ASender: TComponent; const ReplyStatus: TReplyStatus);
    function is_ping(IP: AnsiString): Boolean;
    procedure UnitCtrl(nCmd, nFCNo, nUnitNo, nMNo: Word; sData: AnsiString);
    function chkNet(csTarget: TClientSocket; sData: AnsiString): Boolean;
    procedure csInDsp1Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure HomeInfoTest_Proc_Gye;
  public
    { Public declarations }
    procedure InOpen(csLPR: TClientSocket);
    Procedure OutOpen(csLPR: TClientSocket);
    procedure DspProc(nIO, nType: Byte; sData, sDspIP: AnsiString);
    procedure GridData(nIO, nListCnt: Byte; sResult: String);
    procedure NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
                        sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
                        sDspIP: AnsiString; csLPR: TClientSocket; nListCnt: Byte);
    procedure NormalProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
                         sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
                         sDspIP: AnsiString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte);
    procedure HomeInfo_Proc(nInOut: Byte);
    procedure HomeInfo_Proc_Hyun(nInOut: Byte);   //현대통신
    procedure HomeInfo_Proc_Kocom(nInOut: Byte);  //코콤
    procedure HomeInfo_Proc_Icon(nInOut: Byte);   //아이컨트롤스
    procedure HomeInfo_Proc_Gye(nInOut: Byte);    //계영정보통신
    procedure HomeInfo_Proc_UBiz(nInOut: Byte);   //삼성중공업 유비즈
    procedure HomeInfo_Proc_EZ(nInOut: Byte);     //이지빌
    procedure HomeInfo_Proc_BeeJu(nInOut: Byte);  //한화 비쥬드림 uCamp

    procedure HomeInfoTest_Hyun;                  //현대통신 테스트
    procedure HomeinfoTest_Kocom;                 //코콤 테스트
    procedure HomeinfoTest_Icon;                  //아이컨트롤스 테스트
    procedure HomeInfoTest_Gye;                   //계영정보통신 테스트
    procedure HomeInfoTest_UBiz;                  //삼성중공업 유비즈
    procedure HomeInfoTest_EZ;                    //이지빌 테스트
    procedure HomeInfoTest_BeeJu;                 //한화 비쥬드림 uCamp


    function MakeHomeCrc(sData: AnsiString): ansiChar;    //유비즈 전문생성용
    function MakeMassage(sOrder, sVal: String): String;   //비쥬드림 전문생성용

    function RecvLprProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
                         sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
                         sDspIP: AnsiString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte): String;
    procedure FormAlign;
    procedure GridClear;
    procedure WaitClear;
    procedure InitProc;
    function IntToBool(nNo: Integer): Boolean;
    procedure MichulProc(sCarNo, sProcDate, sProcTime: AnsiString);
    procedure NGridData(sResult: String);
    procedure prDelay(Time: Integer);
  end;

var
  frmMain: TfrmMain;
  bLostProc: Boolean = False;
  sChkDateTime, sNextDateTime, sInDate, sInTime, sOutDate, sOutTime, sChkDate,
    sChkTime, sNextTime,nowsLprFile1,nowInTKNo: AnsiString;
  nYogum, nTotYogum, nItemMax, nTotMax, nDayCnt, nItemMax0, nTotMax0: Cardinal;
  nFeeNo: Word = 0;
  nDCList: Byte = 0;
  nowLpr, ManualLpr: TClientSocket;
  ping_success: Boolean = False;
  nowLprNo,nowLprRecog1 ,nowLprRecog2,nowInUnitNo: Byte;
//          nInUnitNo := FieldByName('UnitNo').AsInteger;
//        sInTKNo := FieldByName('TKNo').AsString;

  // 정기차량 처리대기용 변수들
  bSCProcWait: Boolean = False;
  nSCWaitFlag: Byte = 0; // 처리할 데이터 위치
  nSCWaitPoint: Byte = 0; // 대기 데이터 위치
  RSCWait: Array [1 .. 20] of R_SCWait;

  // 일반차량 처리대기용 변수들
  bNCInProcWait: Boolean = False;
  bNCOutProcWait: Boolean = False;
  nNCInWaitFlag: Byte = 0; // 처리할 데이터 위치
  nNCInWaitPoint: Byte = 0; // 대기 데이터 위치
  nNCOutWaitFlag: Byte = 0; // 처리할 데이터 위치
  nNCOutWaitPoint: Byte = 0; // 대기 데이터 위치
  RNCInWait: Array [1 .. 20] of R_NCWait;
  RNCOutWait: Array [1 .. 20] of R_NCWait;

  // 정기차량 수동출차 차량번호
  sManualSCCarNo: String;

function IcmpCreateFile : THandle; stdcall; external 'icmp.dll';
function IcmpCloseHandle (icmpHandle : THandle) : boolean; stdcall; external 'icmp.dll';
function IcmpSendEcho (IcmpHandle    : THandle;  DestinationAddress: LongInt;
                       RequestData   : Pointer;  RequestSize       : Smallint;
                       RequestOptions: pointer;  ReplyBuffer       : Pointer;
                       ReplySize     : DWORD;    Timeout           : DWORD): DWORD;
                       stdcall; external 'icmp.dll';

implementation
uses
  Global, Tables, Login, InDspSet, DspSet, Setup, UnitInfo,Msg, IONData;

{$R *.dfm}

function TfrmMain.chkNet(csTarget: TClientSocket; sData: AnsiString): Boolean;
begin
  try
    Result:= False;

    if sData = '전광판 문구전송' then
    begin
      if (csTarget.Host <> '') then
      begin
        // ping 때리기
        if is_ping(csTarget.Host) then
        begin
          csTarget.Active:= True;

          if csTarget.Active then
          begin
            // 소켓 연결 안 되었으면
            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end
          else
          begin

            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end;
        end
        else
        begin
          ExceptLogging(csTarget.Host + ' ' + sData + ' 시 Ping 에러!');
        end;
      end;
    end
    // '전광판 문구전송'이 아니면
    else
    begin
      if (csTarget.Host <> '') then
      begin
        // ping
        if is_ping(csTarget.Host) then
        begin
          // csTarget 소켓 접속
          if csTarget.Active then
          begin
            // 소켓 연결 안 되었으면
            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end
          else
          begin
            csTarget.Active:= True;

            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end;
        end
        else
        begin
          ExceptLogging(csTarget.Host + ' ' + sData + ' 시 Ping 에러!');
        end;
      end;
    end;
  except
    on E: Exception do
    begin
      Result:= False;
      ExceptLogging('네트워크 에러: ' + csTarget.Host);
    end;
  end;
end;

// nCmd: 1-BarOpen
procedure TfrmMain.UnitCtrl(nCmd, nFCNo, nUnitNo, nMNo: Word;
  sData: AnsiString);
var
  sFCIp, sSend: aString;
  nFCPort: Word;
  nResponse: Smallint;
  i: Byte;
  bSend: Boolean;
begin
  try
    if nFCNo = nCurrUnitNo then
    begin
      // 현재 요금계산기에 연결된 LPR이면 LPR을 찾아서 명령 전송...
      bSend := False;

      case nCmd of
        1:
          begin
            for i := 1 to 5 do
            begin
              with frmMain do
              begin
                // 입구 LPR 소켓 태그값이 현재 기기번호랑 같으면
                if TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  // chkNet 함수 호출
                  if chkNet(TClientSocket(FindComponent('csInLpr' + IntToStr(i))), '차단기 원격제어') then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end;
                end;
              end;
            end;

            if not bSend then
              for i := 1 to 3 do
              begin
                with frmMain do
                begin
                  if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                  begin
                    if chkNet(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))), '차단기 원격제어') then
                    begin
                      sSend := 'BAR_OPEN-1';
                      TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                      bSend := True;
                      Break;
                    end;
                  end;
                end;
              end;

            // 소켓전송 완료하였으면 차단기제어 내역에 데이터 등록 처리
            if bSend then
            begin
              with dmTables.qryBarProc do
              begin
                Close;
                SQL.Clear;
                SQL.Add('Insert BarProc ');
                SQL.Add(
                  '(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
                Parameters.ParamByName('N1').Value := nCurrParkNo;
                Parameters.ParamByName('N2').Value := nUnitNo;
                Parameters.ParamByName('N3').Value := FormatDateTime
                  ('YYYY-MM-DD', Now);
                Parameters.ParamByName('N4').Value := FormatDateTime
                  ('HH:NN:SS', Now);
                Parameters.ParamByName('N5').Value := 1;
                Parameters.ParamByName('N6').Value := nMNo;
                Parameters.ParamByName('N7').Value := 0;

                if sData <> '' then
                  Parameters.ParamByName('N8').Value := sData
                else
                  Parameters.ParamByName('N8').Value := '수동오픈';
                ExecSQL;
              end;
            end;
          end;
      end;
    end
    else
    begin
      // 다른 요금계산기에 연결된 LPR이면 해당 요금계산기로 명령 전송...
      with qryCtrl do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from UnitInfo where UnitNo = :N1');
        Parameters.ParamByName('N1').Value := nFCNo;
        Open;

        if RecordCount > 0 then
        begin
          sFCIp := MG_StrTrim(FieldByName('IPNo').AsString, ' ');      // IP
          nFCPort := FieldByName('PortNo').AsInteger;                  // Port

          // 다른 요금계산기 ping
          if is_ping(sFCIp) then
          begin
            try
              // 연결끊고, IP랑 Port저장한 다음 다시 연결
              idTC.Disconnect;
              idTC.Host := sFCIp;
              idTC.Port := nFCPort;
              idTC.Connect;

              // 연결되었으면
              if idTC.Connected then
              begin
                sSend := STX + MG_InsZero(IntToStr(nCmd), 2) + MG_InsZero
                  (IntToStr(nUnitNo), 5) + MG_InsZero(IntToStr(nMNo), 3)
                  + sData + ETX;
                idTC.IOHandler.WriteLnRFC(sSend, enDefault);
                idTC.Disconnect;
              end;
            except
              on E: Exception do
                ExceptLogging('TfrmMain.UnitCtrl: ' + aString(E.Message));
            end;
          end
          else
            ExceptLogging('UnitCtrl(' + IntToStr(nCmd) + ')시 네트워크 오류!');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.UnitCtrl: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.WaitClear;
begin

end;

{
입구차단기 open
최종수정: 2014-11-27
}
procedure TfrmMain.InitProc;
begin

end;

procedure TfrmMain.InOpen(csLPR: TClientSocket);
begin
//  try
//    if is_Ping(csLpr.Host) then
//    begin
//      csLPR.Socket.SendText('BAR_OPEN_1');
//      ExceptLogging('입구차단기 Open');
//    end
//    else begin
//      ExceptLogging(csLpr.Host + ' LPR 차단기 오픈시 네트워크 오류!');
//      if is_ping(csLpr.Host) then
//      begin
//        csLPR.Socket.SendText('BAR_OPEN_1');
//        ExceptLogging('입구차단기 ReOpen');
//      end
//      else
//        ExceptLogging(csLpr.Host + ' LPR 차단기 재오픈시 네트워크 오류!');
//    end;
//  except
//    on E: Exception do
//      ExceptLogging('InOpen: ' + aString(E.Message));
//  end;
end;

function TfrmMain.IntToBool(nNo: Integer): Boolean;
begin

end;

{
출구차단기 open
최종수정: 2014-11-27
}
procedure TfrmMain.OutOpen(csLPR: TClientSocket);
begin
//  try
//    if is_Ping(csLpr.Host) then
//    begin
//      csLPR.Socket.SendText('BAR_OPEN_1');
//      ExceptLogging('출구차단기 Open');
//    end
//    else begin
//      ExceptLogging(csLpr.Host + ' LPR 차단기 오픈시 네트워크 오류!');
//      if is_ping(csLpr.Host) then
//      begin
//        csLPR.Socket.SendText('BAR_OPEN_1');
//        ExceptLogging('출구차단기 ReOpen');
//      end
//      else
//        ExceptLogging(csLpr.Host + ' LPR 차단기 재오픈시 네트워크 오류!');
//    end;
//  except
//    on E: Exception do
//      ExceptLogging('OutOpen: ' + aString(E.Message));
//  end;
end;



procedure TfrmMain.prDelay(Time: Integer);
var
   PastCount: LongInt;
begin
     PastCount := GetTickCount;
     repeat
           Application.ProcessMessages;
     until ((GetTickCount-PastCount) >= LongInt(Time));
end;

// 정기차량 그리드 화면에 표시
procedure TfrmMain.GridClear;
begin

end;

procedure TfrmMain.GridData(nIO, nListCnt: Byte; sResult: String);
var
  sCarNo, sName, sCompName, sDeptName, sExpDate, sStatus, sTemp, sIODate, sIOTime: String;
  nPos: Byte;
begin
  // '12014-11-04^13:05:10^31로6819^홍길동^^^2014-12-03까지^입 차'
  if Length(sResult) > 6 then
  begin
 //   nIO := nIO;
    nIO := StrToInt(Copy(sResult, 1, 1));
    sIODate := Copy(sResult, 2, Pos('^', sResult) - 2);          // '2014-11-04'

//    sIODate := Copy(sResult, 1, Pos('^', sResult) - 2);          // '2014-11-04'
    sTemp := Copy(sResult, Pos('^', sResult) + 1, Length(sResult) - (Pos('^', sResult)));
    sIOTime := Copy(sTemp, 1, Pos('^', sTemp) - 1);                // '13:05:10'
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sCarNo := Copy(sTemp, 1, Pos('^', sTemp) - 1);                // 차량번호: '31로6819'
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sName := Copy(sTemp, 1, Pos('^', sTemp) - 1);                 // 이름: '홍길동'
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sCompName := Copy(sTemp, 1, Pos('^', sTemp) - 1);             // 동
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sDeptName:= Copy(sTemp, 1, Pos('^', sTemp) - 1);              // 호
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    //Copy(sTemp, nPos + 1, (Length(sTemp) - (nPos)) + 2);
    sExpDate := Copy(sTemp, 1, Pos('^', sTemp) - 1);              // 유효기간
    nPos := Pos('^', sTemp);
    sStatus := Copy(sTemp, nPos + 1, Length(sTemp) - nPos);      // '2014-12-03까지^입 차'

    // 입구
    if nIO = 1 then
    begin
      with frmMain do
      begin
        // 화면에 표시(정기, 동, 호, 차량번호)
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '정기';
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        if (sCompName <> '') or (sDeptName <> '') then
          TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= sCompName +'동 '+  sDeptName + '호'
        else
          TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo;
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
        with sgIn do
        begin
          InsertRows(1, 1, True);
          Cells[0, 1] := '정기차량';
          Cells[1, 1] := sIODate;
          Cells[2, 1] := sIOTime;
          Cells[3, 1] := sCarNo;
          Cells[4, 1] := sCompName +'동 '+  sDeptName + '호';
          Cells[5, 1] := sName;
          Cells[6, 1] := sExpDate;
          Cells[7, 1] := sStatus;
        end;
        sgIn.Alignments[0, 1] := taCenter;
        sgIn.Alignments[1, 1] := taCenter;
        sgIn.Alignments[2, 1] := taCenter;
        sgIn.Alignments[3, 1] := taCenter;
        sgIn.Alignments[4, 1] := taCenter;
        sgIn.Alignments[5, 1] := taCenter;
        sgIn.Alignments[6, 1] := taCenter;
        sgIn.Alignments[7, 1] := taCenter;
      end;
    end
    // 출구
    else
    begin
      with frmMain do
      begin
        // 화면에 표시(정기, 동, 호, 차량번호)
        TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '정기';
        TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        if (sCompName <> '') or (sDeptName <> '') then
          TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= sCompName +'동 '+  sDeptName + '호'
        else
          TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
        TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo;
        TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
        TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
        TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
        with sgOut do
        begin
          InsertRows(1, 1, True);
          Cells[0, 1] := '정기차량';
          Cells[1, 1] := sIODate;
          Cells[2, 1] := sIOTime;
          Cells[3, 1] := sCarNo;
          Cells[4, 1] := sCompName +'동 '+  sDeptName + '호';
          Cells[5, 1] := sName;
          Cells[6, 1] := sExpDate;
          Cells[7, 1] := sStatus;
        end;
        sgOut.Alignments[0, 1] := taCenter;
        sgOut.Alignments[1, 1] := taCenter;
        sgOut.Alignments[2, 1] := taCenter;
        sgOut.Alignments[3, 1] := taCenter;
        sgOut.Alignments[4, 1] := taCenter;
        sgOut.Alignments[5, 1] := taCenter;
        sgOut.Alignments[6, 1] := taCenter;
        sgOut.Alignments[7, 1] := taCenter;
      end;
    end;
  end;
end;

// nIO: 1-입구, 2-출구    nType: 1-정기차량, 2-일반차량, 3-요금표시, 4-주차요금0원
procedure TfrmMain.csOutDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp1_connect');
  if sOutDspBasic1 <> '' then
  begin
    csOutDsp1.Socket.SendText(sOutDspBasic1);
//    csOutDsp1.Active:= False;
    sOutDspBasic1:= '';
  end;
//  if sOutDspBasic1 <> '' then
//  begin
//    ExceptLogging('OutDsp1_전광판문구전송');
//    csOutDsp1.Socket.SendText(sOutDspBasic1);
//    prDelay(nDspInterval);
//  end;
end;

procedure TfrmMain.csOutDsp1Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp1_Disconnect');
end;

procedure TfrmMain.csOutDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[Out]>DSP1 Recv: ' + sRecv);
//  prDelay(nDspInterval);
//  csOutDsp1 .Active:= False;
//  sOutDspBasic1 := '';
end;


procedure TfrmMain.csOutLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr1Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csOutLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
    tOutAlive1.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv1 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr1.Tag) + ' Recv: ' + sOutLPRRecv1);

    if Length(sOutLPRRecv1) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr1.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr1.Tag;
      sLprData := sOutLPRRecv1;
      sLprIP := csOutLpr1.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr1;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR1 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
//              Close;
//              SQL.Clear;
//              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
//              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
//              Parameters.ParamByName('N1').Value := sCarNo2;
//              Parameters.ParamByName('N2').Value := sFile2;
//              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
//              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
//              Parameters.ParamByName('N5').Value := sCarNo1;
//              Parameters.ParamByName('N6').Value := nRecog2;
//              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14), '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile4:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        if nRecog1 = 1 then
        begin
          with dmTables.qryOutLpr1Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
              sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
              nCarNoLength:= Length(sCarNo1);
              Close;
              SQL.Clear;
              SQL.Add('Select * from ');
              SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
              SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
              Parameters.ParamByName('N1').Value:= sShortCarNo;
              Parameters.ParamByName('N2').Value:= sShortCarNo;
              Parameters.ParamByName('N7').Value:= sShortCarNo;

              Case nCarNoLength of
                11: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
                      Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
                    end;
                // '서울77가7789' -> 12
                12: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
                    end;
                8 : begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
                    end;
              end;
              Open;
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt);

                GridData(nIO, nListCnt, sResult);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := False;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt);
                end;
              end;
            end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
//            with frmMain do
//            begin
//              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
//              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
//              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
//              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
//              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
//              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
////              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
////              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
////              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
//            end;
//            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '일반';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            if not bMode then
            begin
                OutOpen(csLPR);
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end;
        end;
        //Image16.Refresh;
      except
        on E: Exception do
          ExceptLogging('csOutLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv1 = 'LPR_R' then
      begin
//        if chkNet(csOutLpr1, '시간동기화 전송') then
//        begin
////          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
////          ExceptLogging('시간동기화 전송');
//        end;
      end;
    end;
    sOutLPRRecv1 := '';
  finally
    tOutAlive1.Enabled := True;
  end;
end;

procedure TfrmMain.csOutLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
    tOutAlive2.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv2 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr2.Tag) + ' Recv: ' + sOutLPRRecv2);

    if Length(sOutLPRRecv2) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr2.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr2.Tag;
      sLprData := sOutLPRRecv2;
      sLprIP := csOutLpr2.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr2;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR2 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
//              Close;
//              SQL.Clear;
//              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
//              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
//              Parameters.ParamByName('N1').Value := sCarNo2;
//              Parameters.ParamByName('N2').Value := sFile2;
//              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
//              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
//              Parameters.ParamByName('N5').Value := sCarNo1;
//              Parameters.ParamByName('N6').Value := nRecog2;
//              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile5:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        if nRecog1 = 1 then
        begin
          with dmTables.qryOutLpr2Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
              sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
              nCarNoLength:= Length(sCarNo1);
              Close;
              SQL.Clear;
              SQL.Add('Select * from ');
              SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
              SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
              Parameters.ParamByName('N1').Value:= sShortCarNo;
              Parameters.ParamByName('N2').Value:= sShortCarNo;
              Parameters.ParamByName('N7').Value:= sShortCarNo;

              Case nCarNoLength of
                11: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 5, 1) = :N3');
                      Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
                    end;
                12: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
                    end;
                8 : begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
                    end;
              end;
              Open;
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt);

                GridData(nIO, nListCnt, sResult);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := False;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt);
                end;
              end;
            end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
            with frmMain do
            begin
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
//              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
//              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
//              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '일반';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end;
        end;
        //Image22.Refresh;
      except
        on E: Exception do
          ExceptLogging('csOutLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv2 = 'LPR_R' then
      begin
        if chkNet(csOutLpr2, '시간동기화 전송') then
        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sOutLPRRecv2 := '';
  finally
    tOutAlive2.Enabled := True;
  end;
end;

procedure TfrmMain.csOutLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  {
  try
    tOutAlive3.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv3 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr3.Tag) + ' Recv: ' + sOutLPRRecv3);

    if Length(sOutLPRRecv3) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr3.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr3.Tag;
      sLprData := sOutLPRRecv3;
      sLprIP := csOutLpr3.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr3;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR3 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile6:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        if nRecog1 = 1 then
        begin
          with dmTables.qryOutLpr3Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
              sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
              nCarNoLength:= Length(sCarNo1);
              Close;
              SQL.Clear;
              SQL.Add('Select * from ');
              SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
              SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
              Parameters.ParamByName('N1').Value:= sShortCarNo;
              Parameters.ParamByName('N2').Value:= sShortCarNo;
              Parameters.ParamByName('N7').Value:= sShortCarNo;

              Case nCarNoLength of
                11: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 5, 1) = :N3');
                      Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
                    end;
                12: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
                    end;
                8 : begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
                    end;
              end;
              Open;
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt);

                GridData(nIO, nListCnt, sResult);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                end;
              end;
            end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
            with frmMain do
            begin
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end;
        end;
        Image27.Refresh;
        pnLogo.SetFocus;
      except
        on E: Exception do
          ExceptLogging('csOutLpr3Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv3 = 'LPR_R' then
      begin
        if chkNet(csOutLpr3, '시간동기화 전송') then
        begin
          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sOutLPRRecv3 := '';
  finally
    tOutAlive3.Enabled := True;
  end;
  }
end;

procedure TfrmMain.csOutLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  {
  try
    tOutAlive4.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv4 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr4.Tag) + ' Recv: ' + sOutLPRRecv4);

    if Length(sOutLPRRecv4) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr4.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr4.Tag;
      sLprData := sOutLPRRecv4;
      sLprIP := csOutLpr4.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr4;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR3 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile7:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        if nRecog1 = 1 then
        begin
          with dmTables.qryOutLpr4Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
              sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
              nCarNoLength:= Length(sCarNo1);
              Close;
              SQL.Clear;
              SQL.Add('Select * from ');
              SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
              SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
              Parameters.ParamByName('N1').Value:= sShortCarNo;
              Parameters.ParamByName('N2').Value:= sShortCarNo;
              Parameters.ParamByName('N7').Value:= sShortCarNo;

              Case nCarNoLength of
                11: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 5, 1) = :N3');
                      Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
                    end;
                12: begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
                    end;
                8 : begin
                      SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                      SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                      Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
                      Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
                    end;
              end;
              Open;
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt);

                GridData(nIO, nListCnt, sResult);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                end;
              end;
            end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
            with frmMain do
            begin
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end;
        end;
        Image32.Refresh;
        pnLogo.SetFocus;
      except
        on E: Exception do
          ExceptLogging('csOutLpr3Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv4 = 'LPR_R' then
      begin
        if chkNet(csOutLpr4, '시간동기화 전송') then
        begin
          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sOutLPRRecv4 := '';
  finally
    tOutAlive4.Enabled := True;
  end;
  }
end;

procedure TfrmMain.DBAdvGrid1Click(Sender: TObject);
begin
  if dmTables.qrySCSearch.RecordCount > 0 then
  begin
    sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
    btnSCIn.Enabled:= True;
    btnSCOut.Enabled := True;
  end
  else
    sManualSCCarNo := '';
end;

procedure TfrmMain.dgManualClick(Sender: TObject);
begin
  if dmTables.qrySCSearch.RecordCount > 0 then
  begin
    sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
    btnManualSCIn.Enabled:= True;
    btnManualSCOut.Enabled := True;
  end
  else
  begin
    sManualSCCarNo := '';
    btnManualSCIn.Enabled:= False;
    btnManualSCOut.Enabled := False;
  end;
end;

// 전광판 문구 표출
procedure TfrmMain.DspProc(nIO, nType: Byte; sData, sDspIP: aString);
var
  i: Byte;
  sSend: aString;
begin
//  try
//    case nType of
//      1: sSend := MakeDSPData(AnsiChar($54), EMDSP1, SCCOLOR, MG_Left(sData, 24));
//      2: sSend := MakeDSPData(AnsiChar($54), EMDSP1, NOCOLOR, MG_Left(sData, 24));
//      3: sSend := MakeDSPData(AnsiChar($54), EMDSP0, YOCOLOR, MG_Left(sData, 24));
//      4: sSend := MakeDSPData(AnsiChar($54), EMDSP1, YOCOLOR, MG_Left(sData, 24));
//    end;
//
//    if nIO = 1 then
//    begin
//      for i := 1 to 1 do begin
//
//        with frmMain do begin
//
//        ExceptLogging('sDspIP(' + wString(sDspIP) + ')  <==>' + TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host);
//
//          sDspIP :=  StringReplace(sDspIP, ' ', '',  [rfReplaceAll, rfIgnoreCase]);
//
//          if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then begin
//
//            if is_ping(sDspIP) then begin
//
//              { TODO : 전광판 입차 }
//
//              if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active and
//
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.Connected then begin
//
//                try
//
//                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend)
//
//                except
//
//                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.Close;
//
//                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active := True;
//
//                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend)
//
//                end;
//
//              end else begin
//
//                ExceptLogging('전광판(' + sDspIP + ') 네트워크 끊김');
//
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.Close;
//
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active := True;
//
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend)
//
//              end;
//
//            end else  // if is_ping(sDspIP) then begin
//
//            ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
//
//          end; // if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then begin
//
//        end;  // with frmMain do begin
//
//      end;
//      for i := 1 to 5 do
//      begin
//        with frmMain do
//        begin
//          if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then
//          begin
//            if is_ping(sDspIP) then begin
//              case i  of
//                1: sInDspBasic1:= sSend;
//                2: sInDspBasic2:= sSend;
//                3: sInDspBasic3:= sSend;
//                4: sInDspBasic4:= sSend;
//                5: sInDspBasic5:= sSend;
//              end;
//              { TODO : 전광판 입차 }
//              if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active then
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active:= false;
//
//              TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active:= True;
//
//            end else  // if is_ping(sDspIP) then begin
//
//            ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
//          end;
//        end;
//      end;
//    end
//    else if nIO = 2 then
//    begin
//      for i := 1 to 1 do begin
//
//        with frmMain do begin
//
//          if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host = wString(sDspIP) then begin
//
//            if is_ping(sDspIP) then begin
//
//             { TODO : 전광판 출차 }
//
//              if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active and
//
//                 TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Connected then begin
//
//                 try
//
//                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
//
//                 except
//
//                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Close;
//
//                    //TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Connect();
//
//                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
//
//                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
//
//                 end;
//
//              end else begin
//
//                ExceptLogging('전광판(' + sDspIP + ') 네트워크 끊김');
//
//                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Close;
//
//                //TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Connect();
//
//                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
//
//                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
//
//              end;
//
//            end else
//
//              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
//
//          end;
//
//        end;
//
//      end;
//      for i := 1 to 4 do
//      begin
//        with frmMain do
//        begin
//          if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host = wString(sDspIP) then
//          begin
//            if is_ping(sDspIP) then begin
//              case i  of
//                1: sOutDspBasic1:= sSend;
//                2: sOutDspBasic2:= sSend;
//                3: sOutDspBasic3:= sSend;
//                4: sOutDspBasic4:= sSend;
//              end;
//              { TODO : 전광판 입차 }
//              if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then
//                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active:= false;
//
//              TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active:= True;
//
//            end else  // if is_ping(sDspIP) then begin
//
//            ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
//          end;
//        end;
//      end;
//    end;
//    if nIO = 1 then
//    begin
//      for i := 1 to 5 do
//      begin
//        with frmMain do
//        begin
//          if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then
//          begin
//            if is_ping(sDspIP) then
//            begin
//              if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active then
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend)
//              else
//              begin
//                ExceptLogging('전광판(' + sDspIP + ') 네트워크 끊김');
//                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active:= True;
//
//                if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active then
//                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend)
//                else
//                  ExceptLogging('전광판(' + sDspIP + ') 네트워크 재접속시에도 끊김');
//              end;
//            end
//            else
//              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
//          end;
//        end;
//      end;
//    end
//    else if nIO = 2 then
//    begin
//      for i := 1 to 3 do
//      begin
//        with frmMain do
//        begin
//          if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host = wString(sDspIP) then
//          begin
//            if is_ping(sDspIP) then
//            begin
//              if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then
//                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend)
//              else
//              begin
//                ExceptLogging('전광판(' + sDspIP + ') 네트워크 끊김');
//                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active:= True;
//
//                if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then
//                  TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend)
//                else
//                  ExceptLogging('전광판(' + sDspIP + ') 네트워크 재접속시에도 끊김');
//              end;
//            end
//            else
//              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
//          end;
//        end;
//      end;
//    end;
//  except
//    on E: Exception do ExceptLogging('DspProc: ' + aString(E.Message));
//  end;
end;


procedure TfrmMain.edtInCarNo1KeyPress(Sender: TObject; var Key: Char);
var
  sIn, sResult, sTime, sTemp, sInputCarNo: aString;
  sDspIP: aString;
  i: Byte;
begin
  try
    if Key = #13 then
    begin
      if edtInCarNo1.Text = '' then
      begin
        ShowMessage('차량번호를 입력하여주세요!');
        edtInCarNo1.SetFocus;
        Exit;
      end;

      with dmTables.qrySCSearch do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr('%' + Trim(edtInCarNo1.Text) + '%'));
        Open;

        if RecordCount > 0 then
        begin
          First;
          sInputCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
          sResult := RecvLprProc(sTempFile1, sInputCarNo, '', '', FormatDateTime('YYYY-MM-DD HH:NN:SS', Now),
                                 csInLpr1.Tag, 1, 2, 0, csInDsp1.Host, csInLpr1, True, 1);
          GridData(1, 1, sResult);
        end
        else
        begin
          sInputCarNo := '';
          ShowMessage('미등록차량입니다.');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.edtInCarNo1KeyPress: ' + E.Message);
  end;
end;

procedure TfrmMain.edtManualProcCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnManualSeekClick(Self);
end;

procedure TfrmMain.edtOutCarNo1KeyPress(Sender: TObject; var Key: Char);
var
  sIn, sResult, sTime, sTemp, sInputCarNo: aString;
  sDspIP: aString;
  i: Byte;
begin
  try
    if Key = #13 then
    begin
      if edtOutCarNo1.Text = '' then
      begin
        ShowMessage('차량번호를 입력하여주세요!');
        edtOutCarNo1.SetFocus;
        Exit;
      end;

      with dmTables.qrySCSearch do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr('%' + Trim(edtOutCarNo1.Text) + '%'));
        Open;

        if RecordCount > 0 then
        begin
          First;
          sInputCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
          sResult := RecvLprProc(sTempFile4, sInputCarNo, '', '', FormatDateTime('YYYY-MM-DD HH:NN:SS', Now),
                                 csOutLpr1.Tag, 2, 2, 0, csOutDsp1.Host, csOutLpr1, True, 1);
          GridData(2, 1, sResult);
        end
        else
        begin
          sInputCarNo := '';
          ShowMessage('미등록차량입니다.');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.edtOutCarNo1KeyPress: ' + E.Message);
  end;
end;

procedure TfrmMain.edtSCCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnSCClick(Self);
end;

procedure TfrmMain.FormAlign;
begin

end;

procedure TfrmMain.FormShow(Sender: TObject);
begin

end;

// 일반차량 출차처리
procedure TfrmMain.NGridData(sResult: String);
begin

end;

procedure TfrmMain.NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; nListCnt: Byte);
var
  sNow, sInCarNo, sInTKNo, sInDate, sInTime, sParking, sInFile, sImgFile1,
    sImgFile2, sLocalFile, sTime, sDir, sYogum, sTemp: aString;
  nDay, nHour, nMin, nOutCnt: Cardinal;
  nInUnitNo, i: Word;
  hr: HRESULT;
begin
  // 일반차량 출차처리...
  try
  try
    bNCOutProcWait := True;
    nowLpr := csLPR;
    sNow:= FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    // 일반차량 시간대별 출입현황 조회
    with dmTables.qryNormalOut2 do
    begin
      // 일반차량 입출차 자료 조회, 미출차된 자료 최신순으로 조회
      Close;
      SQL.Clear;
      SQL.Add('Select * from IONData where OutChk = :N1 and ');
      SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3)) ');
      SQL.Add('Order By ProcDate Desc, ProcTime Desc');
      Parameters.ParamByName('N1').Value := 0;
      Parameters.ParamByName('N2').Value := sLprCarNo1;
      Parameters.ParamByName('N3').Value := sLprCarNo1;
      Open;

      // 입출차 데이터 있으면
      if RecordCount > 0 then
      begin
        nInUnitNo := FieldByName('UnitNo').AsInteger;
        sInTKNo := FieldByName('TKNo').AsString;

        // 정상인식이면
        if nLprRecog1 = 1 then
        begin
          sInCarNo := sLprCarNo1;
          sInFile := FieldByName('InImage1').AsString;
          sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
          sNowInCarNo := sInCarNo;
          sNowInFile := sInFile;
        end
        else
        begin
          sInCarNo := sLprCarNo1;
          sInFile := FieldByName('InImage1').AsString;
          sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
          sNowInCarNo := sInCarNo;
          sNowInFile := sInFile;
        end;
        sInDate := FieldByName('ProcDate').AsString;
        sInTime := FieldByName('ProcTime').AsString;
        sNowInDate := sInDate;
        sNowInTime := sInTime;

        // 입출차 데이터 있으면 업데이트 처리
//        Close;
//        SQL.Clear;
//        SQL.Add('Update IONData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
//        SQL.Add('OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
//        SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N16 ');
//        SQL.Add('where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
//        Parameters.ParamByName('N1').Value := nLprNo;
//        Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
//        Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
//        Parameters.ParamByName('N4').Value := 4;
//        Parameters.ParamByName('N5').Value := sLprFile1;
//        Parameters.ParamByName('N6').Value := sLprCarNo1;
//        Parameters.ParamByName('N7').Value := sLprFile2;
//        Parameters.ParamByName('N8').Value := sLprCarNo2;
//        Parameters.ParamByName('N9').Value := nLprRecog1;
//        Parameters.ParamByName('N10').Value := nLprRecog2;
//        Parameters.ParamByName('N11').Value := nCurrParkNo;
//        Parameters.ParamByName('N12').Value := nInUnitNo;
//        Parameters.ParamByName('N13').Value := sInDate;
//        Parameters.ParamByName('N14').Value := sInTime;
//        Parameters.ParamByName('N15').Value := sInTKNo;
//        Parameters.ParamByName('N16').Value := '';
//        ExecSQL;
//        OutOpen(csLPR);
      end
      else
      begin
        // 입출차 데이터 없으면 데이터 등록
        sInTKNo:= MG_InsZero(IntToStr(GetTickCount), 10);

//        Close;
//        SQL.Clear;
//        Close;
//        SQL.Clear;
//        SQL.Add('Insert Into IONData ');
//        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, InImage1, InCarNo1, ');
//        SQL.Add('InImage2, InCarNo2, Status, InRecog1, InRecog2, OutUnitNo, OutDate, OutTime, OutChk, ');
//        SQL.Add('OutImage1, OutCarNo1, OutImage2, OutCarNo2, OutRecog1, OutRecog2) ');
//        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, ');
//        SQL.Add(':N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23, :N24 ) ');
//        Parameters.ParamByName('N1').Value := nCurrParkNo;
//        Parameters.ParamByName('N2').Value := nLprNo;
//        Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
//        Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
//        Parameters.ParamByName('N5').Value := sInTKNo;
//        Parameters.ParamByName('N6').Value := 1;
//        Parameters.ParamByName('N7').Value := 1;
//        Parameters.ParamByName('N8').Value := '';
//        Parameters.ParamByName('N9').Value := '';
//        Parameters.ParamByName('N10').Value:= '';
//        Parameters.ParamByName('N11').Value:= '';
//        Parameters.ParamByName('N12').Value:= 1;
//        Parameters.ParamByName('N13').Value:= 0;
//        Parameters.ParamByName('N14').Value:= 0;
//        Parameters.ParamByName('N15').Value:= nLprNo;
//        Parameters.ParamByName('N16').Value:= Copy(sNow, 1, 10);
//        Parameters.ParamByName('N17').Value:= Copy(sNow, 12, 8);
//        Parameters.ParamByName('N18').Value:= 1;
//        Parameters.ParamByName('N19').Value:= sLprFile1;
//        Parameters.ParamByName('N20').Value:= sLprCarNo1;
//        Parameters.ParamByName('N21').Value:= '';
//        Parameters.ParamByName('N22').Value:= '';
//        Parameters.ParamByName('N23').Value:= nLprRecog1;
//        Parameters.ParamByName('N24').Value:= nLprRecog2;
//        ExecSQL;
//        if not bMode then
//        begin
//            OutOpen(csLPR);
//        end;
      end;
    end;
    NormalLogging('미등록차량 출차: ' + sLprCarNo1 + ' - ' + sLprFile1);

    try
      if FileExists(sLprFile1) then
      begin
        with frmMain do
        begin
          TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
        end;
      end
      else
      begin
        with frmMain do
        begin
          TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
        end;
        ExceptLogging('File 없음: ' + sLprFile1);
      end;
    except
      on E: Exception do
        ExceptLogging('이미지 로드 에러(NormatOut): ' + aString(E.Message));
    end;

    with frmMain do
    begin
      // 화면에 치량번호 인식상태 => 일반, 차량번호 표시
      TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
      TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '일반';
      TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
      TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
      TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
      TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
      TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
      TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
      TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
    end;
//    DspProc(2, 2, ' 미등록차량 ' + MG_Left(sLprCarNo1, 12), sDspIP);
    NGridData('2' + sLprCarNo1 + '^' + Copy(sNow, 1, 10) + ' ' + Copy(sNow, 12, 8) + '^'+ ''+'^'+TLabel(FindComponent('lbOut' + IntToStr(nListCnt))).Caption);
  except
    on E: Exception do
      ExceptLogging('NormalOut: ' + aString(E.Message));
  end;

  finally
    bNCOutProcWait := False;
  end;
end;


// 동일한 차량번호로 입차된 기존 미출차차량은 미출차정리로 처리
function TfrmMain.MakeHomeCrc(sData: AnsiString): ansiChar;
var
  sTemp: aString;
  nCrc, i, nLength: Byte;
begin
  sTemp:= sData;
  nLength:= Length(aString(sTemp));
  nCrc:= 0;

  for i := 1 to nLength do
    nCrc:= nCrc xor Ord(sTemp[i]);

  Result:= AnsiChar(nCrc);
end;

function TfrmMain.MakeMassage(sOrder, sVal: String): String;
var
  sReturn : String;
begin
  sReturn := '<' + sOrder + '>' + sVal + '</' + sOrder + '>' + #13#10;
  Result := sReturn;
end;

procedure TfrmMain.MichulProc(sCarNo, sProcDate, sProcTime: AnsiString);
begin
  if (sCarNo <> '') and (sCarNo <> '0000000000') then
  begin
    try
      with dmTables.qryMichulProc do
      begin
//        Close;
//        SQL.Clear;
//        SQL.Add('Update IONData Set OutChk = :N1, OutDate = :N2, OutTime = :N3 ');
//        SQL.Add('where ((InCarNo1 = :N4) or (InCarNo2 = :N5)) and OutChk = 0');
//        Parameters.ParamByName('N1').Value := 7;
//        Parameters.ParamByName('N2').Value := sProcDate;
//        Parameters.ParamByName('N3').Value := sProcTime;
//        Parameters.ParamByName('N4').Value := sCarNo;
//        Parameters.ParamByName('N5').Value := sCarNo;
//        ExecSQL;
      end;
    except
      on E: Exception do
        ExceptLogging('TfrmMainNew.MichulProc: ' + aString(E.Message));
    end;
  end;
end;

procedure TfrmMain.mnuOutDspClick(Sender: TObject);
begin

end;

// 일반차량 입출차 처리, 출차 -> [NormalOut]
procedure TfrmMain.NormalProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte);
var
  sTKNo, sLprDate, sLprTime, sSend, sTemp: aString;
  nInCnt: Word;
  inValue: String;
  frmMessage: TfrmMessage;
//  sTKNo, sLprDate, sLprTime, sSend, sTemp: aString;
//  nInCnt: Word;
begin
  try
    ExceptLogging('일반차량: ' + sLprCarNo1 + ', ' + sLprCarNo2);
    sLprDate := Copy(sIOTime, 1, 10);
    sLprTime := Copy(sIOTime, 12, 8);
    if nLprInOut = 1 then begin
      try
        bNCInProcWait := True;
        // 동일한 차량번호로 입차된 기존 미출차차량은 미출차정리로 처리...
        if (sLprCarNo1 <> '') and (sLprCarNo1 <> '0000000000') then
          MichulProc(sLprCarNo1, sLprDate, sLprTime);

        if (sLprCarNo2 <> '') and (sLprCarNo2 <> '0000000000') then
          MichulProc(sLprCarNo2, sLprDate, sLprTime);
//        DspProc(1, 2, ' 미등록차량 ' + MG_Left(sLprCarNo1, 12), sDspIP);
        if FileExists(sLprFile1) then begin
          with frmMain do begin
            ExceptLogging('일반차량 입차 이미지 가져오기 시작');
            TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
            ExceptLogging('일반차량 입차 이미지 가져오기 끝');
          end;
        end else begin
          with frmMain do begin
            TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
          end;
          ExceptLogging('File 없음: ' + sLprFile1);
        end;
        NormalLogging('미등록차량 입차: ' + sLprCarNo1 + ' - ' + sLprFile1);

      with frmMain do
      begin
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '일반';
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
      end;

//        if bMode then
//        begin
//          inValue := '입차불가';
//          if nListCnt = 1 then
//            begin
//            frmMessage := TfrmMessage.Create(Application);
//            try
//              if frmMessage.ShowModal = mrOK then begin
//                //bOpen :=True;
//                inValue := frmMessage.edtMemo.Text;
//              if inValue = '' then begin
//                 inValue := '사유 미작성'
//              end;
//              end;
//            finally
//              frmMessage.Free;
//              frmMessage := nil;
//            end;
//          end;
//        end
//        else
//        begin
//          if nListCnt = 1 then
//          begin
//            inValue := '입차';
//          end
//          else
//          begin
//            inValue := '입차불가';
//          end;
//        end;
        NGridData('1' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime + '^'+ inValue+'^'+TLabel(FindComponent('lbIn' + IntToStr(nListCnt))).Caption);
        //sTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
        sTKNo := FormatDateTime('YYYYMMDDHHNNSS', Now)+ IntToStr(nCurrUnitNo) ;
        with dmTables.qryNormal do begin
//          Close;
//          SQL.Clear;
//          Close;
//          SQL.Clear;
//          SQL.Add('Insert Into IONData ');
//          SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, InImage1, InCarNo1, ');
//          SQL.Add('InImage2, InCarNo2, Status, InRecog1, InRecog2,Reserve1) ');
//          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15)');
//          Parameters.ParamByName('N1').Value := nCurrParkNo;
//          Parameters.ParamByName('N2').Value := nLprNo;
//          Parameters.ParamByName('N3').Value := sLprDate;
//          Parameters.ParamByName('N4').Value := sLprTime;
//          Parameters.ParamByName('N5').Value := sTKNo;
//          Parameters.ParamByName('N6').Value := 1;
//          Parameters.ParamByName('N7').Value := 1;
//          Parameters.ParamByName('N8').Value := sLprFile1;
//          Parameters.ParamByName('N9').Value := sLprCarNo1;
//          Parameters.ParamByName('N10').Value := sLprFile2;
//          Parameters.ParamByName('N11').Value := sLprCarNo2;
//          Parameters.ParamByName('N12').Value := 1;
//          Parameters.ParamByName('N13').Value := nLprRecog1;
//          Parameters.ParamByName('N14').Value := nLprRecog2;
//          Parameters.ParamByName('N15').Value := inValue;
//          ExecSQL;
////          if nListCnt = 1 then
////          begin
//          if not bMode then
//          begin
//            InOpen(csLPR);
//          end
//          else
//          begin
//            if bOpen then
//              InOpen(csLPR);
//          end;
//          end
//          else
//          begin
//             ExceptLogging('NormalProc: 아파트 전용 문 안 열어줌' );
//          end;
        end;
      finally
        bNCInProcWait := False;
      end;
    end else if nLprInOut = 2 then begin
      // 출차처리...
      NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2, sIOTime, nLprNo, nLprInOut, nLprRecog1, nLprRecog2, sDspIP, csLPR, nListCnt);
    end;
  except
    on E: Exception do
      ExceptLogging('NormalProc: ' + aString(E.Message));
  end;
end;


procedure TfrmMain.HomeInfoTest_BeeJu;
var
  sSend: aString;
  nLength: Integer;
  sLength: String;
begin
  try
    sSend:= '';
    // 입력받은 차량번호 뒷자리 4자리 자르기

    // 입력받은 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      sSend := '<Message>' + #13#10 + '<header>' + #13#10 + MakeMassage('txid', '1') +
          MakeMassage('type', 'event') + MakeMassage('dest', 'wallpad') +
          MakeMassage('command', '') + MakeMassage('feedback', 'false') +
          '</header>' + #13#10 + '<target>' + #13#10 + MakeMassage('total_num', '1') +
          MakeMassage('1', edtDong.Text + '-' + edtHo.Text) + '</target>' + #13#10 +
          '<body>' + #13#10 + '<event>' + #13#10 + MakeMassage('name' , 'car') +
          '<argument>' + #13#10 + MakeMassage('number', edtCar.Text) +
          MakeMassage('time', FormatDateTime('YYYYMMDDHHNNSS', Now)) +
          MakeMassage('mode','0') + MakeMassage('gateid', '') + MakeMassage('manid', '') +
          MakeMassage('cardno', '') + '</argument>' + #13#10 + '</event>' + #13#10 +
          '</body>' + #13#10 + '</message>';
      nLength := Length(sSend) * 2 -2;
      sLength := MG_InsZero(IntToStr(nLength), 8);
      sSend := sLength + sSend;                      //길이값 8바이트 추가
      HomeInfoLogging('홈넷전문 : ' + sSend);

      if IdTC_Beeju.Connected then
        IdTC_Beeju.Disconnect;

      IdTC_Beeju.Host:= sHomeInfo_IP;
      IdTC_Beeju.Port:= nHomeInfo_Port;

      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Beeju.Connect;

        // idTC 연결되었으면 세대통보하고 연결끊기
        if IdTC_Beeju.Connected then
        begin
          IdTC_Beeju.Socket.WriteLnRFC(sSend, IndyTextEncoding_UTF16LE);
          HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' + edtHo.Text + '호 ' + edtCar.Text);
          IdTC_Beeju.Disconnect;
        end
        else
        begin
          HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
        end;
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 세대통보 ping 전송시 네트워크 에러!');
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;


procedure TfrmMain.HomeInfoTest_EZ;
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    // 입력받은 차량번호 뒷자리 4자리 자르기
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-3, 4);

    // 입력받은 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      sSend:= '$version=2.0$dongho=' + sezVilleDong + '&' + sezVilleHo +
              '$cmd=30$target=parking#mode=0#dongho=' + edtDong.Text + '&' +
              edtHo.Text + '#inout=0#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
              '#carno=' + sShortCarNo;

      sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
      nSendLength:= StrToInt(sSendLength);
      sSend:= '<start=' + sSendLength + '&0>' + sSend;

      try
        if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
        begin
          if is_Ping(sHomeInfo_IP) then
          begin
            if csHomeInfo_EZ.Socket.Connected then
            begin
              try
                if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                begin
                  HomeInfoLogging('입차통보: ' + sSend);
                end
                else
                begin
                  HomeInfoLogging('입차통보 에러: ' + sSend);
                end;
              except
                on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
              end;
            end
            else
            begin
              csHomeInfo_EZ.Close;

              if is_Ping(sHomeInfo_IP) then
              begin
                csHomeInfo_EZ.Open;
                try
                  if csHomeInfo_EZ.Socket.Connected then
                  begin
                    if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                    begin
                      HomeInfoLogging('입차통보(2): ' + sSend);
                    end
                    else
                    begin
                      HomeInfoLogging('입차통보 에러(2): ' + sSend);
                    end;
                  end;
                except
                  on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
                end;
              end
              else
                HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨(2)!');
            end;
          end
          else
          begin
            HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨!');
          end;
        end;
      except
        on E: Exception do HomeInfoLogging('입차통보 에러(3): ' + sSend);
      end;
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_Gye;
type
  TSendData = packed record
    dong: WORD;
    ho: WORD;
    command: ansiChar;
    length: WORD;
    InDate: array[1..20] of ansiChar;
    IOType: array[1..2] of ansiChar;
    CarNo: array[1..4] of ansiChar;
    Temp: array[1..9] of ansiChar;
  end;

var
  sShortCarNo, sSendLength: aString;
  i: Byte;
  tmpPchr : Pchar;
  SendData : TSendData;
  SendBuff : TIdBytes;
tmpStr: String;
  tmpCnt: Integer;
begin
  try
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-4, 4);
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin

      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

      SendData.ho := Swap(strtoint(edtHo.Text));
      SendData.dong := Swap(strtoint(edtDong.Text));
      SendData.command := chr(1);
      SendData.length := Swap(35);
      tmpStr := FormatDateTime('YYYY-MM-DD,HH:NN:SS,', NOW);
      for tmpCnt := 1 to 20 do
        SendData.InDate[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      Case cmbIO.ItemIndex of
        0: SendData.IOType := '0,';
        1: SendData.IOType := '1,';
      end;
      tmpStr := sShortCarNo;
      for tmpCnt := 1 to 4 do
        SendData.CarNo[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      SendData.Temp := ',00000000';

      if IdTC_Gyeyoung.Connected then
        IdTC_Gyeyoung.Disconnect;

      IdTC_Gyeyoung.Host:= sHomeInfo_IP;
      IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Gyeyoung.Connect;

        if IdTC_Gyeyoung.Connected then
        begin
          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          IdTC_Gyeyoung.IOHandler.Write(SendBuff);
          IdTC_Gyeyoung.Disconnect;
          case cmbIO.ItemIndex of
            0: HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' +
                                edtHo.Text + '호 ' + edtCar.Text);
            1: HomeInfoLogging('출차 세대통보 전송: ' + edtDong.Text + '동 ' +
                               edtHo.Text + '호 ' + edtCar.Text);
          end;
        end
        else
        begin
          HomeInfoLogging(sHomeInfo_IP + '로 세대통보 연결 에러!');
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 ping 전송시 에러!');
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_Hyun;
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    sSend:= '';
    HomeInfoLogging('세대통보 테스트 전송: ' + edtDong.Text + '동 ' + edtHo.Text + '호 ' + edtCar.Text);

    // 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      // '00000070Type=PARKING&Dong=101&Ho=101&CarNo=7789&DateTime=201410221402&InOut=IN'
      sSend:= 'Type=PARKING&Dong=' + edtDong.Text + '&Ho=' + edtHo.Text + '&CarNo=' + edtCar.Text + '&DateTime=' +
             FormatDateTime('YYYYMMDDHHNN', Now) + '&InOut=';

      sSend:= sSend + 'IN';
      sSend:= MG_InsZero(IntToStr(Length(sSend)), 8) + sSend;

      // idTC 연결되있으면 끊기
      if IdTc_HyunDai.Connected then
        IdTc_HyunDai.Disconnect;

      // 홈넷 IP, Port 저장
      IdTc_HyunDai.Host:= sHomeInfo_IP;
      IdTc_HyunDai.Port:= nHomeInfo_Port;

      // 홈넷 ping
      if is_Ping(sHomeInfo_IP) then
      begin
        // idTC 연결
        IdTc_HyunDai.Connect;

        // idTC 연결 되었으면
        if IdTc_HyunDai.Connected then
        begin
          // 세대통보 전송
          IdTc_HyunDai.Socket.WriteLnRFC(sSend, enUTF8);
          IdTc_HyunDai.Disconnect;
          HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' + edtHo.Text + '호 ' + edtCar.Text);
        end
        else
        begin
          HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 연결 실패!');
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 ping 에러!');
    end;
  except
    on E: Exception do HomeInfoLogging('TfrmMain.HomeInfoTest_Hyun > 세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeinfoTest_Icon;
var
  sHomeData, sFile: aString;
  sXml: TXMLDocument;
  iNode: IXMLNode;
  mTemp: TMemoryStream;
begin
  try
    sHomeInfo_Dong:= edtDong.Text;
    sHomeInfo_Ho:= edtHo.Text;
    sHomeInfo_CarNo:= edtCar.Text;
    sHomeInfo_Data:= '<?xml version="1.0" encoding="utf-8"?>' + //#13 +
                '<imap ver = "1.0" address = "' + sHomeInfo_IP + '" sender = "주차관리">' + //+#13 +
                '<service type = "request" name = "car_move_info">' + //+ #13 +
                '<destination name = "homedev" id_high = "' + edtDong.Text + '" id_low = "' + edtHo.Text + '"/>' + // + #13 +
                '<move_info> "in" </move_info>' + //+ #13 +
                '<params car_num = "' + edtCar.Text + '" loc_num = "입구" message = "null"/>' + // + #13 +
                '</service>' + //+ #13 +
                '</imap>';

    if is_Ping(sHomeInfo_IP) then
    begin
      csHomeInfo_icon.Active:= False;
      csHomeInfo_icon.Active:= True;
    end
    else
      HomeInfoLogging('세대통보 전송 시 홈넷 Ping 안됨');
  except
    on E: Exception do HomeInfoLogging('세대통보 테스트: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeinfoTest_Kocom;
var
  sSend: aString;
  sShortCarNo, sSendLength, sTemp: aString;
  nSendLength, nChkLength: Integer;
  i: Byte;
begin
  try
    FillChar(RKPark_Info, SizeOf(RKPark_Info), AnsiChar($00));

    RKPark_Info.nHeaderKey:= nGHeaderKey;
    RKPark_Info.nMsgType:= nGPark_Info;
    RKPark_Info.nMsgLength:= SizeOf(RPark_Info);
    RKPark_Info.nTown:= 0;
    RKPark_Info.nDong:= StrToInt(edtDong.Text);
    RKPark_Info.nHo:= StrToInt(edtHo.Text);
    RKPark_Info.nReserved:= 0;

    sTemp:= IntToStr(cmbIO.ItemIndex + 1);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sGateid[i]:= sTemp[i];
    end;

    sTemp:= 'aps';

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sManager[i]:= sTemp[i];
    end;

    sTemp:= IntToStr(GetTickCount);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sCardNo[i]:= sTemp[i];
    end;

    RKPark_Info.nInOut:= cmbIO.ItemIndex + 1;

    sTemp:= FormatDateTime('YYYYMMDDHHNNSS', Now);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sDate[i]:= sTemp[i];
    end;

    sTemp:= edtCar.Text;
    nChkLength:= Length(sTemp);

    for i:= 1 to nChkLength do
    begin
      RKPark_Info.sCarNo[i]:= sTemp[i];
    end;

    if is_Ping(sHomeInfo_IP) then
    begin
      try
        if idTC_Kocom.Connected then
        begin
          idTC_Kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
          HomeInfoLogging('세대통보 전송, 차량번호: ' + edtCar.Text + ' 동: ' + edtDong.Text + ' 호: ' + edtHo.Text);
        end;
      except
        on E: EIdSocketError do
        begin
          tAlive.Enabled:= True;
          idTC_Kocom.Disconnect;
          ExceptLogging('세대통보시 Bind Error');
          btnBind.Click;
        end;
      end;
    end
    else
      ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    {
    //코콤 시리얼 세대통보...
    if comKocom.Open then
    begin
      if (Length(edtDong.Text) > 0) and
         (Length(edtHo.Text) > 0) and
         (Length(edtCar.Text) >= 4) and
         MG_NumberCheck(edtDong.Text) and
         MG_NumberCheck(edtHo.Text) and
         MG_NumberCheck(Copy(aString(edtCar.Text), Length(aString(edtCar.Text))-3, 4)) then
      begin
        nResend:= 1;
        sSend:= KocomMakeString(nResend, MG_InsZero(edtDong.Text, 4) +
                MG_InsZero(edtHo.Text, 4),
                MG_InsZero(Copy(aString(edtCar.Text), Length(aString(edtCar.Text))-3, 4), 4), cmbIO.ItemIndex+1);
        comKocom.PutString(sSend);
        bReceive:= False;
        nHomeInfo_InOut:= cmbIO.ItemIndex+1;
        tKocom.Enabled:= True;
      end
      else
      begin
        ShowMessage('Kocom 시리얼 세대통보 테스트시 입력정보 오류: 동-' + edtDong.Text + ',  ' +
                      '호-' + edtHo.Text + ',  ' + '차량번호-' + edtCar.Text);
      end;
    end
    else
    begin
      ExceptLogging('Kocom 시리얼 세대통보시 포트오픈 안됨!');
    end;
    }
  except
    on E: Exception do ExceptLogging('TfrmMain.btnHomeInfoTestClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_Proc_Gye;
type
  TSendData = packed record
    dong: WORD;
    ho: WORD;
    command: ansiChar;
    length: WORD;
    InDate: array[1..20] of ansiChar;
    IOType: array[1..2] of ansiChar;
    CarNo: array[1..4] of ansiChar;
    Temp: array[1..9] of ansiChar;
  end;

var
  sShortCarNo, sSendLength: aString;
  i: Byte;
  tmpPchr : Pchar;
  SendData : TSendData;
  SendBuff : TIdBytes;
tmpStr: String;
  tmpCnt: Integer;
begin
  try
    //세대통보
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-4, 4);
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화
      SendData.ho := Swap(strtoint(edtHo.Text));
      SendData.dong := Swap(strtoint(edtDong.Text));
      SendData.command := chr(1);
      SendData.length := Swap(35);
      tmpStr := FormatDateTime('YYYY-MM-DD,HH:NN:SS,', NOW);
      for tmpCnt := 1 to 20 do
        SendData.InDate[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      Case cmbIO.ItemIndex of
        0: SendData.IOType := '0,';
        1: SendData.IOType := '1,';
      end;
      tmpStr := sShortCarNo;
      for tmpCnt := 1 to 4 do
        SendData.CarNo[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      SendData.Temp := ',00000000';

      if IdTC_Gyeyoung.Connected then
        IdTC_Gyeyoung.Disconnect;

      IdTC_Gyeyoung.Host:= sHomeInfo_IP;
      IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Gyeyoung.Connect;

        if IdTC_Gyeyoung.Connected then
        begin
          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          IdTC_Gyeyoung.IOHandler.Write(SendBuff);
          IdTC_Gyeyoung.Disconnect;
          case cmbIO.ItemIndex of
            0: HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' +
                                edtHo.Text + '호 ' + edtCar.Text);
            1: HomeInfoLogging('출차 세대통보 전송: ' + edtDong.Text + '동 ' +
                               edtHo.Text + '호 ' + edtCar.Text);
          end;
        end
        else
        begin
          HomeInfoLogging(sHomeInfo_IP + '로 세대통보 연결 에러!');
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_UBiz;
Type
    TSendData =  record
    STX : array[1..4] of ansiChar;
    Gubun : array[1..2] of ansiChar;
    PacketType : ansiChar;
    Data1 : ansiChar;
    Data2 : ansiChar;
    Dong : array[1..4] of ansiChar;
    Ho : array[1..4] of ansiChar;
    CarNo : array[1..12] of ansiChar;
    ETX : ansiChar;
    CheckSum: ansiChar;
  end;
var
  sShortCarNo: String;
  i, nLength: Byte;
  tmpPchr : Pchar;
  tmpCarNo: ansiString;
  tmpCnt: Integer;
  sTemp : aString;
  nCarNoLength : Byte;
  sSend: aString;
  SendData : TSendData;
  SendBuff : TIdBytes;
  sCarNo : String;
begin
   try
      HomeInfoLogging('홈넷차량정보 > 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
      sSend := '';

      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

      // 차량번호 12자리
      nCarNoLength:= Length(sHomeInfo_CarNo);
      case nCarNoLength of
        8: tmpCarNo :=  sHomeInfo_CarNo + '0000';
        11: tmpCarNo :=  sHomeInfo_CarNo + '0';
        12: tmpCarNo :=  sHomeInfo_CarNo;
      end;

      // 동, 호수  4자리
      if not MG_NumberCheck(sHomeInfo_Dong) then
        sHomeInfo_Dong:= '0000';

      if not MG_NumberCheck(sHomeInfo_Ho) then
        sHomeInfo_Ho:= '0000';

      if Length(sHomeInfo_Dong) = 3 then
        sHomeInfo_Dong := '0' + sHomeInfo_Dong;

      if Length(sHomeInfo_Ho) = 3 then
        sHomeInfo_Ho := '0' + sHomeInfo_Ho;

      //sSend:= MakeKyeYoungHome(sHomeInfo_Dong, sHomeInfo_Ho, tmpStr);

      // STX 연동구분 PacketType, Data1, Data2, 동, 호, 차량번호, CheckSum, ETX
      SendData.STX[1] := AnsiChar($AA);
      SendData.STX[2] := AnsiChar($AA);
      SendData.STX[3] := AnsiChar($AA);
      SendData.STX[4] := AnsiChar($A0);

      SendData.Gubun[1] := AnsiChar($BB);
      SendData.Gubun[2] := AnsiChar($BB);

      SendData.PacketType := AnsiChar($A1);

      SendData.Data1 := AnsiChar($01);

      SendData.Data2 := AnsiChar($01);

      for tmpCnt := 1 to 4 do
        SendData.Dong[tmpCnt] := AnsiChar(sHomeInfo_Dong[tmpCnt]);

      for tmpCnt := 1 to 4 do
        SendData.Ho[tmpCnt] := AnsiChar(sHomeInfo_Ho[tmpCnt]);

      nLength:= Length(aString(tmpCarNo));

      for tmpCnt := 1 to nLength do
      begin
        sCarNo := inttohex(ord(tmpcarno[tmpcnt]),2);
        SendData.CarNo[tmpCnt]:= AnsiChar(StrToInt(aString('$' + sCarNo)));

        HomeInfoLogging(aString('$' + sCarNo));
      end;

      //  연동구분 ~ 차량번호까지 XOR연산 ...
      sTemp := SendData.Gubun[1] + SendData.Gubun[2] + SendData.PacketType + SendData.Data1
                + SendData.Data2 + sHomeInfo_Dong + sHomeInfo_Ho + tmpCarNo ;

      SendData.CheckSum  := MakeHomeCrc(sTemp);

      SendData.ETX := AnsiChar($00);
      //sBuf:= STX + Gubun + PacketType + Data1 + Data2 + sDong + sHo + sCarNo + sCheckSum + ETX ;


      if is_ping(sHomeInfo_IP) then
      begin
        try
          if idUC_ubiz.Connected then
          begin

            SendBuff := RawToBytes(SendData, SizeOf(SendData));
            idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

            HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
          end
          else
          begin
            idUC_ubiz.Disconnect;
            Sleep(200);
            idUC_ubiz.Connect;

            SendBuff := RawToBytes(SendData, SizeOf(SendData));
            idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);
            HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
          end;
        except
          on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
        end;
      end
      else
      begin
        HomeInfoLogging('단지서버로 세대통보 전송시 ping 에러');
      end;
    except
      on E: Exception do HomeInfoLogging('TfrmMain.HomeInfo_Proc: ' + aString(E.Message));
    end;
end;

procedure TfrmMain.HomeInfo_Proc(nInOut: Byte);
begin
  if nHomeinfo_Comp = 0 then
  begin
    HomeInfoLogging('홈넷 설정 없음 미전송');
  end
  else if nHomeInfo_Comp = 1 then     //현대통신
  begin
    HomeInfo_Proc_Hyun(nInOut);
  end
  else if nHomeInfo_Comp = 2 then     //코콤
  begin
    HomeInfo_Proc_Kocom(nInOut);
  end
  else if nHomeInfo_Comp = 3 then     //아이컨트롤스
  begin
    HomeInfo_Proc_Icon(nInOut);
  end
  else if nHomeInfo_Comp = 4 then     //계영정보통신
  begin
    HomeInfo_Proc_Gye(nInOut);
  end
  else if nHomeInfo_Comp = 5 then     //삼성중공업 유비즈
  begin
    HomeInfo_Proc_UBiz(nInOut);
  end
  else if nHomeInfo_Comp = 6 then     //이지빌
  begin
    HomeInfo_Proc_EZ(nInOut);
  end
  else if nHomeInfo_Comp = 7 then     //한화 비쥬드림 ucamp
  begin
    HomeInfo_Proc_BeeJu(nInOut);
  end

end;


procedure TfrmMain.HomeInfo_Proc_BeeJu(nInOut: Byte);
var
  sSend: aString;
  nLength: Integer;
  sLength: String;
begin
  try
    sSend:= '';

    // 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
//      HomeInfoLogging('세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);

      if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
      begin
        sSend := '<Message>' + #13#10 + '<header>' + #13#10 + MakeMassage('txid', '1') +
            MakeMassage('type', 'event') + MakeMassage('dest', 'wallpad') +
            MakeMassage('command', '') + MakeMassage('feedback', 'false') +
            '</header>' + #13#10 + '<target>' + #13#10 + MakeMassage('total_num', '1') +
            MakeMassage('1', sHomeInfo_Dong + '-' + sHomeInfo_Ho) + '</target>' + #13#10 +
            '<body>' + #13#10 + '<event>' + #13#10 + MakeMassage('name' , 'car') +
            '<argument>' + #13#10 + MakeMassage('number', sHomeInfo_CarNo) +
//            '<argument>' + #13#10 + MakeMassage('number', sHomeInfo_ShortCarNo) +
            MakeMassage('time', FormatDateTime('YYYYMMDDHHNNSS', Now)) +
            MakeMassage('mode','0') + MakeMassage('gateid', '') + MakeMassage('manid', '') +
            MakeMassage('cardno', '') + '</argument>' + #13#10 + '</event>' + #13#10 +
            '</body>' + #13#10 + '</message>' + #13#10;
        nLength := Length(sSend) * 2 -2;
        sLength := MG_InsZero(IntToStr(nLength), 8);
        sSend := sLength + sSend;                      //길이값 8바이트 추가

//        // idTC 연결되있으면 끊기
//        if idTC.Connected then
//          idTC.Disconnect;

        // 홈넷 IP, Port 저장
        idTC.Host:= sHomeInfo_IP;
        idTC.Port:= nHomeInfo_Port;

        // 홈넷 ping
        if is_Ping(sHomeInfo_IP) then
        begin
          // idTC 연결
  //        idTC.Connect;
         if not(idTC.Connected) then
         begin
          idTC.Connect;
          ExceptLogging('홈넷 연결 성공');
         end;


          // idTC 연결 되었으면
          if idTC.Connected then
          begin
            idTC.Socket.WriteLnRFC(sSend, IndyTextEncoding_UTF16LE);
            HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);
            idTC.Disconnect;
          end
          else
          begin
            HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
          end;
        end
        else
          ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
      end;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;


procedure TfrmMain.HomeInfo_Proc_EZ(nInOut: Byte);
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    HomeInfoLogging('차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);

    if Length(sHomeInfo_CarNo) >= 4 then
    begin
      sShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);

      if not MG_NumberCheck(sShortCarNo) then
        sShortCarNo:= '0000';
    end
    else
      sShortCarNo:= '0000';

    if not MG_NumberCheck(sHomeInfo_Dong) then
      sHomeInfo_Dong:= '000';

    if not MG_NumberCheck(sHomeInfo_Ho) then
      sHomeInfo_Ho:= '000';

    sSend:= '$version=2.0$dongho=' + sezVilleDong + '&' + sezVilleHo +
            '$cmd=30$target=parking#mode=0#dongho=' + sHomeInfo_Dong + '&' +
            sHomeInfo_Ho + '#inout=0#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
            '#carno=' + sShortCarNo;

    sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
    nSendLength:= StrToInt(sSendLength);
    sSend:= '<start=' + sSendLength + '&0>' + sSend;

    try
      if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
      begin
        if is_Ping(sHomeInfo_IP) then
        begin
          if csHomeInfo_EZ.Socket.Connected then
          begin
            try
              if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
              begin
                HomeInfoLogging('입차통보: ' + sSend);
              end
              else
              begin
                HomeInfoLogging('입차통보 에러: ' + sSend);
              end;
            except
              on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
            end;
          end
          else
          begin
            csHomeInfo_EZ.Close;

            if is_Ping(sHomeInfo_IP) then
            begin
              csHomeInfo_EZ.Open;

              try
                if csHomeInfo_EZ.Socket.Connected then
                begin
                  if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                  begin
                    HomeInfoLogging('입차통보(2): ' + sSend);
                  end
                  else
                  begin
                    HomeInfoLogging('입차통보 에러(2): ' + sSend);
                  end;
                end;
              except
                on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
              end;
            end
            else
              HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨(2)!');
          end;
        end
        else
        begin
          HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨!');
        end;
      end;
    except
      on E: Exception do HomeInfoLogging('입차통보 에러(3): ' + sSend);
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Gye(nInOut: Byte);
type
  TSendData = packed record
    dong: WORD;
    ho: WORD;
    command: ansiChar;
    length: WORD;
    InDate: array[1..20] of ansiChar;
    IOType: array[1..2] of ansiChar;
    CarNo: array[1..4] of ansiChar;
    Temp: array[1..9] of ansiChar;
  end;
var
  sShortCarNo, sSendLength: aString;
  i: Byte;
  tmpPchr : Pchar;
  SendData : TSendData;
  SendBuff : TIdBytes;
  tmpStr: String;
  tmpCnt: Integer;
begin
  try
    //세대통보
    sShortCarNo:= sHomeInfo_ShortCarNo;
    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

      SendData.ho := Swap(strtoint(sHomeInfo_Ho));
      SendData.dong := Swap(strtoint(sHomeInfo_Dong));
      SendData.command := chr(1);
      SendData.length := Swap(35);
      tmpStr := FormatDateTime('YYYY-MM-DD,HH:NN:SS,', NOW);
      for tmpCnt := 1 to 20 do
        SendData.InDate[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);
      Case nInOut of
        1: SendData.IOType := '0,';
        2: SendData.IOType := '1,';
      end;
//      Case cmbIO.ItemIndex of
//        0: SendData.IOType := '0,';
//        1: SendData.IOType := '1,';
//      end;
      tmpStr := sShortCarNo;
      for tmpCnt := 1 to 4 do
        SendData.CarNo[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      SendData.Temp := ',00000000';

      if IdTC_Gyeyoung.Connected then
        IdTC_Gyeyoung.Disconnect;

      IdTC_Gyeyoung.Host:= sHomeInfo_IP;
      IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Gyeyoung.Connect;

        if IdTC_Gyeyoung.Connected then
        begin
          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          IdTC_Gyeyoung .IOHandler.Write(SendBuff);
          IdTC_Gyeyoung .Disconnect;
        end;
        case nInOut of
          1: HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
          2: HomeInfoLogging('출차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
        end;
        ExceptLogging(' ');
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Hyun(nInOut: Byte);
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    // 울산 신천 엠코타운 - 현대통신 세대통보
    sSend:= '';

    // 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
      // '00000070Type=PARKING&Dong=101&Ho=101&CarNo=7789&DateTime=201410221402&InOut=IN'
      sSend:= 'Type=PARKING&Dong=' + sHomeInfo_Dong + '&Ho=' + sHomeInfo_Ho + '&CarNo=' + sHomeInfo_ShortCarNo + '&DateTime=' +
             FormatDateTime('YYYYMMDDHHNN', Now) + '&InOut=';

      Case nInOut of
        1: sSend:= sSend + 'IN';
        2: sSend:= sSend + 'OUT';
      end;
      sSend:= MG_InsZero(IntToStr(Length(sSend)), 8) + sSend;

      // idTC 연결되있으면 끊기
      if IdTc_HyunDai.Connected then
        IdTc_HyunDai.Disconnect;

      // 홈넷 IP, Port 저장
      IdTc_HyunDai.Host:= sHomeInfo_IP;
      IdTc_HyunDai.Port:= nHomeInfo_Port;

      // 홈넷 ping
      if is_Ping(sHomeInfo_IP) then
      begin
        // idTC 연결
        IdTc_HyunDai.Connect;

        // idTC 연결 되었으면
        if IdTc_HyunDai.Connected then
        begin
          IdTc_HyunDai.Socket.WriteLnRFC(sSend, enUTF8);
          IdTc_HyunDai.Disconnect;
          case nInOut of
            1: HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
            2: HomeInfoLogging('출차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
          end;
        end
        else
        begin
           ExceptLogging(sHomeInfo_IP + '로 현대통신 세대통보 연결 실패!')
        end;
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 현대통신 세대통보 ping 전송시 네트워크 에러!');
    end;
  except
    on E: Exception do HomeInfoLogging('현대통신 세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Icon(nInOut: Byte);
var
  sHomeData, sFile: aString;
  sXml: TXMLDocument;
  iNode: IXMLNode;
  mTemp: TMemoryStream;
begin
  try
    sHomeInfo_Data:= '<?xml version="1.0" encoding="utf-8"?>' + //#13 +
                '<imap ver = "1.0" address = "' + sHomeInfo_IP + '" sender = "주차관리">' + //+#13 +
                '<service type = "request" name = "car_move_info">' + //+ #13 +
                '<destination name = "homedev" id_high = "' + sHomeInfo_Dong + '" id_low = "' + sHomeInfo_Ho + '"/>' + // + #13 +
                '<move_info> "in" </move_info>' + //+ #13 +
                '<params car_num = "' + sHomeInfo_CarNo + '" loc_num = "입구" message = "null"/>' + // + #13 +
                '</service>' + //+ #13 +
                '</imap>';

    if is_Ping(sHomeInfo_IP) then
    begin
      csHomeInfo_icon.Active:= False;
      csHomeInfo_icon.Active:= True;
    end
    else
      HomeInfoLogging('세대통보 전송 시 홈넷 Ping 안됨');
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Kocom(nInOut: Byte);
var
  sSend: aString;
  sShortCarNo, sSendLength, sTemp: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    FillChar(RKPark_Info, SizeOf(RKPark_Info), AnsiChar($00));
    RKPark_Info.nHeaderKey:= nGHeaderKey;
    RKPark_Info.nMsgType:= nGPark_Info;
    RKPark_Info.nMsgLength:= SizeOf(RPark_Info);
    RKPark_Info.nTown:= 0;
    RKPark_Info.nDong:= StrToInt(sHomeInfo_Dong);
    RKPark_Info.nHo:= StrToInt(sHomeInfo_Ho);
    RKPark_Info.nReserved:= 0;

    sTemp:= IntToStr(nInOut);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sGateid[i]:= sTemp[i];
    end;

    sTemp:= 'aps';

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sManager[i]:= sTemp[i];
    end;

    sTemp:= sHomeInfo_CardNo;

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sCardNo[i]:= sTemp[i];
    end;

    RKPark_Info.nInOut:= nInOut;

    sTemp:= FormatDateTime('YYYYMMDDHHNNSS', Now);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sDate[i]:= sTemp[i];
    end;

    sTemp:= sHomeInfo_CarNo;

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sCarNo[i]:= sTemp[i];
    end;

    if is_Ping(sHomeInfo_IP) then
    begin
      try
        if IdTC_kocom.Connected then
        begin
          IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
          HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//          tKocomCheck.Interval:= 200;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//          tKocomCheck.Enabled:= True;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
        end
        else
        begin
          IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
          HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//          tKocomCheck.Interval:= 200;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//          tKocomCheck.Enabled:= True;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
        end;
      except
        on E: EIdSocketError do
        begin
          tAlive.Enabled:= True;
          IdTC_kocom.Disconnect;
          ExceptLogging('세대통보시 Bind Error');
          btnBind.Click;
        end;
      end;
    end
    else
    begin
      if is_Ping(sHomeInfo_IP) then
      begin
        try
          if IdTC_kocom.Connected then
          begin
            IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
            HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//            tKocomCheck.Interval:= 200;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//            tKocomCheck.Enabled:= True;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
          end
          else
          begin
            IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
            //ExceptLogging('세대통보 전송(' + sHomeInfo_CarNo + ')' );
            HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//            tKocomCheck.Interval:= 200;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//            tKocomCheck.Enabled:= True;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
          end;
        except
          on E: EIdSocketError do
          begin
            tAlive.Enabled:= True;
            IdTC_kocom.Disconnect;
            ExceptLogging('세대통보시 Bind Error');
            btnBind.Click;
          end;
        end;
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 세대통보 Ping 재전송시 네트워크 에러!');
    end;

    {
    //코콤 시리얼 세대통보...
    if comKocom.Open then
    begin
      if (Length(sHomeInfo_Dong) > 0) and
         (Length(sHomeInfo_Ho) > 0) and
         (Length(sHomeInfo_CarNo) >= 4) and
         MG_NumberCheck(sHomeInfo_Dong) and
         MG_NumberCheck(sHomeInfo_Ho) and
         MG_NumberCheck(Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4)) then
      begin
        nResend:= 1;
        sSend:= KocomMakeString(nResend, MG_InsZero(sHomeInfo_Dong, 4) +
                MG_InsZero(sHomeInfo_Ho, 4),
                MG_InsZero(Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4), 4), nInOut);
        comKocom.PutString(sSend);
        bReceive:= False;
        nHomeInfo_InOut:= nInOut;
        tKocom.Enabled:= True;
      end
      else
      begin
        ExceptLogging('Kocom 시리얼 세대통보시 입력정보 오류: 동-' + sHomeInfo_Dong + ',  ' +
                      '호-' + sHomeInfo_Ho + ',  ' + '차량번호-' + sHomeInfo_CarNo);
      end;
    end
    else
    begin
      ExceptLogging('Kocom 시리얼 세대통보시 포트오픈 안됨!');
    end;
    }
  except
    on E: Exception do
    begin
      HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
    end;
  end;
end;

procedure TfrmMain.HomeInfo_Proc_UBiz(nInOut: Byte);
Type
  //TSendData = Packed record
    TSendData =  record
    STX : array[1..4] of ansiChar;
    Gubun : array[1..2] of ansiChar;
    PacketType : ansiChar;
    Data1 : ansiChar;
    Data2 : ansiChar;
    Dong : array[1..4] of ansiChar;
    Ho : array[1..4] of ansiChar;
    CarNo : array[1..12] of ansiChar;
    ETX : ansiChar;
    CheckSum: ansiChar;
  end;
var
  sShortCarNo: String;
  i, nLength: Byte;
  tmpPchr : Pchar;
  tmpCarNo: ansiString;
  tmpCnt: Integer;
  sTemp : aString;
  nCarNoLength : Byte;
  sSend: aString;
  SendData : TSendData;
  SendBuff : TIdBytes;
  sCarNo : String;
begin
  try
    HomeInfoLogging('홈넷차량정보 > 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
    sSend := '';

    FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

    // 차량번호 12자리
    nCarNoLength:= Length(sHomeInfo_CarNo);
    case nCarNoLength of
      8: tmpCarNo :=  sHomeInfo_CarNo + '0000';
      11: tmpCarNo :=  sHomeInfo_CarNo + '0';
      12: tmpCarNo :=  sHomeInfo_CarNo;
    end;

    // 동, 호수  4자리
    if not MG_NumberCheck(sHomeInfo_Dong) then
      sHomeInfo_Dong:= '0000';

    if not MG_NumberCheck(sHomeInfo_Ho) then
      sHomeInfo_Ho:= '0000';

    if Length(sHomeInfo_Dong) = 3 then
      sHomeInfo_Dong := '0' + sHomeInfo_Dong;

    if Length(sHomeInfo_Ho) = 3 then
      sHomeInfo_Ho := '0' + sHomeInfo_Ho;

    //sSend:= MakeKyeYoungHome(sHomeInfo_Dong, sHomeInfo_Ho, tmpStr);

    // STX 연동구분 PacketType, Data1, Data2, 동, 호, 차량번호, CheckSum, ETX
    SendData.STX[1] := AnsiChar($AA);
    SendData.STX[2] := AnsiChar($AA);
    SendData.STX[3] := AnsiChar($AA);
    SendData.STX[4] := AnsiChar($A0);

    SendData.Gubun[1] := AnsiChar($BB);
    SendData.Gubun[2] := AnsiChar($BB);

    SendData.PacketType := AnsiChar($A1);

    SendData.Data1 := AnsiChar($01);

    SendData.Data2 := AnsiChar($01);

    for tmpCnt := 1 to 4 do
      SendData.Dong[tmpCnt] := AnsiChar(sHomeInfo_Dong[tmpCnt]);

    for tmpCnt := 1 to 4 do
      SendData.Ho[tmpCnt] := AnsiChar(sHomeInfo_Ho[tmpCnt]);

    nLength:= Length(aString(tmpCarNo));

    for tmpCnt := 1 to nLength do
    begin
      sCarNo := inttohex(ord(tmpcarno[tmpcnt]),2);
      SendData.CarNo[tmpCnt]:= AnsiChar(StrToInt(aString('$' + sCarNo)));

      HomeInfoLogging(aString('$' + sCarNo));
    end;

    //  연동구분 ~ 차량번호까지 XOR연산 ...
    sTemp := SendData.Gubun[1] + SendData.Gubun[2] + SendData.PacketType + SendData.Data1
              + SendData.Data2 + sHomeInfo_Dong + sHomeInfo_Ho + tmpCarNo ;

    SendData.CheckSum  := MakeHomeCrc(sTemp);

    SendData.ETX := AnsiChar($00);
    //sBuf:= STX + Gubun + PacketType + Data1 + Data2 + sDong + sHo + sCarNo + sCheckSum + ETX ;

    if is_ping(sHomeInfo_IP) then
    begin
      try
        if idUC_ubiz.Connected then
        begin

          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

          HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
        end
        else
        begin
          idUC_ubiz.Disconnect;
          Sleep(200);
          idUC_ubiz.Connect;

          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);
          HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
        end;
      except
        on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
      end;
    end
    else
    begin
      HomeInfoLogging('단지서버로 세대통보 전송시 ping 에러');
    end;
  except
    on E: Exception do HomeInfoLogging('TfrmMain.HomeInfo_Proc: ' + aString(E.Message));
  end;
end;

function TfrmMain.RecvLprProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte): String;
var
  sRecv, sSend, sName: aString;
  nSTXPos, nETXPos, nParkNo, nUnitNo: Integer;

  sCardNo, sLastUseTime, sSTime, sETime, sCarNo, sMarkNo, sGroupName,
    sSCInDate, sSCInTime, sCompName, sDeptName, sExpDateF, sExpDateT, sLprDate,
    sLprTime, sTemp, sInFile, sHISTime, sHIETime: aString;
  nInOut, nStatus, nAPB, nWP, nSYoil, nEYoil, nCarNo, nGroupNo, nHIType: Integer;
  nLastUnitNo: Byte;
  nIBCRC: Word;
  bHoliday,bHIType: Boolean;
  nUseFlag, nLastStatus: Byte;
begin
  try
    try
      bSCProcWait := True;
      bHomeInfo:= True;
      // 정기차량 처리....
      ExceptLogging('정기차량시작: ' + sLprCarNo1 + ', ' + sLprCarNo2);
      Result := '^^^^^^';
      nParkNo := nCurrParkNo;
      nUnitNo := nLprNo;
      nInOut := nLprInOut;
      nCarNo := 0;
      nLastUnitNo := 0;
      sCardNo := '';
      sMarkNo := '';
      bHoliday := False;
      sLprDate := Copy(sIOTime, 1, 10);
      sLprTime := Copy(sIOTime, 12, 8);

      with dmTables.qryRecvLpr1 do
      begin
        Close;
        SQL.Clear;

        // 정기차량 조회
        if sLprCarNo2 <> '' then
        begin
          SQL.Add('Select * from CustInfo where (CarNo = :N1) or (CarNo = :N2) and TKType = 2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
          Parameters.ParamByName('N2').Value := sLprCarNo2;
        end
        else
        begin
          SQL.Add('Select * from CustInfo where CarNo = :N1 and TKType = 2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
        end;
        Open;

        if RecordCount > 0 then
        begin
          sCardNo := FieldByName('TKNo').AsString;
          sMarkNo := FieldByName('MarkNo').AsString;
          nStatus := FieldByName('Status').AsInteger;
          nAPB := FieldByName('APB').AsInteger;
          nLastStatus := FieldByName('IOStatusNo').AsInteger;
          sLastUseTime := FieldByName('LastUseDate').AsString + ' ' + FieldByName('LastUseTime').AsString;
          nWP := FieldByName('WPNo').AsInteger;
          nGroupNo := FieldByName('GroupNo').AsInteger;
          sName := FieldByName('Name').AsString;
          nLastUnitNo := FieldByName('LastUnitNo').AsInteger;
          sCompName := FieldByName('CompName').AsString;
          sDeptName := FieldByName('DeptName').AsString;
          sExpDateF := FieldByName('ExpDateF').AsString;
          sExpDateT := FieldByName('ExpDateT').AsString;
          nHIType:= FieldByName('HIType').AsInteger;         // 세대통보여부
          sHISTime:= FieldByName('HISTime').AsString;        // 세대통보 시작시각
          sHIETime:= FieldByName('HIETime').AsString;        // 세대통보 종료시각
          sCarNo := FieldByName('CarNo').AsString;
          sHomeInfo_CarNo:= MG_StrTrim(sCarNo, ' ');         // 홈넷 차량번호
          if (sHISTime <>'') and (sHIETime <>'') then
          begin
            if sHISTime < sHIETime then
            begin
              bHIType := True;
            end
            else
            begin
              bHIType := False;
            end;
          end
          else
          begin
            bHIType := True;
          end;

          // 홈넷 차량번호가 4자리 이상이면 차량번호 뒷자리 4자리 자르기
          if Length(sHomeInfo_CarNo) >= 4 then
          begin
            sHomeInfo_ShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);

            // 뒷자리 4자리 자른 차량 번호에 숫자가 없으면 ???
            if not MG_NumberCheck(sHomeInfo_ShortCarNo) then
              sHomeInfo_ShortCarNo:= '0000';
          end
          else
            sHomeInfo_ShortCarNo:= '0000';

          sHomeInfo_Dong:= MG_StrTrim(sCompName, ' ');         // 홈넷 동
          sHomeInfo_Ho:= MG_StrTrim(sDeptName, ' ');           // 홈넷 호

          Result := sLprDate + '^' + sLprTime + '^' + sCarNo + '^' + sName + '^' + sCompName + '^' + sDeptName + '^' + sExpDateT + '까지^';
        end;
      end;
//
//      if (nHIType = 1) then
//      begin
        bHomeInfo:= True;
//      end
//      else
//      begin
//        bHomeInfo:= False;
//      end;

//      // 입차가 아님 or 세대통보 안함 or
//      // (세대통보 = 설정 통보 and (통보 시작시간 > 현재시간 or 통보 종료시간 < 현재시간))
//      if (nInOut <> 1) or (nHIType = 2) or
//         ((nHIType = 1) and ((sHISTime > FormatDateTime('HH:NN', Now)) or (sHIETime < FormatDateTime('HH:NN', Now)))) then
//        bHomeInfo:= False;

      with dmTables do
      begin
        nSYoil := 1;
        nEYoil := 7;
        sSTime := '00:00';
        sETime := '23:59';

        // 정기차량 그룹 조회
        with qryRecvLpr2 do
        begin
          Close;
          SQL.Clear;
          SQL.Add('Select * from GGroup where ParkNo = :N1 and GroupNo = :N2');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nGroupNo;
          Open;

          if RecordCount > 0 then
          begin
            sGroupName := FieldByName('GroupName').AsString;
            nGroupType := FieldByName('GroupType').AsInteger;
            nUseFeeItem := FieldByName('UseFeeItem').AsInteger;    // 적용할 요금종류 번호
          end;
        end;

        try
          // Lpr 파일1이 있으면
          if FileExists(sLprFile1) then
          begin
            // 입차
            if nInOut = 1 then
            begin
              with frmMain do
              begin
                ExceptLogging('정기차량 입차 이미지 가져오기 시작');
                TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
                ExceptLogging('정기차량 입차 이미지 가져오기 끝');
              end;
            end
            // 출차
            else
            if nInOut = 2 then
            begin
              with frmMain do
              begin
                ExceptLogging('정기차량 출차 이미지 가져오기 시작');
                TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
                ExceptLogging('정기차량 출차 이미지 가져오기 끝');
              end;
            end;
          end
          // 파일없으면
          else
          begin
            // 입차
            if nInOut = 1 then
            begin
              with frmMain do
              begin
                TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
              end;
            end
            // 출차
            else
            if nInOut = 2 then
            begin
              with frmMain do
              begin
                TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
              end;
            end;

            ExceptLogging('File 없음: ' + sLprFile1);
          end;
        except
          on E: Exception do
            ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
        end;

        // 현재 사용기간내에 있으면...
        if (sExpDateF <= FormatDateTime('YYYY-MM-DD', Now)) and
           (sExpDateT >= FormatDateTime('YYYY-MM-DD', Now)) then
        begin
          // 입출구 구분(입구용:1, 출구용:2)
          if nInOut = 1 then
          begin
            if ((nSYoil <= DayOfWeek(Now)) and (nEYoil >= DayOfWeek(Now)) and
                (sSTime <= FormatDateTime('HH:NN', Now)) and
                (sETime >= FormatDateTime('HH:NN', Now))) then
            begin
              // 상태(발매:0, 사용중:1, 전체봉쇄:3, 입차봉쇄:4, 출차봉쇄:5)
              Case nStatus of
                0,2:
                  begin // 발매
//                    with qryRecvLpr2 do
//                    begin
//                      Close;
//                      SQL.Clear;
//                      SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                      SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
//
//                      // APB가 "1회조정(2)" 이면 APB를 "자동(1)"으로 변경한다.
//                      if nAPB = 2 then
//                        SQL.Add(', APB = :N10 ');
//
//                      SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                      Parameters.ParamByName('N1').Value := nCurrParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 1;        // 최종사용상태: 주차장
//                      Parameters.ParamByName('N6').Value := 1;        // 상태: 사용중
//                      Parameters.ParamByName('N7').Value := nCurrParkNo;
//                      Parameters.ParamByName('N8').Value := 2;
//                      Parameters.ParamByName('N9').Value := sCarNo;
//
//                      if nAPB = 2 then
//                        Parameters.ParamByName('N10').Value := 1;
//                      ExecSQL;

//                      Close;
//                      SQL.Clear;
//                      SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                      SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                      SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
//                      SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                      SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17)');
//                      Parameters.ParamByName('N1').Value := nParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 2;
//                      Parameters.ParamByName('N6').Value := 2;
//                      Parameters.ParamByName('N7').Value := nGroupNo;
//                      Parameters.ParamByName('N8').Value := sGroupName;
//                      Parameters.ParamByName('N9').Value := sCompName;
//                      Parameters.ParamByName('N10').Value := sDeptName;
//                      Parameters.ParamByName('N11').Value := sName;
//                      Parameters.ParamByName('N12').Value := sLprCarNo1;
//                      Parameters.ParamByName('N13').Value := 1;              // 입차상태번호: 주차장
//                      Parameters.ParamByName('N14').Value := sLprFile1;
//                      Parameters.ParamByName('N15').Value := sLprCarNo2;
//                      Parameters.ParamByName('N16').Value := sLprFile2;
//                      Parameters.ParamByName('N17').Value := sCardNo;
//                      ExecSQL;
//                    end;

//                    if not bHomeInfo then
//                    begin
//                      if bOpen then
//                        InOpen(csLPR);

//                      DspProc(1, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                      Result := '1' + Result + '입 차';
//                    end
//                    else
//                    begin
////                      DspProc(1, 1, '  등록전용  ' + MG_Left(sCarNo, 12), sDspIP);
//                      Result := '1' + Result + '입차불가';
//                    end;
                  end;

                1, 5:
                  begin // 정상, 출차봉쇄
                    if nAPB = 1 then // 자동
                    begin
                      // 최종사용상태가 주차장, APB위반 입차거부일 경우
                      if (nLastStatus = 1) or (nLastStatus = 8) then
                      begin
//                        with qryRecvLpr2 do
//                        begin
//                          Close;
//                          SQL.Clear;
//                          SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                          SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
//                          SQL.Add('where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 9;        // 봉쇄중 입차시도
//                          Parameters.ParamByName('N6').Value := nParkNo;
//                          Parameters.ParamByName('N7').Value := 2;
//                          Parameters.ParamByName('N8').Value := sCarNo;
//                          ExecSQL;
//
//                          Close;
//                          SQL.Clear;
//                          SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                          SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                          SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
//                          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
//                          SQL.Add(':N13, :N14, :N15, :N16, :N17)');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 2;
//                          Parameters.ParamByName('N6').Value := 2;
//                          Parameters.ParamByName('N7').Value := nGroupNo;
//                          Parameters.ParamByName('N8').Value := sGroupName;
//                          Parameters.ParamByName('N9').Value := sCompName;
//                          Parameters.ParamByName('N10').Value := sDeptName;
//                          Parameters.ParamByName('N11').Value := sName;
//                          Parameters.ParamByName('N12').Value := sLprCarNo1;
//                          Parameters.ParamByName('N13').Value := 7;            // APB 위반(입차)
//                          Parameters.ParamByName('N14').Value := sLprFile1;
//                          Parameters.ParamByName('N15').Value := sLprCarNo2;
//                          Parameters.ParamByName('N16').Value := sLprFile2;
//                          Parameters.ParamByName('N17').Value := sCardNo;
//                          ExecSQL;
//                        end;
//                        DspProc(1, 1, 'APB위반차량 ' + MG_Left(sCarNo, 12), sDspIP);
                        bHomeInfo:= False;
                        Result := '1' + Result + 'APB위반';
                        ExceptLogging('##### APB 위반 차량 #####');
                      end
                      else
                      begin
                        // 최종사용상태가 주차장 또는 APB위반 입차거부가 아니면 입차처리한다.
//                        with qryRecvLpr2 do
//                        begin
//                          Close;
//                          SQL.Clear;
//                          SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                          SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
//                          SQL.Add('Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 1;               // 최종사용상태: 주차장
//                          Parameters.ParamByName('N6').Value := 1;               // 상태: 발매
//                          Parameters.ParamByName('N7').Value := nParkNo;
//                          Parameters.ParamByName('N8').Value := 2;
//                          Parameters.ParamByName('N9').Value := sCarNo;
//                          ExecSQL;
//
//                          Close;
//                          SQL.Clear;
//                          SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                          SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                          SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ' );
//                          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
//                          SQL.Add(':N13, :N14, :N15, :N16, :N17)');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 2;
//                          Parameters.ParamByName('N6').Value := 2;
//                          Parameters.ParamByName('N7').Value := nGroupNo;
//                          Parameters.ParamByName('N8').Value := sGroupName;
//                          Parameters.ParamByName('N9').Value := sCompName;
//                          Parameters.ParamByName('N10').Value := sDeptName;
//                          Parameters.ParamByName('N11').Value := sName;
//                          Parameters.ParamByName('N12').Value := sLprCarNo1;
//                          Parameters.ParamByName('N13').Value := 1;
//                          Parameters.ParamByName('N14').Value := sLprFile1;
//                          Parameters.ParamByName('N15').Value := sLprCarNo2;
//                          Parameters.ParamByName('N16').Value := sLprFile2;
//                          Parameters.ParamByName('N17').Value := sCardNo;
//                          ExecSQL;
//                        end;

//                        if not bHomeInfo then
//                        begin
//                          if bOpen then
//                            InOpen(csLPR);

//                          DspProc(1, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                          Result := '1' + Result + '입 차';
//                        end
//                        else
//                        begin
////                          DspProc(1, 1, '  등록전용  ' + MG_Left(sCarNo, 12), sDspIP);
//                          Result := '1' + Result + '입차불가';
//                        end;
                      end;
                    end
                    else if nAPB = 2 then
                    begin
                      // APB가 1회조정이면 APB를 자동으로 변경한다.
//                      with qryRecvLpr2 do
//                      begin
//                        Close;
//                        SQL.Clear;
//                        SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                        SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
//                        SQL.Add('Status = :N6, APB = :N10 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                        Parameters.ParamByName('N1').Value := nParkNo;
//                        Parameters.ParamByName('N2').Value := nUnitNo;
//                        Parameters.ParamByName('N3').Value := sLprDate;
//                        Parameters.ParamByName('N4').Value := sLprTime;
//                        Parameters.ParamByName('N5').Value := 1;
//                        Parameters.ParamByName('N6').Value := 1;
//                        Parameters.ParamByName('N7').Value := nParkNo;
//                        Parameters.ParamByName('N8').Value := 2;
//                        Parameters.ParamByName('N9').Value := sCarNo;
//                        Parameters.ParamByName('N10').Value := 1;
//                        ExecSQL;
//
//                        Close;
//                        SQL.Clear;
//                        SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                        SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                        SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
//                        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
//                        SQL.Add(':N13, :N14, :N15, :N16, :N17)');
//                        Parameters.ParamByName('N1').Value := nParkNo;
//                        Parameters.ParamByName('N2').Value := nUnitNo;
//                        Parameters.ParamByName('N3').Value := sLprDate;
//                        Parameters.ParamByName('N4').Value := sLprTime;
//                        Parameters.ParamByName('N5').Value := 2;
//                        Parameters.ParamByName('N6').Value := 2;
//                        Parameters.ParamByName('N7').Value := nGroupNo;
//                        Parameters.ParamByName('N8').Value := sGroupName;
//                        Parameters.ParamByName('N9').Value := sCompName;
//                        Parameters.ParamByName('N10').Value := sDeptName;
//                        Parameters.ParamByName('N11').Value := sName;
//                        Parameters.ParamByName('N12').Value := sLprCarNo1;
//                        Parameters.ParamByName('N13').Value := 1;
//                        Parameters.ParamByName('N14').Value := sLprFile1;
//                        Parameters.ParamByName('N15').Value := sLprCarNo2;
//                        Parameters.ParamByName('N16').Value := sLprFile2;
//                        Parameters.ParamByName('N17').Value := sCardNo;
//                        ExecSQL;
//                      end;

//                      if not bHomeInfo then
//                      begin
//                        if bOpen then
//                          InOpen(csLPR);

//                        DspProc(1, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                        Result := '1' + Result + '입 차';
//                      end
//                      else
//                      begin
////                        DspProc(1, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
//                        Result := '1' + Result + '입차불가';
//                      end;
                    end
                    else if nAPB = 3 then
                    begin
                      // APB사용안함이면 입차처리한다.
                      // 정기차량에 대한 최종사용정보 업데이트후 정기차량 입출차 자료 등록
//                      with qryRecvLpr2 do
//                      begin
//                        Close;
//                        SQL.Clear;
//                        SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                        SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
//                        SQL.Add('Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                        Parameters.ParamByName('N1').Value := nParkNo;
//                        Parameters.ParamByName('N2').Value := nUnitNo;
//                        Parameters.ParamByName('N3').Value := sLprDate;
//                        Parameters.ParamByName('N4').Value := sLprTime;
//                        Parameters.ParamByName('N5').Value := 1;
//                        Parameters.ParamByName('N6').Value := 1;
//                        Parameters.ParamByName('N7').Value := nParkNo;
//                        Parameters.ParamByName('N8').Value := 2;
//                        Parameters.ParamByName('N9').Value := sCarNo;
//                        ExecSQL;
//
//                        Close;
//                        SQL.Clear;
//                        SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                        SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                        SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
//                        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
//                        SQL.Add(':N13, :N14, :N15, :N16, :N17)');
//                        Parameters.ParamByName('N1').Value := nParkNo;
//                        Parameters.ParamByName('N2').Value := nUnitNo;
//                        Parameters.ParamByName('N3').Value := sLprDate;
//                        Parameters.ParamByName('N4').Value := sLprTime;
//                        Parameters.ParamByName('N5').Value := 2;
//                        Parameters.ParamByName('N6').Value := 2;
//                        Parameters.ParamByName('N7').Value := nGroupNo;
//                        Parameters.ParamByName('N8').Value := sGroupName;
//                        Parameters.ParamByName('N9').Value := sCompName;
//                        Parameters.ParamByName('N10').Value := sDeptName;
//                        Parameters.ParamByName('N11').Value := sName;
//                        Parameters.ParamByName('N12').Value := sLprCarNo1;
//                        Parameters.ParamByName('N13').Value := 1;
//                        Parameters.ParamByName('N14').Value := sLprFile1;
//                        Parameters.ParamByName('N15').Value := sLprCarNo2;
//                        Parameters.ParamByName('N16').Value := sLprFile2;
//                        Parameters.ParamByName('N17').Value := sCardNo;
//                        ExecSQL;
//                      end;

//                      if not bHomeInfo then
//                      begin
                      if bOpen then
                        InOpen(csLPR);

//                      DspProc(1, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                      Result := '1' + Result + '입 차';
//                      end
//                      else
//                      begin
//                        DspProc(1, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
//                        Result := '1' + Result + '입차불가';
//                      end;
                    end;
                  end;

                3, 4:
                  begin // 전체봉쇄, 입차봉쇄
//                    with qryRecvLpr2 do
//                    begin
//                      Close;
//                      SQL.Clear;
//                      SQL.Add(
//                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                      SQL.Add(
//                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
//                      SQL.Add(
//                        'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
//                      Parameters.ParamByName('N1').Value := nParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 9;
//                      Parameters.ParamByName('N6').Value := nParkNo;
//                      Parameters.ParamByName('N7').Value := 2;
//                      Parameters.ParamByName('N8').Value := sCarNo;
//                      ExecSQL;
//
//                      Close;
//                      SQL.Clear;
//                      SQL.Add(
//                        'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                      SQL.Add(
//                        'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                      SQL.Add(
//                        'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
//                      SQL.Add(
//                        'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
//                      SQL.Add(':N13, :N14, :N15, :N16, :N17)');
//                      Parameters.ParamByName('N1').Value := nParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 2;
//                      Parameters.ParamByName('N6').Value := 2;
//                      Parameters.ParamByName('N7').Value := nGroupNo;
//                      Parameters.ParamByName('N8').Value := sGroupName;
//                      Parameters.ParamByName('N9').Value := sCompName;
//                      Parameters.ParamByName('N10').Value := sDeptName;
//                      Parameters.ParamByName('N11').Value := sName;
//                      Parameters.ParamByName('N12').Value := sLprCarNo1;
//                      Parameters.ParamByName('N13').Value := 9;                      // 봉쇄중 입차시도
//                      Parameters.ParamByName('N14').Value := sLprFile1;
//                      Parameters.ParamByName('N15').Value := sLprCarNo2;
//                      Parameters.ParamByName('N16').Value := sLprFile2;
//                      Parameters.ParamByName('N17').Value := sCardNo;
//                      ExecSQL;
//                    end;
                    bHomeInfo:= False;
//                    DspProc(1, 1, '봉쇄차량    ' + MG_Left(sCarNo, 12), sDspIP);
                    Result := '1' + Result + '봉쇄차량';
                    ExceptLogging('##### 전체 또는 입차봉쇄 카드 #####');
                  end;
              end;
            end
            else
            begin
//              with qryRecvLpr2 do
//              begin
//                Close;
//                SQL.Clear;
//                SQL.Add(
//                  'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                SQL.Add(
//                  'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
//                SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                Parameters.ParamByName('N1').Value := nParkNo;
//                Parameters.ParamByName('N2').Value := nUnitNo;
//                Parameters.ParamByName('N3').Value := sLprDate;
//                Parameters.ParamByName('N4').Value := sLprTime;
//                Parameters.ParamByName('N5').Value := 18;
//                Parameters.ParamByName('N7').Value := nParkNo;
//                Parameters.ParamByName('N8').Value := 2;
//                Parameters.ParamByName('N9').Value := sCarNo;
//                ExecSQL;
//
//                Close;
//                SQL.Clear;
//                SQL.Add(
//                  'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                SQL.Add(
//                  'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
//                SQL.Add(
//                  'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
//                SQL.Add(':N13, :N14, :N15, :N16, :N17)');
//                Parameters.ParamByName('N1').Value := nParkNo;
//                Parameters.ParamByName('N2').Value := nUnitNo;
//                Parameters.ParamByName('N3').Value := sLprDate;
//                Parameters.ParamByName('N4').Value := sLprTime;
//                Parameters.ParamByName('N5').Value := 2;
//                Parameters.ParamByName('N6').Value := 2;
//                Parameters.ParamByName('N7').Value := nGroupNo;
//                Parameters.ParamByName('N8').Value := sGroupName;
//                Parameters.ParamByName('N9').Value := sCompName;
//                Parameters.ParamByName('N10').Value := sDeptName;
//                Parameters.ParamByName('N11').Value := sName;
//                Parameters.ParamByName('N12').Value := sLprCarNo1;
//                Parameters.ParamByName('N13').Value := 5;
//                Parameters.ParamByName('N14').Value := sLprFile1;
//                Parameters.ParamByName('N15').Value := sLprCarNo2;
//                Parameters.ParamByName('N16').Value := sLprFile2;
//                Parameters.ParamByName('N17').Value := sCardNo;
//                ExecSQL;
//              end;
              bHomeInfo:= False;
//              DspProc(1, 1, '사용시간위반' + MG_Left(sCarNo, 12), sDspIP);
              Result := '1' + Result + 'WP위반';
              ExceptLogging('##### 사용시간대(WP) 위반 #####');
            end;

            //if bHomeInfo then
            //  HomeInfo_Proc(nInOut);
          end
          else if nInOut = 2 then // 출구용
          begin
            if ((nSYoil <= DayOfWeek(Now)) and (nEYoil >= DayOfWeek(Now)) and
                (sSTime <= FormatDateTime('HH:NN', Now)) and
                (sETime >= FormatDateTime('HH:NN', Now))) then
            begin
              Case nStatus of
                0:
                  begin // 발매
//                    with qryRecvLpr2 do
//                    begin
//                      Close;
//                      SQL.Clear;
//                      SQL.Add(
//                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                      SQL.Add(
//                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
//
//                      // APB가 "1회조정(2)" 이면 APB를 "자동(1)"으로 변경한다.
//                      if nAPB = 2 then
//                        SQL.Add(', APB = :N10 ');
//
//                      SQL.Add(
//                        'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                      Parameters.ParamByName('N1').Value := nParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 2;       // 최종사용상태: 외부
//                      Parameters.ParamByName('N6').Value := 1;       // 상태: 사용중
//                      Parameters.ParamByName('N7').Value := nParkNo;
//                      Parameters.ParamByName('N8').Value := 2;
//                      Parameters.ParamByName('N9').Value := sCarNo;
//
//                      if nAPB = 2 then
//                        Parameters.ParamByName('N10').Value := 1;
//                      ExecSQL;
//
//                      Close;
//                      SQL.Clear;
//                      SQL.Add(
//                        'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                      SQL.Add(
//                        'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                      SQL.Add(
//                        'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                      SQL.Add(
//                        'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) '
//                        );
//                      SQL.Add(
//                        'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                      SQL.Add(
//                        ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                      Parameters.ParamByName('N1').Value := nParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 2;
//                      Parameters.ParamByName('N6').Value := 2;
//                      Parameters.ParamByName('N7').Value := nGroupNo;
//                      Parameters.ParamByName('N8').Value := sGroupName;
//                      Parameters.ParamByName('N9').Value := sCompName;
//                      Parameters.ParamByName('N10').Value := sDeptName;
//                      Parameters.ParamByName('N11').Value := sName;
//                      Parameters.ParamByName('N12').Value := sCarNo;
//                      Parameters.ParamByName('N13').Value := 1;
//                      Parameters.ParamByName('N14').Value := '';
//                      Parameters.ParamByName('N15').Value := nUnitNo;
//                      Parameters.ParamByName('N16').Value := sLprDate;
//                      Parameters.ParamByName('N17').Value := sLprTime;
//                      Parameters.ParamByName('N18').Value := sLprFile1;
//                      Parameters.ParamByName('N19').Value := sLprCarNo1;
//                      Parameters.ParamByName('N20').Value := 2;
//                      Parameters.ParamByName('N21').Value := sLprFile2;
//                      Parameters.ParamByName('N22').Value := sLprCarNo2;
//                      Parameters.ParamByName('N23').Value := sCardNo;
//                      ExecSQL;
//                    end;

//                    if bOpen then
//                      OutOpen(csLPR);
//
//                    DspProc(2, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                    Result := '2' + Result + '출 차';
                  end;

                1, 4:
                  begin // 사용중, 입차봉쇄
                    if nAPB = 1 then // 자동
                    begin
                      if (nLastStatus = 2) or (nLastStatus = 9) then
                      // 외부, APB위반 출차거부
                      begin
                        with qryRecvLpr2 do
                        begin
//                          Close;
//                          SQL.Clear;
//                          SQL.Add(
//                            'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                          SQL.Add(
//                            'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
//                          SQL.Add(
//                            'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 8;
//                          Parameters.ParamByName('N6').Value := 1;
//                          Parameters.ParamByName('N7').Value := nParkNo;
//                          Parameters.ParamByName('N8').Value := 2;
//                          Parameters.ParamByName('N9').Value := sCarNo;
//                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                          SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                          Parameters.ParamByName('N1').Value := sCarNo;
                          Parameters.ParamByName('N2').Value := sCarNo;
                          Open;

                          if RecordCount > 0 then
                          begin
                            First;

                            if FieldByName('OutDate').AsString = '' then
                            begin
                              // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                              sSCInDate := FieldByName('ProcDate').AsString;
                              sSCInTime := FieldByName('ProcTime').AsString;
                              nLastUnitNo := FieldByName('UnitNo').AsInteger;
                              sInFile := FieldByName('InImage1').AsString;

//                              Close;
//                              SQL.Clear;
//                              SQL.Add(
//                                'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                              SQL.Add(
//                                'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
//                              SQL.Add(
//                                'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                              SQL.Add(
//                                'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                              Parameters.ParamByName('N1').Value := nUnitNo;
//                              Parameters.ParamByName('N2').Value := sLprDate;
//                              Parameters.ParamByName('N3').Value := sLprTime;
//                              Parameters.ParamByName('N4').Value := 8;
//                              Parameters.ParamByName('N5').Value := sLprFile1;
//                              Parameters.ParamByName('N6').Value := sLprCarNo1;
//                              Parameters.ParamByName('N7').Value := sCarNo;
//                              Parameters.ParamByName('N8').Value := sSCInDate;
//                              Parameters.ParamByName('N9').Value := sSCInTime;
//                              Parameters.ParamByName('N10').Value :=
//                                nLastUnitNo;
//                              Parameters.ParamByName('N11').Value := sCarNo;
//                              Parameters.ParamByName('N12').Value := sLprFile2;
//                              Parameters.ParamByName('N13').Value := sLprCarNo2;
//                              ExecSQL;
                            end
                            else
                            begin
                              // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                              Close;
//                              SQL.Clear;
//                              SQL.Add(
//                                'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                              SQL.Add(
//                                'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                              SQL.Add(
//                                'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                              SQL.Add(
//                                'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                              SQL.Add(
//                                'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                              SQL.Add(
//                                ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                              Parameters.ParamByName('N1').Value := nParkNo;
//                              Parameters.ParamByName('N2').Value := nUnitNo;
//                              Parameters.ParamByName('N3').Value := sLprDate;
//                              Parameters.ParamByName('N4').Value := sLprTime;
//                              Parameters.ParamByName('N5').Value := 2;
//                              Parameters.ParamByName('N6').Value := 2;
//                              Parameters.ParamByName('N7').Value := nGroupNo;
//                              Parameters.ParamByName('N8').Value := sGroupName;
//                              Parameters.ParamByName('N9').Value := sCompName;
//                              Parameters.ParamByName('N10').Value := sDeptName;
//                              Parameters.ParamByName('N11').Value := sName;
//                              Parameters.ParamByName('N12').Value := sCarNo;
//                              Parameters.ParamByName('N13').Value := 8;
//                              Parameters.ParamByName('N14').Value := '';
//                              Parameters.ParamByName('N15').Value := nUnitNo;
//                              Parameters.ParamByName('N16').Value := sLprDate;
//                              Parameters.ParamByName('N17').Value := sLprTime;
//                              Parameters.ParamByName('N18').Value := sLprFile1;
//                              Parameters.ParamByName('N19').Value := sLprCarNo1;
//                              Parameters.ParamByName('N20').Value := 8;
//                              Parameters.ParamByName('N21').Value := sLprFile2;
//                              Parameters.ParamByName('N22').Value := sLprCarNo2;
//                              Parameters.ParamByName('N23').Value := sCardNo;
//                              ExecSQL;
                            end;
                          end;
                        end;
                        bHomeInfo:= False;
                        Result := '2' + Result + 'APB위반';
//                        DspProc(2, 1, 'APB위반차량 ' + MG_Left(sCarNo, 12), sDspIP);
                      end
                      else
                      begin
                        with qryRecvLpr2 do
                        begin
//                          Close;
//                          SQL.Clear;
//                          SQL.Add(
//                            'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                          SQL.Add(
//                            'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
//                          SQL.Add(
//                            'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 2;
//                          Parameters.ParamByName('N6').Value := 1;
//                          Parameters.ParamByName('N7').Value := nParkNo;
//                          Parameters.ParamByName('N8').Value := 2;
//                          Parameters.ParamByName('N9').Value := sCarNo;
//                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                          SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                          Parameters.ParamByName('N1').Value := sCarNo;
                          Parameters.ParamByName('N2').Value := sCarNo;
                          Open;

                          if RecordCount > 0 then
                          begin
                            First;

                            if FieldByName('OutDate').AsString = '' then
                            begin
                              // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                              sSCInDate := FieldByName('ProcDate').AsString;
                              sSCInTime := FieldByName('ProcTime').AsString;
                              nLastUnitNo := FieldByName('UnitNo').AsInteger;
                              sInFile := FieldByName('InImage1').AsString;

//                              Close;
//                              SQL.Clear;
//                              SQL.Add(
//                                'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                              SQL.Add(
//                                'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :12, OutCarNo2 = :N13 ');
//                              SQL.Add(
//                                'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                              SQL.Add(
//                                'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                              Parameters.ParamByName('N1').Value := nUnitNo;
//                              Parameters.ParamByName('N2').Value := sLprDate;
//                              Parameters.ParamByName('N3').Value := sLprTime;
//                              Parameters.ParamByName('N4').Value := 2;
//                              Parameters.ParamByName('N5').Value := sLprFile1;
//                              Parameters.ParamByName('N6').Value := sLprCarNo1;
//                              Parameters.ParamByName('N7').Value := sCarNo;
//                              Parameters.ParamByName('N8').Value := sSCInDate;
//                              Parameters.ParamByName('N9').Value := sSCInTime;
//                              Parameters.ParamByName('N10').Value := nLastUnitNo;
//                              Parameters.ParamByName('N11').Value := sCarNo;
//                              Parameters.ParamByName('N12').Value := sLprFile2;
//                              Parameters.ParamByName('N13').Value := sLprCarNo2;
//                              ExecSQL;
                            end
                            else
                            begin
                              // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                              Close;
//                              SQL.Clear;
//                              SQL.Add(
//                                'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                              SQL.Add(
//                                'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                              SQL.Add(
//                                'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                              SQL.Add(
//                                'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                              SQL.Add(
//                                'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                              SQL.Add(
//                                ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                              Parameters.ParamByName('N1').Value := nParkNo;
//                              Parameters.ParamByName('N2').Value := nUnitNo;
//                              Parameters.ParamByName('N3').Value := sLprDate;
//                              Parameters.ParamByName('N4').Value := sLprTime;
//                              Parameters.ParamByName('N5').Value := 2;
//                              Parameters.ParamByName('N6').Value := 2;
//                              Parameters.ParamByName('N7').Value := nGroupNo;
//                              Parameters.ParamByName('N8').Value := sGroupName;
//                              Parameters.ParamByName('N9').Value := sCompName;
//                              Parameters.ParamByName('N10').Value := sDeptName;
//                              Parameters.ParamByName('N11').Value := sName;
//                              Parameters.ParamByName('N12').Value := sCarNo;
//                              Parameters.ParamByName('N13').Value := 1;
//                              Parameters.ParamByName('N14').Value := '';
//                              Parameters.ParamByName('N15').Value := nUnitNo;
//                              Parameters.ParamByName('N16').Value := sLprDate;
//                              Parameters.ParamByName('N17').Value := sLprTime;
//                              Parameters.ParamByName('N18').Value := sLprFile1;
//                              Parameters.ParamByName('N19').Value := sLprCarNo1;
//                              Parameters.ParamByName('N20').Value := 2;
//                              Parameters.ParamByName('N21').Value := sLprFile2;
//                              Parameters.ParamByName('N22').Value := sLprCarNo2;
//                              Parameters.ParamByName('N23').Value := sCardNo;
//                              ExecSQL;
                            end;
                          end;
                        end;

//                        if bOpen then
//                          OutOpen(csLPR);

//                        DspProc(2, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                        Result := '2' + Result + '출 차';
                      end
                    end
                    else if nAPB = 2 then // 1회조정
                    begin
                      with qryRecvLpr2 do
                      begin
//                        Close;
//                        SQL.Clear;
//                        SQL.Add(
//                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                        SQL.Add(
//                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
//                        SQL.Add(
//                          'APB = :N10 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                        Parameters.ParamByName('N1').Value := nParkNo;
//                        Parameters.ParamByName('N2').Value := nUnitNo;
//                        Parameters.ParamByName('N3').Value := sLprDate;
//                        Parameters.ParamByName('N4').Value := sLprTime;
//                        Parameters.ParamByName('N5').Value := 2;
//                        Parameters.ParamByName('N6').Value := 1;
//                        Parameters.ParamByName('N7').Value := nParkNo;
//                        Parameters.ParamByName('N8').Value := 2;
//                        Parameters.ParamByName('N9').Value := sCarNo;
//                        Parameters.ParamByName('N10').Value := 1;
//                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                        SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                        Parameters.ParamByName('N1').Value := sCarNo;
                        Parameters.ParamByName('N2').Value := sCarNo;
                        Open;

                        if RecordCount > 0 then
                        begin
                          First;

                          if FieldByName('OutDate').AsString = '' then
                          begin
                            // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                            sSCInDate := FieldByName('ProcDate').AsString;
                            sSCInTime := FieldByName('ProcTime').AsString;
                            nLastUnitNo := FieldByName('UnitNo').AsInteger;
                            sInFile := FieldByName('InImage1').AsString;

//                            Close;
//                            SQL.Clear;
//                            SQL.Add(
//                              'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                            SQL.Add(
//                              'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
//                            SQL.Add(
//                              'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                            SQL.Add(
//                              'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                            Parameters.ParamByName('N1').Value := nUnitNo;
//                            Parameters.ParamByName('N2').Value := sLprDate;
//                            Parameters.ParamByName('N3').Value := sLprTime;
//                            Parameters.ParamByName('N4').Value := 2;
//                            Parameters.ParamByName('N5').Value := sLprFile1;
//                            Parameters.ParamByName('N6').Value := sLprCarNo1;
//                            Parameters.ParamByName('N7').Value := sCarNo;
//                            Parameters.ParamByName('N8').Value := sSCInDate;
//                            Parameters.ParamByName('N9').Value := sSCInTime;
//                            Parameters.ParamByName('N10').Value := nLastUnitNo;
//                            Parameters.ParamByName('N11').Value := sCarNo;
//                            Parameters.ParamByName('N12').Value := sLprFile2;
//                            Parameters.ParamByName('N13').Value := sLprCarNo2;
//                            ExecSQL;
                          end
                          else
                          begin
                            // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                            Close;
//                            SQL.Clear;
//                            SQL.Add(
//                              'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                            SQL.Add(
//                              'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                            SQL.Add(
//                              'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                            SQL.Add(
//                              'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                            SQL.Add(
//                              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                            SQL.Add(
//                              ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                            Parameters.ParamByName('N1').Value := nParkNo;
//                            Parameters.ParamByName('N2').Value := nUnitNo;
//                            Parameters.ParamByName('N3').Value := sLprDate;
//                            Parameters.ParamByName('N4').Value := sLprTime;
//                            Parameters.ParamByName('N5').Value := 2;
//                            Parameters.ParamByName('N6').Value := 2;
//                            Parameters.ParamByName('N7').Value := nGroupNo;
//                            Parameters.ParamByName('N8').Value := sGroupName;
//                            Parameters.ParamByName('N9').Value := sCompName;
//                            Parameters.ParamByName('N10').Value := sDeptName;
//                            Parameters.ParamByName('N11').Value := sName;
//                            Parameters.ParamByName('N12').Value := sCarNo;
//                            Parameters.ParamByName('N13').Value := 1;
//                            Parameters.ParamByName('N14').Value := '';
//                            Parameters.ParamByName('N15').Value := nUnitNo;
//                            Parameters.ParamByName('N16').Value := sLprDate;
//                            Parameters.ParamByName('N17').Value := sLprTime;
//                            Parameters.ParamByName('N18').Value := sLprFile1;
//                            Parameters.ParamByName('N19').Value := sLprCarNo1;
//                            Parameters.ParamByName('N20').Value := 2;
//                            Parameters.ParamByName('N21').Value := sLprFile2;
//                            Parameters.ParamByName('N22').Value := sLprCarNo2;
//                            Parameters.ParamByName('N23').Value := sCardNo;
//                            ExecSQL;
                          end;
                        end;
                      end;

//                      if bOpen then
//                        OutOpen(csLPR);

//                      DspProc(2, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                      Result := '2' + Result + '출 차';
                    end
                    else if nAPB = 3 then // 사용안함
                    begin
                      with qryRecvLpr2 do
                      begin
//                        Close;
//                        SQL.Clear;
//                        SQL.Add(
//                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                        SQL.Add(
//                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
//                        SQL.Add(
//                          'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                        Parameters.ParamByName('N1').Value := nParkNo;
//                        Parameters.ParamByName('N2').Value := nUnitNo;
//                        Parameters.ParamByName('N3').Value := sLprDate;
//                        Parameters.ParamByName('N4').Value := sLprTime;
//                        Parameters.ParamByName('N5').Value := 2;
//                        Parameters.ParamByName('N6').Value := 1;
//                        Parameters.ParamByName('N7').Value := nParkNo;
//                        Parameters.ParamByName('N8').Value := 2;
//                        Parameters.ParamByName('N9').Value := sCarNo;
//                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                        SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                        Parameters.ParamByName('N1').Value := sCarNo;
                        Parameters.ParamByName('N2').Value := sCarNo;
                        Open;

                        if RecordCount > 0 then
                        begin
                          First;

                          if FieldByName('OutDate').AsString = '' then
                          begin
                            // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                            sSCInDate := FieldByName('ProcDate').AsString;
                            sSCInTime := FieldByName('ProcTime').AsString;
                            nLastUnitNo := FieldByName('UnitNo').AsInteger;
                            sInFile := FieldByName('InImage1').AsString;

//                            Close;
//                            SQL.Clear;
//                            SQL.Add(
//                              'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                            SQL.Add(
//                              'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
//                            SQL.Add(
//                              'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                            SQL.Add(
//                              'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                            Parameters.ParamByName('N1').Value := nUnitNo;
//                            Parameters.ParamByName('N2').Value := sLprDate;
//                            Parameters.ParamByName('N3').Value := sLprTime;
//                            Parameters.ParamByName('N4').Value := 2;
//                            Parameters.ParamByName('N5').Value := sLprFile1;
//                            Parameters.ParamByName('N6').Value := sLprCarNo1;
//                            Parameters.ParamByName('N7').Value := sCarNo;
//                            Parameters.ParamByName('N8').Value := sSCInDate;
//                            Parameters.ParamByName('N9').Value := sSCInTime;
//                            Parameters.ParamByName('N10').Value := nLastUnitNo;
//                            Parameters.ParamByName('N11').Value := sCarNo;
//                            Parameters.ParamByName('N12').Value := sLprFile2;
//                            Parameters.ParamByName('N13').Value := sLprCarNo2;
//                            ExecSQL;
                          end
                          else
                          begin
                            // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                            Close;
//                            SQL.Clear;
//                            SQL.Add(
//                              'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                            SQL.Add(
//                              'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                            SQL.Add(
//                              'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                            SQL.Add(
//                              'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                            SQL.Add(
//                              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                            SQL.Add(
//                              ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                            Parameters.ParamByName('N1').Value := nParkNo;
//                            Parameters.ParamByName('N2').Value := nUnitNo;
//                            Parameters.ParamByName('N3').Value := sLprDate;
//                            Parameters.ParamByName('N4').Value := sLprTime;
//                            Parameters.ParamByName('N5').Value := 2;
//                            Parameters.ParamByName('N6').Value := 2;
//                            Parameters.ParamByName('N7').Value := nGroupNo;
//                            Parameters.ParamByName('N8').Value := sGroupName;
//                            Parameters.ParamByName('N9').Value := sCompName;
//                            Parameters.ParamByName('N10').Value := sDeptName;
//                            Parameters.ParamByName('N11').Value := sName;
//                            Parameters.ParamByName('N12').Value := sCarNo;
//                            Parameters.ParamByName('N13').Value := 1;
//                            Parameters.ParamByName('N14').Value := '';
//                            Parameters.ParamByName('N15').Value := nUnitNo;
//                            Parameters.ParamByName('N16').Value := sLprDate;
//                            Parameters.ParamByName('N17').Value := sLprTime;
//                            Parameters.ParamByName('N18').Value := sLprFile1;
//                            Parameters.ParamByName('N19').Value := sLprCarNo1;
//                            Parameters.ParamByName('N20').Value := 2;
//                            Parameters.ParamByName('N21').Value := sLprFile2;
//                            Parameters.ParamByName('N22').Value := sLprCarNo2;
//                            Parameters.ParamByName('N23').Value := sCardNo;
//                            ExecSQL;
                          end;
                        end;
                      end;

//                      // 바오픈
//                      if bOpen then
//                        OutOpen(csLPR);

                      // 전광판 긴급문구 표출
//                      DspProc(2, 1, '  등록차량  ' + MG_Left(sCarNo, 12), sDspIP);
                      Result := '2' + Result + '출 차';
                    end;
                  end;

                3, 5:
                  begin // 전체봉쇄, 출차봉쇄
                    with qryRecvLpr2 do
                    begin
//                      Close;
//                      SQL.Clear;
//                      SQL.Add(
//                        'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                      SQL.Add(
//                        'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
//                      SQL.Add(
//                        'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
//                      Parameters.ParamByName('N1').Value := nParkNo;
//                      Parameters.ParamByName('N2').Value := nUnitNo;
//                      Parameters.ParamByName('N3').Value := sLprDate;
//                      Parameters.ParamByName('N4').Value := sLprTime;
//                      Parameters.ParamByName('N5').Value := 10;
//                      Parameters.ParamByName('N6').Value := nParkNo;
//                      Parameters.ParamByName('N7').Value := 2;
//                      Parameters.ParamByName('N8').Value := sCarNo;
//                      ExecSQL;

                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                      SQL.Add('Order By InDate Desc, InTime Desc');
                      Parameters.ParamByName('N1').Value := sCarNo;
                      Parameters.ParamByName('N2').Value := sCarNo;
                      Open;

                      if RecordCount > 0 then
                      begin
                        First;

                        if FieldByName('OutDate').AsString = '' then
                        begin
                          // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                          sSCInDate := FieldByName('ProcDate').AsString;
                          sSCInTime := FieldByName('ProcTime').AsString;
                          nLastUnitNo := FieldByName('UnitNo').AsInteger;
                          sInFile := FieldByName('InImage1').AsString;

//                          Close;
//                          SQL.Clear;
//                          SQL.Add('Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                          SQL.Add('OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
//                          SQL.Add('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                          SQL.Add('ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                          Parameters.ParamByName('N1').Value := nUnitNo;
//                          Parameters.ParamByName('N2').Value := sLprDate;
//                          Parameters.ParamByName('N3').Value := sLprTime;
//                          Parameters.ParamByName('N4').Value := 10;
//                          Parameters.ParamByName('N5').Value := sLprFile1;
//                          Parameters.ParamByName('N6').Value := sLprCarNo1;
//                          Parameters.ParamByName('N7').Value := sCarNo;
//                          Parameters.ParamByName('N8').Value := sSCInDate;
//                          Parameters.ParamByName('N9').Value := sSCInTime;
//                          Parameters.ParamByName('N10').Value := nLastUnitNo;
//                          Parameters.ParamByName('N11').Value := sCarNo;
//                          Parameters.ParamByName('N12').Value := sLprFile2;
//                          Parameters.ParamByName('N13').Value := sLprCarNo2;
//                          ExecSQL;
                        end
                        else
                        begin
                          // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                          Close;
//                          SQL.Clear;
//                          SQL.Add(
//                            'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                          SQL.Add(
//                            'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                          SQL.Add(
//                            'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                          SQL.Add(
//                            'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                          SQL.Add(
//                            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                          SQL.Add(
//                            ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                          Parameters.ParamByName('N1').Value := nParkNo;
//                          Parameters.ParamByName('N2').Value := nUnitNo;
//                          Parameters.ParamByName('N3').Value := sLprDate;
//                          Parameters.ParamByName('N4').Value := sLprTime;
//                          Parameters.ParamByName('N5').Value := 2;
//                          Parameters.ParamByName('N6').Value := 2;
//                          Parameters.ParamByName('N7').Value := nGroupNo;
//                          Parameters.ParamByName('N8').Value := sGroupName;
//                          Parameters.ParamByName('N9').Value := sCompName;
//                          Parameters.ParamByName('N10').Value := sDeptName;
//                          Parameters.ParamByName('N11').Value := sName;
//                          Parameters.ParamByName('N12').Value := sCarNo;
//                          Parameters.ParamByName('N13').Value := 10;
//                          Parameters.ParamByName('N14').Value := '';
//                          Parameters.ParamByName('N15').Value := nUnitNo;
//                          Parameters.ParamByName('N16').Value := sLprDate;
//                          Parameters.ParamByName('N17').Value := sLprTime;
//                          Parameters.ParamByName('N18').Value := sLprFile1;
//                          Parameters.ParamByName('N19').Value := sLprCarNo1;
//                          Parameters.ParamByName('N20').Value := 10;
//                          Parameters.ParamByName('N21').Value := sLprFile2;
//                          Parameters.ParamByName('N22').Value := sLprCarNo2;
//                          Parameters.ParamByName('N23').Value := sCardNo;
//                          ExecSQL;
                        end;
                      end;
                    end;
                    bHomeInfo:= False;
                    Result := '2' + Result + '봉쇄중';
//                    DspProc(2, 1, '  봉쇄차량  ' + MG_Left(sCarNo, 12), sDspIP);
                    ExceptLogging('##### 전체 또는 출차봉쇄 카드(출차) #####');
                  end;
              end;
            end
            else
            begin
              with qryRecvLpr2 do
              begin
//                Close;
//                SQL.Clear;
//                SQL.Add(
//                  'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//                SQL.Add(
//                  'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
//                SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
//                Parameters.ParamByName('N1').Value := nParkNo;
//                Parameters.ParamByName('N2').Value := nUnitNo;
//                Parameters.ParamByName('N3').Value := sLprDate;
//                Parameters.ParamByName('N4').Value := sLprTime;
//                Parameters.ParamByName('N5').Value := 6;
//                Parameters.ParamByName('N7').Value := nParkNo;
//                Parameters.ParamByName('N8').Value := 2;
//                Parameters.ParamByName('N9').Value := sCarNo;
//                ExecSQL;

                Close;
                SQL.Clear;
                SQL.Add(
                  'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) Order By ProcDate Desc, ProcTime Desc');
                Parameters.ParamByName('N1').Value := sCarNo;
                Parameters.ParamByName('N2').Value := sCarNo;
                Open;

                if RecordCount > 0 then
                begin
                  First;

                  if FieldByName('OutDate').AsString = '' then
                  begin
                    // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                    sSCInDate := FieldByName('ProcDate').AsString;
                    sSCInTime := FieldByName('ProcTime').AsString;
                    nLastUnitNo := FieldByName('UnitNo').AsInteger;
                    sInFile := FieldByName('InImage1').AsString;

//                    Close;
//                    SQL.Clear;
//                    SQL.Add(
//                      'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                    SQL.Add(
//                      'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
//                    SQL.Add
//                      ('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                    SQL.Add(
//                      'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                    Parameters.ParamByName('N1').Value := nUnitNo;
//                    Parameters.ParamByName('N2').Value := sLprDate;
//                    Parameters.ParamByName('N3').Value := sLprTime;
//                    Parameters.ParamByName('N4').Value := 6;
//                    Parameters.ParamByName('N5').Value := sLprFile1;
//                    Parameters.ParamByName('N6').Value := sLprCarNo1;
//                    Parameters.ParamByName('N7').Value := sCarNo;
//                    Parameters.ParamByName('N8').Value := sSCInDate;
//                    Parameters.ParamByName('N9').Value := sSCInTime;
//                    Parameters.ParamByName('N10').Value := nLastUnitNo;
//                    Parameters.ParamByName('N11').Value := sCarNo;
//                    Parameters.ParamByName('N12').Value := sLprFile2;
//                    Parameters.ParamByName('N13').Value := sLprCarNo2;
//                    ExecSQL;
                  end
                  else
                  begin
                    // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                    Close;
//                    SQL.Clear;
//                    SQL.Add(
//                      'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                    SQL.Add(
//                      'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                    SQL.Add(
//                      'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                    SQL.Add(
//                      'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                    SQL.Add(
//                      'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                    SQL.Add(
//                      ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                    Parameters.ParamByName('N1').Value := nParkNo;
//                    Parameters.ParamByName('N2').Value := nUnitNo;
//                    Parameters.ParamByName('N3').Value := sLprDate;
//                    Parameters.ParamByName('N4').Value := sLprTime;
//                    Parameters.ParamByName('N5').Value := 2;
//                    Parameters.ParamByName('N6').Value := 2;
//                    Parameters.ParamByName('N7').Value := nGroupNo;
//                    Parameters.ParamByName('N8').Value := sGroupName;
//                    Parameters.ParamByName('N9').Value := sCompName;
//                    Parameters.ParamByName('N10').Value := sDeptName;
//                    Parameters.ParamByName('N11').Value := sName;
//                    Parameters.ParamByName('N12').Value := sCarNo;
//                    Parameters.ParamByName('N13').Value := 6;
//                    Parameters.ParamByName('N14').Value := '';
//                    Parameters.ParamByName('N15').Value := nUnitNo;
//                    Parameters.ParamByName('N16').Value := sLprDate;
//                    Parameters.ParamByName('N17').Value := sLprTime;
//                    Parameters.ParamByName('N18').Value := sLprFile1;
//                    Parameters.ParamByName('N19').Value := sLprCarNo1;
//                    Parameters.ParamByName('N20').Value := 6;
//                    Parameters.ParamByName('N21').Value := sLprFile2;
//                    Parameters.ParamByName('N22').Value := sLprCarNo2;
//                    Parameters.ParamByName('N23').Value := sCardNo;
//                    ExecSQL;
                  end;
                end;
              end;
              bHomeInfo:= False;
              Result := '2' + Result + '시간위반';
//              DspProc(2, 1, '사용시간위반' + MG_Left(sCarNo, 12), sDspIP);
              ExceptLogging('##### 사용시간대(WP) 위반(출차) #####');
            end;
          end;

          //if bHomeInfo then
          //  HomeInfo_Proc(nInOut);
        end
        else
        begin
          // 카드사용기간 오류처리..
          with qryRecvLpr2 do
          begin
//            Close;
//            SQL.Clear;
//            SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
//            SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
//            SQL.Add('where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
//            Parameters.ParamByName('N1').Value := nParkNo;
//            Parameters.ParamByName('N2').Value := nUnitNo;
//            Parameters.ParamByName('N3').Value := sLprDate;
//            Parameters.ParamByName('N4').Value := sLprTime;
//            Parameters.ParamByName('N5').Value := 3;
//            Parameters.ParamByName('N6').Value := nParkNo;
//            Parameters.ParamByName('N7').Value := 2;
//            Parameters.ParamByName('N8').Value := sCarNo;
//            ExecSQL;

            Close;
            SQL.Clear;
            SQL.Add(
              'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) Order By ProcDate Desc, ProcTime Desc');
            Parameters.ParamByName('N1').Value := sCarNo;
            Parameters.ParamByName('N2').Value := sCarNo;
            Open;

            if RecordCount > 0 then
            begin
              First;

              if FieldByName('OutDate').AsString = '' then
              begin
                // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                sSCInDate := FieldByName('ProcDate').AsString;
                sSCInTime := FieldByName('ProcTime').AsString;
                nLastUnitNo := FieldByName('UnitNo').AsInteger;
                sInFile := FieldByName('InImage1').AsString;

//                Close;
//                SQL.Clear;
//                SQL.Add(
//                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
//                SQL.Add(
//                  'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
//                SQL.Add('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
//                SQL.Add('ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
//                Parameters.ParamByName('N1').Value := nUnitNo;
//                Parameters.ParamByName('N2').Value := sLprDate;
//                Parameters.ParamByName('N3').Value := sLprTime;
//                Parameters.ParamByName('N4').Value := 3;
//                Parameters.ParamByName('N5').Value := sLprFile1;
//                Parameters.ParamByName('N6').Value := sLprCarNo1;
//                Parameters.ParamByName('N7').Value := sCarNo;
//                Parameters.ParamByName('N8').Value := sSCInDate;
//                Parameters.ParamByName('N9').Value := sSCInTime;
//                Parameters.ParamByName('N10').Value := nLastUnitNo;
//                Parameters.ParamByName('N11').Value := sCarNo;
//                Parameters.ParamByName('N12').Value := sLprFile2;
//                Parameters.ParamByName('N13').Value := sLprCarNo2;
//                ExecSQL;
              end
              else
              begin
                // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
//                Close;
//                SQL.Clear;
//                SQL.Add(
//                  'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
//                SQL.Add(
//                  'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
//                SQL.Add(
//                  'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
//                SQL.Add
//                  ('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
//                SQL.Add(
//                  'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
//                SQL.Add(
//                  ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
//                Parameters.ParamByName('N1').Value := nParkNo;
//                Parameters.ParamByName('N2').Value := nUnitNo;
//                Parameters.ParamByName('N3').Value := sLprDate;
//                Parameters.ParamByName('N4').Value := sLprTime;
//                Parameters.ParamByName('N5').Value := 2;
//                Parameters.ParamByName('N6').Value := 2;
//                Parameters.ParamByName('N7').Value := nGroupNo;
//                Parameters.ParamByName('N8').Value := sGroupName;
//                Parameters.ParamByName('N9').Value := sCompName;
//                Parameters.ParamByName('N10').Value := sDeptName;
//                Parameters.ParamByName('N11').Value := sName;
//                Parameters.ParamByName('N12').Value := sCarNo;
//                Parameters.ParamByName('N13').Value := 3;
//                Parameters.ParamByName('N14').Value := '';
//                Parameters.ParamByName('N15').Value := nUnitNo;
//                Parameters.ParamByName('N16').Value := sLprDate;
//                Parameters.ParamByName('N17').Value := sLprTime;
//                Parameters.ParamByName('N18').Value := sLprFile1;
//                Parameters.ParamByName('N19').Value := sLprCarNo1;
//                Parameters.ParamByName('N20').Value := 3;
//                Parameters.ParamByName('N21').Value := sLprFile2;
//                Parameters.ParamByName('N22').Value := sLprCarNo2;
//                Parameters.ParamByName('N23').Value := sCardNo;
//                ExecSQL;
              end;
            end;
          end;

          if nInOut = 1 then
          begin
            Result := '1' + Result + '기간만료';
//            DspProc(1, 1, '사용기간위반' + MG_Left(sCarNo, 12), sDspIP);
          end
          else if nInOut = 2 then
          begin
            Result := '2' + Result + '기간만료';
//            DspProc(2, 1, '사용기간위반' + MG_Left(sCarNo, 12), sDspIP);
          end;
          ExceptLogging('##### 사용기간 오류 - 사용시작일: ' + sExpDateF + ', 사용종료일: ' +
              sExpDateT + ' #####');
        end;
      end;
      ExceptLogging('정기차량처리: ' + sLprCarNo1 + ', ' + sLprCarNo2);
    except
      on E: Exception do
        ExceptLogging('RecvLprProc: ' + aString(E.Message));
    end;

  finally
    bSCProcWait := False;
  end;
end;


procedure TfrmMain.sgInDblClickCell(Sender: TObject; ARow, ACol: Integer);
var
  sTemp, sFileIP, sTempFile: aString;
begin
  if ARow > 0 then
  begin
    nGridCheck := 1;
    nModRow := ARow;
//
//    if (MG_StrTrim(sgIn.Cells[7, ARow], ' ') = '입차') then
//    begin
      if sgIn.Cells[0, ARow] <> '일반차량' then
      begin
        ShowMessage('일반차량의 차량번호만 수정이 가능합니다.');
        Exit;
      end;
      sOrgCarNo := MG_StrTrim(sgIn.Cells[3, ARow], ' ');
      sOrgDate := sgIn.Cells[1, ARow];
      sOrgTime := sgIn.Cells[2, ARow];
      edtMCarNo.Text := sOrgCarNo;

      with dmTables.qryTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from IONdata where ParkNo = :N1 and ((InCarNo1 = :N2) or ');
        SQL.Add('(InCarNo2 = :N3)) and ProcDate = :N4 and ProcTime = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := sOrgCarNo;
        Parameters.ParamByName('N3').Value := sOrgCarNo;
        Parameters.ParamByName('N4').Value := sOrgDate;
        Parameters.ParamByName('N5').Value := sOrgTime;
        Open;

        if RecordCount > 0 then
        begin
          sOrgFile := FieldByName('InImage1').AsString;
          nOrgUnitNo := FieldByName('UnitNo').AsInteger;
        end;
      end;

      try
        if Copy(sOrgFile, 1, 4) = 'http' then
        begin
          sTemp := Copy(sOrgFile, 6, Length(sOrgFile) - 5);
          sTempFile := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sTempFile := sTempFile + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sTempFile := MG_StrConvert(sTempFile, '/', '\');
          ExceptLogging('File: ' + sTempFile);
          sFileIP:= Copy(sTempFile, 3, Pos('\MSImage', sTempFile)-3);
        end
        else
        begin
          sTempFile :=sOrgFile ;
          sFileIP:= Copy(sTempFile, 3, Pos('\MSImage', sTempFile)-3);
        end;

        if is_ping(sFileIP) then
        begin
          if FileExists(sTempFile) then
          begin
            imgModify.Picture.LoadFromFile(sTempFile);
          end
          else
          begin
            imgModify.Picture.Assign(Nil);
            ExceptLogging('File 없음: ' + sTempFile);
          end;
        end
        else
        begin
          imgModify.Picture.Assign(Nil);
          ExceptLogging('File 없음: ' + sTempFile);
        end;
      except
        on E: Exception do
          ExceptLogging('sgInDblClickCell_ModifyImageLoad: ' + aString(E.Message));
      end;
      pnModify.Visible := True;
      edtMCarNo.SetFocus;
      edtMCarNo.SelectAll;
//    end
//    else
//      ShowMessage('입차 차량번호만 수정이 가능합니다.');
  end;
end;

procedure TfrmMain.ICMPReply(ASender: TComponent; const ReplyStatus: TReplyStatus);
begin
  case ReplyStatus.ReplyStatusType of
    rsTimeOut:
      ping_success := False;
    rsErrorUnreachable:
      ping_success := False;
    rsEcho:
      ping_success := True;
  end;
end;

procedure TfrmMain.idTSExecute(AContext: TIdContext);
var
  sRecv, sRemortIP, sSend, sData: aString;
  nCmd, nUnitNo, nMNo: Word;
  i: Byte;
  bSend: Boolean;
begin
  try
    sRecv := AContext.Connection.IOHandler.ReadString
      (AContext.Connection.IOHandler.InputBuffer.Size, enUTF8);

    if Pos(STX, sRecv) > 0 then
      sCtrl := sRecv
    else
      sCtrl := sCtrl + sRecv;

    if (Pos(STX, sCtrl) <= 0) or (Pos(ETX, sCtrl) <= 0) then
      Exit;

    sRemortIP := AContext.Binding.PeerIP;
    ExceptLogging('CtrlRecv: ' + sCtrl + ':' + sRemortIP);
    nCmd := StrToInt(Copy(sRecv, 2, 2));
    nUnitNo := StrToInt(Copy(sRecv, 4, 5));
    nMNo := StrToInt(Copy(sRecv, 9, 3));

    if Pos(ETX, sCtrl) > 12 then
    begin
      // 데이터가 있으면...
      sData := Copy(sCtrl, 12, Pos(ETX, sCtrl) - 12);
    end
    else
      sData := '';

    bSend := False;

    case nCmd of
      1:
        begin
          for i := 1 to 5 do
          begin
            with frmMain do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                .Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_OPEN-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                    .Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging
                    (TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                      .Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
            for i := 1 to 3 do
            begin
              with frmMain do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add(
                '(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime
                ('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime
                ('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
      2:
        begin
          for i := 1 to 5 do
          begin
            with frmMain do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                .Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_CLOSE-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                    .Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging
                    (TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                      .Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
            for i := 1 to 3 do
            begin
              with frmMain do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_CLOSE-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add(
                '(ParkNo, UnitNo, ProcDate, ProcTime, Down, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime
                ('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime
                ('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
    end;

    sCtrl := '';
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.idTSExecute: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.IdTS_BeejuExecute(AContext: TIdContext);
var
  sRecv, sRemortIP, sSend, sData: aString;
  nCmd, nUnitNo, nMNo: Word;
  i: Byte;
  bSend: Boolean;
begin
  try
    sRecv := AContext.Connection.IOHandler.ReadString(AContext.Connection.IOHandler.InputBuffer.Size, enUTF8);
    sRemortIP := AContext.Binding.PeerIP;

    if Pos(STX, sRecv) > 0 then
      sCtrl := sRecv
    else
      sCtrl := sCtrl + sRecv;

    ExceptLogging('Recv Check: ' + sCtrl + ':' + sRemortIP);

    if (Pos(STX, sCtrl) <= 0) or (Pos(ETX, sCtrl) <= 0) then
      Exit;

    ExceptLogging('CtrlRecv: ' + sCtrl + ':' + sRemortIP);
    nCmd := StrToInt(Copy(sRecv, 2, 2));
    nUnitNo := StrToInt(Copy(sRecv, 4, 5));
    nMNo := StrToInt(Copy(sRecv, 9, 3));

    if Pos(ETX, sCtrl) > 12 then
    begin
      // 데이터가 있으면...
      sData := Copy(sCtrl, 12, Pos(ETX, sCtrl) - 12);
    end
    else
      sData := '';

    bSend := False;

    case nCmd of
      1:
        begin
          for i := 1 to 5 do
          begin
            with frmMain do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_OPEN-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
          begin
            for i := 1 to 3 do
            begin
              with frmMain do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;
          end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
    end;

    sCtrl := '';
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.idTSExecute: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.IdTs_GyeyoungExecute(AContext: TIdContext);
var
  sRecv: Char;
  sip: aString;
  i: Integer;
begin
  try
    sRecv:= AContext.Connection.IOHandler.ReadChar(enDefault);
    sip:= AContext.Binding.PeerIP;
    sRecvHomeServer:= sRecv;

    for i := 1 to AContext.Connection.IOHandler.InputBuffer.Size do
      sRecvHomeServer:= sRecvHomeServer + AContext.Connection.IOHandler.ReadChar(enDefault);

    ExceptLogging('<단지서버 수신데이터(' + sIP + ') ' + sRecvHomeServer);
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
  end;
end;

procedure TfrmMain.IdTS_HyunDaiExecute(AContext: TIdContext);
var
  sRecv: Char;
  sip: aString;
  i: Integer;
begin
  try
    sRecv:= AContext.Connection.IOHandler.ReadChar(enDefault);
    sip:= AContext.Binding.PeerIP;
    sRecvHomeServer:= sRecv;

    for i := 1 to AContext.Connection.IOHandler.InputBuffer.Size do
      sRecvHomeServer:= sRecvHomeServer + AContext.Connection.IOHandler.ReadChar(enDefault);

    ExceptLogging('<단지서버 수신데이터(' + sIP + ') ' + sRecvHomeServer);
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
  end;
end;

procedure TfrmMain.idUC_ubizConnected(Sender: TObject);
begin
  HomeInfoLogging('단지서버 Connect');
end;

procedure TfrmMain.idUC_ubizDisconnected(Sender: TObject);
begin
  HomeInfoLogging('단지서버 DisConnect');
end;

procedure TfrmMain.idUS_ubizUDPRead(AThread: TIdUDPListenerThread;
  const AData: TIdBytes; ABinding: TIdSocketHandle);
Type
  //TSendData = Packed record
    TSendData =  record
    STX : array[1..4] of ansiChar;
    Gubun : array[1..2] of ansiChar;
    PacketType : ansiChar;
    Data1 : ansiChar;
  end;
var
  sSend : aString;
  sHomeInfo_Temp : aString;
  SendData : TSendData;
  SendBuff : TIdBytes;
begin
  try
    sHomeInfo_Temp := BytesToString(aData, enUTF8);

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 단지서버 수신: ' +  sHomeInfo_Temp);

    FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

    if Pos('0x', sHomeInfo_Temp) > 0 then
    begin
      if Copy(sHomeInfo_Temp, 31, 4) = '0xA0' then
      begin
        try
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [상태정보] 상태응답');

          SendData.STX[1] := AnsiChar($AA);
          SendData.STX[2] := AnsiChar($AA);
          SendData.STX[3] := AnsiChar($AA);
          SendData.STX[4] := AnsiChar($A0);

          SendData.Gubun[1] := AnsiChar($BB);
          SendData.Gubun[2] := AnsiChar($BB);

          SendData.PacketType := AnsiChar($A1);

          if is_ping(sHomeInfo_IP) then
          begin
            try
//              if csHomeInfo.Socket.Connected then
//              begin
                SendData.Data1 := AnsiChar($A0);
//              end
//              else
//              begin
//                HomeInfoLogging('> [상태정보] 통신 오류');
//                SendData.Data1 := AnsiChar($A5);
//              end;
            except
              on E: Exception do HomeInfoLogging('TfrmMain.MakeKeyStatus-1 ' + aString(E.Message));
            end;
          end
          else
          begin
            HomeInfoLogging('> [상태정보] 단지서버 ping 에러');
            SendData.Data1 := AnsiChar($A5);
          end;

          if is_Ping(sHomeInfo_IP) then
          begin
            if idUC_uBiz.Connected then
            begin
              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_uBiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));
            end
            else
            begin
              idUC_uBiz.Disconnect;
              Sleep(200);
              idUC_uBiz.Connect;

              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_uBiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));
            end;
          end
          else
          begin
            HomeInfoLogging('[상태정보] 단지서버로 상태조회 전송 시도시 Ping 안됨!');
          end;
        except
        on E: Exception do HomeInfoLogging('TfrmMain.idUSUDPRead_1: ' + E.Message);
        end;
      end
      else
      begin
        // 입차 정보에 대한 응답값
        if Copy(sHomeInfo_Temp, 31, 4) = '0xA1' then
        begin
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [입차정보] 응답');
        end;
      end;
    end
    else
    begin
      if Copy(sHomeInfo_Temp, 19, 2) = 'A0' then
      begin
        try
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [상태정보] 상태응답');

          SendData.STX[1] := AnsiChar($AA);
          SendData.STX[2] := AnsiChar($AA);
          SendData.STX[3] := AnsiChar($AA);
          SendData.STX[4] := AnsiChar($A0);

          SendData.Gubun[1] := AnsiChar($BB);
          SendData.Gubun[2] := AnsiChar($BB);

          SendData.PacketType := AnsiChar($A1);

          if is_ping(sHomeInfo_IP) then
          begin
            try
//              if csHomeInfo.Socket.Connected then
//              begin
                SendData.Data1 := AnsiChar($A0);
//              end
//              else
//              begin
//                HomeInfoLogging('> [상태정보] 통신 오류');
//                SendData.Data1 := AnsiChar($A5);
//              end;
            except
              on E: Exception do HomeInfoLogging('TfrmMain.MakeKeyStatus-1 ' + aString(E.Message));
            end;
          end
          else
          begin
            HomeInfoLogging('> [상태정보] 단지서버 ping 에러');
            SendData.Data1 := AnsiChar($A5);
          end;

          if is_Ping(sHomeInfo_IP) then
          begin
            if idUC_ubiz.Connected then
            begin
              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));;
            end
            else
            begin
              idUC_ubiz.Disconnect;
              Sleep(200);
              idUC_ubiz.Connect;

              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));
            end;
          end
          else
          begin
            HomeInfoLogging('[상태정보] 단지서버로 상태조회 전송 시도시 Ping 안됨!');
          end;
        except
        on E: Exception do HomeInfoLogging('TfrmMain.idUSUDPRead_2: ' + E.Message);
        end;
      end
      else
      begin
        // 입차 정보에 대한 응답값
        if Copy(sHomeInfo_Temp, 19, 2) = 'A1' then
        begin
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [입차정보] 응답');
        end;
      end;
    end;

  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.idUSUDPRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.idUSUDPRead: ' + E.Message);
  end;
end;

procedure TfrmMain.imgOut1Click(Sender: TObject);
begin

end;

{
function TfrmMain.is_ping(IP: AnsiString): Boolean;
begin
  Result := False;
  try
    with ICMP do
    begin
      OnReply := ICMPReply;
      ReceiveTimeOut := 2000;
      Host := wString(IP);
      Ping;
    end;
    Result := ping_success;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.is_ping: ' + aString(E.Message));
  end;
end;
}

function TfrmMain.is_Ping(ip: AnsiString): Boolean;
var
   Handle : THandle;
   DW : DWORD;
   REP : ICMPECHO;
   IPLong: LongInt;
begin
     //Result := -1;
     Result:= False;
     //ExceptLogging('Ping 시간 체크1-' + IntToStr(GetTickCount));

     Handle := IcmpCreateFile;

     if Handle = INVALID_HANDLE_VALUE then Exit;

     IPLong := inet_addr(PAnsiChar( ip ));
     DW := IcmpSendEcho(Handle, IPLong, nil, 0, nil, @rep, Sizeof(Rep), nPingTimeOut );

     //Result := rep.Status;

     if rep.status = 0 then
       Result:= True
     else
       Result:= False;

     //ExceptLogging('Ping 시간 체크2-' + IntToStr(GetTickCount));
     IcmpCloseHandle(Handle);
end;

procedure TfrmMain.a1Click(Sender: TObject);
begin
  NextModalDialog(TfrmIONData.Create(Self));
end;

procedure TfrmMain.btnBar1Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar1.ImageIndex, btnBar1.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBar2Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar2.ImageIndex, btnBar2.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBar3Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar3.ImageIndex, btnBar3.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBar4Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar4.ImageIndex, btnBar4.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBarCloseClick(Sender: TObject);
begin
  pnBar.Visible := False;
end;

procedure TfrmMain.btnBindClick(Sender: TObject);
var
  i, bTemp: Byte;
  sTemp: aString;
begin
  try
//    tAlive.Enabled := false;  //Added Woo.YH 160426 코콤서버 연결 시도 중에는 tAlive(접속상태 체크 타이머) 중지
//    Added Woo.YH 160426 코콤 서버 먼저 끊고 연결
    if idTC.Connected then
    begin
      idTc.IOHandler.InputBuffer.Clear;         //버퍼 클리어가 안되면 disconnect가 정상적으로 동작되지않는다
      idTC.Disconnect;
      ExceptLogging('코콤 DisConnet 후 재연결시도');
    end;

    FillChar(RBind, SizeOf(RBind), AnsiChar($00));
    FillChar(RKHeader, SizeOf(RKHeader), AnsiChar($00));
    FillChar(RAlive, SizeOf(RAlive), AnsiChar($00));

    RBind.nHomeVersion:= 0;
    RBind.nKind:= 0;

    for i:= 0 to 3 do
      RBind.nVersion[i]:= 0;

    for i:= 1 to Length(sHomeInfo_ID) do
      RKHeader.sID[i]:= sHomeInfo_ID[i];


    RKHeader.nHeaderKey:= nGHeaderKey;
    RKHeader.nMsgType:= nGBind;
    RKHeader.nMsgLength:= SizeOf(RBind);
    RKHeader.nTown:= 0;
    RKHeader.nDong:= 0;
    RKHeader.nHo:= 0;
    RKHeader.nReserved:= 0;

//Modified Start Woo.YH 160426 하드코딩되어있는 ID,PW값 ini에서 읽어온값으로 수정
//    for i:= 1 to Length(sTemp) do
//      RKHeader.sPW[i]:= sTemp[i];
    for i:= 1 to Length(sHomeInfo_PW) do
      RKHeader.sPW[i]:= sHomeInfo_PW[i];
//Modified End Woo.YH 160426 하드코딩되어있는 ID,PW값 ini에서 읽어온값으로 수정

     idTC.Connect;

     if idTC.Connected then
     begin
       idTC.IOHandler.Write(RawToBytes(RKHeader, SizeOf(RKHeader)), SizeOf(RKHeader), 0);
//       tKocomCheck.Interval:= 200;              //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//       tKocomCheck.Enabled:= True;              //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
       tAlive.Enabled:= True;
       ExceptLogging('코콤서버와 Bind확인 - OK');
     end
     else
       ExceptLogging('코콤서버와 Bind 안됨!');
//     tAlive.Enabled:= True;  //Added Woo.YH 160426
  except
    on E: Exception do
    begin
     ExceptLogging('TfrmMain.btnBindClick: ' + E.Message);
//    tAlive.Enabled:= True;  //Added Woo.YH 160427
    end;
  end;
end;

procedure TfrmMain.btnCloseClick(Sender: TObject);
begin
  btnManualSCIn.Enabled:= False;
  btnManualSCOut.Enabled := False;
  dmTables.qrySCSearch.Close;
  pnManualProc.Visible:= False;
end;

// 세대통보 버튼 클릭시 세대통보처리
procedure TfrmMain.btnHomeInfoTestClick(Sender: TObject);
begin
  try
    if nHomeInfo_Comp = 1 then      // 현대
    begin
      HomeInfoTest_Hyun;
    end
    else if nHomeInfo_Comp = 2 then // 코콤
    begin
      HomeinfoTest_Kocom;
    end
    else if nHomeInfo_Comp = 3 then // 아이컨트롤스
    begin
      HomeinfoTest_Icon;
    end
    else if nHomeInfo_Comp = 4 then  // 계영정보통신
    begin
      HomeInfoTest_Gye;
    end
    else if nHomeInfo_Comp = 5 then  // 삼성중공업 유비즈
    begin
      HomeInfoTest_UBiz;
    end
    else if nHomeInfo_Comp = 6 then  // 이지빌
    begin
      HomeInfoTest_EZ;
    end
    else if nHomeInfo_Comp = 7 then  // 비쥬드림
    begin
      HomeInfoTest_BeeJu;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보 테스트: ' + aString(E.Message));
  end;
end;

// 미인식 차량 입차처리
procedure TfrmMain.btnManualCancelClick(Sender: TObject);
begin
  edtManualCarNo.Text := '';
  pnManual.Visible := False;
end;

procedure TfrmMain.btnManualInClick(Sender: TObject);
begin
  pnManual.Visible := True;
  edtManualCarNo.Text := '';
  edtManualCarNo.SetFocus;
  edtManualCarNo.SelectAll;
end;

procedure TfrmMain.btnManualOKClick(Sender: TObject);
var
  sTKNo, sProcDate, sProcTime, sInCarNo: String;
begin
  try
    //sTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
    sTKNo := FormatDateTime('YYYYMMDDHHNNSS', Now)+ IntToStr(nCurrUnitNo) ;
    sProcDate := FormatDateTime('YYYY-MM-DD', Now);
    sProcTime := FormatDateTime('HH:NN:SS', Now);
    sInCarNo := MG_StrTrim(edtManualCarNo.Text, ' ');

    with dmTables do
    begin
      with qryDCTemp do
      begin
//        Close;
//        SQL.Clear;
//        SQL.Add('Insert Into IONData ');
//        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
//        SQL.Add('CarType, Status, OutChk, InImage1, InCarNo1, Reserve1) ');
//        SQL.Add(
//          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12)');
//        Parameters.ParamByName('N1').Value := nCurrParkNo;
//        Parameters.ParamByName('N2').Value := nCurrUnitNo;
//        Parameters.ParamByName('N3').Value := sProcDate;
//        Parameters.ParamByName('N4').Value := sProcTime;
//        Parameters.ParamByName('N5').Value := sTKNo;
//        Parameters.ParamByName('N6').Value := 1;
//        Parameters.ParamByName('N7').Value := 1;
//        Parameters.ParamByName('N8').Value := 1;
//        Parameters.ParamByName('N9').Value := 0;
//        Parameters.ParamByName('N10').Value := '';
//        Parameters.ParamByName('N11').Value := sInCarNo;
//        Parameters.ParamByName('N12').Value := '수동입차';
//        ExecSQL;
      end;
      ExceptLogging('수동입차: ' + sProcDate + ', ' + sProcTime + ', ' + sInCarNo);
      ShowMessage('수동입차처리를 완료하였습니다.');
    end;
    // InOpen;
    NGridData('1' + sInCarNo + '^' + sProcDate + ' ' + sProcTime + '^수동입차');
    pnManual.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualOKClick: ' + E.Message);
  end
end;

procedure TfrmMain.btnManualSCInClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동입차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csInLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;         // 전광판 IP
        nIO := RLpr[i].nIO;               // 입출구구분
        nListCnt:= RLpr[i].nLprCnt;       // LPR 개수 ???
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt);

    GridData(nIO, nListCnt, sResult);
    edtManualProcCarNo.Text:= '';
    btnManualSCIn.Enabled:= False;
    btnManualSCOut.Enabled:= False;
    dmTables.qrySCSearch.Close;
    pnManualProc.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCInClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnManualSCOutClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csOutLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        nIO := RLpr[i].nIO;
        nListCnt:= RLpr[i].nLprCnt;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt);

    GridData(nIO, nListCnt, sResult);
    edtManualProcCarNo.Text:= '';
    btnManualSCIn.Enabled:= False;
    btnManualSCOut.Enabled:= False;
    dmTables.qrySCSearch.Close;
    pnManualProc.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCOutClick: ' + aString(E.Message));
  end;
end;

// 미인식 차량 차량번호로 조회
procedure TfrmMain.btnManualSeekClick(Sender: TObject);
var
  sIn, sResult, sTime, sTemp: aString;
  sDspIP: aString;
  i: Byte;
begin
  try
    // 입력받은 차량번호가 없으면
    if edtManualProcCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtManualProcCarNo.SetFocus;
      Exit;
    end;

    // 정기차량 조회
    with dmTables.qrySCSearch do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%'));
      Open;

      if RecordCount > 0 then
      begin
        First;
        sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
        dgManual.SetFocus;
      end
      else
      begin
        sManualSCCarNo := '';
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualSeekClick: ' + E.Message);
  end;
end;

procedure TfrmMain.btnMCancelClick(Sender: TObject);
begin
  edtMCarNo.Text := '';
  pnModify.Visible := False;
  imgModify.Picture.Assign(Nil);
  nGridCheck := 0;
end;

procedure TfrmMain.btnModeClick(Sender: TObject);
var
  sMode : astring;
begin
   if btnMode.Tag = 1 then begin
     sMode := '개방운영'
   end
   else begin
     sMode := '유인운영'
   end;


   if MessageDlg( btnMode.Caption + '에서 ' + sMode + '로 변경하시겠습니까?', mtConfirmation, [mbYes, mbNo], 0) = mrNo then Exit;
   bMode := not bMode;
   if bMode then begin
     btnMode.Caption := '유인운영' ;
     btnMode.Tag := 1;
   end
   else begin
     btnMode.Caption := '개방운영';
     btnMode.Tag := 2;
   end;
end;

procedure TfrmMain.btnMOKClick(Sender: TObject);
var
  sCardNo, sName, sCompName, sDeptName, sGroupName, sExpDateT: aString;
  nGroupNo, i: Integer;
  bSC: Boolean;
begin
  try
    bSC:= False;
    with dmTables.qryModify do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo = :N1 and ');
      SQL.Add('ExpDateF <= :N2 and ExpDateT >= :N3 and TKType = :N4 and ParkNo = :N5');
      Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
      Parameters.ParamByName('N2').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := 2;
      Parameters.ParamByName('N5').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        // 정기차량 처리
        sCardNo := FieldByName('TKNo').AsString;
        nGroupNo := FieldByName('GroupNo').AsInteger;
        sName := FieldByName('Name').AsString;
        sCompName := FieldByName('CompName').AsString;
        sDeptName := FieldByName('DeptName').AsString;
        sExpDateT:= FieldByName('ExpDateT').AsString;

        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from GGroup where ParkNo = :N1 and GroupNo = :N2 and Reserve1 is null');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nGroupNo;
        Open;

        if RecordCount > 0 then
          sGroupName := FieldByName('GroupName').AsString;

        Close;
        SQL.Clear;
        SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
        SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
        SQL.Add('where ParkNo = :N6 and TKType = :N7 and TKNo = :N8');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nOrgUnitNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := 1;
        Parameters.ParamByName('N6').Value := nCurrParkNo;
        Parameters.ParamByName('N7').Value := 2;
        Parameters.ParamByName('N8').Value := sCardNo;
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add
          ('Select * from IOSData where ParkNo = :N1 and UnitNo = :N2 and ');
        SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nOrgUnitNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sCardNo;
        Open;

        if RecordCount <= 0 then
        begin
          Close;
          SQL.Clear;
          SQL.Add(
            'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
          SQL.Add(
            'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, InIOStatusNo, ');
          SQL.Add('InImage1, InRecog1, Reserve1, Reserve2) ');
          SQL.Add(
            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18)');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nOrgUnitNo;
          Parameters.ParamByName('N3').Value := sOrgDate;
          Parameters.ParamByName('N4').Value := sOrgTime;
          Parameters.ParamByName('N5').Value := sCardNo;
          Parameters.ParamByName('N6').Value := 2;
          Parameters.ParamByName('N7').Value := 2;
          Parameters.ParamByName('N8').Value := nGroupNo;
          Parameters.ParamByName('N9').Value := sGroupName;
          Parameters.ParamByName('N10').Value := sCompName;
          Parameters.ParamByName('N11').Value := sDeptName;
          Parameters.ParamByName('N12').Value := sName;
          Parameters.ParamByName('N13').Value := MG_StrTrim
            (edtMCarNo.Text, ' ');
          Parameters.ParamByName('N14').Value := 1;
          Parameters.ParamByName('N15').Value := sOrgFile;
          Parameters.ParamByName('N16').Value := 4;
          Parameters.ParamByName('N17').Value := FormatDateTime
            ('YYYY-MM-DD HH:NN:SS', Now);
          Parameters.ParamByName('N18').Value := IntToStr(nCurrMNo);
          ExecSQL;
        end;

        Close;
        SQL.Clear;
        SQL.Add(
          'Delete from IONData where ParkNo = :N1 and ProcDate = :N2 and ProcTime = :N3 and ');
        SQL.Add('((InCarNo1 = :N4) or (InCarNo2 = :N5))');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := sOrgDate;
        Parameters.ParamByName('N3').Value := sOrgTime;
        Parameters.ParamByName('N4').Value := sOrgCarNo;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        //Parameters.ParamByName('N4').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        //Parameters.ParamByName('N5').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        ExecSQL;
        bSC := True;
      end
      else
      begin
        // 일반차량 처리
//        Close;
//        SQL.Clear;
//        SQL.Add(
//          'Update IONData Set InCarNo1 = :N1, Reserve5 = :N7, Reserve4 = :N8, Reserve3 = :N9, InRecog1 = 1 ');
//        SQL.Add(
//          'Where ParkNo = :N2 and ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
//        Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
//        Parameters.ParamByName('N2').Value := nCurrParkNo;
//        Parameters.ParamByName('N3').Value := sOrgDate;
//        Parameters.ParamByName('N4').Value := sOrgTime;
//        Parameters.ParamByName('N5').Value := sOrgCarNo;
//        Parameters.ParamByName('N7').Value := '차량번호수정';
//        Parameters.ParamByName('N8').Value := FormatDateTime
//          ('YYYY-MM-DD HH:NN:SS', Now);
//        Parameters.ParamByName('N9').Value := IntToStr(nCurrMNo);
//        ExecSQL;
//
//        Close;
//        SQL.Clear;
//        SQL.Add(
//          'Update IONData Set InCarNo2 = :N1, Reserve5 = :N7, Reserve4 = :N8, Reserve3 = :N9, InRecog2 = 1 ');
//        SQL.Add(
//          'Where ParkNo = :N2 and ProcDate = :N3 and ProcTime = :N4 and InCarNo2 = :N5');
//        Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
//        Parameters.ParamByName('N2').Value := nCurrParkNo;
//        Parameters.ParamByName('N3').Value := sOrgDate;
//        Parameters.ParamByName('N4').Value := sOrgTime;
//        Parameters.ParamByName('N5').Value := sOrgCarNo;
//        Parameters.ParamByName('N7').Value := '차량번호수정';
//        Parameters.ParamByName('N8').Value := FormatDateTime
//          ('YYYY-MM-DD HH:NN:SS', Now);
//        Parameters.ParamByName('N9').Value := IntToStr(nCurrMNo);
//        ExecSQL;
      end;

      if nGridCheck = 1 then
      begin
        for i := 2 to sgIn.RowCount do
        begin
          if (MG_StrTrim(sgIn.Cells[3, i - 1], ' ') = sOrgCarNo) and
            (sgIn.Cells[1, i - 1] = sOrgDate) and
            (sgIn.Cells[2, i - 1] = sOrgTime) then
          begin
            sgIn.Cells[3, i - 1] := MG_StrTrim(edtMCarNo.Text, ' ');
            sgIn.RowColor[i - 1] := clWhite;

            if bSC then
            begin
              sgIn.Cells[0, i -1]:= '정기차량';
              sgIn.Cells[4, i -1]:= sCompName;
              sgIn.Cells[5, i -1]:= sName;
              sgIn.Cells[6, i -1]:= sExpDateT;
            end;
          end;
        end;
      end
      else if nGridCheck = 2 then
      begin
        sgOut.RemoveRows(nModRow, 1);
      end;

      edtMCarNo.Text := '';
      imgModify.Picture.Assign(Nil);
      pnModify.Visible := False;
      nGridCheck := 0;
      sOrgCarNo := '';
      sOrgDate := '';
      sOrgTime := '';
      sOrgFile := '';
      nOrgUnitNo := 0;

      // 메시지 없애달라는 요청... 2012-06-30  황이성 주임
      // ShowMessage('차량번호 수정을 완료하였습니다.');
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnMOKClick: ' + E.Message);
  end;
end;

procedure TfrmMain.btnSCCancelClick(Sender: TObject);
begin
  sManualSCCarNo := '';
  btnSCIn.Enabled:= False;
  btnSCOut.Enabled:= False;
  edtSCCarNo.Text:= '';
  pnSCSearch.Visible := False;
end;

procedure TfrmMain.btnSCClick(Sender: TObject);
begin
  try
    if edtSCCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtSCCarNo.SetFocus;
      Exit;
    end;

    with dmTables.qrySCSearch do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr
          ('%' + Trim(edtSCCarNo.Text) + '%'));
      Open;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnSCInClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csInLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        nIO:= RLpr[i].nIO;
        nListCnt:= RLpr[i].nLprCnt;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt);

    GridData(nIO, nListCnt, sResult);
    edtSCCarNo.Text:= '';
    btnSCIn.Enabled:= False;
    btnSCOut.Enabled := False;
    dmTables.qrySCSearch.Close;
    pnSCSearch.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCInClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnSCOutClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csOutLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        nIO:= RLpr[i].nIO;
        nListCnt:= RLpr[i].nLprCnt;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt);

    GridData(nIO, nListCnt, sResult);
    edtSCCarNo.Text:= '';
    btnSCIn.Enabled:= False;
    btnSCOut.Enabled := False;
    dmTables.qrySCSearch.Close;
    pnSCSearch.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCOutClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.Button1Click(Sender: TObject);
begin
  pnHomeInfo.Visible:= False;
end;

procedure TfrmMain.csDspError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
var
  tmpCnt: Integer;
  tmpErrorCd: Integer;
  tmpMsg: String;
begin
  tmpErrorCd := ErrorCode;
  tmpMsg := '';

  Case ErrorCode of
    10049 : tmpMsg := '컨넥트 하려는 주소가 잘못';
    10053 : tmpMsg := '소프트웨어 때문에 연결이 중단되었습니다';
    10054 : tmpMsg := '상대편에 의해 연결이 강제로 종료되었을 경우 발생하는 오류';
    10060 : tmpMsg := '네트워크 타임아웃';
    10061 : tmpMsg := '서버가 죽었거나 클라이언트에서 접속환경이 잘못되었을때 나타나는 현상';
  else tmpMsg := '네트워크 기타 에러';
  end;
  ErrorCode := 0;

  ExceptLogging('SocketError > ErrorNo: [' + IntToStr(tmpErrorCd) + '] Host: ['
                                  + (Sender as TClientSocket).Host + '] Port: ['
                                  + intToStr((Sender as TClientSocket).Port) + '] Name: ['
                                  + (Sender as TClientSocket).Name + '] Msg: ['
                                  + tmpMsg + ']');
   if tmpErrorCd = 10057 then
   begin
     prDelay(nDspInterval);
     if (Sender as TClientSocket).Active then
     begin
       (Sender as TClientSocket).Active := False;
     end;
   end;
   if tmpErrorCd = 10049 then
   begin
     prDelay(nDspInterval);
    (Sender as TClientSocket).Active := True;
   end;
end;




procedure TfrmMain.csHomeInfo_EZConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('이지빌 단지서버 Connect');
end;

procedure TfrmMain.csHomeInfo_EZDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('이지빌 단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_EZRead(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv, sSend, sSendLength, sTemp: aString;
  nSendLength: Integer;
begin
  try
    //이지빌
    sHomeInfo_Temp:= Socket.ReceiveText;

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 이지빌 수신(' + IntToStr(GetTickCount) + '): ' + sHomeInfo_Temp);

    if (Pos('$cmd=10', sHomeInfo_Temp) > 0) then
    begin
      //홈서버에서의 상태요청에 대한 응답...
      sSend:= Copy(sHomeInfo_Temp, 15, Length(sHomeInfo_Temp)-14) + '#dongho=' +
              //sezvilleDong + '&' + sezvilleho + '#ip=' + sLocalIP + '#status=0';
              sezvilleDong + '&' + sezvilleho + '#ip=' + sHomeInfo_IP + '#status=0';
      sTemp:= Copy(sSend, 1, Pos('cmd', sSend)-1) + 'cmd=11$' + Copy(sSend, Pos('target', sSend), Length(sSend)- (Pos('target', sSend)-1));
      sSend:= sTemp;
      sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
      nSendLength:= StrToInt(sSendLength);
      sSend:= '<start=' + sSendLength + '&0>' + sSend;

      if csHomeInfo_EZ.Socket.Connected then
      begin
        if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
        begin
          HomeInfoLogging('> 단지서버 상태요청에 대한 응답: ' + sSend);
        end
        else
        begin
          HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러: ' + sSend);
        end;
      end
      else
      begin
        if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
        begin
          if is_Ping(sHomeInfo_IP) then
          begin
            try
              csHomeInfo_EZ.Close;
              csHomeInfo_EZ.Open;

              if csHomeInfo_EZ.Socket.Connected then
              begin
                if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                begin
                  HomeInfoLogging('> 단지서버 상태요청에 대한 응답(2): ' + sSend);
                end
                else
                begin
                  HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러(2): ' + sSend);
                end;
              end
              else
                HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 네트워크 에러');
            except
              on E: Exception do HomeInfoLogging('이지빌 상태요청에 대한 응답시 에러: ' + aString(E.Message));
            end;
          end
          else
            HomeInfoLogging('이지빌 단지서버로 상태요청에 대한 응답전송 시도시 Ping 안됨!');
        end;
      end;
    end;
    sHomeInfo_Temp:= '';
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.csEZVilleRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.csEZVilleRead: ' + E.Message);
  end;
end;

procedure TfrmMain.csHomeInfo_GyeConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  try
    HomeInfoLogging('단지서버 Connect');

    if sHomeInfo_Data <> '' then
    begin
      if csHomeInfo_Gye.Socket.Connected then
      begin
        csHomeInfo_Gye.Socket.SendText(sHomeInfo_Data);
        HomeInfoLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
        sHomeInfo_Data:= '';
      end
      else
      begin
        csHomeInfo_Gye.Active:= True;

        if csHomeInfo_Gye.Socket.Connected then
        begin
          csHomeInfo_Gye.Socket.SendText(sHomeInfo_Data);
          HomeInfoLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
          sHomeInfo_Data:= '';
        end
        else
          sHomeInfo_Data:= '';
      end;
    end;
  except
    on E: Exception do ExceptLogging('단지서버 전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_GyeDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_GyeError(Sender: TObject;
  Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  try
    sHomeInfo_Data:= '';
    HomeInfoLogging('단지서버 Connect error: ' + IntToStr(ErrorCode));
    ErrorCode := 0;
  except
    on E: Exception do ExceptLogging('단지서버 Connect error: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_GyeRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
  sRecv, sSend, sSendLength, sTemp: aString;
  nSendLength: Integer;
begin
  try
    sHomeInfo_Temp:= Socket.ReceiveText;

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 단지서버 수신(' + IntToStr(GetTickCount) + '): ' + toHex(sHomeInfo_Temp));

    if (Pos('ok', sHomeInfo_Temp) > 0) then
    begin
      //홈서버에서의 상태요청에 대한 응답...
      HomeInfoLogging('< 단지서버에서 ok 수신');
      csHomeInfo_Gye.Active:= False;
    end
    else
    if (Pos('fail', sHomeInfo_Temp) > 0) then
    begin
      HomeInfoLogging('< 단지서버에서 fail 수신');
      csHomeInfo_Gye.Active:= False;
    end;
    sHomeInfo_Temp:= '';
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
  end;
end;

procedure TfrmMain.csHomeInfo_iconConnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  try
    HomeInfoLogging('csHomeInfo_iconConnect');

    if sHomeInfo_Data <> '' then
    begin
      if csHomeInfo_icon.Socket.Connected then
      begin
        csHomeInfo_icon.Socket.SendText(sHomeInfo_Data);
        HomeInfoLogging(sHomeInfo_CarNo + '차량 ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
        sHomeInfo_Data:= '';
      end
      else
      begin
        csHomeInfo_icon.Active:= True;

        if csHomeInfo_icon.Socket.Connected then
        begin
          csHomeInfo_icon.Socket.SendText(sHomeInfo_Data);
          HomeInfoLogging(sHomeInfo_CarNo + '차량 ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
          sHomeInfo_Data:= '';
        end
        else
        begin
          sHomeInfo_Data:= '';
          ExceptLogging('아이콘트롤스 단지서버 연결시 에러');
        end;
      end;
    end;
  except
    on E: Exception do ExceptLogging('아이콘트롤스 단지서버 전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_iconDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_iconError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  try
    sHomeInfo_Data:= '';
    HomeInfoLogging('단지서버 Connect error: ' + IntToStr(ErrorCode));
    ErrorCode := 0;
  except
    on E: Exception do ExceptLogging('단지서버 Connect error: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_iconRead(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv, sSend, sSendLength, sTemp: aString;
  nSendLength: Integer;
begin
  try
    sHomeInfo_Temp:= Socket.ReceiveText;

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 단지서버 수신(' + IntToStr(GetTickCount) + '): ' + toHex(sHomeInfo_Temp));

    if (Pos('ok', sHomeInfo_Temp) > 0) then
    begin
      //홈서버에서의 상태요청에 대한 응답...
      HomeInfoLogging('< 단지서버에서 ok 수신');
      csHomeInfo_icon.Active:= False;
    end
    else
    if (Pos('fail', sHomeInfo_Temp) > 0) then
    begin
      HomeInfoLogging('< 단지서버에서 fail 수신');
      csHomeInfo_icon.Active:= False;
    end;
    sHomeInfo_Temp:= '';
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
  end;
end;

procedure TfrmMain.csInDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp1_connect');
  if sInDspBasic1 <> '' then
  begin
    csInDsp1.Socket.SendText(sInDspBasic1);
//    csInDsp1.Active:= False;
    sInDspBasic1:= '';
  end;
//  if sInDspBasic1 <> '' then
//  begin
//    ExceptLogging('InDsp1_전광판문구전송');
//    prDelay(nDspInterval);
//    csInDsp1.Socket.SendText(sInDspBasic1);
//    prDelay(nDspInterval);
//  end;
end;

procedure TfrmMain.csInDsp1Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp1_Disconnect');
end;

procedure TfrmMain.csInDsp1Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin

end;

procedure TfrmMain.csInDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[IN]>DSP1 Recv: ' + sRecv);
//  prDelay(nDspInterval);
//  csInDsp1.Active:= False;
//  sInDspBasic1:= '';
end;


procedure TfrmMain.csInDsp2Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp2_connect');
  if sInDspBasic2 <> '' then
  begin
    csInDsp2.Socket.SendText(sInDspBasic2);
//    csInDsp1.Active:= False;
    sInDspBasic2:= '';
  end;
end;

procedure TfrmMain.csInDsp2Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
 ExceptLogging('InDsp2_Disconnect');
end;

procedure TfrmMain.csInDsp2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[IN]>DSP2 Recv: ' + sRecv);
end;

procedure TfrmMain.csInLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('InLpr1Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csInLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
    tInAlive1.Enabled := False;
    sRecv := Socket.ReceiveText;      // 소켓 데이터  => CH1#31로6811#N#\2014\09\30\CH1_20140930205613_31로6811.jpg
    sInLPRRecv1 := sRecv;
    ExceptLogging('LPR ' + IntToStr(csInLpr1.Tag) + ' Recv: ' + sInLPRRecv1);

    // 소켓 데이터 길이가 15자 초과이면
    if Length(sInLPRRecv1) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr1.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;       // 전광판 IP
          Break;
        end;
      end;

      nNo := csInLpr1.Tag;                // LPR 기기번호
      sLprData := sInLPRRecv1;
      sLprIP := csInLpr1.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr1;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen1 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면의 결과와 후면의 결과가 오인식이 아닌 다른 차로 인식된 경우.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14), '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        // CH
        else
        begin
          // 바오픈
          bInBarOpen1 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          // 'CH1_20141021141836_31로6819.jpg'
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          // '2014-10-21 14:18:36'
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');
        end;


        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr(nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2) + ', ' + sTime);

        // 차량 전면 이미지
        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        // 차량 후면 이미지
        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        // 이미지 파일 임시파일에 저장
        sTempFile1:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;                // 입출구구분
            nListCnt:= RLpr[i].nLprCnt;        // LPR 개수 ???
          end;
        end;

        if nRecog1 = 1 then
        begin
          with dmTables.qryInLpr1Proc do
          begin
            //정기차량 Full 번호 확인
             Close;
             SQL.Clear;
             SQL.Add('Select * from CustInfo ');
             if sCarNo2 <> '' then
             begin
               SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Parameters.ParamByName('N2').Value := sCarNo2;
               Open;
             end
             else
             if sCarNo1 <> '' then
             begin
               SQL.Add('where CarNo = :N1 and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Open;
             end;
             if RecordCount > 0 then
             begin
                // 등록된 정기차량이면...
                sCarNo1:= FieldByName('CarNO').AsString;

                // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                if bSCProcWait then
                begin
                  if nSCWaitPoint = 20 then
                    nSCWaitPoint := 1
                  else
                    nSCWaitPoint := nSCWaitPoint + 1;

                  RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                  RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                  RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                  RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                  RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                  RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                  RSCWait[nSCWaitPoint].nSCInOut := nIO;
                  RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                  RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                  RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                  RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                  RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                  RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen1;

                  if not tSCWait.Enabled then
                    tSCWait.Enabled := True;
                end
                else
                begin
                  sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                         nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, true, nListCnt);
                  GridData(nIO, nListCnt, sResult);

                  if bHomeInfo then
                    HomeInfo_Proc(nIO);
                end;
             end
             else begin
              //풀번호 확인시 없을 경우
                if b6Proc then  begin
                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
                  nCarNoLength:= Length(sCarNo1);
                  Close;
                  SQL.Clear;
                  SQL.Add('Select * from ');
                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
                  Parameters.ParamByName('N1').Value:= sShortCarNo;
                  Parameters.ParamByName('N2').Value:= sShortCarNo;
                  Parameters.ParamByName('N7').Value:= sShortCarNo;

                  Case nCarNoLength of
                    11: begin
                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
                        end;
                    12: begin
                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
                        end;
                    8 : begin
                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
                        end;
                  end;
                  Open;
                  if RecordCount > 0 then
                  begin
                    // 등록된 정기차량이면...
                    sCarNo1:= FieldByName('CarNO').AsString;

                    // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                    if bSCProcWait then
                    begin
                      if nSCWaitPoint = 20 then
                        nSCWaitPoint := 1
                      else
                        nSCWaitPoint := nSCWaitPoint + 1;

                      RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                      RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                      RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                      RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                      RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                      RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                      RSCWait[nSCWaitPoint].nSCInOut := nIO;
                      RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                      RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                      RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                      RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                      RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                      RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen1;

                      if not tSCWait.Enabled then
                        tSCWait.Enabled := True;
                    end
                    else
                    begin
                      sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                             nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, true, nListCnt);
                      GridData(nIO, nListCnt, sResult);
                    end;
                  end
                  else
                  begin
                    // 정상인식시 일반차량 처리...
                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt);
                      end;
                    end;
                  end;

                end
                else
                begin
                    try
                      if FileExists(sImgFile1) then
                      begin
                        if nIO = 1 then
                        begin
                          with frmMain do
                          begin
                            TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                          end;
                        end
                        else
                        if nIO = 2 then
                        begin
                          with frmMain do
                          begin
                            TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                          end;
                        end;
                      end
                      else
                      begin
                        if nIO = 1 then
                        begin
                          with frmMain do
                          begin
                            TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                          end;
                        end
                        else
                        if nIO = 2 then
                        begin
                          with frmMain do
                          begin
                            TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                          end;
                        end;

                        ExceptLogging('File 없음: ' + sImgFile1);
                      end;
                    except
                      on E: Exception do
                        ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
                    end;

                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt);
                      end;
                    end;
                end;
             end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          if bMiIn then
          begin
            //미인식차량 입차시...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                //NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen1, nListCnt);
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt);
              end;
            end;
          end
          else
          begin
            //미인식차량
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;
//              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
//              if not bMode then
//              begin
//                  InOpen(csLPR);
//              end;
            end
            else if nIO = 2 then
            begin
              //출구...
//              with frmMain do
//              begin
//                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
//                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
//                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
//                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
//                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
//                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
//                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
//                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
//                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
//              end;
//              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
//      if sInLPRRecv1 = 'LPR_R' then
//      begin
//        if chkNet(csInLpr1, '시간동기화 전송') then
//        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
//        end;
//      end;
    end;
    sInLPRRecv1 := '';
  finally
    tInAlive1.Enabled := True;
  end;
end;

procedure TfrmMain.csInLpr2Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('InLpr2Error: ' + IntToStr(ErrorCode));
  errorcode := 0;
end;

procedure TfrmMain.csInLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
begin
  try
    tInAlive2.Enabled := False;
    sRecv := Socket.ReceiveText;
    sInLPRRecv2 := sRecv;
    ExceptLogging('LPR' + IntToStr(csInLpr2.Tag) + ' Recv: ' + sInLPRRecv2);

    if Length(sInLPRRecv2) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr2.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr2.Tag;
      sLprData := sInLPRRecv2;
      sLprIP := csInLpr2.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr2;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen2 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
        end
        else
        begin
          bInBarOpen2 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile2:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        if nRecog1 = 1 then
        begin
          with dmTables.qryInLpr2Proc do
          begin
             //정기차량 Full 번호 확인
             Close;
             SQL.Clear;
             SQL.Add('Select * from CustInfo ');
             if sCarNo2 <> '' then
             begin
               SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Parameters.ParamByName('N2').Value := sCarNo2;
               Open;
             end
             else
             if sCarNo1 <> '' then
             begin
               SQL.Add('where CarNo = :N1 and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Open;
             end;

             if RecordCount > 0 then
             begin
                // 등록된 정기차량이면...
                sCarNo1:= FieldByName('CarNO').AsString;

                // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                if bSCProcWait then
                begin
                  if nSCWaitPoint = 20 then
                    nSCWaitPoint := 1
                  else
                    nSCWaitPoint := nSCWaitPoint + 1;

                  RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                  RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                  RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                  RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                  RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                  RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                  RSCWait[nSCWaitPoint].nSCInOut := nIO;
                  RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                  RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                  RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                  RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                  RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                  RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen2;

                  if not tSCWait.Enabled then
                    tSCWait.Enabled := True;
                end
                else
                begin
                  sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                         nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen2, nListCnt);
                  GridData(nIO, nListCnt, sResult);

                  if bHomeInfo then
                    HomeInfo_Proc(nIO);
                end;
             end
             else
             begin
              //풀번호 확인시 없을 경우
                if b6Proc then  begin
                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
                  nCarNoLength:= Length(sCarNo1);
                  Close;
                  SQL.Clear;
                  SQL.Add('Select * from ');
                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
                  Parameters.ParamByName('N1').Value:= sShortCarNo;
                  Parameters.ParamByName('N2').Value:= sShortCarNo;
                  Parameters.ParamByName('N7').Value:= sShortCarNo;

                  Case nCarNoLength of
                    11: begin
                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
                        end;
                    12: begin
                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
                        end;
                    8 : begin
                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
                        end;
                  end;
                  Open;

                  if RecordCount > 0 then
                  begin
                    // 등록된 정기차량이면...
                    sCarNo1:= FieldByName('CarNO').AsString;

                    // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                    if bSCProcWait then
                    begin
                      if nSCWaitPoint = 20 then
                        nSCWaitPoint := 1
                      else
                        nSCWaitPoint := nSCWaitPoint + 1;

                      RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                      RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                      RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                      RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                      RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                      RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                      RSCWait[nSCWaitPoint].nSCInOut := nIO;
                      RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                      RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                      RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                      RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                      RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                      RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen2;

                      if not tSCWait.Enabled then
                        tSCWait.Enabled := True;
                    end
                    else
                    begin
                      sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                             nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen2, nListCnt);
                      GridData(nIO, nListCnt, sResult);
                    end;
                  end
                  else
                  begin
                    // 정상인식시 일반차량 처리...
                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                      end;
                    end;
                  end;

                end
                else
                begin
                  if nIO = 1 then
                  begin
                    if bNCInProcWait then
                    begin
                      if nNCInWaitPoint = 20 then
                        nNCInWaitPoint := 1
                      else
                        nNCInWaitPoint := nNCInWaitPoint + 1;

                      RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                      RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                      RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                      RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                      RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                      RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                      RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                      RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                      RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                      RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                      RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;

                      if not tNCInWait.Enabled then
                        tNCInWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                    end;
                  end
                  else if nIO = 2 then
                  begin
                    if bNCOutProcWait then
                    begin
                      if nNCOutWaitPoint = 20 then
                        nNCOutWaitPoint := 1
                      else
                        nNCOutWaitPoint := nNCOutWaitPoint + 1;

                      RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                      RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                      RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                      RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                      RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                      RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                      RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                      if not tNCOutWait.Enabled then
                        tNCOutWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt);
                    end;
                  end;
                end;
             end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          if bMiIn then
          begin
            //미인식차량 입차시...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt);
              end;
            end;
          end
          else
          begin
            //미인식차량
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;

              if not bMode then
              begin
                  InOpen(csLPR);
              end;
              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end
            else if nIO = 2 then
            begin
              //출구...
              with frmMain do
              begin
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);

            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr2Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv2 = 'LPR_R' then
      begin
        if chkNet(csInLpr2, '시간동기화 전송') then
        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sInLPRRecv2 := '';
  finally
    tInAlive2.Enabled := True;
  end;
end;

end.
