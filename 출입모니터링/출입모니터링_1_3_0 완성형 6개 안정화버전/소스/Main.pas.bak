unit Main;

interface

uses
  Windows, Messages, SysUtils, Variants, Classes, Graphics, Controls, Forms, IdGlobal,
  Dialogs, StdCtrls, ExtCtrls, Menus, IdContext, ScktComp, IdServerIOHandler, IdServerIOHandlerSocket, IdServerIOHandlerStack,
  IdCustomTCPServer, IdTCPServer, IdIOHandler, IdIOHandlerSocket, IdIOHandlerStack, IdTCPConnection, IdTCPClient, IdComponent, IdRawBase,
  IdRawClient, IdIcmpClient, IdBaseComponent, IdAntiFreezeBase, IdAntiFreeze, Grids, BaseGrid, AdvGrid, IniFiles, DB, ADODB, AdvToolBtn,
  Buttons, DBAdvGrid, sButton, Winsock, IdStack, IdException, jpeg, acPNG, IdIOHandlerStream, AdvCombo,
  AdvObj, AdPort, OoMisc,sPanel,sLabel, AdvEdit, XMLDoc, xmldom, XMLIntf, System.DateUtils,
  IdCustomTransparentProxy, IdSocks, IdSocketHandle, IdUDPServer, IdUDPBase,
  IdUDPClient, Vcl.MPlayer, Vcl.PlatformDefaultStyleActnCtrls, Vcl.ActnPopup,
  Xml.Win.msxmldom;

type
  R_SCWait = Record
    sSCFile1: AnsiString;
    sSCCarNo1: AnsiString;
    sSCFile2: AnsiString;
    sSCCarNo2: AnsiString;
    sSCIOTime: AnsiString;
    nSCLprNo: Byte;
    nSCInOut: Byte;
    nSCRecog1: Byte;
    nSCRecog2: Byte;
    nSCLprCnt: Byte;
    sSCDspIP: AnsiString;
    csSCLPR: TClientSocket;
    bBarOpen: Boolean;
    nBackData: Integer;
  end;

  R_NCWait = Record
    sNCFile1: AnsiString;
    sNCCarNo1: AnsiString;
    sNCFile2: AnsiString;
    sNCCarNo2: AnsiString;
    sNCIOTime: AnsiString;
    nNCLprNo: Byte;
    nNCInOut: Byte;
    nNCRecog1: Byte;
    nNCRecog2: Byte;
    nNCCharo: Byte;
    nNCLprCnt: Byte;
    sNCDspIP: AnsiString;
    csNCLPR: TClientSocket;
    bBarOpen: Boolean;
    nBackData: Integer;
  end;

  TfrmMain = class(TForm)
    MainMenu1: TMainMenu;
    mnuSetup: TMenuItem;
    N2: TMenuItem;
    N3: TMenuItem;
    N4: TMenuItem;
    mnuInDsp: TMenuItem;
    mnuOutDsp: TMenuItem;
    mnuClose: TMenuItem;
    IdAntiFreeze1: TIdAntiFreeze;
    ICMP: TIdIcmpClient;
    IdTc_HyunDai: TIdTCPClient;
    idStack2: TIdIOHandlerStack;
    IdTS_HyunDai: TIdTCPServer;
    IdStack1: TIdServerIOHandlerStack;
    csInLpr1: TClientSocket;
    csOutLpr1: TClientSocket;
    csInDsp1: TClientSocket;
    csOutDsp1: TClientSocket;
    qryMainTemp: TADOQuery;
    qry1: TADOQuery;
    tInDsp: TTimer;
    tOutDsp: TTimer;
    tInAlive1: TTimer;
    tOutAlive1: TTimer;
    tSCWait: TTimer;
    csInLpr2: TClientSocket;
    csInLpr3: TClientSocket;
    csInLpr4: TClientSocket;
    csOutLpr2: TClientSocket;
    csOutLpr3: TClientSocket;
    csInDsp2: TClientSocket;
    csInDsp3: TClientSocket;
    csInDsp4: TClientSocket;
    csOutDsp2: TClientSocket;
    csOutDsp3: TClientSocket;
    tNCInWait: TTimer;
    tNCOutWait: TTimer;
    qryCtrl: TADOQuery;
    tEZVille: TTimer;
    tInAlive2: TTimer;
    tInAlive3: TTimer;
    tInAlive4: TTimer;
    tOutAlive2: TTimer;
    tOutAlive3: TTimer;
    pnTot: TPanel;
    pnIn1: TPanel;
    imgIn1: TImage;
    pnInT1: TPanel;
    imgInL1: TImage;
    pnOut1: TPanel;
    imgOut1: TImage;
    imgInR1: TImage;
    lbIn1: TLabel;
    lbInOpen1: TLabel;
    pnOutT1: TPanel;
    imgOutL1: TImage;
    imgOutR1: TImage;
    lbOut1: TLabel;
    pnManualProc: TPanel;
    Label10: TLabel;
    Panel8: TPanel;
    Panel9: TPanel;
    imgManual: TImage;
    edtManualProcCarNo: TEdit;
    pnSManualProc: TPanel;
    dgManual: TDBAdvGrid;
    btnManualSeek: TBitBtn;
    btnManualSCOut: TBitBtn;
    btnClose: TBitBtn;
    btnManualSCIn: TBitBtn;
    pnSCSearch: TPanel;
    Label7: TLabel;
    DBAdvGrid1: TDBAdvGrid;
    btnSCOut: TsButton;
    btnSCCancel: TsButton;
    btnSC: TBitBtn;
    edtSCCarNo: TEdit;
    btnSCIn: TsButton;
    pnBar: TPanel;
    btnBar1: TAdvToolButton;
    btnBar2: TAdvToolButton;
    btnBar3: TAdvToolButton;
    btnBar4: TAdvToolButton;
    btnBar5: TAdvToolButton;
    btnBar6: TAdvToolButton;
    btnBar7: TAdvToolButton;
    btnBar8: TAdvToolButton;
    btnBarClose: TAdvToolButton;
    btnBar9: TAdvToolButton;
    btnBar10: TAdvToolButton;
    Panel13: TPanel;
    pnHomeInfo: TPanel;
    edtDong: TLabeledEdit;
    edtHo: TLabeledEdit;
    edtCar: TLabeledEdit;
    btnHomeInfoTest: TButton;
    Button1: TButton;
    cmbIO: TAdvComboBox;
    csOutLpr4: TClientSocket;
    tOutAlive4: TTimer;
    lbOutOpen1: TLabel;
    csOutDsp4: TClientSocket;
    PopupMenu1: TPopupMenu;
    mnu1_1: TMenuItem;
    mnu2_1: TMenuItem;
    mnuHomeInfo: TMenuItem;
    pnBottom: TPanel;
    pnList: TPanel;
    btnMode: TButton;
    imgSgIn: TImage;
    imgSgOut: TImage;
    sgIn: TAdvStringGrid;
    sgOut: TAdvStringGrid;
    btnManualIn: TButton;
    pnModify: TsPanel;
    sLabel28: TsLabel;
    Label11: TLabel;
    edtMCarNo: TEdit;
    btnMOK: TsButton;
    btnMCancel: TsButton;
    Panel3: TPanel;
    imgModify: TImage;
    pnInLogo1: TPanel;
    imgLogo1: TImage;
    pnInB1: TPanel;
    lbInHo1: TLabel;
    edtInCarNo1: TEdit;
    pnInG1: TPanel;
    lbInG1: TLabel;
    pnOutB1: TPanel;
    lbOutHo1: TLabel;
    edtOutCarNo1: TEdit;
    pnOutG1: TPanel;
    lbOutG1: TLabel;
    a1: TMenuItem;
    pnManual: TsPanel;
    sLabel31: TsLabel;
    Label3: TLabel;
    edtManualCarNo: TEdit;
    btnManualOK: TsButton;
    btnManualCancel: TsButton;
    pnIn2: TPanel;
    imgIn2: TImage;
    pnInT2: TPanel;
    imgInL2: TImage;
    imgInR2: TImage;
    lbIn2: TLabel;
    lbInOpen2: TLabel;
    pnInB2: TPanel;
    lbInHo2: TLabel;
    edtInCarNo2: TEdit;
    pnInG2: TPanel;
    lbInG2: TLabel;
    csHomeInfo_icon: TClientSocket;
    mnu1_2: TMenuItem;
    lbListIn: TLabel;
    lbListOut: TLabel;
    pnIn3: TPanel;
    imgIn3: TImage;
    pnInT3: TPanel;
    imgInL3: TImage;
    imgInR3: TImage;
    lbIn3: TLabel;
    lbInOpen3: TLabel;
    pnInB3: TPanel;
    lbInHo3: TLabel;
    edtInCarNo3: TEdit;
    pnInG3: TPanel;
    lbInG3: TLabel;
    pnIn4: TPanel;
    imgIn4: TImage;
    pnInT4: TPanel;
    imgInL4: TImage;
    imgInR4: TImage;
    lbIn4: TLabel;
    lbInOpen4: TLabel;
    pnInB4: TPanel;
    lbInHo4: TLabel;
    edtInCarNo4: TEdit;
    pnInG4: TPanel;
    lbInG4: TLabel;
    pnInLogo2: TPanel;
    imgLogo2: TImage;
    pnInLogo3: TPanel;
    imgLogo3: TImage;
    pnOutLogo1: TPanel;
    imgLogo4: TImage;
    pnOut2: TPanel;
    imgOut2: TImage;
    pnOutT2: TPanel;
    imgOutL2: TImage;
    imgOutR2: TImage;
    lbOut2: TLabel;
    lbOutOpen2: TLabel;
    pnOutB2: TPanel;
    lbOutHo2: TLabel;
    edtOutCarNo2: TEdit;
    pnOutG2: TPanel;
    lbOutG2: TLabel;
    pnOut3: TPanel;
    imgOut3: TImage;
    pnOutT3: TPanel;
    imgOutL3: TImage;
    imgOutR3: TImage;
    lbOut3: TLabel;
    lbOutOpen3: TLabel;
    pnOutB3: TPanel;
    lbOutHo3: TLabel;
    edtOutCarNo3: TEdit;
    pnOutG3: TPanel;
    lbOutG3: TLabel;
    pnOut4: TPanel;
    imgOut4: TImage;
    pnOutT4: TPanel;
    imgOutL4: TImage;
    imgOutR4: TImage;
    lbOut4: TLabel;
    lbOutOpen4: TLabel;
    pnOutB4: TPanel;
    lbOutHo4: TLabel;
    edtOutCarNo4: TEdit;
    pnOutG4: TPanel;
    lbOutG4: TLabel;
    pnOutLogo2: TPanel;
    Image1: TImage;
    pnOutLogo3: TPanel;
    Image2: TImage;
    csHomeInfo_EZ: TClientSocket;
    csHomeInfo_Gye: TClientSocket;
    idTC: TIdTCPClient;
    idTS: TIdTCPServer;
    IdTS_kocom: TIdTCPServer;
    IdTC_kocom: TIdTCPClient;
    IdSocksInfo1: TIdSocksInfo;
    tAlive: TTimer;
    btnBind: TButton;
    IdTs_Gyeyoung: TIdTCPServer;
    IdTC_Gyeyoung: TIdTCPClient;
    idUC_ubiz: TIdUDPClient;
    idUS_ubiz: TIdUDPServer;
    IdTS_Beeju: TIdTCPServer;
    IdTC_Beeju: TIdTCPClient;
    mnu1_3: TMenuItem;
    mnu1_4: TMenuItem;
    mnu2_2: TMenuItem;
    mnu2_3: TMenuItem;
    mnu2_4: TMenuItem;
    pnlBlack: TPanel;
    lblVipTitle: TLabel;
    lblBlackListCarNo1: TLabel;
    lblBlackListCarNo2: TLabel;
    btnVip: TButton;
    mpBlackList: TMediaPlayer;
    mnuBlack: TMenuItem;
    tmrBlack: TTimer;
    btnInGate1: TButton;
    popGate: TPopupMenu;
    popOpen: TMenuItem;
    popClose: TMenuItem;
    popOpenLock: TMenuItem;
    popUnLock: TMenuItem;
    btnInGate2: TButton;
    btnInGate3: TButton;
    btnInGate4: TButton;
    btnOutGate1: TButton;
    btnOutGate2: TButton;
    btnOutGate3: TButton;
    btnOutGate4: TButton;
    ComPrn: TApdComPort;
    csHomeInfo_CVNet: TClientSocket;
    tHeartBeat: TTimer;
    IdTc_Commax: TIdTCPClient;
    idTs_Commax: TIdTCPServer;
    l1: TLabel;
    tVisitDel: TTimer;
    ssHomeinfo_icon: TServerSocket;
    xmlRead: TXMLDocument;
    xmlSend: TXMLDocument;
    IdTc_Home: TIdTCPClient;
    tDbCheck: TTimer;
    procedure mnuCloseClick(Sender: TObject);
    procedure FormResize(Sender: TObject);
    procedure FormCloseQuery(Sender: TObject; var CanClose: Boolean);
    procedure N2Click(Sender: TObject);
    procedure N3Click(Sender: TObject);
    procedure mnuInDspClick(Sender: TObject);
    procedure mnuOutDspClick(Sender: TObject);
    procedure FormCreate(Sender: TObject);
    procedure FormShow(Sender: TObject);
    procedure tInDspTimer(Sender: TObject);
    procedure tOutDspTimer(Sender: TObject);
    procedure tInAlive1Timer(Sender: TObject);
    procedure tOutAlive1Timer(Sender: TObject);
    procedure csInLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure tSCWaitTimer(Sender: TObject);
    procedure csOutLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnManualSeekClick(Sender: TObject);
    procedure edtManualProcCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure dgManualClick(Sender: TObject);
    procedure btnManualSCOutClick(Sender: TObject);
    procedure btnCloseClick(Sender: TObject);
    procedure edtSCCarNoKeyPress(Sender: TObject; var Key: Char);
    procedure btnSCClick(Sender: TObject);
    procedure DBAdvGrid1Click(Sender: TObject);
    procedure btnSCCancelClick(Sender: TObject);
    procedure btnSCOutClick(Sender: TObject);
    procedure btnBarCloseClick(Sender: TObject);
    procedure btnSCInClick(Sender: TObject);
    procedure btnManualSCInClick(Sender: TObject);
    procedure tNCInWaitTimer(Sender: TObject);
    procedure tNCOutWaitTimer(Sender: TObject);
    procedure btnBar1Click(Sender: TObject);
    procedure btnBar2Click(Sender: TObject);
    procedure btnBar3Click(Sender: TObject);
    procedure btnBar4Click(Sender: TObject);
    procedure tEZVilleTimer(Sender: TObject);
    procedure tInAlive2Timer(Sender: TObject);
    procedure tInAlive3Timer(Sender: TObject);
    procedure tOutAlive2Timer(Sender: TObject);
    procedure csInLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTS_HyunDaiExecute(AContext: TIdContext);
    procedure mnu1_1Click(Sender: TObject);
    procedure mnu1_2Click(Sender: TObject);
    procedure mnu2_1Click(Sender: TObject);
    procedure mnu4_2Click(Sender: TObject);
    procedure edtInCarNo1KeyPress(Sender: TObject; var Key: Char);
    procedure edtOutCarNo1KeyPress(Sender: TObject; var Key: Char);
    procedure mnuHomeInfoClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure btnHomeInfoTestClick(Sender: TObject);
    procedure csOutLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure tInAlive4Timer(Sender: TObject);
    procedure tOutAlive3Timer(Sender: TObject);
    procedure imgOut1Click(Sender: TObject);
    procedure btnModeClick(Sender: TObject);
    procedure csInDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csDspError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure btnManualCancelClick(Sender: TObject);
    procedure btnManualOKClick(Sender: TObject);
    procedure btnManualInClick(Sender: TObject);
    procedure sgInDblClickCell(Sender: TObject; ARow, ACol: Integer);
    procedure btnMCancelClick(Sender: TObject);
    procedure btnMOKClick(Sender: TObject);
    procedure mnu2_2Click(Sender: TObject);
    procedure csInLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInLpr2Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csOutLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure mnu3_2Click(Sender: TObject);
    procedure mnu1_3Click(Sender: TObject);
    procedure mnu2_3Click(Sender: TObject);
    procedure mnu3_3Click(Sender: TObject);
    procedure mnu4_3Click(Sender: TObject);
    procedure csInLpr3Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure a1Click(Sender: TObject);
    procedure csHomeInfo_iconConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_iconDisconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_iconError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csHomeInfo_iconRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure idTSExecute(AContext: TIdContext);
    procedure tAliveTimer(Sender: TObject);
    procedure btnBindClick(Sender: TObject);
    procedure csHomeInfo_GyeConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_GyeDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure csHomeInfo_GyeError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csHomeInfo_GyeRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTs_GyeyoungExecute(AContext: TIdContext);
    procedure idUC_ubizConnected(Sender: TObject);
    procedure idUC_ubizDisconnected(Sender: TObject);
    procedure idUS_ubizUDPRead(AThread: TIdUDPListenerThread;
      const AData: TIdBytes; ABinding: TIdSocketHandle);
    procedure csHomeInfo_EZConnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csHomeInfo_EZDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure csHomeInfo_EZRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTS_BeejuExecute(AContext: TIdContext);
    procedure csInLpr4Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csOutLpr2Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csOutLpr3Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csOutLpr4Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csInDsp3Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp4Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp4Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csInDsp4Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp2Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp3Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp4Connect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp2Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp3Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp4Disconnect(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp2Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp3Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure csOutDsp4Read(Sender: TObject; Socket: TCustomWinSocket);
    procedure mnu1_4Click(Sender: TObject);
    procedure mnu2_4Click(Sender: TObject);
    procedure btnVipClick(Sender: TObject);
    procedure mnuBlackClick(Sender: TObject);
    procedure tmrBlackTimer(Sender: TObject);
    procedure mpBlackListNotify(Sender: TObject);
    procedure btnInGate1Click(Sender: TObject);
    procedure popOpenClick(Sender: TObject);
    procedure popCloseClick(Sender: TObject);
    procedure popOpenLockClick(Sender: TObject);
    procedure popUnLockClick(Sender: TObject);
    procedure btnInGate2Click(Sender: TObject);
    procedure btnInGate3Click(Sender: TObject);
    procedure btnInGate4Click(Sender: TObject);
    procedure btnOutGate1Click(Sender: TObject);
    procedure btnOutGate2Click(Sender: TObject);
    procedure btnOutGate3Click(Sender: TObject);
    procedure btnOutGate4Click(Sender: TObject);
    procedure csHomeInfo_CVNetConnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure csHomeInfo_CVNetDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure tHeartBeatTimer(Sender: TObject);
    procedure csHomeInfo_CVNetError(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure csHomeInfo_CVNetRead(Sender: TObject; Socket: TCustomWinSocket);
    procedure IdTS_HyunDaiException(AContext: TIdContext;
      AException: Exception);
    procedure IdTS_HyunDaiDisconnect(AContext: TIdContext);
    procedure tVisitDelTimer(Sender: TObject);
    procedure IdTS_kocomExecute(AContext: TIdContext);
    procedure ssHomeinfo_iconClientConnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ssHomeinfo_iconClientDisconnect(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure ssHomeinfo_iconClientError(Sender: TObject;
      Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;
      var ErrorCode: Integer);
    procedure ssHomeinfo_iconClientRead(Sender: TObject;
      Socket: TCustomWinSocket);
    procedure tDbCheckTimer(Sender: TObject);
    procedure tOutAlive4Timer(Sender: TObject);
  private
    { Private declarations }
    procedure ICMPReply(ASender: TComponent; const ReplyStatus: TReplyStatus);
    function is_ping(IP: AnsiString): Boolean;
    procedure UnitCtrl(nCmd, nFCNo, nUnitNo, nMNo: Word; sData: AnsiString);
    function chkNet(csTarget: TClientSocket; sData: AnsiString): Boolean;
    procedure csInDsp1Error(Sender: TObject; Socket: TCustomWinSocket;
      ErrorEvent: TErrorEvent; var ErrorCode: Integer);
    procedure HomeInfoTest_Proc_Gye;
  public
    { Public declarations }
    procedure InOpen(csLPR: TClientSocket);
    Procedure OutOpen(csLPR: TClientSocket);
    procedure DspProc(nIO, nType: Byte; sData, sDspIP: AnsiString);
    procedure GridData(nIO, nListCnt: Byte; sResult: String);
    procedure NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
                        sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
                        sDspIP: AnsiString; csLPR: TClientSocket; nListCnt: Byte);
    procedure NormalProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
                         sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
                         sDspIP: AnsiString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte; nBackData: Integer);
    procedure HomeInfo_Proc(nInOut: Byte);
    procedure HomeInfo_Proc_Hyun(nInOut: Byte);    //현대통신
    procedure HomeInfo_Proc_Kocom(nInOut: Byte);   //코콤
    procedure HomeInfo_Proc_Icon(nInOut: Byte);    //아이컨트롤스
    procedure HomeInfo_Proc_Gye(nInOut: Byte);     //계영정보통신
    procedure HomeInfo_Proc_UBiz(nInOut: Byte);    //삼성중공업 유비즈
    procedure HomeInfo_Proc_EZ(nInOut: Byte);      //이지빌
    procedure HomeInfo_Proc_BeeJu(nInOut: Byte);   //한화 비쥬드림 uCamp
    procedure HomeInfo_Proc_CVNet(nInOut: Byte);   //CVNet
    procedure homeinfo_proc_Commax(nInOut: Byte);  //코맥스
    procedure homeinfo_proc_Home(nInOut: Byte);    //홈넷홈

    procedure HomeInfoTest_Hyun;                  //현대통신 테스트
    procedure HomeinfoTest_Kocom;                 //코콤 테스트
    procedure HomeinfoTest_Icon;                  //아이컨트롤스 테스트
    procedure HomeInfoTest_Gye;                   //계영정보통신 테스트
    procedure HomeInfoTest_UBiz;                  //삼성중공업 유비즈
    procedure HomeInfoTest_EZ;                    //이지빌 테스트
    procedure HomeInfoTest_BeeJu;                 //한화 비쥬드림 uCamp
    procedure HomeInfoTest_CVNet;                 //CVNET테스트
    procedure HomeInfoTest_Commax;                //Commax 테스트
    procedure HomeInfoTest_Home;                  //홈넷홈 테스트

    function MakeHomeCrc(sData: AnsiString): ansiChar;    //유비즈 전문생성용
    function MakeMassage(sOrder, sVal: String): String;   //비쥬드림 전문생성용

    function RecvLprProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
                         sIOTime: AnsiString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
                         sDspIP: AnsiString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte;
                         nBackData : Integer): String;
    procedure FormAlign;
    procedure GridClear;
    procedure WaitClear;
    procedure InitProc;
    function IntToBool(nNo: Integer): Boolean;
    procedure MichulProc(sCarNo, sProcDate, sProcTime: AnsiString);
    procedure NGridData(sResult: String);
    procedure prDelay(Time: Integer);
    function  FindNumber(Target : string): string;
    function MakeCVNetHeartBeat: AnsiString;
    procedure CVnetProc(sData: AnsiString);
    function BuildCVnetCRC(sData: AnsiString): AnsiString;
    procedure HomeInfo_RecvProc(sData: AnsiString);
    function CheckCVnetCRC(sData: AnsiString): Boolean;
    function MakeCVnetData(sDong, sHo, sTime, sCarNo, sType: AnsiString): AnsiString;
    function MakeCVnetLogin: AnsiString;
    //HD_ << 현대통신 방문자 관련 함수들
    function HD_RequestProcess(sRecv: String): String;
    function StringToDate(sString : string): TDateTime;                           //Added Woo.YH 구분값없는 string을 dateTime으로변경
    function DateToString(sDateTime : String): String;                            //Added Woo.YH DB에서 읽어온 시간을 구분값없는 String으로 변경

    function HD_VisitAddProcess(sDong, sHo, sCarNo : string;
                              dtStartDateTime, dtEndDateTime : TDateTime) : Integer;//Added Woo.YH  현대통신방문자 차량 등록
    function HD_VisitAddRespone(nReturnValue : Integer;
                   sDong, sHo, sCarNo, sDateTime, sDateTimeEnd : String) : String ; //Added Woo.YH 현대통신 방문자 차량 등록 응답 전송
    function HD_VisitDelProcess(sDong, sHo, sCarNo : String) : Integer;             //Added Woo.YH 현대통신 방문객 차량 취소
    function HD_VisitDelRespone(nReturnValue : Integer;
                   sDong, sHo, sCarNo, sIdx : string) : String;                     //Added Woo.YH 현대통신 방문객 차량 취소 응답 전송
    function HD_VisitListProcess(sDong, sHo, sInOut : String) : String;             //Added Woo.YH 현대통신 방문객 차량 리스트 전송
    function HD_CheckVisit(nCarNo: String): Boolean;
    function EZ_VisitListProcess(sDongHo, sParam : string) : string;                //added Woo.YH 이지빌 방문객 차량 리스트 전송
    function EZ_VisitAddProcess(sCarNo, sTime, sDongHo, sInout : string) : Integer; //added Woo.YH 이지빌 방문객 차량 등록
    function EZ_VisitDelProcess(saDelCarNo : array of string; sDongHo : string) : Integer;
    function EZ_CheckVisit(nCarNo: String): Boolean;

    function ICon_RequestProcess(sRecv: String): String;
    function ICon_CheckVisit(nCarNo: String): Boolean;                              //아이콘트롤스 방문자 체크
    function ICon_VisitAddRespone(sDong, sHo, sCarNo, sProcDateTime, sPeriod :String) : String; //added Woo.YH 아이콘트롤스 방문객 차량 등록
    function ICon_VisitDelProcess : Integer;                    //added Woo.YH 아이콘트롤스 방문객 차량 삭제
    function ICon_VisitListProcess(sDong, sHo: string) : string;                //added Woo.YH 아이콘트롤스 방문객 차량 리스트 전송

  end;

var
  frmMain: TfrmMain;
  bLostProc: Boolean = False;
  sChkDateTime, sNextDateTime, sInDate, sInTime, sOutDate, sOutTime, sChkDate,
    sChkTime, sNextTime,nowsLprFile1,nowInTKNo: AnsiString;
  nYogum, nTotYogum, nItemMax, nTotMax, nDayCnt, nItemMax0, nTotMax0: Cardinal;
  nFeeNo: Word = 0;
  nDCList: Byte = 0;
  nowLpr, ManualLpr: TClientSocket;
  ping_success: Boolean = False;
  nowLprNo,nowLprRecog1 ,nowLprRecog2,nowInUnitNo: Byte;
//          nInUnitNo := FieldByName('UnitNo').AsInteger;
//        sInTKNo := FieldByName('TKNo').AsString;

  // 정기차량 처리대기용 변수들
  bSCProcWait: Boolean = False;
  nSCWaitFlag: Byte = 0; // 처리할 데이터 위치
  nSCWaitPoint: Byte = 0; // 대기 데이터 위치
  RSCWait: Array [1 .. 20] of R_SCWait;

  // 일반차량 처리대기용 변수들
  bNCInProcWait: Boolean = False;
  bNCOutProcWait: Boolean = False;
  nNCInWaitFlag: Byte = 0; // 처리할 데이터 위치
  nNCInWaitPoint: Byte = 0; // 대기 데이터 위치
  nNCOutWaitFlag: Byte = 0; // 처리할 데이터 위치
  nNCOutWaitPoint: Byte = 0; // 대기 데이터 위치
  RNCInWait: Array [1 .. 20] of R_NCWait;
  RNCOutWait: Array [1 .. 20] of R_NCWait;

  // 정기차량 수동출차 차량번호
  sManualSCCarNo: String;

function IcmpCreateFile : THandle; stdcall; external 'icmp.dll';
function IcmpCloseHandle (icmpHandle : THandle) : boolean; stdcall; external 'icmp.dll';
function IcmpSendEcho (IcmpHandle    : THandle;  DestinationAddress: LongInt;
                       RequestData   : Pointer;  RequestSize       : Smallint;
                       RequestOptions: pointer;  ReplyBuffer       : Pointer;
                       ReplySize     : DWORD;    Timeout           : DWORD): DWORD;
                       stdcall; external 'icmp.dll';

implementation
uses
  Global, Tables, Login, InDspSet, DspSet, Setup, UnitInfo,Msg, IONData, Alarm;

{$R *.dfm}

function TfrmMain.MakeCVnetData(sDong, sHo, sTime, sCarNo,
  sType: AnsiString): AnsiString;
var
  sData: AnsiString;
  nSize: Integer;
begin
  sData:= AnsiChar($05) + AnsiChar($56) + AnsiChar($05) + AnsiChar($01) +
          MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + sTime;
  sData:= sData + MG_InsNull(UTF8Encode(sCarNo), 16) + AnsiChar(StrToInt(sType));
  nSize:= Length(sData);
  sData:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nSize) + AnsiChar($00) + sData;
  Result:= sData + BuildCVnetCRC(sData) + ETX;
end;

function TfrmMain.MakeCVNetHeartBeat;
var
  sData: AnsiString;
begin
  sData:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar($07) + AnsiChar($00) +
          AnsiChar($09) + AnsiChar($91) + AnsiChar($01) + AnsiChar($01) +
          AnsiChar($00) + AnsiChar($01) + AnsiChar($01);
  Result:= sData + BuildCVnetCRC(sData) + ETX;
end;

function TfrmMain.MakeCVnetLogin: AnsiString;
var
  sData: AnsiString;
begin
  sData:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar($4C) + AnsiChar($00) +
          AnsiChar($09) + AnsiChar($93) + AnsiChar($03) + AnsiChar($01) +
          MG_InsNull('parkmgr', 32) + MG_InsNull('parkmgr0', 40);
  Result:= sData + BuildCVnetCRC(sData) + ETX;
end;

function TfrmMain.chkNet(csTarget: TClientSocket; sData: AnsiString): Boolean;
begin
  try
    Result:= False;

    if sData = '전광판 문구전송' then
    begin
      if (csTarget.Host <> '') then
      begin
        // ping 때리기
        if is_ping(csTarget.Host) then
        begin
          csTarget.Active:= True;

          if csTarget.Active then
          begin
            // 소켓 연결 안 되었으면
            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end
          else
          begin

            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end;
        end
        else
        begin
          ExceptLogging(csTarget.Host + ' ' + sData + ' 시 Ping 에러!');
        end;
      end;
    end
    // '전광판 문구전송'이 아니면
    else
    begin
      if (csTarget.Host <> '') then
      begin
        // ping
        if is_ping(csTarget.Host) then
        begin
          // csTarget 소켓 접속
          if csTarget.Active then
          begin
            // 소켓 연결 안 되었으면
            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end
          else
          begin
            csTarget.Active:= True;

            if not csTarget.Socket.Connected then
            begin
              ExceptLogging(csTarget.Host + ' ' + sData + ' 시 네트워크 끊김!');
            end
            else
              Result:= True;
          end;
        end
        else
        begin
          ExceptLogging(csTarget.Host + ' ' + sData + ' 시 Ping 에러!');
        end;
      end;
    end;
  except
    on E: Exception do
    begin
      Result:= False;
      ExceptLogging('네트워크 에러: ' + csTarget.Host);
    end;
  end;
end;

// nCmd: 1-BarOpen
procedure TfrmMain.UnitCtrl(nCmd, nFCNo, nUnitNo, nMNo: Word;
  sData: AnsiString);
var
  sFCIp, sSend: aString;
  nFCPort: Word;
  nResponse: Smallint;
  i: Byte;
  bSend: Boolean;
begin
  try
    if nFCNo = nCurrUnitNo then
    begin
      // 현재 요금계산기에 연결된 LPR이면 LPR을 찾아서 명령 전송...
      bSend := False;

      case nCmd of
        1:
          begin
            for i := 1 to 5 do
            begin
              with frmMain do
              begin
                // 입구 LPR 소켓 태그값이 현재 기기번호랑 같으면
                if TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  // chkNet 함수 호출
                  if chkNet(TClientSocket(FindComponent('csInLpr' + IntToStr(i))), '차단기 원격제어') then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end;
                end;
              end;
            end;

            if not bSend then
              for i := 1 to 3 do
              begin
                with frmMain do
                begin
                  if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                  begin
                    if chkNet(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))), '차단기 원격제어') then
                    begin
                      sSend := 'BAR_OPEN-1';
                      TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                      bSend := True;
                      Break;
                    end;
                  end;
                end;
              end;

            // 소켓전송 완료하였으면 차단기제어 내역에 데이터 등록 처리
            if bSend then
            begin
              with dmTables.qryBarProc do
              begin
                Close;
                SQL.Clear;
                SQL.Add('Insert BarProc ');
                SQL.Add(
                  '(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
                Parameters.ParamByName('N1').Value := nCurrParkNo;
                Parameters.ParamByName('N2').Value := nUnitNo;
                Parameters.ParamByName('N3').Value := FormatDateTime
                  ('YYYY-MM-DD', Now);
                Parameters.ParamByName('N4').Value := FormatDateTime
                  ('HH:NN:SS', Now);
                Parameters.ParamByName('N5').Value := 1;
                Parameters.ParamByName('N6').Value := nMNo;
                Parameters.ParamByName('N7').Value := 0;

                if sData <> '' then
                  Parameters.ParamByName('N8').Value := sData
                else
                  Parameters.ParamByName('N8').Value := '수동오픈';
                ExecSQL;
              end;
            end;
          end;
      end;
    end
    else
    begin
      // 다른 요금계산기에 연결된 LPR이면 해당 요금계산기로 명령 전송...
      with qryCtrl do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from UnitInfo where UnitNo = :N1');
        Parameters.ParamByName('N1').Value := nFCNo;
        Open;

        if RecordCount > 0 then
        begin
          sFCIp := MG_StrTrim(FieldByName('IPNo').AsString, ' ');      // IP
          nFCPort := FieldByName('PortNo').AsInteger;                  // Port

          // 다른 요금계산기 ping
          if is_ping(sFCIp) then
          begin
            try
              // 연결끊고, IP랑 Port저장한 다음 다시 연결
              idTC.Disconnect;
              idTC.Host := sFCIp;
              idTC.Port := nFCPort;
              idTC.Connect;

              // 연결되었으면
              if idTC.Connected then
              begin
                sSend := STX + MG_InsZero(IntToStr(nCmd), 2) + MG_InsZero
                  (IntToStr(nUnitNo), 5) + MG_InsZero(IntToStr(nMNo), 3)
                  + sData + ETX;
                idTC.IOHandler.WriteLnRFC(sSend, enDefault);
                idTC.Disconnect;
              end;
            except
              on E: Exception do
                ExceptLogging('TfrmMain.UnitCtrl: ' + aString(E.Message));
            end;
          end
          else
            ExceptLogging('UnitCtrl(' + IntToStr(nCmd) + ')시 네트워크 오류!');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.UnitCtrl: ' + aString(E.Message));
  end;
end;

function TfrmMain.HD_VisitAddProcess(sDong, sHo, sCarNo: string; dtStartDateTime,
  dtEndDateTime: TDateTime): Integer;
var
  fSetini : TIniFile;   //설정 파일
  sMaxCar : String;     //최대등록가능차량
  tdNow: TDateTime;     //현재 날짜 시간

begin
  ExceptLogging('HD_VisitAddProcess : Start');
  tdNow := Now;
  fSetini := TIniFile.Create(ExtractFileDir(Application.ExeName) + '\ParkSet.ini');
  sMaxCar  := iSetup.ReadString('VISIT', 'MaxCar', '6');
  if (sDong = '') or (sHo = '') or (sCarNo = '') or (dtStartDateTime = StringToDate('100010101010')) then
  begin
    ExceptLogging('HD_VisitAddProcess : 전문양식오류');
    Result := -3;
    Exit;
  end;

  try
    with dmTables.qryVisitInsert do
    begin
      //최대 등록가능 차량 수 확인
      Close;
      SQL.Clear;
      SQL.Add('Select CarNo from VisitInfo');
      SQL.Add(' where StartDateTime <= :N1 and EndDateTime >= :N2');
      SQL.Add(' and Dong = :N3 and Ho = :N4');
      Parameters.ParamByName('N1').Value := tdNow;
      Parameters.ParamByName('N2').Value := tdNow;
      Parameters.ParamByName('N3').Value := sDong;
      Parameters.ParamByName('N4').Value := sHo;
      Open;
      if RecordCount >= 5 then
      begin
        ExceptLogging('최대 등록 가능 차량 수 [' + sMaxCar + '] 초과');
        Result := -1; //최대 등록 가능 차량 수 초과
        Exit;
      end;

      //차량 중복 등록 여부 확인
      Close;
      SQL.Clear;
      SQL.Add('Select CarNo from VisitInfo');
      SQL.Add(' where StartDateTime < :N1 and EndDateTime > :N2 and CarNo = :N3');
      SQL.Add(' and Dong = :N3 and Ho = :N4');
      Parameters.ParamByName('N1').Value := tdNow;
      Parameters.ParamByName('N2').Value := tdNow;
      Parameters.ParamByName('N3').Value := sCarNo;
      Parameters.ParamByName('N3').Value := sDong;
      Parameters.ParamByName('N4').Value := sHo;
      Open;
      if RecordCount > 0 then
      begin
        ExceptLogging('차량 중복으로 등록 : [' + sCarNo + ']');
        Result := -2;   //차량 중복 등록
        Exit;
      end;

      //차량 등록
      Close;
      Sql.Clear;
      SQL.Add('Insert Into VisitInfo ');
      SQL.Add('(Dong, Ho, CarNo, StartDateTime, EndDateTime)');
      SQL.Add(' Values (:N1, :N2, :N3, :N4, :N5)');
      Parameters.ParamByName('N1').Value := sDong;
      Parameters.ParamByName('N2').Value := sHo;
      Parameters.ParamByName('N3').Value := sCarNo;
      Parameters.ParamByName('N4').Value := dtStartDateTime;
      Parameters.ParamByName('N5').Value := dtEndDateTime;
      ExecSQL;
      Result := 0;      //정상종료
      ExceptLogging('HD_VisitAddProcess : End');
    end;
  except
    on E: Exception do
    begin
      ExceptLogging('HD_VisitAddProcess : ' + aString(E.Message));
      Result := -3;     //DB에러발생
    end;
  end;
end;

function TfrmMain.HD_VisitAddRespone(nReturnValue: Integer; sDong, sHo, sCarNo,
  sDateTime, sDateTimeEnd: String): String;
var
  sSend : string; //송신 전문
begin
  if nReturnValue = -1 then
  begin
    sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo + '&DateTime=' + sDateTime +
            '&DateTimeEnd=' + sDateTimeEnd + '&InOut=VISIT' + '&Return=fail' + '&ReturnCmt=OverFlow';
  end
  else if nReturnValue = -2 then
  begin
    sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo + '&DateTime=' + sDateTime +
            '&DateTimeEnd=' + sDateTimeEnd + '&InOut=VISIT' + '&Return=fail' + '&ReturnCmt=AlreadyCar';
  end
  else if nReturnValue = -3 then
  begin
    sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo + '&DateTime=' + sDateTime +
            '&DateTimeEnd=' + sDateTimeEnd + '&InOut=VISIT' + '&Return=fail';
  end
  else if nReturnValue = 0 then
  begin
    sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo + '&DateTime=' + sDateTime +
            '&DateTimeEnd=' + sDateTimeEnd + '&InOut=VISIT' + '&Return=ok';
  end;

  if sSend <> '' then                                             //전문 전송
  begin
    sSend := MG_InsZero(IntToStr(Length(AnsiString(sSend))+20), 8) + sSend + '                    ';
    Result := sSend;
  end;
end;

function TfrmMain.HD_VisitDelProcess(sDong, sHo, sCarNo: String): Integer;
var
  tdNow: TDateTime;     //현재 날짜 시간
begin
  ExceptLogging('HD_VisitDelProcess : Start');
  tdNow := Now;

  if (sDong = '') or (sHo = '') or (sCarNo = '') then
  begin
    ExceptLogging('HD_VisitDelProcess : 전문양식오류');
    Result := -3;
    Exit;
  end;

  try
    with dmTables.qryVisitDelete do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from VisitInfo');
//      SQL.Add(' where StartDateTime <= :N1 and EndDateTime >= :N2');
      SQL.Add(' where Dong = :N1 and Ho = :N2 and CarNo = :N3');
//      Parameters.ParamByName('N1').Value := tdNow;
//      Parameters.ParamByName('N2').Value := tdNow;
      Parameters.ParamByName('N1').Value := sDong;
      Parameters.ParamByName('N2').Value := sHo;
      Parameters.ParamByName('N3').Value := sCarNo;
      Open;
      if RecordCount <= 0 then
      begin
        Result := -3;
        Exit;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Delete from VisitInfo');
//      SQL.Add(' where StartDateTime <= :N1 and EndDateTime >= :N2');
      SQL.Add(' where Dong = :N1 and Ho = :N2 and CarNo = :N3');
//      Parameters.ParamByName('N1').Value := tdNow;
//      Parameters.ParamByName('N2').Value := tdNow;
      Parameters.ParamByName('N1').Value := sDong;
      Parameters.ParamByName('N2').Value := sHo;
      Parameters.ParamByName('N3').Value := sCarNo;
      ExecSQL;

      Result := 0;
      ExceptLogging('HD_VisitDelProcess : End');
    end;
    except
    on E: Exception do
    begin
      ExceptLogging('HD_VisitDelProcess : ' + aString(E.Message));
      Result := -3;            //DB에러발생
    end;
  end;
end;

function TfrmMain.HD_VisitDelRespone(nReturnValue: Integer; sDong, sHo, sCarNo,
  sIdx: string): String;
var
  sSend : string;                                              //송신 전문
begin
  if nReturnValue = -3 then
  begin
    sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo +
            '&Idx=' + sIdx + '&InOut=VISIT_DEL' + '&Return=fail';
  end
  else if nReturnValue = 0 then
  begin
    sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo +
            '&Idx=' + sIdx + '&InOut=VISIT_DEL' + '&Return=ok';
  end;

  if sSend <> '' then                                             //전문 전송
  begin
    sSend := MG_InsZero(IntToStr(Length(AnsiString(sSend))+20), 8) + sSend + '                    ';
    Result := sSend;
  end;
end;

function TfrmMain.HD_VisitListProcess(sDong, sHo, sInOut: String): String;
var
  tdNow : TDateTime;     //현재 날짜 시간
  sSend : String;        //응답전문
  sSendCarNo, sSendDateTime, sSendDateTimeEnd : String;   // 응답전문
begin
  ExceptLogging('HD_VisitListProcess : Start');
  tdNow := Now;

  if (sDong = '') or (sHo = '') or (sInOut = '') then
  begin
    ExceptLogging('HD_VisitListProcess : 전문 양식 오류 ');
    Exit;
  end;

  try
    with dmTables.qryVisitList do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from VisitInfo');
      if sInOut = 'VISIT_LIST' then
      begin
        SQL.Add(' where Dong = :N1 and Ho = :N2');
        SQL.Add(' and StartDateTime <= :N3 and EndDateTime >= :N4');
        Parameters.ParamByName('N1').Value := sDong;
        Parameters.ParamByName('N2').Value := sHo;
        Parameters.ParamByName('N3').Value := tdNow;
        Parameters.ParamByName('N4').Value := tdNow;
      end
      else if sInOut = 'VISIT_LIST_HISTORY' then
      begin
        SQL.Add(' where Dong = :N1 and Ho = :N2');
        SQL.Add(' and EndDateTime < :N3');
        Parameters.ParamByName('N1').Value := sDong;
        Parameters.ParamByName('N2').Value := sHo;
        Parameters.ParamByName('N3').Value := tdNow;
      end
      else if sInOut = 'VISIT_LIST_ALL' then
      begin
        SQL.Add(' where Dong = :N1 and Ho = :N2');
        Parameters.ParamByName('N1').Value := sDong;
        Parameters.ParamByName('N2').Value := sHo;
      end;

      SQL.Add(' order by StartDateTime desc');
      Open;
      if RecordCount > 0 then
      begin
        sSendCarNo     := FieldByName('CarNo').AsString;
        sSendDateTime  := DateToString(FieldByName('StartDateTime').AsString);
        sSendDateTimeEnd := DateToString(FieldByName('EndDateTime').AsString);
        Next;

        while not Eof do
        begin
          sSendCarNo := sSendCarNo + '^' + FieldByName('CarNo').AsString;
          sSendDateTime := sSendDateTime + '^' + DateToString(FieldByName('StartDateTime').AsString);
          sSendDateTimeEnd := sSendDateTimeEnd + '^' + DateToString(FieldByName('EndDateTime').AsString);
          Next;
        end;

        sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sSendCarNo +
                '&DateTime=' + sSendDateTime + '&DateTimeEnd=' + sSendDateTimeEnd + '&InOut=' + sInOut + '&Cnt=' + IntToStr(RecordCount) + '&Return=ok';
        sSend := MG_InsZero(IntToStr(Length(AnsiString(sSend))+20), 8) + sSend + '                    ';
        //임시로 스페이스 넣어서 전달
        Result := sSend;
        ExceptLogging('HD_VisitListProcess : End');
      end
      else
      begin
        sSend:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sSendCarNo +
                '&DateTime=' + sSendDateTime + '&DateTimeEnd=' + sSendDateTimeEnd + '&InOut=' + sInOut + '&Cnt=' + IntToStr(RecordCount) + '&Return=fail';
        sSend := MG_InsZero(IntToStr(Length(AnsiString(sSend))+20), 8) + sSend + '                    ';
        Result := sSend;
        ExceptLogging('HD_VisitListProcess : 리스트 없음');
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('HD_VisitListProcess: ' + aString(E.Message));

  end;
end;

{
입구차단기 open
최종수정: 2014-11-27
}
procedure TfrmMain.InOpen(csLPR: TClientSocket);
begin
  try
    if nGateActive = 1 then //차단기 동작여부
    begin
      if is_Ping(csLpr.Host) then
      begin
        csLPR.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('입구차단기 Open');
      end
      else begin
        ExceptLogging(csLpr.Host + ' LPR 차단기 오픈시 네트워크 오류!');
        if is_ping(csLpr.Host) then
        begin
          csLPR.Socket.SendText('BAR_OPEN_1');
          ExceptLogging('입구차단기 ReOpen');
        end
        else
          ExceptLogging(csLpr.Host + ' LPR 차단기 재오픈시 네트워크 오류!');
      end;
    end
    else
    begin
      ExceptLogging('TfrmMain.InOpen : LPR 차단기 미동작 모드');
    end;
  except
    on E: Exception do
      ExceptLogging('InOpen: ' + aString(E.Message));
  end;
end;

{
출구차단기 open
최종수정: 2014-11-27
}
procedure TfrmMain.OutOpen(csLPR: TClientSocket);
begin
  try
    if nGateActive = 1 then
    begin
      if is_Ping(csLpr.Host) then
      begin
        csLPR.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('출구차단기 Open');
      end
      else begin
        ExceptLogging(csLpr.Host + ' LPR 차단기 오픈시 네트워크 오류!');
        if is_ping(csLpr.Host) then
        begin
          csLPR.Socket.SendText('BAR_OPEN_1');
          ExceptLogging('출구차단기 ReOpen');
        end
        else
          ExceptLogging(csLpr.Host + ' LPR 차단기 재오픈시 네트워크 오류!');
      end;
    end
    else
    begin
      ExceptLogging('TfrmMain.OutOpen : LPR 차단기 미동작 모드');
    end;
  except
    on E: Exception do
      ExceptLogging('OutOpen: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.popCloseClick(Sender: TObject);
begin
  try
    if nGateNo = 11 then
    begin
      if chkNet(csInLpr1, '차단기 Close') then
      begin
        csInLpr1.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차1 차단기 Close');
      end;
    end
    else if nGateNo = 12 then
    begin
      if chkNet(csInLpr2, '차단기 Close') then
      begin
        csInLpr2.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차2 차단기 Close');
      end;
    end
    else if nGateNo = 13 then
    begin
      if chkNet(csInLpr3, '차단기 Close') then
      begin
        csInLpr3.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차3 차단기 Close');
      end;
    end
    else if nGateNo = 14 then
    begin
      if chkNet(csInLpr4, '차단기 Close') then
      begin
        csInLpr4.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차4 차단기 Close');
      end;
    end
    else if nGateNo = 21 then
    begin
      if chkNet(csOutLpr1, '차단기 Close') then
      begin
        csOutLpr1.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차1 차단기 Close');
      end;
    end
    else if nGateNo = 22 then
    begin
      if chkNet(csOutLpr2, '차단기 Close') then
      begin
        csOutLpr2.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차2 차단기 Close');
      end;
    end
    else if nGateNo = 23 then
    begin
      if chkNet(csOutLpr3, '차단기 Close') then
      begin
        csOutLpr3.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차3 차단기 Close');
      end;
    end
    else if nGateNo = 24 then
    begin
      if chkNet(csOutLpr4, '차단기 Close') then
      begin
        csOutLpr4.Socket.SendText('BAR_CLOSE_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차4 차단기 Close');
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.popOpenClick: ' + E.Message);
  end;
end;

procedure TfrmMain.popUnLockClick(Sender: TObject);
begin
  try
    if nGateNo = 11 then
    begin
      if is_Ping(csInLpr1.Host) then
      begin
        csInLpr1.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차1 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csInLpr1.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csInLpr1.Host) then
        begin
          csInLpr1.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 입차1 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 12 then
    begin
      if is_Ping(csInLpr2.Host) then
      begin
        csInLpr2.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차2 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csInLpr2.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csInLpr2.Host) then
        begin
          csInLpr2.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 입차2 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 13 then
    begin
      if is_Ping(csInLpr3.Host) then
      begin
        csInLpr3.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차3 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csInLpr3.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csInLpr3.Host) then
        begin
          csInLpr3.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 입차3 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 14 then
    begin
      if is_Ping(csInLpr4.Host) then
      begin
        csInLpr4.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차4 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csInLpr4.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csInLpr4.Host) then
        begin
          csInLpr4.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 입차4 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 21 then
    begin
      if is_Ping(csOutLpr1.Host) then
      begin
        csOutLpr1.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차1 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csOutLpr1.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csOutLpr1.Host) then
        begin
          csOutLpr1.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 출차1 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 22 then
    begin
      if is_Ping(csOutLpr2.Host) then
      begin
        csOutLpr2.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차2 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csOutLpr2.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csOutLpr2.Host) then
        begin
          csOutLpr2.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 출차2 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 23 then
    begin
      if is_Ping(csOutLpr3.Host) then
      begin
        csOutLpr3.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차3 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csOutLpr3.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csOutLpr3.Host) then
        begin
          csOutLpr3.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 출차3 차단기 UnLock');
        end
      end;
    end
    else if nGateNo = 24 then
    begin
      if is_Ping(csOutLpr4.Host) then
      begin
        csOutLpr4.Socket.SendText('BAR_OPEN_UNLOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차4 차단기 UnLock');
      end
      else
      begin
        ExceptLogging(csOutLpr4.Host + ' LPR 차단기 잠금시 네트워크 오류!');
        if is_ping(csOutLpr4.Host) then
        begin
          csOutLpr4.Socket.SendText('BAR_OPEN_UNLOCK_1');
          ExceptLogging('TfrmMain.popOpenClick: 출차4 차단기 UnLock');
        end
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.popOpenClick: ' + E.Message);
  end;
end;

procedure TfrmMain.popOpenClick(Sender: TObject);
begin
  try
    if nGateNo = 11 then
    begin
      if chkNet(csInLpr1, '차단기 OPEN') then
      begin
        csInLpr1.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차1 차단기 OPEN');
      end;
    end
    else if nGateNo = 12 then
    begin
      if chkNet(csInLpr2, '차단기 OPEN') then
      begin
        csInLpr2.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차2 차단기 OPEN');
      end;
    end
    else if nGateNo = 13 then
    begin
      if chkNet(csInLpr3, '차단기 OPEN') then
      begin
        csInLpr3.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차3 차단기 OPEN');
      end;
    end
    else if nGateNo = 14 then
    begin
      if chkNet(csInLpr4, '차단기 OPEN') then
      begin
        csInLpr4.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차4 차단기 OPEN');
      end;
    end
    else if nGateNo = 21 then
    begin
      if chkNet(csOutLpr1, '차단기 OPEN') then
      begin
        csOutLpr1.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차1 차단기 OPEN');
      end;
    end
    else if nGateNo = 22 then
    begin
      if chkNet(csOutLpr2, '차단기 OPEN') then
      begin
        csOutLpr2.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차2 차단기 OPEN');
      end;
    end
    else if nGateNo = 23 then
    begin
      if chkNet(csOutLpr3, '차단기 OPEN') then
      begin
        csOutLpr3.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차3 차단기 OPEN');
      end;
    end
    else if nGateNo = 24 then
    begin
      if chkNet(csOutLpr4, '차단기 OPEN') then
      begin
        csOutLpr4.Socket.SendText('BAR_OPEN_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차4 차단기 OPEN');
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.popOpenClick: ' + E.Message);
  end;
end;

procedure TfrmMain.popOpenLockClick(Sender: TObject);
begin
   try
    if nGateNo = 11 then
    begin
      if is_Ping(csInLpr1.Host) then
      begin
        csInLpr1.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차1 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csInLpr1.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csInLpr1.Host) then
		  begin
			csInLpr1.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 입차1 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 12 then
    begin
      if is_Ping(csInLpr2.Host) then
      begin
        csInLpr2.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차2 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csInLpr2.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csInLpr2.Host) then
		  begin
			csInLpr2.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 입차2 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 13 then
    begin
      if is_Ping(csInLpr3.Host) then
      begin
        csInLpr3.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차3 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csInLpr3.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csInLpr3.Host) then
		  begin
			csInLpr3.Socket.SendText('BAR_OPEN_LOCK_1');
	        ExceptLogging('TfrmMain.popOpenClick: 입차3 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 14 then
    begin
      if is_Ping(csInLpr4.Host) then
      begin
        csInLpr4.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 입차4 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csInLpr4.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csInLpr4.Host) then
		  begin
			csInLpr4.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 입차4 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 21 then
    begin
      if is_Ping(csOutLpr1.Host) then
      begin
        csOutLpr1.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차1 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csOutLpr1.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csOutLpr1.Host) then
		  begin
			csOutLpr1.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 출차1 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 22 then
    begin
      if is_Ping(csOutLpr2.Host) then
      begin
        csOutLpr2.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차2 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csOutLpr2.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csOutLpr2.Host) then
		  begin
			csOutLpr2.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 출차2 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 23 then
    begin
      if is_Ping(csOutLpr3.Host) then
      begin
        csOutLpr3.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차3 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csOutLpr3.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csOutLpr3.Host) then
		  begin
			csOutLpr3.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 출차3 차단기 Lock');
		  end
	  end;
    end
    else if nGateNo = 24 then
    begin
      if is_Ping(csOutLpr4.Host) then
      begin
        csOutLpr4.Socket.SendText('BAR_OPEN_LOCK_1');
        ExceptLogging('TfrmMain.popOpenClick: 출차4 차단기 Lock');
      end
	  else
	  begin
		  ExceptLogging(csOutLpr4.Host + ' LPR 차단기 잠금시 네트워크 오류!');
		  if is_ping(csOutLpr4.Host) then
		  begin
			csOutLpr4.Socket.SendText('BAR_OPEN_LOCK_1');
			ExceptLogging('TfrmMain.popOpenClick: 출차4 차단기 Lock');
		  end
	  end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.popOpenClick: ' + E.Message);
  end;
end;

procedure TfrmMain.prDelay(Time: Integer);
var
   PastCount: LongInt;
begin
     PastCount := GetTickCount;
     repeat
           Application.ProcessMessages;
     until ((GetTickCount-PastCount) >= LongInt(Time));
end;

// 정기차량 그리드 화면에 표시
procedure TfrmMain.GridData(nIO, nListCnt: Byte; sResult: String);
var
  sCarNo, sName, sCompName, sDeptName, sExpDate, sStatus, sTemp, sIODate, sIOTime, sLineInCnt, sLineOutCnt: String;
  nPos: Byte;
begin
  // '12014-11-04^13:05:10^31로6819^홍길동^^^2014-12-03까지^입 차'
  if Length(sResult) > 6 then
  begin
 //   nIO := nIO;
    nIO := StrToInt(Copy(sResult, 1, 1));
    sIODate := Copy(sResult, 2, Pos('^', sResult) - 2);          // '2014-11-04'

//    sIODate := Copy(sResult, 1, Pos('^', sResult) - 2);          // '2014-11-04'
    sTemp := Copy(sResult, Pos('^', sResult) + 1, Length(sResult) - (Pos('^', sResult)));
    sIOTime := Copy(sTemp, 1, Pos('^', sTemp) - 1);                // '13:05:10'
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sCarNo := Copy(sTemp, 1, Pos('^', sTemp) - 1);                // 차량번호: '31로6819'
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sName := Copy(sTemp, 1, Pos('^', sTemp) - 1);                 // 이름: '홍길동'
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sCompName := Copy(sTemp, 1, Pos('^', sTemp) - 1);             // 동
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    sDeptName:= Copy(sTemp, 1, Pos('^', sTemp) - 1);              // 호
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)));
    //Copy(sTemp, nPos + 1, (Length(sTemp) - (nPos)) + 2);
    sExpDate := Copy(sTemp, 1, Pos('^', sTemp) - 1);              // 유효기간
    nPos := Pos('^', sTemp);
    sStatus := Copy(sTemp, nPos + 1, Length(sTemp) - nPos);      // '2014-12-03까지^입 차'

    // 입구
    if nIO = 1 then
    begin
      with frmMain do
      begin
        sLineInCnt := TLabel(FindComponent('lbIn' + IntToStr(nListCnt))).Caption;
        // 화면에 표시(정기, 동, 호, 차량번호)
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '정기';
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clBlack;


        if (sCompName <> '') or (sDeptName <> '') then
        begin
          if nApt = 1 then        //아파트
          begin
            TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= sCompName +'동 '+  sDeptName + '호';
          end
          else if nApt = 0 then
          Begin
            TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= sCompName +' / '+  sDeptName;
          End;
        end
        else
          TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';


        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo;
        TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
        TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
        TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
        with sgIn do
        begin
          InsertRows(1, 1, True);
          Cells[0, 1] := '정기차량';
          Cells[1, 1] := sIODate;
          Cells[2, 1] := sIOTime;
          Cells[3, 1] := sCarNo;
          if nApt = 1 then
          begin
            Cells[4, 1] := sCompName +'동 '+  sDeptName + '호';
          end
          else if nApt = 0 then
          begin
            Cells[4, 1] := sCompName +' / '+  sDeptName;
          end;
          Cells[5, 1] := sName;
          Cells[6, 1] := sExpDate;
          Cells[7, 1] := sStatus;
          Cells[8, 1] := sLineInCnt;
        end;
        sgIn.Alignments[0, 1] := taCenter;
        sgIn.Alignments[1, 1] := taCenter;
        sgIn.Alignments[2, 1] := taCenter;
        sgIn.Alignments[3, 1] := taCenter;
        sgIn.Alignments[4, 1] := taCenter;
        sgIn.Alignments[5, 1] := taCenter;
        sgIn.Alignments[6, 1] := taCenter;
        sgIn.Alignments[7, 1] := taCenter;
        sgIn.Alignments[8, 1] := taCenter;
      end;
    end
    // 출구
    else
    begin
      with frmMain do
      begin
        sLineOutCnt := TLabel(FindComponent('lbOut' + IntToStr(nListCnt))).Caption;
        // 화면에 표시(정기, 동, 호, 차량번호)
        TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '정기';
        TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        if (sCompName <> '') or (sDeptName <> '') then
        begin
          if nApt = 1 then        //아파트
          begin
            TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= sCompName +'동 '+  sDeptName + '호';
          end
          else if nApt = 0 then
          Begin
            TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= sCompName +' / '+  sDeptName;
          End;
        end
        else
          TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';

        TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clBlack;
        TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo;
        TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
        TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
        TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
        with sgOut do
        begin
          InsertRows(1, 1, True);
          Cells[0, 1] := '정기차량';
          Cells[1, 1] := sIODate;
          Cells[2, 1] := sIOTime;
          Cells[3, 1] := sCarNo;
          if nApt = 1 then
          begin
            Cells[4, 1] := sCompName +'동 '+  sDeptName + '호';
          end
          else if nApt = 0 then
          begin
            Cells[4, 1] := sCompName +' / '+  sDeptName;
          end;
          Cells[5, 1] := sName;
          Cells[6, 1] := sExpDate;
          Cells[7, 1] := sStatus;
          Cells[8, 1] := sLineOutCnt;
        end;
        sgOut.Alignments[0, 1] := taCenter;
        sgOut.Alignments[1, 1] := taCenter;
        sgOut.Alignments[2, 1] := taCenter;
        sgOut.Alignments[3, 1] := taCenter;
        sgOut.Alignments[4, 1] := taCenter;
        sgOut.Alignments[5, 1] := taCenter;
        sgOut.Alignments[6, 1] := taCenter;
        sgOut.Alignments[7, 1] := taCenter;
        sgOut.Alignments[8, 1] := taCenter;
      end;
    end;
  end;
end;

// nIO: 1-입구, 2-출구    nType: 1-정기차량, 2-일반차량, 3-요금표시, 4-주차요금0원
procedure TfrmMain.csOutDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp1_connect');
end;

procedure TfrmMain.csOutDsp1Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp1_Disconnect');
end;

procedure TfrmMain.csOutDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[Out]>DSP1 Recv: ' + sRecv);
end;


procedure TfrmMain.csOutDsp2Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp2_connect');
end;

procedure TfrmMain.csOutDsp2Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp2_Disconnect');
end;

procedure TfrmMain.csOutDsp2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[Out]>DSP2 Recv: ' + sRecv);
end;

procedure TfrmMain.csOutDsp3Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp3_connect');
end;

procedure TfrmMain.csOutDsp3Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp3_Disconnect');
end;

procedure TfrmMain.csOutDsp3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[Out]>DSP3 Recv: ' + sRecv);
end;

procedure TfrmMain.csOutDsp4Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp4_connect');
end;

procedure TfrmMain.csOutDsp4Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('OutDsp4_Disconnect');
end;

procedure TfrmMain.csOutDsp4Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[Out]>DSP4 Recv: ' + sRecv);
end;

procedure TfrmMain.csOutLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr1Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csOutLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tOutAlive1.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv1 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr1.Tag) + ' Recv: ' + sOutLPRRecv1);

    if Length(sOutLPRRecv1) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr1.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr1.Tag;
      sLprData := sOutLPRRecv1;
      sLprIP := csOutLpr1.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr1;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR1 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14), '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile4:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryOutLpr1Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);

                GridData(nIO, nListCnt, sResult);

                if bHomeInfo then
                  HomeInfo_Proc(nIO);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := False;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);
                end;
              end;
            end;
          end;
        end
        else
        begin
          if bMiIn then
          begin
            //미인식차량 출차시...
            if nIO = 2 then
            begin
              if bNCInProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCInWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCOutWaitPoint].bBarOpen := bInBarOpen1;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                 nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
//            with frmMain do
//            begin
//              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
//              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
//              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
//              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
//              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
//              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
////              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
////              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
////              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
//            end;
//            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '일반';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            if not bMode then
            begin
                OutOpen(csLPR);
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);

          end;
        end;
        end;
        //Image16.Refresh;
      except
        on E: Exception do
          ExceptLogging('csOutLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv1 = 'LPR_R' then
      begin
//        if chkNet(csOutLpr1, '시간동기화 전송') then
//        begin
////          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
////          ExceptLogging('시간동기화 전송');
//        end;
      end;
    end;
    sOutLPRRecv1 := '';
  finally
    tOutAlive1.Enabled := True;
  end;
end;

procedure TfrmMain.csOutLpr2Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr2Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csOutLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tOutAlive2.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv2 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr2.Tag) + ' Recv: ' + sOutLPRRecv2);

    if Length(sOutLPRRecv2) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr2.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr2.Tag;
      sLprData := sOutLPRRecv2;
      sLprIP := csOutLpr2.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr2;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR2 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile5:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryOutLpr2Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);

                GridData(nIO, nListCnt, sResult);

                if bHomeInfo then
                  HomeInfo_Proc(nIO);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := False;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);
                end;
              end;
            end;
          end;
        end
        else
        begin
          if bMiIn then
          begin
            //미인식차량 출차시...
            if nIO = 2 then
            begin
              if bNCInProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCInWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCOutWaitPoint].bBarOpen := bInBarOpen1;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
            with frmMain do
            begin
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
//              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
//              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
//              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '일반';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            if not bMode then
            begin
                OutOpen(csLPR);
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end;
        end;
        end;
      except
        on E: Exception do
          ExceptLogging('csOutLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv2 = 'LPR_R' then
      begin
//        if chkNet(csOutLpr2, '시간동기화 전송') then
//        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
//        end;
      end;
    end;
    sOutLPRRecv2 := '';
  finally
    tOutAlive2.Enabled := True;
  end;
end;

procedure TfrmMain.csOutLpr3Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr3Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csOutLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tOutAlive3.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv3 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr3.Tag) + ' Recv: ' + sOutLPRRecv3);

    if Length(sOutLPRRecv3) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr3.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr3.Tag;
      sLprData := sOutLPRRecv3;
      sLprIP := csOutLpr3.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr3;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR3 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile6:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryOutLpr3Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);

                GridData(nIO, nListCnt, sResult);

                if bHomeInfo then
                  HomeInfo_Proc(nIO);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                end;
              end;
            end;
          end;
        end
        else
        begin
          if bMiIn then
          begin
            //미인식차량 출차시...
            if nIO = 2 then
            begin
              if bNCInProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCInWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCOutWaitPoint].bBarOpen := bInBarOpen1;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,  nRecog1, nRecog2, sDspIP,
                csLPR, True, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
          //미인식차량 처리...
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end
            else if nIO = 2 then
            begin
              //출구...
              with frmMain do
              begin
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              if not bMode then
              begin
                  OutOpen(csLPR);
              end;
              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csOutLpr3Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv3 = 'LPR_R' then
      begin
        if chkNet(csOutLpr3, '시간동기화 전송') then
        begin
          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sOutLPRRecv3 := '';
  finally
    tOutAlive3.Enabled := True;
  end;
end;

procedure TfrmMain.csOutLpr4Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('OutLpr4Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csOutLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tOutAlive4.Enabled := False;
    sRecv := Socket.ReceiveText;
    sOutLPRRecv4 := sRecv;
    ExceptLogging('LPR' + IntToStr(csOutLpr4.Tag) + ' Recv: ' + sOutLPRRecv4);

    if Length(sOutLPRRecv4) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csOutLpr4.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;
      nNo := csOutLpr4.Tag;
      sLprData := sOutLPRRecv4;
      sLprIP := csOutLpr4.Host;
      sDspIP := sDspIP;
      csLPR := csOutLpr4;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');

          with dmTables.qryRecvOutLPR3 do
          begin
            Close;
            SQL.Clear;
            SQL.Add('Select * from IONData where ProcDate = :N1 and ProcTime = :N2 and InCarNo1 = :N3');
            Parameters.ParamByName('N1').Value := Copy(sTime, 1, 10);
            Parameters.ParamByName('N2').Value := Copy(sTime, 12, 8);
            Parameters.ParamByName('N3').Value := sCarNo1;
            Open;

            if RecordCount > 0 then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update IONData Set InCarNo2 = :N1, InImage2 = :N2, InRecog2 = :N6 ');
              SQL.Add('where ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
              Parameters.ParamByName('N1').Value := sCarNo2;
              Parameters.ParamByName('N2').Value := sFile2;
              Parameters.ParamByName('N3').Value := Copy(sTime, 1, 10);
              Parameters.ParamByName('N4').Value := Copy(sTime, 12, 8);
              Parameters.ParamByName('N5').Value := sCarNo1;
              Parameters.ParamByName('N6').Value := nRecog2;
              ExecSQL;
            end;
          end;
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile7:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryOutLpr4Proc do
          begin
            if not b6Proc then
            begin
              Close;
              SQL.Clear;
              SQL.Add('Select * from CustInfo ');

              if sCarNo2 <> '' then
              begin
                SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Parameters.ParamByName('N2').Value := sCarNo2;
                Open;
              end
              else
              if sCarNo1 <> '' then
              begin
                SQL.Add('where CarNo = :N1 and TKType = 2');
                Parameters.ParamByName('N1').Value := sCarNo1;
                Open;
              end;
            end
            else
            begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end
            end;

            if RecordCount > 0 then
            begin
              // 등록된 정기차량이면...
              sCarNo1:= FieldByName('CarNO').AsString;

              // 사용가능한 정기차량이면...
              if bSCProcWait then
              begin
                if nSCWaitPoint = 20 then
                  nSCWaitPoint := 1
                else
                  nSCWaitPoint := nSCWaitPoint + 1;

                RSCWait[nSCWaitPoint].sSCFile1 := sImgFile1;
                RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                RSCWait[nSCWaitPoint].sSCFile2 := sImgFile2;
                RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                RSCWait[nSCWaitPoint].nSCInOut := nIO;
                RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                RSCWait[nSCWaitPoint].bBarOpen := True;

                if not tSCWait.Enabled then
                  tSCWait.Enabled := True;
              end
              else
              begin
                sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                       nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);

                GridData(nIO, nListCnt, sResult);

                if bHomeInfo then
                  HomeInfo_Proc(nIO);
              end;
            end
            else
            begin
              // 일반차량 처리...
              if nIO = 1 then
              begin
                if bNCInProcWait then
                begin
                  if nNCInWaitPoint = 20 then
                    nNCInWaitPoint := 1
                  else
                    nNCInWaitPoint := nNCInWaitPoint + 1;

                  RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                  RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                  RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                  RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                  RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                  RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                  RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                  RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                  RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                  RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                  RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;

                  if not tNCInWait.Enabled then
                    tNCInWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                end;
              end
              else if nIO = 2 then
              begin
                if bNCOutProcWait then
                begin
                  if nNCOutWaitPoint = 20 then
                    nNCOutWaitPoint := 1
                  else
                    nNCOutWaitPoint := nNCOutWaitPoint + 1;

                  RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                  RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                  RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                  RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                  RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                  RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                  RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                  RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                  RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                  RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                  RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                  if not tNCOutWait.Enabled then
                    tNCOutWait.Enabled := True;
                end
                else
                begin
                  NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                    nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                end;
              end;
            end;
          end;
        end
        else
        begin
          if bMiIn then
          begin
            //미인식차량 출차시...
            if nIO = 2 then
            begin
              if bNCInProcWait then
              begin
                if nNCOutWaitPoint = 20 then
                  nNCOutWaitPoint := 1
                else
                  nNCOutWaitPoint := nNCOutWaitPoint + 1;

                RNCInWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCOutWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCOutWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCOutWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCOutWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCOutWaitPoint].bBarOpen := bInBarOpen1;

                if not tNCOutWait.Enabled then
                  tNCOutWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                nRecog1, nRecog2, sDspIP, csLPR, True, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
          //미인식차량 처리...
          try
            if FileExists(sImgFile1) then
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                end;
              end;
            end
            else
            begin
              if nIO = 1 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end
              else
              if nIO = 2 then
              begin
                with frmMain do
                begin
                  TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                end;
              end;

              ExceptLogging('File 없음: ' + sImgFile1);
            end;
          except
            on E: Exception do
              ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          end;

          if nIO = 1 then
          begin
            //입구...
            with frmMain do
            begin
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end
          else if nIO = 2 then
          begin
            //출구...
            with frmMain do
            begin
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
              TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            if not bMode then
            begin
                OutOpen(csLPR);
            end;
            DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
          end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csOutLpr4Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sOutLPRRecv4 = 'LPR_R' then
      begin
//        if chkNet(csOutLpr4, '시간동기화 전송') then
//        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
//        end;
      end;
    end;
    sOutLPRRecv4 := '';
  finally
    tOutAlive4.Enabled := True;
  end;
end;

procedure TfrmMain.CVnetProc(sData: AnsiString);
var
  sSend, sDong, sHo, sCarNo, sInDate, sOutDate, sTemp: AnsiString;
  nPage, nDataCnt, nTotCnt, nSendPage, nSendDataCnt, i, j, nType, nDate, nIndex: Byte;
  nTotSize, nSizeLow, nSizeHigh, nMod: Integer;
  sChkDate: TDate;
begin
  try
  case Ord(sData[7]) of
     86: begin
           case Ord(sData[8]) of
             1: begin
                  //방문차량 조회 요청
                  sDong:= IntToStr(StrToInt(Copy(sData, 10, 4)));
                  sHo:= IntToStr(StrToInt(Copy(sData, 14, 4)));
                  nPage:= Ord(sData[18]);
                  nDataCnt:= Ord(sData[19]);

                  if not ((MG_NumberCheck(sDong)) and (MG_NumberCheck(sHo))) then
                  begin
                    HomeInfoLogging('##### 숫자 오류 #####');

                    sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($02) + AnsiChar($01) +
                            MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) +
                            AnsiChar(nPage) + AnsiChar($00);
                    nTotSize:= Length(sSend);
                    sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                    sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                    csHomeInfo_CVNet.Socket.SendText(sSend);
                    HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                    Exit;
                  end;

                  try
                    sTemp:= IntToStr(nPage);
                  except
                    on E: Exception do
                    begin
                      HomeInfoLogging('##### 조회요청 시 데이터 갯수 에러 #####');
                      sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($02) + AnsiChar($01) +
                              MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) +
                              AnsiChar(nPage) + AnsiChar($00);
                      nTotSize:= Length(sSend);
                      sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                      sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                      csHomeInfo_CVNet.Socket.SendText(sSend);
                      HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                      Exit;
                    end;
                  end;

                  try
                    sTemp:= IntToStr(nDataCnt);
                  except
                    on E: Exception do
                    begin
                      HomeInfoLogging('##### 조회요청 시 페이지 에러 #####');
                      sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($02) + AnsiChar($01) +
                              MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) +
                              AnsiChar(nPage) + AnsiChar($00);
                      nTotSize:= Length(sSend);
                      sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                      sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                      csHomeInfo_CVNet.Socket.SendText(sSend);
                      HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                      Exit;
                    end;
                  end;
                  HomeInfoLogging('방문차량 조회요청: ' + sDong + '동, ' + sHo + '호, ' +
                                  IntToStr(nPage) + '페이지, ' + IntToStr(nDataCnt) + '개');

                  try
                    with qry1 do
                    begin
                      Close;
                      SQL.Clear;
                      SQL.Add('Select * from ReserveCar ');
                      SQL.Add('where CompName = :N1 and DeptName = :N2');
                      Parameters.ParamByName('N1').Value:= sDong;
                      Parameters.ParamByName('N2').Value:= sHo;
                      Open;

                      if RecordCount > 0 then
                      begin
                        i:= 0;
                        nTotCnt:= RecordCount;

                        while not Eof do
                        begin
                          Inc(i);

                          RCarInfo[i].nCarIndex:= FieldByName('CarIndex').AsInteger;
                          RCarInfo[i].sCarNo   := FieldByName('CarNo').AsString;
                          RCarInfo[i].sDate    := MG_StrTrim(FieldByName('InDate').AsString, '-');
                          RCarInfo[i].nDateCnt := FieldByName('DateCnt').AsInteger;
                          Next;
                        end;

                        nSendPage:= nTotCnt div nDataCnt;
                        nMod:= nTotCnt mod nDataCnt;

                        if nMod > 0 then
                          Inc(nSendPage);

                        for i := 1 to nSendPage do
                        begin
                          if nSendPage > i then
                          begin
                            sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($02) + AnsiChar($01) +
                                    MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) +
                                    AnsiChar(i) + AnsiChar(nDataCnt);

                            for j := 1 to nDataCnt do
                            begin
                              sSend:= sSend + AnsiChar(RCarInfo[((i-1)*nDataCnt) + j].nCarIndex) +
                                      MG_InsNull(UTF8Encode(RCarInfo[((i-1)*nDataCnt) + j].sCarNo), 16) +
                                      RCarInfo[((i-1)*nDataCnt) + j].sDate +
                                      AnsiChar(RCarInfo[((i-1)*nDataCnt) + j].nDateCnt);
                            end;
                            nTotSize:= Length(sSend);

                            if nTotSize > 255 then
                            begin
                              nSizeHigh:= nTotSize div 256;
                              nSizeLow := nTotSize mod 256;
                              sSend:= STX + AnsiChar($B0) + AnsiChar($D2) +
                                      AnsiChar(nSizeLow) + AnsiChar(nSizeHigh) + sSend;
                              sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                              csHomeInfo_CVNet.Socket.SendText(sSend);
                              HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                            end
                            else
                            begin
                              sSend:= STX + AnsiChar($B0) + AnsiChar($D2) +
                                      AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                              sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                              csHomeInfo_CVNet.Socket.SendText(sSend);
                              HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                            end;
                          end
                          else
                          if nSendPage = i then
                          begin
                            if nMod > 0 then
                            begin
                              sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($02) + AnsiChar($01) +
                                      MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) +
                                      AnsiChar(i) + AnsiChar(nMod);

                              for j := 1 to nMod do
                              begin
                                sSend:= sSend + AnsiChar(RCarInfo[((i-1)*nDataCnt) + j].nCarIndex) +
                                        MG_InsNull(UTF8Encode(RCarInfo[((i-1)*nDataCnt) + j].sCarNo), 16) +
                                        RCarInfo[((i-1)*nDataCnt) + j].sDate +
                                        AnsiChar(RCarInfo[((i-1)*nDataCnt) + j].nDateCnt);
                              end;
                              nTotSize:= Length(sSend);

                              if nTotSize > 255 then
                              begin
                                nSizeHigh:= nTotSize div 256;
                                nSizeLow := nTotSize mod 256;
                                sSend:= STX + AnsiChar($B0) + AnsiChar($D2) +
                                        AnsiChar(nSizeLow) + AnsiChar(nSizeHigh) + sSend;
                                sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                                csHomeInfo_CVNet.Socket.SendText(sSend);
                                HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                              end
                              else
                              begin
                                sSend:= STX + AnsiChar($B0) + AnsiChar($D2) +
                                        AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                                sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                                csHomeInfo_CVNet.Socket.SendText(sSend);
                                HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                              end;
                            end;
                          end;
                        end;
                      end
                      else
                      begin
                        //해당 세대에 등록된 차량이 없으면...
                        sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($02) + AnsiChar($01) +
                                MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) +
                                AnsiChar(nPage) + AnsiChar($00);
                        nTotSize:= Length(sSend);
                        sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                AnsiChar($00) + sSend;
                        sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                        csHomeInfo_CVNet.Socket.SendText(sSend);
                        HomeInfoLogging('세대통보로 조회응답 전송: ' + toHex(sSend));
                      end;
                    end;
                  except
                    on E: Exception do HomeInfoLogging('세대통보로 조회응답 전송시 에러: ' + E.Message);
                  end;
             end;

             3: begin
                  //방문차량 등록,삭제
                  sDong:= IntToStr(StrToInt(Copy(sData, 10, 4)));
                  sHo:= IntToStr(StrToInt(Copy(sData, 14, 4)));
                  nType:= Ord(sData[18]);  //0:삭제,  1:등록

                  if not ((MG_NumberCheck(sDong)) and (MG_NumberCheck(sHo)) and
                          ((nType = 0) or (nType = 1))) then
                  begin
                    HomeInfoLogging('##### 제어요청 시 동(' + sDong + '), 호(' +
                                    sHo + ') 또는 타입(' + IntToStr(nType) + ') 에러 #####');
                    sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                            MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                            AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                    nTotSize:= Length(sSend);
                    sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                    sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                    csHomeInfo_CVNet.Socket.SendText(sSend);
                    HomeInfoLogging('세대통보로 에러 전송: ' + toHex(sSend));
                    Exit;
                  end;

                  case nType of
                    0: begin
                         //삭제
                         nIndex:= Ord(sData[19]);
                         sCarNo:= MG_StrTrim(UTF8Decode(Copy(sData, 20, 16)), AnsiChar($00));
                         sInDate:= Copy(sData, 36, 8);
                         nDate:= Ord(sData[44]);

                         try
                           sChkDate:= StrToDate(MG_StrToStr(sInDate, '####-##-##'));
                         except
                           on E: Exception do
                           begin
                             HomeInfoLogging('##### 방문차량 삭제 요청 시 날짜 에러 #####');
                             sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                     MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                     AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                             nTotSize:= Length(sSend);
                             sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                             sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                             csHomeInfo_CVNet.Socket.SendText(sSend);
                             HomeInfoLogging('세대통보로 삭제에러 전송: ' + toHex(sSend));
                             Exit;
                           end;
                         end;

                         if (Length(sCarNo) < 8) then
                         begin
                           HomeInfoLogging('##### 방문차량 삭제 요청 시 차량번호 에러 #####');
                           sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                   MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                   AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                           nTotSize:= Length(sSend);
                           sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                           sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                           csHomeInfo_CVNet.Socket.SendText(sSend);
                           HomeInfoLogging('세대통보로 삭제에러 전송: ' + toHex(sSend));
                           Exit;
                         end;

                         try
                           with qry1 do
                           begin
                             //2016-07-28 16시58분 통화시
                             //CVNet 김형국 차장 요청
                             //스마트폰 앱에서 Index가 0으로 들어온다...
                             //따라서 Index가 0으로 들어오면 Index와 상관없이
                             //해당 차량번호의 자료를 삭제한다...

                             if nIndex <> 0 then
                             begin
                               Close;
                               SQL.Clear;
                               SQL.Add('Delete from ReserveCar ');
                               SQL.Add('where InDate = :N1 and CarNo = :N2 and CarIndex = :N3');
                               Parameters.ParamByName('N1').Value:= MG_StrToStr(sInDate, '####-##-##');
                               Parameters.ParamByName('N2').Value:= sCarNo;
                               Parameters.ParamByName('N3').Value:= nIndex;
                               ExecSQL;
                             end
                             else
                             begin
                               Close;
                               SQL.Clear;
                               SQL.Add('Delete from ReserveCar ');
                               SQL.Add('where InDate = :N1 and CarNo = :N2');
                               Parameters.ParamByName('N1').Value:= MG_StrToStr(sInDate, '####-##-##');
                               Parameters.ParamByName('N2').Value:= sCarNo;
                               ExecSQL;
                             end;
                           end;

                           sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                   MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                   AnsiChar(nIndex) + AnsiChar($00) + AnsiChar($03);
                           nTotSize:= Length(sSend);
                           sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                   AnsiChar($00) + sSend;
                           sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                           csHomeInfo_CVNet.Socket.SendText(sSend);
                           HomeInfoLogging('세대통보로 삭제성공 전송: ' + toHex(sSend));
                         except
                           on E: Exception do
                           begin
                             HomeInfoLogging('방문차량 삭제 시 에러: ' + E.Message);

                             sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                     MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                     AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                             nTotSize:= Length(sSend);
                             sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                     AnsiChar($00) + sSend;
                             sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                             csHomeInfo_CVNet.Socket.SendText(sSend);
                             HomeInfoLogging('세대통보로 삭제에러 전송: ' + toHex(sSend));
                           end;
                         end;
                    end;

                    1: begin
                         //등록
                         sCarNo:= MG_StrTrim(UTF8Decode(Copy(sData, 19, 16)), AnsiChar($00));
                         sInDate:= MG_StrToStr(Copy(sData, 35, 8), '####-##-##');
                         nDate:= Ord(sData[43]);

                         try
                           sChkDate:= StrToDate(sInDate);
                         except
                           on E: Exception do
                           begin
                             HomeInfoLogging('##### 방문차량 등록 요청 시 날짜 에러 #####');
                             sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                     MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                     AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                             nTotSize:= Length(sSend);
                             sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                             sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                             csHomeInfo_CVNet.Socket.SendText(sSend);
                             HomeInfoLogging('세대통보로 등록에러 전송: ' + toHex(sSend));
                             Exit;
                           end;
                         end;

                         if (Length(sCarNo) < 8) or ((nDate <> 1) and (nDate <> 2)) or
                            (sInDate < FormatDateTime('YYYY-MM-DD', Now)) then
                         begin
                           HomeInfoLogging('##### 방문차량 등록 요청 시 차량번호(' + sCarNo +
                                           '), 날짜(' + sInDate + ') 또는 기간(' + IntToStr(nDate) + ') 에러 #####');
                           sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                   MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                   AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                           nTotSize:= Length(sSend);
                           sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) + AnsiChar($00) + sSend;
                           sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                           csHomeInfo_CVNet.Socket.SendText(sSend);
                           HomeInfoLogging('세대통보로 등록에러 전송: ' + toHex(sSend));
                           Exit;
                         end;
                         HomeInfoLogging('방문차량 등록요청: ' + sCarNo + ', ' + sInDate + ', ' + IntToStr(nDate));

                         if nDate = 1 then
                           sOutDate:= sInDate
                         else
                         if nDate = 2 then
                           sOutDate:= MG_AddDate(sInDate, 1);

                         try
                           with qry1 do
                           begin
                             Close;
                             SQL.Clear;
                             SQL.Add('Select * from CustInfo ');
                             SQL.Add('where CarNo = :N1');
                             Parameters.ParamByName('N1').Value:= sCarNo;
                             Open;

                             if RecordCount > 0 then
                             begin
                               sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                       MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                       AnsiChar($00) + AnsiChar($01) + AnsiChar($01);
                               nTotSize:= Length(sSend);
                               sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                       AnsiChar($00) + sSend;
                               sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                               csHomeInfo_CVNet.Socket.SendText(sSend);
                               HomeInfoLogging('세대통보로 등록에러 전송(세대등록차량): ' + toHex(sSend));
                             end
                             else
                             begin
                               Close;
                               SQL.Clear;
                               SQL.Add('Select * from ReserveCar ');
                               SQL.Add('Where CarNo = :N1 and ');
                               SQL.Add('((InDate between :N2 and :N3) or (OutDate between :N2 and :N3))');
                               Parameters.ParamByName('N1').Value:= sCarNo;
                               Parameters.ParamByName('N2').Value:= sInDate;
                               Parameters.ParamByName('N3').Value:= sOutDate;
                               Open;

                               if RecordCount > 0 then
                               begin
                                 sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                         MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                         AnsiChar($00) + AnsiChar($01) + AnsiChar($02);
                                 nTotSize:= Length(sSend);
                                 sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                         AnsiChar($00) + sSend;
                                 sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                                 csHomeInfo_CVNet.Socket.SendText(sSend);
                                 HomeInfoLogging('세대통보로 등록에러 전송(방문등록차량): ' + toHex(sSend));
                               end
                               else
                               begin
                                 //등록 후 결과 전송
                                 Close;
                                 SQL.Clear;
                                 SQL.Add('Select * from ReserveCar ');
                                 SQL.Add('Where CompName = :N1 and DeptName = :N2');
                                 Parameters.ParamByName('N1').Value:= sDong;
                                 Parameters.ParamByName('N2').Value:= sHo;
                                 Open;

                                 if RecordCount > 0 then
                                   nIndex:= RecordCount + 1
                                 else
                                   nIndex:= 1;

                                 Close;
                                 SQL.Clear;
                                 SQL.Add('Insert Into ReserveCar ');
                                 SQL.Add('(ParkNo, InDate, OutDate, CarNo, CompName, DeptName, ');
                                 SQL.Add('CarIndex, DateCnt) ');
                                 SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
                                 Parameters.ParamByName('N1').Value:= 1;
                                 Parameters.ParamByName('N2').Value:= sInDate;
                                 Parameters.ParamByName('N3').Value:= sOutDate;
                                 Parameters.ParamByName('N4').Value:= sCarNo;
                                 Parameters.ParamByName('N5').Value:= sDong;
                                 Parameters.ParamByName('N6').Value:= sHo;
                                 Parameters.ParamByName('N7').Value:= nIndex;
                                 Parameters.ParamByName('N8').Value:= nDate;
                                 ExecSQL;

                                 sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                         MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                         AnsiChar(nIndex) + AnsiChar($00) + AnsiChar($00);
                                 nTotSize:= Length(sSend);
                                 sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                         AnsiChar($00) + sSend;
                                 sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                                 csHomeInfo_CVNet.Socket.SendText(sSend);
                                 HomeInfoLogging('세대통보로 등록성공 전송: ' + toHex(sSend));
                               end;
                             end;
                           end;
                         except
                           on E: Exception do
                           begin
                             HomeInfoLogging('방문차량 등록 시 에러: ' + E.Message);

                             sSend:= AnsiChar($05) + AnsiChar($56) + AnsiChar($04) + AnsiChar($01) +
                                     MG_InsZero(sDong, 4) + MG_InsZero(sHo, 4) + AnsiChar(nType) +
                                     AnsiChar(nIndex) + AnsiChar($01) + AnsiChar($03);
                             nTotSize:= Length(sSend);
                             sSend:= STX + AnsiChar($B0) + AnsiChar($D2) + AnsiChar(nTotSize) +
                                     AnsiChar($00) + sSend;
                             sSend:= sSend + BuildCVnetCRC(sSend) + ETX;
                             csHomeInfo_CVNet.Socket.SendText(sSend);
                             HomeInfoLogging('세대통보로 등록에러 전송: ' + toHex(sSend));
                           end;
                         end;
                    end;
                  end;
             end;
           end;
     end;

    145: begin
           //HeartBeat 응답...
           if Ord(sData[8]) = 2 then
           begin
             bHeartBeat:= True;
             HomeInfoLogging('세대통보 서버에서 HeartBeat 응답 수신');
           end;
    end;

    147: begin
           case Ord(sData[8]) of
             5: begin
                  //로그인요청
                  sSend:= MakeCVnetLogin;
                  csHomeInfo_CVNet.Socket.SendText(sSend);
                  HomeInfoLogging('세대통보로 로그인인증요청 전송: ' + toHex(sSend));
             end;

             4: begin
                  //로그인응답
                  if Ord(sData[10]) = 1 then
                  begin
                    tHeartBeat.Enabled:= True;
                    HomeInfoLogging('세대통보 서버에서 인증성공 수신');
                  end;
             end;
           end;
    end;
  end;
  except
    on E: Exception do HomeInfoLogging('CVnetProc: ' + aString(E.Message));
  end;
end;


function TfrmMain.DateToString(sDateTime: String): String;
var
  nLength : Integer;
  i : Integer;
begin
  sDateTime := StringReplace(sDateTime, ':', '',[rfReplaceAll]);
  sDateTime := StringReplace(sDateTime, '-', '',[rfReplaceAll]);
  sDateTime := StringReplace(sDateTime, ' ', '',[rfReplaceAll]);
  sDateTime := Copy(sDateTime, 1, 12);
  nLength := length(sDateTime);
  if nLength <> 12 then
  begin
    for i := 0 to 11-nLength do
    begin
     sDateTime := sDateTime + '0';
    end
  end;

  Result := sDateTime;
end;

procedure TfrmMain.DBAdvGrid1Click(Sender: TObject);
begin
  if dmTables.qrySCSearch.RecordCount > 0 then
  begin
    sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
    btnSCIn.Enabled:= True;
    btnSCOut.Enabled := True;
  end
  else
    sManualSCCarNo := '';
end;

procedure TfrmMain.dgManualClick(Sender: TObject);
begin
  if dmTables.qrySCSearch.RecordCount > 0 then
  begin
    sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
    btnManualSCIn.Enabled:= True;
    btnManualSCOut.Enabled := True;
  end
  else
  begin
    sManualSCCarNo := '';
    btnManualSCIn.Enabled:= False;
    btnManualSCOut.Enabled := False;
  end;
end;

// 전광판 문구 표출
procedure TfrmMain.DspProc(nIO, nType: Byte; sData, sDspIP: aString);
var
  i: Byte;
  sSend, sOriCarNo: aString;
begin
  try
    if nDisplaySize = 0 then    //2단 4열
    begin
      sOriCarNo := '';
      sOriCarNo :=  MG_ReplaceStr(Copy(SData, 13, 12), ' ', '');
      sOriCarNo := Copy(sOriCarNo, Length(sOriCarNo) -3, 4); //차량번호 뒤에서 4자리
      sOriCarNo := MG_Center(sOriCarNo, 8);
      //ini파일에서 정기차량, 일반차량 문구
      if Copy(sData,0,12) = ' 미등록차량 ' then
      begin
//        sData := sIONDsp + Copy(SData, 13, 12)   ;
        sData := s4IONDsp + sOriCarNo;
      end
      else if Copy(sData,0,12) = '  등록차량  ' then
      begin
//        sData := sIOSDsp + Copy(SData, 13, 12);
        sData := s4IOSDsp + sOriCarNo;
      end
      else
      begin
        sData := MG_Left(sData, 8) + sOriCarNo;
      end;

      case nType of
        1: sSend := MakeDSPData(AnsiChar($54), EMDSP1, SCCOLOR24, MG_Left(sData, 16));
        2: sSend := MakeDSPData(AnsiChar($54), EMDSP1, NOCOLOR24, MG_Left(sData, 16));
        3: sSend := MakeDSPData(AnsiChar($54), EMDSP0, YOCOLOR24, MG_Left(sData, 16));
        4: sSend := MakeDSPData(AnsiChar($54), EMDSP1, YOCOLOR24, MG_Left(sData, 16));
      end;
    end
    else
    begin
      //ini파일에서 정기차량, 일반차량 문구
      if Copy(sData,0,12) = ' 미등록차량 ' then
      begin
        sData := sIONDsp + Copy(SData, 13, 12);
      end
      else if Copy(sData,0,12) = '  등록차량  ' then
      begin
        sData := sIOSDsp + Copy(SData, 13, 12);
      end
      else
      begin
        sData := sData + Copy(SData, 13, 12);
      end;

      case nType of
        1: sSend := MakeDSPData(AnsiChar($54), EMDSP1, SCCOLOR, MG_Left(sData, 24));
        2: sSend := MakeDSPData(AnsiChar($54), EMDSP1, NOCOLOR, MG_Left(sData, 24));
        3: sSend := MakeDSPData(AnsiChar($54), EMDSP0, YOCOLOR, MG_Left(sData, 24));
        4: sSend := MakeDSPData(AnsiChar($54), EMDSP1, YOCOLOR, MG_Left(sData, 24));
      end;
    end;

    if nIO = 1 then           //입구
    begin
      for i := 1 to 4 do
      begin
        with frmMain do
        begin
//          ExceptLogging('sDspIP(' + wString(sDspIP) + ')  <==>' + TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host);

          sDspIP :=  StringReplace(sDspIP, ' ', '',  [rfReplaceAll, rfIgnoreCase]);

          if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then
          begin

            if is_ping(sDspIP) then
            begin
              { TODO : 전광판 입차 }

              if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active and
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.Connected then
              begin
                try
                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend);
                  ExceptLogging('전광판(' + sDspIP + ') : ' + sData);
                except
                  TClientSocket(FindComponent('csInDsp' + IntToStr(i ))).Socket.Close;
                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active := True;
                  TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend);
                  ExceptLogging('전광판예외발생(' + sDspIP + ') : ' + sData);
                end;
              end
              else
              begin

                ExceptLogging('전광판(' + sDspIP + ') 네트워크 끊김 : ' + sData);
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.Close;
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active := True;
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend);
              end;
            end
            else
              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
          end; // if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host = wString(sDspIP) then begin

        end;  // with frmMain do begin
      end;
    end
    else if nIO = 2 then      //출구
    begin
      for i := 1 to 4 do
      begin
        with frmMain do
        begin

          if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host = wString(sDspIP) then
          begin
            if is_ping(sDspIP) then
            begin
             { TODO : 전광판 출차 }
              if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active and
                 TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Connected then
              begin
                 try
                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
                    ExceptLogging('전광판(' + sDspIP + ') : ' + sData);
                 except
                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Close;
                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
                    TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
                    ExceptLogging('전광판예외발생(' + sDspIP + ') : ' + sData);
                 end;
              end
              else
              begin
                ExceptLogging('전광판(' + sDspIP + ') 네트워크 끊김 : ' + sData);
                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.Close;
                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
              end;
            end
            else
              ExceptLogging('전광판(' + sDspIP + ') 네트워크 에러');
          end;
        end;
      end;
    end;
  except
    on E: Exception do ExceptLogging('DspProc: ' + aString(E.Message));
  end;
end;


procedure TfrmMain.edtInCarNo1KeyPress(Sender: TObject; var Key: Char);
var
  sIn, sResult, sTime, sTemp, sInputCarNo: aString;
  sDspIP: aString;
  i: Byte;
begin
  try
    if Key = #13 then
    begin
      if edtInCarNo1.Text = '' then
      begin
        ShowMessage('차량번호를 입력하여주세요!');
        edtInCarNo1.SetFocus;
        Exit;
      end;

      with dmTables.qrySCSearch do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr('%' + Trim(edtInCarNo1.Text) + '%'));
        Open;

        if RecordCount > 0 then
        begin
          First;
          sInputCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
          sResult := RecvLprProc(sTempFile1, sInputCarNo, '', '', FormatDateTime('YYYY-MM-DD HH:NN:SS', Now),
                                 csInLpr1.Tag, 1, 2, 0, csInDsp1.Host, csInLpr1, True, 1, 0);
          GridData(1, 1, sResult);
        end
        else
        begin
          sInputCarNo := '';
          ShowMessage('미등록차량입니다.');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.edtInCarNo1KeyPress: ' + E.Message);
  end;
end;

procedure TfrmMain.edtManualProcCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnManualSeekClick(Self);
end;

procedure TfrmMain.edtOutCarNo1KeyPress(Sender: TObject; var Key: Char);
var
  sIn, sResult, sTime, sTemp, sInputCarNo: aString;
  sDspIP: aString;
  i: Byte;
begin
  try
    if Key = #13 then
    begin
      if edtOutCarNo1.Text = '' then
      begin
        ShowMessage('차량번호를 입력하여주세요!');
        edtOutCarNo1.SetFocus;
        Exit;
      end;

      with dmTables.qrySCSearch do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr('%' + Trim(edtOutCarNo1.Text) + '%'));
        Open;

        if RecordCount > 0 then
        begin
          First;
          sInputCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
          sResult := RecvLprProc(sTempFile4, sInputCarNo, '', '', FormatDateTime('YYYY-MM-DD HH:NN:SS', Now),
                                 csOutLpr1.Tag, 2, 2, 0, csOutDsp1.Host, csOutLpr1, True, 1, 0);
          GridData(2, 1, sResult);
        end
        else
        begin
          sInputCarNo := '';
          ShowMessage('미등록차량입니다.');
        end;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.edtOutCarNo1KeyPress: ' + E.Message);
  end;
end;

procedure TfrmMain.edtSCCarNoKeyPress(Sender: TObject; var Key: Char);
begin
  if Key = #13 then
    btnSCClick(Self);
end;

function TfrmMain.EZ_CheckVisit(nCarNo: String): Boolean;
begin
  with dmTables.qryVisit do
  begin
    Close;
    SQL.Clear;
    SQL.Add('select * from VisitInfo_EZ');
    SQL.Add(' where CarNo = :N1');
    Parameters.ParamByName('N1').Value := nCarNo;
    Open;

    if RecordCount > 0 then
    begin
       // 홈넷 차량번호가 4자리 이상이면 차량번호 뒷자리 4자리 자르기
      if Length(nCarNo) >= 4 then
      begin
        sHomeInfo_ShortCarNo:= Copy(nCarNo, Length(nCarNo)-3, 4);

        // 뒷자리 4자리 자른 차량 번호에 숫자가 없으면 ???
        if not MG_NumberCheck(sHomeInfo_ShortCarNo) then
          sHomeInfo_ShortCarNo:= '0000';
      end
      else
        sHomeInfo_ShortCarNo:= '0000';
        sHomeInfo_Dong := FieldByName('Dong').AsString;        // 홈넷 동
        sHomeInfo_Ho   := FieldByName('Ho').AsString;          // 홈넷 호
        Result := True;
    end
    else
    begin
      Result := False
    end;
  end
end;

function TfrmMain.EZ_VisitAddProcess(sCarNo, sTime, sDongHo, sInout : string): Integer;
var
  sDong, sHo, sNowDatetime : String;
begin
  try
    sDong := Copy(sDongHo, 0, pos('&', sDongHo) -1);
    sHo := Copy(sDongHo, pos('&', sDongHo)+1, Length(sDongho) - Length(sDong));
    sNowDatetime := FormatDateTime('YYYYMMDDHHMMSS', now);

    with dmTables.qryVisitInsert do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select Count(*) as cnt from visitinfo_EZ where dong = :pDong and ho = :pHo');
      Parameters.ParamByName('pDong').Value := sDong;
      Parameters.ParamByName('pHo').Value   := sHo;
      Open;
      if FieldByName('cnt').AsInteger >= 10 then //10개 초과할 수 없음
      begin
        HomeInfoLogging('EZ_VisitAddProcess : 방문차량등록 실패 10대 초과 동:' + sDong + ' 호:' + sHo);
        Result := 1;
        exit;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Insert into VisitInfo_EZ (Dong, Ho, CarNo, StartDatetime, Inout, RecordTime) '
              +'values (:pDong, :pHo, :pCarNo, :pStartDateTime, :pInout, :pRecordTime)');
      Parameters.ParamByName('pDong').Value := sDong;
      Parameters.ParamByName('pHo').Value   := sHo;
      Parameters.ParamByName('pCarNo').Value:= sCarNo;
      Parameters.ParamByName('pStartDateTime').Value:= sTime;
      Parameters.ParamByName('pInout').Value:= sInout;
      Parameters.ParamByName('pRecordTime').Value:= sNowDatetime;
      ExecSQL;
      HomeInfoLogging('EZ_VisitAddProcess : 방문차량등록  동:' + sDong + ' 호:' + sHo +
        ' 차량번호 :' + sCarNo + ' 일자 :' + sTime + ' 입출 :' + sInout);
    end;
    Result := 0;
  except
    on E: Exception do
    begin
      ExceptLogging('EZ_VisitAddProcess: ' + aString(E.Message));
      Result := 1;
    end;
  end;
end;

function TfrmMain.EZ_VisitDelProcess(saDelCarNo : array of string;
  sDongHo: string): Integer;
var
  sDong, sHo : String;
  nRoop : Integer;
begin
  try
    sDong := Copy(sDongHo, 0, pos('&', sDongHo) - 1);
    sHo := Copy(sDongHo, pos('&', sDongHo)+1, Length(sDongho) - Length(sDong));
    nRoop := 0;
    with dmTables.qryVisitDelete do
    begin
      while(true) do
      begin
        Close;
        SQL.Clear;

        if nRoop >= 10 then
        begin
          Result := 0;
          break;
        end;

        if saDelCarNo[nRoop] = '' then         //삭제완료
        begin
          Result := 0;
          break;
        end;

        SQL.Add('delete from visitinfo_EZ where dong = :pDong and ho = :pHo and ' +
                'CarNo = :pCarNo');
        Parameters.ParamByName('pDong').Value   := sDong;
        Parameters.ParamByName('pHo').Value     := sHo;
        Parameters.ParamByName('pCarNo').Value  := saDelCarNo[nRoop];
        ExecSQL;
        HomeInfoLogging('EZ_VisitDelProcess : 방문차량삭제 동 : ' + sDong + ' 호 : ' + sHo +
                        ' 차량번호 : ' + saDelCarNo[nRoop]);
        inc(nRoop);
      end;
    end;
  except
    on E: Exception do
    begin
      ExceptLogging('EZ_VisitAddProcess: ' + aString(E.Message));
      Result := 1;
    end;
  end;
end;

function TfrmMain.EZ_VisitListProcess(sDongHo, sParam: string): string;
var
  sDong, sHo, sSendData, sFullCarNo, sStartTime, sInout, sParamStart, sParamEnd : string;
  i : Integer;
//type
//  R_SCWait = Record
//    sSCFile1: AnsiString;
//    sSCCarNo1: AnsiString;
//    sSCFile2: AnsiString;
//    sSCCarNo2: AnsiString;
//    sSCIOTime: AnsiString;
//    nSCLprNo: Byte;
//    nSCInOut: Byte;
//    nSCRecog1: Byte;
//    nSCRecog2: Byte;
//    nSCLprCnt: Byte;
//    sSCDspIP: AnsiString;
//    csSCLPR: TClientSocket;
//    bBarOpen: Boolean;
//  end;

begin
  try
    sDong := Copy(sDongHo, 0, pos('&', sDongHo) - 1);
    sHo := Copy(sDongHo, pos('&', sDongHo)+1, Length(sDongho) - Length(sDong));

    sParamStart := Copy(sParam, 0, pos('&', sParam) -1 );
    sParamEnd :=Copy(sParam, pos('&', sParam)+1, Length(sParam) - Length(sParamStart));

    with dmTables.qryVisitList do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select * from Visitinfo_EZ ' +
              'where dong = :pdong and ho = :pho');
      Parameters.ParamByName('pdong').Value := sDong;
      Parameters.ParamByName('pho').Value   := sHo;
      open;
      if RecordCount > 0 then
      begin
        i := 1;
        sSendData := '#total=' + IntToStr(RecordCount);
        while RecordCount >= i do
        begin
          sFullCarNo := FieldByName('CarNo').Value;
          sInout     := FieldByName('Inout').Value;
          sStartTime := FieldByName('StartDatetime').Value;

          sSendData := sSendData + '#no=' + IntToStr(i) + '#inout=' + sInout +
                        '#time=' + sStartTime + '#carno=' + sFullCarNo;
          Inc(i);
          if i > StrToInt(sParamEnd) then
          begin
            break;
          end;
          Next;
        end;
      end
      else
      begin
        sSendData := '#total=0'
      end;
    end;
    result := sSendData;
  except
    on E: Exception do
    begin
      ExceptLogging('EZ_VisitListProcess: ' + aString(E.Message));
      result := '#total=0';
    end;
  end;

end;

// 일반차량 출차처리
procedure TfrmMain.NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; nListCnt: Byte);
var
  sNow, sInCarNo, sInTKNo, sInDate, sInTime, sParking, sInFile, sImgFile1,
    sImgFile2, sLocalFile, sTime, sDir, sYogum, sTemp: aString;
  nDay, nHour, nMin, nOutCnt: Cardinal;
  nInUnitNo, i: Word;
  hr: HRESULT;
begin
  // 일반차량 출차처리...
  try
  try
    bNCOutProcWait := True;
    nowLpr := csLPR;
    sNow:= FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    // 일반차량 시간대별 출입현황 조회
    with dmTables.qryNormalOut2 do
    begin
      // 일반차량 입출차 자료 조회, 미출차된 자료 최신순으로 조회
      Close;
      SQL.Clear;
      SQL.Add('Select * from IONData where OutChk = :N1 and ');
      SQL.Add('((InCarNo1 = :N2) or (InCarNo2 = :N3)) ');
      SQL.Add('Order By ProcDate Desc, ProcTime Desc');
      Parameters.ParamByName('N1').Value := 0;
      Parameters.ParamByName('N2').Value := sLprCarNo1;
      Parameters.ParamByName('N3').Value := sLprCarNo1;
      Open;

      // 입출차 데이터 있으면
      if RecordCount > 0 then
      begin
        nInUnitNo := FieldByName('UnitNo').AsInteger;
        sInTKNo := FieldByName('TKNo').AsString;

        // 정상인식이면
        if nLprRecog1 = 1 then
        begin
          sInCarNo := sLprCarNo1;
          sInFile := FieldByName('InImage1').AsString;
          sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
          sNowInCarNo := sInCarNo;
          sNowInFile := sInFile;
        end
        else
        begin
          sInCarNo := sLprCarNo1;
          sInFile := FieldByName('InImage1').AsString;
          sTime := Copy(sInFile, Pos('_', sInFile) + 1, 14);
          sNowInCarNo := sInCarNo;
          sNowInFile := sInFile;
        end;
        sInDate := FieldByName('ProcDate').AsString;
        sInTime := FieldByName('ProcTime').AsString;
        sNowInDate := sInDate;
        sNowInTime := sInTime;

        // 입출차 데이터 있으면 업데이트 처리
        if not bMonitoring  then
        begin
          Close;
          SQL.Clear;
          SQL.Add('Update IONData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, OutChk = :N4, ');
          SQL.Add('OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N7, OutCarNo2 = :N8, ');
          SQL.Add('OutRecog1 = :N9, OutRecog2 = :N10, Reserve1 = :N16 ');
          SQL.Add('where ParkNo = :N11 and UnitNo = :N12 and ProcDate = :N13 and ProcTime = :N14 and TKNo = :N15');
          Parameters.ParamByName('N1').Value := nLprNo;
          Parameters.ParamByName('N2').Value := Copy(sNow, 1, 10);
          Parameters.ParamByName('N3').Value := Copy(sNow, 12, 8);
          Parameters.ParamByName('N4').Value := 4;
          Parameters.ParamByName('N5').Value := sLprFile1;
          Parameters.ParamByName('N6').Value := sLprCarNo1;
          Parameters.ParamByName('N7').Value := sLprFile2;
          Parameters.ParamByName('N8').Value := sLprCarNo2;
          Parameters.ParamByName('N9').Value := nLprRecog1;
          Parameters.ParamByName('N10').Value := nLprRecog2;
          Parameters.ParamByName('N11').Value := nCurrParkNo;
          Parameters.ParamByName('N12').Value := nInUnitNo;
          Parameters.ParamByName('N13').Value := sInDate;
          Parameters.ParamByName('N14').Value := sInTime;
          Parameters.ParamByName('N15').Value := sInTKNo;
          Parameters.ParamByName('N16').Value := '';
          ExecSQL;
        end;
      end
      else
      begin
        // 입출차 데이터 없으면 데이터 등록
        sInTKNo:= MG_InsZero(IntToStr(GetTickCount), 10);
        if not bMonitoring  then
        begin
          Close;
          SQL.Clear;
          Close;
          SQL.Clear;
          SQL.Add('Insert Into IONData ');
          SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, InImage1, InCarNo1, ');
          SQL.Add('InImage2, InCarNo2, Status, InRecog1, InRecog2, OutUnitNo, OutDate, OutTime, OutChk, ');
          SQL.Add('OutImage1, OutCarNo1, OutImage2, OutCarNo2, OutRecog1, OutRecog2) ');
          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, ');
          SQL.Add(':N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23, :N24 ) ');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nLprNo;
          Parameters.ParamByName('N3').Value := Copy(sNow, 1, 10);
          Parameters.ParamByName('N4').Value := Copy(sNow, 12, 8);
          Parameters.ParamByName('N5').Value := sInTKNo;
          Parameters.ParamByName('N6').Value := 1;
          Parameters.ParamByName('N7').Value := 1;
          Parameters.ParamByName('N8').Value := '';
          Parameters.ParamByName('N9').Value := '';
          Parameters.ParamByName('N10').Value:= '';
          Parameters.ParamByName('N11').Value:= '';
          Parameters.ParamByName('N12').Value:= 1;
          Parameters.ParamByName('N13').Value:= 0;
          Parameters.ParamByName('N14').Value:= 0;
          Parameters.ParamByName('N15').Value:= nLprNo;
          Parameters.ParamByName('N16').Value:= Copy(sNow, 1, 10);
          Parameters.ParamByName('N17').Value:= Copy(sNow, 12, 8);
          Parameters.ParamByName('N18').Value:= 1;
          Parameters.ParamByName('N19').Value:= sLprFile1;
          Parameters.ParamByName('N20').Value:= sLprCarNo1;
          Parameters.ParamByName('N21').Value:= '';
          Parameters.ParamByName('N22').Value:= '';
          Parameters.ParamByName('N23').Value:= nLprRecog1;
          Parameters.ParamByName('N24').Value:= nLprRecog2;
          ExecSQL;
        end;
      end;
      if not bMonitoring then
      begin
        OutOpen(csLPR);
      end;

    end;
    NormalLogging('미등록차량 출차: ' + sLprCarNo1 + ' - ' + sLprFile1);

//    try
//      if FileExists(sLprFile1) then
//      begin
//        with frmMain do
//        begin
//          TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
//        end;
//      end
//      else
//      begin
//        with frmMain do
//        begin
//          TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
//        end;
//        ExceptLogging('File 없음: ' + sLprFile1);
//      end;
//    except
//      on E: Exception do
//        ExceptLogging('이미지 로드 에러(NormatOut): ' + aString(E.Message));
//    end;

    with frmMain do
    begin
      // 화면에 치량번호 인식상태 => 일반, 차량번호 표시
      TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
      TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '일반';
      TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
      TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
      TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
      TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
      TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
      TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
      TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
    end;
    DspProc(2, 2, ' 미등록차량 ' + MG_Left(sLprCarNo1, 12), sDspIP);
    NGridData('2' + sLprCarNo1 + '^' + Copy(sNow, 1, 10) + ' ' + Copy(sNow, 12, 8) + '^'+ ''+'^'+TLabel(FindComponent('lbOut' + IntToStr(nListCnt))).Caption);
    //이미지 로드 맨뒤로
    try
      if FileExists(sLprFile1) then
      begin
        with frmMain do
        begin
          TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
        end;
      end
      else
      begin
        with frmMain do
        begin
          TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
        end;
        ExceptLogging('File 없음: ' + sLprFile1);
      end;
    except
      on E: Exception do
        ExceptLogging('이미지 로드 에러(NormatOut): ' + aString(E.Message));
    end;
  except
    on E: Exception do
      ExceptLogging('NormalOut: ' + aString(E.Message));
  end;

  finally
    bNCOutProcWait := False;
  end;
end;


// 동일한 차량번호로 입차된 기존 미출차차량은 미출차정리로 처리
procedure TfrmMain.MichulProc(sCarNo, sProcDate, sProcTime: AnsiString);
begin
  if (sCarNo <> '') and (sCarNo <> '0000000000') then
  begin
    try
      with dmTables.qryMichulProc do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Update IONData Set OutChk = :N1, OutDate = :N2, OutTime = :N3 ');
        SQL.Add('where ((InCarNo1 = :N4) or (InCarNo2 = :N5)) and OutChk = 0');
        Parameters.ParamByName('N1').Value := 7;
        Parameters.ParamByName('N2').Value := sProcDate;
        Parameters.ParamByName('N3').Value := sProcTime;
        Parameters.ParamByName('N4').Value := sCarNo;
        Parameters.ParamByName('N5').Value := sCarNo;
        ExecSQL;
      end;
    except
      on E: Exception do
        ExceptLogging('TfrmMainNew.MichulProc: ' + aString(E.Message));
    end;
  end;
end;

// 일반차량 입출차 처리, 출차 -> [NormalOut]
procedure TfrmMain.NormalProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte;
  nBackData: Integer);
var
  sTKNo, sLprDate, sLprTime, sSend, sTemp: aString;
  nInCnt: Word;
  inValue: String;
  frmMessage: TfrmMessage;
  bVisitor : Boolean;              //cvnet 방문자 유무 true 방문, false 일반
  inDong, inHo : String;
  bCheckVisit : Boolean; //Added Woo.YH 방문차량 확인     (True 방문차량, false 일반차량)
//  sTKNo, sLprDate, sLprTime, sSend, sTemp: aString;
//  nInCnt: Word;
begin
  try
    ExceptLogging('일반차량: ' + sLprCarNo1 + ', ' + sLprCarNo2);
    sLprDate := Copy(sIOTime, 1, 10);
    sLprTime := Copy(sIOTime, 12, 8);
    if nLprInOut = 1 then begin
      try
        bVisitor := false;
        bNCInProcWait := True;
        bCheckVisit := false;

        // 동일한 차량번호로 입차된 기존 미출차차량은 미출차정리로 처리...
        if not bMonitoring  then
        begin
          if (sLprCarNo1 <> '') and (sLprCarNo1 <> '0000000000') then
            MichulProc(sLprCarNo1, sLprDate, sLprTime);

          if (sLprCarNo2 <> '') and (sLprCarNo2 <> '0000000000') then
            MichulProc(sLprCarNo2, sLprDate, sLprTime);
        end;

        sNowCarNo := sLprCarNo1;

        if nHomeVisit = 1 then            //방문자 사용
        begin
          if nHomeInfo_Comp = 1 then      //현대통신
          begin
            if sLprCarNo1 <> '' then
            begin
              bCheckVisit:= HD_CheckVisit(sLprCarNo1);
            end
            else if sLprCarNo2 <> '' then
            begin
              bCheckVisit:= HD_CheckVisit(sLprCarNo2);
            end;
          end
          else if nHomeInfo_Comp = 3 then      //아이콘트롤스
          begin
            if sLprCarNo1 <> '' then
            begin
              bCheckVisit:= ICon_CheckVisit(sLprCarNo1);
            end
            else if sLprCarNo2 <> '' then
            begin
              bCheckVisit:= ICon_CheckVisit(sLprCarNo2);
            end;
          end
          else if nHomeInfo_Comp = 6 then      //이지빌
          begin
            if sLprCarNo1 <> '' then
            begin
              bCheckVisit:= EZ_CheckVisit(sLprCarNo1);
            end
            else if sLprCarNo2 <> '' then
            begin
              bCheckVisit:= EZ_CheckVisit(sLprCarNo2);
            end;
          end;
        end;

        if bCheckVisit = True then
        begin
          ExceptLogging('방문차량 입차: ' + sLprCarNo1 + ' - ' + sLprFile1);

        end
        else
          NormalLogging('미등록차량 입차: ' + sLprCarNo1 + ' - ' + sLprFile1);
      except
        on E: Exception do
        begin
          ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
          bNCInProcWait := false;
        end;
      end;

      try
        //Added Woo.YH 블랙리스트 차량 입출기록
        with dmTables.qryIOBData do
        begin
          Close;
          SQL.Clear;
          SQL.Add('select * from BlackList where ParkNo = :N1 and BCarNo = :N2');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := sLprCarNo1;
          open;
          if RecordCount > 0 then
          begin
            with frmMain do
            begin
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '블랙리스트';
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
              TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
              TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
              TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
            end;
            DspProc(1, 2, '출입제한차량' + MG_Left(sLprCarNo1, 12), sDspIP);
            ExceptLogging('NormalProc : 블랙리스트 차량 입차시도 : ' + sLprCarNo1);

            mpBlacklist.Rewind;
            mpBlacklist.Play;
            mpBlacklist.Notify := True;
            lblBlackListCarNo2.Caption := sLprCarNo1;
            tmrBlack.Enabled := False;
            tmrBlack.Interval:= nBAlarmTime * 1000;
            tmrBlack.Enabled := True;
            pnlBlack.Visible := True;

            if not bMonitoring  then
            begin
              with dmTables.qryInsertBlackList do
              begin
                Close;
                SQL.Clear;
                SQL.Add('Insert Into IOBData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, CarType, ');
                SQL.Add('InCarNo1, InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, ');
                SQL.Add(':N7, :N8, :N9, :N10, :N11, :N12)');
                Parameters.ParamByName('N1').Value := nCurrParkNo;
                Parameters.ParamByName('N2').Value := nLprNo;
                Parameters.ParamByName('N3').Value := sLprDate;
                Parameters.ParamByName('N4').Value := sLprTime;
                Parameters.ParamByName('N5').Value := 2;
                Parameters.ParamByName('N6').Value := 2;
                Parameters.ParamByName('N7').Value := sLprCarNo1;
                Parameters.ParamByName('N8').Value := 1;              // 입차상태번호: 주차장
                Parameters.ParamByName('N9').Value := sLprFile1;
                Parameters.ParamByName('N10').Value := sLprCarNo2;
                Parameters.ParamByName('N11').Value := sLprFile2;
                Parameters.ParamByName('N12').Value := sLprCarNo1;
                ExecSQL;
              end;
            end;
            NGridData('9' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime + '^'+ inValue+'^'+TLabel(FindComponent('lbIn' + IntToStr(nListCnt))).Caption);
            bNCInProcWait := false;
            if FileExists(sLprFile1) then
            begin
              with frmMain do begin
                ExceptLogging('일반차량 입차 이미지 가져오기 시작');
                TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
                ExceptLogging('일반차량 입차 이미지 가져오기 끝');
              end;
            end else begin
              with frmMain do begin
                TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
              end;
              ExceptLogging('File 없음: ' + sLprFile1);
            end;
            Exit;
          end;
        end;

//      NormalLogging('미등록차량 입차: ' + sLprCarNo1 + ' - ' + sLprFile1);
        if nHomeInfo_Comp = 8 then  //cvnet
        begin
          with dmTables.qryIOBData do
          begin
            Close;
            SQL.Clear;
//            SQL.Add('select * from ReserveCar where ParkNo = :N1 and ((OutDate <= :N3) and (InDate >= :N4))');   //Modifided Woo
            SQL.Add('select * from ReserveCar where ParkNo = :N1 and ((OutDate >= :N3) and (InDate <= :N4) and CarNo = :N5)');     //Modifided Woo
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N4').Value := FormatDateTime('YYYY-MM-DD', Now);
            Parameters.ParamByName('N5').Value := sLprCarNo1;
            open;
            if RecordCount > 0 then
            begin
              with frmMain do
              begin
                bVisitor := True;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clBlue;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '방문자등록';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clBlue;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clBlue;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
                ExceptLogging('NormalProc : cvnet 방문자예약 차량 입차: ' + sLprCarNo1);
              end;
            end
            else
            begin
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '일반';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;
            end;
          end;
        end
        else
        begin
          with frmMain do
          begin
            TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
            TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '일반';
            TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
            TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
            TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
            TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sLprCarNo1;
            TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
            TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
            TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
          end;
        end;
      except
        on E: Exception do
        begin
          ExceptLogging('NormalProc: ' + aString(E.Message));
          bNCInProcWait := False;
        end;
      end;

      try
        inValue := '입차';
        sTKNo := FormatDateTime('YYYYMMDDHHNNSSZZ', Now)+ IntToStr(nCurrUnitNo) ;

        if (nVisitation = 1) and (not bVisitor) then
        begin
          if bMode then
          begin
            inValue := '입차';
            inDong := '';
            inHo := '';
            frmIONData := TfrmIONData.Create(Application);
            try
              if frmIONData.ShowModal = mrOK then begin
//                  bOpen := True;
                inValue := frmIONData.edtMemo1.Text;
                inDong    := frmIONData.edtDong.Text;
                inHo      := frmIONData.edtHo.Text;
                if inValue = '' then begin
                   inValue := '사유 미작성'
                end;

                sPrtData := '';
                sPrtData := ST_WTP + '========================================' + LF + LF + LF + CR + SO_WTP;
                sPrtData := sPrtData + '    방   문   증' + LF + LF + LF + CR +ST_WTP;
                sPrtData := sPrtData + '========================================' + LF + LF + LF + CR + SI_WTP;
                sPrtData := sPrtData + sParkName + LF + CR;
                sPrtData := sPrtData + '--------------------' + LF + CR;
                sPrtData := sPrtData + '입차시간 : ' + sLprDate + ' ' + sLprTime + LF;
                sPrtData := sPrtData + '차량번호 : ' + sLprCarNo1 + LF + CR;
                sPrtData := sPrtData + '비    고 : ' + inValue + LF + CR;
                sPrtData := sPrtData + '확인자명 : ' + sCurrMName + LF + CR;
                sPrtData := sPrtData + LF + CR+ LF + CR+ LF + CR+ LF + CR+ LF + CR+ LF + CR;
                sPrtData := sPrtData + FullCut_WTP;
                if ComPrn.Open then //방문증 받아가야하므로 차단기 안열어줌
                begin
                  ComPrn.PutString(sPrtData);
                end
                else
                begin
                  if not bMonitoring then
                  begin
                    if nBackData = 1 then
                    begin
                      ExceptLogging('후방데이터 차단기 동작안함');
                    end
                    else
                    begin
                      InOpen(csLPR);
                    end;
                  end;
                end;
              end;
            finally
              frmIONData.Free;
              frmIONData := nil;
            end;
          end;
          NGridData('1' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime + '^'+ inValue+'^'+TLabel(FindComponent('lbIn' + IntToStr(nListCnt))).Caption);
        end
        else
        begin
          if ((bCheckVisit = True) or (bVisitor = True)) then
          begin
            NGridData('8' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime + '^'+ inValue+'^'+TLabel(FindComponent('lbIn' + IntToStr(nListCnt))).Caption);
          end
          else
          begin
            NGridData('1' + sLprCarNo1 + '^' + sLprDate + ' ' + sLprTime + '^'+ inValue+'^'+TLabel(FindComponent('lbIn' + IntToStr(nListCnt))).Caption);
          end;
        end;

        with dmTables.qryNormal do begin
		      if not bMonitoring  then
          begin
            Close;
            SQL.Clear;
            SQL.Add('Insert Into IONData ');
            SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, CarType, InImage1, InCarNo1, ');
            SQL.Add('InImage2, InCarNo2, Status, InRecog1, InRecog2, Reserve1,Reserve2,Reserve3) ');
            SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17)');
            Parameters.ParamByName('N1').Value := nCurrParkNo;
            Parameters.ParamByName('N2').Value := nLprNo;
            Parameters.ParamByName('N3').Value := sLprDate;
            Parameters.ParamByName('N4').Value := sLprTime;
            Parameters.ParamByName('N5').Value := sTKNo;
            Parameters.ParamByName('N6').Value := 1;
            Parameters.ParamByName('N7').Value := 1;
            Parameters.ParamByName('N8').Value := sLprFile1;
            Parameters.ParamByName('N9').Value := sLprCarNo1;
            Parameters.ParamByName('N10').Value := sLprFile2;
            Parameters.ParamByName('N11').Value := sLprCarNo2;
            Parameters.ParamByName('N12').Value := 1;
            Parameters.ParamByName('N13').Value := nLprRecog1;
            Parameters.ParamByName('N14').Value := nLprRecog2;
            Parameters.ParamByName('N15').Value := inValue;
            Parameters.ParamByName('N16').Value := inDong;
            Parameters.ParamByName('N17').Value := inHo;
            ExecSQL;
          end;
          if (bVisitor or bCheckVisit) then
          begin
            DspProc(1, 2, ' 방문객차량 ' + MG_Left(sLprCarNo1, 12), sDspIP);
            if nBackData = 1 then
            begin
              ExceptLogging('후방데이터 차단기 동작안함');
            end
            else
            begin
              InOpen(csLPR);
            end;
          end
          else
          begin
            DspProc(1, 2, ' 미등록차량 ' + MG_Left(sLprCarNo1, 12), sDspIP);
            if not bMonitoring then
            begin
              if not bMode then
              begin
                if nBackData = 1 then
                begin
                  ExceptLogging('후방데이터 차단기 동작안함');
                end
                else
                begin
                  InOpen(csLPR);
                end;
              end
              else
              begin
                if bOpen then
                begin
                  if nBackData = 1 then
                  begin
                    ExceptLogging('후방데이터 차단기 동작안함');
                  end
                  else
                  begin
                    InOpen(csLPR);
                  end;
                end;
              end;
            end;
          end;
        end;

        if (bCheckVisit and (nHomeVisit = 1)) then
        begin
          if (nHomeInfo_Comp = 1) then            //현대통신 방문자
          begin
            HomeInfo_Proc(3);
          end
          else if (nHomeInfo_Comp = 3) then       //아이콘트롤스
          begin
            HomeInfo_Proc(3);
          end
          else if (nHomeInfo_Comp = 6) then       //이즈빌 방문자
          begin
            HomeInfo_Proc(3);
          end;
        end;


        //이미지 로드부분 로직 맨뒤로 이동
        if FileExists(sLprFile1) then begin
          with frmMain do begin
            ExceptLogging('일반차량 입차 이미지 가져오기 시작');
            TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
            ExceptLogging('일반차량 입차 이미지 가져오기 끝');
          end;
        end else begin
          with frmMain do begin
            TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
          end;
          ExceptLogging('File 없음: ' + sLprFile1);
        end;

      finally
        bNCInProcWait := False;
      end;
    end else if nLprInOut = 2 then begin
      // 출차처리...
      NormalOut(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2, sIOTime, nLprNo, nLprInOut, nLprRecog1, nLprRecog2, sDspIP, csLPR, nListCnt);
    end;
  except
    on E: Exception do
    begin
      ExceptLogging('NormalProc: ' + aString(E.Message));
      bNCInProcWait := False;
    end;
  end;
end;

function TfrmMain.HD_CheckVisit(nCarNo: String): Boolean;
var
 dtNow : TDatetime;
begin
  dtNow := Now;

  with dmTables.qryVisit do
  begin
    Close;
    SQL.Clear;
    SQL.Add('select * from VisitInfo');
    SQL.Add(' where CarNo = :N1 and StartDateTime <= :N2 and EndDateTime >= :N3');
    Parameters.ParamByName('N1').Value := nCarNo;
    Parameters.ParamByName('N2').Value := dtNow;
    Parameters.ParamByName('N3').Value := dtNow;
    Open;

    if RecordCount > 0 then
    begin
       // 홈넷 차량번호가 4자리 이상이면 차량번호 뒷자리 4자리 자르기
      if Length(nCarNo) >= 4 then
      begin
        sHomeInfo_ShortCarNo:= Copy(nCarNo, Length(nCarNo)-3, 4);

        // 뒷자리 4자리 자른 차량 번호에 숫자가 없으면 ???
        if not MG_NumberCheck(sHomeInfo_ShortCarNo) then
          sHomeInfo_ShortCarNo:= '0000';
      end
      else
        sHomeInfo_ShortCarNo:= '0000';
        sHomeInfo_Dong := FieldByName('Dong').AsString;        // 홈넷 동
        sHomeInfo_Ho   := FieldByName('Ho').AsString;          // 홈넷 호
        Result := True;
    end
    else
    begin
      Result := False
    end;
  end
end;

function TfrmMain.HD_RequestProcess(sRecv: String): String;
var
  sRecvText : String;    //수신전문
//요청전문내역
//길이,   타입,   동,    호 ,  차량번호, 시작시간 , 데이터종류  ,  종료시간   , 인덱스
  sLength ,sType, sDong, sHo,  sCarNo,   sDateTime, sInOut,       sDateTimeEnd,  sIdx : String;

//  시작시간   ,  종료시간
  dtDateTime, dtDateTimeEnd : TDateTime;
  nSearchStart, nSearchEnd : Integer;       //전문 끊어 보는용도
  nReturnValue : Integer;
  sTemp : string;

begin
  try
    dtDateTime := StringToDate   ('100010101010');
    dtDateTimeEnd := StringToDate('100010101010');
    ExceptLogging('HD_RequestProcess : Start');
    nReturnValue := 0;
    sRecvText := sRecv;

    sLength := Copy(sRecvText, 0, 8);                      //길이
    nSearchStart := Pos('Type=', sRecvText);               //타입
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart +5;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
      begin
        nSearchEnd := StrToInt(sLength) + 8 - nSearchStart +2;
      end;

      sType := Copy(sRecvText, nSearchStart, nSearchEnd-1);
    end;
    nSearchStart :=0;
    nSearchEnd := 0;

    nSearchStart := Pos('Dong=', sRecvText);             //동
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart +5;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
        nSearchEnd := StrToInt(sLength) +8 - nSearchStart +2;
      sDong := Copy(sRecvText, nSearchStart, nSearchEnd-1);
    end;
    nSearchStart :=0;
    nSearchEnd := 0;

    nSearchStart := Pos('Ho=', sRecvText);               //호
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart + 3;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
        nSearchEnd := StrToInt(sLength) +8  - nSearchStart + 2;
      sHo := Copy(sRecvText, nSearchStart, nSearchEnd-1);
    end;
    nSearchStart :=0;
    nSearchEnd := 0;

    nSearchStart := Pos('CarNo=', sRecvText);             //차량번호
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart + 6;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
        nSearchEnd := StrToInt(sLength) +8 - nSearchStart + 2;
      sCarNo := Copy(sRecvText, nSearchStart, nSearchEnd-1);
    end;
    nSearchStart :=0;
    nSearchEnd := 0;

    nSearchStart := Pos('InOut=', sRecvText);             //처리 종류
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart + 6;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
        nSearchEnd := StrToInt(sLength) +8  - nSearchStart + 2;
      sInOut := Copy(sRecvText, nSearchStart, nSearchEnd-1);
    end;
    nSearchStart :=0;
    nSearchEnd := 0;

    nSearchStart := Pos('DateTime=', sRecvText);          // 입차가능 시작시간
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart + 9;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
      begin
        nSearchEnd := StrToInt(sLength) +8 - nSearchStart + 2;
      end
      else if nSearchEnd = 13 then            //시간데이터가 전부있으면
      begin
        sDateTime := Copy(sRecvText, nSearchStart, nSearchEnd-1);
        dtDateTime := StringToDate(sDateTime);
      end;
      nSearchStart :=0;
      nSearchEnd := 0;

      if sDateTime <> '' then
      begin
        nSearchStart := Pos('DateTimeEnd=', sRecvText);
        if nSearchStart > 0 then
        begin
          nSearchStart := nSearchStart + 12;
          nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
          if nSearchEnd = 0 then
            nSearchEnd := StrToInt(sLength) + 8 - nSearchStart + 2;
          sDateTimeEnd := Copy(sRecvText, nSearchStart, nSearchEnd-1);
        end;
        if sDateTimeEnd = '' then                             //값이 안들어오면 하루만 추가
        begin
          dtDateTimeEnd := IncDay(dtDateTime, 1)
        end
        else
        begin
          dtDateTimeEnd := StringToDate(sDateTimeEnd);
        end;
      end;
    end;
    nSearchStart := 0;
    nSearchEnd := 0;

    nSearchStart := Pos('Idx=', sRecvText);
    if nSearchStart > 0 then
    begin
      nSearchStart := nSearchStart + 4;
      nSearchEnd := Pos('&', String(PChar(@sRecvText[nSearchStart])));
      if nSearchEnd = 0 then
        nSearchEnd := StrToInt(sLength) - (nSearchStart - 4);
      sidx := Copy(sRecvText, nSearchStart, nSearchEnd-1);
    end;
    nSearchStart :=0;
    nSearchEnd := 0;

    if sInOut = 'VISIT' then
    begin
      nReturnValue := HD_VisitAddProcess(sDong, sHo, sCarNo, dtDateTime, dtDateTimeEnd);
      ExceptLogging('방문자 차량 등록 : ' + sCarNo);
      Result := HD_VisitAddRespone(nReturnValue, sDong, sHo, sCarNo, sDateTime, sDateTimeEnd);
    end
    else if ((sInOut = 'VISIT_LIST') or (sInOut = 'VISIT_LIST_HISTORY') or (sInOut = 'VISIT_LIST_ALL'))then
    begin
      Result := HD_VisitListProcess(sDong, sHo, sInOut);
      ExceptLogging('방문자 리스트 요청');
    end
    else if sInOut = 'VISIT_DEL' then
    begin
      nReturnValue := HD_VisitDelProcess(sDong, sHo, sCarNo);
      ExceptLogging('방문자 차량 취소 : ' + sCarNo);
      Result := HD_VisitDelRespone(nReturnValue, sDong, sHo, sCarNo, sIdx);
    end;

    if Result = '' then
    begin
      ExceptLogging('HD_RequestProcess : 전문 양식 오류');
      Result:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo + '&DateTime=' + sDateTime +
            '&DateTimeEnd=' + sDateTimeEnd + '&InOut=' + sInOut + '&Return=fail';
      Result := MG_InsZero(IntToStr(Length(Result)), 8) + Result;
    end;
    ExceptLogging('HD_RequestProcess : End');
  except
    on E: Exception do
    begin
      Result:= 'Type=PARKING&Dong=' + sDong + '&Ho=' + sHo + '&CarNo=' + sCarNo + '&DateTime=' + sDateTime +
            '&DateTimeEnd=' + sDateTimeEnd + '&InOut=' + sInOut + '&Return=fail';
      Result := MG_InsZero(IntToStr(Length(Result)), 8) + Result;
      ExceptLogging('HD_RequestProcess: ' + E.Message);
    end;
  end;
end;

procedure TfrmMain.HomeInfoTest_BeeJu;
var
  sSend: aString;
  nLength: Integer;
  sLength: String;
begin
  try
    sSend:= '';
    // 입력받은 차량번호 뒷자리 4자리 자르기

    // 입력받은 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      sSend := '<Message>' + #13#10 + '<header>' + #13#10 + MakeMassage('txid', '1') +
          MakeMassage('type', 'event') + MakeMassage('dest', 'wallpad') +
          MakeMassage('command', '') + MakeMassage('feedback', 'false') +
          '</header>' + #13#10 + '<target>' + #13#10 + MakeMassage('total_num', '1') +
          MakeMassage('1', edtDong.Text + '-' + edtHo.Text) + '</target>' + #13#10 +
          '<body>' + #13#10 + '<event>' + #13#10 + MakeMassage('name' , 'car') +
          '<argument>' + #13#10 + MakeMassage('number', edtCar.Text) +
          MakeMassage('time', FormatDateTime('YYYYMMDDHHNNSS', Now)) +
          MakeMassage('mode','0') + MakeMassage('gateid', '') + MakeMassage('manid', '') +
          MakeMassage('cardno', '') + '</argument>' + #13#10 + '</event>' + #13#10 +
          '</body>' + #13#10 + '</message>';
      nLength := Length(sSend) * 2 -2;
      sLength := MG_InsZero(IntToStr(nLength), 8);
      sSend := sLength + sSend;                      //길이값 8바이트 추가
      HomeInfoLogging('홈넷전문 : ' + sSend);

      if IdTC_Beeju.Connected then
        IdTC_Beeju.Disconnect;

      IdTC_Beeju.Host:= sHomeInfo_IP;
      IdTC_Beeju.Port:= nHomeInfo_Port;

      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Beeju.Connect;

        // idTC 연결되었으면 세대통보하고 연결끊기
        if IdTC_Beeju.Connected then
        begin
          IdTC_Beeju.Socket.WriteLnRFC(sSend, IndyTextEncoding_UTF16LE);
          HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' + edtHo.Text + '호 ' + edtCar.Text);
          IdTC_Beeju.Disconnect;
        end
        else
        begin
          HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
        end;
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 세대통보 ping 전송시 네트워크 에러!');
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;


procedure TfrmMain.HomeInfoTest_Commax;
var
  sSend, sNowY, sNowM, sNowD, sNowH, sNowN, sNowS, sRecvCode: aString;
  Buffer: TIdBytes;
  abRecvCode : TBytes;
begin
  sSend :=  '';
  sNowY := FormatDateTime('YYYY', Now);
  sNowM := FormatDateTime('MM', Now);
  sNowD := FormatDateTime('DD', Now);
  sNowH := FormatDateTime('HH', Now);
  sNowN := FormatDateTime('NN', Now);
  sNowS := FormatDateTime('SS', Now);

  sHomeInfo_CarNo := edtCar.Text;
  sHomeInfo_Dong := edtDong.Text;
  sHomeInfo_Ho := edtHo.Text;

  if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
  begin
    if Length(sHomeInfo_CarNo) > 4 then
    begin
      sHomeInfo_ShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);
    end;


    sSend := '<cmx>' + #13#10 +'<park>' + #13#10 +
              MakeMassage('dong', sHomeInfo_Dong) +    //동번호
              MakeMassage('ho', sHomeInfo_Ho) +        //호번호
              MakeMassage('car', sHomeInfo_ShortCarNo);//차량번호 4자리

    sSend := sSend + MakeMassage('inout', 'in');

    sSend := sSend +                                   //입출차 시각
              MakeMassage('year', sNowY) +
              MakeMassage('mon', sNowM) +
              MakeMassage('day', sNowD) +
              MakeMassage('hour', sNowH) +
              MakeMassage('min', sNowN) +
              MakeMassage('sec', sNowS) +
              '</park>' + #13#10 + '</cmx>';

    // 홈넷 IP, Port 저장
    IdTc_Commax.Host:= sHomeInfo_IP;
    IdTc_Commax.Port:= nHomeInfo_Port;

    // 홈넷 ping
    if is_Ping(sHomeInfo_IP) then
    begin
      // idTC 연결
      if not(IdTc_Commax.Connected) then
      begin
        IdTc_Commax.Connect;
        ExceptLogging('홈넷 연결 성공');
      end;

      // idTC 연결 되었으면
      if IdTc_Commax.Connected then
      begin
        IdTc_Commax.Socket.WriteLn(sSend);
        HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);

        idTC.Socket.ReadBytes(Buffer, -1, false);
        sRecvCode :=  BytesToString (Buffer);

        HomeInfoLogging('응답전문: ' + sRecvCode + '  (0:정상, 1:지원불가, 2:범위초과, 3:임시사용불가, 4:잘못된파라미터, ' +
                '5:기기응답없음, 6:서버내부오류, 9:정의되지않은오류, 10:중복입력)');
        IdTc_Commax.Disconnect;
      end
      else
      begin
        HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
      end;
    end
    else
      ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
  end
  else
  begin
    HomeInfoLogging('homeinfo_proc_Commax : 동, 호수 값 오류 : ' + sHomeInfo_Dong + ' / ' + sHomeInfo_Ho);
  end;
end;

procedure TfrmMain.HomeInfoTest_CVNet;
var
  nDong, nHo: Integer;
  sSend: aString;
begin
  try
  Case cmbIO.ItemIndex of
      0: nHomeInfo_InOut := 1;
      1: nHomeInfo_InOut := 2;
  end;
    nHomeInfo_InOut := 1;
    sHomeInfo_Type := '0';
    sHomeInfo_CarNo := edtCar.Text;
    sHomeInfo_Dong := edtDong.Text;
    sHomeInfo_Ho := edtHo.Text;
    if Length(sHomeInfo_CarNo) >= 4 then
    begin
      sHomeInfo_ShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);

      if not MG_NumberCheck(sHomeInfo_ShortCarNo) then
        sHomeInfo_ShortCarNo:= '0000';
    end
    else
      sHomeInfo_ShortCarNo:= '0000';

    HomeInfoLogging(IntToStr(nHomeInfo_InOut) + ', ' + sHomeInfo_Dong + ', ' +
                  sHomeInfo_Ho + ', ' + sHomeInfo_CarNo + ', ' + sHomeInfo_Type);

    if (sHomeInfo_Dong = '') and (sHomeInfo_Ho = '') then
    begin
      HomeInfoLogging('동, 호 입력안됨: ' + sHomeInfo_Dong + ', ' + sHomeInfo_Ho);
      Exit;
    end;

    nDong:= 0;
    nHo:= 0;
    nDong:= StrToInt(sHomeInfo_Dong);
    nHo:= StrToInt(sHomeInfo_Ho);
    sHomeInfo_Dong:= IntToStr(nDong);
    sHomeInfo_Ho:= IntToStr(nHo);

    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
      sSend:= MakeCVnetData(sHomeInfo_Dong, sHomeInfo_Ho,
                            FormatDateTime('YYYYMMDDHHNNSS', Now),
                            sHomeInfo_CarNo, sHomeInfo_Type);
      HomeInfoLogging('세대통보데이터: ' + toHex(sSend));

       if is_Ping(sHomeInfo_IP) then
      begin
        if csHomeInfo_CVNet.Socket.Connected then
        begin
          //cHomeInfo.Socket.SendText(sSend);
          csHomeInfo_CVNet.Socket.SendBuf(Pointer(sSend)^, Length(sSend));
          HomeInfoLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')');
          sSend:= '';
        end
        else
        begin
          csHomeInfo_CVNet.Active:= False;
          sHomeInfo_SendData := sSend;
          csHomeInfo_CVNet.Active:= True;
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    end
    else
      HomeInfoLogging(sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 가 올바른 숫자가 아님!');


  except
    on E: Exception do ExceptLogging('HomeInfo_Proc_CVNet: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_EZ;
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    // 입력받은 차량번호 뒷자리 4자리 자르기
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-4, 4);

    // 입력받은 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      sSend:= '$version=2.0$dongho=' + sezVilleDong + '&' + sezVilleHo +
              '$cmd=30$target=parking#mode=0#dongho=' + edtDong.Text + '&' +
              edtHo.Text + '#inout=0#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
              '#carno=' + sShortCarNo;

      sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
      nSendLength:= StrToInt(sSendLength);
      sSend:= '<start=' + sSendLength + '&0>' + sSend;

      try
        if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
        begin
          if is_Ping(sHomeInfo_IP) then
          begin
            if csHomeInfo_EZ.Socket.Connected then
            begin
              try
                if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                begin
                  HomeInfoLogging('입차통보: ' + sSend);
                end
                else
                begin
                  HomeInfoLogging('입차통보 에러: ' + sSend);
                end;
              except
                on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
              end;
            end
            else
            begin
              csHomeInfo_EZ.Close;

              if is_Ping(sHomeInfo_IP) then
              begin
                csHomeInfo_EZ.Open;
                try
                  if csHomeInfo_EZ.Socket.Connected then
                  begin
                    if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                    begin
                      HomeInfoLogging('입차통보(2): ' + sSend);
                    end
                    else
                    begin
                      HomeInfoLogging('입차통보 에러(2): ' + sSend);
                    end;
                  end;
                except
                  on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
                end;
              end
              else
                HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨(2)!');
            end;
          end
          else
          begin
            HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨!');
          end;
        end;
      except
        on E: Exception do HomeInfoLogging('입차통보 에러(3): ' + sSend);
      end;
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_Gye;
type
  TSendData = packed record
    dong: WORD;
    ho: WORD;
    command: ansiChar;
    length: WORD;
    InDate: array[1..20] of ansiChar;
    IOType: array[1..2] of ansiChar;
    CarNo: array[1..4] of ansiChar;
    Temp: array[1..9] of ansiChar;
  end;

var
  sShortCarNo, sSendLength: aString;
  i: Byte;
  tmpPchr : Pchar;
  SendData : TSendData;
  SendBuff : TIdBytes;
tmpStr: String;
  tmpCnt: Integer;
begin
  try
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-4, 4);
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin

      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

      SendData.ho := Swap(strtoint(edtHo.Text));
      SendData.dong := Swap(strtoint(edtDong.Text));
      SendData.command := chr(1);
      SendData.length := Swap(35);
      tmpStr := FormatDateTime('YYYY-MM-DD,HH:NN:SS,', NOW);
      for tmpCnt := 1 to 20 do
        SendData.InDate[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      Case cmbIO.ItemIndex of
        0: SendData.IOType := '0,';
        1: SendData.IOType := '1,';
      end;
      tmpStr := sShortCarNo;
      for tmpCnt := 1 to 4 do
        SendData.CarNo[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      SendData.Temp := ',00000000';

      if IdTC_Gyeyoung.Connected then
        IdTC_Gyeyoung.Disconnect;

      IdTC_Gyeyoung.Host:= sHomeInfo_IP;
      IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Gyeyoung.Connect;

        if IdTC_Gyeyoung.Connected then
        begin
          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          IdTC_Gyeyoung.IOHandler.Write(SendBuff);
          IdTC_Gyeyoung.Disconnect;
          case cmbIO.ItemIndex of
            0: HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' +
                                edtHo.Text + '호 ' + edtCar.Text);
            1: HomeInfoLogging('출차 세대통보 전송: ' + edtDong.Text + '동 ' +
                               edtHo.Text + '호 ' + edtCar.Text);
          end;
        end
        else
        begin
          HomeInfoLogging(sHomeInfo_IP + '로 세대통보 연결 에러!');
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 ping 전송시 에러!');
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_Home;
var
  sHomeData, sFile, sTransKey, sRecvText: aString;
  sXml: TXMLDocument;
  iNode: IXMLNode;
  mTemp: TMemoryStream;
  sSendText : string;

begin
  try
    sTransKey :=  'car' + FormatDateTime('YYYYMMDDHHNNSS', Now) ;
    sHomeInfo_Dong:=edtDong.Text;
    sHomeInfo_Ho:= edtHo.Text;
    sHomeInfo_CarNo:= edtCar.Text;
    cmbIO.ItemIndex := 0;


    sHomeInfo_Data:=  '<wizhom>'
                      + '<head trans="' + sTransKey + '">'
                      + '<from>car</from>'
                      + '<to>uims</to>'
                      + '<service>CarManager</service>'
                      + '<function>notice</function'
                      + '<return>true</return>'
                      + '</wizhom>'
                      + '</head>'
                      + '<content>'
                      + '<info>'
                      + '<addr>'+ sHomeInfo_Dong + '-' + sHomeInfo_Ho + '</addr>'
                      + '<inout>' + IntToStr(cmbIO.ItemIndex) + '</inout>'  //'0'입차, '1'출차
                      + '<datetime>'+ FormatDateTime('YYYYMMDDHHNNSS', Now) + ' </datetime>'  //입차시간'yyyyMMddHHmmss'
                      + '<location>' + sHomeInfo + '</location>'
                      + '<carno>' + sHomeInfo_CarNo +  '</carno>'
                      + '</info>'
                      + '</content>'
                      + '</wizhom>';

    HomeInfoLogging('sHomeInfo_Data : ' + sHomeInfo_Data);

    if is_Ping(sHomeInfo_IP) then
    begin
      // idTC 연결
      IdTC_Home.Connect;
      if not(IdTC_Home.Connected) then
      begin
        IdTC_Home.Connect;
        ExceptLogging('홈넷 연결 성공');
      end;

      // idTC 연결 되었으면
      if IdTC_Home.Connected then
      begin
        IdTC_Home.Socket.WriteLnRFC(sSendText, IndyTextEncoding_UTF16LE);
        HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);
        sRecvText := IdTc_Home.IOHandler.AllData;
        HomeInfoLogging('세대통보 응답: ' +sRecvText);
        IdTC_Home.Disconnect;

      end
      else
      begin
        HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
      end;
    end
    else
      ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');

//    sReadText := IdTC_Home.Socket.ReadLnRFC(bRecv,IndyTextEncoding_UTF16LE);
//    HomeInfoLogging('홈넷 응답값 : ' + sReadText);

//    IdTC_Home.IOHandler.InputBuffer.clear;
//    IdTC_Home.IOHandler.CloseGracefully;
//    IdTC_Home.Disconnect;

  except
    on E: Exception do
    begin
      HomeInfoLogging('세대통보 테스트: ' + aString(E.Message));
      HomeInfoLogging('홈넷홈 세대통보 전송오류: ' + aString(E.Message));
      IdTC_Home.IOHandler.InputBuffer.clear;
      HomeInfoLogging('홈넷홈 소켓 초기화 작업1');
      IdTC_Home.IOHandler.CloseGracefully;
      HomeInfoLogging('홈넷홈 소켓 초기화 작업2');
      IdTC_Home.Disconnect;
      HomeInfoLogging('홈넷홈 소켓 초기화 작업3');
    end;
  end;
end;

procedure TfrmMain.HomeInfoTest_Hyun;
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    sSend:= '';

    // 입력받은 차량번호 뒷자리 4자리 자르기
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-4, 4);

    HomeInfoLogging('세대통보 테스트 전송: ' + edtDong.Text + '동 ' + edtHo.Text + '호 ' + sShortCarNo);

    // 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      // '00000070Type=PARKING&Dong=101&Ho=101&CarNo=7789&DateTime=201410221402&InOut=IN'
      sSend:= 'Type=PARKING&Dong=' + edtDong.Text + '&Ho=' + edtHo.Text + '&CarNo=' + sShortCarNo + '&DateTime=' +
             FormatDateTime('YYYYMMDDHHNN', Now) + '&InOut=';

      sSend:= sSend + 'IN';
      sSend:= MG_InsZero(IntToStr(Length(sSend)), 8) + sSend;

      // idTC 연결되있으면 끊기
      if IdTc_HyunDai.Connected then
        IdTc_HyunDai.Disconnect;

      // 홈넷 IP, Port 저장
      IdTc_HyunDai.Host:= sHomeInfo_IP;
      IdTc_HyunDai.Port:= nHomeInfo_Port;

      // 홈넷 ping
      if is_Ping(sHomeInfo_IP) then
      begin
        // idTC 연결
        IdTc_HyunDai.Connect;

        // idTC 연결 되었으면
        if IdTc_HyunDai.Connected then
        begin
          // 세대통보 전송
          IdTc_HyunDai.Socket.WriteLnRFC(sSend, enUTF8);
          IdTc_HyunDai.Disconnect;
          HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' + edtHo.Text + '호 ' + edtCar.Text);
        end
        else
        begin
          HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 연결 실패!');
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 ping 에러!');
    end;
  except
    on E: Exception do HomeInfoLogging('TfrmMain.HomeInfoTest_Hyun > 세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeinfoTest_Icon;
var
  sHomeData, sFile: aString;
  sXml: TXMLDocument;
  iNode: IXMLNode;
  mTemp: TMemoryStream;
begin
  try
    sHomeInfo_Dong:= edtDong.Text;
    sHomeInfo_Ho:= edtHo.Text;
    sHomeInfo_CarNo:= edtCar.Text;
    sHomeInfo_Data:= '<?xml version="1.0" encoding="utf-8"?>' + //#13 +
                '<imap ver = "1.0" address = "' + sHomeInfo_IP + '" sender = "주차관리">' + //+#13 +
                '<service type = "request" name = "car_move_info">' + //+ #13 +
                '<destination name = "homedev" id_high = "' + edtDong.Text + '" id_low = "' + edtHo.Text + '"/>' + // + #13 +
                '<move_info> "in" </move_info>' + //+ #13 +
                '<params car_num = "' + edtCar.Text + '" loc_num = "입구" message = "null"/>' + // + #13 +
                '</service>' + //+ #13 +
                '</imap>';

    if is_Ping(sHomeInfo_IP) then
    begin
      csHomeInfo_icon.Active:= False;
      csHomeInfo_icon.Active:= True;
    end
    else
      HomeInfoLogging('세대통보 전송 시 홈넷 Ping 안됨');
  except
    on E: Exception do HomeInfoLogging('세대통보 테스트: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeinfoTest_Kocom;
var
  sSend: aString;
  sShortCarNo, sSendLength, sTemp: aString;
  nSendLength, nChkLength: Integer;
  i: Byte;
begin
  try
    FillChar(RKPark_Info, SizeOf(RKPark_Info), AnsiChar($00));

    RKPark_Info.nHeaderKey:= nGHeaderKey;
    RKPark_Info.nMsgType:= nGPark_Info;
    RKPark_Info.nMsgLength:= SizeOf(RPark_Info);
    RKPark_Info.nTown:= 0;
    RKPark_Info.nDong:= StrToInt(edtDong.Text);
    RKPark_Info.nHo:= StrToInt(edtHo.Text);
    RKPark_Info.nReserved:= 0;

    sTemp:= IntToStr(cmbIO.ItemIndex + 1);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sGateid[i]:= sTemp[i];
    end;

    sTemp:= 'aps';

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sManager[i]:= sTemp[i];
    end;

    sTemp:= IntToStr(GetTickCount);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sCardNo[i]:= sTemp[i];
    end;

    RKPark_Info.nInOut:= cmbIO.ItemIndex + 1;

    sTemp:= FormatDateTime('YYYYMMDDHHNNSS', Now);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sDate[i]:= sTemp[i];
    end;

    sTemp:= edtCar.Text;
    nChkLength:= Length(sTemp);

    for i:= 1 to nChkLength do
    begin
      RKPark_Info.sCarNo[i]:= sTemp[i];
    end;

    if is_Ping(sHomeInfo_IP) then
    begin
      try
        if idTC_Kocom.Connected then
        begin
          idTC_Kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
          HomeInfoLogging('세대통보 전송, 차량번호: ' + edtCar.Text + ' 동: ' + edtDong.Text + ' 호: ' + edtHo.Text);
        end;
      except
        on E: EIdSocketError do
        begin
          tAlive.Enabled:= True;
          idTC_Kocom.Disconnect;
          ExceptLogging('세대통보시 Bind Error');
          btnBind.Click;
        end;
      end;
    end
    else
      ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    {
    //코콤 시리얼 세대통보...
    if comKocom.Open then
    begin
      if (Length(edtDong.Text) > 0) and
         (Length(edtHo.Text) > 0) and
         (Length(edtCar.Text) >= 4) and
         MG_NumberCheck(edtDong.Text) and
         MG_NumberCheck(edtHo.Text) and
         MG_NumberCheck(Copy(aString(edtCar.Text), Length(aString(edtCar.Text))-3, 4)) then
      begin
        nResend:= 1;
        sSend:= KocomMakeString(nResend, MG_InsZero(edtDong.Text, 4) +
                MG_InsZero(edtHo.Text, 4),
                MG_InsZero(Copy(aString(edtCar.Text), Length(aString(edtCar.Text))-3, 4), 4), cmbIO.ItemIndex+1);
        comKocom.PutString(sSend);
        bReceive:= False;
        nHomeInfo_InOut:= cmbIO.ItemIndex+1;
        tKocom.Enabled:= True;
      end
      else
      begin
        ShowMessage('Kocom 시리얼 세대통보 테스트시 입력정보 오류: 동-' + edtDong.Text + ',  ' +
                      '호-' + edtHo.Text + ',  ' + '차량번호-' + edtCar.Text);
      end;
    end
    else
    begin
      ExceptLogging('Kocom 시리얼 세대통보시 포트오픈 안됨!');
    end;
    }
  except
    on E: Exception do ExceptLogging('TfrmMain.btnHomeInfoTestClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_Proc_Gye;
type
  TSendData = packed record
    dong: WORD;
    ho: WORD;
    command: ansiChar;
    length: WORD;
    InDate: array[1..20] of ansiChar;
    IOType: array[1..2] of ansiChar;
    CarNo: array[1..4] of ansiChar;
    Temp: array[1..9] of ansiChar;
  end;

var
  sShortCarNo, sSendLength: aString;
  i: Byte;
  tmpPchr : Pchar;
  SendData : TSendData;
  SendBuff : TIdBytes;
tmpStr: String;
  tmpCnt: Integer;
begin
  try
    //세대통보
    sShortCarNo:= Copy(edtCar.Text, Length(aString(edtCar.Text))-4, 4);
    if MG_NumberCheck(edtDong.Text) and MG_NumberCheck(edtHo.Text) then
    begin
      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화
      SendData.ho := Swap(strtoint(edtHo.Text));
      SendData.dong := Swap(strtoint(edtDong.Text));
      SendData.command := chr(1);
      SendData.length := Swap(35);
      tmpStr := FormatDateTime('YYYY-MM-DD,HH:NN:SS,', NOW);
      for tmpCnt := 1 to 20 do
        SendData.InDate[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      Case cmbIO.ItemIndex of
        0: SendData.IOType := '0,';
        1: SendData.IOType := '1,';
      end;
      tmpStr := sShortCarNo;
      for tmpCnt := 1 to 4 do
        SendData.CarNo[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      SendData.Temp := ',00000000';

      if IdTC_Gyeyoung.Connected then
        IdTC_Gyeyoung.Disconnect;

      IdTC_Gyeyoung.Host:= sHomeInfo_IP;
      IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Gyeyoung.Connect;

        if IdTC_Gyeyoung.Connected then
        begin
          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          IdTC_Gyeyoung.IOHandler.Write(SendBuff);
          IdTC_Gyeyoung.Disconnect;
          case cmbIO.ItemIndex of
            0: HomeInfoLogging('입차 세대통보 전송: ' + edtDong.Text + '동 ' +
                                edtHo.Text + '호 ' + edtCar.Text);
            1: HomeInfoLogging('출차 세대통보 전송: ' + edtDong.Text + '동 ' +
                               edtHo.Text + '호 ' + edtCar.Text);
          end;
        end
        else
        begin
          HomeInfoLogging(sHomeInfo_IP + '로 세대통보 연결 에러!');
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    end
    else
    begin
      ShowMessage('동, 호 정보는 숫자로 입력되어야 합니다.');
      edtDong.SetFocus;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfoTest_UBiz;
Type
    TSendData =  record
    STX : array[1..4] of ansiChar;
    Gubun : array[1..2] of ansiChar;
    PacketType : ansiChar;
    Data1 : ansiChar;
    Data2 : ansiChar;
    Dong : array[1..4] of ansiChar;
    Ho : array[1..4] of ansiChar;
    CarNo : array[1..12] of ansiChar;
    ETX : ansiChar;
    CheckSum: ansiChar;
  end;
var
  sShortCarNo: String;
  i, nLength: Byte;
  tmpPchr : Pchar;
  tmpCarNo: ansiString;
  tmpCnt: Integer;
  sTemp : aString;
  nCarNoLength : Byte;
  sSend: aString;
  SendData : TSendData;
  SendBuff : TIdBytes;
  sCarNo : String;
begin
   try
      HomeInfoLogging('홈넷차량정보 > 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
      sSend := '';

      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

      // 차량번호 12자리
      nCarNoLength:= Length(sHomeInfo_CarNo);
      case nCarNoLength of
        8: tmpCarNo :=  sHomeInfo_CarNo + '0000';
        11: tmpCarNo :=  sHomeInfo_CarNo + '0';
        12: tmpCarNo :=  sHomeInfo_CarNo;
      end;

      // 동, 호수  4자리
      if not MG_NumberCheck(sHomeInfo_Dong) then
        sHomeInfo_Dong:= '0000';

      if not MG_NumberCheck(sHomeInfo_Ho) then
        sHomeInfo_Ho:= '0000';

      if Length(sHomeInfo_Dong) = 3 then
        sHomeInfo_Dong := '0' + sHomeInfo_Dong;

      if Length(sHomeInfo_Ho) = 3 then
        sHomeInfo_Ho := '0' + sHomeInfo_Ho;

      //sSend:= MakeKyeYoungHome(sHomeInfo_Dong, sHomeInfo_Ho, tmpStr);

      // STX 연동구분 PacketType, Data1, Data2, 동, 호, 차량번호, CheckSum, ETX
      SendData.STX[1] := AnsiChar($AA);
      SendData.STX[2] := AnsiChar($AA);
      SendData.STX[3] := AnsiChar($AA);
      SendData.STX[4] := AnsiChar($A0);

      SendData.Gubun[1] := AnsiChar($BB);
      SendData.Gubun[2] := AnsiChar($BB);

      SendData.PacketType := AnsiChar($A1);

      SendData.Data1 := AnsiChar($01);

      SendData.Data2 := AnsiChar($01);

      for tmpCnt := 1 to 4 do
        SendData.Dong[tmpCnt] := AnsiChar(sHomeInfo_Dong[tmpCnt]);

      for tmpCnt := 1 to 4 do
        SendData.Ho[tmpCnt] := AnsiChar(sHomeInfo_Ho[tmpCnt]);

      nLength:= Length(aString(tmpCarNo));

      for tmpCnt := 1 to nLength do
      begin
        sCarNo := inttohex(ord(tmpcarno[tmpcnt]),2);
        SendData.CarNo[tmpCnt]:= AnsiChar(StrToInt(aString('$' + sCarNo)));

        HomeInfoLogging(aString('$' + sCarNo));
      end;

      //  연동구분 ~ 차량번호까지 XOR연산 ...
      sTemp := SendData.Gubun[1] + SendData.Gubun[2] + SendData.PacketType + SendData.Data1
                + SendData.Data2 + sHomeInfo_Dong + sHomeInfo_Ho + tmpCarNo ;

      SendData.CheckSum  := MakeHomeCrc(sTemp);

      SendData.ETX := AnsiChar($00);
      //sBuf:= STX + Gubun + PacketType + Data1 + Data2 + sDong + sHo + sCarNo + sCheckSum + ETX ;


      if is_ping(sHomeInfo_IP) then
      begin
        try
          if idUC_ubiz.Connected then
          begin

            SendBuff := RawToBytes(SendData, SizeOf(SendData));
            idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

            HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
          end
          else
          begin
            idUC_ubiz.Disconnect;
            Sleep(200);
            idUC_ubiz.Connect;

            SendBuff := RawToBytes(SendData, SizeOf(SendData));
            idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);
            HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
          end;
        except
          on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
        end;
      end
      else
      begin
        HomeInfoLogging('단지서버로 세대통보 전송시 ping 에러');
      end;
    except
      on E: Exception do HomeInfoLogging('TfrmMain.HomeInfo_Proc: ' + aString(E.Message));
    end;
end;

procedure TfrmMain.HomeInfo_Proc(nInOut: Byte);
begin
  if nInOut = 2 then                                           //출차 세대 알림
  begin
    if nHomeInfo_Comp = 6 then     //이지빌
    begin
      HomeInfo_Proc_EZ(nInOut);
    end
    else if nHomeInfo_Comp = 9 then     //코맥스
    begin
      HomeInfo_Proc_Commax(nInOut);
    end;
  end
  else
  begin
    if nHomeinfo_Comp = 0 then
    begin
      HomeInfoLogging('홈넷 설정 없음 미전송');
    end
    else if nHomeInfo_Comp = 1 then     //현대통신
    begin
      HomeInfo_Proc_Hyun(nInOut);
    end
    else if nHomeInfo_Comp = 2 then     //코콤
    begin
      HomeInfo_Proc_Kocom(nInOut);
    end
    else if nHomeInfo_Comp = 3 then     //아이컨트롤스
    begin
      HomeInfo_Proc_Icon(nInOut);
    end
    else if nHomeInfo_Comp = 4 then     //계영정보통신
    begin
      HomeInfo_Proc_Gye(nInOut);
    end
    else if nHomeInfo_Comp = 5 then     //삼성중공업 유비즈
    begin
      HomeInfo_Proc_UBiz(nInOut);
    end
    else if nHomeInfo_Comp = 6 then     //이지빌
    begin
      HomeInfo_Proc_EZ(nInOut);
    end
    else if nHomeInfo_Comp = 7 then     //한화 비쥬드림 ucamp
    begin
      HomeInfo_Proc_BeeJu(nInOut);
    end
    else if nHomeInfo_Comp = 8 then     //CVNet
    begin
      HomeInfo_Proc_CVNet(nInOut);
    end
    else if nHomeInfo_Comp = 9 then     //코맥스
    begin
      HomeInfo_Proc_Commax(nInOut);
    end
    else if nHomeInfo_Comp = 10 then     //홈넷홈
    begin
      HomeInfo_Proc_Home(nInOut);
    end;
  end

end;

procedure TfrmMain.HomeInfo_Proc_BeeJu(nInOut: Byte);
var
  sSend: aString;
  nLength: Integer;
  sLength: String;
begin
  try
    sSend:= '';

    // 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
//      HomeInfoLogging('세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);

      if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
      begin
        sSend := '<Message>' + #13#10 + '<header>' + #13#10 + MakeMassage('txid', '1') +
            MakeMassage('type', 'event') + MakeMassage('dest', 'wallpad') +
            MakeMassage('command', '') + MakeMassage('feedback', 'false') +
            '</header>' + #13#10 + '<target>' + #13#10 + MakeMassage('total_num', '1') +
            MakeMassage('1', sHomeInfo_Dong + '-' + sHomeInfo_Ho) + '</target>' + #13#10 +
            '<body>' + #13#10 + '<event>' + #13#10 + MakeMassage('name' , 'car') +
            '<argument>' + #13#10 + MakeMassage('number', sHomeInfo_CarNo) +
//            '<argument>' + #13#10 + MakeMassage('number', sHomeInfo_ShortCarNo) +
            MakeMassage('time', FormatDateTime('YYYYMMDDHHNNSS', Now)) +
            MakeMassage('mode','0') + MakeMassage('gateid', '') + MakeMassage('manid', '') +
            MakeMassage('cardno', '') + '</argument>' + #13#10 + '</event>' + #13#10 +
            '</body>' + #13#10 + '</message>' + #13#10;
        nLength := Length(sSend) * 2 -2;
        sLength := MG_InsZero(IntToStr(nLength), 8);
        sSend := sLength + sSend;                      //길이값 8바이트 추가

//        // idTC 연결되있으면 끊기
//        if idTC.Connected then
//          idTC.Disconnect;

        // 홈넷 IP, Port 저장
        IdTC_Beeju.Host:= sHomeInfo_IP;
        IdTC_Beeju.Port:= nHomeInfo_Port;

        // 홈넷 ping
        if is_Ping(sHomeInfo_IP) then
        begin
          // idTC 연결
  //        idTC.Connect;
          if not(IdTC_Beeju.Connected) then
          begin
            IdTC_Beeju.Connect;
            ExceptLogging('홈넷 연결 성공');
          end;

          // idTC 연결 되었으면
          if IdTC_Beeju.Connected then
          begin
            IdTC_Beeju.Socket.WriteLnRFC(sSend, IndyTextEncoding_UTF16LE);
            HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);
            IdTC_Beeju.Disconnect;
          end
          else
          begin
            HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
          end;
        end
        else
          ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
      end;
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.homeinfo_proc_Commax(nInOut: Byte);
var
  sSend, sNowY, sNowM, sNowD, sNowH, sNowN, sNowS, sRecvCode: aString;
  Buffer: TIdBytes;
  abRecvCode : TBytes;
begin
  sSend :=  '';
  sNowY := FormatDateTime('YYYY', Now);
  sNowM := FormatDateTime('MM', Now);
  sNowD := FormatDateTime('DD', Now);
  sNowH := FormatDateTime('HH', Now);
  sNowN := FormatDateTime('NN', Now);
  sNowS := FormatDateTime('SS', Now);

  if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
  begin
    if Length(sHomeInfo_CarNo) > 4 then
    begin
      sHomeInfo_ShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);
    end;


    sSend := '<cmx>' + #13#10 +'<park>' + #13#10 +
              MakeMassage('dong', sHomeInfo_Dong) +    //동번호
              MakeMassage('ho', sHomeInfo_Ho) +        //호번호
              MakeMassage('car', sHomeInfo_ShortCarNo);//차량번호 4자리
    if nInOut = 1 then                                 //입출구분
    begin
      sSend := sSend + MakeMassage('inout', 'in');
    end
    else
    begin
      sSend := sSend + MakeMassage('inout', 'out');
    end;

    sSend := sSend +                                   //입출차 시각
              MakeMassage('year', sNowY) +
              MakeMassage('mon', sNowM) +
              MakeMassage('day', sNowD) +
              MakeMassage('hour', sNowH) +
              MakeMassage('min', sNowN) +
              MakeMassage('sec', sNowS) +
              '</park>' + #13#10 + '</cmx>';

    // 홈넷 IP, Port 저장
    IdTc_Commax.Host:= sHomeInfo_IP;
    IdTc_Commax.Port:= nHomeInfo_Port;

    // 홈넷 ping
    if is_Ping(sHomeInfo_IP) then
    begin
      // idTC 연결
      if not(IdTc_Commax.Connected) then
      begin
        IdTc_Commax.Connect;
        ExceptLogging('홈넷 연결 성공');
      end;

      // idTC 연결 되었으면
      if IdTc_Commax.Connected then
      begin
        IdTc_Commax.Socket.WriteLn(sSend);
        HomeInfoLogging('세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);

        idTC.Socket.ReadBytes(Buffer, -1, false);
        sRecvCode :=  BytesToString (Buffer);

        HomeInfoLogging('응답전문: ' + sRecvCode + ' (0:정상, 1:지원불가, 2:범위초과, 3:임시사용불가, 4:잘못된파라미터, ' +
                '5:기기응답없음, 6:서버내부오류, 9:정의되지않은오류, 10:중복입력)');
        IdTc_Commax.Disconnect;
      end
      else
      begin
        HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
      end;
    end
    else
      ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
  end
  else
  begin
    HomeInfoLogging('homeinfo_proc_Commax : 동, 호수 값 오류 : ' + sHomeInfo_Dong + ' / ' + sHomeInfo_Ho);
  end;
end;

procedure TfrmMain.HomeInfo_Proc_CVNet(nInOut: Byte);
var
  nDong, nHo: Integer;
  sSend: aString;
begin
  try
    nHomeInfo_InOut := 1;
    sHomeInfo_Type := '0';

    if Length(sHomeInfo_CarNo) >= 4 then
    begin
      sHomeInfo_ShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);

      if not MG_NumberCheck(sHomeInfo_ShortCarNo) then
        sHomeInfo_ShortCarNo:= '0000';
    end
    else
      sHomeInfo_ShortCarNo:= '0000';

    HomeInfoLogging(IntToStr(nHomeInfo_InOut) + ', ' + sHomeInfo_Dong + ', ' +
                  sHomeInfo_Ho + ', ' + sHomeInfo_CarNo + ', ' + sHomeInfo_Type);

    if (sHomeInfo_Dong = '') and (sHomeInfo_Ho = '') then
    begin
      HomeInfoLogging('동, 호 입력안됨: ' + sHomeInfo_Dong + ', ' + sHomeInfo_Ho);
      Exit;
    end;

    nDong:= 0;
    nHo:= 0;
    nDong:= StrToInt(sHomeInfo_Dong);
    nHo:= StrToInt(sHomeInfo_Ho);
    sHomeInfo_Dong:= IntToStr(nDong);
    sHomeInfo_Ho:= IntToStr(nHo);

    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
      sSend:= MakeCVnetData(sHomeInfo_Dong, sHomeInfo_Ho,
                            FormatDateTime('YYYYMMDDHHNNSS', Now),
                            sHomeInfo_CarNo, sHomeInfo_Type);
      HomeInfoLogging('세대통보데이터: ' + toHex(sSend));

       if is_Ping(sHomeInfo_IP) then
      begin
        if csHomeInfo_CVNet.Socket.Connected then
        begin
          //cHomeInfo.Socket.SendText(sSend);
          csHomeInfo_CVNet.Socket.SendBuf(Pointer(sSend)^, Length(sSend));
          HomeInfoLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')');
          sSend:= '';
        end
        else
        begin
          csHomeInfo_CVNet.Active:= False;
          sHomeInfo_SendData := sSend;
          csHomeInfo_CVNet.Active:= True;
        end;
      end
      else
        HomeInfoLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    end
    else
      HomeInfoLogging(sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 가 올바른 숫자가 아님!');


  except
    on E: Exception do ExceptLogging('HomeInfo_Proc_CVNet: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_EZ(nInOut: Byte);
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    HomeInfoLogging('차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);

    if Length(sHomeInfo_CarNo) >= 4 then
    begin
      sShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);

      if not MG_NumberCheck(sShortCarNo) then
        sShortCarNo:= '0000';
    end
    else
      sShortCarNo:= '0000';

    if not MG_NumberCheck(sHomeInfo_Dong) then
      sHomeInfo_Dong:= '000';

    if not MG_NumberCheck(sHomeInfo_Ho) then
      sHomeInfo_Ho:= '000';

    if nHomeVisit = 1 then //방문자 사용시
    begin
      if nInOut = 3 then //방문객 입차
      begin
        sSend:= '$version=3.0$cmd=30$copy=1-10$dongho=' + sezVilleDong + '&' +
                sezVilleHo + '$target=parking#mode=1#dongho=' +sHomeInfo_Dong + '&' +
                sHomeInfo_Ho + '#inout=0#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
                '#carno=' + sHomeInfo_CarNo;
      end
      else if nInOut = 1 then               //입주민 입차
      begin
        sSend:= '$version=3.0$cmd=30$copy=1-10$dongho=' + sezVilleDong + '&' +
                sezVilleHo + '$target=parking#mode=0#dongho=' +sHomeInfo_Dong + '&' +
                sHomeInfo_Ho + '#inout=0#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
                '#carno=' + sHomeInfo_CarNo;
      end
      else if nInOut = 2 then               //입주민 출차
      begin
        sSend:= '$version=3.0$cmd=30$copy=1-10$dongho=' + sezVilleDong + '&' +
                sezVilleHo + '$target=parking#mode=0#dongho=' +sHomeInfo_Dong + '&' +
                sHomeInfo_Ho + '#inout=1#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
                '#carno=' + sHomeInfo_CarNo;
      end;
    end
    else
    begin
      sSend:= '$version=2.0$dongho=' + sezVilleDong + '&' + sezVilleHo +
                '$cmd=30$target=parking#mode=0#dongho=' + sHomeInfo_Dong + '&' +
                sHomeInfo_Ho + '#inout=0#time=' + FormatDateTime('YYYYMMDDHHNNSS', Now) +
                '#carno=' + sShortCarNo;
    end;

    sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
    nSendLength:= StrToInt(sSendLength);
    sSend:= '<start=' + sSendLength + '&0>' + sSend;

    try
      if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
      begin
        if is_Ping(sHomeInfo_IP) then
        begin
          if csHomeInfo_EZ.Socket.Connected then
          begin
            try
              if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
              begin
                HomeInfoLogging('입차통보: ' + sSend);
              end
              else
              begin
                HomeInfoLogging('입차통보 에러: ' + sSend);
              end;
            except
              on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
            end;
          end
          else
          begin
            csHomeInfo_EZ.Close;

            if is_Ping(sHomeInfo_IP) then
            begin
              csHomeInfo_EZ.Open;

              try
                if csHomeInfo_EZ.Socket.Connected then
                begin
                  if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                  begin
                    HomeInfoLogging('입차통보(2): ' + sSend);
                  end
                  else
                  begin
                    HomeInfoLogging('입차통보 에러(2): ' + sSend);
                  end;
                end;
              except
                on E: Exception do HomeInfoLogging('입차통보 에러: ' + sSend);
              end;
            end
            else
              HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨(2)!');
          end;
        end
        else
        begin
          HomeInfoLogging('이지빌 단지서버로 입차통보 전송 시도시 Ping 안됨!');
        end;
      end;
    except
      on E: Exception do HomeInfoLogging('입차통보 에러(3): ' + sSend);
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Gye(nInOut: Byte);
type
  TSendData = packed record
    dong: WORD;
    ho: WORD;
    command: ansiChar;
    length: WORD;
    InDate: array[1..20] of ansiChar;
    IOType: array[1..2] of ansiChar;
    CarNo: array[1..4] of ansiChar;
    Temp: array[1..9] of ansiChar;
  end;
var
  sShortCarNo, sSendLength: aString;
  i: Byte;
  tmpPchr : Pchar;
  SendData : TSendData;
  SendBuff : TIdBytes;
  tmpStr: String;
  tmpCnt: Integer;
begin
  try
    //세대통보
    sShortCarNo:= sHomeInfo_ShortCarNo;
    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
      FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

      SendData.ho := Swap(strtoint(sHomeInfo_Ho));
      SendData.dong := Swap(strtoint(sHomeInfo_Dong));
      SendData.command := chr(1);
      SendData.length := Swap(35);
      tmpStr := FormatDateTime('YYYY-MM-DD,HH:NN:SS,', NOW);
      for tmpCnt := 1 to 20 do
        SendData.InDate[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);
      Case nInOut of
        1: SendData.IOType := '0,';
        2: SendData.IOType := '1,';
      end;
//      Case cmbIO.ItemIndex of
//        0: SendData.IOType := '0,';
//        1: SendData.IOType := '1,';
//      end;
      tmpStr := sShortCarNo;
      for tmpCnt := 1 to 4 do
        SendData.CarNo[tmpCnt] := AnsiChar(tmpStr[tmpCnt]);

      SendData.Temp := ',00000000';

      if IdTC_Gyeyoung.Connected then
        IdTC_Gyeyoung.Disconnect;

      IdTC_Gyeyoung.Host:= sHomeInfo_IP;
      IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      if is_Ping(sHomeInfo_IP) then
      begin
        IdTC_Gyeyoung.Connect;

        if IdTC_Gyeyoung.Connected then
        begin
          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          IdTC_Gyeyoung .IOHandler.Write(SendBuff);
          IdTC_Gyeyoung .Disconnect;
        end;
        case nInOut of
          1: HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
          2: HomeInfoLogging('출차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
        end;
        ExceptLogging(' ');
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
    end;
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.homeinfo_proc_Home(nInOut: Byte);
var
  sTransKey, sSendText,sSendTextLength,sReadText, sRecvText : aString;
  nSendTextLength : Integer;
  bRecv : Boolean;

begin
  try
    sTransKey :=  'car' + FormatDateTime('YYYYMMDDHHNNSS', Now) ;
//    sHomeInfo_CarNo:= edtCar.Text;
    cmbIO.ItemIndex := 0;


    sSendText:=  '<wizhom>'
                      + '<head trans="' + sTransKey + '">'
                      + '<from>car</from>'
                      + '<to>uims</to>'
                      + '<service>CarManager</service>'
                      + '<function>notice</function>'
                      + '<return>true</return>'
                      + '</head>'
                      + '<content>'
                      + '<info>'
                      + '<addr>'+ sHomeInfo_Dong + '-' + sHomeInfo_Ho + '</addr>'
                      + '<inout>' + IntToStr(cmbIO.ItemIndex) + '</inout>'  //'0'입차, '1'출차
                      + '<datetime>'+ FormatDateTime('YYYYMMDDHHNNSS', Now) + ' </datetime>'  //입차시간'yyyyMMddHHmmss'
                      + '<location>' + sHomeInfo + '</location>'
                      + '<carno>' + sHomeInfo_CarNo +  '</carno>'
                      + '</info>'
                      + '</content>'
                      + '</wizhom>';


    nSendTextLength :=  Length(WideString(sSendText))*2 ;
    sSendTextLength := format('%0.6d', [nSendTextLength]) + format('%0.6d', [nSendTextLength])+'00';
    sSendText := sSendTextLength + sSendText;
    HomeInfoLogging('sHomeInfo_Data : ' + sSendText);

    IdTC_Home.IOHandler.InputBuffer.clear;

//    IdTC_Home.IOHandler.CloseGracefully;

    if is_Ping(sHomeInfo_IP) then
    begin
      // idTC 연결
      IdTC_Home.Connect;
//      if not(IdTC_Home.Connected) then
//      begin
//        IdTC_Home.Connect;
//        HomeInfoLogging('홈넷 재연결 성공');
//      end;

      // idTC 연결 되었으면
      if IdTC_Home.Connected then
      begin
        IdTC_Home.Socket.WriteLnRFC(sSendText, IndyTextEncoding_UTF16LE);
        HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_CarNo);
//        IdTC_Home.IOHandler.WriteLnRFC(sRecvText, IndyTextEncoding_UTF16LE);
//        IdTC_Home.IOHandler.InputBuffer.clear;
//        HomeInfoLogging('세대통보 응답: ' +sRecvText);
        IdTc_Home.Disconnect;
      end
      else
      begin
        HomeInfoLogging('홈넷 연결실패 : ' + sHomeInfo_IP + ' ' + IntToStr(nHomeInfo_Port));
      end;
    end
    else
      ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');

//    IdTC_Home.IOHandler.InputBuffer.clear;
//    IdTC_Home.IOHandler.CloseGracefully;
//    IdTC_Home.Disconnect;

  except
    on E: Exception do
    begin
      HomeInfoLogging('홈넷홈 세대통보 전송오류: ' + aString(E.Message));
      IdTC_Home.IOHandler.InputBuffer.clear;
      HomeInfoLogging('홈넷홈 소켓 초기화 작업1');
      IdTC_Home.IOHandler.CloseGracefully;
      HomeInfoLogging('홈넷홈 소켓 초기화 작업2');
      IdTC_Home.Disconnect;
      HomeInfoLogging('홈넷홈 소켓 초기화 작업3');
    end;
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Hyun(nInOut: Byte);
var
  sSend: aString;
  sShortCarNo, sSendLength: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    // 울산 신천 엠코타운 - 현대통신 세대통보
    sSend:= '';

    // 동, 호수가 숫자인 경우만 세대통보 전송하도록 한다.
    if MG_NumberCheck(sHomeInfo_Dong) and MG_NumberCheck(sHomeInfo_Ho) then
    begin
      // '00000070Type=PARKING&Dong=101&Ho=101&CarNo=7789&DateTime=201410221402&InOut=IN'
      sSend:= 'Type=PARKING&Dong=' + sHomeInfo_Dong + '&Ho=' + sHomeInfo_Ho + '&CarNo=' + sHomeInfo_ShortCarNo + '&DateTime=' +
             FormatDateTime('YYYYMMDDHHNN', Now) + '&InOut=';

      Case nInOut of
        1: sSend:= sSend + 'IN';
        2: sSend:= sSend + 'OUT';
        3: sSend:= sSend + 'VISIT_IN'; //added Woo 방문자
      end;
      sSend:= MG_InsZero(IntToStr(Length(sSend)), 8) + sSend;

      // idTC 연결되있으면 끊기
      if IdTc_HyunDai.Connected then
        IdTc_HyunDai.Disconnect;

      // 홈넷 IP, Port 저장
      IdTc_HyunDai.Host:= sHomeInfo_IP;
      IdTc_HyunDai.Port:= nHomeInfo_Port;

      // 홈넷 ping
      if is_Ping(sHomeInfo_IP) then
      begin
        // idTC 연결
        IdTc_HyunDai.Connect;

        // idTC 연결 되었으면
        if IdTc_HyunDai.Connected then
        begin
          IdTc_HyunDai.Socket.WriteLnRFC(sSend, enUTF8);
          IdTc_HyunDai.Disconnect;
          case nInOut of
            1: HomeInfoLogging('입차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
            2: HomeInfoLogging('출차 세대통보 전송: ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 ' + sHomeInfo_ShortCarNo);
          end;
        end
        else
        begin
           ExceptLogging(sHomeInfo_IP + '로 현대통신 세대통보 연결 실패!')
        end;
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 현대통신 세대통보 ping 전송시 네트워크 에러!');
    end;
  except
    on E: Exception do
    begin
      HomeInfoLogging('현대통신 세대통보전송시 에러: ' + aString(E.Message));

      IdTc_HyunDai.IOHandler.InputBuffer.clear;
      HomeInfoLogging('현대통신 소켓 초기화 작업1');
      IdTc_HyunDai.IOHandler.CloseGracefully;
      HomeInfoLogging('현대통신 소켓 초기화 작업2');
      IdTc_HyunDai.Disconnect;
      HomeInfoLogging('현대통신 소켓 초기화 작업3');
    end;
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Icon(nInOut: Byte);
var
  sHomeData, sFile: aString;
  sXml: TXMLDocument;
  iNode: IXMLNode;
  mTemp: TMemoryStream;
begin
  try
    sHomeInfo_Data:= '<?xml version="1.0" encoding="utf-8"?>' + //#13 +
                '<imap ver = "1.0" address = "' + sHomeInfo_IP + '" sender = "주차관리">' + //+#13 +
                '<service type = "request" name = "car_move_info">' + //+ #13 +
                '<destination name = "homedev" id_high = "' + sHomeInfo_Dong + '" id_low = "' + sHomeInfo_Ho + '"/>';
    if nInOut = 2 then
    begin
      sHomeInfo_Data := sHomeInfo_Data + '<move_info> "out" </move_info>' +
      '<params car_num = "' + sHomeInfo_CarNo + '" loc_num = "출구"';
    end
    else
    begin
      sHomeInfo_Data := sHomeInfo_Data + '<move_info> "in" </move_info>' +
      '<params car_num = "' + sHomeInfo_CarNo + '" loc_num = "입구"';
    end;

    if nInOut = 3 then          //방문자
    begin
      sHomeInfo_Data := sHomeInfo_Data + 'message = "Guest"/>';
    end
    else
    begin
      sHomeInfo_Data := sHomeInfo_Data + 'message = "null"/>'
    end;

    sHomeInfo_Data := sHomeInfo_Data + '</service>' + '</imap>';

    if is_Ping(sHomeInfo_IP) then
    begin
      csHomeInfo_icon.Active:= False;
      csHomeInfo_icon.Active:= True;
    end
    else
      HomeInfoLogging('세대통보 전송 시 홈넷 Ping 안됨');
  except
    on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_Proc_Kocom(nInOut: Byte);
var
  sSend: aString;
  sShortCarNo, sSendLength, sTemp: aString;
  nSendLength: Integer;
  i: Byte;
begin
  try
    FillChar(RKPark_Info, SizeOf(RKPark_Info), AnsiChar($00));
    RKPark_Info.nHeaderKey:= nGHeaderKey;
    RKPark_Info.nMsgType:= nGPark_Info;
    RKPark_Info.nMsgLength:= SizeOf(RPark_Info);
    RKPark_Info.nTown:= 0;
    RKPark_Info.nDong:= StrToInt(sHomeInfo_Dong);
    RKPark_Info.nHo:= StrToInt(sHomeInfo_Ho);
    RKPark_Info.nReserved:= 0;

    sTemp:= IntToStr(nInOut);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sGateid[i]:= sTemp[i];
    end;

    sTemp:= 'aps';

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sManager[i]:= sTemp[i];
    end;

    sTemp:= sHomeInfo_CardNo;

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sCardNo[i]:= sTemp[i];
    end;

    RKPark_Info.nInOut:= nInOut;

    sTemp:= FormatDateTime('YYYYMMDDHHNNSS', Now);

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sDate[i]:= sTemp[i];
    end;

    sTemp:= sHomeInfo_CarNo;

    for i:= 1 to Length(sTemp) do
    begin
      RKPark_Info.sCarNo[i]:= sTemp[i];
    end;

    if is_Ping(sHomeInfo_IP) then
    begin
      try
        if IdTC_kocom.Connected then
        begin
          IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
          HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//          tKocomCheck.Interval:= 200;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//          tKocomCheck.Enabled:= True;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
        end
        else
        begin
          IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
          HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//          tKocomCheck.Interval:= 200;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//          tKocomCheck.Enabled:= True;         //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
        end;
      except
        on E: EIdSocketError do
        begin
          tAlive.Enabled:= True;
          IdTC_kocom.Disconnect;
          ExceptLogging('세대통보시 Bind Error');
          btnBind.Click;
        end;
      end;
    end
    else
    begin
      if is_Ping(sHomeInfo_IP) then
      begin
        try
          if IdTC_kocom.Connected then
          begin
            IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
            HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//            tKocomCheck.Interval:= 200;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//            tKocomCheck.Enabled:= True;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
          end
          else
          begin
            IdTC_kocom.IOHandler.Write(RawToBytes(RKPark_Info, SizeOf(RKPark_Info)), SizeOf(RKPark_Info), 0);
            //ExceptLogging('세대통보 전송(' + sHomeInfo_CarNo + ')' );
            HomeInfoLogging('세대통보 전송, 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
//            tKocomCheck.Interval:= 200;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//            tKocomCheck.Enabled:= True;           //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
          end;
        except
          on E: EIdSocketError do
          begin
            tAlive.Enabled:= True;
            IdTC_kocom.Disconnect;
            ExceptLogging('세대통보시 Bind Error');
            btnBind.Click;
          end;
        end;
      end
      else
        ExceptLogging(sHomeInfo_IP + '로 세대통보 Ping 재전송시 네트워크 에러!');
    end;

    {
    //코콤 시리얼 세대통보...
    if comKocom.Open then
    begin
      if (Length(sHomeInfo_Dong) > 0) and
         (Length(sHomeInfo_Ho) > 0) and
         (Length(sHomeInfo_CarNo) >= 4) and
         MG_NumberCheck(sHomeInfo_Dong) and
         MG_NumberCheck(sHomeInfo_Ho) and
         MG_NumberCheck(Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4)) then
      begin
        nResend:= 1;
        sSend:= KocomMakeString(nResend, MG_InsZero(sHomeInfo_Dong, 4) +
                MG_InsZero(sHomeInfo_Ho, 4),
                MG_InsZero(Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4), 4), nInOut);
        comKocom.PutString(sSend);
        bReceive:= False;
        nHomeInfo_InOut:= nInOut;
        tKocom.Enabled:= True;
      end
      else
      begin
        ExceptLogging('Kocom 시리얼 세대통보시 입력정보 오류: 동-' + sHomeInfo_Dong + ',  ' +
                      '호-' + sHomeInfo_Ho + ',  ' + '차량번호-' + sHomeInfo_CarNo);
      end;
    end
    else
    begin
      ExceptLogging('Kocom 시리얼 세대통보시 포트오픈 안됨!');
    end;
    }
  except
    on E: Exception do
    begin
      HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
    end;
  end;
end;

procedure TfrmMain.HomeInfo_Proc_UBiz(nInOut: Byte);
Type
  //TSendData = Packed record
    TSendData =  record
    STX : array[1..4] of ansiChar;
    Gubun : array[1..2] of ansiChar;
    PacketType : ansiChar;
    Data1 : ansiChar;
    Data2 : ansiChar;
    Dong : array[1..4] of ansiChar;
    Ho : array[1..4] of ansiChar;
    CarNo : array[1..12] of ansiChar;
    ETX : ansiChar;
    CheckSum: ansiChar;
  end;
var
  sShortCarNo: String;
  i, nLength: Byte;
  tmpPchr : Pchar;
  tmpCarNo: ansiString;
  tmpCnt: Integer;
  sTemp : aString;
  nCarNoLength : Byte;
  sSend: aString;
  SendData : TSendData;
  SendBuff : TIdBytes;
  sCarNo : String;
begin
  try
    HomeInfoLogging('홈넷차량정보 > 차량번호: ' + sHomeInfo_CarNo + ' 동: ' + sHomeInfo_Dong + ' 호: ' + sHomeInfo_Ho);
    sSend := '';

    FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

    // 차량번호 12자리
    nCarNoLength:= Length(sHomeInfo_CarNo);
    case nCarNoLength of
      8: tmpCarNo :=  sHomeInfo_CarNo + '0000';
      11: tmpCarNo :=  sHomeInfo_CarNo + '0';
      12: tmpCarNo :=  sHomeInfo_CarNo;
    end;

    // 동, 호수  4자리
    if not MG_NumberCheck(sHomeInfo_Dong) then
      sHomeInfo_Dong:= '0000';

    if not MG_NumberCheck(sHomeInfo_Ho) then
      sHomeInfo_Ho:= '0000';

    if Length(sHomeInfo_Dong) = 3 then
      sHomeInfo_Dong := '0' + sHomeInfo_Dong;

    if Length(sHomeInfo_Ho) = 3 then
      sHomeInfo_Ho := '0' + sHomeInfo_Ho;

    //sSend:= MakeKyeYoungHome(sHomeInfo_Dong, sHomeInfo_Ho, tmpStr);

    // STX 연동구분 PacketType, Data1, Data2, 동, 호, 차량번호, CheckSum, ETX
    SendData.STX[1] := AnsiChar($AA);
    SendData.STX[2] := AnsiChar($AA);
    SendData.STX[3] := AnsiChar($AA);
    SendData.STX[4] := AnsiChar($A0);

    SendData.Gubun[1] := AnsiChar($BB);
    SendData.Gubun[2] := AnsiChar($BB);

    SendData.PacketType := AnsiChar($A1);

    SendData.Data1 := AnsiChar($01);

    SendData.Data2 := AnsiChar($01);

    for tmpCnt := 1 to 4 do
      SendData.Dong[tmpCnt] := AnsiChar(sHomeInfo_Dong[tmpCnt]);

    for tmpCnt := 1 to 4 do
      SendData.Ho[tmpCnt] := AnsiChar(sHomeInfo_Ho[tmpCnt]);

    nLength:= Length(aString(tmpCarNo));

    for tmpCnt := 1 to nLength do
    begin
      sCarNo := inttohex(ord(tmpcarno[tmpcnt]),2);
      SendData.CarNo[tmpCnt]:= AnsiChar(StrToInt(aString('$' + sCarNo)));

      HomeInfoLogging(aString('$' + sCarNo));
    end;

    //  연동구분 ~ 차량번호까지 XOR연산 ...
    sTemp := SendData.Gubun[1] + SendData.Gubun[2] + SendData.PacketType + SendData.Data1
              + SendData.Data2 + sHomeInfo_Dong + sHomeInfo_Ho + tmpCarNo ;

    SendData.CheckSum  := MakeHomeCrc(sTemp);

    SendData.ETX := AnsiChar($00);
    //sBuf:= STX + Gubun + PacketType + Data1 + Data2 + sDong + sHo + sCarNo + sCheckSum + ETX ;

    if is_ping(sHomeInfo_IP) then
    begin
      try
        if idUC_ubiz.Connected then
        begin

          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

          HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
        end
        else
        begin
          idUC_ubiz.Disconnect;
          Sleep(200);
          idUC_ubiz.Connect;

          SendBuff := RawToBytes(SendData, SizeOf(SendData));
          idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);
          HomeInfoLogging('> 세대통보 전송 : ' + aString(SendBuff));
        end;
      except
        on E: Exception do HomeInfoLogging('세대통보전송시 에러: ' + aString(E.Message));
      end;
    end
    else
    begin
      HomeInfoLogging('단지서버로 세대통보 전송시 ping 에러');
    end;
  except
    on E: Exception do HomeInfoLogging('TfrmMain.HomeInfo_Proc: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.HomeInfo_RecvProc(sData: AnsiString);
var
  nChk, nSTXPos, nETXPos, nEndLen, nDataLen, i: Integer;
  sCVnetData: AnsiString;
begin
  try
    //CVnet
    sCVnetData:= sData;

    if Length(sCVNetData) >= 5 then
    begin
      nDataLen:= Ord(sCVNetData[4]) + (Ord(sCVNetData[5]) * 256) + 7;
    end
    else
      Exit;

    nEndLen:= Length(sCVNetData);

    if nEndLen < nDataLen then
    begin
      HomeInfoLogging('CVNet 수신데이터 길이오류');
      Exit;
    end;
    nSTXPos:= Pos(STX, sCVnetData);

    for i := nEndLen Downto 1 do
      if sCVNetData[i] = ETX then
      begin
        nETXPos:= i;
        Break;
      end;

    if (nSTXPos <= 0) or
       (nETXPos <= 0) then
      Exit;

    sCVnetData:= Copy(sCVnetData, nSTXPos, (nETXPos-nSTXPos)+1);
    HomeInfoLogging('CVNet 수신데이터: ' + toHex(sCVnetData));

    if CheckCVnetCRC(sCVnetData) and (Copy(sCVnetData, 2, 1) = AnsiChar($D2)) then
      CVNetProc(sCVNetData)
    else
      HomeInfoLogging('CVNet 수신데이터 CRC 에러');
  except
    on E: Exception do ExceptLogging('HomeInfo_RecvProc: ' + aString(E.Message));
  end;
end;

function TfrmMain.RecvLprProc(sLprFile1, sLprCarNo1, sLprFile2, sLprCarNo2,
  sIOTime: aString; nLprNo, nLprInOut, nLprRecog1, nLprRecog2: Byte;
  sDspIP: aString; csLPR: TClientSocket; bOpen: Boolean; nListCnt: Byte; nBackData : Integer): String;
var
  sRecv, sSend, sName: aString;
  nSTXPos, nETXPos, nParkNo, nUnitNo: Integer;

  sCardNo, sLastUseTime, sSTime, sETime, sCarNo, sMarkNo, sGroupName,
    sSCInDate, sSCInTime, sCompName, sDeptName, sExpDateF, sExpDateT, sLprDate,
    sLprTime, sTemp, sInFile, sHISTime, sHIETime, sDisplayText: aString;
  nInOut, nStatus, nAPB, nWP, nSYoil, nEYoil, nCarNo, nGroupNo, nHIType: Integer;
  nLastUnitNo: Byte;
  nIBCRC: Word;
  bHoliday,bHIType: Boolean;
  nUseFlag, nLastStatus: Byte;
begin
  try
    try
      bSCProcWait := True;
      bHomeInfo:= True;
      // 정기차량 처리....
      ExceptLogging('정기차량시작: ' + sLprCarNo1 + ', ' + sLprCarNo2);
      Result := '^^^^^^';
      nParkNo := nCurrParkNo;
      nUnitNo := nLprNo;
      nInOut := nLprInOut;
      nCarNo := 0;
      nLastUnitNo := 0;
      sCardNo := '';
      sMarkNo := '';
      bHoliday := False;
      sLprDate := Copy(sIOTime, 1, 10);
      sLprTime := Copy(sIOTime, 12, 8);

      with dmTables.qryRecvLpr1 do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from UnitInfo where UnitNo = :N1');
        Parameters.ParamByName('N1').Value := nUnitNo;
        Open;
        if RecordCount > 0 then
        begin
          sHomeInfo := FieldByName('UnitName').AsString;
        end;
        Close;
        SQL.Clear;

        // 정기차량 조회
        if sLprCarNo2 <> '' then
        begin
          SQL.Add('Select * from CustInfo where (CarNo = :N1) or (CarNo = :N2) and TKType = 2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
          Parameters.ParamByName('N2').Value := sLprCarNo2;
        end
        else
        begin
          SQL.Add('Select * from CustInfo where CarNo = :N1 and TKType = 2');
          Parameters.ParamByName('N1').Value := sLprCarNo1;
        end;
        Open;

        if RecordCount > 0 then
        begin
          sCardNo := FieldByName('TKNo').AsString;
          sMarkNo := FieldByName('MarkNo').AsString;
          nStatus := FieldByName('Status').AsInteger;
          nAPB := FieldByName('APB').AsInteger;
          nLastStatus := FieldByName('IOStatusNo').AsInteger;
          sLastUseTime := FieldByName('LastUseDate').AsString + ' ' + FieldByName('LastUseTime').AsString;
          nWP := FieldByName('WPNo').AsInteger;
          nGroupNo := FieldByName('GroupNo').AsInteger;
          sName := FieldByName('Name').AsString;
          nLastUnitNo := FieldByName('LastUnitNo').AsInteger;
          sCompName := FieldByName('CompName').AsString;
          sDeptName := FieldByName('DeptName').AsString;
          sExpDateF := FieldByName('ExpDateF').AsString;
          sExpDateT := FieldByName('ExpDateT').AsString;
          nHIType:= FieldByName('HIType').AsInteger;         // 세대통보여부
          sHISTime:= FieldByName('HISTime').AsString;        // 세대통보 시작시각
          sHIETime:= FieldByName('HIETime').AsString;        // 세대통보 종료시각
          sCarNo := FieldByName('CarNo').AsString;
          sHomeInfo_CarNo:= MG_StrTrim(sCarNo, ' ');         // 홈넷 차량번호

//          if (sHISTime <> '') and (sHIETime <> '') then
//          begin
//            if sHISTime < sHIETime then
//            begin
//              bHIType := True;
//            end
//            else
//            begin
//              bHIType := False;
//            end;
//          end
//          else
//          begin
//            bHIType := True;
//          end;

          // 홈넷 차량번호가 4자리 이상이면 차량번호 뒷자리 4자리 자르기
          if Length(sHomeInfo_CarNo) >= 4 then
          begin
            sHomeInfo_ShortCarNo:= Copy(sHomeInfo_CarNo, Length(sHomeInfo_CarNo)-3, 4);

            // 뒷자리 4자리 자른 차량 번호에 숫자가 없으면 ???
            if not MG_NumberCheck(sHomeInfo_ShortCarNo) then
              sHomeInfo_ShortCarNo:= '0000';
          end
          else
            sHomeInfo_ShortCarNo:= '0000';

          sHomeInfo_Dong:= MG_StrTrim(sCompName, ' ');         // 홈넷 동
          sHomeInfo_Ho:= MG_StrTrim(sDeptName, ' ');           // 홈넷 호

          Result := sLprDate + '^' + sLprTime + '^' + sCarNo + '^' + sName + '^' + sCompName + '^' + sDeptName + '^' + sExpDateT + '까지^';
        end;
      end;
//
//      if (nHIType = 1) then
//      begin
        bHomeInfo:= True;
//      end
//      else
//      begin
//        bHomeInfo:= False;
//      end;

//      // 입차가 아님 or 세대통보 안함 or
//      // (세대통보 = 설정 통보 and (통보 시작시간 > 현재시간 or 통보 종료시간 < 현재시간))
//      if (nInOut <> 1) or (nHIType = 2) or
//         ((nHIType = 1) and ((sHISTime > FormatDateTime('HH:NN', Now)) or (sHIETime < FormatDateTime('HH:NN', Now)))) then
//        bHomeInfo:= False;

      //입차 아니라도 쏘도록
      if (nHIType = 2) or
         ((nHIType = 1) and ((sHISTime > FormatDateTime('HH:NN', Now)) or (sHIETime < FormatDateTime('HH:NN', Now)))) then
        bHomeInfo:= False;

      with dmTables do
      begin
        nSYoil := 1;
        nEYoil := 7;
        sSTime := '00:00';
        sETime := '23:59';

        // 정기차량 그룹 조회
        with qryRecvLpr2 do
        begin
          Close;
          SQL.Clear;
          SQL.Add('Select * from GGroup where ParkNo = :N1 and GroupNo = :N2');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nGroupNo;
          Open;

          if RecordCount > 0 then
          begin
            sGroupName := FieldByName('GroupName').AsString;
            nGroupType := FieldByName('GroupType').AsInteger;
            nUseFeeItem := FieldByName('UseFeeItem').AsInteger;    // 적용할 요금종류 번호
          end;
        end;

        if nUseDSPText = 1 then
        begin
          sDisplayText := MG_Left(sGroupName, 12);
        end
        else if nUseDSPText = 2 then
        begin
          sDisplayText := MG_Left(sCompName, 12);
        end
        else if nUseDSPText = 3 then
        begin
          sDisplayText := MG_Left(sDeptName, 12);
        end
        else if nUseDSPText = 4 then
        begin
          sDisplayText := MG_Left(sName, 12);
        end
        else
        begin
          sDisplayText := MG_Left('  등록차량  ', 12);
        end;

        // 현재 사용기간내에 있으면...
        if (sExpDateF <= FormatDateTime('YYYY-MM-DD', Now)) and
           (sExpDateT >= FormatDateTime('YYYY-MM-DD', Now)) then
        begin
          // 입출구 구분(입구용:1, 출구용:2)
          if nInOut = 1 then
          begin
            if ((nSYoil <= DayOfWeek(Now)) and (nEYoil >= DayOfWeek(Now)) and
                (sSTime <= FormatDateTime('HH:NN', Now)) and
                (sETime >= FormatDateTime('HH:NN', Now))) then
            begin
              // 상태(발매:0, 사용중:1, 전체봉쇄:3, 입차봉쇄:4, 출차봉쇄:5)
              Case nStatus of
                0,2:
                  begin // 발매
                    if not bMonitoring  then
                    begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');

                        // APB가 "1회조정(2)" 이면 APB를 "자동(1)"으로 변경한다.
                        if nAPB = 2 then
                          SQL.Add(', APB = :N10 ');

                        SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                        Parameters.ParamByName('N1').Value := nCurrParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 1;        // 최종사용상태: 주차장
                        Parameters.ParamByName('N6').Value := 1;        // 상태: 사용중
                        Parameters.ParamByName('N7').Value := nCurrParkNo;
                        Parameters.ParamByName('N8').Value := 2;
                        Parameters.ParamByName('N9').Value := sCarNo;

                        if nAPB = 2 then
                          Parameters.ParamByName('N10').Value := 1;
                        ExecSQL;
  //
                        Close;
                        SQL.Clear;
                        SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                        SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                        SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                        SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                        SQL.Add(':N12, :N13, :N14, :N15, :N16, :N17)');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;
                        Parameters.ParamByName('N6').Value := 2;
                        Parameters.ParamByName('N7').Value := nGroupNo;
                        Parameters.ParamByName('N8').Value := sGroupName;
                        Parameters.ParamByName('N9').Value := sCompName;
                        Parameters.ParamByName('N10').Value := sDeptName;
                        Parameters.ParamByName('N11').Value := sName;
                        Parameters.ParamByName('N12').Value := sLprCarNo1;
                        Parameters.ParamByName('N13').Value := 1;              // 입차상태번호: 주차장
                        Parameters.ParamByName('N14').Value := sLprFile1;
                        Parameters.ParamByName('N15').Value := sLprCarNo2;
                        Parameters.ParamByName('N16').Value := sLprFile2;
                        Parameters.ParamByName('N17').Value := sCardNo;
                        ExecSQL;
                      end;
                      if bOpen then
                      begin
                        if nBackData = 1 then
                        begin
                          ExceptLogging('후방데이터 차단기 동작안함');
                        end
                        else
                        begin
                          InOpen(csLPR);
                        end;
                      end;
                    end;

                    DspProc(1, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                    Result := '1' + Result + '입 차';
                  end;

                1, 5:
                  begin // 정상, 출차봉쇄
                    if nAPB = 1 then // 자동
                    begin
                      // 최종사용상태가 주차장, APB위반 입차거부일 경우
                      if (nLastStatus = 1) or (nLastStatus = 8) then
                      begin
                        if not bMonitoring  then
                        begin
                          with qryRecvLpr2 do
                          begin
                            Close;
                            SQL.Clear;
                            SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                            SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                            SQL.Add('where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 9;        // 봉쇄중 입차시도
                            Parameters.ParamByName('N6').Value := nParkNo;
                            Parameters.ParamByName('N7').Value := 2;
                            Parameters.ParamByName('N8').Value := sCarNo;
                            ExecSQL;

                            Close;
                            SQL.Clear;
                            SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                            SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                            SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                            SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                            SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 2;
                            Parameters.ParamByName('N7').Value := nGroupNo;
                            Parameters.ParamByName('N8').Value := sGroupName;
                            Parameters.ParamByName('N9').Value := sCompName;
                            Parameters.ParamByName('N10').Value := sDeptName;
                            Parameters.ParamByName('N11').Value := sName;
                            Parameters.ParamByName('N12').Value := sLprCarNo1;
                            Parameters.ParamByName('N13').Value := 7;            // APB 위반(입차)
                            Parameters.ParamByName('N14').Value := sLprFile1;
                            Parameters.ParamByName('N15').Value := sLprCarNo2;
                            Parameters.ParamByName('N16').Value := sLprFile2;
                            Parameters.ParamByName('N17').Value := sCardNo;
                            ExecSQL;
                          end;
                        end;
                        DspProc(1, 1, 'APB위반차량 ' + MG_Left(sCarNo, 12), sDspIP);
                        bHomeInfo:= False;
                        Result := '1' + Result + 'APB위반';
                        ExceptLogging('##### APB 위반 차량 #####');
                        if not bMode then
                        begin
                          if nBackData = 1 then
                          begin
                            ExceptLogging('후방데이터 차단기 동작안함');
                          end
                          else
                          begin
                            InOpen(csLPR);
                          end;
                        end;
                      end
                      else
                      begin
                        // 최종사용상태가 주차장 또는 APB위반 입차거부가 아니면 입차처리한다.
                        if not bMonitoring  then
                        begin
                          with qryRecvLpr2 do
                          begin
                            Close;
                            SQL.Clear;
                            SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                            SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                            SQL.Add('Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 1;               // 최종사용상태: 주차장
                            Parameters.ParamByName('N6').Value := 1;               // 상태: 발매
                            Parameters.ParamByName('N7').Value := nParkNo;
                            Parameters.ParamByName('N8').Value := 2;
                            Parameters.ParamByName('N9').Value := sCarNo;
                            ExecSQL;

                            Close;
                            SQL.Clear;
                            SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                            SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                            SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ' );
                            SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                            SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 2;
                            Parameters.ParamByName('N7').Value := nGroupNo;
                            Parameters.ParamByName('N8').Value := sGroupName;
                            Parameters.ParamByName('N9').Value := sCompName;
                            Parameters.ParamByName('N10').Value := sDeptName;
                            Parameters.ParamByName('N11').Value := sName;
                            Parameters.ParamByName('N12').Value := sLprCarNo1;
                            Parameters.ParamByName('N13').Value := 1;
                            Parameters.ParamByName('N14').Value := sLprFile1;
                            Parameters.ParamByName('N15').Value := sLprCarNo2;
                            Parameters.ParamByName('N16').Value := sLprFile2;
                            Parameters.ParamByName('N17').Value := sCardNo;
                            ExecSQL;
                          end;

                          if bOpen then
                          begin
                            if nBackData = 1 then
                            begin
                              ExceptLogging('후방데이터 차단기 동작안함');
                            end
                            else
                            begin
                              InOpen(csLPR);
                            end;
                          end;
                        end;

                        DspProc(1, 1, sDisplayText  + MG_Left(sCarNo, 12), sDspIP);
                        Result := '1' + Result + '입 차';

                      end;
                    end
                    else if nAPB = 2 then
                    begin
                      // APB가 1회조정이면 APB를 자동으로 변경한다.
                      if not bMonitoring  then
                      begin
                        with qryRecvLpr2 do
                        begin
                          Close;
                          SQL.Clear;
                          SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                          SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                          SQL.Add('Status = :N6, APB = :N10 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 1;
                          Parameters.ParamByName('N6').Value := 1;
                          Parameters.ParamByName('N7').Value := nParkNo;
                          Parameters.ParamByName('N8').Value := 2;
                          Parameters.ParamByName('N9').Value := sCarNo;
                          Parameters.ParamByName('N10').Value := 1;
                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                          SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                          SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                          SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 2;
                          Parameters.ParamByName('N7').Value := nGroupNo;
                          Parameters.ParamByName('N8').Value := sGroupName;
                          Parameters.ParamByName('N9').Value := sCompName;
                          Parameters.ParamByName('N10').Value := sDeptName;
                          Parameters.ParamByName('N11').Value := sName;
                          Parameters.ParamByName('N12').Value := sLprCarNo1;
                          Parameters.ParamByName('N13').Value := 1;
                          Parameters.ParamByName('N14').Value := sLprFile1;
                          Parameters.ParamByName('N15').Value := sLprCarNo2;
                          Parameters.ParamByName('N16').Value := sLprFile2;
                          Parameters.ParamByName('N17').Value := sCardNo;
                          ExecSQL;
                        end;

                        if bOpen then
                        begin
                          if nBackData = 1 then
                          begin
                            ExceptLogging('후방데이터 차단기 동작안함');
                          end
                          else
                          begin
                            InOpen(csLPR);
                          end;
                        end;
                      end;

                      DspProc(1, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                      Result := '1' + Result + '입 차';

                    end
                    else if nAPB = 3 then
                    begin
                      // APB사용안함이면 입차처리한다.
                      // 정기차량에 대한 최종사용정보 업데이트후 정기차량 입출차 자료 등록
                      if not bMonitoring  then
                      begin
                        with qryRecvLpr2 do
                        begin
                          Close;
                          SQL.Clear;
                          SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                          SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                          SQL.Add('Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 1;
                          Parameters.ParamByName('N6').Value := 1;
                          Parameters.ParamByName('N7').Value := nParkNo;
                          Parameters.ParamByName('N8').Value := 2;
                          Parameters.ParamByName('N9').Value := sCarNo;
                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add('Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                          SQL.Add('CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                          SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                          SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                          SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 2;
                          Parameters.ParamByName('N7').Value := nGroupNo;
                          Parameters.ParamByName('N8').Value := sGroupName;
                          Parameters.ParamByName('N9').Value := sCompName;
                          Parameters.ParamByName('N10').Value := sDeptName;
                          Parameters.ParamByName('N11').Value := sName;
                          Parameters.ParamByName('N12').Value := sLprCarNo1;
                          Parameters.ParamByName('N13').Value := 1;
                          Parameters.ParamByName('N14').Value := sLprFile1;
                          Parameters.ParamByName('N15').Value := sLprCarNo2;
                          Parameters.ParamByName('N16').Value := sLprFile2;
                          Parameters.ParamByName('N17').Value := sCardNo;
                          ExecSQL;
                        end;

                        if bOpen then
                        begin
                          if nBackData = 1 then
                          begin
                            ExceptLogging('후방데이터 차단기 동작안함');
                          end
                          else
                          begin
                            InOpen(csLPR);
                          end;
                        end;
                      end;

                      DspProc(1, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                      Result := '1' + Result + '입 차';

                    end;
                  end;

                3, 4:
                  begin // 전체봉쇄, 입차봉쇄
                    if not bMonitoring  then
                    begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add(
                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                        SQL.Add(
                          'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 9;
                        Parameters.ParamByName('N6').Value := nParkNo;
                        Parameters.ParamByName('N7').Value := 2;
                        Parameters.ParamByName('N8').Value := sCarNo;
                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                        SQL.Add(
                          'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                        SQL.Add(
                          'InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                        SQL.Add(
                          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                        SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;
                        Parameters.ParamByName('N6').Value := 2;
                        Parameters.ParamByName('N7').Value := nGroupNo;
                        Parameters.ParamByName('N8').Value := sGroupName;
                        Parameters.ParamByName('N9').Value := sCompName;
                        Parameters.ParamByName('N10').Value := sDeptName;
                        Parameters.ParamByName('N11').Value := sName;
                        Parameters.ParamByName('N12').Value := sLprCarNo1;
                        Parameters.ParamByName('N13').Value := 9;                      // 봉쇄중 입차시도
                        Parameters.ParamByName('N14').Value := sLprFile1;
                        Parameters.ParamByName('N15').Value := sLprCarNo2;
                        Parameters.ParamByName('N16').Value := sLprFile2;
                        Parameters.ParamByName('N17').Value := sCardNo;
                        ExecSQL;
                      end;
                    end;
                    bHomeInfo:= False;
                    DspProc(1, 1, '봉쇄차량    ' + MG_Left(sCarNo, 12), sDspIP);
                    Result := '1' + Result + '봉쇄차량';
                    ExceptLogging('##### 전체 또는 입차봉쇄 카드 #####');
                    if not bMode then
                    begin
                      if nBackData = 1 then
                      begin
                        ExceptLogging('후방데이터 차단기 동작안함');
                      end
                      else
                      begin
                        InOpen(csLPR);
                      end;
                    end;
                  end;
              end;
            end
            else
            begin
              if not bMonitoring  then
              begin
                with qryRecvLpr2 do
                begin
                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                  SQL.Add(
                    'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                  SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                  Parameters.ParamByName('N1').Value := nParkNo;
                  Parameters.ParamByName('N2').Value := nUnitNo;
                  Parameters.ParamByName('N3').Value := sLprDate;
                  Parameters.ParamByName('N4').Value := sLprTime;
                  Parameters.ParamByName('N5').Value := 18;
                  Parameters.ParamByName('N7').Value := nParkNo;
                  Parameters.ParamByName('N8').Value := 2;
                  Parameters.ParamByName('N9').Value := sCarNo;
                  ExecSQL;

                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                  SQL.Add(
                    'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                  SQL.Add('InIOStatusNo, InImage1, InCarNo2, InImage2, TKNo) ');
                  SQL.Add(
                    'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, ');
                  SQL.Add(':N13, :N14, :N15, :N16, :N17)');
                  Parameters.ParamByName('N1').Value := nParkNo;
                  Parameters.ParamByName('N2').Value := nUnitNo;
                  Parameters.ParamByName('N3').Value := sLprDate;
                  Parameters.ParamByName('N4').Value := sLprTime;
                  Parameters.ParamByName('N5').Value := 2;
                  Parameters.ParamByName('N6').Value := 2;
                  Parameters.ParamByName('N7').Value := nGroupNo;
                  Parameters.ParamByName('N8').Value := sGroupName;
                  Parameters.ParamByName('N9').Value := sCompName;
                  Parameters.ParamByName('N10').Value := sDeptName;
                  Parameters.ParamByName('N11').Value := sName;
                  Parameters.ParamByName('N12').Value := sLprCarNo1;
                  Parameters.ParamByName('N13').Value := 5;
                  Parameters.ParamByName('N14').Value := sLprFile1;
                  Parameters.ParamByName('N15').Value := sLprCarNo2;
                  Parameters.ParamByName('N16').Value := sLprFile2;
                  Parameters.ParamByName('N17').Value := sCardNo;
                  ExecSQL;
                end;
              end;
              bHomeInfo:= False;
              DspProc(1, 1, '사용시간위반' + MG_Left(sCarNo, 12), sDspIP);
              Result := '1' + Result + 'WP위반';
              ExceptLogging('##### 사용시간대(WP) 위반 #####');
              if not bMode then
              begin
                if nBackData = 1 then
                begin
                  ExceptLogging('후방데이터 차단기 동작안함');
                end
                else
                begin
                  InOpen(csLPR);
                end;
              end;
            end;
          end
          else if nInOut = 2 then // 출구용
          begin
            if ((nSYoil <= DayOfWeek(Now)) and (nEYoil >= DayOfWeek(Now)) and
                (sSTime <= FormatDateTime('HH:NN', Now)) and
                (sETime >= FormatDateTime('HH:NN', Now))) then
            begin
              Case nStatus of
                0:
                  begin // 발매
                    if not bMonitoring  then
                    begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add(
                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');

                        // APB가 "1회조정(2)" 이면 APB를 "자동(1)"으로 변경한다.
                        if nAPB = 2 then
                          SQL.Add(', APB = :N10 ');

                        SQL.Add(
                          'where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;       // 최종사용상태: 외부
                        Parameters.ParamByName('N6').Value := 1;       // 상태: 사용중
                        Parameters.ParamByName('N7').Value := nParkNo;
                        Parameters.ParamByName('N8').Value := 2;
                        Parameters.ParamByName('N9').Value := sCarNo;

                        if nAPB = 2 then
                          Parameters.ParamByName('N10').Value := 1;
                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                        SQL.Add(
                          'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                        SQL.Add(
                          'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                        SQL.Add(
                          'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) '
                          );
                        SQL.Add(
                          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                        SQL.Add(
                          ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 2;
                        Parameters.ParamByName('N6').Value := 2;
                        Parameters.ParamByName('N7').Value := nGroupNo;
                        Parameters.ParamByName('N8').Value := sGroupName;
                        Parameters.ParamByName('N9').Value := sCompName;
                        Parameters.ParamByName('N10').Value := sDeptName;
                        Parameters.ParamByName('N11').Value := sName;
                        Parameters.ParamByName('N12').Value := sCarNo;
                        Parameters.ParamByName('N13').Value := 1;
                        Parameters.ParamByName('N14').Value := '';
                        Parameters.ParamByName('N15').Value := nUnitNo;
                        Parameters.ParamByName('N16').Value := sLprDate;
                        Parameters.ParamByName('N17').Value := sLprTime;
                        Parameters.ParamByName('N18').Value := sLprFile1;
                        Parameters.ParamByName('N19').Value := sLprCarNo1;
                        Parameters.ParamByName('N20').Value := 2;
                        Parameters.ParamByName('N21').Value := sLprFile2;
                        Parameters.ParamByName('N22').Value := sLprCarNo2;
                        Parameters.ParamByName('N23').Value := sCardNo;
                        ExecSQL;
                      end;
  //
                      if bOpen then
                        OutOpen(csLPR);
                    end;

                    DspProc(2, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                    Result := '2' + Result + '출 차';
                  end;

                1, 4:
                  begin // 사용중, 입차봉쇄
                    if nAPB = 1 then // 자동
                    begin
                      if (nLastStatus = 2) or (nLastStatus = 9) then
                      // 외부, APB위반 출차거부
                      begin
                        if not bMonitoring  then
                        begin
                          with qryRecvLpr2 do
                          begin
                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                            SQL.Add(
                              'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                            SQL.Add(
                              'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 8;
                            Parameters.ParamByName('N6').Value := 1;
                            Parameters.ParamByName('N7').Value := nParkNo;
                            Parameters.ParamByName('N8').Value := 2;
                            Parameters.ParamByName('N9').Value := sCarNo;
                            ExecSQL;

                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                            SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                            Parameters.ParamByName('N1').Value := sCarNo;
                            Parameters.ParamByName('N2').Value := sCarNo;
                            Open;

                            if RecordCount > 0 then
                            begin
                              First;

                              if FieldByName('OutDate').AsString = '' then
                              begin
                                // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                                sSCInDate := FieldByName('ProcDate').AsString;
                                sSCInTime := FieldByName('ProcTime').AsString;
                                nLastUnitNo := FieldByName('UnitNo').AsInteger;
                                sInFile := FieldByName('InImage1').AsString;

                                Close;
                                SQL.Clear;
                                SQL.Add(
                                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                                SQL.Add(
                                  'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                                SQL.Add(
                                  'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                                SQL.Add(
                                  'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                                Parameters.ParamByName('N1').Value := nUnitNo;
                                Parameters.ParamByName('N2').Value := sLprDate;
                                Parameters.ParamByName('N3').Value := sLprTime;
                                Parameters.ParamByName('N4').Value := 8;
                                Parameters.ParamByName('N5').Value := sLprFile1;
                                Parameters.ParamByName('N6').Value := sLprCarNo1;
                                Parameters.ParamByName('N7').Value := sCarNo;
                                Parameters.ParamByName('N8').Value := sSCInDate;
                                Parameters.ParamByName('N9').Value := sSCInTime;
                                Parameters.ParamByName('N10').Value :=
                                  nLastUnitNo;
                                Parameters.ParamByName('N11').Value := sCarNo;
                                Parameters.ParamByName('N12').Value := sLprFile2;
                                Parameters.ParamByName('N13').Value := sLprCarNo2;
                                ExecSQL;
                              end
                              else
                              begin
                                // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                                Close;
                                SQL.Clear;
                                SQL.Add(
                                  'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                                SQL.Add(
                                  'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                                SQL.Add(
                                  'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                                SQL.Add(
                                  'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                                SQL.Add(
                                  'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                                SQL.Add(
                                  ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                                Parameters.ParamByName('N1').Value := nParkNo;
                                Parameters.ParamByName('N2').Value := nUnitNo;
                                Parameters.ParamByName('N3').Value := sLprDate;
                                Parameters.ParamByName('N4').Value := sLprTime;
                                Parameters.ParamByName('N5').Value := 2;
                                Parameters.ParamByName('N6').Value := 2;
                                Parameters.ParamByName('N7').Value := nGroupNo;
                                Parameters.ParamByName('N8').Value := sGroupName;
                                Parameters.ParamByName('N9').Value := sCompName;
                                Parameters.ParamByName('N10').Value := sDeptName;
                                Parameters.ParamByName('N11').Value := sName;
                                Parameters.ParamByName('N12').Value := sCarNo;
                                Parameters.ParamByName('N13').Value := 8;
                                Parameters.ParamByName('N14').Value := '';
                                Parameters.ParamByName('N15').Value := nUnitNo;
                                Parameters.ParamByName('N16').Value := sLprDate;
                                Parameters.ParamByName('N17').Value := sLprTime;
                                Parameters.ParamByName('N18').Value := sLprFile1;
                                Parameters.ParamByName('N19').Value := sLprCarNo1;
                                Parameters.ParamByName('N20').Value := 8;
                                Parameters.ParamByName('N21').Value := sLprFile2;
                                Parameters.ParamByName('N22').Value := sLprCarNo2;
                                Parameters.ParamByName('N23').Value := sCardNo;
                                ExecSQL;
                              end;
                            end;
                          end;
                        end;
                        bHomeInfo:= False;
                        Result := '2' + Result + 'APB위반';
                        DspProc(2, 1, 'APB위반차량 ' + MG_Left(sCarNo, 12), sDspIP);
                        if not bMode then
                        begin
                          OutOpen(csLPR);
                        end;
                      end
                      else
                      begin
                        if not bMonitoring  then
                        begin
                          with qryRecvLpr2 do
                          begin
                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                            SQL.Add(
                              'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                            SQL.Add(
                              'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 1;
                            Parameters.ParamByName('N7').Value := nParkNo;
                            Parameters.ParamByName('N8').Value := 2;
                            Parameters.ParamByName('N9').Value := sCarNo;
                            ExecSQL;

                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                            SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                            Parameters.ParamByName('N1').Value := sCarNo;
                            Parameters.ParamByName('N2').Value := sCarNo;
                            Open;

                            if RecordCount > 0 then
                            begin
                              First;

                              if FieldByName('OutDate').AsString = '' then
                              begin
                                // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                                sSCInDate := FieldByName('ProcDate').AsString;
                                sSCInTime := FieldByName('ProcTime').AsString;
                                nLastUnitNo := FieldByName('UnitNo').AsInteger;
                                sInFile := FieldByName('InImage1').AsString;

                                Close;
                                SQL.Clear;
                                SQL.Add(
                                  'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                                SQL.Add(
                                  'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :12, OutCarNo2 = :N13 ');
                                SQL.Add(
                                  'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                                SQL.Add(
                                  'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                                Parameters.ParamByName('N1').Value := nUnitNo;
                                Parameters.ParamByName('N2').Value := sLprDate;
                                Parameters.ParamByName('N3').Value := sLprTime;
                                Parameters.ParamByName('N4').Value := 2;
                                Parameters.ParamByName('N5').Value := sLprFile1;
                                Parameters.ParamByName('N6').Value := sLprCarNo1;
                                Parameters.ParamByName('N7').Value := sCarNo;
                                Parameters.ParamByName('N8').Value := sSCInDate;
                                Parameters.ParamByName('N9').Value := sSCInTime;
                                Parameters.ParamByName('N10').Value := nLastUnitNo;
                                Parameters.ParamByName('N11').Value := sCarNo;
                                Parameters.ParamByName('N12').Value := sLprFile2;
                                Parameters.ParamByName('N13').Value := sLprCarNo2;
                                ExecSQL;
                              end
                              else
                              begin
                                // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                                Close;
                                SQL.Clear;
                                SQL.Add(
                                  'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                                SQL.Add(
                                  'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                                SQL.Add(
                                  'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                                SQL.Add(
                                  'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                                SQL.Add(
                                  'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                                SQL.Add(
                                  ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                                Parameters.ParamByName('N1').Value := nParkNo;
                                Parameters.ParamByName('N2').Value := nUnitNo;
                                Parameters.ParamByName('N3').Value := sLprDate;
                                Parameters.ParamByName('N4').Value := sLprTime;
                                Parameters.ParamByName('N5').Value := 2;
                                Parameters.ParamByName('N6').Value := 2;
                                Parameters.ParamByName('N7').Value := nGroupNo;
                                Parameters.ParamByName('N8').Value := sGroupName;
                                Parameters.ParamByName('N9').Value := sCompName;
                                Parameters.ParamByName('N10').Value := sDeptName;
                                Parameters.ParamByName('N11').Value := sName;
                                Parameters.ParamByName('N12').Value := sCarNo;
                                Parameters.ParamByName('N13').Value := 1;
                                Parameters.ParamByName('N14').Value := '';
                                Parameters.ParamByName('N15').Value := nUnitNo;
                                Parameters.ParamByName('N16').Value := sLprDate;
                                Parameters.ParamByName('N17').Value := sLprTime;
                                Parameters.ParamByName('N18').Value := sLprFile1;
                                Parameters.ParamByName('N19').Value := sLprCarNo1;
                                Parameters.ParamByName('N20').Value := 2;
                                Parameters.ParamByName('N21').Value := sLprFile2;
                                Parameters.ParamByName('N22').Value := sLprCarNo2;
                                Parameters.ParamByName('N23').Value := sCardNo;
                                ExecSQL;
                              end;
                            end;
                          end;
                        end;

                        if not bMonitoring then
                        begin
                          if bOpen then
                            OutOpen(csLPR);
                        end;
//
                        DspProc(2, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                        Result := '2' + Result + '출 차';
                      end
                    end
                    else if nAPB = 2 then // 1회조정
                    begin
                      if not bMonitoring  then
                      begin
                        with qryRecvLpr2 do
                        begin
                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                          SQL.Add(
                            'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, Status = :N6 ');
                          SQL.Add(
                            'APB = :N10 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 1;
                          Parameters.ParamByName('N7').Value := nParkNo;
                          Parameters.ParamByName('N8').Value := 2;
                          Parameters.ParamByName('N9').Value := sCarNo;
                          Parameters.ParamByName('N10').Value := 1;
                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                          SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                          Parameters.ParamByName('N1').Value := sCarNo;
                          Parameters.ParamByName('N2').Value := sCarNo;
                          Open;

                          if RecordCount > 0 then
                          begin
                            First;

                            if FieldByName('OutDate').AsString = '' then
                            begin
                              // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                              sSCInDate := FieldByName('ProcDate').AsString;
                              sSCInTime := FieldByName('ProcTime').AsString;
                              nLastUnitNo := FieldByName('UnitNo').AsInteger;
                              sInFile := FieldByName('InImage1').AsString;

                              Close;
                              SQL.Clear;
                              SQL.Add(
                                'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                              SQL.Add(
                                'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                              SQL.Add(
                                'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                              SQL.Add(
                                'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                              Parameters.ParamByName('N1').Value := nUnitNo;
                              Parameters.ParamByName('N2').Value := sLprDate;
                              Parameters.ParamByName('N3').Value := sLprTime;
                              Parameters.ParamByName('N4').Value := 2;
                              Parameters.ParamByName('N5').Value := sLprFile1;
                              Parameters.ParamByName('N6').Value := sLprCarNo1;
                              Parameters.ParamByName('N7').Value := sCarNo;
                              Parameters.ParamByName('N8').Value := sSCInDate;
                              Parameters.ParamByName('N9').Value := sSCInTime;
                              Parameters.ParamByName('N10').Value := nLastUnitNo;
                              Parameters.ParamByName('N11').Value := sCarNo;
                              Parameters.ParamByName('N12').Value := sLprFile2;
                              Parameters.ParamByName('N13').Value := sLprCarNo2;
                              ExecSQL;
                            end
                            else
                            begin
                              // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                              Close;
                              SQL.Clear;
                              SQL.Add(
                                'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                              SQL.Add(
                                'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                              SQL.Add(
                                'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                              SQL.Add(
                                'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                              SQL.Add(
                                'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                              SQL.Add(
                                ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                              Parameters.ParamByName('N1').Value := nParkNo;
                              Parameters.ParamByName('N2').Value := nUnitNo;
                              Parameters.ParamByName('N3').Value := sLprDate;
                              Parameters.ParamByName('N4').Value := sLprTime;
                              Parameters.ParamByName('N5').Value := 2;
                              Parameters.ParamByName('N6').Value := 2;
                              Parameters.ParamByName('N7').Value := nGroupNo;
                              Parameters.ParamByName('N8').Value := sGroupName;
                              Parameters.ParamByName('N9').Value := sCompName;
                              Parameters.ParamByName('N10').Value := sDeptName;
                              Parameters.ParamByName('N11').Value := sName;
                              Parameters.ParamByName('N12').Value := sCarNo;
                              Parameters.ParamByName('N13').Value := 1;
                              Parameters.ParamByName('N14').Value := '';
                              Parameters.ParamByName('N15').Value := nUnitNo;
                              Parameters.ParamByName('N16').Value := sLprDate;
                              Parameters.ParamByName('N17').Value := sLprTime;
                              Parameters.ParamByName('N18').Value := sLprFile1;
                              Parameters.ParamByName('N19').Value := sLprCarNo1;
                              Parameters.ParamByName('N20').Value := 2;
                              Parameters.ParamByName('N21').Value := sLprFile2;
                              Parameters.ParamByName('N22').Value := sLprCarNo2;
                              Parameters.ParamByName('N23').Value := sCardNo;
                              ExecSQL;
                            end;
                          end;
                        end;

                        if bOpen then
                          OutOpen(csLPR);
                      end;
//
                      DspProc(2, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                      Result := '2' + Result + '출 차';
                    end
                    else if nAPB = 3 then // 사용안함
                    begin
                      if not bMonitoring  then
                      begin
                        with qryRecvLpr2 do
                        begin
                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                          SQL.Add(
                            'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5, ');
                          SQL.Add(
                            'Status = :N6 where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                          Parameters.ParamByName('N1').Value := nParkNo;
                          Parameters.ParamByName('N2').Value := nUnitNo;
                          Parameters.ParamByName('N3').Value := sLprDate;
                          Parameters.ParamByName('N4').Value := sLprTime;
                          Parameters.ParamByName('N5').Value := 2;
                          Parameters.ParamByName('N6').Value := 1;
                          Parameters.ParamByName('N7').Value := nParkNo;
                          Parameters.ParamByName('N8').Value := 2;
                          Parameters.ParamByName('N9').Value := sCarNo;
                          ExecSQL;

                          Close;
                          SQL.Clear;
                          SQL.Add(
                            'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                          SQL.Add('Order By ProcDate Desc, ProcTime Desc');
                          Parameters.ParamByName('N1').Value := sCarNo;
                          Parameters.ParamByName('N2').Value := sCarNo;
                          Open;

                          if RecordCount > 0 then
                          begin
                            First;

                            if FieldByName('OutDate').AsString = '' then
                            begin
                              // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                              sSCInDate := FieldByName('ProcDate').AsString;
                              sSCInTime := FieldByName('ProcTime').AsString;
                              nLastUnitNo := FieldByName('UnitNo').AsInteger;
                              sInFile := FieldByName('InImage1').AsString;

                              Close;
                              SQL.Clear;
                              SQL.Add(
                                'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                              SQL.Add(
                                'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                              SQL.Add(
                                'where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                              SQL.Add(
                                'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                              Parameters.ParamByName('N1').Value := nUnitNo;
                              Parameters.ParamByName('N2').Value := sLprDate;
                              Parameters.ParamByName('N3').Value := sLprTime;
                              Parameters.ParamByName('N4').Value := 2;
                              Parameters.ParamByName('N5').Value := sLprFile1;
                              Parameters.ParamByName('N6').Value := sLprCarNo1;
                              Parameters.ParamByName('N7').Value := sCarNo;
                              Parameters.ParamByName('N8').Value := sSCInDate;
                              Parameters.ParamByName('N9').Value := sSCInTime;
                              Parameters.ParamByName('N10').Value := nLastUnitNo;
                              Parameters.ParamByName('N11').Value := sCarNo;
                              Parameters.ParamByName('N12').Value := sLprFile2;
                              Parameters.ParamByName('N13').Value := sLprCarNo2;
                              ExecSQL;
                            end
                            else
                            begin
                              // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                              Close;
                              SQL.Clear;
                              SQL.Add(
                                'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                              SQL.Add(
                                'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                              SQL.Add(
                                'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                              SQL.Add(
                                'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                              SQL.Add(
                                'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                              SQL.Add(
                                ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                              Parameters.ParamByName('N1').Value := nParkNo;
                              Parameters.ParamByName('N2').Value := nUnitNo;
                              Parameters.ParamByName('N3').Value := sLprDate;
                              Parameters.ParamByName('N4').Value := sLprTime;
                              Parameters.ParamByName('N5').Value := 2;
                              Parameters.ParamByName('N6').Value := 2;
                              Parameters.ParamByName('N7').Value := nGroupNo;
                              Parameters.ParamByName('N8').Value := sGroupName;
                              Parameters.ParamByName('N9').Value := sCompName;
                              Parameters.ParamByName('N10').Value := sDeptName;
                              Parameters.ParamByName('N11').Value := sName;
                              Parameters.ParamByName('N12').Value := sCarNo;
                              Parameters.ParamByName('N13').Value := 1;
                              Parameters.ParamByName('N14').Value := '';
                              Parameters.ParamByName('N15').Value := nUnitNo;
                              Parameters.ParamByName('N16').Value := sLprDate;
                              Parameters.ParamByName('N17').Value := sLprTime;
                              Parameters.ParamByName('N18').Value := sLprFile1;
                              Parameters.ParamByName('N19').Value := sLprCarNo1;
                              Parameters.ParamByName('N20').Value := 2;
                              Parameters.ParamByName('N21').Value := sLprFile2;
                              Parameters.ParamByName('N22').Value := sLprCarNo2;
                              Parameters.ParamByName('N23').Value := sCardNo;
                              ExecSQL;
                            end;
                          end;
                        end;

                        // 바오픈
                        if bOpen then
                          OutOpen(csLPR);
                      end;

//                       전광판 긴급문구 표출
                      DspProc(2, 1, sDisplayText + MG_Left(sCarNo, 12), sDspIP);
                      Result := '2' + Result + '출 차';
                    end;
                  end;

                3, 5:
                  begin // 전체봉쇄, 출차봉쇄
                    if not bMonitoring  then
                    begin
                      with qryRecvLpr2 do
                      begin
                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                        SQL.Add(
                          'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                        SQL.Add(
                          'where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
                        Parameters.ParamByName('N1').Value := nParkNo;
                        Parameters.ParamByName('N2').Value := nUnitNo;
                        Parameters.ParamByName('N3').Value := sLprDate;
                        Parameters.ParamByName('N4').Value := sLprTime;
                        Parameters.ParamByName('N5').Value := 10;
                        Parameters.ParamByName('N6').Value := nParkNo;
                        Parameters.ParamByName('N7').Value := 2;
                        Parameters.ParamByName('N8').Value := sCarNo;
                        ExecSQL;

                        Close;
                        SQL.Clear;
                        SQL.Add(
                          'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) ');
                        SQL.Add('Order By InDate Desc, InTime Desc');
                        Parameters.ParamByName('N1').Value := sCarNo;
                        Parameters.ParamByName('N2').Value := sCarNo;
                        Open;

                        if RecordCount > 0 then
                        begin
                          First;

                          if FieldByName('OutDate').AsString = '' then
                          begin
                            // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                            sSCInDate := FieldByName('ProcDate').AsString;
                            sSCInTime := FieldByName('ProcTime').AsString;
                            nLastUnitNo := FieldByName('UnitNo').AsInteger;
                            sInFile := FieldByName('InImage1').AsString;

                            Close;
                            SQL.Clear;
                            SQL.Add('Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                            SQL.Add('OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                            SQL.Add('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                            SQL.Add('ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                            Parameters.ParamByName('N1').Value := nUnitNo;
                            Parameters.ParamByName('N2').Value := sLprDate;
                            Parameters.ParamByName('N3').Value := sLprTime;
                            Parameters.ParamByName('N4').Value := 10;
                            Parameters.ParamByName('N5').Value := sLprFile1;
                            Parameters.ParamByName('N6').Value := sLprCarNo1;
                            Parameters.ParamByName('N7').Value := sCarNo;
                            Parameters.ParamByName('N8').Value := sSCInDate;
                            Parameters.ParamByName('N9').Value := sSCInTime;
                            Parameters.ParamByName('N10').Value := nLastUnitNo;
                            Parameters.ParamByName('N11').Value := sCarNo;
                            Parameters.ParamByName('N12').Value := sLprFile2;
                            Parameters.ParamByName('N13').Value := sLprCarNo2;
                            ExecSQL;
                          end
                          else
                          begin
                            // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                            Close;
                            SQL.Clear;
                            SQL.Add(
                              'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                            SQL.Add(
                              'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                            SQL.Add(
                              'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                            SQL.Add(
                              'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                            SQL.Add(
                              'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                            SQL.Add(
                              ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                            Parameters.ParamByName('N1').Value := nParkNo;
                            Parameters.ParamByName('N2').Value := nUnitNo;
                            Parameters.ParamByName('N3').Value := sLprDate;
                            Parameters.ParamByName('N4').Value := sLprTime;
                            Parameters.ParamByName('N5').Value := 2;
                            Parameters.ParamByName('N6').Value := 2;
                            Parameters.ParamByName('N7').Value := nGroupNo;
                            Parameters.ParamByName('N8').Value := sGroupName;
                            Parameters.ParamByName('N9').Value := sCompName;
                            Parameters.ParamByName('N10').Value := sDeptName;
                            Parameters.ParamByName('N11').Value := sName;
                            Parameters.ParamByName('N12').Value := sCarNo;
                            Parameters.ParamByName('N13').Value := 10;
                            Parameters.ParamByName('N14').Value := '';
                            Parameters.ParamByName('N15').Value := nUnitNo;
                            Parameters.ParamByName('N16').Value := sLprDate;
                            Parameters.ParamByName('N17').Value := sLprTime;
                            Parameters.ParamByName('N18').Value := sLprFile1;
                            Parameters.ParamByName('N19').Value := sLprCarNo1;
                            Parameters.ParamByName('N20').Value := 10;
                            Parameters.ParamByName('N21').Value := sLprFile2;
                            Parameters.ParamByName('N22').Value := sLprCarNo2;
                            Parameters.ParamByName('N23').Value := sCardNo;
                            ExecSQL;
                          end;
                        end;
                      end;
                    end;
                    bHomeInfo:= False;
                    Result := '2' + Result + '봉쇄중';
                    DspProc(2, 1, '  봉쇄차량  ' + MG_Left(sCarNo, 12), sDspIP);
                    ExceptLogging('##### 전체 또는 출차봉쇄 카드(출차) #####');
                    if not bMode then
                    begin
                      OutOpen(csLPR);
                    end;
                  end;
              end;
            end
            else
            begin
              if not bMonitoring  then
              begin
                with qryRecvLpr2 do
                begin
                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
                  SQL.Add(
                    'LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
                  SQL.Add('where ParkNo = :N7 and TKType = :N8 and CarNo = :N9');
                  Parameters.ParamByName('N1').Value := nParkNo;
                  Parameters.ParamByName('N2').Value := nUnitNo;
                  Parameters.ParamByName('N3').Value := sLprDate;
                  Parameters.ParamByName('N4').Value := sLprTime;
                  Parameters.ParamByName('N5').Value := 6;
                  Parameters.ParamByName('N7').Value := nParkNo;
                  Parameters.ParamByName('N8').Value := 2;
                  Parameters.ParamByName('N9').Value := sCarNo;
                  ExecSQL;

                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) Order By ProcDate Desc, ProcTime Desc');
                  Parameters.ParamByName('N1').Value := sCarNo;
                  Parameters.ParamByName('N2').Value := sCarNo;
                  Open;

                  if RecordCount > 0 then
                  begin
                    First;

                    if FieldByName('OutDate').AsString = '' then
                    begin
                      // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                      sSCInDate := FieldByName('ProcDate').AsString;
                      sSCInTime := FieldByName('ProcTime').AsString;
                      nLastUnitNo := FieldByName('UnitNo').AsInteger;
                      sInFile := FieldByName('InImage1').AsString;

                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                      SQL.Add(
                        'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                      SQL.Add
                        ('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                      SQL.Add(
                        'ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                      Parameters.ParamByName('N1').Value := nUnitNo;
                      Parameters.ParamByName('N2').Value := sLprDate;
                      Parameters.ParamByName('N3').Value := sLprTime;
                      Parameters.ParamByName('N4').Value := 6;
                      Parameters.ParamByName('N5').Value := sLprFile1;
                      Parameters.ParamByName('N6').Value := sLprCarNo1;
                      Parameters.ParamByName('N7').Value := sCarNo;
                      Parameters.ParamByName('N8').Value := sSCInDate;
                      Parameters.ParamByName('N9').Value := sSCInTime;
                      Parameters.ParamByName('N10').Value := nLastUnitNo;
                      Parameters.ParamByName('N11').Value := sCarNo;
                      Parameters.ParamByName('N12').Value := sLprFile2;
                      Parameters.ParamByName('N13').Value := sLprCarNo2;
                      ExecSQL;
                    end
                    else
                    begin
                      // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                      Close;
                      SQL.Clear;
                      SQL.Add(
                        'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                      SQL.Add(
                        'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                      SQL.Add(
                        'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                      SQL.Add(
                        'OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                      SQL.Add(
                        'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                      SQL.Add(
                        ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                      Parameters.ParamByName('N1').Value := nParkNo;
                      Parameters.ParamByName('N2').Value := nUnitNo;
                      Parameters.ParamByName('N3').Value := sLprDate;
                      Parameters.ParamByName('N4').Value := sLprTime;
                      Parameters.ParamByName('N5').Value := 2;
                      Parameters.ParamByName('N6').Value := 2;
                      Parameters.ParamByName('N7').Value := nGroupNo;
                      Parameters.ParamByName('N8').Value := sGroupName;
                      Parameters.ParamByName('N9').Value := sCompName;
                      Parameters.ParamByName('N10').Value := sDeptName;
                      Parameters.ParamByName('N11').Value := sName;
                      Parameters.ParamByName('N12').Value := sCarNo;
                      Parameters.ParamByName('N13').Value := 6;
                      Parameters.ParamByName('N14').Value := '';
                      Parameters.ParamByName('N15').Value := nUnitNo;
                      Parameters.ParamByName('N16').Value := sLprDate;
                      Parameters.ParamByName('N17').Value := sLprTime;
                      Parameters.ParamByName('N18').Value := sLprFile1;
                      Parameters.ParamByName('N19').Value := sLprCarNo1;
                      Parameters.ParamByName('N20').Value := 6;
                      Parameters.ParamByName('N21').Value := sLprFile2;
                      Parameters.ParamByName('N22').Value := sLprCarNo2;
                      Parameters.ParamByName('N23').Value := sCardNo;
                      ExecSQL;
                    end;
                  end;
                end;
              end;
              bHomeInfo:= False;
              Result := '2' + Result + '시간위반';
              DspProc(2, 1, '사용시간위반' + MG_Left(sCarNo, 12), sDspIP);
              ExceptLogging('##### 사용시간대(WP) 위반(출차) #####');
              if not bMode then
              begin
                OutOpen(csLPR);
              end;
            end;
          end;

          //if bHomeInfo then
          //  HomeInfo_Proc(nInOut);
        end
        else
        begin
          if not bMonitoring  then
          begin
          // 카드사용기간 오류처리..
            with qryRecvLpr2 do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
              SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
              SQL.Add('where ParkNo = :N6 and TKType = :N7 and CarNo = :N8');
              Parameters.ParamByName('N1').Value := nParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := sLprDate;
              Parameters.ParamByName('N4').Value := sLprTime;
              Parameters.ParamByName('N5').Value := 3;
              Parameters.ParamByName('N6').Value := nParkNo;
              Parameters.ParamByName('N7').Value := 2;
              Parameters.ParamByName('N8').Value := sCarNo;
              ExecSQL;

              Close;
              SQL.Clear;
              SQL.Add(
                'Select * from IOSData where ((InCarNo1 = :N1) or (InCarNo2 = :N2)) Order By ProcDate Desc, ProcTime Desc');
              Parameters.ParamByName('N1').Value := sCarNo;
              Parameters.ParamByName('N2').Value := sCarNo;
              Open;

              if RecordCount > 0 then
              begin
                First;

                if FieldByName('OutDate').AsString = '' then
                begin
                  // 최종입차후 출차되지 않은 자료가 있다. 이때는 출차일시 자료를 Update한다.
                  sSCInDate := FieldByName('ProcDate').AsString;
                  sSCInTime := FieldByName('ProcTime').AsString;
                  nLastUnitNo := FieldByName('UnitNo').AsInteger;
                  sInFile := FieldByName('InImage1').AsString;

                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Update IOSData Set OutUnitNo = :N1, OutDate = :N2, OutTime = :N3, ');
                  SQL.Add(
                    'OutIOStatusNo = :N4, OutImage1 = :N5, OutCarNo1 = :N6, OutImage2 = :N12, OutCarNo2 = :N13 ');
                  SQL.Add('where ((InCarNo1 = :N7) or (InCarNo2 = :N11)) and ');
                  SQL.Add('ProcDate = :N8 and ProcTime = :N9 and UnitNo = :N10');
                  Parameters.ParamByName('N1').Value := nUnitNo;
                  Parameters.ParamByName('N2').Value := sLprDate;
                  Parameters.ParamByName('N3').Value := sLprTime;
                  Parameters.ParamByName('N4').Value := 3;
                  Parameters.ParamByName('N5').Value := sLprFile1;
                  Parameters.ParamByName('N6').Value := sLprCarNo1;
                  Parameters.ParamByName('N7').Value := sCarNo;
                  Parameters.ParamByName('N8').Value := sSCInDate;
                  Parameters.ParamByName('N9').Value := sSCInTime;
                  Parameters.ParamByName('N10').Value := nLastUnitNo;
                  Parameters.ParamByName('N11').Value := sCarNo;
                  Parameters.ParamByName('N12').Value := sLprFile2;
                  Parameters.ParamByName('N13').Value := sLprCarNo2;
                  ExecSQL;
                end
                else
                begin
                  // 최종입차된 자료가 없다.  이때는 출차자료를 입차자료와 동일하게 Insert한다.
                  Close;
                  SQL.Clear;
                  SQL.Add(
                    'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKType, ');
                  SQL.Add(
                    'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, ');
                  SQL.Add(
                    'InIOStatusNo, InImage1, OutUnitNo, OutDate, OutTime, OutImage1, ');
                  SQL.Add
                    ('OutCarNo1, OutIOStatusNo, OutImage2, OutCarNo2, TKNo) ');
                  SQL.Add(
                    'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, ');
                  SQL.Add(
                    ':N12, :N13, :N14, :N15, :N16, :N17, :N18, :N19, :N20, :N21, :N22, :N23)');
                  Parameters.ParamByName('N1').Value := nParkNo;
                  Parameters.ParamByName('N2').Value := nUnitNo;
                  Parameters.ParamByName('N3').Value := sLprDate;
                  Parameters.ParamByName('N4').Value := sLprTime;
                  Parameters.ParamByName('N5').Value := 2;
                  Parameters.ParamByName('N6').Value := 2;
                  Parameters.ParamByName('N7').Value := nGroupNo;
                  Parameters.ParamByName('N8').Value := sGroupName;
                  Parameters.ParamByName('N9').Value := sCompName;
                  Parameters.ParamByName('N10').Value := sDeptName;
                  Parameters.ParamByName('N11').Value := sName;
                  Parameters.ParamByName('N12').Value := sCarNo;
                  Parameters.ParamByName('N13').Value := 3;
                  Parameters.ParamByName('N14').Value := '';
                  Parameters.ParamByName('N15').Value := nUnitNo;
                  Parameters.ParamByName('N16').Value := sLprDate;
                  Parameters.ParamByName('N17').Value := sLprTime;
                  Parameters.ParamByName('N18').Value := sLprFile1;
                  Parameters.ParamByName('N19').Value := sLprCarNo1;
                  Parameters.ParamByName('N20').Value := 3;
                  Parameters.ParamByName('N21').Value := sLprFile2;
                  Parameters.ParamByName('N22').Value := sLprCarNo2;
                  Parameters.ParamByName('N23').Value := sCardNo;
                  ExecSQL;
                end;
              end;
            end;
          end;

          if nInOut = 1 then
          begin
            Result := '1' + Result + '기간만료';
            DspProc(1, 1, '사용기간위반' + MG_Left(sCarNo, 12), sDspIP);
          end
          else if nInOut = 2 then
          begin
            Result := '2' + Result + '기간만료';
            DspProc(2, 1, '사용기간위반' + MG_Left(sCarNo, 12), sDspIP);
          end;
          ExceptLogging('##### 사용기간 오류 - 사용시작일: ' + sExpDateF + ', 사용종료일: ' +
              sExpDateT + ' #####');
          if not bMode then
          begin
            OutOpen(csLPR);
          end;
        end;

        //이미지 로드부분 맨 뒤로
        try
          // Lpr 파일1이 있으면
          if FileExists(sLprFile1) then
          begin
            // 입차
            if nInOut = 1 then
            begin
              with frmMain do
              begin
                ExceptLogging('정기차량 입차 이미지 가져오기 시작');
                TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
                ExceptLogging('정기차량 입차 이미지 가져오기 끝');
              end;
            end
            // 출차
            else
            if nInOut = 2 then
            begin
              with frmMain do
              begin
                ExceptLogging('정기차량 출차 이미지 가져오기 시작');
                TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sLprFile1);
                ExceptLogging('정기차량 출차 이미지 가져오기 끝');
              end;
            end;
          end
          // 파일없으면
          else
          begin
            // 입차
            if nInOut = 1 then
            begin
              with frmMain do
              begin
                TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
              end;
            end
            // 출차
            else
            if nInOut = 2 then
            begin
              with frmMain do
              begin
                TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
              end;
            end;

            ExceptLogging('File 없음: ' + sLprFile1);
          end;
        except
          on E: Exception do
            ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
        end;

      end;
      ExceptLogging('정기차량처리: ' + sLprCarNo1 + ', ' + sLprCarNo2);
    except
      on E: Exception do
        ExceptLogging('RecvLprProc: ' + aString(E.Message));
    end;

  finally
    bSCProcWait := False;
  end;
end;


procedure TfrmMain.sgInDblClickCell(Sender: TObject; ARow, ACol: Integer);
var
  sTemp, sFileIP, sTempFile: aString;
begin
  if ARow > 0 then
  begin
    nGridCheck := 1;
    nModRow := ARow;

//    if (MG_StrTrim(sgIn.Cells[7, ARow], ' ') = '입차') then
//    begin
    if sgIn.Cells[0, ARow] <> '일반차량' then
    begin
      ShowMessage('일반차량의 차량번호만 수정이 가능합니다.');
      Exit;
    end;
    sOrgCarNo := MG_StrTrim(sgIn.Cells[3, ARow], ' ');
    sOrgDate := sgIn.Cells[1, ARow];
    sOrgTime := sgIn.Cells[2, ARow];
    edtMCarNo.Text := sOrgCarNo;

    with dmTables.qryTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add(
        'Select * from IONdata where ParkNo = :N1 and ((InCarNo1 = :N2) or ');
      SQL.Add('(InCarNo2 = :N3)) and ProcDate = :N4 and ProcTime = :N5');
      Parameters.ParamByName('N1').Value := nCurrParkNo;
      Parameters.ParamByName('N2').Value := sOrgCarNo;
      Parameters.ParamByName('N3').Value := sOrgCarNo;
      Parameters.ParamByName('N4').Value := sOrgDate;
      Parameters.ParamByName('N5').Value := sOrgTime;
      Open;

      if RecordCount > 0 then
      begin
        sOrgFile := FieldByName('InImage1').AsString;
        nOrgUnitNo := FieldByName('UnitNo').AsInteger;
      end;
    end;

    try
      if Copy(sOrgFile, 1, 4) = 'http' then
      begin
        sTemp := Copy(sOrgFile, 6, Length(sOrgFile) - 5);
        sTempFile := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
        sTempFile := sTempFile + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
            (sTemp) - (Pos(':9080', sTemp) + 4));
        sTempFile := MG_StrConvert(sTempFile, '/', '\');
        ExceptLogging('File: ' + sTempFile);
        sFileIP:= Copy(sTempFile, 3, Pos('\MSImage', sTempFile)-3);
      end
      else
      begin
        sTempFile :=sOrgFile ;
        sFileIP:= Copy(sTempFile, 3, Pos('\MSImage', sTempFile)-3);
      end;

      if is_ping(sFileIP) then
      begin
        if FileExists(sTempFile) then
        begin
          imgModify.Picture.LoadFromFile(sTempFile);
        end
        else
        begin
          imgModify.Picture.Assign(Nil);
          ExceptLogging('File 없음: ' + sTempFile);
        end;
      end
      else
      begin
        imgModify.Picture.Assign(Nil);
        ExceptLogging('File 없음: ' + sTempFile);
      end;
    except
      on E: Exception do
        ExceptLogging('sgInDblClickCell_ModifyImageLoad: ' + aString(E.Message));
    end;
    pnModify.Visible := True;
    edtMCarNo.SetFocus;
    edtMCarNo.SelectAll;
//    end
//    else
//      ShowMessage('입차 차량번호만 수정이 가능합니다.');
  end;
end;

procedure TfrmMain.ssHomeinfo_iconClientConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('ssHomeinfo_iconClientConnect : Connect');
  HomeInfoLogging('ssHomeinfo_iconClientConnect : ' +Socket.RemoteAddress + ' , ' + IntToStr(Socket.RemotePort) + '접속');
end;

procedure TfrmMain.ssHomeinfo_iconClientDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('ssHomeinfo_iconClientDisconnect : DisConnect');
  HomeInfoLogging('ssHomeinfo_iconClientDisconnect : ' +Socket.RemoteAddress + ' , ' + IntToStr(Socket.RemotePort) + '종료');
end;

procedure TfrmMain.ssHomeinfo_iconClientError(Sender: TObject;
  Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  HomeInfoLogging('ssHomeinfo_iconClientError : 에러코드 : [' + IntToStr(ErrorCode) + ']');
  ErrorCode := 0;
end;

procedure TfrmMain.ssHomeinfo_iconClientRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
  sRecvText, sSend : AnsiString;

begin
  HomeInfoLogging('tssServerMainClientRead : ' + Socket.RemoteAddress +  ' , ' + IntToStr(Socket.RemotePort) + '로 부터 요청전문 수신');
  sRecvText := Socket.ReceiveText;
  HomeInfoLogging('요청전문 : ['+ sRecvText + ']');

  sSend := AnsiString(ICon_RequestProcess(sRecvText));

end;

function TfrmMain.StringToDate(sString: string): TDateTime;
var
  sTempY, sTempM, sTempD, sTempH, sTempMm, sTempS : String; //임시 년월일시분초
  sTemp :String;
begin
  sTempY := Copy(sString,1,4);
  sTempM := Copy(sString,5,2);
  sTempD := Copy(sString,7,2);
  sTempH := Copy(sString,9,2);
  sTempMm := Copy(sString,11,2);
  Result := EncodeDateTime( StrToInt(sTempY), StrToInt(sTempM), StrToInt(sTempD), StrToInt(sTempH), StrToInt(sTempMm), 0, 0);
end;

procedure TfrmMain.ICMPReply(ASender: TComponent; const ReplyStatus: TReplyStatus);
begin
  case ReplyStatus.ReplyStatusType of
    rsTimeOut:
      ping_success := False;
    rsErrorUnreachable:
      ping_success := False;
    rsEcho:
      ping_success := True;
  end;
end;

function TfrmMain.ICon_CheckVisit(nCarNo: String): Boolean;
var
  sStartDateTime, sEndDateTime : string;
  nPeriod : Integer;
begin
  try
    with dmTables.qryVisit do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select * from VisitInfo_iCon');
      SQL.Add(' where CarNo = :N1');
      Parameters.ParamByName('N1').Value := nCarNo;
      Open;

      if RecordCount > 0 then
      begin
        sStartDateTime := FieldByName('StartDateTime').Value;
        sStartDateTime := FormatDateTime('YYYY-MM-DD', StrToDate(Copy(sStartDateTime, 0, 10)));

        nPeriod := FieldByName('period').Value;

        if IncDay(StrToDate(sStartDateTime), nPeriod) > Now then
        begin
          sHomeInfo_Dong := FieldByName('Dong').AsString;        // 홈넷 동
          sHomeInfo_Ho   := FieldByName('Ho').AsString;          // 홈넷 호
          Result := True;
          exit;
        end;
        Result := False;
      end
      else
      begin
        Result := False;
      end;
    end
  except
    on E: Exception do
      ExceptLogging('TfrmMain.ICon_CheckVisit: ' + aString(E.Message));
  end;

end;

function TfrmMain.ICon_RequestProcess(sRecv: String): String;
var
//서비스 타입,   동작,   동,    호 ,  차량번호, 기한   , 등록일자
  sSerivceType ,sAction, sDong, sHo,  sCarNo,   sPeriod, sProcDateTime : String;
  xnChild : IXMLNode;
  xnGrandchild : IXMLNode;
  sGrandChild,stemp : String;

begin
  xmlRead.LoadFromXML(sRecv);

//  sRecv := '<?xml version="1.0" encoding="UTF-8"?> <imap ver="1.0" address="10.0.1.1" sender="valley"> <service type="request" name="car_guest_info">		<request_info name="homedev" id_high="101" id_low="202" type="main"></request_info> <action>"registration"</action> <params car_num="57부9718" period="1" date="null" message="null"></params> </service> </imap>';

  xnChild := xmlRead.DocumentElement.ChildNodes[0];
  sAction := xnChild.ChildNodes['action'].Text;         //동작

  xnGrandchild := xnChild.ChildNodes['request_info'];
  sDong :=  xnGrandchild.AttributeNodes.Get(1).NodeValue;
  sHo   :=  xnGrandchild.AttributeNodes.Get(2).NodeValue;
  HomeInfoLogging('action : sAction');
  if sAction = '"query"' then               //조회
  begin
    ICon_VisitListProcess(sDong, sHo);
  end
  else if sAction = '"registration"' then   //등록
  begin
    xnGrandchild  := xnChild.ChildNodes['params'];
    sCarNo        := xnGrandchild.AttributeNodes.Get(0).NodeValue;
    sPeriod       := xnGrandchild.AttributeNodes.Get(1).NodeValue;
    sProcDateTime := xnGrandchild.AttributeNodes.Get(2).NodeValue;
//    sProcDateTime := xnGrandchild.AttributeNodes.Get(1).NodeValue;
//    sPeriod       := xnGrandchild.AttributeNodes.Get(2).NodeValue;
    ICon_VisitAddRespone(sDong, sHo, sCarNo, sProcDateTime, sPeriod);
  end
  else if sAction = '"delete"' then         //삭제
  begin
    ICon_VisitDelProcess;
  end
  else
  begin
    //액션값 오류
  end;

  sGrandChild := xnGrandchild.AttributeNodes.Get(0).NodeValue;
  sGrandChild := sGrandChild+ xnGrandchild.AttributeNodes.Get(1).NodeValue;
  sGrandChild := sGrandChild+ xnGrandchild.AttributeNodes.Get(2).NodeValue;

end;

function TfrmMain.ICon_VisitAddRespone(sDong, sHo, sCarNo, sProcDateTime,
  sPeriod: String): String;
var
  xnRoot, xnChild, xnGrandchild : IXMLNode;
  sSend : String;
  nRoop : Integer;
begin
  try
  try

    with dmTables.qryVisitInsert do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Insert into VisitInfo_Icon (dong, ho, CarNo, StartDateTime, period) ' +
              'values(:pDong, :pHo, :pCarNo, :pStartDateTime, :pPeriod)');
      Parameters.ParamByName('pDong').Value := sDong;
      Parameters.ParamByName('pHo').Value := sHo;
      Parameters.ParamByName('pCarNo').Value := sCarNo;
      Parameters.ParamByName('pStartDateTime').Value := FormatDateTime('YYYY-MM-DD HH:MM:SS', Now);
      Parameters.ParamByName('pPeriod').Value := sPeriod;
      ExecSQL;

      xmlSend.Active := true;
      xmlSend.Encoding := 'utf-8';
      xnRoot := xmlSend.AddChild('imap');
      xnRoot.Attributes['ver']      := '1.0';
      xnRoot.Attributes['address']  := My_LocalIP;
      xnRoot.Attributes['sender']   := '주차관제';

      xnChild := xnRoot.AddChild('service');
      xnChild.Attributes['type']    := 'reply';
      xnChild.Attributes['name']    := 'car_guest_info';
      xnChild.Attributes['result']  := 'ok';

      xnGrandchild := xnChild.AddChild('request_info');
      xnGrandchild.Attributes['name']    := 'homedev';
      xnGrandchild.Attributes['id_high'] := sDong;
      xnGrandchild.Attributes['id_low']  := sHo;
      xnGrandchild.Attributes['type']    := 'main';

      xnGrandchild := xnChild.AddChild('action');
      xnGrandchild.NodeValue := '"registration"';

      with dmTables.qryVisitList do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select * from VisitInfo_Icon');
        SQL.Add(' where Dong = :N1 and Ho = :N2');
        Parameters.ParamByName('N1').Value := sDong;
        Parameters.ParamByName('N2').Value := sHo;
        SQL.Add(' order by StartDateTime desc');
        Open;
        if RecordCount > 0 then
        begin
          for nRoop := 1 to RecordCount do
          begin
            xnGrandchild := xnChild.AddChild('params');
            xnGrandchild.Attributes['car_num'] := FieldByName('CarNo').AsString;
            xnGrandchild.Attributes['period']  := FieldByName('period').AsString;
            xnGrandchild.Attributes['date']    := FieldByName('StartDateTime').AsString;
            xnGrandchild.Attributes['message'] := 'null';
            next;
          end;
        end;

        ExceptLogging('ICon_VisitAddRespone : 등록 응답 전문 생성 : ' + sSend);
      end;
    end;
  except
    on E: Exception do
    begin
      ExceptLogging('ICon_VisitAddRespone: ' + aString(E.Message));
      xmlSend.Active := true;
      xmlSend.Encoding := 'utf-8';
      xnRoot := xmlSend.AddChild('imap');
      xnRoot.Attributes['ver']      := '1.0';
      xnRoot.Attributes['address']  := My_LocalIP;
      xnRoot.Attributes['sender']   := '주차관제';

      xnChild := xnRoot.AddChild('service');
      xnChild.Attributes['type']    := 'reply';
      xnChild.Attributes['name']    := 'car_guest_info';
      xnChild.Attributes['result']  := 'fail';
    end;
  end;
  finally
    sSend := xmlSend.XML.Text;
    xmlSend.XML.Text := '';
    xmlSend.Active := false;
    ssHomeinfo_icon.Socket.Connections[0].SendText(sSend);
  end;

end;

function TfrmMain.ICon_VisitDelProcess : Integer;
var
  xnRoot, xnChild, xnGrandchild : IXMLNode;
  sDong, sHo, sCarNo, sPeriod, sProcDateTime, sSend : string;
  nRoop, nParamsCnt : Integer;

begin
  try
  try
    xnChild := xmlRead.DocumentElement.ChildNodes[0];
    xnGrandchild := xnChild.ChildNodes['request_info'];
    sDong        :=  xnGrandchild.AttributeNodes.Get(1).NodeValue;
    sHo          :=  xnGrandchild.AttributeNodes.Get(2).NodeValue;

    nParamsCnt := xnChild.ChildNodes.Count;

    for nRoop := 1 to nParamsCnt - 2 do         //request_info, action 때문에 2개를 제외함
    begin
      if nRoop = 1 then
      begin
        xnGrandchild := xnChild.ChildNodes['params'];
        sCarNo       :=  xnGrandchild.AttributeNodes.Get(0).NodeValue;
//        sProcDateTime:=  xnGrandchild.AttributeNodes.Get(1).NodeValue;
//        sPeriod      :=  xnGrandchild.AttributeNodes.Get(2).NodeValue;
        sPeriod      :=  xnGrandchild.AttributeNodes.Get(1).NodeValue;
        sProcDateTime:=  xnGrandchild.AttributeNodes.Get(2).NodeValue;
      end
      else
      begin
        xnGrandchild := xnChild.ChildNodes['params'].NextSibling;
        sCarNo       :=  xnGrandchild.AttributeNodes.Get(0).NodeValue;
//        sProcDateTime:=  xnGrandchild.AttributeNodes.Get(1).NodeValue;
//        sPeriod      :=  xnGrandchild.AttributeNodes.Get(2).NodeValue;
        sPeriod      :=  xnGrandchild.AttributeNodes.Get(1).NodeValue;
        sProcDateTime:=  xnGrandchild.AttributeNodes.Get(2).NodeValue;
      end;

      with dmTables.qryVisitDelete do
      begin
        Close;
        SQL.Clear;
        SQL.Add('delete from Visitinfo_icon where dong = :pDong and ho = :pHo and CarNo = :pCarNo' +
                ' and StartDateTime = :pStartDateTime and period = :pPeriod');
        Parameters.ParamByName('pDong').Value := sDong;
        Parameters.ParamByName('pHo').Value := sHo;
        Parameters.ParamByName('pCarNo').Value := sCarNo;
        Parameters.ParamByName('pStartDateTime').Value := sProcDateTime;
        Parameters.ParamByName('pPeriod').Value := sPeriod;
        ExecSQL;
      end;
    end;

    xmlSend.Active := true;
    xmlSend.Encoding := 'utf-8';
    xnRoot := xmlSend.AddChild('imap');
    xnRoot.Attributes['ver']      := '1.0';
    xnRoot.Attributes['address']  := My_LocalIP;
    xnRoot.Attributes['sender']   := '주차관제';

    xnChild := xnRoot.AddChild('service');
    xnChild.Attributes['type']    := 'reply';
    xnChild.Attributes['name']    := 'car_guest_info';
    xnChild.Attributes['result']  := 'ok';

    xnGrandchild := xnChild.AddChild('request_info');
    xnGrandchild.Attributes['name']    := 'homedev';
    xnGrandchild.Attributes['id_high'] := sDong;
    xnGrandchild.Attributes['id_low']  := sHo;
    xnGrandchild.Attributes['type']    := 'main';

    xnGrandchild := xnChild.AddChild('action');
    xnGrandchild.NodeValue := '"delete"';

    with dmTables.qryVisitList do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from VisitInfo_Icon');
      SQL.Add(' where Dong = :N1 and Ho = :N2');
      Parameters.ParamByName('N1').Value := sDong;
      Parameters.ParamByName('N2').Value := sHo;
      SQL.Add(' order by StartDateTime desc');
      Open;
      if RecordCount > 0 then
      begin
        for nRoop := 1 to RecordCount do
        begin
          xnGrandchild := xnChild.AddChild('params');
          xnGrandchild.Attributes['car_num'] := FieldByName('CarNo').AsString;
          xnGrandchild.Attributes['period']  := FieldByName('period').AsString;
          xnGrandchild.Attributes['date']    := FieldByName('StartDateTime').AsString;
          xnGrandchild.Attributes['message'] := 'null';
          next;
        end;
      end;
    end;

  except
    on E: Exception do
    begin
      ExceptLogging('ICon_VisitDelProcess: ' + aString(E.Message));
      xmlSend.Active := true;
      xmlSend.Encoding := 'utf-8';
      xnRoot := xmlSend.AddChild('imap');
      xnRoot.Attributes['ver']      := '1.0';
      xnRoot.Attributes['address']  := My_LocalIP;
      xnRoot.Attributes['sender']   := '주차관제';

      xnChild := xnRoot.AddChild('service');
      xnChild.Attributes['type']    := 'reply';
      xnChild.Attributes['name']    := 'car_guest_info';
      xnChild.Attributes['result']  := 'fail';
    end;
  end;
  finally
    sSend := xmlSend.XML.Text;
    ExceptLogging('ICon_VisitDelProcess : 삭제 응답 전문 생성 : ' + sSend);
    xmlSend.XML.Text := '';
    xmlSend.Active := false;
    ssHomeinfo_icon.Socket.Connections[0].SendText(sSend);
  end;
end;

function TfrmMain.ICon_VisitListProcess(sDong, sHo: string): string;
var
  xnRoot, xnChild, xnGrandchild : IXMLNode;
  sSend : String;
  nRoop     : Integer;
begin
  if (sDong = '') or (sHo = '') then
  begin
    HomeInfoLogging('ICon_VisitListProcess : 동/호 데이터 오류 ');
    Exit;
  end;

  HomeInfoLogging('ICon_VisitListProcess :  등록된 방문객 조회 시작 ' + sDong + ' / ' + sHo);

  try
    xmlSend.Active := true;
    xmlSend.Encoding := 'utf-8';
    xnRoot := xmlSend.AddChild('imap');
    xnRoot.Attributes['ver']      := '1.0';
    xnRoot.Attributes['address']  := My_LocalIP;
    xnRoot.Attributes['sender']   := '주차관제';

    xnChild := xnRoot.AddChild('service');
    xnChild.Attributes['type']    := 'reply';
    xnChild.Attributes['name']    := 'car_guest_info';
    xnChild.Attributes['result']  := 'ok';

    xnGrandchild := xnChild.AddChild('request_info');
    xnGrandchild.Attributes['name']    := 'homedev';
    xnGrandchild.Attributes['id_high'] := sDong;
    xnGrandchild.Attributes['id_low']  := sHo;
    xnGrandchild.Attributes['type']  := 'main';

    xnGrandchild := xnChild.AddChild('action');
    xnGrandchild.NodeValue := '"query"';

    with dmTables.qryVisitList do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from VisitInfo_ICon');
      SQL.Add(' where Dong = :N1 and Ho = :N2');
      Parameters.ParamByName('N1').Value := sDong;
      Parameters.ParamByName('N2').Value := sHo;
      SQL.Add(' order by StartDateTime desc');
      Open;
      if RecordCount > 0 then
      begin
        for nRoop := 1 to RecordCount do
        begin
          xnGrandchild := xnChild.AddChild('params');
          xnGrandchild.Attributes['car_num'] := FieldByName('CarNo').AsString;
          xnGrandchild.Attributes['period']  := FieldByName('period').AsString;
          xnGrandchild.Attributes['date']    := FieldByName('StartDateTime').AsString;
          xnGrandchild.Attributes['message'] := 'null';
          next;
        end;
      end;
//      sSend := xmlSend.XML.Text;
      xmlSend.SaveToXML(sSend);

      xmlSend.XML.Text := '';
      xmlSend.Active := false;
      ssHomeinfo_icon.Socket.Connections[0].SendText(sSend);

      ExceptLogging('ICon_VisitListProcess : 조회 응답 전문 생성 : ' + sSend);
    end;
  except
    on E: Exception do
      ExceptLogging('ICon_VisitListProcess: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.idTSExecute(AContext: TIdContext);
var
  sRecv, sRemortIP, sSend, sData: aString;
  nCmd, nUnitNo, nMNo: Word;
  i: Byte;
  bSend: Boolean;
begin
  try
    sRecv := AContext.Connection.IOHandler.ReadString
      (AContext.Connection.IOHandler.InputBuffer.Size, enUTF8);

    if Pos(STX, sRecv) > 0 then
      sCtrl := sRecv
    else
      sCtrl := sCtrl + sRecv;

    if (Pos(STX, sCtrl) <= 0) or (Pos(ETX, sCtrl) <= 0) then
      Exit;

    sRemortIP := AContext.Binding.PeerIP;
    ExceptLogging('CtrlRecv: ' + sCtrl + ':' + sRemortIP);
    nCmd := StrToInt(Copy(sRecv, 2, 2));
    nUnitNo := StrToInt(Copy(sRecv, 4, 5));
    nMNo := StrToInt(Copy(sRecv, 9, 3));

    if Pos(ETX, sCtrl) > 12 then
    begin
      // 데이터가 있으면...
      sData := Copy(sCtrl, 12, Pos(ETX, sCtrl) - 12);
    end
    else
      sData := '';

    bSend := False;

    case nCmd of
      1:
        begin
          for i := 1 to 5 do
          begin
            with frmMain do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                .Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_OPEN-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                    .Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging
                    (TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                      .Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
            for i := 1 to 3 do
            begin
              with frmMain do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add(
                '(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime
                ('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime
                ('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
      2:
        begin
          for i := 1 to 5 do
          begin
            with frmMain do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                .Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_CLOSE-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                    .Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging
                    (TClientSocket(FindComponent('csInLpr' + IntToStr(i)))
                      .Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
            for i := 1 to 3 do
            begin
              with frmMain do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_CLOSE-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add(
                '(ParkNo, UnitNo, ProcDate, ProcTime, Down, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime
                ('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime
                ('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
    end;

    sCtrl := '';
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.idTSExecute: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.IdTS_BeejuExecute(AContext: TIdContext);
var
  sRecv, sRemortIP, sSend, sData: aString;
  nCmd, nUnitNo, nMNo: Word;
  i: Byte;
  bSend: Boolean;
begin
  try
    sRecv := AContext.Connection.IOHandler.ReadString(AContext.Connection.IOHandler.InputBuffer.Size, enUTF8);
    sRemortIP := AContext.Binding.PeerIP;

    if Pos(STX, sRecv) > 0 then
      sCtrl := sRecv
    else
      sCtrl := sCtrl + sRecv;

    ExceptLogging('Recv Check: ' + sCtrl + ':' + sRemortIP);

    if (Pos(STX, sCtrl) <= 0) or (Pos(ETX, sCtrl) <= 0) then
      Exit;

    ExceptLogging('CtrlRecv: ' + sCtrl + ':' + sRemortIP);
    nCmd := StrToInt(Copy(sRecv, 2, 2));
    nUnitNo := StrToInt(Copy(sRecv, 4, 5));
    nMNo := StrToInt(Copy(sRecv, 9, 3));

    if Pos(ETX, sCtrl) > 12 then
    begin
      // 데이터가 있으면...
      sData := Copy(sCtrl, 12, Pos(ETX, sCtrl) - 12);
    end
    else
      sData := '';

    bSend := False;

    case nCmd of
      1:
        begin
          for i := 1 to 5 do
          begin
            with frmMain do
            begin
              if TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag = nUnitNo then
              begin
                if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) and
                   TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active then
                begin
                  sSend := 'BAR_OPEN-1';
                  TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Socket.SendText(sSend);
                  bSend := True;
                  Break;
                end
                else
                  ExceptLogging(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
              end;
            end;
          end;

          if not bSend then
          begin
            for i := 1 to 3 do
            begin
              with frmMain do
              begin
                if TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag = nUnitNo then
                begin
                  if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) and
                     TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active then
                  begin
                    sSend := 'BAR_OPEN-1';
                    TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Socket.SendText(sSend);
                    bSend := True;
                    Break;
                  end
                  else
                    ExceptLogging(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host + ': 차단기 원격제어시 네트워크 오류!');
                end;
              end;
            end;
          end;

          if bSend then
          begin
            with dmTables.qryBarProc do
            begin
              Close;
              SQL.Clear;
              SQL.Add('Insert BarProc ');
              SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, Up, MNo, ChkClosing, ProcReason) ');
              SQL.Add('Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8)');
              Parameters.ParamByName('N1').Value := nCurrParkNo;
              Parameters.ParamByName('N2').Value := nUnitNo;
              Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
              Parameters.ParamByName('N4').Value := FormatDateTime('HH:NN:SS', Now);
              Parameters.ParamByName('N5').Value := 1;
              Parameters.ParamByName('N6').Value := nMNo;
              Parameters.ParamByName('N7').Value := 0;

              if sData <> '' then
                Parameters.ParamByName('N8').Value := sData
              else
                Parameters.ParamByName('N8').Value := '원격제어';
              ExecSQL;
            end;
          end;
        end;
    end;

    sCtrl := '';
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.idTSExecute: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.IdTs_GyeyoungExecute(AContext: TIdContext);
var
  sRecv: Char;
  sip: aString;
  i: Integer;
begin
  try
    sRecv:= AContext.Connection.IOHandler.ReadChar(enDefault);
    sip:= AContext.Binding.PeerIP;
    sRecvHomeServer:= sRecv;

    for i := 1 to AContext.Connection.IOHandler.InputBuffer.Size do
      sRecvHomeServer:= sRecvHomeServer + AContext.Connection.IOHandler.ReadChar(enDefault);

    ExceptLogging('<단지서버 수신데이터(' + sIP + ') ' + sRecvHomeServer);
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
  end;
end;

procedure TfrmMain.IdTS_HyunDaiDisconnect(AContext: TIdContext);
begin
  ExceptLogging('IdTS_HyunDaiDisconnect');
end;

procedure TfrmMain.IdTS_HyunDaiException(AContext: TIdContext;
  AException: Exception);
begin
  try
    AContext.Connection.Disconnect;
  except
    ExceptLogging('IdTS_HyunDaiException');
  end;
end;

procedure TfrmMain.IdTS_HyunDaiExecute(AContext: TIdContext);
//var
//  sRecv: Char;
//  sip: aString;
//  i: Integer;
//begin
//  try
//    sRecv:= AContext.Connection.IOHandler.ReadChar(enDefault);
//    sip:= AContext.Binding.PeerIP;
//    sRecvHomeServer:= sRecv;
//
//    for i := 1 to AContext.Connection.IOHandler.InputBuffer.Size do
//      sRecvHomeServer:= sRecvHomeServer + AContext.Connection.IOHandler.ReadChar(enDefault);
//
//    ExceptLogging('<단지서버 수신데이터(' + sIP + ') ' + sRecvHomeServer);
//  except
//    on E: EIdSocketError do
//    begin
//      if E.LastError <> 10054 then ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
//      Exit;
//    end;
////    on E: EIdConnClosedGracefully do Exit;
//    on E: EIdConnClosedGracefully do
//    begin
//      AContext.Connection.Disconnect;
//      Exit;
//    end;
//
//    on E: Exception do ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
//  end;
var
  sRecv: String;
  sSend: AnsiString;
  i: Integer;
begin
  try
    sRecv := '';
    if AContext.Connection.IOHandler.Connected then
    begin
      sRecv := AContext.Connection.IOHandler.ReadString(AContext.Connection.IOHandler.InputBuffer.Size , IndyOSDefaultEncoding(true));
    end;
    if sRecv = '' then
      Exit;
    ExceptLogging('idTSExecute IP : ' +  AContext.Binding.PeerIP + ', Port : ' + IntToStr(AContext.Binding.PeerPort));
    ExceptLogging('idTSExecute recv: '+ sRecv);

    sSend := AnsiString(HD_RequestProcess(sRecv));
    if sSend <> '' then
    begin
      ExceptLogging('idTSExecute send: '+ sSend);
      AContext.Connection.IOHandler.WriteLnRFC(AnsiString(sSend), IndyOSDefaultEncoding(true));
    end;

  except
  on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do
    begin
      AContext.Connection.Disconnect;
      Exit;
    end;

    on E: Exception do
    begin
      AContext.Connection.Disconnect;
      ExceptLogging('TfrmMain.idTSExecute: ' + E.Message);
    end;
  end;
end;

procedure TfrmMain.IdTS_kocomExecute(AContext: TIdContext);
var
  sRecv: Char;
  sip: aString;
  i: Integer;
begin
  try
    sRecv:= AContext.Connection.IOHandler.ReadChar(enDefault);
    sip:= AContext.Binding.PeerIP;
    sRecvHomeServer:= sRecv;

    for i := 1 to AContext.Connection.IOHandler.InputBuffer.Size do
      sRecvHomeServer:= sRecvHomeServer + AContext.Connection.IOHandler.ReadChar(enDefault);

    ExceptLogging('<단지서버 수신데이터(' + sIP + ') ' + sRecvHomeServer);
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then ExceptLogging('TfrmMain.IdTS_kocomExecute: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do ExceptLogging('TfrmMain.IdTS_kocomExecute: ' + E.Message);
  end;
end;

procedure TfrmMain.idUC_ubizConnected(Sender: TObject);
begin
  HomeInfoLogging('단지서버 Connect');
end;

procedure TfrmMain.idUC_ubizDisconnected(Sender: TObject);
begin
  HomeInfoLogging('단지서버 DisConnect');
end;

procedure TfrmMain.idUS_ubizUDPRead(AThread: TIdUDPListenerThread;
  const AData: TIdBytes; ABinding: TIdSocketHandle);
Type
  //TSendData = Packed record
    TSendData =  record
    STX : array[1..4] of ansiChar;
    Gubun : array[1..2] of ansiChar;
    PacketType : ansiChar;
    Data1 : ansiChar;
  end;
var
  sSend : aString;
  sHomeInfo_Temp : aString;
  SendData : TSendData;
  SendBuff : TIdBytes;
begin
  try
    sHomeInfo_Temp := BytesToString(aData, enUTF8);

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 단지서버 수신: ' +  sHomeInfo_Temp);

    FillChar(SendData, sizeof(SendData), ' '); //공백으로 초기화

    if Pos('0x', sHomeInfo_Temp) > 0 then
    begin
      if Copy(sHomeInfo_Temp, 31, 4) = '0xA0' then
      begin
        try
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [상태정보] 상태응답');

          SendData.STX[1] := AnsiChar($AA);
          SendData.STX[2] := AnsiChar($AA);
          SendData.STX[3] := AnsiChar($AA);
          SendData.STX[4] := AnsiChar($A0);

          SendData.Gubun[1] := AnsiChar($BB);
          SendData.Gubun[2] := AnsiChar($BB);

          SendData.PacketType := AnsiChar($A1);

          if is_ping(sHomeInfo_IP) then
          begin
            try
//              if csHomeInfo.Socket.Connected then
//              begin
                SendData.Data1 := AnsiChar($A0);
//              end
//              else
//              begin
//                HomeInfoLogging('> [상태정보] 통신 오류');
//                SendData.Data1 := AnsiChar($A5);
//              end;
            except
              on E: Exception do HomeInfoLogging('TfrmMain.MakeKeyStatus-1 ' + aString(E.Message));
            end;
          end
          else
          begin
            HomeInfoLogging('> [상태정보] 단지서버 ping 에러');
            SendData.Data1 := AnsiChar($A5);
          end;

          if is_Ping(sHomeInfo_IP) then
          begin
            if idUC_uBiz.Connected then
            begin
              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_uBiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));
            end
            else
            begin
              idUC_uBiz.Disconnect;
              Sleep(200);
              idUC_uBiz.Connect;

              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_uBiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));
            end;
          end
          else
          begin
            HomeInfoLogging('[상태정보] 단지서버로 상태조회 전송 시도시 Ping 안됨!');
          end;
        except
        on E: Exception do HomeInfoLogging('TfrmMain.idUSUDPRead_1: ' + E.Message);
        end;
      end
      else
      begin
        // 입차 정보에 대한 응답값
        if Copy(sHomeInfo_Temp, 31, 4) = '0xA1' then
        begin
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [입차정보] 응답');
        end;
      end;
    end
    else
    begin
      if Copy(sHomeInfo_Temp, 19, 2) = 'A0' then
      begin
        try
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [상태정보] 상태응답');

          SendData.STX[1] := AnsiChar($AA);
          SendData.STX[2] := AnsiChar($AA);
          SendData.STX[3] := AnsiChar($AA);
          SendData.STX[4] := AnsiChar($A0);

          SendData.Gubun[1] := AnsiChar($BB);
          SendData.Gubun[2] := AnsiChar($BB);

          SendData.PacketType := AnsiChar($A1);

          if is_ping(sHomeInfo_IP) then
          begin
            try
//              if csHomeInfo.Socket.Connected then
//              begin
                SendData.Data1 := AnsiChar($A0);
//              end
//              else
//              begin
//                HomeInfoLogging('> [상태정보] 통신 오류');
//                SendData.Data1 := AnsiChar($A5);
//              end;
            except
              on E: Exception do HomeInfoLogging('TfrmMain.MakeKeyStatus-1 ' + aString(E.Message));
            end;
          end
          else
          begin
            HomeInfoLogging('> [상태정보] 단지서버 ping 에러');
            SendData.Data1 := AnsiChar($A5);
          end;

          if is_Ping(sHomeInfo_IP) then
          begin
            if idUC_ubiz.Connected then
            begin
              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));;
            end
            else
            begin
              idUC_ubiz.Disconnect;
              Sleep(200);
              idUC_ubiz.Connect;

              SendBuff := RawToBytes(SendData, SizeOf(SendData));
              idUC_ubiz.SendBuffer(sHomeInfo_IP, nHostPort, SendBuff);

              HomeInfoLogging('> [상태정보] 단지서버로 상태정보 전송: ' + aString(SendBuff));
            end;
          end
          else
          begin
            HomeInfoLogging('[상태정보] 단지서버로 상태조회 전송 시도시 Ping 안됨!');
          end;
        except
        on E: Exception do HomeInfoLogging('TfrmMain.idUSUDPRead_2: ' + E.Message);
        end;
      end
      else
      begin
        // 입차 정보에 대한 응답값
        if Copy(sHomeInfo_Temp, 19, 2) = 'A1' then
        begin
          // STX , 연동구분, Packet Type, Data
          HomeInfoLogging('> [입차정보] 응답');
        end;
      end;
    end;

  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.idUSUDPRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.idUSUDPRead: ' + E.Message);
  end;
end;

procedure TfrmMain.imgOut1Click(Sender: TObject);
begin


end;

{
function TfrmMain.is_ping(IP: AnsiString): Boolean;
begin
  Result := False;
  try
    with ICMP do
    begin
      OnReply := ICMPReply;
      ReceiveTimeOut := 2000;
      Host := wString(IP);
      Ping;
    end;
    Result := ping_success;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.is_ping: ' + aString(E.Message));
  end;
end;
}

function TfrmMain.is_Ping(ip: AnsiString): Boolean;
var
   Handle : THandle;
   DW : DWORD;
   REP : ICMPECHO;
   IPLong: LongInt;
begin
     //Result := -1;
     Result:= False;
     //ExceptLogging('Ping 시간 체크1-' + IntToStr(GetTickCount));

     Handle := IcmpCreateFile;

     if Handle = INVALID_HANDLE_VALUE then Exit;

     IPLong := inet_addr(PAnsiChar( ip ));
     DW := IcmpSendEcho(Handle, IPLong, nil, 0, nil, @rep, Sizeof(Rep), nPingTimeOut );

     //Result := rep.Status;

     if rep.status = 0 then
     begin
       // Added By LJH 181126 ====================
       // 기존 isPing 함수가 IP없이 체크할경우 TRUE로 반환하고 있었음.
       // 따라서 체크결과가 어떻든 IP가 빈칸일 경우 False반환토록 추가
       if IP = '' then
       begin
         Result:= False;
       end
       else
       begin
         Result:= True;
       end;
     end
     else
     begin
       Result:= False;
     end;

     //ExceptLogging('Ping 시간 체크2-' + IntToStr(GetTickCount));
     IcmpCloseHandle(Handle);
end;

procedure TfrmMain.a1Click(Sender: TObject);
begin
  NextModalDialog(TfrmIONData.Create(Self));
end;

procedure TfrmMain.btnBar1Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar1.ImageIndex, btnBar1.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBar2Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar2.ImageIndex, btnBar2.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBar3Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar3.ImageIndex, btnBar3.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBar4Click(Sender: TObject);
begin
  UnitCtrl(1, btnBar4.ImageIndex, btnBar4.Tag, nCurrMNo, '');
end;

procedure TfrmMain.btnBarCloseClick(Sender: TObject);
begin
  pnBar.Visible := False;
end;

procedure TfrmMain.btnBindClick(Sender: TObject);
var
  i, bTemp: Byte;
  sTemp: aString;
begin
  try
//    tAlive.Enabled := false;  //Added Woo.YH 160426 코콤서버 연결 시도 중에는 tAlive(접속상태 체크 타이머) 중지
//    Added Woo.YH 160426 코콤 서버 먼저 끊고 연결
    if IdTC_kocom.Connected then
    begin
      IdTC_kocom.IOHandler.InputBuffer.Clear;         //버퍼 클리어가 안되면 disconnect가 정상적으로 동작되지않는다
      IdTC_kocom.Disconnect;
      ExceptLogging('코콤 DisConnet 후 재연결시도');
    end;

    FillChar(RBind, SizeOf(RBind), AnsiChar($00));
    FillChar(RKHeader, SizeOf(RKHeader), AnsiChar($00));
    FillChar(RAlive, SizeOf(RAlive), AnsiChar($00));

    RBind.nHomeVersion:= 0;
    RBind.nKind:= 0;

    for i:= 0 to 3 do
      RBind.nVersion[i]:= 0;

    for i:= 1 to Length(sHomeInfo_ID) do
      RKHeader.sID[i]:= sHomeInfo_ID[i];


    RKHeader.nHeaderKey:= nGHeaderKey;
    RKHeader.nMsgType:= nGBind;
    RKHeader.nMsgLength:= SizeOf(RBind);
    RKHeader.nTown:= 0;
    RKHeader.nDong:= 0;
    RKHeader.nHo:= 0;
    RKHeader.nReserved:= 0;

//Modified Start Woo.YH 160426 하드코딩되어있는 ID,PW값 ini에서 읽어온값으로 수정
//    for i:= 1 to Length(sTemp) do
//      RKHeader.sPW[i]:= sTemp[i];
    for i:= 1 to Length(sHomeInfo_PW) do
      RKHeader.sPW[i]:= sHomeInfo_PW[i];
//Modified End Woo.YH 160426 하드코딩되어있는 ID,PW값 ini에서 읽어온값으로 수정

     IdTC_kocom.Connect;

     if IdTC_kocom.Connected then
     begin
       IdTC_kocom.IOHandler.Write(RawToBytes(RKHeader, SizeOf(RKHeader)), SizeOf(RKHeader), 0);
//       tKocomCheck.Interval:= 200;              //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
//       tKocomCheck.Enabled:= True;              //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
       tAlive.Enabled:= True;
       ExceptLogging('코콤서버와 Bind확인 - OK');
     end
     else
       ExceptLogging('코콤서버와 Bind 안됨!');
//     tAlive.Enabled:= True;  //Added Woo.YH 160426
  except
    on E: Exception do
    begin
     ExceptLogging('TfrmMain.btnBindClick: ' + E.Message);
//    tAlive.Enabled:= True;  //Added Woo.YH 160427
    end;
  end;
end;

procedure TfrmMain.btnCloseClick(Sender: TObject);
begin
  btnManualSCIn.Enabled:= False;
  btnManualSCOut.Enabled := False;
  dmTables.qrySCSearch.Close;
  pnManualProc.Visible:= False;
end;

// 세대통보 버튼 클릭시 세대통보처리
procedure TfrmMain.btnHomeInfoTestClick(Sender: TObject);
begin
  HomeInfoLogging('홈넷 테스트 : ' + IntToStr(nHomeInfo_Comp));
  try
    if nHomeInfo_Comp = 0 then
    begin
      HomeInfoLogging('홈넷 설정 없음 미전송');
    end
    else if nHomeInfo_Comp = 1 then  // 현대
    begin
      HomeInfoTest_Hyun;
    end
    else if nHomeInfo_Comp = 2 then // 코콤
    begin
      HomeinfoTest_Kocom;
    end
    else if nHomeInfo_Comp = 3 then // 아이컨트롤스
    begin
      HomeinfoTest_Icon;
    end
    else if nHomeInfo_Comp = 4 then  // 계영정보통신
    begin
      HomeInfoTest_Gye;
    end
    else if nHomeInfo_Comp = 5 then  // 삼성중공업 유비즈
    begin
      HomeInfoTest_UBiz;
    end
    else if nHomeInfo_Comp = 6 then  // 이지빌
    begin
      HomeInfoTest_EZ;
    end
    else if nHomeInfo_Comp = 7 then  // 비쥬드림
    begin
      HomeInfoTest_BeeJu;
    end
    else if nHomeInfo_Comp = 8 then  // CV Net
    begin
      HomeInfoTest_CVNet;
    end
    else if nHomeInfo_Comp = 9 then  // 코맥스
    begin
      HomeInfoTest_Commax;
    end
    else if nHomeInfo_Comp = 10 then  //홈넷홈
    begin
      HomeInfoTest_Home;
    end;
    ShowMessage('세대통보 전송완료');
  except
    on E: Exception do HomeInfoLogging('세대통보 테스트: ' + aString(E.Message));
  end;
end;

// 미인식 차량 입차처리
procedure TfrmMain.btnManualCancelClick(Sender: TObject);
begin
  edtManualCarNo.Text := '';
  pnManual.Visible := False;
end;

procedure TfrmMain.btnManualInClick(Sender: TObject);
begin
  pnManual.Visible := True;
  edtManualCarNo.Text := '';
  edtManualCarNo.SetFocus;
  edtManualCarNo.SelectAll;
end;

procedure TfrmMain.btnManualOKClick(Sender: TObject);
var
  sTKNo, sProcDate, sProcTime, sInCarNo: String;
begin
  try
    //sTKNo := MG_InsZero(IntToStr(GetTickCount), 10);
    sTKNo := FormatDateTime('YYYYMMDDHHNNSSZZ', Now)+ IntToStr(nCurrUnitNo) ;
    sProcDate := FormatDateTime('YYYY-MM-DD', Now);
    sProcTime := FormatDateTime('HH:NN:SS', Now);
    sInCarNo := MG_StrTrim(edtManualCarNo.Text, ' ');

    with dmTables do
    begin
      with qryDCTemp do
      begin
        Close;
        SQL.Clear;
        SQL.Add('Insert Into IONData ');
        SQL.Add('(ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
        SQL.Add('CarType, Status, OutChk, InImage1, InCarNo1, Reserve1) ');
        SQL.Add(
          'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12)');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := sProcDate;
        Parameters.ParamByName('N4').Value := sProcTime;
        Parameters.ParamByName('N5').Value := sTKNo;
        Parameters.ParamByName('N6').Value := 1;
        Parameters.ParamByName('N7').Value := 1;
        Parameters.ParamByName('N8').Value := 1;
        Parameters.ParamByName('N9').Value := 0;
        Parameters.ParamByName('N10').Value := '';
        Parameters.ParamByName('N11').Value := sInCarNo;
        Parameters.ParamByName('N12').Value := '수동입차';
        ExecSQL;
      end;
      ExceptLogging('수동입차: ' + sProcDate + ', ' + sProcTime + ', ' + sInCarNo);
      ShowMessage('수동입차처리를 완료하였습니다.');
    end;
    // InOpen;
    NGridData('1' + sInCarNo + '^' + sProcDate + ' ' + sProcTime + '^수동입차');
    pnManual.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualOKClick: ' + E.Message);
  end
end;

procedure TfrmMain.btnManualSCInClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동입차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csInLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;         // 전광판 IP
        nIO := RLpr[i].nIO;               // 입출구구분
        nListCnt:= RLpr[i].nLprCnt;       // LPR 개수 ???
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt, 0)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt, 0);

    GridData(nIO, nListCnt, sResult);
    edtManualProcCarNo.Text:= '';
    btnManualSCIn.Enabled:= False;
    btnManualSCOut.Enabled:= False;
    dmTables.qrySCSearch.Close;
    pnManualProc.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCInClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnManualSCOutClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csOutLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        nIO := RLpr[i].nIO;
        nListCnt:= RLpr[i].nLprCnt;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt, 0)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt, 0);

    GridData(nIO, nListCnt, sResult);
    edtManualProcCarNo.Text:= '';
    btnManualSCIn.Enabled:= False;
    btnManualSCOut.Enabled:= False;
    dmTables.qrySCSearch.Close;
    pnManualProc.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCOutClick: ' + aString(E.Message));
  end;
end;

// 미인식 차량 차량번호로 조회
procedure TfrmMain.btnManualSeekClick(Sender: TObject);
var
  sIn, sResult, sTime, sTemp: aString;
  sDspIP: aString;
  i: Byte;
begin
  try
    // 입력받은 차량번호가 없으면
    if edtManualProcCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtManualProcCarNo.SetFocus;
      Exit;
    end;

    // 정기차량 조회
    with dmTables.qrySCSearch do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr('%' + Trim(edtManualProcCarNo.Text) + '%'));
      Open;

      if RecordCount > 0 then
      begin
        First;
        sManualSCCarNo := dmTables.qrySCSearch.FieldByName('CarNo').AsString;
        dgManual.SetFocus;
      end
      else
      begin
        sManualSCCarNo := '';
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnManualSeekClick: ' + E.Message);
  end;
end;

procedure TfrmMain.btnMCancelClick(Sender: TObject);
begin
  edtMCarNo.Text := '';
  pnModify.Visible := False;
  imgModify.Picture.Assign(Nil);
  nGridCheck := 0;
end;

procedure TfrmMain.btnModeClick(Sender: TObject);
var
  sMode : astring;
begin
   if btnMode.Tag = 1 then begin
     sMode := '개방운영'
   end
   else begin
     sMode := '유인운영'
   end;


   if MessageDlg( btnMode.Caption + '에서 ' + sMode + '로 변경하시겠습니까?', mtConfirmation, [mbYes, mbNo], 0) <> mrYes then Exit;
   bMode := not bMode;
   if bMode then begin
     btnMode.Caption := '유인운영' ;
     ExceptLogging('TfrmMain.btnModeClick: 유인운영');
     btnMode.Tag := 1;
     iSetup.WriteBool('PARKING', '개방운영', true);
   end
   else begin
     btnMode.Caption := '개방운영';
     ExceptLogging('TfrmMain.btnModeClick: 개방운영');
     btnMode.Tag := 2;
     iSetup.WriteBool('PARKING', '개방운영', False);
   end;
end;

procedure TfrmMain.btnMOKClick(Sender: TObject);
var
  sCardNo, sName, sCompName, sDeptName, sGroupName, sExpDateT: aString;
  nGroupNo, i: Integer;
  bSC: Boolean;
begin
  try
    bSC:= False;
    with dmTables.qryModify do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo = :N1 and ');
      SQL.Add('ExpDateF <= :N2 and ExpDateT >= :N3 and TKType = :N4 and ParkNo = :N5');
      Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
      Parameters.ParamByName('N2').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N3').Value := FormatDateTime('YYYY-MM-DD', Now);
      Parameters.ParamByName('N4').Value := 2;
      Parameters.ParamByName('N5').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        // 정기차량 처리
        sCardNo := FieldByName('TKNo').AsString;
        nGroupNo := FieldByName('GroupNo').AsInteger;
        sName := FieldByName('Name').AsString;
        sCompName := FieldByName('CompName').AsString;
        sDeptName := FieldByName('DeptName').AsString;
        sExpDateT:= FieldByName('ExpDateT').AsString;

        Close;
        SQL.Clear;
        SQL.Add(
          'Select * from GGroup where ParkNo = :N1 and GroupNo = :N2 and Reserve1 is null');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nGroupNo;
        Open;

        if RecordCount > 0 then
          sGroupName := FieldByName('GroupName').AsString;

        Close;
        SQL.Clear;
        SQL.Add('Update CustInfo Set LastParkNo = :N1, LastUnitNo = :N2, ');
        SQL.Add('LastUseDate = :N3, LastUseTime = :N4, IOStatusNo = :N5 ');
        SQL.Add('where ParkNo = :N6 and TKType = :N7 and TKNo = :N8');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nOrgUnitNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := 1;
        Parameters.ParamByName('N6').Value := nCurrParkNo;
        Parameters.ParamByName('N7').Value := 2;
        Parameters.ParamByName('N8').Value := sCardNo;
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add
          ('Select * from IOSData where ParkNo = :N1 and UnitNo = :N2 and ');
        SQL.Add('ProcDate = :N3 and ProcTime = :N4 and TKNo = :N5');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := nOrgUnitNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sCardNo;
        Open;

        if RecordCount <= 0 then
        begin
          Close;
          SQL.Clear;
          SQL.Add(
            'Insert Into IOSData (ParkNo, UnitNo, ProcDate, ProcTime, TKNo, TKType, ');
          SQL.Add(
            'CarType, GroupNo, GroupName, CompName, DeptName, Name, InCarNo1, InIOStatusNo, ');
          SQL.Add('InImage1, InRecog1, Reserve1, Reserve2) ');
          SQL.Add(
            'Values (:N1, :N2, :N3, :N4, :N5, :N6, :N7, :N8, :N9, :N10, :N11, :N12, :N13, :N14, :N15, :N16, :N17, :N18)');
          Parameters.ParamByName('N1').Value := nCurrParkNo;
          Parameters.ParamByName('N2').Value := nOrgUnitNo;
          Parameters.ParamByName('N3').Value := sOrgDate;
          Parameters.ParamByName('N4').Value := sOrgTime;
          Parameters.ParamByName('N5').Value := sCardNo;
          Parameters.ParamByName('N6').Value := 2;
          Parameters.ParamByName('N7').Value := 2;
          Parameters.ParamByName('N8').Value := nGroupNo;
          Parameters.ParamByName('N9').Value := sGroupName;
          Parameters.ParamByName('N10').Value := sCompName;
          Parameters.ParamByName('N11').Value := sDeptName;
          Parameters.ParamByName('N12').Value := sName;
          Parameters.ParamByName('N13').Value := MG_StrTrim
            (edtMCarNo.Text, ' ');
          Parameters.ParamByName('N14').Value := 1;
          Parameters.ParamByName('N15').Value := sOrgFile;
          Parameters.ParamByName('N16').Value := 4;
          Parameters.ParamByName('N17').Value := FormatDateTime
            ('YYYY-MM-DD HH:NN:SS', Now);
          Parameters.ParamByName('N18').Value := IntToStr(nCurrMNo);
          ExecSQL;
        end;

        Close;
        SQL.Clear;
        SQL.Add(
          'Delete from IONData where ParkNo = :N1 and ProcDate = :N2 and ProcTime = :N3 and ');
        SQL.Add('((InCarNo1 = :N4) or (InCarNo2 = :N5))');
        Parameters.ParamByName('N1').Value := nCurrParkNo;
        Parameters.ParamByName('N2').Value := sOrgDate;
        Parameters.ParamByName('N3').Value := sOrgTime;
        Parameters.ParamByName('N4').Value := sOrgCarNo;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        //Parameters.ParamByName('N4').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        //Parameters.ParamByName('N5').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        ExecSQL;
        bSC := True;
      end
      else
      begin
        // 일반차량 처리
        Close;
        SQL.Clear;
        SQL.Add(
          'Update IONData Set InCarNo1 = :N1, Reserve5 = :N7, Reserve4 = :N8, Reserve3 = :N9, InRecog1 = 1 ');
        SQL.Add(
          'Where ParkNo = :N2 and ProcDate = :N3 and ProcTime = :N4 and InCarNo1 = :N5');
        Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        Parameters.ParamByName('N2').Value := nCurrParkNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        Parameters.ParamByName('N7').Value := '차량번호수정';
        Parameters.ParamByName('N8').Value := FormatDateTime
          ('YYYY-MM-DD HH:NN:SS', Now);
        Parameters.ParamByName('N9').Value := IntToStr(nCurrMNo);
        ExecSQL;

        Close;
        SQL.Clear;
        SQL.Add(
          'Update IONData Set InCarNo2 = :N1, Reserve5 = :N7, Reserve4 = :N8, Reserve3 = :N9, InRecog2 = 1 ');
        SQL.Add(
          'Where ParkNo = :N2 and ProcDate = :N3 and ProcTime = :N4 and InCarNo2 = :N5');
        Parameters.ParamByName('N1').Value := MG_StrTrim(edtMCarNo.Text, ' ');
        Parameters.ParamByName('N2').Value := nCurrParkNo;
        Parameters.ParamByName('N3').Value := sOrgDate;
        Parameters.ParamByName('N4').Value := sOrgTime;
        Parameters.ParamByName('N5').Value := sOrgCarNo;
        Parameters.ParamByName('N7').Value := '차량번호수정';
        Parameters.ParamByName('N8').Value := FormatDateTime
          ('YYYY-MM-DD HH:NN:SS', Now);
        Parameters.ParamByName('N9').Value := IntToStr(nCurrMNo);
        ExecSQL;
      end;

      if nGridCheck = 1 then
      begin
        for i := 2 to sgIn.RowCount do
        begin
          if (MG_StrTrim(sgIn.Cells[3, i - 1], ' ') = sOrgCarNo) and
            (sgIn.Cells[1, i - 1] = sOrgDate) and
            (sgIn.Cells[2, i - 1] = sOrgTime) then
          begin
            sgIn.Cells[3, i - 1] := MG_StrTrim(edtMCarNo.Text, ' ');
            sgIn.RowColor[i - 1] := clWhite;

            if bSC then
            begin
              sgIn.Cells[0, i -1]:= '정기차량';
              sgIn.Cells[4, i -1]:= sCompName;
              sgIn.Cells[5, i -1]:= sName;
              sgIn.Cells[6, i -1]:= sExpDateT;
            end;
          end;
        end;
      end
      else if nGridCheck = 2 then
      begin
        sgOut.RemoveRows(nModRow, 1);
      end;

      edtMCarNo.Text := '';
      imgModify.Picture.Assign(Nil);
      pnModify.Visible := False;
      nGridCheck := 0;
      sOrgCarNo := '';
      sOrgDate := '';
      sOrgTime := '';
      sOrgFile := '';
      nOrgUnitNo := 0;

      // 메시지 없애달라는 요청... 2012-06-30  황이성 주임
      // ShowMessage('차량번호 수정을 완료하였습니다.');
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnMOKClick: ' + E.Message);
  end;
end;

procedure TfrmMain.btnOutGate1Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 21;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnOutGate2Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 22;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnOutGate3Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 23;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnOutGate4Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 24;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnSCCancelClick(Sender: TObject);
begin
  sManualSCCarNo := '';
  btnSCIn.Enabled:= False;
  btnSCOut.Enabled:= False;
  edtSCCarNo.Text:= '';
  pnSCSearch.Visible := False;
end;

procedure TfrmMain.btnSCClick(Sender: TObject);
begin
  try
    if edtSCCarNo.Text = '' then
    begin
      ShowMessage('차량번호를 입력하여주세요!');
      edtSCCarNo.SetFocus;
      Exit;
    end;

    with dmTables.qrySCSearch do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from CustInfo where CarNo like ' + MG_MakeStr
          ('%' + Trim(edtSCCarNo.Text) + '%'));
      Open;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnSCInClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csInLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        nIO:= RLpr[i].nIO;
        nListCnt:= RLpr[i].nLprCnt;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt, 0)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt, 0);

    GridData(nIO, nListCnt, sResult);
    edtSCCarNo.Text:= '';
    btnSCIn.Enabled:= False;
    btnSCOut.Enabled := False;
    dmTables.qrySCSearch.Close;
    pnSCSearch.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCInClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnSCOutClick(Sender: TObject);
var
  sResult, sTime, sTemp, sDspIP: aString;
  i, nIO, nListCnt: Byte;
begin
  try
    // 정기차량 수동출차
    for i := 1 to 10 do
    begin
      if RLpr[i].nUnitNo = csOutLpr1.Tag then
      begin
        sDspIP := RLpr[i].sDspIP;
        nIO:= RLpr[i].nIO;
        nListCnt:= RLpr[i].nLprCnt;
        Break;
      end;
    end;
    sOutLprCarNo := sManualSCCarNo;
    sTime := FormatDateTime('YYYY-MM-DD HH:NN:SS', Now);

    if nIO = 1 then
      sResult := RecvLprProc(sInMiFile, sOutLprCarNo, '', '', sTime,
                             csInLpr1.Tag, nIO, 3, 3, sDspIP, csInLpr1, True, nListCnt, 0)
    else
      sResult := RecvLprProc(sOutMiFile, sOutLprCarNo, '', '', sTime,
                             csOutLpr1.Tag, nIO, 3, 3, sDspIP, csOutLpr1, True, nListCnt, 0);

    GridData(nIO, nListCnt, sResult);
    edtSCCarNo.Text:= '';
    btnSCIn.Enabled:= False;
    btnSCOut.Enabled := False;
    dmTables.qrySCSearch.Close;
    pnSCSearch.Visible := False;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.btnSCOutClick: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.btnVipClick(Sender: TObject);
begin
  pnlBlack.Visible := False;
  mpBlackList.Notify := False;
  mpBlackList.Stop;
end;

function TfrmMain.BuildCVnetCRC(sData: AnsiString): AnsiString;
var
  i, Sum: Integer;
  SumByte: Byte;
begin
  Sum:= 0;

  for i:= 1 to Length(sData) do Sum:= Sum + Ord(sData[i]);
  Sum:= (Sum xor Ord(AnsiChar($FF))) + 1;
  SumByte:= Sum;
  Result:= AnsiChar(SumByte);
end;

procedure TfrmMain.Button1Click(Sender: TObject);
begin
  pnHomeInfo.Visible:= False;
end;

function TfrmMain.CheckCVnetCRC(sData: AnsiString): Boolean;
begin
  if Copy(sData, Length(sData)-1, 1) =
     BuildCVnetCRC(Copy(sData, 1, Length(sData)-2)) then
    Result:= true
  else
    Result:= false;
end;

procedure TfrmMain.btnInGate1Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 11;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnInGate2Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 12;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnInGate3Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 13;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.btnInGate4Click(Sender: TObject);
var
  TempPoint : TPoint;
begin
  nGateNo   := 14;
  TempPoint := TButton(Sender).ClientToScreen(Point(0,0));
  popGate.Popup(TempPoint.X, TempPoint.Y);
end;

procedure TfrmMain.csDspError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
var
  tmpCnt: Integer;
  tmpErrorCd: Integer;
  tmpMsg: String;
begin
  tmpErrorCd := ErrorCode;
  tmpMsg := '';

  Case ErrorCode of
    10049 : tmpMsg := '컨넥트 하려는 주소가 잘못';
    10053 : tmpMsg := '소프트웨어 때문에 연결이 중단되었습니다';
    10054 : tmpMsg := '상대편에 의해 연결이 강제로 종료되었을 경우 발생하는 오류';
    10060 : tmpMsg := '네트워크 타임아웃';
    10061 : tmpMsg := '서버가 죽었거나 클라이언트에서 접속환경이 잘못되었을때 나타나는 현상';
  else tmpMsg := '네트워크 기타 에러';
  end;
  ErrorCode := 0;

  ExceptLogging('SocketError > ErrorNo: [' + IntToStr(tmpErrorCd) + '] Host: ['
                                  + (Sender as TClientSocket).Host + '] Port: ['
                                  + intToStr((Sender as TClientSocket).Port) + '] Name: ['
                                  + (Sender as TClientSocket).Name + '] Msg: ['
                                  + tmpMsg + ']');
   if tmpErrorCd = 10057 then
   begin
     prDelay(nDspInterval);
     if (Sender as TClientSocket).Active then
     begin
       (Sender as TClientSocket).Active := False;
     end;
   end;
   if tmpErrorCd = 10049 then
   begin
     prDelay(nDspInterval);
    (Sender as TClientSocket).Active := True;
   end;
end;


procedure TfrmMain.csHomeInfo_CVNetConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  try
    ExceptLogging('CVNet단지서버 Connect');

    if sHomeInfo_SendData <> '' then
    begin
      csHomeInfo_CVNet.Socket.SendText(sHomeInfo_SendData);

      ExceptLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')');
      sHomeInfo_SendData:= '';
    end;
  except
    on E: Exception do ExceptLogging('단지서버 전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_CVNetDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('CVNet 단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_CVNetError(Sender: TObject;
  Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('단지서버 소켓에러: ' + IntToStr(ErrorCode));
  ErrorCode:= 0;
end;

procedure TfrmMain.csHomeInfo_CVNetRead(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  try
    sHomeInfo_RecvData:= Socket.ReceiveText;

    if sHomeInfo_RecvData = '' then Exit;

    HomeInfo_RecvProc(sHomeInfo_RecvData);
    sHomeInfo_RecvData:= '';
  except
    on E: Exception do ExceptLogging('csHomeInfo_CVNetRead: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_EZConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('이지빌 단지서버 Connect');
end;

procedure TfrmMain.csHomeInfo_EZDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('이지빌 단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_EZRead(Sender: TObject; Socket: TCustomWinSocket);
var
  sSend, sSendLength, sTemp,
  sRHStart, sRHVersion, sRHCopy, sRHCmd, sRHDongho, sRHTarget,   //방문자 전문 파싱용
  sRBMode, sRBParam, sRBDongho, sRBtotal, sRBinout, sRBtime, sRBno,
  sRBCarno, sRBErr, sDelData, sSendData, sMyIP : aString;

  ntemp1, ntemp2, nRoop, nInsertResult, nDelResult : Integer;

  saDelCarNo : array[1..10] of string;

  nSendLength: Integer;
begin
  try
    //이지빌
    sHomeInfo_Temp:= Socket.ReceiveText;

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 이지빌 수신(' + IntToStr(GetTickCount) + '): ' + sHomeInfo_Temp);

    if nHomeVisit = 1 then //방문자
    begin
      ntemp1 := Pos('<start=', sHomeInfo_Temp)+ 7;
      nTemp2 := Pos('>', Copy(sHomeInfo_Temp, Pos('<start=', sHomeInfo_Temp)+ 7, length(sHomeInfo_Temp)-nTemp1));
      sRHStart := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

      ntemp1 := Pos('$version=', sHomeInfo_Temp) + 9;
      nTemp2 := Pos('$', Copy(sHomeInfo_Temp, Pos('$version=', sHomeInfo_Temp)+ 9, length(sHomeInfo_Temp) -nTemp1 ));
      sRHVersion := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

      ntemp1 := Pos('$copy=', sHomeInfo_Temp) + 6;
      nTemp2 := Pos('$', Copy(sHomeInfo_Temp, Pos('$copy=', sHomeInfo_Temp)+ 6, length(sHomeInfo_Temp) -nTemp1));
      sRHCopy := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

      ntemp1 := Pos('$cmd=', sHomeInfo_Temp) + 5;
      nTemp2 := Pos('$', Copy(sHomeInfo_Temp, Pos('$cmd=', sHomeInfo_Temp) + 5, length(sHomeInfo_Temp) -nTemp1));
      sRHCmd := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

      ntemp1 := Pos('$dongho=', sHomeInfo_Temp) + 8;
      nTemp2 := Pos('$', Copy(sHomeInfo_Temp, Pos('$dongho=', sHomeInfo_Temp) + 8, length(sHomeInfo_Temp) -nTemp1));
      sRHDongho := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

      if pos('#', sHomeInfo_Temp) > 0 then
      begin
        ntemp1 := Pos('$target=', sHomeInfo_Temp) + 8;
        nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('$target=', sHomeInfo_Temp) + 8, length(sHomeInfo_Temp) -nTemp1));
        sRHTarget := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

        ntemp1 := Pos('#mode=', sHomeInfo_Temp) + 6;
        if nTemp1 = 6 then  //단지 서버 상태 정보 조회 응답
        begin
          HomeInfoLogging('단지서버 상태정보 조회 응답 수신');
          exit;
        end;
        nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('#mode=', sHomeInfo_Temp) + 6, length(sHomeInfo_Temp) -nTemp1));
//        sRBMode := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);
        sRBMode := Copy(sHomeInfo_Temp, ntemp1, 1);

        ntemp1 := Pos('#dongho=', sHomeInfo_Temp) + 8;
        nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('#dongho=', sHomeInfo_Temp) + 8, length(sHomeInfo_Temp) -nTemp1));
        sRBDongho := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

        if sRBMode = '0' then     //입주민 통보 응답
        begin
          if sRHCmd = '31' then    //입주민 통보 응답
          begin
            HomeInfoLogging('입주민 세대통보 정상 전송 응답수신 동&호 : ' + sRHDongho);
            Exit;
          end;
        end
        else if sRBMode = '1' then //주차 예약 or 리스트 조회 or  방문자 통보응답
        begin
          if sRHCmd = '10' then //리스트 조회
          begin
//            ntemp1 := Pos('#param=', sHomeInfo_Temp) + 7;
//            nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('#param=', sHomeInfo_Temp) + 7, length(sHomeInfo_Temp) -nTemp1));

            ntemp1 := Pos('#param=', sHomeInfo_Temp) + 7;
//            nTemp2 := Pos('#', Copy(sHomeInfo_Temp, ntemp1, length(sHomeInfo_Temp) -nTemp1));
            sRBParam := Copy(sHomeInfo_Temp, ntemp1,  length(sHomeInfo_Temp) -nTemp1+1);
            sSend := EZ_VisitListProcess(sRBDongho , sRBParam);

            sSend := '$version=' + sRHVersion + '$cmd=11$copy=' + sRHCopy + '$dongho=' + sezvilleDong + '&' + sezvilleho
              + '$target=' + sRHTarget + '#mode=' + sRBMode + '#dongho=' + sRBDongho + sSend;
            sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
            sSend:= '<start=' + sSendLength + '&0>' + sSend;

          end
          else if sRHcmd = '20' then //주차 예약
          begin
            ntemp1 := Pos('#no=', sHomeInfo_Temp) + 4;
            nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('#no=', sHomeInfo_Temp) + 4, length(sHomeInfo_Temp) -nTemp1));
            sRBno := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

            ntemp1 := Pos('#inout=', sHomeInfo_Temp) + 7;
            nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('#inout=', sHomeInfo_Temp) + 7, length(sHomeInfo_Temp) -nTemp1));
            sRBinout := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

            ntemp1 := Pos('#time=', sHomeInfo_Temp) + 6;
            nTemp2 := Pos('#', Copy(sHomeInfo_Temp, Pos('#time=', sHomeInfo_Temp) + 6, length(sHomeInfo_Temp) -nTemp1));
            sRBtime := Copy(sHomeInfo_Temp, ntemp1, nTemp2-1);

            ntemp1 := Pos('#carno=', sHomeInfo_Temp) + 7;
            sRBCarno := Copy(sHomeInfo_Temp, ntemp1, length(sHomeInfo_Temp) - 1);

            //등록처리 함수
            nInsertResult := EZ_VisitAddProcess(sRBCarno, sRBtime, sRBDongho, sRBinout);
            if nInsertResult = 0 then   //정상
            begin
              sSend := '$version=' + sRHVersion + '$cmd=21$copy=' + sRHCopy + '$target=' + sRHTarget +
                        '#dongho=' + sRBDongho + '#mode=' + sRBMode;
            end
            else
            begin
              sSend := '$version=' + sRHVersion + '$cmd=21$copy=' + sRHCopy + '$target=' + sRHTarget +
                        '#dongho=' + sRBDongho + '#mode=' + sRBMode + '#err=0001&차번저장오류';
            end;
            sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
            sSend:= '<start=' + sSendLength + '&0>' + sSend;
          end
          else if sRHCmd = '31' then    //방문차 통보 응답
          begin
            HomeInfoLogging('방문자 세대통보 정상 전송 응답수신 동&호 : ' + sRBDongho);
            Exit;
          end;
        end
        else if sRBMode = '2' then  //주차 삭제 요청
        begin
          sDelData := Copy(sHomeInfo_Temp, Pos('#no=', sHomeInfo_Temp), Length(sHomeInfo_Temp)- ntemp1);
          for nRoop := 1 to 10 do
          begin
            ntemp1 := Pos('#carno=', sDelData) + 7;
            nTemp2 := Pos('#', Copy(sDelData, ntemp1, length(sDelData) - nTemp1));
            //여기서 동호도 받고 지우기
            if ntemp2 = 0 then //다찾았다
            begin
              saDelCarNo[nRoop] := Copy(sDelData, ntemp1, length(sDelData) - 1);
              break;
            end
            else
            begin
//              saDelCarNo[nRoop] := Copy(sDelData, ntemp1, length(sDelData) - 1);
              saDelCarNo[nRoop] := Copy(sDelData, ntemp1, nTemp2);
              sDelData := Copy(sDelData, ntemp1 + length(saDelCarNo[nRoop])+1, length(sDelData) - ntemp2);
            end;
          end;

          nDelResult := EZ_VisitDelProcess(saDelCarNo, sRBDongho);
          if nDelResult = 0 then                  //삭제 성공
          begin
              sSend := '$version=' + sRHVersion + '$cmd=21$copy=' + sRHCopy + '$target=' + sRHTarget +
                        '#dongho=' + sRBDongho + '#mode=' + sRBMode;
          end
          else                                     //삭제 오류 발생시 전문차이없음
          begin
              sSend := '$version=' + sRHVersion + '$cmd=21$copy=' + sRHCopy + '$target=' + sRHTarget +
                        '#dongho=' + sRBDongho + '#mode=' + sRBMode;
          end;
          sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
          sSend:= '<start=' + sSendLength + '&0>' + sSend;
        end;

        //sSend 전송부
        if csHomeInfo_EZ.Socket.Connected then
        begin
          if csHomeInfo_EZ.Socket.SendText(sSend) = strToInt(sSendLength) then
          begin
            HomeInfoLogging('> 단지서버 상태요청에 대한 응답: ' + sSend);
          end
          else
          begin
            HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러: ' + sSend);
          end;
        end
        else
        begin
          if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
          begin
            if is_Ping(sHomeInfo_IP) then
            begin
              try
                csHomeInfo_EZ.Close;
                csHomeInfo_EZ.Open;

                if csHomeInfo_EZ.Socket.Connected then
                begin
                  if csHomeInfo_EZ.Socket.SendText(sSend) = StrToInt(sSendLength) then
                  begin
                    HomeInfoLogging('> 단지서버 상태요청에 대한 응답(2): ' + sSend);
                  end
                  else
                  begin
                    HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러(2): ' + sSend);
                  end;
                end
                else
                  HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 네트워크 에러');
              except
                on E: Exception do HomeInfoLogging('이지빌 상태요청에 대한 응답시 에러: ' + aString(E.Message));
              end;
            end
            else
              HomeInfoLogging('이지빌 단지서버로 상태요청에 대한 응답전송 시도시 Ping 안됨!');
          end;
        end;
      end
      else                            //상태조회 요청 수신
      begin
        ntemp1 := Pos('$target=', sHomeInfo_Temp) + 8;
        sRHTarget := Copy(sHomeInfo_Temp, ntemp1, length(sHomeInfo_Temp) -nTemp1+1);

        sSend := '$version=' + sRHVersion + '$cmd=11$copy=' + sRHCopy + '$target=' + sRHTarget + '#dongho=' +
//                sezvilleDong + '&' + sezvilleho + '#ip=' + sHomeInfo_IP + '#status=0';
                sezvilleDong + '&' + sezvilleho + '#ip=' + sMyIp + '#status=0';
        sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
        sSend:= '<start=' + sSendLength + '&0>' + sSend;

        if csHomeInfo_EZ.Socket.Connected then
        begin
          if csHomeInfo_EZ.Socket.SendText(sSend) = StrToInt(sSendLength) then
          begin
            HomeInfoLogging('> 단지서버 상태요청에 대한 응답: ' + sSend);
          end
          else
          begin
            HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러: ' + sSend);
          end;
        end
        else
        begin
          if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
          begin
            if is_Ping(sHomeInfo_IP) then
            begin
              try
                csHomeInfo_EZ.Close;
                csHomeInfo_EZ.Open;

                if csHomeInfo_EZ.Socket.Connected then
                begin
                  if csHomeInfo_EZ.Socket.SendText(sSend) = StrToInt(sSendLength) then
                  begin
                    HomeInfoLogging('> 단지서버 상태요청에 대한 응답(2): ' + sSend);
                  end
                  else
                  begin
                    HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러(2): ' + sSend);
                  end;
                end
                else
                  HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 네트워크 에러');
              except
                on E: Exception do HomeInfoLogging('이지빌 상태요청에 대한 응답시 에러: ' + aString(E.Message));
              end;
            end
            else
              HomeInfoLogging('이지빌 단지서버로 상태요청에 대한 응답전송 시도시 Ping 안됨!');
          end;
        end;
      end;
      sHomeInfo_Temp:= '';
    end
    else if nHomeVisit = 0 then         //방문자 사용안함
    begin
      if (Pos('$cmd=10', sHomeInfo_Temp) > 0) then
      begin

        //홈서버에서의 상태요청에 대한 응답...
        sSend:= Copy(sHomeInfo_Temp, 15, Length(sHomeInfo_Temp)-14) + '#dongho=' +
                sezvilleDong + '&' + sezvilleho + '#ip=' + sHomeInfo_IP + '#status=0';
        sTemp:= Copy(sSend, 1, Pos('cmd', sSend)-1) + 'cmd=11$' + Copy(sSend, Pos('target', sSend), Length(sSend)- (Pos('target', sSend)-1));
        sSend:= sTemp;
        sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
        nSendLength:= StrToInt(sSendLength);
        sSend:= '<start=' + sSendLength + '&0>' + sSend;

        if csHomeInfo_EZ.Socket.Connected then

        begin
          if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
          begin
            HomeInfoLogging('> 단지서버 상태요청에 대한 응답: ' + sSend);
          end
          else
          begin
            HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러: ' + sSend);
          end;
        end
        else
        begin
          if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
          begin
            if is_Ping(sHomeInfo_IP) then
            begin
              try
                csHomeInfo_EZ.Close;
                csHomeInfo_EZ.Open;

                if csHomeInfo_EZ.Socket.Connected then
                begin
                  if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
                  begin
                    HomeInfoLogging('> 단지서버 상태요청에 대한 응답(2): ' + sSend);
                  end
                  else
                  begin
                    HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 에러(2): ' + sSend);
                  end;
                end
                else
                  HomeInfoLogging('> 단지서버 상태요청에 대한 응답시 네트워크 에러');
              except
                on E: Exception do HomeInfoLogging('이지빌 상태요청에 대한 응답시 에러: ' + aString(E.Message));
              end;
            end
            else
              HomeInfoLogging('이지빌 단지서버로 상태요청에 대한 응답전송 시도시 Ping 안됨!');
          end;
        end;
      end;
      sHomeInfo_Temp:= '';
    end;

  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.csEZVilleRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.csEZVilleRead: ' + E.Message);
  end;
end;

procedure TfrmMain.csHomeInfo_GyeConnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  try
    HomeInfoLogging('단지서버 Connect');

    if sHomeInfo_Data <> '' then
    begin
      if csHomeInfo_Gye.Socket.Connected then
      begin
        csHomeInfo_Gye.Socket.SendText(sHomeInfo_Data);
        HomeInfoLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
        sHomeInfo_Data:= '';
      end
      else
      begin
        csHomeInfo_Gye.Active:= True;

        if csHomeInfo_Gye.Socket.Connected then
        begin
          csHomeInfo_Gye.Socket.SendText(sHomeInfo_Data);
          HomeInfoLogging(sHomeInfo_CarNo + '차량 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
          sHomeInfo_Data:= '';
        end
        else
          sHomeInfo_Data:= '';
      end;
    end;
  except
    on E: Exception do ExceptLogging('단지서버 전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_GyeDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_GyeError(Sender: TObject;
  Socket: TCustomWinSocket; ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  try
    sHomeInfo_Data:= '';
    HomeInfoLogging('단지서버 Connect error: ' + IntToStr(ErrorCode));
    ErrorCode := 0;
  except
    on E: Exception do ExceptLogging('단지서버 Connect error: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_GyeRead(Sender: TObject;
  Socket: TCustomWinSocket);
var
  sRecv, sSend, sSendLength, sTemp: aString;
  nSendLength: Integer;
begin
  try
    sHomeInfo_Temp:= Socket.ReceiveText;

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 단지서버 수신(' + IntToStr(GetTickCount) + '): ' + toHex(sHomeInfo_Temp));

    if (Pos('ok', sHomeInfo_Temp) > 0) then
    begin
      //홈서버에서의 상태요청에 대한 응답...
      HomeInfoLogging('< 단지서버에서 ok 수신');
      csHomeInfo_Gye.Active:= False;
    end
    else
    if (Pos('fail', sHomeInfo_Temp) > 0) then
    begin
      HomeInfoLogging('< 단지서버에서 fail 수신');
      csHomeInfo_Gye.Active:= False;
    end;
    sHomeInfo_Temp:= '';
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
  end;
end;

procedure TfrmMain.csHomeInfo_iconConnect(Sender: TObject; Socket: TCustomWinSocket);
begin
  try
    HomeInfoLogging('csHomeInfo_iconConnect');

    if sHomeInfo_Data <> '' then
    begin
      if csHomeInfo_icon.Socket.Connected then
      begin
        csHomeInfo_icon.Socket.SendText(sHomeInfo_Data);
        HomeInfoLogging(sHomeInfo_CarNo + '차량 ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
        sHomeInfo_Data:= '';
      end
      else
      begin
        csHomeInfo_icon.Active:= True;

        if csHomeInfo_icon.Socket.Connected then
        begin
          csHomeInfo_icon.Socket.SendText(sHomeInfo_Data);
          HomeInfoLogging(sHomeInfo_CarNo + '차량 ' + sHomeInfo_Dong + '동 ' + sHomeInfo_Ho + '호 세대전송! (단지서버 IP-' + sHomeInfo_IP + ')  ' + sHomeInfo_IP);
          sHomeInfo_Data:= '';
        end
        else
        begin
          sHomeInfo_Data:= '';
          ExceptLogging('아이콘트롤스 단지서버 연결시 에러');
        end;
      end;
    end;
  except
    on E: Exception do ExceptLogging('아이콘트롤스 단지서버 전송시 에러: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_iconDisconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  HomeInfoLogging('단지서버 Disconnect');
end;

procedure TfrmMain.csHomeInfo_iconError(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  try
    sHomeInfo_Data:= '';
    HomeInfoLogging('단지서버 Connect error: ' + IntToStr(ErrorCode));
    ErrorCode := 0;
  except
    on E: Exception do ExceptLogging('단지서버 Connect error: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.csHomeInfo_iconRead(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv, sSend, sSendLength, sTemp: aString;
  nSendLength: Integer;
begin
  try
    sHomeInfo_Temp:= Socket.ReceiveText;

    if sHomeInfo_Temp = '' then Exit;

    HomeInfoLogging('< 단지서버 수신(' + IntToStr(GetTickCount) + '): ' + toHex(sHomeInfo_Temp));

    if (Pos('ok', sHomeInfo_Temp) > 0) then
    begin
      //홈서버에서의 상태요청에 대한 응답...
      HomeInfoLogging('< 단지서버에서 ok 수신');
      csHomeInfo_icon.Active:= False;
    end
    else
    if (Pos('fail', sHomeInfo_Temp) > 0) then
    begin
      HomeInfoLogging('< 단지서버에서 fail 수신');
      csHomeInfo_icon.Active:= False;
    end;
    sHomeInfo_Temp:= '';
  except
    on E: EIdSocketError do
    begin
      if E.LastError <> 10054 then HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
      Exit;
    end;

    on E: EIdConnClosedGracefully do Exit;

    on E: Exception do HomeInfoLogging('TfrmMain.csHomeInfoRead: ' + E.Message);
  end;
end;

procedure TfrmMain.csInDsp1Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp1_connect');
end;

procedure TfrmMain.csInDsp1Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp1_Disconnect');
end;

procedure TfrmMain.csInDsp1Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin

end;

procedure TfrmMain.csInDsp1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[IN]>DSP1 Recv: ' + sRecv);
end;


procedure TfrmMain.csInDsp2Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp2_connect');
end;

procedure TfrmMain.csInDsp2Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
 ExceptLogging('InDsp2_Disconnect');
end;

procedure TfrmMain.csInDsp2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[IN]>DSP2 Recv: ' + sRecv);
end;

procedure TfrmMain.csInDsp3Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp3_connect');
end;

procedure TfrmMain.csInDsp3Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp3_Disconnect');
end;

procedure TfrmMain.csInDsp3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[IN]>DSP3 Recv: ' + sRecv);
end;

procedure TfrmMain.csInDsp4Connect(Sender: TObject; Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp4_connect');
end;

procedure TfrmMain.csInDsp4Disconnect(Sender: TObject;
  Socket: TCustomWinSocket);
begin
  ExceptLogging('InDsp4_Disconnect');
end;

procedure TfrmMain.csInDsp4Read(Sender: TObject; Socket: TCustomWinSocket);
var
  sRecv: aString;
begin
  sRecv := Socket.ReceiveText;
  ExceptLogging('[IN]>DSP4 Recv: ' + sRecv);
end;

procedure TfrmMain.csInLpr1Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('InLpr1Error: ' + IntToStr(ErrorCode));
  ErrorCode := 0;
end;

procedure TfrmMain.csInLpr1Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : integer;            //후방데이터 여부 1 : 후방,  0 : 전방
begin
  try
    tInAlive1.Enabled := False;
    sRecv := Socket.ReceiveText;      // 소켓 데이터  => CH1#31로6811#N#\2014\09\30\CH1_20140930205613_31로6811.jpg
    sInLPRRecv1 := sRecv;
    ExceptLogging('LPR ' + IntToStr(csInLpr1.Tag) + ' Recv: ' + sInLPRRecv1);

    // 소켓 데이터 길이가 15자 초과이면
    if Length(sInLPRRecv1) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr1.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;       // 전광판 IP
          Break;
        end;
      end;

      nNo := csInLpr1.Tag;                // LPR 기기번호
      sLprData := sInLPRRecv1;
      sLprIP := csInLpr1.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr1;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen1 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          // 세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) - (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면의 결과와 후면의 결과가 오인식이 아닌 다른 차로 인식된 경우.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;        //후방데이터
        end
        // CH
        else
        begin
          // 바오픈
          bInBarOpen1 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp));
          // 'CH1_20141021141836_31로6819.jpg'
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) - (Pos('CH', sFile1) - 1));
          // '2014-10-21 14:18:36'
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14), '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');
        end;


        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr(nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2) + ', ' + sTime);

        // 차량 전면 이미지
        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        // 차량 후면 이미지
        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length(sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        // 이미지 파일 임시파일에 저장
        sTempFile1:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;                // 입출구구분
            nListCnt:= RLpr[i].nLprCnt;        // LPR 개수 ???
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryInLpr1Proc do
          begin
             //정기차량 Full 번호 확인
             Close;
             SQL.Clear;
             SQL.Add('Select * from CustInfo ');
             if sCarNo2 <> '' then
             begin
               SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Parameters.ParamByName('N2').Value := sCarNo2;
               Open;
             end
             else
             if sCarNo1 <> '' then
             begin
               SQL.Add('where CarNo = :N1 and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Open;
             end;

             if RecordCount > 0 then
             begin
                // 등록된 정기차량이면...
                sCarNo1:= FieldByName('CarNO').AsString;

                // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                if bSCProcWait then
                begin
                  if nSCWaitPoint = 20 then
                    nSCWaitPoint := 1
                  else
                    nSCWaitPoint := nSCWaitPoint + 1;

                  RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                  RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                  RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                  RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                  RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                  RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                  RSCWait[nSCWaitPoint].nSCInOut := nIO;
                  RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                  RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                  RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                  RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                  RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                  RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen1;
                  RSCWait[nSCWaitPoint].nBackData:= nBackData;

                  if not tSCWait.Enabled then
                    tSCWait.Enabled := True;
                end
                else
                begin
                  sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                         nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen1, nListCnt, nBackData);
                  GridData(nIO, nListCnt, sResult);

                  if bHomeInfo then
                    HomeInfo_Proc(nIO);
                end;
             end
             else
             begin
              //풀번호 확인시 없을 경우
                if b6Proc then  begin

//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = :N1');
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end

                  if RecordCount > 0 then
                  begin
                    // 등록된 정기차량이면...
                    sCarNo1:= FieldByName('CarNO').AsString;

                    // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                    if bSCProcWait then
                    begin
                      if nSCWaitPoint = 20 then
                        nSCWaitPoint := 1
                      else
                        nSCWaitPoint := nSCWaitPoint + 1;

                      RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                      RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                      RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                      RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                      RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                      RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                      RSCWait[nSCWaitPoint].nSCInOut := nIO;
                      RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                      RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                      RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                      RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                      RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                      RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen1;
                      RSCWait[nSCWaitPoint].nBackData:= nBackData;

                      if not tSCWait.Enabled then
                        tSCWait.Enabled := True;
                    end
                    else
                    begin
                      sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                             nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen1, nListCnt, nBackData);
                      GridData(nIO, nListCnt, sResult);
                    end;
                  end
                  else
                  begin
                    // 정상인식시 일반차량 처리...
                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;
                        RNCInWait[nNCInWaitPoint].nBackData:= nBackData;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                        RNCOutWait[nNCOutWaitPoint].nBackData:= nBackData;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end;
                  end;

                end
                else
                begin
                  if nIO = 1 then
                  begin
                    if bNCInProcWait then
                    begin
                      if nNCInWaitPoint = 20 then
                        nNCInWaitPoint := 1
                      else
                        nNCInWaitPoint := nNCInWaitPoint + 1;

                      RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                      RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                      RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                      RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                      RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                      RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                      RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                      RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                      RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                      RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                      RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;
                      RNCInWait[nNCInWaitPoint].nBackData:= nBackData;

                      if not tNCInWait.Enabled then
                        tNCInWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end
                  else if nIO = 2 then
                  begin
                    if bNCOutProcWait then
                    begin
                      if nNCOutWaitPoint = 20 then
                        nNCOutWaitPoint := 1
                      else
                        nNCOutWaitPoint := nNCOutWaitPoint + 1;

                      RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                      RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                      RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                      RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                      RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                      RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                      RNCOutWait[nNCOutWaitPoint].bBarOpen := True;
                      RNCOutWait[nNCOutWaitPoint].nBackData:= nBackData;

                      if not tNCOutWait.Enabled then
                        tNCOutWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end;
                end;
             end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          if bMiIn then
          begin
            //미인식차량 입차시...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen1;
                RNCInWait[nNCInWaitPoint].nBackData:= nBackData;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
            //미인식차량
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;

              if not bMode then
              begin
                if nBackData = 1 then
                begin
                  ExceptLogging('후방데이터 차단기 동작안함');
                end
                else
                begin
                  InOpen(csLPR);
                end;
              end;

              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end
            else if nIO = 2 then
            begin
              //출구...
              with frmMain do
              begin
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);

            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr1Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv1 = 'LPR_R' then
      begin
        if chkNet(csInLpr1, '시간동기화 전송') then
        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sInLPRRecv1 := '';
  finally
    tInAlive1.Enabled := True;
  end;
end;

procedure TfrmMain.csInLpr2Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('InLpr2Error: ' + IntToStr(ErrorCode));
  errorcode := 0;
end;

procedure TfrmMain.csInLpr2Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tInAlive2.Enabled := False;
    sRecv := Socket.ReceiveText;
    sInLPRRecv2 := sRecv;
    ExceptLogging('LPR' + IntToStr(csInLpr2.Tag) + ' Recv: ' + sInLPRRecv2);

    if Length(sInLPRRecv2) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr2.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr2.Tag;
      sLprData := sInLPRRecv2;
      sLprIP := csInLpr2.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr2;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen2 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          bInBarOpen2 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile2:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryInLpr2Proc do
          begin
             //정기차량 Full 번호 확인
             Close;
             SQL.Clear;
             SQL.Add('Select * from CustInfo ');
             if sCarNo2 <> '' then
             begin
               SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Parameters.ParamByName('N2').Value := sCarNo2;
               Open;
             end
             else
             if sCarNo1 <> '' then
             begin
               SQL.Add('where CarNo = :N1 and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Open;
             end;

             if RecordCount > 0 then
             begin
                // 등록된 정기차량이면...
                sCarNo1:= FieldByName('CarNO').AsString;

                // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                if bSCProcWait then
                begin
                  if nSCWaitPoint = 20 then
                    nSCWaitPoint := 1
                  else
                    nSCWaitPoint := nSCWaitPoint + 1;

                  RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                  RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                  RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                  RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                  RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                  RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                  RSCWait[nSCWaitPoint].nSCInOut := nIO;
                  RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                  RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                  RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                  RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                  RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                  RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen2;

                  if not tSCWait.Enabled then
                    tSCWait.Enabled := True;
                end
                else
                begin
                  sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                         nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen2, nListCnt, nBackData);
                  GridData(nIO, nListCnt, sResult);

                  if bHomeInfo then
                    HomeInfo_Proc(nIO);
                end;
             end
             else
             begin
              //풀번호 확인시 없을 경우
                if b6Proc then  begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end

                  if RecordCount > 0 then
                  begin
                    // 등록된 정기차량이면...
                    sCarNo1:= FieldByName('CarNO').AsString;

                    // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                    if bSCProcWait then
                    begin
                      if nSCWaitPoint = 20 then
                        nSCWaitPoint := 1
                      else
                        nSCWaitPoint := nSCWaitPoint + 1;

                      RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                      RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                      RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                      RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                      RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                      RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                      RSCWait[nSCWaitPoint].nSCInOut := nIO;
                      RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                      RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                      RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                      RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                      RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                      RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen2;

                      if not tSCWait.Enabled then
                        tSCWait.Enabled := True;
                    end
                    else
                    begin
                      sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                             nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen2, nListCnt, nBackData);
                      GridData(nIO, nListCnt, sResult);
                    end;
                  end
                  else
                  begin
                    // 정상인식시 일반차량 처리...
                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end;
                  end;

                end
                else
                begin
                  if nIO = 1 then
                  begin
                    if bNCInProcWait then
                    begin
                      if nNCInWaitPoint = 20 then
                        nNCInWaitPoint := 1
                      else
                        nNCInWaitPoint := nNCInWaitPoint + 1;

                      RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                      RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                      RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                      RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                      RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                      RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                      RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                      RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                      RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                      RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                      RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;

                      if not tNCInWait.Enabled then
                        tNCInWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end
                  else if nIO = 2 then
                  begin
                    if bNCOutProcWait then
                    begin
                      if nNCOutWaitPoint = 20 then
                        nNCOutWaitPoint := 1
                      else
                        nNCOutWaitPoint := nNCOutWaitPoint + 1;

                      RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                      RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                      RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                      RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                      RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                      RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                      RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                      if not tNCOutWait.Enabled then
                        tNCOutWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end;
                end;
             end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          if bMiIn then
          begin
            //미인식차량 입차시...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen2;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
            //미인식차량
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;

              if not bMode then
              begin
                if nBackData = 1 then
                begin
                  ExceptLogging('후방데이터 차단기 동작안함');
                end
                else
                begin
                  InOpen(csLPR);
                end;
              end;
              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end
            else if nIO = 2 then
            begin
              //출구...
              with frmMain do
              begin
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);

            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr2Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv2 = 'LPR_R' then
      begin
        if chkNet(csInLpr2, '시간동기화 전송') then
        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sInLPRRecv2 := '';
  finally
    tInAlive2.Enabled := True;
  end;
end;

procedure TfrmMain.csInLpr3Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('InLpr3Error: ' + IntToStr(ErrorCode));
  errorcode := 0;
end;

procedure TfrmMain.csInLpr3Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tInAlive3.Enabled := False;
    sRecv := Socket.ReceiveText;
    sInLPRRecv3 := sRecv;
    ExceptLogging('LPR' + IntToStr(csInLpr3.Tag) + ' Recv: ' + sInLPRRecv3);

    if Length(sInLPRRecv3) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr3.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr3.Tag;
      sLprData := sInLPRRecv3;
      sLprIP := csInLpr3.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr3;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen3 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          bInBarOpen3 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile2:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryInLpr3Proc do
          begin
             //정기차량 Full 번호 확인
             Close;
             SQL.Clear;
             SQL.Add('Select * from CustInfo ');
             if sCarNo2 <> '' then
             begin
               SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Parameters.ParamByName('N2').Value := sCarNo2;
               Open;
             end
             else
             if sCarNo1 <> '' then
             begin
               SQL.Add('where CarNo = :N1 and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Open;
             end;

             if RecordCount > 0 then
             begin
                // 등록된 정기차량이면...
                sCarNo1:= FieldByName('CarNO').AsString;

                // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                if bSCProcWait then
                begin
                  if nSCWaitPoint = 20 then
                    nSCWaitPoint := 1
                  else
                    nSCWaitPoint := nSCWaitPoint + 1;

                  RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                  RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                  RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                  RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                  RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                  RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                  RSCWait[nSCWaitPoint].nSCInOut := nIO;
                  RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                  RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                  RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                  RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                  RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                  RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen3;

                  if not tSCWait.Enabled then
                    tSCWait.Enabled := True;
                end
                else
                begin
                  sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                         nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen3, nListCnt, nBackData);
                  GridData(nIO, nListCnt, sResult);

                  if bHomeInfo then
                    HomeInfo_Proc(nIO);
                end;
             end
             else
             begin
              //풀번호 확인시 없을 경우
                if b6Proc then  begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end

                  if RecordCount > 0 then
                  begin
                    // 등록된 정기차량이면...
                    sCarNo1:= FieldByName('CarNO').AsString;

                    // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                    if bSCProcWait then
                    begin
                      if nSCWaitPoint = 20 then
                        nSCWaitPoint := 1
                      else
                        nSCWaitPoint := nSCWaitPoint + 1;

                      RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                      RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                      RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                      RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                      RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                      RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                      RSCWait[nSCWaitPoint].nSCInOut := nIO;
                      RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                      RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                      RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                      RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                      RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                      RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen3;

                      if not tSCWait.Enabled then
                        tSCWait.Enabled := True;
                    end
                    else
                    begin
                      sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                             nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen3, nListCnt, nBackData);
                      GridData(nIO, nListCnt, sResult);
                    end;
                  end
                  else
                  begin
                    // 정상인식시 일반차량 처리...
                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen3;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end;
                  end;
                end
                else
                begin
                  if nIO = 1 then
                  begin
                    if bNCInProcWait then
                    begin
                      if nNCInWaitPoint = 20 then
                        nNCInWaitPoint := 1
                      else
                        nNCInWaitPoint := nNCInWaitPoint + 1;

                      RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                      RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                      RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                      RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                      RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                      RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                      RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                      RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                      RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                      RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                      RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen3;

                      if not tNCInWait.Enabled then
                        tNCInWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end
                  else if nIO = 2 then
                  begin
                    if bNCOutProcWait then
                    begin
                      if nNCOutWaitPoint = 20 then
                        nNCOutWaitPoint := 1
                      else
                        nNCOutWaitPoint := nNCOutWaitPoint + 1;

                      RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                      RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                      RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                      RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                      RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                      RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                      RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                      if not tNCOutWait.Enabled then
                        tNCOutWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end;
                end;
             end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          if bMiIn then
          begin
            //미인식차량 입차시...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen3;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
            //미인식차량
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;

              if not bMode then
              begin
                if nBackData = 1 then
                begin
                  ExceptLogging('후방데이터 차단기 동작안함');
                end
                else
                begin
                  InOpen(csLPR);
                end;
              end;
              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end
            else if nIO = 2 then
            begin
              //출구...
              with frmMain do
              begin
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);

            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr3Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv3 = 'LPR_R' then
      begin
        if chkNet(csInLpr3, '시간동기화 전송') then
        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sInLPRRecv3 := '';
  finally
    tInAlive3.Enabled := True;
  end;
end;

procedure TfrmMain.csInLpr4Error(Sender: TObject; Socket: TCustomWinSocket;
  ErrorEvent: TErrorEvent; var ErrorCode: Integer);
begin
  ExceptLogging('InLpr4Error: ' + IntToStr(ErrorCode));
  errorcode := 0;
end;

procedure TfrmMain.csInLpr4Read(Sender: TObject; Socket: TCustomWinSocket);
var
  nNo: Word;
  sLprData, sLprIP, sDspIP: aString;
  csLPR: TClientSocket;
  sRecv, sExpDateF, sExpDateT, sCarNo1, sCarNo2, sShortCarNo: aString;
  i: Byte;
  sTime, sTemp, sResult, sTest, sDir, sLocal1, sLocal2: String;
  sFile1, sFile2, sImgFile1, sImgFile2: String;
  nRecog1, nRecog2, nIO, nListCnt, nCarNoLength: Byte;
  hr: HRESULT;
  sSend: aString;
  nBackData : Integer;
begin
  try
    tInAlive4.Enabled := False;
    sRecv := Socket.ReceiveText;
    sInLPRRecv4 := sRecv;
    ExceptLogging('LPR' + IntToStr(csInLpr4.Tag) + ' Recv: ' + sInLPRRecv4);

    if Length(sInLPRRecv4) > 15 then
    begin
      for i := 1 to 10 do
      begin
        if RLpr[i].nUnitNo = csInLpr4.Tag then
        begin
          sDspIP := RLpr[i].sDspIP;
          Break;
        end;
      end;

      nNo := csInLpr4.Tag;
      sLprData := sInLPRRecv4;
      sLprIP := csInLpr4.Host;
      sDspIP := sDspIP;
      csLPR := csInLpr4;
      nBackData := 0;

      try
        sCarNo1 := '';
        sCarNo2 := '';
        sFile1 := '';
        sFile2 := '';
        nRecog1 := 0;
        nRecog2 := 0;

        // NW, NP, UP가 올 경우는 차단기를 오픈하지 않는다. 2012-06-15...
        bInBarOpen4 := False;

        if Copy(sLprData, 1, 2) = 'NW' then
        begin
          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          // 후면촬영결과가 전면촬영차량과 다르다. (새로운 차량이다)
          // NW제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr(sFile1, '\', '/');

          //세종시 컨티넨탈에서는 NW를 처리하지 않기로 한다.  2012-09-09
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'UP' then
        begin
          // 오인식으로 전면과 후면촬영결과가 다르다...
          // 이때는 CarNo1과 CarNo2, Image1, Image2를 구분하여 넣는다.
          // 전면차량번호와 입차일시를 가지고 DB검색하여 CarNo2와 Image2를 업데이트한다.

          // UP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos('#', sTemp)),
            '\', '/');
          Exit;
        end
        else if Copy(sLprData, 1, 2) = 'NP' then
        begin
          // 전면촬영된 차량과 후면촬영된 차량이 다르다.
          // 이때는 CarNo2를 개별차량으로 하여 신규입차처리한다.
          // CarNo2, File2, Recog2, Time2 로 신규입차 처리.

          // NP제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호1 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부1 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 파일명1 추출
          sFile1 := Copy(sTemp, 1, Pos('#', sTemp) - 1); // Copy(sTemp, Pos('#', sTemp)+1, Length(sTemp)-Pos('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');

          // 파일명1제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // CH제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 차량번호2 추출
          sCarNo2 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호2제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부2 추출
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog2 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog2 := 2
          else
            nRecog2 := 3;

          sLocal2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal2 := Copy(sLocal2, Pos('CH', sLocal2), Length(sLocal2) -
              (Pos('CH', sLocal2) - 1));
          sFile2 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sTime := MG_StrToStr(Copy(sFile2, Pos('_', sFile2) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부2제거하여 파일명2 추출
          sFile2 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile2, '\', '/');
          sCarNo1 := sCarNo2;
          sFile1 := sFile2;
          nRecog1 := nRecog2;
          sLocal1 := sLocal2;
          sCarNo2 := '';
          sFile2 := '';
          nRecog2 := 0;
          sLocal2 := '';
          nBackData := 1;
        end
        else
        begin
          bInBarOpen4 := True;

          // CH제거
          sTemp := Copy(sLprData, Pos('#', sLprData) + 1, Length(sLprData) - Pos
              ('#', sLprData));

          // 차량번호 추출
          sCarNo1 := Copy(sTemp, 1, Pos('#', sTemp) - 1);

          // 차량번호제거
          sTemp := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));

          // 인식여부 추출(1:정상인식, 2:부분인식, 3:인식오류)
          if (Copy(sTemp, 1, 1) = 'N') or (Copy(sTemp, 1, 1) = 'O') then
            nRecog1 := 1
          else if Copy(sTemp, 1, 1) = 'P' then
            nRecog1 := 2
          else
            nRecog1 := 3;

          // 인식여부제거하여 파일명 추출
          sFile1 := Copy(sTemp, Pos('#', sTemp) + 1, Length(sTemp) - Pos
              ('#', sTemp));
          sLocal1 := Copy(sFile1, Pos('CH', sFile1), Length(sFile1) -
              (Pos('CH', sFile1) - 1));
          sTime := MG_StrToStr(Copy(sFile1, Pos('_', sFile1) + 1, 14),
            '####-##-## ##:##:##');

          // 인식여부제거하여 파일명 추출
          sFile1 := 'http://' + sLprIP + ':9080/MSImage' + MG_ReplaceStr
            (sFile1, '\', '/');
        end;
        ExceptLogging('LPR Check: ' + sCarNo1 + ',' + sFile1 + ',' + IntToStr
            (nRecog1) + ',' + sCarNo2 + ',' + sFile2 + ',' + IntToStr(nRecog2)
            + ', ' + sTime);

        if sFile1 <> '' then
        begin
          sTemp := Copy(sFile1, 6, Length(sFile1) - 5);
          sImgFile1 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile1 := sImgFile1 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile1 := MG_StrConvert(sImgFile1, '/', '\');
          ExceptLogging('File: ' + sImgFile1);
        end;

        if sFile2 <> '' then
        begin
          sTemp := Copy(sFile2, 6, Length(sFile2) - 5);
          sImgFile2 := Copy(sTemp, 1, Pos(':9080', sTemp) - 1);
          sImgFile2 := sImgFile2 + Copy(sTemp, Pos(':9080', sTemp) + 5, Length
              (sTemp) - (Pos(':9080', sTemp) + 4));
          sImgFile2 := MG_StrConvert(sImgFile2, '/', '\');
          ExceptLogging('File: ' + sImgFile2);
        end;
        sTempFile2:= sImgFile1;

        for i := 1 to 10 do
        begin
          if RLpr[i].nUnitNo = nNo then
          begin
            nIO := RLpr[i].nIO;
            nListCnt:= RLpr[i].nLprCnt;
          end;
        end;

        //        if (nRecog1 = 1) then       //부분미인식도 숫자만 비교
        if (nRecog1 = 1) or (nRecog1 = 2) then
        begin
          with dmTables.qryInLpr4Proc do
          begin
             //정기차량 Full 번호 확인
             Close;
             SQL.Clear;
             SQL.Add('Select * from CustInfo ');
             if sCarNo2 <> '' then
             begin
               SQL.Add('where ((CarNo = :N1) or (CarNo = :N2)) and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Parameters.ParamByName('N2').Value := sCarNo2;
               Open;
             end
             else
             if sCarNo1 <> '' then
             begin
               SQL.Add('where CarNo = :N1 and TKType = 2');
               Parameters.ParamByName('N1').Value := sCarNo1;
               Open;
             end;

             if RecordCount > 0 then
             begin
                // 등록된 정기차량이면...
                sCarNo1:= FieldByName('CarNO').AsString;

                // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                if bSCProcWait then
                begin
                  if nSCWaitPoint = 20 then
                    nSCWaitPoint := 1
                  else
                    nSCWaitPoint := nSCWaitPoint + 1;

                  RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                  RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                  RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                  RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                  RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                  RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                  RSCWait[nSCWaitPoint].nSCInOut := nIO;
                  RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                  RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                  RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                  RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                  RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                  RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen4;

                  if not tSCWait.Enabled then
                    tSCWait.Enabled := True;
                end
                else
                begin
                  sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                         nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen4, nListCnt, nBackData);
                  GridData(nIO, nListCnt, sResult);

                  if bHomeInfo then
                    HomeInfo_Proc(nIO);
                end;
             end
             else
             begin
              //풀번호 확인시 없을 경우
                if b6Proc then  begin
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 start
//                  sShortCarNo:= Copy(sCarNo1, Length(sCarNo1) -3, 4);
//                  nCarNoLength:= Length(sCarNo1);
//                  Close;
//                  SQL.Clear;
//                  SQL.Add('Select * from ');
//                  SQL.Add('(Select * from CustInfo where SUBSTRING(CarNo, 4, 4) = :N1 or ');
//                  SQL.Add(' SUBSTRING(CarNo, 6, 4) = :N2 or SUBSTRING(CarNo, 5, 4) = :N7) d ');
//                  Parameters.ParamByName('N1').Value:= sShortCarNo;
//                  Parameters.ParamByName('N2').Value:= sShortCarNo;
//                  Parameters.ParamByName('N7').Value:= sShortCarNo;
//
//                  Case nCarNoLength of
//                    11: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 1) = :N3');
//                          Parameters.ParamByName('N3').Value:= Copy(sCarNo1, 5, 1);
//                        end;
//                    12: begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 5, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 5, 2);
//                        end;
//                    8 : begin
//                          SQL.Add('where SUBSTRING(d.CarNo, 3, 2) = :N4 or ');
//                          SQL.Add('SUBSTRING(d.CarNo, 1, 2) = :N5');
//                          Parameters.ParamByName('N4').Value:= Copy(sCarNo1, 1, 2);
//                          Parameters.ParamByName('N5').Value:= Copy(sCarNo1, 1, 2);
//                        end;
//                  end;
                  sShortCarNo := FindNumber(sCarNo1);
                  Close;
                  SQL.Clear;
//                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) = ' +  sShortCarNo);
                  SQL.Add('select * from custinfo where dbo.UFN_GET_NUMBER(carno) =  ''' + sShortCarNo+ '''');
                  open;
//Modified Woo.YH 차량번호 길이가 아닌 숫자값 추출로 비교 end
                  if RecordCount > 0 then
                  begin
                    // 등록된 정기차량이면...
                    sCarNo1:= FieldByName('CarNO').AsString;

                    // 유효기간이 만료되지 않은 사용가능한 정기차량이면...
                    if bSCProcWait then
                    begin
                      if nSCWaitPoint = 20 then
                        nSCWaitPoint := 1
                      else
                        nSCWaitPoint := nSCWaitPoint + 1;

                      RSCWait[nSCWaitPoint].sSCFile1 := sFile1;
                      RSCWait[nSCWaitPoint].sSCCarNo1 := sCarNo1;
                      RSCWait[nSCWaitPoint].sSCFile2 := sFile2;
                      RSCWait[nSCWaitPoint].sSCCarNo2 := sCarNo2;
                      RSCWait[nSCWaitPoint].sSCIOTime := sTime;
                      RSCWait[nSCWaitPoint].nSCLprNo := nNo;
                      RSCWait[nSCWaitPoint].nSCInOut := nIO;
                      RSCWait[nSCWaitPoint].nSCLprCnt:= nListCnt;
                      RSCWait[nSCWaitPoint].nSCRecog1 := nRecog1;
                      RSCWait[nSCWaitPoint].nSCRecog2 := nRecog2;
                      RSCWait[nSCWaitPoint].sSCDspIP := sDspIP;
                      RSCWait[nSCWaitPoint].csSCLPR := csLPR;
                      RSCWait[nSCWaitPoint].bBarOpen := bInBarOpen4;

                      if not tSCWait.Enabled then
                        tSCWait.Enabled := True;
                    end
                    else
                    begin
                      sResult := RecvLprProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime,
                                             nNo, nIO, nRecog1, nRecog2, sDspIP, csLPR, bInBarOpen4, nListCnt, nBackData);
                      GridData(nIO, nListCnt, sResult);
                    end;
                  end
                  else
                  begin
                    // 정상인식시 일반차량 처리...
                    if nIO = 1 then
                    begin
                      if bNCInProcWait then
                      begin
                        if nNCInWaitPoint = 20 then
                          nNCInWaitPoint := 1
                        else
                          nNCInWaitPoint := nNCInWaitPoint + 1;

                        RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                        RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                        RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                        RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                        RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                        RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                        RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                        RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                        RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                        RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                        RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen4;

                        if not tNCInWait.Enabled then
                          tNCInWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end
                    else if nIO = 2 then
                    begin
                      if bNCOutProcWait then
                      begin
                        if nNCOutWaitPoint = 20 then
                          nNCOutWaitPoint := 1
                        else
                          nNCOutWaitPoint := nNCOutWaitPoint + 1;

                        RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                        RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                        RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                        RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                        RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                        RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                        RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                        RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                        RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                        RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                        RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                        if not tNCOutWait.Enabled then
                          tNCOutWait.Enabled := True;
                      end
                      else
                      begin
                        NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                          nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                      end;
                    end;
                  end;

                end
                else
                begin
                  if nIO = 1 then
                  begin
                    if bNCInProcWait then
                    begin
                      if nNCInWaitPoint = 20 then
                        nNCInWaitPoint := 1
                      else
                        nNCInWaitPoint := nNCInWaitPoint + 1;

                      RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                      RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                      RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                      RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                      RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                      RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                      RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                      RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                      RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                      RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                      RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen4;

                      if not tNCInWait.Enabled then
                        tNCInWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end
                  else if nIO = 2 then
                  begin
                    if bNCOutProcWait then
                    begin
                      if nNCOutWaitPoint = 20 then
                        nNCOutWaitPoint := 1
                      else
                        nNCOutWaitPoint := nNCOutWaitPoint + 1;

                      RNCOutWait[nNCOutWaitPoint].sNCFile1 := sImgFile1;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo1 := sCarNo1;
                      RNCOutWait[nNCOutWaitPoint].sNCFile2 := sImgFile2;
                      RNCOutWait[nNCOutWaitPoint].sNCCarNo2 := sCarNo2;
                      RNCOutWait[nNCOutWaitPoint].sNCIOTime := sTime;
                      RNCOutWait[nNCOutWaitPoint].nNCLprNo := nNo;
                      RNCOutWait[nNCOutWaitPoint].nNCInOut := nIO;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog1 := nRecog1;
                      RNCOutWait[nNCOutWaitPoint].nNCRecog2 := nRecog2;
                      RNCOutWait[nNCOutWaitPoint].sNCDspIP := sDspIP;
                      RNCOutWait[nNCOutWaitPoint].csNCLPR := csLPR;
                      RNCOutWait[nNCOutWaitPoint].nNCLprCnt:= nListCnt;
                      RNCOutWait[nNCOutWaitPoint].bBarOpen := True;

                      if not tNCOutWait.Enabled then
                        tNCOutWait.Enabled := True;
                    end
                    else
                    begin
                      NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                        nRecog1, nRecog2, sDspIP, csLPR, False, nListCnt, nBackData);
                    end;
                  end;
                end;
             end;
          end;
        end
        else
        begin
          //미인식차량 처리...
          if bMiIn then
          begin
            //미인식차량 입차시...
            if nIO = 1 then
            begin
              if bNCInProcWait then
              begin
                if nNCInWaitPoint = 20 then
                  nNCInWaitPoint := 1
                else
                  nNCInWaitPoint := nNCInWaitPoint + 1;

                RNCInWait[nNCInWaitPoint].sNCFile1 := sImgFile1;
                RNCInWait[nNCInWaitPoint].sNCCarNo1 := sCarNo1;
                RNCInWait[nNCInWaitPoint].sNCFile2 := sImgFile2;
                RNCInWait[nNCInWaitPoint].sNCCarNo2 := sCarNo2;
                RNCInWait[nNCInWaitPoint].sNCIOTime := sTime;
                RNCInWait[nNCInWaitPoint].nNCLprNo := nNo;
                RNCInWait[nNCInWaitPoint].nNCInOut := nIO;
                RNCInWait[nNCInWaitPoint].nNCRecog1 := nRecog1;
                RNCInWait[nNCInWaitPoint].nNCRecog2 := nRecog2;
                RNCInWait[nNCInWaitPoint].sNCDspIP := sDspIP;
                RNCInWait[nNCInWaitPoint].csNCLPR := csLPR;
                RNCInWait[nNCInWaitPoint].nNCLprCnt:= nListCnt;
                RNCInWait[nNCInWaitPoint].bBarOpen := bInBarOpen4;

                if not tNCInWait.Enabled then
                  tNCInWait.Enabled := True;
              end
              else
              begin
                NormalProc(sImgFile1, sCarNo1, sImgFile2, sCarNo2, sTime, nNo, nIO,
                  nRecog1, nRecog2, sDspIP, csLPR, false, nListCnt, nBackData);
              end;
            end;
          end
          else
          begin
            //미인식차량
            try
              if FileExists(sImgFile1) then
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.LoadFromFile(sImgFile1);
                  end;
                end;
              end
              else
              begin
                if nIO = 1 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgIn' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end
                else
                if nIO = 2 then
                begin
                  with frmMain do
                  begin
                    TImage(FindComponent('imgOut' + IntToStr(nListCnt))).Picture.Assign(Nil);
                  end;
                end;

                ExceptLogging('File 없음: ' + sImgFile1);
              end;
            except
              on E: Exception do
                ExceptLogging('이미지 로드 에러: ' + aString(E.Message));
            end;

            if nIO = 1 then
            begin
              //입구...
              with frmMain do
              begin
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbInG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbInHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtInCarNo' + IntToStr(nListCnt))).Refresh;
              end;

              if not bMode then
              begin
                if nBackData = 1 then
                begin
                  ExceptLogging('후방데이터 차단기 동작안함');
                end
                else
                begin
                  InOpen(csLPR);
                end;
              end;
              DspProc(1, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);
            end
            else if nIO = 2 then
            begin
              //출구...
              with frmMain do
              begin
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Caption:= '미인식';
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Caption:= '';
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Font.Color:= clRed;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Text:= sCarNo1;
                TLabel(FindComponent('lbOutG' + IntToStr(nListCnt))).Refresh;
                TLabel(FindComponent('lbOutHo' + IntToStr(nListCnt))).Refresh;
                TEdit(FindComponent('edtOutCarNo' + IntToStr(nListCnt))).Refresh;
              end;
              DspProc(2, 2, ' 미인식차량 ' + MG_Left(sCarNo1, 12), sDspIP);

            end;
          end;
        end;
      except
        on E: Exception do
          ExceptLogging('csInLpr4Read: ' + aString(E.Message));
      end;
    end
    else
    begin
      if sInLPRRecv4 = 'LPR_R' then
      begin
        if chkNet(csInLpr4, '시간동기화 전송') then
        begin
//          Socket.SendText(aString('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now)));
//          ExceptLogging('시간동기화 전송');
        end;
      end;
    end;
    sInLPRRecv4 := '';
  finally
    tInAlive4.Enabled := True;
  end;
end;

function TfrmMain.FindNumber(Target: string): string;
var
 i, nCnt, dLen: Integer;
 dStr: string;
begin

  dLen := Length(Target);
  for i := 1 to dLen do begin
    if not(Target[i] in['0'..'9']) then Continue;

    for nCnt := i to dLen do begin
      if not(Target[nCnt] in['0'..'9']) then Continue;
      dStr := dStr + Target[nCnt];
    end;

    Result := dStr;
    Break;
  end;
end;

procedure TfrmMain.FormAlign;
begin
//  pnBar.Top := (frmMain.ClientHeight - pnBar.Height) div 2;
//  pnBar.Left := (frmMain.ClientWidth - pnBar.Width) div 2;
//  pnManualProc.Top := (frmMain.ClientHeight - pnManualProc.Height) div 2;
//  pnManualProc.Left := (frmMain.ClientWidth - pnManualProc.Width) div 2;
//  pnSCSearch.Top := (frmMain.ClientHeight - pnSCSearch.Height) div 2;
//  pnSCSearch.Left := (frmMain.ClientWidth - pnSCSearch.Width) div 2;
//  pnHomeInfo.Top := (frmMain.ClientHeight - pnHomeInfo.Height) div 2;
//  pnHomeInfo.Left := (frmMain.ClientWidth - pnHomeInfo.Width) div 2;
//  pnModify.Top := (frmMain.ClientHeight - pnModify.Height) div 2;
//  pnModify.Left := (frmMain.ClientWidth - pnModify.Width) div 2;
end;

function TfrmMain.IntToBool(nNo: Integer): Boolean;
begin
  if nNo = 0 then
    Result := False
  else
    Result := True;
end;

procedure TfrmMain.GridClear;
var
  i, j: Byte;
begin
  with sgIn do
  begin
    Cells[0, 0] := '차량종류';
    Cells[1, 0] := '입차일자';
    Cells[2, 0] := '입차시각';
    Cells[3, 0] := '차량번호';
    if nApt = 1 then
    begin
      Cells[4, 0] := '동/호';
    end
    else if nApt = 0 then
    begin
      Cells[4, 0] := '회사명/부서명';
    end;
    Cells[5, 0] := '성명';
    Cells[6, 0] := '유효기간';
    Cells[7, 0] := '방문목적';
    Cells[8, 0] := '입차라인';

    for i := 1 to RowCount - 1 do
    begin
      for j := 0 to ColCount - 1 do
      begin
        Cells[j, i] := '';
      end;
    end;
  end;
  sgIn.Alignments[0, 0] := taCenter;
  sgIn.Alignments[1, 0] := taCenter;
  sgIn.Alignments[2, 0] := taCenter;
  sgIn.Alignments[3, 0] := taCenter;
  sgIn.Alignments[4, 0] := taCenter;
  sgIn.Alignments[5, 0] := taCenter;
  sgIn.Alignments[6, 0] := taCenter;
  sgIn.Alignments[7, 0] := taCenter;
  sgIn.Alignments[8, 0] := taCenter;

  with sgOut do
  begin
    Cells[0, 0] := '차량종류';
    Cells[1, 0] := '출차일자';
    Cells[2, 0] := '출차시각';
    Cells[3, 0] := '차량번호';
    if nApt = 1 then
    begin
      Cells[4, 0] := '동/호';
    end
    else if nApt = 0 then
    begin
      Cells[4, 0] := '회사명/부서명';
    end;
    Cells[5, 0] := '성명';
    Cells[6, 0] := '유효기간';
    Cells[7, 0] := '방문목적';
    Cells[8, 0] := '출차라인';

    for i := 1 to RowCount - 1 do
    begin
      for j := 0 to ColCount - 1 do
      begin
        Cells[j, i] := '';
      end;
    end;
  end;
  sgOut.Alignments[0, 0] := taCenter;
  sgOut.Alignments[1, 0] := taCenter;
  sgOut.Alignments[2, 0] := taCenter;
  sgOut.Alignments[3, 0] := taCenter;
  sgOut.Alignments[4, 0] := taCenter;
  sgOut.Alignments[5, 0] := taCenter;
  sgOut.Alignments[6, 0] := taCenter;
  sgOut.Alignments[7, 0] := taCenter;
  sgOut.Alignments[8, 0] := taCenter;
end;

procedure TfrmMain.WaitClear;
var
  i: Byte;
begin
  for i := 1 to 20 do
  begin
    RSCWait[i].sSCFile1 := '';
    RSCWait[i].sSCCarNo1 := '';
    RSCWait[i].sSCFile2 := '';
    RSCWait[i].sSCCarNo2:= '';
    RSCWait[i].sSCIOTime:= '';
    RSCWait[i].nSCLprNo := 0;
    RSCWait[i].nSCInOut := 0;
    RSCWait[i].nSCLprCnt:= 0;
    RSCWait[i].nSCRecog1:= 0;
    RSCWait[i].nSCRecog2:= 0;
    RSCWait[i].sSCDspIP := '';
    RSCWait[i].bBarOpen := False;

    RNCInWait[i].sNCFile1 := '';
    RNCInWait[i].sNCCarNo1 := '';
    RNCInWait[i].sNCFile2 := '';
    RNCInWait[i].sNCCarNo2 := '';
    RNCInWait[i].sNCIOTime := '';
    RNCInWait[i].nNCLprNo := 0;
    RNCInWait[i].nNCInOut := 0;
    RNCInWait[i].nNCRecog1 := 0;
    RNCInWait[i].nNCRecog2 := 0;
    RNCInWait[i].nNCLprCnt:= 0;
    RNCInWait[i].sNCDspIP := '';
    RNCInWait[i].bBarOpen := False;

    RNCOutWait[i].sNCFile1 := '';
    RNCOutWait[i].sNCCarNo1 := '';
    RNCOutWait[i].sNCFile2 := '';
    RNCOutWait[i].sNCCarNo2 := '';
    RNCOutWait[i].sNCIOTime := '';
    RNCOutWait[i].nNCLprNo := 0;
    RNCOutWait[i].nNCInOut := 0;
    RNCOutWait[i].nNCRecog1 := 0;
    RNCOutWait[i].nNCRecog2 := 0;
    RNCOutWait[i].nNCLprCnt:= 0;
    RNCOutWait[i].sNCDspIP := '';
    RNCOutWait[i].bBarOpen := False;
  end;
end;

procedure TfrmMain.InitProc;
var
  i: Byte;
begin
  try
    //제어판의 시간형식 설정...
    SetLocaleInfo(LOCALE_SYSTEM_DEFAULT, LOCALE_STIMEFORMAT, 'HH:mm:ss');
//    DateSeparator  := '-';
//    TimeSeparator  := ':';
//    ShortDateFormat:= 'YYYY-MM-DD';
//    LongDateFormat := 'YYYY-MM-DD';
//    ShortTimeFormat:= 'HH:NN:SS';
//    LongTimeFormat := 'HH:NN:SS';

    with frmMain do
    begin
      for i:= 1 to 4 do
      begin
        TLabel(FindComponent('lbInG' + IntToStr(i))).Caption:= '';
        TEdit(FindComponent('edtInHo' + IntToStr(i))).Text:= '';
        TEdit(FindComponent('edtInCarNo' + IntToStr(i))).Text:= '';
        TLabel(FindComponent('lbInG' + IntToStr(i))).Transparent:= True;
         TLabel(FindComponent('lbInHo' + IntToStr(i))).Caption:= '';
        TLabel(FindComponent('lbInHo' + IntToStr(i))).Transparent:= True;
      end;

      for i := 1 to 4 do
      begin
        TLabel(FindComponent('lbOutG' + IntToStr(i))).Caption:= '';
        TEdit(FindComponent('edtOutHo' + IntToStr(i))).Text:= '';
        TEdit(FindComponent('edtOutCarNo' + IntToStr(i))).Text:= '';
        TLabel(FindComponent('lbOutG' + IntToStr(i))).Transparent:= True;
         TLabel(FindComponent('lbOutHo' + IntToStr(i))).Caption:= '';
        TLabel(FindComponent('lbOutHo' + IntToStr(i))).Transparent:= True;
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.InitProc: ' + E.Message);
  end;
end;

procedure TfrmMain.FormCloseQuery(Sender: TObject; var CanClose: Boolean);
begin
  if not bDirectClose then
  begin
    if MessageDlg('프로그램을 종료할까요?', mtConfirmation, [mbYes, mbNo], 0) = mrYes then
    begin
      ExceptLogging('Program Close');
      CanClose := True;
    end
    else
      CanClose := False;
  end
  else
  begin
    ExceptLogging('Program Close');
    CanClose := True;
  end;
end;

procedure TfrmMain.FormCreate(Sender: TObject);
begin
  try
    CreateFileMapping($FFFFFFFF, nil, PAGE_READWRITE, 0, 1, 'SC_IO');

    if GetLastError = ERROR_ALREADY_EXISTS then
    begin
      ShowMessage('정기차량 출입관리 프로그램이 이미 실행중입니다.'#13#13#10 + '확인하여주세요!');
      halt;
    end;
    sCurrRunDir := aString(ExtractFileDir(Application.ExeName));

    if not DirectoryExists('Log') then
      MkDir('Log');

    if not DirectoryExists('Non_Reg') then
      MkDir('Non_Reg');
  except
    on E: Exception do
      ExceptLogging('TfrmMain.FormCreate: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.FormResize(Sender: TObject);
var
  nInLprCount, nOutLprCount, nInList, nOutList, nLogoCount : Integer;
  i, j, nLogo : Integer;
begin
//  iSetting      := TIniFile.Create(ExtractFileDir(Application.ExeName) + '\setting.ini');
//  iSetup := TIniFile.Create(ExtractFileDir(Application.ExeName) + '\ParkSet.ini');
  nInLprCount   := iSetup.ReadInteger('PARKING', '입차LPR수', 0);
  nOutLprCount  := iSetup.ReadInteger('PARKING', '출차LPR수', 0);

  for I := 1 to 3 do        //입차로고 이미지 invisible
  begin
    TPanel(FindComponent('pnInLogo' + IntToStr(i))).Visible := False;
  end;
  for I := 1 to 3 do        //출차로고 이미지 invisible
  begin
    TPanel(FindComponent('pnOutLogo' + IntToStr(i))).Visible := False;
  end;
  for I := 1 to 4 do        //입차 이미지 invisible
  begin
    TPanel(FindComponent('pnIn' + IntToStr(i))).Visible := False;
  end;
  for I := 1 to 4 do        //출차 이미지 invisible
  begin
    TPanel(FindComponent('pnOut' + IntToStr(i))).Visible := False;
  end;

  if nOutLprCount = 0 then      //출차 LPR없을시
  begin
    sgIn.Visible      := True;
    sgOut.Visible     := False;
    lbListOut.Visible := False; //출차현황
    imgSgOut.Visible  := False;
    mnuOutDsp.Visible := False;

    if frmMain.ClientWidth = Screen.Width  then                //전체화면
    begin
      sgin.Width   := frmMain.ClientWidth;
      sgin.Align   := albottom;
      pnList.Width := frmMain.ClientWidth;
      pnList.Align := albottom;
      imgSgIn.Width:= frmMain.ClientWidth;
    end
    else
    begin
      if nInLprCount >= 3 then
      begin
        frmMain.ClientWidth := 1600;
        frmMain.ClientHeight:= 850;
        sgin.Width      := frmMain.ClientWidth;
        sgin.Align      := albottom;
        pnList.Width    := frmMain.ClientWidth;
        pnList.Align    := albottom;
        imgSgIn.Width   := frmMain.ClientWidth;
      end
      else
        frmMain.ClientWidth := 800;
    end;

    pnList.Height   := 430;
    pntot.Height    := frmMain.ClientHeight - pnList.Height-pnBottom.Height;
    lbListIn.Width  := frmMain.ClientWidth;

    if (nInLprCount = 1) or (nInLprCount = 3) then          //로고 추가
    begin
      for i := 1 to nInLprCount do
      begin
        TPanel(FindComponent('pnIn' + IntToStr(i))).Visible := true;
        TPanel(FindComponent('pnIn' + IntToStr(i))).width   := frmMain.ClientWidth div (nInLprCount+1);
        TPanel(FindComponent('pnIn' + IntToStr(i))).Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
        TPanel(FindComponent('pnIn' + IntToStr(i))).top     := 0;
        TPanel(FindComponent('pnIn' + IntToStr(i))).left    := (i-1) * (frmMain.ClientWidth div (nInLprCount+1));
      end;
      pnInLogo1.Visible := true;
      pnInLogo1.Width   := pnIn1.width;
      pnInLogo1.Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
      pnInLogo1.left   := nInLprCount * (frmMain.ClientWidth div (nInLprCount+1));
    end
    else
    begin
      for i := 1 to nInLprCount do
      begin
        TPanel(FindComponent('pnIn' + IntToStr(i))).Visible := true;
        TPanel(FindComponent('pnIn' + IntToStr(i))).width   := frmMain.ClientWidth div nInLprCount;
        TPanel(FindComponent('pnIn' + IntToStr(i))).Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
        TPanel(FindComponent('pnIn' + IntToStr(i))).top     := 0;
        TPanel(FindComponent('pnIn' + IntToStr(i))).left    := (i-1) * (frmMain.ClientWidth div nInLprCount);
      end;
    end;

    sgIn.ColWidths[0] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[1] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[2] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[3] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[4] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[5] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[6] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[7] :=  frmMain.ClientWidth div 9;
    sgIn.ColWidths[8] :=  frmMain.ClientWidth div 9;
//    frmMain.Position := poScreenCenter;
  end
  else         //             입/출 다 있는 경우
  begin
    sgIn.Visible      := True;
    sgOut.Visible     := True;
    lbListOut.Visible := True; //출차현황
    imgSgOut.Visible  := True;
    if nInLprCount + nOutLprCount > 4 then //차량 이미지가 두줄이 필요한 경우    (LPR 5개이상)
    begin
      if frmMain.ClientWidth = Screen.Width  then                //전체화면
      begin
      end
      else
      begin
        frmMain.ClientWidth := 1600;
        frmMain.ClientHeight:= 1000;
      end;

      sgin.Width      := frmMain.ClientWidth div 2;
      sgout.Width     := frmMain.ClientWidth div 2;
      lbListIn.Width  := sgin.Width;
      lbListOut.Width := sgin.Width;

      pnList.Width    := frmMain.ClientWidth;
      pnList.Align    := albottom;
      imgSgIn.Width   := frmMain.ClientWidth div 2;
      imgSgOut.Width  := frmMain.ClientWidth div 2;
      pnList.Height   := 250;
      pntot.Height    := frmMain.ClientHeight - pnList.Height-pnBottom.Height;
      sgout.left      := sgin.Width;
      imgSgOut.Left   := imgsgIn.Width;
      lbListOut.Left  := imgsgIn.Width;

      for i := 1 to nInLprCount do
      begin
        TPanel(FindComponent('pnIn' + IntToStr(i))).Visible := true;
        TPanel(FindComponent('pnIn' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
        TPanel(FindComponent('pnIn' + IntToStr(i))).Height  := (frmMain.ClientHeight - pnlist.Height - pnBottom.Height) div 2;
        TPanel(FindComponent('pnIn' + IntToStr(i))).left    := (i-1) * (frmMain.ClientWidth div 4);
      end;

      for i := 1 to (4 - nInLprCount) do
      begin
        TPanel(FindComponent('pnInLogo' + IntToStr(i))).Visible := true;
        TPanel(FindComponent('pnInLogo' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
        TPanel(FindComponent('pnInLogo' + IntToStr(i))).Height  := (frmMain.ClientHeight - pnlist.Height - pnBottom.Height) div 2;
        TPanel(FindComponent('pnInLogo' + IntToStr(i))).left    := nInLprCount * (frmMain.ClientWidth div 4)+ ((i-1) * (frmMain.ClientWidth div 4));;
      end;

      for i := 1 to nOutLprCount do
      begin
        TPanel(FindComponent('pnOut' + IntToStr(i))).Visible := true;
        TPanel(FindComponent('pnOut' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
        TPanel(FindComponent('pnOut' + IntToStr(i))).Height  := (frmMain.ClientHeight - pnlist.Height - pnBottom.Height) div 2;
        TPanel(FindComponent('pnOut' + IntToStr(i))).Top     := pnIn1.Height;
        TPanel(FindComponent('pnOut' + IntToStr(i))).left    := (i-1) * (frmMain.ClientWidth div 4);
      end;

      for i := 1 to (4- nOutLprCount) do
      begin
        TPanel(FindComponent('pnOutLogo' + IntToStr(i))).Visible := true;
        TPanel(FindComponent('pnOutLogo' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
        TPanel(FindComponent('pnOutLogo' + IntToStr(i))).Height  := (frmMain.ClientHeight - pnlist.Height - pnBottom.Height) div 2;
        TPanel(FindComponent('pnOutLogo' + IntToStr(i))).Top     := pnIn1.Height;
        TPanel(FindComponent('pnOutLogo' + IntToStr(i))).left    := (nOutLprCount * (frmMain.ClientWidth div 4)) + ((i-1) * (frmMain.ClientWidth div 4));
      end;
    end
    else                                   //차량 이미지가 한줄인 경우 (LPR 4개 이하)
    begin
      if frmMain.ClientWidth = Screen.Width  then                 //전체화면
      begin
      end
      else
      begin
        frmMain.ClientWidth := 1600;
        frmMain.ClientHeight:= 850;
      end;
      sgin.Width      := frmMain.ClientWidth div 2;
      sgout.Width     := frmMain.ClientWidth div 2;
      lbListIn.Width  := sgin.Width;
      lbListOut.Width := sgin.Width;

      pnList.Width    := frmMain.ClientWidth;
      pnList.Align    := albottom;
      imgSgIn.Width   := frmMain.ClientWidth div 2;
      imgSgOut.Width  := frmMain.ClientWidth div 2;
      pnList.Height   := 430;
      pntot.Height    := frmMain.ClientHeight - pnList.Height-pnBottom.Height;
      sgout.left      := sgin.Width;
      imgSgOut.Left   := imgsgIn.Width;
      lbListOut.Left  := imgsgIn.Width;

      if (nInLprCount + nOutLprCount) <> 4 then          //로고 추가
      begin
        //lpr입차이미지
        for i := 1 to nInLprCount do
        begin
          TPanel(FindComponent('pnIn' + IntToStr(i))).Visible := true;
          TPanel(FindComponent('pnIn' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
          TPanel(FindComponent('pnIn' + IntToStr(i))).Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          TPanel(FindComponent('pnIn' + IntToStr(i))).left    := (i-1) * (frmMain.ClientWidth div 4);
        end;

        if (nInLprCount + nOutLprCount) = 2 then  //(입1/출1)
        begin
          pnInLogo1.Visible := true;
          pnInLogo1.Width   := frmMain.ClientWidth div 4;
          pnInLogo1.Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          pnInLogo1.Left    := (pnIn1.Width * nInLprCount);

          pnOutLogo1.Visible := true;
          pnOutLogo1.Width   := frmMain.ClientWidth div 4;
          pnOutLogo1.Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          pnOutLogo1.Left    := (pnIn1.Width * nInLprCount) + pnInLogo1.Width;

          pnOut1.Visible     := true;
          pnOut1.width       := frmMain.ClientWidth div 4;
          pnOut1.Height      := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          pnOut1.left        := (pnIn1.Width * nInLprCount) + (pnIn1.Width * nInLprCount) + ((i-1)*(frmMain.ClientWidth div 4));
        end
        else if nOutLprCount = 1 then        //(입2/출1)
        begin
          pnOutLogo1.Visible := true;
          pnOutLogo1.Width   := frmMain.ClientWidth div 4;
          pnOutLogo1.Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          pnOutLogo1.Left    := (frmMain.ClientWidth div 4) * 2;

          pnOut1.Visible     := true;
          pnOut1.width       := frmMain.ClientWidth div 4;
          pnOut1.Height      := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          pnOut1.left        := (frmMain.ClientWidth div 4) * 3;
        end
        else if nInLprCount = 1 then         //(입1/출2)
        begin
          pnInLogo1.Visible := true;
          pnInLogo1.Width   := frmMain.ClientWidth div 4;
          pnInLogo1.Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          pnInLogo1.Left    := frmMain.ClientWidth div 4;

          for i := 1 to nOutLprCount do
          begin
            TPanel(FindComponent('pnOut' + IntToStr(i))).Visible := true;
            TPanel(FindComponent('pnOut' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
            TPanel(FindComponent('pnOut' + IntToStr(i))).Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
            TPanel(FindComponent('pnOut' + IntToStr(i))).left    := ((pnIn1.Width * nInLprCount)*2) + ((i-1)*(frmMain.ClientWidth div 4));
          end;
        end;
      end
      else
      begin
        for i := 1 to nInLprCount do
        begin
          TPanel(FindComponent('pnIn' + IntToStr(i))).Visible := true;
          TPanel(FindComponent('pnIn' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
          TPanel(FindComponent('pnIn' + IntToStr(i))).Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          TPanel(FindComponent('pnIn' + IntToStr(i))).left    := (i-1)*(frmMain.ClientWidth div 4);
        end;

        for i := 1 to nOutLprCount do
        begin
          TPanel(FindComponent('pnOut' + IntToStr(i))).Visible := true;
          TPanel(FindComponent('pnOut' + IntToStr(i))).width   := frmMain.ClientWidth div 4;
          TPanel(FindComponent('pnOut' + IntToStr(i))).Height  := frmMain.ClientHeight - pnlist.Height - pnBottom.Height;
          TPanel(FindComponent('pnOut' + IntToStr(i))).left    := (nInLprCount*(frmMain.ClientWidth div 4)) + ((i-1)*(frmMain.ClientWidth div 4));
        end;
      end;


    end;
    sgIn.ColWidths[0] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[1] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[2] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[3] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[4] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[5] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[6] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[7] :=  frmMain.ClientWidth div 18;
    sgIn.ColWidths[8] :=  frmMain.ClientWidth div 18;

    sgOut.ColWidths[0] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[1] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[2] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[3] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[4] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[5] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[6] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[7] :=  frmMain.ClientWidth div 18;
    sgOut.ColWidths[8] :=  frmMain.ClientWidth div 18;
  end;
  if screen.Width <> frmMain.ClientWidth then
  begin
    frmMain.Left := ((screen.Width div 2) - (frmMain.width div 2));
    frmMain.Top := ((screen.Height div 2) - (frmMain.Height div 2));
  end;


  //폼 배치
  pnManual.Top := (frmMain.ClientHeight - pnManual.Height) div 2;
  pnManual.Left := (frmMain.ClientWidth - pnManual.Width) div 2;
  pnBar.Top := (frmMain.ClientHeight - pnBar.Height) div 2;
  pnBar.Left := (frmMain.ClientWidth - pnBar.Width) div 2;
  pnManualProc.Top := (frmMain.ClientHeight - pnManualProc.Height) div 2;
  pnManualProc.Left := (frmMain.ClientWidth - pnManualProc.Width) div 2;
  pnSCSearch.Top := (frmMain.ClientHeight - pnSCSearch.Height) div 2;
  pnSCSearch.Left := (frmMain.ClientWidth - pnSCSearch.Width) div 2;
  pnHomeInfo.Top := (frmMain.ClientHeight - pnHomeInfo.Height) div 2;
  pnHomeInfo.Left := (frmMain.ClientWidth - pnHomeInfo.Width) div 2;
  pnModify.Top := (frmMain.ClientHeight - pnModify.Height) div 2;
  pnModify.Left := (frmMain.ClientWidth - pnModify.Width) div 2;
  pnlBlack.Top := (frmMain.ClientHeight - pnModify.Height) div 2;
  pnlBlack.Left := (frmMain.ClientWidth - pnModify.Width) div 2;

end;

procedure TfrmMain.FormShow(Sender: TObject);
var
  sDBString, sTemp: aString;
  i, j: Integer;
  sTemp1, sTemp2: String;
  SystemTime: TSystemTime;
  sDateTime, sYear, sMonth, sDay, sHour, sMin, sSec, sError: String;
  idStack: TIdStack;
begin
  try
    ExceptLogging('Program Start!');

//    FormAlign;
//    GridClear;
//    WaitClear;
//    InitProc;

    iSetup := TIniFile.Create(ExtractFileDir(Application.ExeName) + '\ParkSet.ini');
    sDBIP  := iSetup.ReadString('PARKING', 'DB IP', '');
    sDBID  := iSetup.ReadString('PARKING', 'DB ID', '');
    sDBPW  := iSetup.ReadString('PARKING', 'DB PW', '');
    sDBName:= iSetup.ReadString('PARKING', 'DB Name', '');
    nCurrUnitNo := iSetup.ReadInteger('PARKING', 'UnitNo', 0);
    sImageDir    := iSetup.ReadString('PARKING', 'LPRImage', 'C:\LPRImage');
    sLogoFile    := iSetup.ReadString('PARKING', 'Logo File', '');
    sHostIP      := MG_StrTrim(iSetup.ReadString('PARKING', 'Host IP', ''), ' ');
    nHostPort    := iSetup.ReadInteger('PARKING', 'Host Port', 0);
    sHomeInfo_IP := MG_StrTrim(iSetup.ReadString('PARKING', 'HomeInfo IP', '10.10.10.10'), ' ');
    nHomeInfo_Port:= iSetup.ReadInteger('PARKING', 'HomeInfo Port', 25008);
    sezVilleDong := iSetup.ReadString('PARKING', 'ezVilleDong', '100');
    sezVilleHo   := iSetup.ReadString('PARKING', 'ezVilleHo', '900');
    bMiIn        := iSetup.ReadBool('PARKING', 'MI_IN', False);
    b6Proc       := iSetup.ReadBool('PARKING', '6Proc', False);
    nDspInterval := iSetup.ReadInteger('PARKING', 'DSPInterval', 90);
    nApt         := iSetup.ReadInteger('PARKING', '아파트', 1);
    nHomeinfo_Comp := iSetup.ReadInteger('PARKING', '홈넷', 0);
    sHomeInfo_ID := iSetup.ReadString('PARKING', 'HomeInfo ID', 'wiju');
    sHomeInfo_PW := iSetup.ReadString('PARKING', 'HomeInfo PW', 'wiju1234');
    nBlack       := iSetup.ReadInteger('PARKING', '블랙리스트', 0);
    sBAlarmFile  := iSetup.ReadString('PARKING', 'Alarm File', '');
    nBAlarmTime  := iSetup.ReadInteger('PARKING', 'Alarm Time', 10);    //Addded Woo.YH 160415 블랙리스트알람시간 획득
    nGateActive  := iSetup.ReadInteger('PARKING', '차단기 제어여부', 1);
    nGateControl := iSetup.ReadInteger('PARKING', '차단기 제어', 1);
    bMode        := iSetup.ReadBool('PARKING', '개방운영', True);       //Added Woo.YH 개방운영모드 1: 유인 0: 개방
    nVisitation  := iSetup.ReadInteger('PARKING', '방문증', 0);         //Added Woo.YH 방문증  0:사용안함 , 1:사용
    nLogInUse    := iSetup.ReadInteger('PARKING', '로그인', 1);         //Added Woo.YH 프로그램 시작시 로그인  0:사용안함 , 1:사용
    bMonitoring  := iSetup.ReadBool('PARKING', '모니터링유무', false);
    nHomeVisit   := iSetup.ReadInteger('PARKING', '홈넷방문자', 0);     //Added Woo.YH 홈넷 방문자 연동  0:사용안함 , 1:사용

    //display
    nDisplaySize  := iSetup.ReadInteger('DISPLAY', '전광판', 1);         //Added Woo.YH  0:2단4열(대우건설), 1:2단6열(일반)
    sIOSDsp       := iSetup.ReadString('DISPLAY', '정기차량문구', '  등록차량  ');
    sIONDsp       := iSetup.ReadString('DISPLAY', '일반차량문구', ' 미등록차량 ');
    s4IOSDsp      := iSetup.ReadString('DISPLAY', '4_정기차량문구', '등록차량');
    s4IONDsp      := iSetup.ReadString('DISPLAY', '4_일반차량문구', '일반차량');
    nUseDSPText  := iSetup.ReadInteger('DISPLAY', '정기문구사용', 0);

    sMyIP := My_LocalIP;

    if bMode then begin
     btnMode.Caption := '유인운영' ;
     ExceptLogging('TfrmMain.btnModeClick: 유인운영');
     btnMode.Tag := 1;
    end
    else begin
      btnMode.Caption := '개방운영';
      ExceptLogging('TfrmMain.btnModeClick: 개방운영');
      btnMode.Tag := 2;
    end;

    if nApt = 0 then
    begin
      mnuHomeInfo.Visible := False;
    end;

    if nBlack = 0 then
    begin
      mnuBlack.Visible := False;
    end
    else
    begin
      mnuBlack.Visible := True;
    end;

    if sBAlarmFile <> '' then
    begin
      if FileExists(sBAlarmFile) then
      begin
        mpBlackList.FileName:= sBAlarmFile;
        mpBlackList.Open;
      end;
    end;

    GridClear;
    WaitClear;
    InitProc;

    if nGateControl = 0 then
    begin
      btnInGate1.Visible := False;
      btnInGate2.Visible := False;
      btnInGate3.Visible := False;
      btnInGate4.Visible := False;
      btnOutGate1.Visible := False;
      btnOutGate2.Visible := False;
      btnOutGate3.Visible := False;
      btnOutGate4.Visible := False;
    end
    else if nGateControl = 1 then
    begin
      popClose.Visible := False;
      popOpenLock.Visible := False;
      popUnLock.Visible := False;
    end
    else if nGateControl = 2 then
    begin
      popOpenLock.Visible := False;
      popUnLock.Visible := False;
    end;
    //else if nGateControl = 3 then visible true가 default이므로

    if not DirectoryExists(sImageDir) then
    begin
      if not ForceDirectories(sImageDir) then
        ExceptLogging('이미지저장폴더 생성실패: ' + sImageDir);
    end;

    if sDBIP = '' then
      sDBIP := aString(InputBox('DB설정 입력', 'DB IP 또는 DB서버명을 입력하여주세요', ''));

    if sDBID = '' then
      sDBID := aString(InputBox('DB ID 입력', 'DB 접속용 ID를 입력하여주세요', ''));

    if sDBPW = '' then
      sDBPW := aString(InputBox('DB Password 입력', 'DB 접속용 Password를 입력하여주세요', ''));

    if sDBName = '' then
      sDBName := aString(InputBox('DB Name 입력', 'DB명을  입력하여주세요', ''));

    if (sDBIP <> '') and (sDBID <> '') and (sDBPW <> '') and (sDBName <> '') then
    begin
      try
        // DB연결...
        dmTables.ADODB.Connected := False;
        sDBString := 'Provider=SQLOLEDB.1;Persist Security Info=True;';
        sDBString := sDBString + 'User ID=' + sDBID;
        sDBString := sDBString + ';Password=' + sDBPW;
        sDBString := sDBString + ';Initial Catalog=' + sDBName;
        sDBString := sDBString + ';Data Source=' + sDBIP;
        dmTables.ADODB.ConnectionString := wString(sDBString);
        dmTables.ADODB.Connected := True;
      except
        on E: Exception do
        begin
          ExceptLogging('DB Connect Error:' + aString(E.Message));
          ShowMessage('데이터베이스 연결에 실패하였습니다. 확인하여주세요.');
          Exit;
        end;
      end;
      iSetup.WriteString('PARKING', 'DB IP', sDBIP);
      iSetup.WriteString('PARKING', 'DB ID', sDBID);
      iSetup.WriteString('PARKING', 'DB PW', sDBPW);
      iSetup.WriteString('PARKING', 'DB Name', sDBName);
    end;

    if (sDBIP = '') then
    begin
      ShowMessage('DB IP 또는 서버명을 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    if (sDBID = '') then
    begin
      ShowMessage('DB 접속용 ID를 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    if (sDBPW = '') then
    begin
      ShowMessage('DB 접속용 Password를 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    if (sDBName = '') then
    begin
      ShowMessage('DB명을 입력하여주세요.'#13#10 +
          'DB 연결이 안되면 프로그램을 정상적으로 실행할 수 없습니다.');
      Exit;
    end;

    with qryMainTemp do
    begin
      Close;
      SQL.Clear;
      SQL.Add('Select * from ParkInfo Order By ParkNo');
      Open;

      if RecordCount > 0 then
      begin
        nCurrParkNo := FieldByName('ParkNo').AsInteger;
        sParkName   := FieldByName('ParkName').AsString;
      end
      else
        ExceptLogging('설치된 주차장이 없음!');
    end;
    nLoginResult := 0;

    if nLogInUse = 1 then
    begin
      NextModalDialog(TfrmLogin.Create(Self));
      if nLoginResult = 0 then
      begin
        ShowMessage('로그인에 실패하여 프로그램을 종료합니다.');
        bDirectClose:= True;
        Close;
        Exit;
      end
      else
      begin
        ExceptLogging('근무시작: ' + sCurrMName);
      end;
    end
    else
    begin
      nCurrMNo:= 90;
      sCurrMName:= '비로그인';
      ExceptLogging('비로그인');
    end;

    if nManagerAuthority > 0 then
      mnuSetup.Enabled := False;

    with qryMainTemp do
    begin
      for i := 1 to 10 do
      begin
        RLpr[i].nUnitNo := 0;
        RLpr[i].sDSPIP:= '';
        RLpr[i].nLprCnt:= 0;
        RLpr[i].nIO := 0;
      end;
      j := 1;

      sError := '';

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add('From UnitInfo Where UnitKind = :N1  and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 8; // 입구LPR
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMain do
          begin
            TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;
            TLabel(FindComponent('lbIn' + IntToStr(i))).Caption:= FieldByName('UnitName').AsString;
            TMenuItem(FindComponent('mnu1_' + IntToStr(i))).Caption := FieldByName('UnitName').AsString + ' 차단기 열림';
            TMenuItem(FindComponent('mnu1_' + IntToStr(i))).Visible := True;
            TTimer(FindComponent('tInAlive' + IntToStr(i))).Enabled := True;

            if is_ping(TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csInLpr' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;

            RLpr[j].nUnitNo := FieldByName('UnitNo').AsInteger;
            RLpr[j].sDspIP := FieldByName('Reserve1').AsString;
            RLpr[j].nLprCnt:= i;
            RLpr[j].nIO := 1;
          end;
          i := i + 1;
          j := j + 1;

          if i > 5 then
            Break;
          Next;
        end;
        bLPR := True;
      end
      else
        ExceptLogging('설치된 입구 LPR이 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add('From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 9; // 출구LPR
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMain do
          begin
            TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;
            TLabel(FindComponent('lbOut' + IntToStr(i))).Caption:= FieldByName('UnitName').AsString;
            TMenuItem(FindComponent('mnu2_' + IntToStr(i))).Caption:= FieldByName('UnitName').AsString + ' 차단기 열림';
            TMenuItem(FindComponent('mnu2_' + IntToStr(i))).Visible := True;

            TTimer(FindComponent('tOutAlive' + IntToStr(i))).Enabled := True;

            if is_ping(TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csOutLpr' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;

            RLpr[j].nUnitNo:= FieldByName('UnitNo').AsInteger;
            RLpr[j].sDspIP := FieldByName('Reserve1').AsString;
            RLpr[j].nLprCnt:= i;
            RLpr[j].nIO := 2;
          end;
          i := i + 1;
          j := j + 1;

          if i > 4 then
            Break;
          Next;
        end;
        bLPR := True;
      end
      else
        ExceptLogging('설치된 출구 LPR이 없음!');

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 10; // 입구전광판
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMain do
          begin
            sTemp1 := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;

            if is_ping(TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
          end;
          i := i + 1;

          if i > 5 then
            Break;
          Next;
        end;
        bInDsp := True;
        mnuInDsp.Enabled := True;
        tInDsp.Enabled := True;
      end
      else
      begin
        bInDsp := False;
        ExceptLogging('설치된 입구전광판이 없음!');
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and MyNo = :N2 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 11; // 출구전광판
      Parameters.ParamByName('N2').Value := nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMain do
          begin
            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Port := FieldByName('PortNo').AsInteger;
            TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;

            if is_ping(TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Host) then
            begin
              try
                TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active := True;
              except
                on E: Exception do sError := sError + FieldByName('UnitName').AsString + ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
              end;
            end
            else
              sError := sError + FieldByName('UnitName').AsString +
                ' 네트워크 오류입니다. 확인하여주세요!' + #13#10;
          end;
          i := i + 1;

          if i > 4 then
            Break;
          Next;
        end;
        bOutDsp := True;
        mnuOutDsp.Enabled := True;
        tOutDsp.Enabled := True;
      end
      else
      begin
        bOutDsp := False;
        ExceptLogging('설치된 출구전광판이 없음!');
      end;

      if nVisitation = 1 then
      begin
        Close;
        SQL.Clear;
        SQL.Add('Select ParkNo, UnitNo, UnitKind, ComPort, Baudrate ');
        SQL.Add('From UnitInfo Where UnitKind = :N1 and MyNo = :N2 and ParkNo = :N3 Order By ParkNo, UnitNo');
        Parameters.ParamByName('N1').Value := 6; // 영수증프린터
        Parameters.ParamByName('N2').Value := nCurrUnitNo;
        Parameters.ParamByName('N3').Value := nCurrParkNo;
        Open;

        if RecordCount > 0 then begin
          try
            ComPrn.Open := False;
            ComPrn.ComNumber := FieldByName('ComPort').AsInteger;
            ComPrn.Baud := FieldByName('BaudRate').AsInteger;
            ComPrn.Open := True;
          except
            on E: Exception do
              ExceptLogging('영수증프린터 포트오픈 에러: ' + aString(E.Message));
          end;
        end else
          ExceptLogging('설치된 영수증프린터가 없음!');
        if sError <> '' then
          ShowMessage(sError);
      end;

      Close;
      SQL.Clear;
      SQL.Add('select convert(varchar(30), getdate(), 120) tnow');
      Open;

      sDateTime := FieldByName('tNow').AsString;
      sYear := Copy(sDateTime, 1, 4);
      sMonth := Copy(sDateTime, 6, 2);
      sDay := Copy(sDateTime, 9, 2);
      sHour := Copy(sDateTime, 12, 2);
      sMin := Copy(sDateTime, 15, 2);
      sSec := Copy(sDateTime, 18, 2);

      with SystemTime do
      begin
        wYear := StrToInt(sYear);
        wMonth := StrToInt(sMonth);
        wDay := StrToInt(sDay);
        wDayOfWeek := DayOfWeek(Now) - 1;
        wHour := StrToInt(sHour);
        wMinute := StrToInt(sMin);
        wSecond := StrToInt(sSec);
        wMilliseconds := 0;
      end;
      SetLocalTime(SystemTime);

      nChkTime := GetTickCount + 3600000;

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and ParkNo = :N3 and MyNo = :N4 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 8; // 입구LPR
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Parameters.ParamByName('N4').Value := nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        i := 1;

        while not Eof do
        begin
          with frmMain do
          begin
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Caption := FieldByName('UnitName').AsString;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Hint := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).GroupIndex := FieldByName('PortNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).ImageIndex := FieldByName('MyNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Visible := True;
          end;
          i := i + 1;
          Next;
        end;
      end;

      Close;
      SQL.Clear;
      SQL.Add('Select * ');
      SQL.Add(
        'From UnitInfo Where UnitKind = :N1 and ParkNo = :N3 and myNo = :N4 Order By ParkNo, UnitNo');
      Parameters.ParamByName('N1').Value := 9; // 출구LPR
      Parameters.ParamByName('N3').Value := nCurrParkNo;
      Parameters.ParamByName('N4').Value := nCurrUnitNo;
      Open;

      if RecordCount > 0 then
      begin
        while not Eof do
        begin
          with frmMain do
          begin
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Caption := FieldByName('UnitName').AsString;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Hint := wString(MG_StrTrim(aString(FieldByName('IPNo').AsString), ' '));
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).GroupIndex := FieldByName('PortNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Tag := FieldByName('UnitNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).ImageIndex := FieldByName('MyNo').AsInteger;
            TAdvToolButton(FindComponent('btnBar' + IntToStr(i))).Visible := True;
          end;
          i := i + 1;
          Next;
        end;
      end;

      if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
      begin
        if is_Ping(sHomeInfo_IP) then
        begin
          csHomeInfo_icon.Host:= sHomeInfo_IP;
          HomeInfoLogging('단지서버(홈넷) Ping 정상! (단지서버 IP-' + sHomeInfo_IP + ')');
        end
        else
          HomeInfoLogging('프로그램 시작시 단지서버(홈넷) Ping 안됨! (단지서버 IP-' + sHomeInfo_IP + ')');
      end;

      if nHomeInfo_Comp = 1 then    //현대통신용...
      begin
        IdTS_HyunDai.DefaultPort:= nHomeInfo_Port;
        IdTS_HyunDai.Active:= True;

        IdTc_HyunDai.Host:= sHomeInfo_IP;
        IdTc_HyunDai.Port:= nHomeInfo_Port;
      end
      else if nHomeInfo_Comp = 2 then         //코콤
      begin
        //코콤 Lan 세대통보
        IdTS_kocom.DefaultPort:= nHomeInfo_Port;
        IdTS_kocom.Active:= True;

        //코콤LAN 세대통보용...
        IdSocksInfo1.Authentication:= saUsernamePassword;
        IdSocksInfo1.Username:= sHomeInfo_ID;
        IdSocksInfo1.Password:= sHomeInfo_PW;

        // 초기화
        FillChar(RBind, SizeOf(RBind), AnsiChar($00));
        FillChar(RKHeader, SizeOf(RKHeader), AnsiChar($00));
        FillChar(RAlive, SizeOf(RAlive), AnsiChar($00));

        RBind.nHomeVersion:= 0;
        RBind.nKind:= 0;

        for i:= 0 to 3 do
          RBind.nVersion[i]:= 0;

        sTemp := sHomeInfo_ID;

        for i:= 1 to Length(sTemp) do
          RKHeader.sID[i]:= sTemp[i];

        sTemp := sHomeInfo_PW;

        RKHeader.nHeaderKey:= nGHeaderKey;
        RKHeader.nMsgType:= nGBind;
        RKHeader.nMsgLength:= SizeOf(RBind);
        RKHeader.nTown:= 0;
        RKHeader.nDong:= 0;
        RKHeader.nHo:= 0;
        RKHeader.nReserved:= 0;

        for i:= 1 to Length(sTemp) do
         RKHeader.sPW[i]:= sTemp[i];

        IdTC_kocom.Host:= sHomeInfo_IP;
        IdTC_kocom.Port:= nHomeInfo_Port;

        if is_Ping(sHomeInfo_IP) then
        begin
          IdTC_kocom.Connect;

           if IdTC_kocom.Connected then
           begin
             ExceptLogging('코콤서버와 Bind확인 - OK');
             IdTC_kocom.IOHandler.Write(RawToBytes(RKHeader, SizeOf(RKHeader)), SizeOf(RKHeader), 0);
  //           tKocomCheck.Interval:= 200;                  //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
  //           tKocomCheck.Enabled:= True;                  //Deleted Woo.YH 160517 해당 타이머 아무역활 없이 쌓임
             tAlive.Enabled:= True;
           end
           else
           begin
             tAlive.Enabled:= True;
             ExceptLogging('코콤서버와 Bind안됨!');
             btnBind.Click;
           end;
        end
        else
          ExceptLogging(sHomeInfo_IP + '로 세대통보 전송시 네트워크 에러!');
      end
      else if nHomeInfo_Comp = 3 then       //아이컨트롤스
      begin
        csHomeInfo_icon.Host := sHomeInfo_IP;
        csHomeInfo_icon.port := nHomeInfo_Port;
        ssHomeinfo_icon.Port:= nHostPort;
        ssHomeinfo_icon.Active := true;
      end
      else if nHomeInfo_Comp = 4 then       //계영 정보통신
      begin
        IdTs_Gyeyoung.DefaultPort:= nHomeInfo_Port;
        IdTs_Gyeyoung.Active:= True;
        IdTC_Gyeyoung.Host:= sHomeInfo_IP;
        IdTC_Gyeyoung.Port:= nHomeInfo_Port;
      end
      else if nHomeInfo_Comp = 5 then       //삼성중공업 유비즈
      begin
        idUC_ubiz.Host := sHomeInfo_IP;
        idUC_ubiz.Port := nHostPort;
        idUC_ubiz.Connect;

        idUC_ubiz.Active := True;
      end
      else if nHomeInfo_Comp = 6 then       //이지빌
      begin
        if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
        begin
          if is_Ping(sHomeInfo_IP) then
          begin
            HomeInfoLogging('이지빌 단지서버로 최초 접속 suceess (단지서버 IP-' + sHomeInfo_IP + ')');

            //이지빌...
            csHomeInfo_EZ.Address:= sHomeInfo_IP;
            csHomeInfo_EZ.Port:= nHomeInfo_Port;
            csHomeInfo_EZ.Open;

            tEZVille.Interval := 180000;
            tEzVille.Enabled:= True;

            if nHomeVisit = 1 then
            begin
              tvisitdel.Enabled := true;
            end;

//            if csHomeInfo_EZ.Socket.Connected then
//            begin
//              if nHomeVisit = 1 then
//              begin
//                tEZVille.Interval := 180000;
//              end;
//              tEzVille.Enabled:= True;
//
////              idStack := TIdStack.Create;
////              sLocalIP:= idStack.LocalAddress;
////              idStack.Free;
//            end;
//            else
//            begin
//              csHomeInfo_EZ.Close;
//              csHomeInfo_EZ.Open;
//
//              if csHomeInfo_EZ.Socket.Connected then
//              begin
//                tEzVille.Enabled:= True;
//
////                idStack := TIdStack.Create;
////                sLocalIP:= idStack.LocalAddress;
////                idStack.Free;
//              end;
//            end;
          end
          else
            HomeInfoLogging('이지빌 단지서버로 최초 접속시도시 Ping 안됨! (단지서버 IP-' + sHomeInfo_IP + ')');
        end;
      end
      else if nHomeInfo_Comp = 7 then //한화 비쥬드림 ucamp
      begin
        IdTC_Beeju.Host:= sHomeInfo_IP;
        idTC_Beeju.Port:= nHomeInfo_Port;
      end
      else if nHomeInfo_Comp = 8 then   //CVNet
      begin
        if is_Ping(sHomeInfo_IP) then
        begin
          csHomeInfo_CVNet.Host:= sHomeInfo_IP;
          csHomeInfo_CVNet.Port:= nHomeInfo_Port;
          csHomeInfo_CVNet.Active:= True;
        end
        else
          HomeInfoLogging('##### 세대통보서버 접속 시 Ping 안됨 #####')
      end
      else if nHomeInfo_Comp = 9 then   //Commax
      begin
        if is_Ping(sHomeInfo_IP) then
        begin
          IdTc_Commax.Host:= sHomeInfo_IP;
          IdTc_Commax.Port:= nHomeInfo_Port;
        end
        else
          HomeInfoLogging('##### 세대통보서버 접속 시 Ping 안됨 #####')
      end
      else if nHomeInfo_Comp = 10 then       //홈넷홈
      begin
        IdTc_Home.Host := sHomeInfo_IP;
        IdTc_Home.port := nHomeInfo_Port;
      end;

      if bMonitoring then
      begin
        btnMode.Visible := false;
        btnManualIn.Visible := false;
        N4.Visible := false;
      end;
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.FormShow: ' + aString(E.Message));
  end;
end;


procedure TfrmMain.mnu1_1Click(Sender: TObject);
begin
  try
    if chkNet(csInLpr1, '차단기 OPEN') then
    begin
      csInLpr1.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('TfrmMain.mnu1_1Click 입구1 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu1_1Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu1_2Click(Sender: TObject);
begin
  try
    if chkNet(csInLpr2, '차단기 OPEN') then
    begin
      csInLpr2.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('TfrmMain.mnu1_2Click 입구2 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu1_2Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu1_3Click(Sender: TObject);
begin
  try
    if chkNet(csInLpr3, '차단기 OPEN') then
    begin
      csInLpr3.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('TfrmMain.mnu1_3Click 입구3 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu1_3Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu1_4Click(Sender: TObject);
begin
  try
    if chkNet(csInLpr4, '차단기 OPEN') then
    begin
      csInLpr4.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('TfrmMain.mnu1_4Click 입구4 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu1_4Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu2_1Click(Sender: TObject);
begin
  try
    if chkNet(csOutLpr1, '차단기 OPEN') then
    begin
      csOutLpr1.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('TfrmMain.mnu2_1Click 출구1 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu2_1Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu2_2Click(Sender: TObject);
begin
  try
    if chkNet(csOutLpr2, '차단기 OPEN') then
    begin
      csOutLpr2.Socket.SendText('BAR_OPEN_1');
      ExceptLogging('TfrmMain.mnu2_2Click 출구2 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu2_2Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu2_3Click(Sender: TObject);
begin
  try
    if chkNet(csOutLpr3, '차단기 CLOSE') then
    begin
      csOutLpr3.Socket.SendText('BAR_CLOSE_1');
      ExceptLogging('TfrmMain.mnu2_3Click 출구3 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu2_3Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu2_4Click(Sender: TObject);
begin
  try
    if chkNet(csOutLpr4, '차단기 CLOSE') then
    begin
      csOutLpr4.Socket.SendText('BAR_CLOSE_1');
      ExceptLogging('TfrmMain.mnu2_4Click 출구4 차단기 오픈 ');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu2_4Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu3_2Click(Sender: TObject);
begin
  try
    if chkNet(csInLpr3, '차단기 OPEN') then
    begin
      csInLpr3.Socket.SendText('BAR_OPEN_1');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu3_2Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu3_3Click(Sender: TObject);
begin
  try
    if chkNet(csInLpr3, '차단기 CLOSE') then
    begin
      csInLpr3.Socket.SendText('BAR_CLOSE_1');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu3_3Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu4_2Click(Sender: TObject);
begin
  try
    if chkNet(csOutLpr1, '차단기 OPEN') then
    begin
      csOutLpr1.Socket.SendText('BAR_OPEN_1');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu4_2Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnu4_3Click(Sender: TObject);
begin
  try
    if chkNet(csOutLpr1, '차단기 CLOSE') then
    begin
      csOutLpr1.Socket.SendText('BAR_CLOSE_1');
    end;
  except
    on E: Exception do ExceptLogging('TfrmMain.mnu4_3Click: ' + E.Message);
  end;
end;

procedure TfrmMain.mnuBlackClick(Sender: TObject);
begin
  NextModalDialog(TfrmAlarm.Create(Self));

  if FileExists(sBAlarmFile) then
  begin
    mpBlackList.FileName:= sBAlarmFile;
    mpBlackList.Open;
  end
end;

procedure TfrmMain.mnuCloseClick(Sender: TObject);
begin
  Close;
end;

procedure TfrmMain.mnuHomeInfoClick(Sender: TObject);
begin
  pnHomeInfo.Visible:= True;
end;

procedure TfrmMain.mnuInDspClick(Sender: TObject);
begin
  NextModalDialog(TfrmInDspSet.Create(Self));
end;

procedure TfrmMain.mnuOutDspClick(Sender: TObject);
begin
  NextModalDialog(TfrmDspSet.Create(Self));
end;


procedure TfrmMain.mpBlackListNotify(Sender: TObject);
begin
  if mpBlackList.NotifyValue = nvSuccessful then
    mpBlackList.Play;
end;

procedure TfrmMain.N2Click(Sender: TObject);
begin
  NextModalDialog(TfrmSetup.Create(Self));

  if bSetupChange and (nCurrMNo <> 99) then
  begin
    ShowMessage('환경설정이 변경되어 프로그램을 종료합니다.'#13#10 + '프로그램을 다시 시작하여 주세요!');
    bDirectClose:= True;
    Close;
  end;
end;

procedure TfrmMain.N3Click(Sender: TObject);
begin
  NextModalDialog(TfrmUnitInfo.Create(Self));

  if bSetupChange and (nCurrMNo <> 99) then
  begin
    ShowMessage('환경설정이 변경되어 프로그램을 종료합니다.'#13#10 + '프로그램을 다시 시작하여 주세요!');
    bDirectClose:= True;
    Close;
  end;
end;

procedure TfrmMain.NGridData(sResult: String);
var
  sCarNo, sIOTime, sStatus, sTemp, sDate, sTime,sLine: String;
  nPos, nIO: Byte;
begin
  if Length(sResult) > 4 then
  begin
    nIO := StrToInt(Copy(sResult, 1, 1));
    sCarNo := Copy(sResult, 2, Pos('^', sResult) - 2);
    sTemp := Copy(sResult, Pos('^', sResult) + 1, Length(sResult) - (Pos('^', sResult)));
    sIOTime := Copy(sTemp, 1, Pos('^', sTemp) - 1);
    sDate := Copy(sIOTime, 1, 10);
    sTime := Copy(sIOTime, 12, 8);
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp))
      );
    //nPos := Pos('^', sTemp);
    sStatus :=Copy(sTemp, 1, Pos('^', sTemp) - 1);
    sTemp := Copy(sTemp, Pos('^', sTemp) + 1, Length(sTemp) - (Pos('^', sTemp)) );
    sLine := Copy(sTemp, nPos + 1, Length(sTemp) - nPos);
    if nIO = 1 then
    begin
      with sgIn do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '일반차량';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
        Cells[8, 1] := sLine;
      end;
      sgIn.Alignments[0, 1] := taCenter;
      sgIn.Alignments[1, 1] := taCenter;
      sgIn.Alignments[2, 1] := taCenter;
      sgIn.Alignments[3, 1] := taCenter;
      sgIn.Alignments[4, 1] := taCenter;
      sgIn.Alignments[5, 1] := taCenter;
      sgIn.Alignments[6, 1] := taCenter;
      sgIn.Alignments[7, 1] := taCenter;
      sgIn.Alignments[8, 1] := taCenter;
    end
    else if nIO = 8 then
    begin
      with sgIn do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '방문차량';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
        Cells[8, 1] := sLine;
      end;
      sgIn.Alignments[0, 1] := taCenter;
      sgIn.Alignments[1, 1] := taCenter;
      sgIn.Alignments[2, 1] := taCenter;
      sgIn.Alignments[3, 1] := taCenter;
      sgIn.Alignments[4, 1] := taCenter;
      sgIn.Alignments[5, 1] := taCenter;
      sgIn.Alignments[6, 1] := taCenter;
      sgIn.Alignments[7, 1] := taCenter;
      sgIn.Alignments[8, 1] := taCenter;
    end
    else if nIO = 9 then
    begin
      with sgIn do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '블랙리스트';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
        Cells[8, 1] := sLine;
      end;
      sgIn.Alignments[0, 1] := taCenter;
      sgIn.Alignments[1, 1] := taCenter;
      sgIn.Alignments[2, 1] := taCenter;
      sgIn.Alignments[3, 1] := taCenter;
      sgIn.Alignments[4, 1] := taCenter;
      sgIn.Alignments[5, 1] := taCenter;
      sgIn.Alignments[6, 1] := taCenter;
      sgIn.Alignments[7, 1] := taCenter;
      sgIn.Alignments[8, 1] := taCenter;
    end
    else if nIO = 2 then
    begin
      with sgOut do
      begin
        InsertRows(1, 1, True);
        Cells[0, 1] := '일반차량';
        Cells[1, 1] := sDate;
        Cells[2, 1] := sTime;
        Cells[3, 1] := sCarNo;
        Cells[4, 1] := '';
        Cells[5, 1] := '';
        Cells[6, 1] := '';
        Cells[7, 1] := sStatus;
        Cells[8, 1] := sLine;
      end;
      sgOut.Alignments[0, 1] := taCenter;
      sgOut.Alignments[1, 1] := taCenter;
      sgOut.Alignments[2, 1] := taCenter;
      sgOut.Alignments[3, 1] := taCenter;
      sgOut.Alignments[4, 1] := taCenter;
      sgOut.Alignments[5, 1] := taCenter;
      sgOut.Alignments[6, 1] := taCenter;
      sgOut.Alignments[7, 1] := taCenter;
      sgOut.Alignments[8, 1] := taCenter;
    end;
  end;
end;

procedure TfrmMain.tAliveTimer(Sender: TObject);
var
  i: Byte;
  sTime, sTemp: String;
  nTime: Int64;
begin
  try
//    tAlive.Enabled:= False; //Deleted Woo.YH 계속돌아야함
    ExceptLogging('tAliveTimer : 1분마다 연결 체크');

    //코콤
    FillChar(RKAlive, SizeOf(RKAlive), AnsiChar($00));

    RKAlive.nHeaderKey:= nGHeaderKey;
    RKAlive.nMsgType:= nGAlive;
    RKAlive.nMsgLength:= SizeOf(RAlive);
    RKAlive.nTown:= 0;
    RKAlive.nDong:= 0;
    RKAlive.nHo:= 0;
    RKAlive.nReserved:= 0;

    try
      if IdTC_kocom.Connected then
      begin
//      ExceptLogging('Alive시 코콤서버와 연결확인 - OK');
        IdTC_kocom.IOHandler.Write(RawToBytes(RKAlive, SizeOf(RKAlive)), SizeOf(RKAlive), 0);
        ExceptLogging('Alive시 코콤서버와 연결확인 - OK');
//        tAlive.Enabled:= True;   //Deleted Woo.YH
      end
      else
      begin
        IdTC_kocom.Disconnect;
        ExceptLogging('Alive시 코콤서버와 연결안됨 - Bind 시도');
        btnBind.Click;
      end;
    except
      on E: Exception do
      begin
        ExceptLogging('TfrmMain.tAliveTimer_1: ' + E.Message);
        btnBind.Click;   //Added Woo.YH 160427
      end;

      on E: EIdSocketError do
      begin
//        tAlive.Enabled:= True;     //Deleted Woo.YH
        IdTC_kocom.Disconnect;
        ExceptLogging('세대통보시 Bind Error');
        btnBind.Click;
      end;
    end;
  except
    on E: Exception do
    begin
      ExceptLogging('TfrmMain.tAliveTimer_2: ' + E.Message);
//      btnBind.Click;         //Added Woo.YH 160427
//      idTC.Disconnect;
//      idTC.Connect;
//
//      if idTC.Connected then
//      begin
//        ExceptLogging('코콤서버 재연결시 Bind확인 - OK');
//        idTC.IOHandler.Write(RawToBytes(RKAlive, SizeOf(RKAlive)), SizeOf(RKAlive), 0);
//        tKocomCheck.Interval:= 200;
//        tKocomCheck.Enabled:= True;
//        tAlive.Enabled:= True;
//      end
//      else
//      begin
//        tAlive.Enabled:= True;
//        ExceptLogging('코콤서버 재연결시 Bind안됨!');
//        btnBind.Click;
//      end;
    end;
  end;
end;

procedure TfrmMain.tDbCheckTimer(Sender: TObject);
var
  sDBString : String;
begin
  try
    with dmTables.qryDbCheck do
    begin
      Close;
      SQL.Clear;
      SQL.Add('select parkno from parkinfo');
      Open;
    end;

  except
    on E: Exception do
    begin
      ExceptLogging('tDbCheckTimer : DB접속 오류 : ' + aString(E.Message));

      sDBIP  := iSetup.ReadString('PARKING', 'DB IP', '');
      sDBID  := iSetup.ReadString('PARKING', 'DB ID', '');
      sDBPW  := iSetup.ReadString('PARKING', 'DB PW', '');
      sDBName:= iSetup.ReadString('PARKING', 'DB Name', '');

      dmTables.ADODB.Connected := False;
      sDBString := 'Provider=SQLOLEDB.1;Persist Security Info=True;';
      sDBString := sDBString + 'User ID=' + sDBID;
      sDBString := sDBString + ';Password=' + sDBPW;
      sDBString := sDBString + ';Initial Catalog=' + sDBName;
      sDBString := sDBString + ';Data Source=' + sDBIP;
      dmTables.ADODB.ConnectionString := wString(sDBString);
      dmTables.ADODB.Connected := True;

      ExceptLogging('tDbCheckTimer : 재접속 시도 완료');
    end;
 end;
end;

procedure TfrmMain.tEZVilleTimer(Sender: TObject);
var
  sSend, sSendLength: aString;
  nSendLength: Integer;
begin
  try
    if nHomeVisit = 1 then
    begin
      sSend:= '$version=3.0$cmd=10$copy=1-10$dongho=' + sezVilleDong + '&' + sezVilleHo + '$target=server';
    end
    else
    begin
      sSend:= '$version=2.0$dongho=' + sezVilleDong + '&' + sezVilleHo + '$cmd=10$target=server';
    end;

    sSendLength:= MG_InsZero(IntToStr(Length(sSend)+14), 4);
    nSendLength:= StrToInt(sSendLength);
    sSend:= '<start=' + sSendLength + '&0>' + sSend;

    if MG_StrStrTrim(sHomeInfo_IP, ' ', '.') <> '' then
    begin
      if is_Ping(sHomeInfo_IP) then
      begin
        if csHomeInfo_EZ.Socket.Connected then
        begin
          try
            if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
            begin
              HomeInfoLogging('> 단지서버 상태조회 전송: ' + sSend);
            end
            else
            begin
              HomeInfoLogging('> 단지서버 상태조회 전송시 에러: ' + sSend);
            end;
          except
            on E: Exception do HomeInfoLogging('단지서버 상태조회 전송시 에러: ' + aString(E.Message));
          end;
        end
        else
        begin
          csHomeInfo_EZ.Open;

          if csHomeInfo_EZ.Socket.Connected then
          begin
            try
              if csHomeInfo_EZ.Socket.SendText(sSend) = nSendLength then
              begin
                HomeInfoLogging('> 단지서버 상태조회 전송(2): ' + sSend);
              end
              else
              begin
                HomeInfoLogging('> 단지서버 상태조회 전송시 에러(2): ' + sSend);
              end;
            except
              on E: Exception do HomeInfoLogging('단지서버 상태조회 전송시 에러: ' + aString(E.Message));
            end;
          end
          else
            HomeInfoLogging('단지서버로 상태조회 전송시 네트워크 끊김!');
        end;
      end
      else
        HomeInfoLogging('단지서버로 상태조회 전송 시도시 Ping 안됨!');
    end;
  except
    on E: Exception do HomeInfoLogging('TfrmMain.tEzVilleTimer: ' + E.Message);
  end;
end;


procedure TfrmMain.tHeartBeatTimer(Sender: TObject);
var
  sSend: AnsiString;
begin
  try
    if bHeartBeat then
    begin
      if is_Ping(sHomeInfo_IP) then
      begin
        bHeartBeat:= False;
        sSend:= MakeCVnetHeartBeat;
        csHomeInfo_CVNet.Socket.SendText(sSend);
        HomeInfoLogging('세대통보로 HeartBeat 전송: ' + toHex(sSend));
      end
      else
        HomeInfoLogging('HeartHeat 전송시 세대통보 서버 Ping Error');
    end
    else
    begin
      bHeartBeat:= True;
      csHomeInfo_CVNet.Active:= False;
      csHomeInfo_CVNet.Active:= True;
    end;
  except
    on E: Exception do
      HomeInfoLogging('tHeartBeat: ' + AnsiString(E.Message));
  end;
end;

// LPR 1 시간동기화
procedure TfrmMain.tInAlive1Timer(Sender: TObject);
begin
  try
    if csInLpr1.Active then
    begin
      if is_ping(csInLpr1.Host) then
      begin
        csInLpr1.Socket.SendText('OK');
        ExceptLogging(IntToStr(csInLpr1.Tag) + '번 LPR OK 전송');
      end;
    end
    else
    begin
      ExceptLogging(IntToStr(csInLpr1.Tag) + '번 LPR 비정상 상태');
      if (csInLpr1.Host <> '') and is_ping(csInLpr1.Host) then
      begin
        csInLpr1.Active := True;
        ExceptLogging(IntToStr(csInLpr1.Tag) + '번 LPR Ping 정상 재접속 시도');
      end;
    end;

    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csInLpr1, '시간동기화 전송') then
      begin
//        csInLpr1.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csInLpr1.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csInLpr1, 'LPR OK 전송') then
//    begin
//      csInLpr1.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csInLpr1.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csInLpr1.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tInAlive2Timer(Sender: TObject);
begin
  try
    if csInLpr2.Active then
    begin
      if is_ping(csInLpr2.Host) then
      begin
        csInLpr2.Socket.SendText('OK');
        ExceptLogging(IntToStr(csInLpr2.Tag) + '번 LPR OK 전송');
      end;
    end
    else
    begin
      ExceptLogging(IntToStr(csInLpr2.Tag) + '번 LPR 비정상 상태');
      if (csInLpr2.Host <> '') and is_ping(csInLpr2.Host) then
      begin
        csInLpr2.Active := True;
        ExceptLogging(IntToStr(csInLpr2.Tag) + '번 LPR Ping 정상 재접속 시도');
      end;
    end;

    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csInLpr2, '시간동기화 전송') then
      begin
//        csInLpr2.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csInLpr2.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csInLpr1, 'LPR OK 전송') then
//    begin
//      csInLpr2.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csInLpr2.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csInLpr2.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tInAlive3Timer(Sender: TObject);
begin
  try
//    if csInLpr3.Active then
//    begin
//      if is_ping(csInLpr3.Host) then
//      begin
//        csInLpr3.Socket.SendText('OK');
//        ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR OK 전송');
//      end;
//    end
//    else
//    begin
//      if (csInLpr3.Host <> '') and is_ping(csInLpr3.Host) then
//        csInLpr3.Active := True;
//    end;
    if csInLpr3.Active then
    begin
      if is_ping(csInLpr3.Host) then
      begin
        csInLpr3.Socket.SendText('OK');
        ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR OK 전송');
      end;
    end
    else
    begin
      ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR 비정상 상태');
      if (csInLpr3.Host <> '') and is_ping(csInLpr3.Host) then
      begin
        csInLpr3.Active := True;
        ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR Ping 정상 재접속 시도');
      end;
    end;

    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csInLpr3, '시간동기화 전송') then
      begin
//        csInLpr3.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csInLpr3, 'LPR OK 전송') then
//    begin
//      csInLpr3.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csInLpr3.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tInAlive4Timer(Sender: TObject);
begin
  try
//    if csInLpr4.Active then
//    begin
//      if is_ping(csInLpr4.Host) then
//      begin
//        csInLpr4.Socket.SendText('OK');
//        ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR OK 전송');
//      end;
//    end
//    else
//    begin
//      if (csInLpr4.Host <> '') and is_ping(csInLpr4.Host) then
//        csInLpr4.Active := True;
//    end;
    if csInLpr4.Active then
    begin
      if is_ping(csInLpr4.Host) then
      begin
        csInLpr4.Socket.SendText('OK');
        ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR OK 전송');
      end;
    end
    else
    begin
      ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR 비정상 상태');
      if (csInLpr4.Host <> '') and is_ping(csInLpr4.Host) then
      begin
        csInLpr4.Active := True;
        ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR Ping 정상 재접속 시도');
      end;
    end;


    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csInLpr4, '시간동기화 전송') then
      begin
//        csInLpr4.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csInLpr4, 'LPR OK 전송') then
//    begin
//      csInLpr4.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csInLpr4.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;


// 전광판 고정문구 표출
procedure TfrmMain.tInDspTimer(Sender: TObject);
var
  sSend, sDspData, sSpeed, sTime, sEffect: aString;
  sDsp1, sDsp2, sColor1, sColor2, sTemp1, sTemp2: aString;
  i: Byte;
begin
  try
    tInDsp.Enabled := False;
    sSend := '';
    // ini파일 읽어오기
    // 전광판 표출속도, 표출시간, 윗줄문구, 아랫줄문구, 문구색상

//    sSpeed := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'IN_DSP_SPEED', 0)), 2);
//    sTime := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'IN_DSP_TIME', 0)), 2);
    sSpeed := MG_InsZero(IntToStr(iSetup.ReadInteger('DISPLAY', 'IN_DSP_SPEED', 0)), 2);
    sTime := MG_InsZero(IntToStr(iSetup.ReadInteger('DISPLAY', 'IN_DSP_TIME', 0)), 2);


//    sDsp1 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'IN_DSP_1_1', '')), AnsiChar(39));
//    sDsp2 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'IN_DSP_1_2', '')), AnsiChar(39));
//    sTemp1 := iSetup.ReadString('PARKING', 'IN_DSP_COLOR_1_1', '');
//    sTemp2 := iSetup.ReadString('PARKING', 'IN_DSP_COLOR_1_2', '');
    sColor1 := '';
    sColor2 := '';

    if nDisplaySize = 0 then      //2단 4열
    begin
//      sDsp1 := MG_StrTrim(aString(iSetup.ReadString('PARKING', '4_IN_DSP_1_1', '')), AnsiChar(39));
//      sDsp2 := MG_StrTrim(aString(iSetup.ReadString('PARKING', '4_IN_DSP_1_2', '')), AnsiChar(39));
//      sTemp1 := iSetup.ReadString('PARKING', '4_IN_DSP_COLOR_1_1', '');
//      sTemp2 := iSetup.ReadString('PARKING', '4_IN_DSP_COLOR_1_2', '');
      sDsp1 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', '4_IN_DSP_1_1', '')), AnsiChar(39));
      sDsp2 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', '4_IN_DSP_1_2', '')), AnsiChar(39));
      sTemp1 := iSetup.ReadString('DISPLAY', '4_IN_DSP_COLOR_1_1', '');
      sTemp2 := iSetup.ReadString('DISPLAY', '4_IN_DSP_COLOR_1_2', '');

      // 윗줄문구 색상
      for i := 1 to 8 do
      begin
        sColor1 := sColor1 + AnsiChar(StrToInt('$0' + Copy(sTemp1, i, 1)));
      end;

      // 아랫줄문구 색상
      for i := 1 to 8 do
      begin
        sColor2 := sColor2 + AnsiChar(StrToInt('$0' + Copy(sTemp2, i, 1)));
      end;
    end
    else
    begin
//      sDsp1 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'IN_DSP_1_1', '')), AnsiChar(39));
//      sDsp2 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'IN_DSP_1_2', '')), AnsiChar(39));
//      sTemp1 := iSetup.ReadString('PARKING', 'IN_DSP_COLOR_1_1', '');
//      sTemp2 := iSetup.ReadString('PARKING', 'IN_DSP_COLOR_1_2', '');
      sDsp1 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', 'IN_DSP_1_1', '')), AnsiChar(39));
      sDsp2 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', 'IN_DSP_1_2', '')), AnsiChar(39));
      sTemp1 := iSetup.ReadString('DISPLAY', 'IN_DSP_COLOR_1_1', '');
      sTemp2 := iSetup.ReadString('DISPLAY', 'IN_DSP_COLOR_1_2', '');

      // 윗줄문구 색상
      for i := 1 to 12 do
      begin
        sColor1 := sColor1 + AnsiChar(StrToInt('$0' + Copy(sTemp1, i, 1)));
      end;

      // 아랫줄문구 색상
      for i := 1 to 12 do
      begin
        sColor2 := sColor2 + AnsiChar(StrToInt('$0' + Copy(sTemp2, i, 1)));
      end;
    end;

    sEffect := AnsiChar($00) + // AnsiChar(StrToInt('$' + edtDspNo.Text)) + //문구블록
      AnsiChar($00) + // 배경이미지
      AnsiChar($00) + // 문구저장위치
      AnsiChar($61) + // AnsiChar(StrToInt('$' + edttt.Text)) + //폰트크기
      AnsiChar($00) + // 화면분할위치
      AnsiChar($00) + // 완성형
      AnsiChar($80) + // 분할화면효과없음
      AnsiChar($01) + // 메인화면효과
      AnsiChar(StrToInt('$' + sSpeed)) + // 속도
      AnsiChar(StrToInt('$' + sTime)) + // 정지시간
      AnsiChar($00); // 문구수직위치
    sSend := MakeDSPData(AnsiChar($53), sEffect, sColor1 + sColor2,
      sDsp1 + sDsp2);

    for i := 1 to 4 do
    begin
      if TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Active then
        TClientSocket(FindComponent('csInDsp' + IntToStr(i))).Socket.SendText(sSend);
    end;

  except
    on E: Exception do
      ExceptLogging('TfrmMain.tInDspTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tmrBlackTimer(Sender: TObject);
begin
  if pnlBlack.Visible = True then
    pnlBlack.Visible := False;

  mpBlackList.Notify := False;
  mpBlackList.Stop;
  tmrBlack.Enabled := False;
end;

procedure TfrmMain.tNCInWaitTimer(Sender: TObject);
begin
  try
    tNCInWait.Enabled := False;

    if not bNCInProcWait then
    begin
      ExceptLogging('일반차량 입차대기자료 처리: ' + IntToStr(nNCInWaitFlag)
          + ', ' + IntToStr(nNCInWaitPoint));

      if nNCInWaitPoint <> nNCInWaitFlag then
      begin
        if nNCInWaitFlag = 20 then
          nNCInWaitFlag := 1
        else
          nNCInWaitFlag := nNCInWaitFlag + 1;

        if RNCInWait[nNCInWaitFlag].sNCIOTime <> '' then
        begin
          NormalProc(RNCInWait[nNCInWaitFlag].sNCFile1,
                     RNCInWait[nNCInWaitFlag].sNCCarNo1,
                     RNCInWait[nNCInWaitFlag].sNCFile2,
                     RNCInWait[nNCInWaitFlag].sNCCarNo2,
                     RNCInWait[nNCInWaitFlag].sNCIOTime,
                     RNCInWait[nNCInWaitFlag].nNCLprNo,
                     RNCInWait[nNCInWaitFlag].nNCInOut,
                     RNCInWait[nNCInWaitFlag].nNCRecog1,
                     RNCInWait[nNCInWaitFlag].nNCRecog2,
                     RNCInWait[nNCInWaitFlag].sNCDspIP,
                     RNCInWait[nNCInWaitFlag].csNCLPR,
                     RNCInWait[nNCInWaitFlag].bBarOpen,
                     RNCInWait[nNCInWaitFlag].nNCLprCnt,
                     RNCInWait[nNCInWaitFlag].nBackData
                     );
          RNCInWait[nNCInWaitFlag].sNCFile1 := '';
          RNCInWait[nNCInWaitFlag].sNCCarNo1 := '';
          RNCInWait[nNCInWaitFlag].sNCFile2 := '';
          RNCInWait[nNCInWaitFlag].sNCCarNo2 := '';
          RNCInWait[nNCInWaitFlag].sNCIOTime := '';
          RNCInWait[nNCInWaitFlag].nNCLprNo := 0;
          RNCInWait[nNCInWaitFlag].nNCInOut := 0;
          RNCInWait[nNCInWaitFlag].nNCRecog1 := 0;
          RNCInWait[nNCInWaitFlag].nNCRecog2 := 0;
          RNCInWait[nNCInWaitFlag].nNCLprCnt:= 0;
          RNCInWait[nNCInWaitFlag].sNCDspIP := '';
          RNCInWait[nNCInWaitFlag].bBarOpen := False;
          RNCInWait[nNCInWaitFlag].nBackData := 0;
        end;

        if nNCInWaitPoint <> nNCInWaitFlag then
          tNCInWait.Enabled := True;
      end
      else
        tNCInWait.Enabled := False;
    end
    else
      tNCInWait.Enabled := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.tNCInWaitTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tNCOutWaitTimer(Sender: TObject);
begin
  try
    tNCOutWait.Enabled := False;

    if not bNCOutProcWait then
    begin
      ExceptLogging('일반차량 출차대기자료 처리: ' + IntToStr(nNCOutWaitFlag)
          + ', ' + IntToStr(nNCOutWaitPoint));

      if nNCOutWaitPoint <> nNCOutWaitFlag then
      begin
        if nNCOutWaitFlag = 20 then
          nNCOutWaitFlag := 1
        else
          nNCOutWaitFlag := nNCOutWaitFlag + 1;
       
        if RNCOutWait[nNCOutWaitFlag].sNCIOTime <> '' then
        begin
          nNowCharo := RNCOutWait[nNCOutWaitPoint].nNCCharo;
          NormalProc(RNCOutWait[nNCOutWaitFlag].sNCFile1,
                     RNCOutWait[nNCOutWaitFlag].sNCCarNo1,
                     RNCOutWait[nNCOutWaitFlag].sNCFile2,
                     RNCOutWait[nNCOutWaitFlag].sNCCarNo2,
                     RNCOutWait[nNCOutWaitFlag].sNCIOTime,
                     RNCOutWait[nNCOutWaitFlag].nNCLprNo,
                     RNCOutWait[nNCOutWaitFlag].nNCInOut,
                     RNCOutWait[nNCOutWaitFlag].nNCRecog1,
                     RNCOutWait[nNCOutWaitFlag].nNCRecog2,
                     RNCOutWait[nNCOutWaitFlag].sNCDspIP,
                     RNCOutWait[nNCOutWaitFlag].csNCLPR,
                     RNCOutWait[nNCOutWaitFlag].bBarOpen,
                     RNCOutWait[nNCOutWaitFlag].nNCLprCnt,
                     RNCOutWait[nNCOutWaitFlag].nBackData);

          RNCOutWait[nNCOutWaitFlag].sNCFile1 := '';
          RNCOutWait[nNCOutWaitFlag].sNCCarNo1 := '';
          RNCOutWait[nNCOutWaitFlag].sNCFile2 := '';
          RNCOutWait[nNCOutWaitFlag].sNCCarNo2 := '';
          RNCOutWait[nNCOutWaitFlag].sNCIOTime := '';
          RNCOutWait[nNCOutWaitFlag].nNCLprNo := 0;
          RNCOutWait[nNCOutWaitFlag].nNCInOut := 0;
          RNCOutWait[nNCOutWaitFlag].nNCRecog1 := 0;
          RNCOutWait[nNCOutWaitFlag].nNCRecog2 := 0;
          RNCOutWait[nNCOutWaitFlag].nNCLprCnt:= 0;
          RNCOutWait[nNCOutWaitFlag].sNCDspIP := '';
          RNCOutWait[nNCOutWaitFlag].bBarOpen := False;
        end;

        if nNCOutWaitPoint <> nNCOutWaitFlag then
          tNCOutWait.Enabled := True;
      end
      else
      begin
        tNCOutWait.Enabled := False;
      end;
    end
    else
      tNCOutWait.Enabled := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMainNew.tNCOutWaitTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tOutAlive1Timer(Sender: TObject);
begin
  try
    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csOutLpr1, '시간동기화 전송') then
      begin
//        csOutLpr1.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csOutLpr1.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csOutLpr1, 'LPR OK 전송') then
//    begin
//      csOutLpr1.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csOutLpr1.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csOutLpr1.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tOutAlive2Timer(Sender: TObject);
begin
  try
    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csOutLpr2, '시간동기화 전송') then
      begin
//        csOutLpr2.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csOutLpr2.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csOutLpr2, 'LPR OK 전송') then
//    begin
//      csOutLpr2.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csOutLpr2.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csOutLpr2.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tOutAlive3Timer(Sender: TObject);
begin
  try
    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csOutLpr3, '시간동기화 전송') then
      begin
//        csOutLpr3.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csOutLpr3.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csOutLpr3, 'LPR OK 전송') then
//    begin
//      csOutLpr3.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csOutLpr3.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csOutLpr3.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tOutAlive4Timer(Sender: TObject);
begin
  try
    if nChkTime < GetTickCount then
    begin
      nChkTime := GetTickCount + 3600000;

      if chkNet(csOutLpr4, '시간동기화 전송') then
      begin
//        csOutLpr3.Socket.SendText('TIME' + FormatDateTime('YYYYMMDDHHNNSS', Now));
//        ExceptLogging(IntToStr(csOutLpr3.Tag) + '번 LPR 시간동기화 전송');
      end;
      Exit;
    end;

//    if chkNet(csOutLpr3, 'LPR OK 전송') then
//    begin
//      csOutLpr3.Socket.SendText('OK');
//      ExceptLogging(IntToStr(csOutLpr3.Tag) + '번 LPR OK 전송');
//    end;
  except
    on E: Exception do
      ExceptLogging(IntToStr(csOutLpr4.Tag) + '번 LPR OK 전송시 오류: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tOutDspTimer(Sender: TObject);
var
  sSend, sDspData, sSpeed, sTime, sEffect: aString;
  sDsp1, sDsp2, sColor1, sColor2, sTemp1, sTemp2: aString;
  i: Byte;
begin
  try
    tOutDsp.Enabled := False;
    sSend := '';
//    sSpeed := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'DSP_SPEED', 0)), 2);
//    sTime := MG_InsZero(IntToStr(iSetup.ReadInteger('PARKING', 'DSP_TIME', 0)), 2);
    sSpeed := MG_InsZero(IntToStr(iSetup.ReadInteger('DISPLAY', 'DSP_SPEED', 0)), 2);
    sTime := MG_InsZero(IntToStr(iSetup.ReadInteger('DISPLAY', 'DSP_TIME', 0)), 2);

//    sDsp1 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'DSP_1_1', '')), AnsiChar(39));
//    sDsp2 := MG_StrTrim(aString(iSetup.ReadString('PARKING', 'DSP_1_2', '')), AnsiChar(39));
//    sTemp1 := iSetup.ReadString('PARKING', 'DSP_COLOR_1_1', '');
//    sTemp2 := iSetup.ReadString('PARKING', 'DSP_COLOR_1_2', '');

    sColor1 := '';
    sColor2 := '';

    if nDisplaySize = 0 then      //2단 4열
    begin
      sDsp1 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', '4_DSP_1_1', '')), AnsiChar(39));
      sDsp2 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', '4_DSP_1_2', '')), AnsiChar(39));
      sTemp1 := iSetup.ReadString('DISPLAY', '4_DSP_COLOR_1_1', '');
      sTemp2 := iSetup.ReadString('DISPLAY', '4_DSP_COLOR_1_2', '');

      for i := 1 to 8 do
      begin
        sColor1 := sColor1 + AnsiChar(StrToInt('$0' + Copy(sTemp1, i, 1)));
      end;

      for i := 1 to 8 do
      begin
        sColor2 := sColor2 + AnsiChar(StrToInt('$0' + Copy(sTemp2, i, 1)));
      end;
    end
    else
    begin
      sDsp1 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', 'DSP_1_1', '')), AnsiChar(39));
      sDsp2 := MG_StrTrim(aString(iSetup.ReadString('DISPLAY', 'DSP_1_2', '')), AnsiChar(39));
      sTemp1 := iSetup.ReadString('DISPLAY', 'DSP_COLOR_1_1', '');
      sTemp2 := iSetup.ReadString('DISPLAY', 'DSP_COLOR_1_2', '');

      for i := 1 to 12 do
      begin
        sColor1 := sColor1 + AnsiChar(StrToInt('$0' + Copy(sTemp1, i, 1)));
      end;

      for i := 1 to 12 do
      begin
        sColor2 := sColor2 + AnsiChar(StrToInt('$0' + Copy(sTemp2, i, 1)));
      end;
    end;

    sEffect := AnsiChar($00) + // AnsiChar(StrToInt('$' + edtDspNo.Text)) + //문구블록
      AnsiChar($00) + // 배경이미지
      AnsiChar($00) + // 문구저장위치
      AnsiChar($61) + // AnsiChar(StrToInt('$' + edttt.Text)) + //폰트크기
      AnsiChar($00) + // 화면분할위치
      AnsiChar($00) + // 완성형
      AnsiChar($80) + // 분할화면효과없음
      AnsiChar($01) + // 메인화면효과
      AnsiChar(StrToInt('$' + sSpeed)) + // 속도
      AnsiChar(StrToInt('$' + sTime)) + // 정지시간
      AnsiChar($00); // 문구수직위치
    sSend := MakeDSPData(AnsiChar($53), sEffect, sColor1 + sColor2,
      sDsp1 + sDsp2);
    for i := 1 to 4 do
    begin
      if TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Active then
        TClientSocket(FindComponent('csOutDsp' + IntToStr(i))).Socket.SendText(sSend);
    end;

  except
    on E: Exception do
      ExceptLogging('TfrmMain.tOutDspTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tSCWaitTimer(Sender: TObject);
var
  sResult: String;
begin
  try
    tSCWait.Enabled := False;

    if not bSCProcWait then
    begin
      ExceptLogging('정기차량 대기자료 처리: ' + IntToStr(nSCWaitFlag) + ', ' + IntToStr
          (nSCWaitPoint));

      if nSCWaitPoint <> nSCWaitFlag then
      begin
        if nSCWaitFlag = 20 then
          nSCWaitFlag := 1
        else
          nSCWaitFlag := nSCWaitFlag + 1;

        if RSCWait[nSCWaitFlag].sSCIOTime <> '' then
        begin
          sResult := RecvLprProc(RSCWait[nSCWaitFlag].sSCFile1,
                                 RSCWait[nSCWaitFlag].sSCCarNo1,
                                 RSCWait[nSCWaitFlag].sSCFile2,
                                 RSCWait[nSCWaitFlag].sSCCarNo2,
                                 RSCWait[nSCWaitFlag].sSCIOTime,
                                 RSCWait[nSCWaitFlag].nSCLprNo,
                                 RSCWait[nSCWaitFlag].nSCInOut,
                                 RSCWait[nSCWaitFlag].nSCRecog1,
                                 RSCWait[nSCWaitFlag].nSCRecog2,
                                 RSCWait[nSCWaitFlag].sSCDspIP,
                                 RSCWait[nSCWaitFlag].csSCLPR,
                                 RSCWait[nSCWaitFlag].bBarOpen,
                                 RSCWait[nSCWaitFlag].nSCLprCnt);
          GridData(RSCWait[nSCWaitFlag].nSCInOut, RSCWait[nSCWaitFlag].nSCLprCnt, sResult);
          RSCWait[nSCWaitFlag].sSCFile1 := '';
          RSCWait[nSCWaitFlag].sSCCarNo1 := '';
          RSCWait[nSCWaitFlag].sSCFile2 := '';
          RSCWait[nSCWaitFlag].sSCCarNo2 := '';
          RSCWait[nSCWaitFlag].sSCIOTime := '';
          RSCWait[nSCWaitFlag].nSCLprNo := 0;
          RSCWait[nSCWaitFlag].nSCInOut := 0;
          RSCWait[nSCWaitFlag].nSCRecog1 := 0;
          RSCWait[nSCWaitFlag].nSCRecog2 := 0;
          RSCWait[nSCWaitFlag].sSCDspIP := '';
          RSCWait[nSCWaitFlag].bBarOpen := False;
        end;

        if nSCWaitPoint <> nSCWaitFlag then
          tSCWait.Enabled := True;
      end
      else
        tSCWait.Enabled := False;
    end
    else
      tSCWait.Enabled := True;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.tSCWaitTimer: ' + aString(E.Message));
  end;
end;

procedure TfrmMain.tVisitDelTimer(Sender: TObject);
var
  sToday, sNowTime : String;
begin
  try
    with dmTables.qryVisitDelete do
    begin
      sToday := FormatDateTime('YYYYMMDD', Now - 1);

      sNowTime := (FormatDateTime('HHNNSS', Now));

      if (sNowTime >= '0000') and (sNowTime <= '0100')  then
      begin
        Close;
        SQL.Clear;
        SQL.Add('delete from visitinfo_EZ where Convert(BIGINT, StartDatetime) < ' + sToday+sNowTime);
        ExecSQL;
      end;
    end;
  except
    on E: Exception do
      ExceptLogging('TfrmMain.tVisitDelTimer: ' + aString(E.Message));
  end;
end;

function TfrmMain.MakeHomeCrc(sData: AnsiString): ansiChar;
var
  sTemp: aString;
  nCrc, i, nLength: Byte;
begin
  sTemp:= sData;
  nLength:= Length(aString(sTemp));
  nCrc:= 0;

  for i := 1 to nLength do
    nCrc:= nCrc xor Ord(sTemp[i]);

  Result:= AnsiChar(nCrc);
end;

function TfrmMain.MakeMassage(sOrder, sVal: String): String;
var
  sReturn : String;
begin
  sReturn := '<' + sOrder + '>' + sVal + '</' + sOrder + '>' + #13#10;
  Result := sReturn;
end;

end.

